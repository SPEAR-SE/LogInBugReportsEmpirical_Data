{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12757357","self":"https://issues.apache.org/jira/rest/api/2/issue/12757357","key":"MAPREDUCE-6171","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12327586","id":"12327586","description":"2.7.0 release","name":"2.7.0","archived":false,"released":true,"releaseDate":"2015-04-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2014-11-26T03:46:15.951+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 30 07:18:57 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_675931879_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-12-02T06:01:16.462+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-6171/watchers","watchCount":6,"isWatching":false},"created":"2014-11-24T10:15:44.626+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-06-30T07:18:57.629+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313041","id":"12313041","name":"security"}],"timeoriginalestimate":null,"description":"The visibilities of the distributed cache files and archives are currently determined by the permission of these files or archives. \nThe following is the logic of method isPublic() in class ClientDistributedCacheManager:\n{code}\nstatic boolean isPublic(Configuration conf, URI uri,\n      Map<URI, FileStatus> statCache) throws IOException {\n    FileSystem fs = FileSystem.get(uri, conf);\n    Path current = new Path(uri.getPath());\n    //the leaf level file should be readable by others\n    if (!checkPermissionOfOther(fs, current, FsAction.READ, statCache)) {\n      return false;\n    }\n    return ancestorsHaveExecutePermissions(fs, current.getParent(), statCache);\n  }\n{code}\nAt NodeManager side, it will use \"yarn\" user to download public files and use the user who submits the job to download private files. In normal cases, there is no problem with this. However, if the files are located in an encryption zone(HDFS-6134) and yarn user are configured to be disallowed to fetch the DataEncryptionKey(DEK) of this encryption zone by KMS, the download process of this file will fail. \n\nYou can reproduce this issue with the following steps (assume you submit job with user \"testUser\"): \n# create a clean cluster which has HDFS cryptographic FileSystem feature\n# create directory \"/data/\" in HDFS and make it as an encryption zone with keyName \"testKey\"\n# configure KMS to only allow user \"testUser\" can decrypt DEK of key \"testKey\" in KMS\n{code}\n  <property>\n    <name>key.acl.testKey.DECRYPT_EEK</name>\n    <value>testUser</value>\n  </property>\n{code}\n# execute job \"teragen\" with user \"testUser\":\n{code}\nsu -s /bin/bash testUser -c \"hadoop jar hadoop-mapreduce-examples*.jar teragen 10000 /data/terasort-input\" \n{code}\n# execute job \"terasort\" with user \"testUser\":\n{code}\nsu -s /bin/bash testUser -c \"hadoop jar hadoop-mapreduce-examples*.jar terasort /data/terasort-input /data/terasort-output\"\n{code}\n\nYou will see logs like this at the job submitter's console:\n{code}\nINFO mapreduce.Job: Job job_1416860917658_0002 failed with state FAILED due to: Application application_1416860917658_0002 failed 2 times due to AM Container for appattempt_1416860917658_0002_000002 exited with  exitCode: -1000 due to: org.apache.hadoop.security.authorize.AuthorizationException: User [yarn] is not authorized to perform [DECRYPT_EEK] on key with ACL name [testKey]!!\n{code}\n\nThe initial idea to solve this issue is to modify the logic in ClientDistributedCacheManager.isPublic to consider also whether this file is in an encryption zone. If it is in an encryption zone, this file should be considered as private. Then at NodeManager side, it will use user who submits the job to fetch the file.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"The visibilities of the distributed cache files and archives should be determined by both their permissions and if they are located in HDFS encryption zone","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dian.fu","name":"dian.fu","key":"dian.fu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dian Fu","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dian.fu","name":"dian.fu","key":"dian.fu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dian Fu","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12757357/comment/14225672","id":"14225672","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"body":"[~dian.fu], Any reason why _yarn_ user is blacklisted from _DECRYPT_EEK_ calls ? My understanding was that only the HDFS admin ie. the _hdfs_ user only needs to be blacklisted","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-26T03:46:15.951+0000","updated":"2014-11-26T03:46:15.951+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12757357/comment/14225726","id":"14225726","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dian.fu","name":"dian.fu","key":"dian.fu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dian Fu","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~asuresh], key based ACL in KMS is currently implemented as whitelist. So if I configure as follows in kms-acl.xml, \n{code}\n <property>\n    <name>key.acl.testKey.DECRYPT_EEK</name>\n    <value>testUser</value>\n  </property>\n{code}, then only {{testUser}} user can do {{DECRYPT_EEK}} call on key {{testKey}}. If I want {{yarn}} user can also do {{DECRYPT_EEK}} call on {{testKey}} key, I need add {{yarn}} user to the above configuration value manually. This means that if I want to configure key based ACL({{DECRYPT_EEK}}) for {{some key}}, I need also add {{yarn}} user to configuration {{DECRYPT_EEK}} for that key. As I don't know if {{yarn}} user will later need to do {{DECRYPT_EEK}} for this key, such as the described example in the description of this JIRA. This is inconvenient and tricky. On the other hand, fetch the files under an encryption zone with the user who submits the job is more straight forward.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dian.fu","name":"dian.fu","key":"dian.fu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dian Fu","active":true,"timeZone":"Asia/Shanghai"},"created":"2014-11-26T04:32:19.359+0000","updated":"2014-11-26T04:32:19.359+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12757357/comment/14226778","id":"14226778","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"body":"[~dian.fu], Thank you for clarifying\n\nBut I still feel this can be handled in KMS configuration itself with a small change in ACL logic. I have opened a new JIRA : [HADOOP-11341|https://issues.apache.org/jira/browse/HADOOP-11341] to address this.\n\nAs per that JIRA, you will now be able to place {{yarn}} user in {{default.key.acl.DECRYPT_EEK}}. That way, {{yarn}} user will be allowed to decrypt all keys. Let me know if that patch works for you...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-26T20:27:10.912+0000","updated":"2014-11-26T20:27:10.912+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12757357/comment/14227183","id":"14227183","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dian.fu","name":"dian.fu","key":"dian.fu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dian Fu","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~asuresh], if applying the patch in HADOOP-11341 and place {{yarn}} user in {{default.key.acl.DECRYPT_EEK}} in kms-acl.xml, it does can solve the issue reported here. Thanks for the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dian.fu","name":"dian.fu","key":"dian.fu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dian Fu","active":true,"timeZone":"Asia/Shanghai"},"created":"2014-11-27T02:49:01.432+0000","updated":"2014-11-27T02:49:01.432+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12757357/comment/14231042","id":"14231042","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"body":"Duping this to HADOOP-11341 since Dian reports that it fixes this issue. Thanks again Dian/Arun for finding and working on this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-12-02T06:01:16.491+0000","updated":"2014-12-02T06:01:16.491+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12757357/comment/14607681","id":"14607681","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinodkv","name":"vinodkv","key":"vinodkv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinod Kumar Vavilapalli","active":true,"timeZone":"America/Los_Angeles"},"body":"Closing old tickets that are already part of a release.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinodkv","name":"vinodkv","key":"vinodkv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinod Kumar Vavilapalli","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-30T07:18:57.625+0000","updated":"2015-06-30T07:18:57.625+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-6171/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i22pgn:"}}