{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12444937","self":"https://issues.apache.org/jira/rest/api/2/issue/12444937","key":"MAPREDUCE-1363","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2010-01-07T23:05:46.844+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jan 07 23:05:46 UTC 2010","customfield_12310420":"149466","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-1363/watchers","watchCount":4,"isWatching":false},"created":"2010-01-07T17:05:32.289+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314047","id":"12314047","description":"","name":"0.20.1","archived":false,"released":true,"releaseDate":"2009-09-01"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-01-07T23:05:46.881+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312920","id":"12312920","name":"task","description":"The code that runs in the child task process."}],"timeoriginalestimate":null,"description":"Spill size could get underestimated when using certain combiners, causing map tasks to fail when disk space is really low in some mapred.local.dir.\n\nWhen doing sortAndSpill(), MapOutputBuffer gets an output path through LocalDirAllocator which checks if the estimated size of the spill is available on any paths specified for intermediate data storage. In case a combiner is specified which emits key-value pairs having serialized size larger than the input key-value pairs' size, the size of the spill file is underestimated. If LocalDirAllocator selects a path for intermediate data storage which does not have enough space to hold the spilled records, an IOException is thrown and the map task fails.\n\nThis could be avoided by either improving the estimation of the size of the spill (increasing it by a constant amount or by constant percentage), or LocalDirAllocator could take into consideration a configuration parameter specifying how much extra unused space should be on the path returned by getLocalPathForWrite (similarly to dfs.datanode.du.reserved). In case there is no space left on a device designated for writing intermediate data on, the spill could be retried on a different device (without the failure of the map task).","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"81287","customfield_12312823":null,"summary":"Spill size underestimated when using certain combiners, causing map tasks to fail","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=miklos","name":"miklos","key":"miklos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Miklos Erdelyi","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=miklos","name":"miklos","key":"miklos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Miklos Erdelyi","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12444937/comment/12797827","id":"12797827","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chris.douglas","name":"chris.douglas","key":"chris.douglas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Douglas","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. This could be avoided by either improving the estimation of the size of the spill (increasing it by a constant amount or by constant percentage), or LocalDirAllocator could take into consideration a configuration parameter specifying how much extra unused space should be on the path returned by getLocalPathForWrite\n\nYet another esoteric, static configuration parameter would be an unfortunate approach and a fixed percentage is patently wrong (wordcount-like applications will overestimate, not underestimate space requirements). A decent fix could estimate and adapt requests for space based on the expansion/contraction observed in prior spills. Most combiners' ratio won't be a simple scalar, but a function of key distribution during both the collection and merge phases; this ratio may not be stable between those phases, either. That said, it's not a bad place to start.\n\nOne approach could initialize a float using a configurable ratio (defaulting to 1.0) adjusted at each spill. This could naively update a global average for each spill, use an exponential moving average to avoid radical shifts due to abnormally large records, odd skews, etc. Whether the ratio is tracked for each invocation of the combiner and not over the entire spill doesn't seem too important if the ratio is stable, which this implicitly assumes. Tracking per-partition expansion/contraction is probably more correct for some applications, but of dubious value generally.\n\nbq. In case there is no space left on a device designated for writing intermediate data on, the spill could be retried on a different device (without the failure of the map task).\n\nThis is slightly tricky, as one would want to copy the data already spilled to the end of the prior partition and re-run the combiner on the partition that caused the error (since partially serialized data causes all sorts of problems) before continuing the spill.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chris.douglas","name":"chris.douglas","key":"chris.douglas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Douglas","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-01-07T23:05:46.844+0000","updated":"2010-01-07T23:05:46.844+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-1363/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0e9ev:"}}