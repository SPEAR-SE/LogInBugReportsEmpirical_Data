{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12697142","self":"https://issues.apache.org/jira/rest/api/2/issue/12697142","key":"MAPREDUCE-5767","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-12-12T12:41:40.996+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 17 00:45:19 UTC 2017","customfield_12310420":"375616","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-5767/watchers","watchCount":8,"isWatching":false},"created":"2014-02-25T16:31:15.443+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314047","id":"12314047","description":"","name":"0.20.1","archived":false,"released":true,"releaseDate":"2009-09-01"}],"issuelinks":[{"id":"12511782","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12511782","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"12932875","key":"AVRO-1786","self":"https://issues.apache.org/jira/rest/api/2/issue/12932875","fields":{"summary":"Strange IndexOutofBoundException in GenericDatumReader.readString","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-08-17T00:45:19.558+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12315344","id":"12315344","name":"mrv1"}],"timeoriginalestimate":null,"description":"There is an issue in org.apache.hadoop.mapred.MapTask in 0.20 that can cause data corruption when the size of a single value produced by the mapper exceeds the size of the map output buffer (roughly io.sort.mb).\n\nI experienced this issue in CDH4.2.1, but am logging the issue here for greater visibility in case anyone else might run across the issue.\n\nThe issue does not exist in 0.21 and beyond due to the implementation of MAPREDUCE-64.  That JIRA significantly changes the way the map output buffering is done and it looks like the issue has been resolved by those changes.\n\nI expect this bug will likely be closed / won't fix due to the fact that 0.20 is obsolete.  As stated previously, I am just logging this issue for visibility in case anyone else is still running something based on 0.20 and encounters the same problem.\n\nIn my situation the issue manifested as an ArrayIndexOutOfBoundsException in the reduce phase when deserializing a key -- causing the job to fail.  However, I think the problem could manifest in a more dangerous fashion where the affected job succeeds, but produces corrupt output.  The stack trace I saw was:\n\n2014-02-13 01:07:34,690 WARN org.apache.hadoop.mapred.Child: Error running child\njava.lang.ArrayIndexOutOfBoundsException: 24\n\tat org.apache.avro.io.parsing.Symbol$Alternative.getSymbol(Symbol.java:364)\n\tat org.apache.avro.io.ResolvingDecoder.doAction(ResolvingDecoder.java:229)\n\tat org.apache.avro.io.parsing.Parser.advance(Parser.java:88)\n\tat org.apache.avro.io.ResolvingDecoder.readIndex(ResolvingDecoder.java:206)\n\tat org.apache.avro.generic.GenericDatumReader.read(GenericDatumReader.java:148)\n\tat org.apache.avro.generic.GenericDatumReader.readRecord(GenericDatumReader.java:173)\n\tat org.apache.avro.generic.GenericDatumReader.read(GenericDatumReader.java:144)\n\tat org.apache.avro.generic.GenericDatumReader.read(GenericDatumReader.java:135)\n\tat org.apache.crunch.types.avro.SafeAvroSerialization$AvroWrapperDeserializer.deserialize(SafeAvroSerialization.java:86)\n\tat org.apache.crunch.types.avro.SafeAvroSerialization$AvroWrapperDeserializer.deserialize(SafeAvroSerialization.java:70)\n\tat org.apache.hadoop.mapreduce.task.ReduceContextImpl.nextKeyValue(ReduceContextImpl.java:135)\n\tat org.apache.hadoop.mapreduce.task.ReduceContextImpl.nextKey(ReduceContextImpl.java:114)\n\tat org.apache.hadoop.mapreduce.lib.reduce.WrappedReducer$Context.nextKey(WrappedReducer.java:291)\n\tat org.apache.hadoop.mapreduce.Reducer.run(Reducer.java:163)\n\tat org.apache.hadoop.mapred.ReduceTask.runNewReducer(ReduceTask.java:610)\n\tat org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:444)\n\tat org.apache.hadoop.mapred.Child$4.run(Child.java:268)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:396)\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1408)\n\tat org.apache.hadoop.mapred.Child.main(Child.java:262)\n\nThe problem appears to me to be in org.apache.hadoop.mapred.MapTask.MapOutputBuffer.Buffer.write(byte[], int, int).  The sequence of events that leads up to the issue is:\n\n* some complete records (cumulative size less than total buffer size) written to buffer\n* large (over io.sort.mb) record starts writing\n* [soft buffer limit exceeded|https://github.com/apache/hadoop-common/blob/release-0.20.1/src/mapred/org/apache/hadoop/mapred/MapTask.java#L1030] - spill starts\n* write of large record continues\n* buffer becomes [full|https://github.com/apache/hadoop-common/blob/release-0.20.1/src/mapred/org/apache/hadoop/mapred/MapTask.java#L1012]\n* [wrap|https://github.com/apache/hadoop-common/blob/release-0.20.1/src/mapred/org/apache/hadoop/mapred/MapTask.java#L1013] evaluates to true, suggesting the buffer can be safely wrapped\n* writing the large record continues until a write occurs such that bufindex + len == bufstart exactly.  When this happens [buffull|https://github.com/apache/hadoop-common/blob/release-0.20.1/src/mapred/org/apache/hadoop/mapred/MapTask.java#L1018] evaluates to false, so the data gets written to the buffer without event\n* writing of the large value continues with another call to write(), starting the corruption of the buffer.  Buffer full can no longer be detected by the [buffull logic|https://github.com/apache/hadoop-common/blob/release-0.20.1/src/mapred/org/apache/hadoop/mapred/MapTask.java#L1012] that is used when bufindex >= bufstart\n\nThe key to this problem occurring is a write where bufindex + len equals bufstart exactly.\n\nI have titled the issue as having to do with writing large records (over io.sort.mb), but really I think the issue *could* occur on smaller records if the serializer generated a write of exactly the right size.  For example, if the buffer is getting close to full, but hasn't exceeded the buffer soft limit and then a collect() on a new value is called that triggers a write() such that bufindex + len == bufstart.  The size of the write would have to be relatively large -- greater than the free space offered by the soft limit (20% of the buffer by default), making the issue occurring that way pretty unlikely.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"375912","customfield_12312823":null,"summary":"Data corruption when single value exceeds map buffer size (io.sort.mb)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ben.roling","name":"ben.roling","key":"ben.roling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Roling","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ben.roling","name":"ben.roling","key":"ben.roling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Roling","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12697142/comment/14244062","id":"14244062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tomdeleu","name":"tomdeleu","key":"tomdeleu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tom De Leu","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks a lot for this analysis! We had the exact same problem at work , running CDH3.5, with Crunch 0.8.4 and Avro 1.7.7.\n\nIt's only after trying a couple of days to find the cause of our problem, and not finding it, that I came across this issue via a lucky Google search.\nI can confirm that increasing *io.sort.mb* solved our problem.\n\nThank you for saving us probably weeks of investigation :) ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tomdeleu","name":"tomdeleu","key":"tomdeleu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tom De Leu","active":true,"timeZone":"Europe/Berlin"},"created":"2014-12-12T12:41:40.996+0000","updated":"2014-12-12T12:41:40.996+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12697142/comment/14244169","id":"14244169","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ben.roling","name":"ben.roling","key":"ben.roling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Roling","active":true,"timeZone":"America/Chicago"},"body":"Thanks for the feedback [~tomdeleu] -- I'm glad you found the post helpful.  It was quite tedious to come to root cause when we encountered the issue and I figured there would probably be some others that ran into it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ben.roling","name":"ben.roling","key":"ben.roling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Roling","active":true,"timeZone":"America/Chicago"},"created":"2014-12-12T14:18:09.789+0000","updated":"2014-12-12T14:18:09.789+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12697142/comment/15641821","id":"15641821","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=work.asr","name":"work.asr","key":"work.asr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Ringel","active":true,"timeZone":"Etc/UTC"},"body":"Is this possibly still a problem?  I'm getting the error after a long running map job on Hadoop 2.7.3.\nI can't increase mapreduce.task.io.sort.mb > 2047 because of [https://github.com/apache/hadoop-mapreduce/blob/HDFS-641/src/java/org/apache/hadoop/mapred/MapTask.java?source=cc#L746]\nInterestingly enough some other searches from Google suggest _decreasing_ the parameter, e.g. [http://comments.gmane.org/gmane.comp.jakarta.lucene.hadoop.user/44152]\nHowever, since it takes ~5hrs to reach the error point doing trial and error testing is problematic.\n---\n{color:red}\nUPDATE: lowering  mapreduce.task.io.sort.mb to 1024 caused the problem to go away\n{color}\n---\n{noformat}\nTask: attempt_1478217421435_0024_m_000000_0 - exited : java.lang.ArrayIndexOutOfBoundsException\n        at org.apache.hadoop.mapred.MapTask$MapOutputBuffer$Buffer.write(MapTask.java:1453)\n        at java.io.DataOutputStream.writeLong(DataOutputStream.java:224)\n        at org.apache.hadoop.io.LongWritable.write(LongWritable.java:52)\n...\n        at org.apache.hadoop.io.serializer.WritableSerialization$WritableSerializer.serialize(WritableSerialization.java:98)\n        at org.apache.hadoop.io.serializer.WritableSerialization$WritableSerializer.serialize(WritableSerialization.java:82)\n        at org.apache.hadoop.mapred.MapTask$MapOutputBuffer.collect(MapTask.java:1149)\n        at org.apache.hadoop.mapred.MapTask$NewOutputCollector.write(MapTask.java:715)\n        at org.apache.hadoop.mapreduce.task.TaskInputOutputContextImpl.write(TaskInputOutputContextImpl.java:89)\n        at org.apache.hadoop.mapreduce.lib.map.WrappedMapper$Context.write(WrappedMapper.java:112)\n        at org.apache.hadoop.mapreduce.Mapper.map(Mapper.java:125)\n        at org.apache.hadoop.mapreduce.Mapper.run(Mapper.java:146)\n        at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:787)\n        at org.apache.hadoop.mapred.MapTask.run(MapTask.java:341)\n        at org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:164)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at javax.security.auth.Subject.doAs(Subject.java:422)\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1698)\n        at org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:158)\n{noformat}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=work.asr","name":"work.asr","key":"work.asr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Ringel","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-06T13:55:04.703+0000","updated":"2016-11-07T20:16:12.622+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12697142/comment/16123626","id":"16123626","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=belugabehr","name":"belugabehr","key":"belugabehr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BELUGA BEHR","active":true,"timeZone":"America/New_York"},"body":"We are also seeing this problem on CDH 5.10.1.  This same issue was also reported as [AVRO-1786]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=belugabehr","name":"belugabehr","key":"belugabehr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BELUGA BEHR","active":true,"timeZone":"America/New_York"},"created":"2017-08-11T16:55:35.313+0000","updated":"2017-08-11T16:55:35.313+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12697142/comment/16129705","id":"16129705","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=belugabehr","name":"belugabehr","key":"belugabehr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BELUGA BEHR","active":true,"timeZone":"America/New_York"},"body":"Issue was resolved by increasing mapreduce.task.io.sort.mb higher than the default and larger than our largest Avro object.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=belugabehr","name":"belugabehr","key":"belugabehr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BELUGA BEHR","active":true,"timeZone":"America/New_York"},"created":"2017-08-17T00:45:19.558+0000","updated":"2017-08-17T00:45:19.558+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-5767/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1sq6f:"}}