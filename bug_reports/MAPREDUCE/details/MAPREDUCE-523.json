{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12408478","self":"https://issues.apache.org/jira/rest/api/2/issue/12408478","key":"MAPREDUCE-523","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/4","id":"4","description":"The problem is not completely described.","name":"Incomplete"},"customfield_12312322":null,"customfield_12310220":"2008-11-14T09:13:52.502+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Jul 19 00:10:57 UTC 2014","customfield_12310420":"148860","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_179077466790_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-07-19T00:10:57.875+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-523/watchers","watchCount":4,"isWatching":false},"created":"2008-11-14T08:26:31.110+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-07-19T00:10:57.898+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"User limit is not expanding back properly.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"108183","customfield_12312823":null,"summary":"User limit is not expanding back properly.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=karams","name":"karams","key":"karams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karam Singh","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=karams","name":"karams","key":"karams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karam Singh","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"GC=100% nodes=104, map_capacity=208, reduce_capacity=208, user-limit=25%;","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12408478/comment/12647544","id":"12647544","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=karams","name":"karams","key":"karams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karam Singh","active":true,"timeZone":"Asia/Kolkata"},"body":"Submitted 4 sleep jobs with different user -:\n\nJob J1, User1, maps=208, reduces=0, sleeptime=120000 milliseconds.\nJob J2, User2, maps=208, reduces=0, sleeptime=120000 milliseconds.\nJob J3, User3, maps=104, reduces=0, sleeptime=124000 milliseconds.\nJob J4, User4, maps=104, reduces=0, sleeptime=124000 milliseconds.\n\nWhen all job starts running, the status from Jobtacker UI is -:\nCluster Summary: Nodes=104, Maps=208, Reduces=0, Map_Capacity=208, Reduce_Capacity=208, Avg. Task/Node=4.00\nQueue: Name=default, running_maps=207, waiting_maps=423\nJ1 having pending_maps=159, running_maps=52\nJ2 having pending_maps=159, running-maps=52\nJ3 having pending_maps=52,  running_maps=52\nJ4 having pending_maps=52,  running_maps=52\n\n\nWhen J3 and J4 finish, status from Jobtacker UI is -:\nCluster Summary: Nodes=104, Maps=208, Reduces=0, Map_Capacity=208, Reduce_Capacity=208, Avg. Task/Node=4.00\nQueues: Name=default, running_maps=207, waiting_maps=34\n\nJ1 having pending_maps=0,  running_maps=104\nJ2 having pending_maps=33, running_maps=71\n \n\n\nObservation -:\n1. J2 should also be using 104 as its user-limit should expand back to 50% like J1 whereas it is using 71 slots.\n2. Actually running_maps=J1+j2=175, pending_maps=J1+j2=33, where as cluster status and queue information shows maps=208 (running), where slots 33 went.\n\nNote -: speculative execution was true.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=karams","name":"karams","key":"karams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karam Singh","active":true,"timeZone":"Asia/Kolkata"},"created":"2008-11-14T08:26:48.142+0000","updated":"2008-11-14T08:26:48.142+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12408478/comment/12647552","id":"12647552","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"body":"Looking at the logs, it seems that there are 2 problems\n- when job3 finishes (pending = 0), it takes some time for it to exit the scheduler. While job3 from user3 is actually done (doesnt require any scheduling cycles), user3 is still counted as a valid user and thus affects the _limit_ computation\n- Since the limit computation is slow in catching up, job1 always has the benefit and schedules more tasks. The problem is that it sometimes goes ahead and schedules speculative tasks even when  job2 has genuine tasks to run.\n\nlimit computation works as follows :\n{code}\ncap = min (running_tasks + 1, guaranteed_cap)\nlimit = max( cap/num_users, cap*ulimit)\n{code}\n\nI think whatever is extra should always be equally given back to all the contenders. This can be achieved if we update _limits_ immediately based on how many users actually require slots rather than waiting for the user to be removed from the scheduler. Also we should make sure that speculative tasks should be run last else we will end up wasting resources.\n\nnew limit computation :\n{code}\ncap = min (running_tasks, guaranteed_cap)\nnum_actual_users = users with slot requirements // avoids users from jobs that are done with their scheduling\nlimit = max( cap/num_actual_users, cap*ulimit)\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-14T09:13:52.502+0000","updated":"2008-11-14T09:13:52.502+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12408478/comment/12647558","id":"12647558","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"body":"Here is the scenario\n\n_Setup :_\nj1 and j2 are 2 jobs submitted by user user1 and user2 resp and  run for longer time.\nj3 and j4 are 2 jobs submitted by user user3 and user4 resp and run for less time .\nOnly \"default\" queue is used.\n\n_Analysis :_\n\n||jobs||num-running-tasks||limit||who will schedule||comment||\n|j1, j2, j3, j4|25, 25, 25, 25| 25| j1 |everyone is over limit|\n|j1, j2, j3*, j4|40, 25, 10, 25| 25| j1 |everyone is over limit and job3 is finishing off|\n|j1, j2, j4|50, 25, 25| 33| j2 |only user1 is over limit as limit is re-defined|\n|j1, j2, j4*|50, 33, 17| 33| j1 |everyone is over limit and job4 is finishing off|\n|j1, j2|67, 33| 50| j2 |user1 is over limit as limits is redefined|\n\nNote that j1 might actually have 50 maps to run but then is can run 67 with this setup. So it can go ahead an run 17 speculative tasks instead of job2 running its 17 genuine tasks.\n\nWith the proposed change\n||jobs||num-running-tasks||limit||who will schedule||comment||\n|j1, j2, j3, j4|25, 25, 25, 25| 25| j1 |everyone is over limit|\n|j1, j2, j3*, j4|33, 25, 17, 25| 33| j2|user1 is over limit as limit is redefined and job3 is finishing off, slots will be equally divided|\n|j1, j2, j3*, j4|33, 33, 9, 25| 33| j1 |everyone is overlimit and job3 is finishing off|\n|j1, j2, j4|42, 33, 25| 33| j1 |everyone is overlimit|\n|j1, j2, j4*|50, 33, 17| 50| j2 |as user1 is over limit as limit are redefined and job4 is finishing off|\n|j1, j2|50, 50| 50| j1 |as everyone is overlimit|\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-14T10:01:06.735+0000","updated":"2008-11-14T10:01:06.735+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12408478/comment/12647593","id":"12647593","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"body":"There are a couple of things going on here. \n\nThe scheduler is notified by the JT when a job is considered 'done' (see HADOOP-4053). At that point, we recompute the number of users who have submitted jobs in the queue. If this notification is coming in late, you need to see why. But the scheduler's behavior is right in terms of computing the user limit. The scheduler doesn't decide when a job is 'done'. The JT does. And that, IMO,is correct behavior. \n\nSecondly, if we walk through the entire queue and no job can accept a slot (likely because, as in this case, either jobs are over capacity or don't have tasks to run) and there are no waiting tasks, we still want the slot to be used by the queue, so we walk through the queue again, this tiem without considering user limits. Likely, the first job will start getting a bunch of slots. This is by design, as it's really hard to argue what is fair in this case. Taking one of your examples, suppose the queue capacity is 100 and we have four jobs from four different users. Each is using 25 slots. J3 starts finishing up, and at some point, is only running, say, 5 tasks. Also assume there are no waiting jobs. Now, what's the right behavior? WHo should get the slot? J1, right? Who gets the next slot? You can argue that you want to redistribute J3's 20 unused slots among J1, J2, and J4, but this recomputation gets really complicated. So, we took a simpler approach by saying that free slots are offered to jobs in order. So J1 will get a bunch of free slots, which will let it finish fast. Eventually J3 finishes, is taken out of the queue, and user limits are recomputed. We couldn't think of a simple and more fair approach here. Note that this situation is a bit rare. On a regular, well-utilized cluster, you'll have a bunch of waiting jobs and they will start running. J3's user's first waiting job will start running, which is the right thing. \n\nSo, in summary, I'd say this is expected behavior. \n\nAs for your comment on speculative tasks being run by J1 - that's really a different call. J1 runs a speculative task if it legitimately has a speculate task to run, not because there's a slot free. J1 can come back and say it doesn't have any task to run, in which case J2 is looked at next. If J1 is running 17 speculative tasks, they're as genuine, and higher priority, than J2's tasks, so I'd say that's still the right behavior. \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-14T11:56:35.024+0000","updated":"2008-11-14T11:56:35.024+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12408478/comment/14067249","id":"14067249","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aw","name":"aw","key":"aw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=aw&avatarId=23681","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=aw&avatarId=23681","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=aw&avatarId=23681","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=aw&avatarId=23681"},"displayName":"Allen Wittenauer","active":true,"timeZone":"America/Tijuana"},"body":"Capacity scheduler has changed quite a bit since then so closing as stale.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aw","name":"aw","key":"aw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=aw&avatarId=23681","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=aw&avatarId=23681","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=aw&avatarId=23681","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=aw&avatarId=23681"},"displayName":"Allen Wittenauer","active":true,"timeZone":"America/Tijuana"},"created":"2014-07-19T00:10:57.895+0000","updated":"2014-07-19T00:10:57.895+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-523/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ivev:"}}