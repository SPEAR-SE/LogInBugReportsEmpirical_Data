{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12735845","self":"https://issues.apache.org/jira/rest/api/2/issue/12735845","key":"MAPREDUCE-6043","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":"2014-08-27T15:53:34.203+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Aug 27 16:49:12 UTC 2014","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_520238829_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-08-27T18:13:02.347+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-6043/watchers","watchCount":5,"isWatching":false},"created":"2014-08-21T17:42:23.556+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-08-27T18:13:02.379+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"We have seen various cases that reducer-preemption does not kick in and the scheduled mappers wait behind running reducers forever. Each time there seems to be a different scenario. So far we have tracked down two of such cases and the common element between them is that the variables in RMContainerAllocator go out of sync since they only get updated when completed container is reported by RM. However there are many corner cases that such report is not received from RM and yet the MapReduce app moves forward. Perhaps one possible fix would be to update such variables also after exceptional cases.\n\nThe logic for triggering preemption is at RMContainerAllocator::preemptReducesIfNeeded\nThe preemption is triggered if the following is true:\n{code}\nheadroom +  am * |m| + pr * |r| < mapResourceRequest\n{code} \nwhere am: number of assigned mappers, |m| is mapper size, pr is number of reducers being preempted, and |r| is the reducer size. Each of these variables going out of sync will cause the preemption not to kick in. In the following comment, we explain two of such cases.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Lost messages from RM to MRAppMaster","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maysamyabandeh","name":"maysamyabandeh","key":"maysamyabandeh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maysamyabandeh&avatarId=17671","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maysamyabandeh&avatarId=17671","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maysamyabandeh&avatarId=17671","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maysamyabandeh&avatarId=17671"},"displayName":"Maysam Yabandeh","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maysamyabandeh","name":"maysamyabandeh","key":"maysamyabandeh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maysamyabandeh&avatarId=17671","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maysamyabandeh&avatarId=17671","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maysamyabandeh&avatarId=17671","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maysamyabandeh&avatarId=17671"},"displayName":"Maysam Yabandeh","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735845/comment/14105664","id":"14105664","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maysamyabandeh","name":"maysamyabandeh","key":"maysamyabandeh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maysamyabandeh&avatarId=17671","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maysamyabandeh&avatarId=17671","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maysamyabandeh&avatarId=17671","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maysamyabandeh&avatarId=17671"},"displayName":"Maysam Yabandeh","active":true,"timeZone":"America/Los_Angeles"},"body":"The value of this variables in the first case were this:\n{code}\nheadroom = 0; \npr = 0; //reducer preemption was never called at this app\n{code}\nso the triggering condition for reducer preemption is summarized to:\n{code}\nam * |m| < |m|\n{code}\nor \n{code}\nam < 1\n{code}\nIn this erroneous case we had two assigned mappers that were not successfully removed from the list and hence prevent preemption from kicking in. Those mappers were finished but the MRAppMaster did not hear anything about them afterwards so called them successful after one minute timeout:\n{code}\n2014-08-20 04:25:21,665 INFO [Ping Checker] org.apache.hadoop.yarn.util.AbstractLivelinessMonitor: Expired:attempt_xxx_yyy_m_000288_0 Timed out after 60 secs\n2014-08-20 04:25:21,665 WARN [AsyncDispatcher event handler] org.apache.hadoop.mapreduce.v2.app.job.impl.TaskAttemptImpl: Task attempt attempt_xxx_yyy_m_000288_0 is done fromTaskUmbilicalProtocol's point of view. However, it stays in finishing state for too long\n2014-08-20 04:25:21,665 INFO [AsyncDispatcher event handler] org.apache.hadoop.mapreduce.v2.app.job.impl.TaskAttemptImpl: attempt_xxx_yyy_m_000288_0 TaskAttempt Transitioned from FINISHING_CONTAINER to SUCCESS_CONTAINER_CLEANUP\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maysamyabandeh","name":"maysamyabandeh","key":"maysamyabandeh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maysamyabandeh&avatarId=17671","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maysamyabandeh&avatarId=17671","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maysamyabandeh&avatarId=17671","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maysamyabandeh&avatarId=17671"},"displayName":"Maysam Yabandeh","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-21T17:42:35.506+0000","updated":"2014-08-21T17:42:35.506+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735845/comment/14105665","id":"14105665","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maysamyabandeh","name":"maysamyabandeh","key":"maysamyabandeh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maysamyabandeh&avatarId=17671","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maysamyabandeh&avatarId=17671","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maysamyabandeh&avatarId=17671","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maysamyabandeh&avatarId=17671"},"displayName":"Maysam Yabandeh","active":true,"timeZone":"America/Los_Angeles"},"body":"After a preemption, the task id is added to\n{code}\nassignedRequests.preemptionWaitingReduces\n{code}\nAnd it is later removed once the preemption is successfully finished. In the second scenario we observed, although the preemption was successfully finished its report was not received through RM and hence the variable was not decreased and future preemptions did not kick in.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maysamyabandeh","name":"maysamyabandeh","key":"maysamyabandeh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maysamyabandeh&avatarId=17671","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maysamyabandeh&avatarId=17671","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maysamyabandeh&avatarId=17671","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maysamyabandeh&avatarId=17671"},"displayName":"Maysam Yabandeh","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-21T17:42:55.886+0000","updated":"2014-08-21T17:42:55.886+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735845/comment/14111622","id":"14111622","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maysamyabandeh","name":"maysamyabandeh","key":"maysamyabandeh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maysamyabandeh&avatarId=17671","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maysamyabandeh&avatarId=17671","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maysamyabandeh&avatarId=17671","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maysamyabandeh&avatarId=17671"},"displayName":"Maysam Yabandeh","active":true,"timeZone":"America/Los_Angeles"},"body":"I was planning to work on a patch that maintains those variables also in exceptional corner cases. \n\nComments are highly appreciated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maysamyabandeh","name":"maysamyabandeh","key":"maysamyabandeh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maysamyabandeh&avatarId=17671","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maysamyabandeh&avatarId=17671","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maysamyabandeh&avatarId=17671","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maysamyabandeh&avatarId=17671"},"displayName":"Maysam Yabandeh","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-27T00:11:54.725+0000","updated":"2014-08-27T00:11:54.725+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735845/comment/14112367","id":"14112367","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"For the first case you described, the AM currently kills tasks immediately after they said they have completed (either successfully or unsuccessfully).  This behavior may change after MAPREDUCE-5465 but that's not in yet.  Did the kill not take place or otherwise failed in some fashion?  Killing a lingering-but-finished map task is better than preempting a reducer.\n\nFor the second case, could you elaborate on how the RM failed to report the completed container to the AM?  That sounds like a bug in YARN rather than MapReduce, but it would be good to know the circumstances in which it occurred.\n\nBoth of these sound like they could be cases of YARN failing to convey completed container status to the AM.  If so those seem like bugs in YARN and not MapReduce.  Also could you elaborate on how you're proposing to fix these exceptional corner cases in MapReduce?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2014-08-27T15:53:34.203+0000","updated":"2014-08-27T15:53:34.203+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735845/comment/14112428","id":"14112428","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maysamyabandeh","name":"maysamyabandeh","key":"maysamyabandeh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maysamyabandeh&avatarId=17671","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maysamyabandeh&avatarId=17671","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maysamyabandeh&avatarId=17671","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maysamyabandeh&avatarId=17671"},"displayName":"Maysam Yabandeh","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~jlowe] for the comments. Further investigations suggest that the cause for the lost messages, as you correctly mentioned, was a bug introduced by one of our recent internal patches (the container is successfully finished but its status is not successfully transmitted to MRAppMaster through RM). Nevertheless I was under impression that there is double standards in MRAppMaster, sometimes relying on RM to successfully transmit statuses and sometimes not. But after your comment, I double checked and noticed that the logic for the exceptional case described in case 1 is only available in our internal repository and has not made it to the trunk yet. So, I now understand that the containers statuses reported by NM are guaranteed to be received by MRAppMaster through RM, and MRAppMaster's logic need not to be resilient against such cases.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maysamyabandeh","name":"maysamyabandeh","key":"maysamyabandeh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maysamyabandeh&avatarId=17671","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maysamyabandeh&avatarId=17671","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maysamyabandeh&avatarId=17671","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maysamyabandeh&avatarId=17671"},"displayName":"Maysam Yabandeh","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-27T16:49:12.406+0000","updated":"2014-08-27T16:49:12.406+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-6043/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1z707:"}}