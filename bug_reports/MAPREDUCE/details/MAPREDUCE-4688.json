{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12609257","self":"https://issues.apache.org/jira/rest/api/2/issue/12609257","key":"MAPREDUCE-4688","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2012-09-27T07:38:04.642+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Apr 14 21:00:59 UTC 2014","customfield_12310420":"257118","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-4688/watchers","watchCount":5,"isWatching":false},"created":"2012-09-26T14:53:36.670+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":["patch"],"customfield_12312333":null,"customfield_12310230":"hadoop mapreduce setJarByClass findContainingJar jboss as7 jbossas7","customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314205","id":"12314205","description":"","name":"0.20.2","archived":false,"released":true,"releaseDate":"2010-02-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12320250","id":"12320250","description":"maintenance release on branch-1.0","name":"1.0.3","archived":false,"released":true,"releaseDate":"2012-05-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-04-14T21:00:59.470+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"Hello,\n\nIâ€™m using Hadoop as a client from a J2EE web application. One of the lib within my EAR is a jar containing several Map/Reduce jobs. Using JBoss AS 4 in the past, I had no problem running the jobs with the following code:\n{code}\ntry {\n    final Configuration conf = HBaseConfiguration.create();\n    // Load all Hadoop configuration\n    conf.addResource(\"core-site.xml\");\n    conf.addResource(\"hdfs-site.xml\");\n    conf.addResource(\"mapred-site.xml\");\n    conf.addResource(\"hbase-site.xml\");\n\n    final Job job = new Job(conf, \"My Job\");\n    job.setJarByClass(MyJobClass.getClass());\n\t\t\t\n    \t\t\t\n    TableMapReduceUtil.initTableMapperJob(...);\n\t\t\t\n    TableMapReduceUtil.initTableReducerJob(...);\n\t\t\t\n    final boolean status = job.waitForCompletion(true);\n} ...\n{code}\n\nSince, we have moved to JBoss AS 7 and the method setJarByClass is no longer working. Indeed, in *org.apache.hadoop.mapred.JobConf.findContainingJar(Class)* the retrieved URL does not have a *jar* protocol, but a JBoss *vfs* protocol. So, it always return null and the jar is not sent to the Map/Reduce cluster.\nWith the VFS protocol the resource name may be or may not be the actual system file name of the resource. I mean, the class file is within the jar file which may be within an ear file in case of a non-exploded deployment, so there are not system File corresponding to the resource. Though, I guess similar issues may happen with jar: protocol.\n\nIn order to make the job working with JBoss AS-7, I did the following implementation of the Job class. This override the setJarByClass mechanism, by creating a temporary jar file from the actual jar file read from vfs.\n\n{code}\n/**\n * Patch of Map/Red Job to handle VFS jar file\n */\npublic class VFSJob extends Job\n{\n\t\n    /** Logger */\n    private static final transient Logger logger = LoggerFactory.getLogger(VFSJob.class);\n\n    public VFSJob() throws IOException {\n        super();\n    }\n\n    public VFSJob(Configuration conf) throws IOException {\n        super(conf);\n    }\n\n    public VFSJob(Configuration conf, String jobName) throws IOException {\n        super(conf, jobName);\n    }\n\t\n    private File temporaryJarFile;\n\n    /**\n     * Patch of setJarByClass to handle VFS\n     */\n    @Override\n    public void setJarByClass(Class<?> cls) {\n       final ClassLoader loader = cls.getClassLoader();\n        final String classFile = cls.getName().replaceAll(\"\\\\.\", \"/\") + \".class\";\n        JarInputStream is = null;\n        JarOutputStream os = null;\n        try {\n            final Enumeration<URL> itr = loader.getResources(classFile);\n            while (itr.hasMoreElements()) {\n                final URL classUrl = itr.nextElement();\n                // This is the trick\n                if (!\"vfs\".equals(classUrl.getProtocol())) {\n                    continue;\n                }\n\t\t\t   \n                final String jarFile = classUrl.getFile().substring(0, classUrl.getFile().length() - (classFile.length() + 1) ); //+1 because of '/'\n                final URL jarUrl = new URL(classUrl.getProtocol(), classUrl.getHost(), classUrl.getPort(), jarFile, new org.jboss.vfs.protocol.VirtualFileURLStreamHandler());\n\t\t\t  \n                temporaryJarFile = File.createTempFile(\"mapred\", \".jar\");\n\n                is = (JarInputStream) jarUrl.openStream();\n                os = new JarOutputStream(new FileOutputStream(temporaryJarFile));\n\n                final byte[] buffer = new byte[2048];\n\n                for (JarEntry entry = is.getNextJarEntry(); entry !=null; entry = is.getNextJarEntry()) {\n                    os.putNextEntry(entry);\n                    int bytesRead;\n                    while ((bytesRead = is.read(buffer)) != -1) {\n                        os.write(buffer, 0, bytesRead);\n                    }\n                }\n\n                this.conf.setJar(temporaryJarFile.getPath());\n                return;\n            }\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        } finally {\n            if (is != null) {\n                try {\n                    is.close();\n                } catch (IOException e) {\n                    logger.error(\"Error closing input stream\", e);\n                }\n            }\n            if (os != null) {\n                try {\n                    os.close();\n                } catch (IOException e) {\n                    logger.error(\"Error closing output stream\", e);\n                }\n            }\n        }\n\t\t\n        return;\n    }\n\t\n    /**\n     * Clean the temporary jar file created\n     */\n    public void clean() {\n        if (temporaryJarFile != null && temporaryJarFile.exists()) {\n            final boolean isDeleted = temporaryJarFile.delete();\n            if (!isDeleted) {\n                logger.error(\"Error while deleting temporary jar \" + temporaryJarFile);\n            }\n        }\n    }\n\n\n}\n{code}\n\nSo, after the call, I must not forget deleting the temporary jar file.\n{code}\nVFSJob job = null;\ntry {\n    final Configuration conf = HBaseConfiguration.create();\n    // Load all Hadoop configuration\n    conf.addResource(\"core-site.xml\");\n    conf.addResource(\"hdfs-site.xml\");\n    conf.addResource(\"mapred-site.xml\");\n    conf.addResource(\"hbase-site.xml\");\n\n    job = new VFSJob(conf, \"My Job\");\n    job.setJarByClass(MyJobClass.getClass());\n\t\t\t\n\t\t\t\n    TableMapReduceUtil.initTableMapperJob(...);\n\t\t\t\n    TableMapReduceUtil.initTableReducerJob(...);\n\t\t\t\n    final boolean status = job.waitForCompletion(true);\n} ...\n} finally {\n    job.clean();\n}\n{code}\n\n\n\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"112839","customfield_12312823":null,"summary":"setJarByClass does not work under JBoss AS 7","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=guinotphil","name":"guinotphil","key":"guinotphil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=guinotphil&avatarId=15896","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=guinotphil&avatarId=15896","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=guinotphil&avatarId=15896","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=guinotphil&avatarId=15896"},"displayName":"Philippe","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=guinotphil","name":"guinotphil","key":"guinotphil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=guinotphil&avatarId=15896","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=guinotphil&avatarId=15896","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=guinotphil&avatarId=15896","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=guinotphil&avatarId=15896"},"displayName":"Philippe","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Hadoop Cloudera CDH3 Cluster w/Hadoop 0.20.2 on CentOS 5/6\nClient on JBoss AS 7.1.1.Final CentOS/Windows","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12609257/comment/13464526","id":"13464526","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vicaya","name":"vicaya","key":"vicaya","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Luke Lu","active":true,"timeZone":"America/Los_Angeles"},"body":"It'd be much easier and more flexible for webapps to submit jobs via Oozie (another J2EE service). Now you have J2EE and SOA :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vicaya","name":"vicaya","key":"vicaya","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Luke Lu","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-09-27T07:38:04.642+0000","updated":"2012-09-27T07:38:04.642+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12609257/comment/13545435","id":"13545435","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lexsoto","name":"lexsoto","key":"lexsoto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alex Soto","active":true,"timeZone":"America/New_York"},"body":"This JBoss ticket seems related to this issue:\n\n  https://issues.jboss.org/browse/JBVFS-147\n\nWhile we have a workaround, it is not very clean.  \nAnybody has a better solution?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lexsoto","name":"lexsoto","key":"lexsoto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alex Soto","active":true,"timeZone":"America/New_York"},"created":"2013-01-06T16:39:47.473+0000","updated":"2013-01-06T16:39:47.473+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12609257/comment/13968833","id":"13968833","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve167","name":"steve167","key":"steve167","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve S","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for this workaround.  It really helped me out!\n\nOne suggestion I might make is to modify the code as follows.  It allows the job wrapper to work in either JBoss or standalone(without any sort of check or custom handling for both situations) and doesn't introduce the dependency on a JBoss binary at compile or runtime(unless it's triggered at runtime by running in JBoss and having a vfs resource).\n\n                if (!\"vfs\".equals(classUrl.getProtocol())) {\n                    super.setJarByClass(cls);\n                    continue;\n                }\n\n                final String jarFile = classUrl.getFile().substring(0, classUrl.getFile().length() - (classFile.length() + 1) ); //+1 because of '/'\n                final URL jarUrl = new URL(classUrl.getProtocol(), classUrl.getHost(), classUrl.getPort(), jarFile,\n                    (URLStreamHandler)Class.forName(\"org.jboss.vfs.protocol.VirtualFileURLStreamHandler\").newInstance());","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve167","name":"steve167","key":"steve167","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve S","active":true,"timeZone":"Etc/UTC"},"created":"2014-04-14T21:00:59.470+0000","updated":"2014-04-14T21:00:59.470+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-4688/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0jo4n:"}}