{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12542496","self":"https://issues.apache.org/jira/rest/api/2/issue/12542496","key":"MAPREDUCE-3859","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324149","id":"12324149","description":"maintenance release on branch-1.2","name":"1.2.1","archived":false,"released":true,"releaseDate":"2013-08-01"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-02-14T12:47:50.330+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Oct 11 17:18:55 UTC 2013","customfield_12310420":"227782","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_48956905_*|*_1_*:*_2_*:*_40962320673_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-06-03T01:04:56.771+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-3859/watchers","watchCount":8,"isWatching":false},"created":"2012-02-14T09:03:39.218+0000","customfield_12310192":"Fixed wrong CapacityScheduler resource allocation for high memory consumption jobs","customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12318240","id":"12318240","description":"1.0.0 release","name":"1.0.0","archived":false,"released":true,"releaseDate":"2011-12-27"}],"issuelinks":[{"id":"12369784","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12369784","type":{"id":"10020","name":"Cloners","inward":"is cloned by","outward":"is a clone of","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10020"},"inwardIssue":{"id":"12650544","key":"YARN-751","self":"https://issues.apache.org/jira/rest/api/2/issue/12650544","fields":{"summary":"CLONE - CapacityScheduler incorrectly utilizes extra-resources of queue for high-memory jobs","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-10-11T17:18:55.320+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312900","id":"12312900","name":"capacity-sched"}],"timeoriginalestimate":null,"description":"Imagine, we have a queue A with capacity 10 slots and 20 as extra-capacity, jobs which use 3 map slots will never consume more than 9 slots, regardless how many free slots on a cluster.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12583806","id":"12583806","filename":"MAPREDUCE-3859_MR1_fix_and_test.patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-20T07:35:30.450+0000","size":6192,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12583806/MAPREDUCE-3859_MR1_fix_and_test.patch.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12514777","id":"12514777","filename":"test-to-fail.patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-16T09:41:35.428+0000","size":5451,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12514777/test-to-fail.patch.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"58713","customfield_12312823":null,"summary":"CapacityScheduler incorrectly utilizes extra-resources of queue for high-memory jobs","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13207611","id":"13207611","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"Sorry, I don't know what exactly version of Hadoop is used in cdh3u1 distribution. There we have following lines in *CapacitySchedulerQueue.java* in *assignSlotsToJob* method:\n{code}\nint queueSlotsOccupied = getNumSlotsOccupied(taskType);\nint currentCapacity;\n\nif (queueSlotsOccupied < queueCapacity) {\n  currentCapacity = queueCapacity;\n}\nelse {\n  currentCapacity = queueSlotsOccupied + numSlotsRequested;\n}\n{code}\n\nImagine we have a job with 1 slot per task, if we have queue with 10 configured capacity and 9 occupied slots (imagine, we have large maximum capacity and a lot of free slots on cluster), then _currentCapacity=10_ and task will be scheduled properly. Later, when will have 10 occupied slots, _currentCapacity=11_ and all will be fine too. And so on...\n\nNow imagine, we have a job with 3 slots per task, if we have queue with 10 configured capacity and 9 occupied slots, then _currentCapacity=10_, but that's not enough for scheduling this new task!!! So, this job will never use more then 9 slots!\n\nI've fixed this problem by changing:\n{code}\nif (queueSlotsOccupied < queueCapacity) {\n{code}\non\n{code}\nif (queueSlotsOccupied + numSlotsRequested <= queueCapacity) {\n{code}\n\nI've rebuilt cdh3u1 from sources, deployed jar on the cluster and CapacityScheduler works well now for me.\n\nAlso I've checkouted current Hadoop's trunk. Unfortunately, sources of CapacityScheduler dramatically changed. But I've found the similar lines in *LeafQueue.java* in *computeUserLimit* method:\n{code}\nfinal int currentCapacity = \n  (consumed < queueCapacity) ? \n      queueCapacity : (consumed + required.getMemory());\n{code}\nSo, it seems to me, this bug also affects the latest CapacityScheduler","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-14T09:46:01.584+0000","updated":"2012-02-14T09:46:01.584+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13207678","id":"13207678","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"body":"This affects 1.x as well, comparing the difference in commits to CS between CDH3's CS and Apache 1.x.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-02-14T12:47:50.330+0000","updated":"2012-02-14T12:47:50.330+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13207680","id":"13207680","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"body":"Sergey,\n\nThanks for taking a dig at the code and coming up with a fix! Would you be interested in posting a patch fix for this as well? We'd require a test case that fails without the fix as well.\n\nLet us know if thats possible, thanks again!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-02-14T12:49:17.120+0000","updated":"2012-02-14T12:49:17.120+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13208204","id":"13208204","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"Sergey, I'm pretty sure the reason you are hitting this is that you have a single user in your queue.\n\nBy default, a single user can't exceed the queue's capacity (10 in this case). You can use 'user-limit-factor' to bump that up: http://hadoop.apache.org/common/docs/r1.0.0/capacity_scheduler.html#Configuration\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-02-15T03:29:21.312+0000","updated":"2012-02-15T03:29:21.312+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13208337","id":"13208337","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"Arun, no, that's not 'user-limit-factor' issue(( This option perfectly works in case if job consumes only 1 slot per task and we've been using this option for a while. This bug affects only cases if job consumes more than one slot per task.\n\nHarsh, what version should I try to patch? Is it branch-1.0? Or trunk too?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-15T10:19:42.960+0000","updated":"2012-02-15T10:19:42.960+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13209086","id":"13209086","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"Sergey - can you please try this again by bumping up user-limit-factor to 2 or 3?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-02-16T02:43:54.046+0000","updated":"2012-02-16T02:43:54.046+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13209145","id":"13209145","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"We've tried to play  with user-limit-factor in any variants (2,3, 10, 100 and even more). Well, Arun, I just write a test for CapacityScheduler (this test should fail). Before preparing any patches, I'll put the code here and you'll take a look on it. Ok?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-16T06:23:50.288+0000","updated":"2012-02-16T06:23:50.288+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13209154","id":"13209154","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"That would be great, thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-02-16T06:51:26.749+0000","updated":"2012-02-16T06:51:26.749+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13209177","id":"13209177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm not against fixing the CS, I just want to ensure we do the 'right' fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-02-16T07:01:37.352+0000","updated":"2012-02-16T07:01:37.352+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13209238","id":"13209238","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"Patch with test which fails for high memory jobs","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-16T09:41:35.646+0000","updated":"2012-02-16T09:41:35.646+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13209243","id":"13209243","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"Arun, Harsh, I've submitted patch (test-to-fail.patch.txt) with test (it should be applied against \"branch-1.0\" branch).\n\nTest creates 20 map slots cluster (5 nodes with 4 slots) and queue with capacity 10 slots, max capacity 16 slots, user limit factor 2. The cluster is idle. When we submit high memory job (5 mappers with 4 slots per mapper), it should consume 16 slots (4 mappers should be run), but it doesn't because of the bug.\n\nTest with fix (fix is not in the patch) works well.\n\nFeel free to give any remarks (about code style, for example), because that's my first hadoop coding. Arun, agree with you, that each bug report should be \"double-checked\".","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-16T09:52:31.986+0000","updated":"2012-02-16T09:52:31.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13209461","id":"13209461","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks, I'll run the test.\n\nAlso, maybe the fix would be better expressed as:\n\n{code}\n    int currentCapacity = max(queueSlotsOccupied, queueCapacity) + numSlotsRequested;\n{code}    ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-02-16T15:54:09.747+0000","updated":"2012-02-16T15:54:37.146+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13209464","id":"13209464","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"Hmm... maybe not.\n\nLet me think more about it's implications on user-limit etc.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-02-16T15:55:34.774+0000","updated":"2012-02-16T15:55:34.774+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13478830","id":"13478830","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mattf","name":"mattf","key":"mattf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Foley","active":true,"timeZone":"America/Los_Angeles"},"body":"Moved to 1.2.0 upon release of 1.1.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mattf","name":"mattf","key":"mattf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Foley","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-18T09:03:41.918+0000","updated":"2012-10-18T09:03:41.918+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13609117","id":"13609117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mroark","name":"mroark","key":"mroark","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Roark","active":true,"timeZone":"America/Chicago"},"body":"Any updates on this bug? It is affecting us as well.. it has a pretty bad effect on cluster utilization for these kinds of jobs. I tested this locally to see if it was this issue, results below:\n\n10 datanodes, each with 6 slots for reducers, 60 reducer slots total. No other jobs running.\nRunning jobs in a queue which has \"Reduce tasks, Capacity: 4 slots, Maximum capacity: 60 slots\"\nReducer sleeps for a while. This allows me to check steady state reducer slot allocation.\n\n||mapred.reduce.tasks||slots per reducer||expected running reduce tasks||running reduce tasks||using slots||percent of capacity||notes||\n|30|1|30|30|30|750| |\n|30|2|30|{color:red}16{color}|32|800| |\n|30|3|20|{color:red}1{color}|3|75| really bad |\n|30|4|10|{color:red}8{color}|32|800| |\n|30|5|10|{color:red}8{color}|40|1000| |\n|30|6|10|{color:red}8{color}|48|1200| |\n|30|7(err)|0|0|0|0| job hangs, but I expected this |","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mroark","name":"mroark","key":"mroark","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Roark","active":true,"timeZone":"America/Chicago"},"created":"2013-03-21T17:00:34.990+0000","updated":"2013-03-21T17:00:34.990+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13618011","id":"13618011","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"What I know is that the bug is still present in CDH4.1 MR1. So we had to patch Capacity Scheduler there as well... ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2013-03-30T07:52:11.419+0000","updated":"2013-03-30T07:52:11.419+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13618429","id":"13618429","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"[~sergeant] Sorry, I lost track of this. I think you are right...\n\nA bit of history: The CS, initially, did not support multiple-slots per task i.e. HighRAM jobs. In that case, the check 'if (queueSlotsOccupied < queueCapacity)' was correct, since in that case queueCapacity would at least be (queueSlotsOccupied + 1), there-by satisfying the current ask. Obviously, that breaks with multiple slots per job... and hence the bug.\n\nThe bug exists in YARN (i.e. MR2) CapacityScheduler too - could you please provide a fix for that too? \n\nI'll go ahead and commit them both... thanks!\n\nApologies again for losing track of this! My bad.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-03-31T19:05:55.991+0000","updated":"2013-03-31T19:05:55.991+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13656800","id":"13656800","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mattf","name":"mattf","key":"mattf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Foley","active":true,"timeZone":"America/Los_Angeles"},"body":"Changed Target Version to 1.3.0 upon release of 1.2.0. Please change to 1.2.1 if you intend to submit a fix for branch-1.2.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mattf","name":"mattf","key":"mattf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Foley","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-14T05:14:41.662+0000","updated":"2013-05-14T05:14:41.662+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13657840","id":"13657840","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mroark","name":"mroark","key":"mroark","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Roark","active":true,"timeZone":"America/Chicago"},"body":"I applied Sergey's patch from the first comment in my cdh3u5 cluster and had some improvement for jobs with 3 slots per task, but the numbers did not change for other sizes of tasks. Sergey, do you think I'm doing something wrong?\n\nSame setup as above: https://issues.apache.org/jira/browse/MAPREDUCE-3859?focusedCommentId=13609117&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13609117\n\n||mapred.reduce.tasks||slots per reducer||expected running tasks||running tasks without patch||using slots without patch||running tasks with patch||using slots with patch||\n|30|1|30|30|30|30|30|\n|30|2|30|{color:red}16{color}|32|16|32|\n|30|3|20|{color:red}1{color}|3|{color:green}11{color}|33|\n|30|4|10|{color:red}8{color}|32|8|32|\n|30|5|10|{color:red}8{color}|40|8|40|\n|30|6|10|{color:red}8{color}|48|8|48|","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mroark","name":"mroark","key":"mroark","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Roark","active":true,"timeZone":"America/Chicago"},"created":"2013-05-15T03:12:55.047+0000","updated":"2013-05-15T03:12:55.047+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13658317","id":"13658317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"Mike, your test results look a little bit strange even for 2 slots per reducer. Because you've said that max capacity is 60. So I would expect that all 60 slots are used in this case. Try to play with \"user limit factor\". Also try to set up initial capacity to a little be higher value that 4 slots. I'm afraid there is another, not related to this, bug when \"slots per task\" > \"initial capacity\".\n\nArun, Matt, today I have a look into trunk (I believe this is what you call \"1.3.0\" release, because there is no 1.3 brunch). And I found there fully reworked capacity scheduler (YARN). There is another abstraction now which is called \"Resource\" instead of \"slot/task\". I was digging into it for a couple of hours and got to the feeling that this bug is gone there. I even found a test which tests something similar and tried to create my own test, but test case (TestLeafQueue.java) organized very poorly and, basically, tests nothing (mocks over mocks, no human readable logic and so on). Sorry, I've spent couple of hours trying to rewrite it and understood that it would take several more days for me. So I give it up. But, once again, the bug seems to be gone in YARN version of CS, so nothing to fix there.\n\nFor everyone else who is affected by this bug (old Capacity Scheduler), please, use a hot fix from my first comment. Or, Arun, you can commit that fix and attached test case (yep, old CapacityScheduler were covered by test cases much better than in yarn) to appropriate brunch - I just don't know which brunch to use and I didn't found \"contrib\" module in trunk.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-15T12:45:17.095+0000","updated":"2013-05-15T12:45:17.095+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13658844","id":"13658844","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mroark","name":"mroark","key":"mroark","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Roark","active":true,"timeZone":"America/Chicago"},"body":"Good call, I'd forgotten to readjust mapred.capacity-scheduler.default-user-limit-factor after I added some additional queues, so it was skewing the numbers.\n\nAfter fixing that I got exactly what I expected.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mroark","name":"mroark","key":"mroark","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Roark","active":true,"timeZone":"America/Chicago"},"created":"2013-05-15T21:26:09.951+0000","updated":"2013-05-15T21:26:09.951+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13659278","id":"13659278","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"Mike, that's great! So I think this task can be closed, unless someone from Cloudera (their MR1 in CDH4 is still be affected) wants to take care about this issue and port the fix to old Capacity Scheduler into their sources.\n\nFor the others who faces this issue, below is a brief step-by-step instruction for CDH4.1.2:\n   \n* Download sources from https://ccp.cloudera.com/display/SUPPORT/CDH+Downloads. Note: you need hadoop-0.20-mapreduce-0.20.2+1265 tarball.\n* Unpack it and go to root directory.\n* Apply changes from the first comment and test case from attached patch. \n* Also you should add the following lines:\n{code}\n    reactor.repo=https\\://repository.cloudera.com/content/repositories/snapshots\n    version=2.0.0-mr1-cdh4.1.2\n{code}\n    into src/contrib/index/ivy/libraries.properties and src/contrib/capacity-scheduler/ivy/libraries.properties files.\n* Test fixes that were made:\n{code}\n    ant test-contrib\n{code}\n* Build a jar file:\n{code}\n    cd src/contrib/capacity-scheduler/\n    ant jar\n    cd -\n{code}\n* The result file will be placed at build/contrib/capacity-scheduler/hadoop-capacity-scheduler-2.0.0-mr1-cdh4.1.2.jar.\n* Replace original file with the fixed on a node where JobTracker is started. Original file is placed in /usr/lib/hadoop-0.20-mapreduce/contrib/capacity-scheduler/ directory.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-16T06:14:57.319+0000","updated":"2013-05-16T06:14:57.319+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13660501","id":"13660501","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"[~sergeant] Sorry! I lost track of this again. Sincere apologies.\n\nThe same bug exists in CS in YARN:\n\n{noformat}\n    Resource currentCapacity =\n        Resources.lessThan(resourceCalculator, clusterResource, \n            usedResources, queueCapacity) ?\n            queueCapacity : Resources.add(usedResources, required);\n{noformat}\n\nDo you mind providing a patch for that too? Something like:\n\n{noformat}\nindex 64f7114..7d8800a 100644\n--- hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/LeafQueue.java\n+++ hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/LeafQueue.java\n@@ -997,7 +997,7 @@ private Resource computeUserLimit(FiCaSchedulerApp application,\n\n     Resource currentCapacity =\n         Resources.lessThan(resourceCalculator, clusterResource,\n-            usedResources, queueCapacity) ?\n+            Resources.add(usedResources, required), queueCapacity) ?\n             queueCapacity : Resources.add(usedResources, required);\n\n     // Never allow a single user to take more than the\n{noformat}\n\n\nGuilty as charged on mocks for testing in YARN... *smile*\n\nHowever, it does result in our tests running in ~20mins rather than 5-6hrs it takes in hadoop-1!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-17T09:06:07.579+0000","updated":"2013-05-17T09:06:07.579+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13660507","id":"13660507","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"[~sergeant] Please use hadoop/common/branches/branch-1 for MR1, and trunk for YARN.\n\nI'd appreciate if you could provide a full patch with the fix and the test-case for both branches - happy to help with YARN/trunk if you want. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-17T09:13:08.856+0000","updated":"2013-05-17T09:13:08.856+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13661829","id":"13661829","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"Fix is for MR1 only. Test + fix is in the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-20T07:34:27.211+0000","updated":"2013-05-20T07:34:27.211+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13661830","id":"13661830","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"testcase and fix","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-20T07:35:30.467+0000","updated":"2013-05-20T07:35:30.467+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13661831","id":"13661831","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12583806/MAPREDUCE-3859_MR1_fix_and_test.patch.txt\n  against trunk revision .\n\n    {color:red}-1 patch{color}.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-MAPREDUCE-Build/3653//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-20T07:41:28.537+0000","updated":"2013-05-20T07:41:28.537+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13661838","id":"13661838","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"Arun, I've attached patch for \"branch-1\" with testcase and fix (thanks for pointing me to the right branch). \n\n\"happy to help with YARN/trunk if you want.\" - yes, please. You know, I had troubles with understanding of test cases of YARN version of CS. I'm not sure about correctness of testing architecture, where there is one huge capacity scheduler configuration with lots of queues. This scheduler configuration is created at the beginning of each test by \"Before\" method and each test uses that configuration. I think this is not a good choice, because it doesn't allow to test edge cases and hard for understanding (there are no comments at all)). So please, could you help me and take care about fix for YARN.\n\nP.S. Hardcored mocks are great, but, personally, I'd prefer \"old school\" with inversion of control (\"strategy\" pattern) and agile architecture.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-20T07:50:52.585+0000","updated":"2013-05-20T07:50:52.585+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13662363","id":"13662363","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"[~sergeant] I've just committed this to branch-1 and branch-1.2, so we'll pick it up for hadoop-1.2.1.\n\nI've also help add a test case and add this to trunk/branch-2. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-20T21:09:25.713+0000","updated":"2013-05-20T21:09:25.713+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13662647","id":"13662647","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"body":"Thanks, Arun","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sergeant","name":"sergeant","key":"sergeant","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Tryuber","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-21T04:00:52.211+0000","updated":"2013-05-21T04:00:52.211+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13672748","id":"13672748","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm resolving this for MR1 since I'll need to open a separate YARN jira for branch-2.\n\nThanks Sergey!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-06-03T01:04:56.790+0000","updated":"2013-06-03T01:04:56.790+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13776788","id":"13776788","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mroark","name":"mroark","key":"mroark","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Roark","active":true,"timeZone":"America/Chicago"},"body":"I recently tested this issue in CDH4.2 to determine if we needed to patch it. I couldn't reproduce it, so it must have gotten fixed by that version.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mroark","name":"mroark","key":"mroark","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Roark","active":true,"timeZone":"America/Chicago"},"created":"2013-09-24T21:41:27.988+0000","updated":"2013-09-24T21:41:27.988+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12542496/comment/13792827","id":"13792827","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mroark","name":"mroark","key":"mroark","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Roark","active":true,"timeZone":"America/Chicago"},"body":"Correction, still an issue in CDH4.2. Fix is the as Sergey's comment for 4.1.2: https://issues.apache.org/jira/browse/MAPREDUCE-3859?focusedCommentId=13659278&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13659278","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mroark","name":"mroark","key":"mroark","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Roark","active":true,"timeZone":"America/Chicago"},"created":"2013-10-11T17:18:55.320+0000","updated":"2013-10-11T17:18:55.320+0000"}],"maxResults":33,"total":33,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-3859/votes","votes":6,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0af27:"}}