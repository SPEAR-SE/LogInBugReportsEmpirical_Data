{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12456127","self":"https://issues.apache.org/jira/rest/api/2/issue/12456127","key":"MAPREDUCE-1487","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2010-12-25T21:17:01.299+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Aug 10 10:20:47 UTC 2012","customfield_12310420":"149547","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-1487/watchers","watchCount":4,"isWatching":false},"created":"2010-02-12T10:12:01.914+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314047","id":"12314047","description":"","name":"0.20.1","archived":false,"released":true,"releaseDate":"2009-09-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314205","id":"12314205","description":"","name":"0.20.2","archived":false,"released":true,"releaseDate":"2010-02-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314045","id":"12314045","description":"","name":"0.21.0","archived":false,"released":true,"releaseDate":"2010-08-23"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-08-10T10:20:47.124+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"I was trying Google Protocol Buffer as a value type on hadoop,\nthen when I used it in reducer, the parser always failed.\nwhile it worked fine on a plain inputstream reader or mapper.\n\n\nthe reason is that the reducer interface in Task.java gave a buffer larger than an actual encoded record to the parser, and the parser does not stop until it reaches\nthe buffer end, so it parsed some  junk bytes.\n\n\nthe root cause is due to hadoop.io.DataInputBuffer.java :\n\nin 0.20.1  DataInputBuffer.java  line 47:\n\n    public void reset(byte[] input, int start, int length) {\n      this.buf = input;\n      this.count = start+length;\n      this.mark = start;\n      this.pos = start;\n    }\n\n    public byte[] getData() { return buf; }\n    public int getPosition() { return pos; }\n    public int getLength() { return count; }\n\n\n\nwe see that the above logic seems to assume that \"getLength()\" returns the total ** capacity ***, not the actual content length, of the buffer, yet latter code\nseems to assume the semantic that \"length\" is actual content length, i.e. end - start :\n\n /** Resets the data that the buffer reads. */\n  public void reset(byte[] input, int start, int length) {\n    buffer.reset(input, start, length);\n  }\n\ni.e. if u call reset( getPosition(), getLength() ) on the same buffer again and again, the \"length\" would be infinitely increased.\n\n\n\nthis confusion in semantic is reflected in  many places, at leat in IFile.java, and Task.java, where it caused the original issue.\naround line 980 of Task.java, we see\n   valueIn.reset(nextValueBytes.getData(), nextValueBytes.getPosition(), nextValueBytes.getLength())  \nif the position above is not empty, the above actually sets a buffer too long, causing the reported issue.\n\n\n\nchanging the Task.java as a hack , to \n      valueIn.reset(nextValueBytes.getData(), nextValueBytes.getPosition(), nextValueBytes.getLength() - nextValueBytes.getPosition());\n\nfixed the issue, but the semantic of DataInputBuffer should be fixed and streamlined","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"81251","customfield_12312823":null,"summary":"io.DataInputBuffer.getLength() semantic wrong/confused","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangyangyyy","name":"yangyangyyy","key":"yangyangyyy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yang Yang","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangyangyyy","name":"yangyangyyy","key":"yangyangyyy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yang Yang","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12456127/comment/12975073","id":"12975073","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sarthak.83%40gmail.com","name":"sarthak.83@gmail.com","key":"sarthak.83@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sarthak","active":true,"timeZone":"Etc/UTC"},"body":"Hi, \n\nI have a similar problem in Hadoop 0.20.2. \n\nI am trying to write a BSONWritable class that extends WritableComparable. It can be considered as an equivalent of IntWritable, FloatWritable,etc. However the length of the Key/Values produced by the Map step may/may not constant. \n\nI stepped through the Code and Specifically the ReduceContext.nextKeyValue() method line 115 does a buffer.reset().\n\n    DataInputBuffer next = input.getKey();\n    currentRawKey.set(next.getData(), next.getPosition(), \n                      next.getLength() - next.getPosition());\n    buffer.reset(currentRawKey.getBytes(), 0, currentRawKey.getLength());\n    key = keyDeserializer.deserialize(key);\n    next = input.getValue();\n    buffer.reset(next.getData(), next.getPosition(), next.getLength());\n    value = valueDeserializer.deserialize(value);\n\nIn the debugger, I see that the value length field in the  next object is 103. However, the next.getLength() returns the length of the data itself. In the reset method, this causes the 'count' field to increase on every call. \n\nIn the next step, the valueDeserializer fails as the data does not get reset properly due to the length field and hence the deserialization fails. The only way for me to get an accurate length of the Value in bytes is with the next.length field above. If the next.getLength() returns the correct value, then the deserialization step wrill work fine. \n\nI stepped through the same with another Map Reduce step that has an IntWritable output. So in the valueDeserializer.deserialize step, it calls the IntWritable.readFields() (which is pretty simple and reads only the next four bytes). \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sarthak.83%40gmail.com","name":"sarthak.83@gmail.com","key":"sarthak.83@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sarthak","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-25T21:17:01.299+0000","updated":"2010-12-25T21:17:01.299+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12456127/comment/12975074","id":"12975074","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sarthak.83%40gmail.com","name":"sarthak.83@gmail.com","key":"sarthak.83@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sarthak","active":true,"timeZone":"Etc/UTC"},"body":"Will this issue be prioritized? What is the procedure for these kinds of requests? I do not want to modify source code and then have the same issue when i upgrade to a newer version. \n\nFor now, I do not see a workaround for me in this case. I will still keep looking around for the same. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sarthak.83%40gmail.com","name":"sarthak.83@gmail.com","key":"sarthak.83@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sarthak","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-25T21:18:57.593+0000","updated":"2010-12-25T21:18:57.593+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12456127/comment/12976419","id":"12976419","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sarthak.83%40gmail.com","name":"sarthak.83@gmail.com","key":"sarthak.83@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sarthak","active":true,"timeZone":"Etc/UTC"},"body":"i am using 0.20.2 ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sarthak.83%40gmail.com","name":"sarthak.83@gmail.com","key":"sarthak.83@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sarthak","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-01T17:09:14.517+0000","updated":"2011-01-01T17:09:14.517+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12456127/comment/12984431","id":"12984431","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ppod","name":"ppod","key":"ppod","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pavel Podgoretsky","active":true,"timeZone":"Etc/UTC"},"body":"I can confirm this issue in 0.20.2 and by code inspection in 0.21.0.  The short-term fix I would propose is to add a method reset(DataInputBuffer other) to DataInputBuffer which preserves the slightly schizophrenic length~~endPosition semantics.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ppod","name":"ppod","key":"ppod","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pavel Podgoretsky","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-20T22:05:17.851+0000","updated":"2011-01-20T22:05:17.851+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12456127/comment/13432685","id":"13432685","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akvadrako","name":"akvadrako","key":"akvadrako","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Devin Bayer","active":true,"timeZone":"Europe/Berlin"},"body":"It's very embarrassing this issue isn't fixed. Do the developers realise Hadoop cannot even copy data from mapper to reducer without corruption?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akvadrako","name":"akvadrako","key":"akvadrako","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Devin Bayer","active":true,"timeZone":"Europe/Berlin"},"created":"2012-08-10T10:20:47.001+0000","updated":"2012-08-10T10:20:47.001+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-1487/votes","votes":5,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0e96v:"}}