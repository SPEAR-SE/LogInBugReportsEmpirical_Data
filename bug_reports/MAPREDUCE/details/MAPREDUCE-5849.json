{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12709270","self":"https://issues.apache.org/jira/rest/api/2/issue/12709270","key":"MAPREDUCE-5849","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-10-24T04:13:06.037+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Oct 24 04:13:06 UTC 2014","customfield_12310420":"387592","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-5849/watchers","watchCount":4,"isWatching":false},"created":"2014-04-18T14:41:13.454+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325257","id":"12325257","description":"2.3.0 release","name":"2.3.0","archived":false,"released":true,"releaseDate":"2014-02-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-10-24T04:13:06.037+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"Since ValueIterable reuses same iterator object it cannot be iterated more than once. This behaviour is counter-intuitive (with regards to Iterable usage) and thus difficult to spot.\n\nUnless there are particular performance concerns, new instance of Iterator should be returned.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"387854","customfield_12312823":null,"summary":"ReduceContextImpl.ValueIterable can only be iterated once","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vanyatka","name":"vanyatka","key":"vanyatka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Balashov","active":true,"timeZone":"Asia/Yerevan"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vanyatka","name":"vanyatka","key":"vanyatka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Balashov","active":true,"timeZone":"Asia/Yerevan"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12709270/comment/14182412","id":"14182412","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=morgany","name":"morgany","key":"morgany","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Morgany Mendes","active":true,"timeZone":"Etc/UTC"},"body":"I think that is not a bug, but, can be a design mistake on the signature of reduce method. Thinking about the following (simplified)  scenario:\n1. The reduce fase can start reducer tasks if there is some slot available in some task tracker.\n2. So, if some reducer for a specific key (in some specific partition) has started, then, the iterator within the values can only reach the end (false hasNext) after the map fase has reached the end.\n3. Therefore, if you try to iterate the values again. That will only happens after all the mappers has ended up its work.\n\nBecause receiving an Iterable<VALUE> make us naturally to think that iterator() method will return an new instance of Iterator<VALUE> positioned at the beginning. I would like to propose that the reduce method receive the Iterator<VALUE> (just like reduce on MRv1), instead of an Iterable<VALUE>. It can be done by implementing a new Reducer class which extends and deprecates the existent one and overriding the run() method calling the new reduce.\n\n@Deprecated\npublic class Reducer<KEYIN,VALUEIN,KEYOUT,VALUEOUT>{\n...\n}\n\npublic class NewReducer<KEYIN,VALUEIN,KEYOUT,VALUEOUT> extends Reducer<KEYIN,VALUEIN,KEYOUT,VALUEOUT>{\n\nprotected void reduce(KEYIN key, Iterator<VALUEIN> values, Context context\n                        ) throws IOException, InterruptedException {\n   \n    for (;iterator.hasNext();) {\n        VALUEIN value = iterator.next();\n        context.write((KEYOUT) key, (VALUEOUT) value);\n    }\n  }\n\n@Overrides\npublic void run(Context context) throws IOException, InterruptedException {\n    setup(context);\n    while (context.nextKey()) {\n      Iterator<VALUEIN> iter = context.getValues().iterator();\n      reduce(context.getCurrentKey(), iter, context);\n      // If a back up store is used, reset it\n      if(iter instanceof ReduceContext.ValueIterator) {\n        ((ReduceContext.ValueIterator<VALUEIN>)iter).resetBackupStore();       \n      }\n    }\n    cleanup(context);\n  }\n}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=morgany","name":"morgany","key":"morgany","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Morgany Mendes","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-24T04:13:06.037+0000","updated":"2014-10-24T04:13:06.037+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-5849/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1urof:"}}