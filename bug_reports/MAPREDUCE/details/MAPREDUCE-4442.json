{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12598754","self":"https://issues.apache.org/jira/rest/api/2/issue/12598754","key":"MAPREDUCE-4442","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2012-08-29T19:09:07.033+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Aug 31 00:26:58 UTC 2012","customfield_12310420":"252706","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-4442/watchers","watchCount":10,"isWatching":false},"created":"2012-07-13T20:22:51.095+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["usability"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12320354","id":"12320354","description":"hadoop-2.0.0-alpha release","name":"2.0.0-alpha","archived":false,"released":true,"releaseDate":"2012-05-23"}],"issuelinks":[{"id":"12357208","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12357208","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12540308","key":"MAPREDUCE-3755","self":"https://issues.apache.org/jira/rest/api/2/issue/12540308","fields":{"summary":"Add the equivalent of JobStatus to end of JobHistory file ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-02T02:30:54.129+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"We found this issue during our tests moving from MapReduceV1 to MapReduceV2. A few of our applications access job counters multiple times:\n\na) After submission of job, while job is execution (works fine)\n\nb) Right after job complete notification is received (works fine)\n\nc) Few seconds after job complete notification (fails most of the time).\n\nThe error snippet is as follows:\n\n{code}\n2012-07-12 19:12:29,039 WARN  [Client] Unexpected error reading responses on connection Thread[IPC Client (1252749669) connection to sjc1-ciq-ibm-grid07.carrieriq.com/10.202.50.187:47944 from hadoop,5,main]\njava.lang.NullPointerException\n\tat org.apache.hadoop.ipc.Client$Connection.receiveResponse(Client.java:852)\n\tat org.apache.hadoop.ipc.Client$Connection.run(Client.java:781)\n2012-07-12 19:12:29,044 INFO  [ClientServiceDelegate] Application state is completed. FinalApplicationStatus=SUCCEEDED. Redirecting to job history server\n2012-07-12 19:12:29,132 INFO  [ClientServiceDelegate] Application state is completed. FinalApplicationStatus=SUCCEEDED. Redirecting to job history server\n2012-07-12 19:12:29,216 ERROR [UserGroupInformation] PriviledgedActionException as:hadoop (auth:SIMPLE) cause:java.io.IOException\n2012-07-12 19:12:29,216 WARN  [BaseOutputStageJob] getJobCounters: Unable to retrieve counters. null\njava.io.IOException\n\tat org.apache.hadoop.mapred.ClientServiceDelegate.invoke(ClientServiceDelegate.java:315)\n\tat org.apache.hadoop.mapred.ClientServiceDelegate.getJobCounters(ClientServiceDelegate.java:335)\n\tat org.apache.hadoop.mapred.YARNRunner.getJobCounters(YARNRunner.java:470)\n\tat org.apache.hadoop.mapreduce.Job$8.run(Job.java:719)\n\tat org.apache.hadoop.mapreduce.Job$8.run(Job.java:716)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:396)\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1232)\n\tat org.apache.hadoop.mapreduce.Job.getCounters(Job.java:716)\n\tat org.apache.hadoop.mapred.JobClient$NetworkedJob.getCounters(JobClient.java:396)\n{code}\n\nThe connection to 10.202.50.187:47944 is actually the connection to AM; appears that we are connecting to AM to get the counters for the successful job and not yet to the history server.\n \nI'll attach the logs for AM and resource mgr separately, however no unusual activity is seen in those.\n\nThis makes me suspect that we have a race condition in the code trying to access job counters when AM is finishing up and the job hasn't moved to history server yet.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12536450","id":"12536450","filename":"am_logs_counter_failure.html","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rjain7","name":"rjain7","key":"rjain7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Jain","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-13T20:35:30.693+0000","size":2507079,"mimeType":"text/html","content":"https://issues.apache.org/jira/secure/attachment/12536450/am_logs_counter_failure.html"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12536451","id":"12536451","filename":"rsrc_mgr_logs_counter_failed.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rjain7","name":"rjain7","key":"rjain7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Jain","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-13T20:37:49.486+0000","size":3632,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12536451/rsrc_mgr_logs_counter_failed.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"74379","customfield_12312823":null,"summary":"Accessing hadoop counters from a job is unreliable in yarn during AM process cleanup  window","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rjain7","name":"rjain7","key":"rjain7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Jain","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rjain7","name":"rjain7","key":"rjain7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Jain","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598754/comment/13414026","id":"13414026","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rjain7","name":"rjain7","key":"rjain7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Jain","active":true,"timeZone":"America/Los_Angeles"},"body":"Attached AM logs for the full job; the timestamps should correlate to the application timestamps.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rjain7","name":"rjain7","key":"rjain7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Jain","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-13T20:35:30.743+0000","updated":"2012-07-13T20:35:30.743+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598754/comment/13414027","id":"13414027","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rjain7","name":"rjain7","key":"rjain7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Jain","active":true,"timeZone":"America/Los_Angeles"},"body":"Here is the snippet from resource mgr logs, relevant to the the time this happened.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rjain7","name":"rjain7","key":"rjain7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Jain","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-13T20:37:49.504+0000","updated":"2012-07-13T20:37:49.504+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598754/comment/13444332","id":"13444332","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ggoodson","name":"ggoodson","key":"ggoodson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Garth Goodson","active":true,"timeZone":"America/Los_Angeles"},"body":"I think I'm also running into this on both 2.0.0-alpha and 0.23.3.  I am executing the job remotely and polling the job status.  As soon as the job completes (successfully), I get the IOException at org.apache.hadoop.mapred.ClientServiceDelegate.invoke(ClientServiceDelegate.java:315).  After job submission (before completion) checking the job status works fine.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ggoodson","name":"ggoodson","key":"ggoodson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Garth Goodson","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-29T19:09:07.033+0000","updated":"2012-08-29T19:09:07.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598754/comment/13444511","id":"13444511","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sseth","name":"sseth","key":"sseth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Siddharth Seth","active":true,"timeZone":"America/Los_Angeles"},"body":"The client is supposed to try the operation 3 times by default, with 3 IPC level retries for each attempt. \nyarn.app.mapreduce.client.max-retries and yarn.app.mapreduce.client-am.ipc.max-retries.\nAre these set to something other than the default ?\n\nThe defaults, in most cases, should be sufficient for the application state to be updated in the RM, which would trigger a JobHistory redirect on one of the attempts. (Exceptions may be logged during the first 2 attempts, but should not be thrown by the client API)\nThe log posted above does actually mention a redirect \"Application state is completed. FinalApplicationStatus=SUCCEEDED. Redirecting to job history server\". In this case, it looks like there may have been an issue communicating with the JobHistory server (after the AM connection failed and the client was redirected). Are additional client logs available, or is it possible to get logs at DEBUG level ?\n\nIAC, we could modify the AM to wait for the RM state for the app to move to FINISHED, before exiting - to avoid failures when the RM is slow to move an app to the FINISHED state.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sseth","name":"sseth","key":"sseth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Siddharth Seth","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-29T23:01:50.620+0000","updated":"2012-08-29T23:01:50.620+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598754/comment/13444729","id":"13444729","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rjain7","name":"rjain7","key":"rjain7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Jain","active":true,"timeZone":"America/Los_Angeles"},"body":"Here is the workaround we've put; the time where job counters, state etc are unavailable appears to depend upon the number of mappers/reducers for the job: the more tasks there are, the more time it will take to get access to counters restored.\n\nWe didn't have to worry about this issue any more after the workaround described below was put in place.\n\n{code}\n   RunningJob job = jobThatCompleted;\n  // Allow 20 seconds wait, and 0.005 seconds additional per mapper/reducer\n        long maxWaitInSecs = 20 + Math.round((numMaps + numReduces) * 0.005);\n        long currWait = 0;\n        long waitIncr = 1;\n\n        do {\n            try {\n                return job.getCounters();\n                \n            } catch (IOException e) {\n                LOG.error(\"Could not access job counters due to exception;\" + e);\n                if (currWait < maxWaitInSecs) {\n                    LOG.info(\"Waiting for \" + waitIncr + \" seconds before another attempt; max remaining wait=\"\n                                    + (maxWaitInSecs - currWait));\n                    try {\n                        Thread.sleep(waitIncr * 1000);\n                    } catch (InterruptedException ie) {\n                        LOG.warn(\"interrupted waitForJobCountersAccess() \", ie);\n                    }\n                    currWait += waitIncr;\n                    waitIncr += 1;\n                    continue;\n                } else {\n                    LOG.error(\"Exceeded maximum wait for job counters; aborting with received exception\", e);\n                    throw new RuntimeException(e);\n                }\n            }\n        } while (currWait < maxWaitInSecs);\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rjain7","name":"rjain7","key":"rjain7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Jain","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-30T06:20:12.286+0000","updated":"2012-08-30T06:20:12.286+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598754/comment/13445505","id":"13445505","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sseth","name":"sseth","key":"sseth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Siddharth Seth","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks. That explains some of it. The history server needs to read the entire history file before it can serve out job level information. That becomes very inefficient for larger jobs. MAPREDUCE-3755 is meant to fix this. Clients should not need to change code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sseth","name":"sseth","key":"sseth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Siddharth Seth","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-31T00:26:58.692+0000","updated":"2012-08-31T00:26:58.692+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-4442/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0d3pz:"}}