{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12693360","self":"https://issues.apache.org/jira/rest/api/2/issue/12693360","key":"MAPREDUCE-5740","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2014-02-05 14:43:51.061","customfield_12310420":"371945","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-5740/watchers","watchCount":1,"isWatching":false},"created":"2014-02-05T14:43:51.061+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325050","id":"12325050","description":"2.2.0 release","name":"2.2.0","archived":false,"released":true,"releaseDate":"2013-10-15"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-02-05T14:43:51.061+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"When running tests that leverage MiniMRYARNCluster a failure occurs during the jenkins build, however, the tests are successful on local workstations.\n\nThe exception found is as follows: \n{quote}\n2014-01-30 10:59:28,649 ERROR [ShuffleHandler.java:510] Shuffle error :\njava.io.IOException: Error Reading IndexFile\n\tat org.apache.hadoop.mapred.IndexCache.readIndexFileToCache(IndexCache.java:123)\n\tat org.apache.hadoop.mapred.IndexCache.getIndexInformation(IndexCache.java:68)\n\tat org.apache.hadoop.mapred.ShuffleHandler$Shuffle.sendMapOutput(ShuffleHandler.java:592)\n\tat org.apache.hadoop.mapred.ShuffleHandler$Shuffle.messageReceived(ShuffleHandler.java:503)\n\tat org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)\n\tat org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:560)\n\tat org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:787)\n\tat org.jboss.netty.handler.stream.ChunkedWriteHandler.handleUpstream(ChunkedWriteHandler.java:142)\n\tat org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:560)\n\tat org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:787)\n\tat org.jboss.netty.handler.codec.http.HttpChunkAggregator.messageReceived(HttpChunkAggregator.java:148)\n\tat org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)\n\tat org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:560)\n\tat org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:787)\n\tat org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:296)\n\tat org.jboss.netty.handler.codec.frame.FrameDecoder.unfoldAndFireMessageReceived(FrameDecoder.java:459)\n\tat org.jboss.netty.handler.codec.replay.ReplayingDecoder.callDecode(ReplayingDecoder.java:536)\n\tat org.jboss.netty.handler.codec.replay.ReplayingDecoder.messageReceived(ReplayingDecoder.java:435)\n\tat org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)\n\tat org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:560)\n\tat org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:555)\n\tat org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:268)\n\tat org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:255)\n\tat org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:88)\n\tat org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:107)\n\tat org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:312)\n\tat org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:88)\n\tat org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178)\n\tat org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)\n\tat org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n\tat java.lang.Thread.run(Thread.java:722)\nCaused by: java.io.FileNotFoundException: /home/sitebuild/jenkins/workspace/%7Binventory-engineering%7D-snapshot-workflow-%7BS7274%7D/target/Integration-Tests/Integration-Tests-localDir-nm-0_2/usercache/sitebuild/appcache/application_1391108343099_0001/output/attempt_1391108343099_0001_m_000000_0/file.out.index\n\tat org.apache.hadoop.fs.RawLocalFileSystem.open(RawLocalFileSystem.java:210)\n\tat org.apache.hadoop.fs.FileSystem.open(FileSystem.java:763)\n\tat org.apache.hadoop.io.SecureIOUtils.openFSDataInputStream(SecureIOUtils.java:156)\n\tat org.apache.hadoop.mapred.SpillRecord.<init>(SpillRecord.java:70)\n\tat org.apache.hadoop.mapred.SpillRecord.<init>(SpillRecord.java:62)\n\tat org.apache.hadoop.mapred.IndexCache.readIndexFileToCache(IndexCache.java:119)\n\t... 32 more\n{quote}\n\n\nIt was found that org.apache.hadoop.mapred.SpillRecord does a toURI on the indexFileName Path object (line 71). Jenkins uses {} to denote team and branch. These {} characters are being URL encoded, which causes the FileNotFoundException during the shuffle phase.\n\nInterestingly, the code snippet is as follows and seems a little strange to be doing the Path.toUri() so high up in the call:\n\n{code}\npublic SpillRecord(Path indexFileName, JobConf job, Checksum crc, String expectedIndexOwner)  throws IOException {\n\n    final FileSystem rfs = FileSystem.getLocal(job).getRaw();\n\n    final FSDataInputStream in =\n\n        SecureIOUtils.openFSDataInputStream(new File(indexFileName.toUri().getRawPath()), expectedIndexOwner, null);\n\n....\n\n}\n{code}\n\nand SecureIOUtils creates a Path from the File object (!):\n\n{code}\npublic static FSDataInputStream openFSDataInputStream(File file,\n\n      String expectedOwner, String expectedGroup) throws IOException {\n\n    if (!UserGroupInformation.isSecurityEnabled()) {\n\n      return rawFilesystem.open('''new Path(file.getAbsolutePath())''');\n\n    }\n\n    return forceSecureOpenFSDataInputStream(file, expectedOwner, expectedGroup);\n\n  }\n{code}\n\nThe rawFileSystem.open(Path) code, above, is executed by the abstract class FileSystem that delegates to the child class at runtime, which could be any of:\n\t•\tChRootedFileSystem\n\t•\tChecksumFileSystem\n\t•\tDistributedFileSystem\n\t•\tFtpFileSystem\n\t•\tWebHdfsFileSystem\n\t•\tand others\n\nURL escaping makes sense for the WebHdfsFileSystem and some others, but not for all. It seems to make sense to only URL escape within FileSystem implementations that require it.\n\nAlso of note: MiniMRYarnCluster allows for changing a bulk of the directories it uses via org.apache.hadoop.yarn.conf.YarnConfiguration, however testWorkDir is not one of them. testWorkDir is hardcoded to use the following in org.apache.hadoop.yarn.server.MiniYARNCluster.java\n\n{code}\npublic MiniYARNCluster(String testName, int noOfNodeManagers,\n                         int numLocalDirs, int numLogDirs) {\n    super(testName.replace(\"$\", \"\"));\n    this.numLocalDirs = numLocalDirs;\n    this.numLogDirs = numLogDirs;\n    this.testWorkDir = new File(\"target\",\n        testName.replace(\"$\", \"\"));\n....\n}\n{code}\n\nIf modifications to SpillRecord are undesirable, allowing testWorkDir to be configurable might be a good workaround.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"372249","customfield_12312823":null,"summary":"Shuffle error when the MiniMRYARNCluster work path contains special characters","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shanekumpf","name":"shanekumpf","key":"shanekumpf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Inactive","active":true,"timeZone":"America/Denver"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shanekumpf","name":"shanekumpf","key":"shanekumpf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Inactive","active":true,"timeZone":"America/Denver"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-5740/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1s3n3:"}}