{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12686838","self":"https://issues.apache.org/jira/rest/api/2/issue/12686838","key":"MAPREDUCE-5703","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2013-12-31T23:15:20.917+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat May 09 00:41:48 UTC 2015","customfield_12310420":"365831","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_42645242405_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-05-09T00:41:48.704+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-5703/watchers","watchCount":7,"isWatching":false},"created":"2013-12-31T10:47:46.376+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12424183","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12424183","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12671240","key":"MAPREDUCE-5547","self":"https://issues.apache.org/jira/rest/api/2/issue/12671240","fields":{"summary":"Job history should not be flushed to JHS until AM gets unregistered","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-05-09T00:41:48.746+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312982","id":"12312982","name":"client","description":"Code for submitting and monitoring jobs"}],"timeoriginalestimate":null,"description":"1) Run MR job \n2) After reduce completed and while JHS file writing, restart DN.\n\nRM side job is shown as successful.\nJHS doesnt have info about the job.\nJob client gets NPE and exit code as 255.\n\njava.io.IOException: org.apache.hadoop.ipc.RemoteException(java.lang.NullPointerException): java.lang.NullPointerException\n\tat org.apache.hadoop.mapreduce.v2.hs.HistoryClientService$HSClientProtocolHandler.getTaskAttemptCompletionEvents(HistoryClientService.java:269)\n\tat org.apache.hadoop.mapreduce.v2.api.impl.pb.service.MRClientProtocolPBServiceImpl.getTaskAttemptCompletionEvents(MRClientProtocolPBServiceImpl.java:173)\n\tat org.apache.hadoop.yarn.proto.MRClientProtocol$MRClientProtocolService$2.callBlockingMethod(MRClientProtocol.java:283)\n\tat org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:585)\n\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:929)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2080)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2076)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:396)\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1491)\n\tat org.apache.hadoop.ipc.Server$Handler.run(Server.java:2074)\n\n\tat org.apache.hadoop.mapred.ClientServiceDelegate.invoke(ClientServiceDelegate.java:330)\n\tat org.apache.hadoop.mapred.ClientServiceDelegate.getTaskCompletionEvents(ClientServiceDelegate.java:382)\n\tat org.apache.hadoop.mapred.YARNRunner.getTaskCompletionEvents(YARNRunner.java:529)\n\tat org.apache.hadoop.mapreduce.Job$5.run(Job.java:668)\n\tat org.apache.hadoop.mapreduce.Job$5.run(Job.java:665)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:396)\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1491)\n\tat org.apache.hadoop.mapreduce.Job.getTaskCompletionEvents(Job.java:665)\n\tat org.apache.hadoop.mapreduce.Job.monitorAndPrintJob(Job.java:1349)\n\tat org.apache.hadoop.mapred.JobClient$NetworkedJob.monitorAndPrintJob(JobClient.java:407)\n\tat org.apache.hadoop.mapred.JobClient.monitorAndPrintJob(JobClient.java:855)\n\tat org.apache.hadoop.mapred.JobClient.runJob(JobClient.java:835)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"366138","customfield_12312823":null,"summary":"Job client gets failure though RM side job execution result is FINISHED and SUCCEEDED","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutosh_jindal","name":"ashutosh_jindal","key":"ashutosh_jindal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Jindal","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutosh_jindal","name":"ashutosh_jindal","key":"ashutosh_jindal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Jindal","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12686838/comment/13859772","id":"13859772","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jianhe","name":"jianhe","key":"jianhe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jian He","active":true,"timeZone":"America/Los_Angeles"},"body":"The problem is likely being that while JHS is copying the history file, but the files are not successfully written and JHS certainly doesn't have the info about the job. And the JobClient is querying the JHS about the job after it gets known from RM that the job is finished. Since the job doesn't exist in JHS, it throws NPE. But only restarting one DN shouldn't affect so much, only if this is the only DN in the cluster.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jianhe","name":"jianhe","key":"jianhe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jian He","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-12-31T23:15:20.917+0000","updated":"2013-12-31T23:15:20.917+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12686838/comment/13860088","id":"13860088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutosh_jindal","name":"ashutosh_jindal","key":"ashutosh_jindal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Jindal","active":true,"timeZone":"Asia/Kolkata"},"body":"@Jian\n\nYes , the issue was caused due to write failure at the DN and i had only one data node. Thanks for review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutosh_jindal","name":"ashutosh_jindal","key":"ashutosh_jindal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Jindal","active":true,"timeZone":"Asia/Kolkata"},"created":"2014-01-02T08:47:37.573+0000","updated":"2014-01-02T08:47:37.573+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12686838/comment/14099376","id":"14099376","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.jian.fang","name":"john.jian.fang","key":"john.jian.fang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jian Fang","active":true,"timeZone":"America/Los_Angeles"},"body":"We have a cluster with 3 data nodes, but due to some reason, the job history was not persisted successfully as shown in the AM log.\n\n-------------------------------------------------------------LOG----------------------------------------------------------------------\n ERROR [eventHandlingThread] org.apache.hadoop.mapreduce.jobhistory.JobHistoryEventHandler: Error writing History Event: org.apache.hadoop.mapreduce.jobhistory.MapAttemptFinishedEvent@1f2cfc93\njava.io.IOException: All datanodes 10.253.21.212:9200 are bad. Aborting...\n        at org.apache.hadoop.hdfs.DFSOutputStream$DataStreamer.setupPipelineForAppendOrRecovery(DFSOutputStream.java:1140)\n        at org.apache.hadoop.hdfs.DFSOutputStream$DataStreamer.processDatanodeError(DFSOutputStream.java:936)\n        at org.apache.hadoop.hdfs.DFSOutputStream$DataStreamer.run(DFSOutputStream.java:491)\n----------------------------------------------------------------------------------------------------------------------------------------\n\nAs a result, the job failed and threw NPE. The bad thing is the job was marked as failed even though the job actually finished successfully. \n\nThis means this NPE could happen frequently if the cluster size is not big and it is not an edge case. \n\nThe method GetTaskAttemptCompletionEventsResponse() fetched a Job by calling verifyAndGetJob(), but it never checked if job was null or not, which was the root cause of this issue.\n\n    public GetTaskAttemptCompletionEventsResponse\n        getTaskAttemptCompletionEvents(\n            GetTaskAttemptCompletionEventsRequest request) throws IOException {\n      JobId jobId = request.getJobId();\n      int fromEventId = request.getFromEventId();\n      int maxEvents = request.getMaxEvents();\n\n      Job job = verifyAndGetJob(jobId);\n      GetTaskAttemptCompletionEventsResponse response = recordFactory.newRecordInstance(GetTaskAttemptCompletionEventsResponse.class);\n      response.addAllCompletionEvents(Arrays.asList(job.getTaskAttemptCompletionEvents(fromEventId, maxEvents)));\n      return response;\n    }\n\nSince people may face this problem often for a small cluster, what would be the best way to fix this issue then? Do retry when save the job to HDFS? Or something else?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.jian.fang","name":"john.jian.fang","key":"john.jian.fang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jian Fang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-16T00:14:29.422+0000","updated":"2014-08-16T00:14:29.422+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12686838/comment/14310047","id":"14310047","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.jian.fang","name":"john.jian.fang","key":"john.jian.fang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jian Fang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Jian He, could you please response to this jira? We have seen this issue couple times in our production clusters. You could give us a hint on what would be the best way to resolve this issue and then we can work on a fix for this. Thanks in advance.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=john.jian.fang","name":"john.jian.fang","key":"john.jian.fang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jian Fang","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-02-06T22:21:10.162+0000","updated":"2015-02-06T22:21:10.162+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12686838/comment/14536034","id":"14536034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinodkv","name":"vinodkv","key":"vinodkv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinod Kumar Vavilapalli","active":true,"timeZone":"America/Los_Angeles"},"body":"I have run into the same problem many times before.\n - The reason why AM would fail writing the history-file is because it goes out of good nodes to write to. The reports on this JIRA (1 node cluster, 3 nodes cluster) point to this.\n - The reason why RM says it succeeded, but JHS cannot say so is the same as that of MAPREDUCE-5547.\n\nClosing as dup. Please revert back if you disagree.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinodkv","name":"vinodkv","key":"vinodkv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinod Kumar Vavilapalli","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-09T00:41:48.737+0000","updated":"2015-05-09T00:41:48.737+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-5703/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1r25z:"}}