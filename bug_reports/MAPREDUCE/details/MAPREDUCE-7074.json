{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13151093","self":"https://issues.apache.org/jira/rest/api/2/issue/13151093","key":"MAPREDUCE-7074","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329060","id":"12329060","description":"2.8.0 release","name":"2.8.0","archived":false,"released":true,"releaseDate":"2017-03-22"}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2018-04-09 15:39:56.28","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-7074/watchers","watchCount":2,"isWatching":false},"created":"2018-04-09T15:39:56.280+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329060","id":"12329060","description":"2.8.0 release","name":"2.8.0","archived":false,"released":true,"releaseDate":"2017-03-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341437","id":"12341437","description":"3.0.0 GA release","name":"3.0.0","archived":false,"released":true,"releaseDate":"2017-12-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-04-09T15:45:43.765+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12314301","id":"12314301","name":"mrv2","description":"MR-279: Map Reduce Next."},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312920","id":"12312920","name":"task","description":"The code that runs in the child task process."}],"timeoriginalestimate":null,"description":"When a MR job like this:\r\n - MR job with many map tasks, such as 10000 or more\r\n - a few map output were lost or corrupted after map task complete successfully and before shuffle start\r\n - mapreduce.task.timeout was set to 0 and mapreduce.task.progress-report.interval was not set\r\n\r\nthe shuffle of reduce task will get stuck in fetch failures loop for a long time, several or even dozens of hours.\r\n\r\nIt was caused by MAPREDUCE-6740, it releate mapreduce.task.timeout with mapreduce.task.progress-report.interval by MRJobConfUtil.getTaskProgressReportInterval()\r\n{code:java}\r\n  public static long getTaskProgressReportInterval(final Configuration conf) {\r\n    long taskHeartbeatTimeOut = conf.getLong(\r\n        MRJobConfig.TASK_TIMEOUT, MRJobConfig.DEFAULT_TASK_TIMEOUT_MILLIS);\r\n    return conf.getLong(MRJobConfig.TASK_PROGRESS_REPORT_INTERVAL,\r\n        (long) (TASK_REPORT_INTERVAL_TO_TIMEOUT_RATIO * taskHeartbeatTimeOut));\r\n  }\r\n{code}\r\nWhen mapreduce.task.timeout was set to 0 and mapreduce.task.progress-report.interval was not set, getTaskProgressReportInterval will retrun 0L.\r\n In the class TaskReporter which is used to report task progress and status to AM, it set taskProgressInterval= MRJobConfUtil.getTaskProgressReportInterval(), and lock.wait(taskProgressInterval) before every progress report.\r\n{code:java}\r\n public void run() {\r\n      ...skip...\r\n      long taskProgressInterval = MRJobConfUtil.\r\n          getTaskProgressReportInterval(conf);\r\n      while (!taskDone.get()) {\r\n        ...skip...\r\n        try {\r\n          // sleep for a bit\r\n          synchronized(lock) {\r\n            if (taskDone.get()) {\r\n              break;\r\n            }\r\n            lock.wait(taskProgressInterval);\r\n          }\r\n          if (taskDone.get()) {\r\n            break;\r\n          }\r\n          if (sendProgress) {\r\n            // we need to send progress update\r\n            updateCounters();\r\n            taskStatus.statusUpdate(taskProgress.get(),\r\n                                    taskProgress.toString(), \r\n                                    counters);\r\n            taskFound = umbilical.statusUpdate(taskId, taskStatus);\r\n            taskStatus.clearStatus();\r\n          }\r\n          ...skip...\r\n        } \r\n        ...skip...\r\n      }\r\n   }\r\n{code}\r\nWhen mapreduce.task.timeout was set to 0, lock.wait(taskProgressInterval) will be lock.wait(0), and because there is no operation to notify it ,the reporter will wait all the time and don't report anything to AM. \r\n So, when fetch failures happend in shuffle, TaskReporter will not report fetch failures to AM , although the log of reducer show message\"Reporting fetch failure...\", and the fetch failures loop will not stop util reduce task failed for exceeded MAX_FAILED_UNIQUE_FETCHES.\r\n\r\nSo, it's necessary to set a TASK_PROGRESS_REPORT_INTERVAL_MAX value (such as 30s) when the taskProgressInterval return by MRJobConfUtil.getTaskProgressReportInterval() equals 0 or beyond the max value, set the taskProgressInterval = TASK_PROGRESS_REPORT_INTERVAL_MAX. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329060","id":"12329060","description":"2.8.0 release","name":"2.8.0","archived":false,"released":true,"releaseDate":"2017-03-22"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12918178","id":"12918178","filename":"ExceptionMsg.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smarthan","name":"smarthan","key":"smarthan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"smarthan","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-09T15:45:42.962+0000","size":37572,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12918178/ExceptionMsg.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12918179","id":"12918179","filename":"MAPREDUCE-7074.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smarthan","name":"smarthan","key":"smarthan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"smarthan","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-09T15:45:42.984+0000","size":2367,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12918179/MAPREDUCE-7074.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Shuffle  get stuck in fetch failures loop, when a few mapoutput were lost or corrupted and task timeout was set to 0","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smarthan","name":"smarthan","key":"smarthan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"smarthan","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smarthan","name":"smarthan","key":"smarthan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"smarthan","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"cdh 5.10.0 ,  apache hadoop 2.8.0","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-7074/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3sbl3:"}}