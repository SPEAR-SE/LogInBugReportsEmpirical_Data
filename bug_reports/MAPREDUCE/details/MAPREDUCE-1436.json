{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12454977","self":"https://issues.apache.org/jira/rest/api/2/issue/12454977","key":"MAPREDUCE-1436","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310941","id":"12310941","key":"MAPREDUCE","name":"Hadoop Map/Reduce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310941&avatarId=10096","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310941&avatarId=10096","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310941&avatarId=10096","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310941&avatarId=10096"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":"2010-02-01T21:28:49.626+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Feb 22 01:43:49 UTC 2010","customfield_12310420":"37315","customfield_12312320":null,"customfield_12310222":"10002_*:*_2_*:*_1702555361_*|*_1_*:*_2_*:*_46272377_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-02-22T01:43:49.973+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-1436/watchers","watchCount":4,"isWatching":false},"created":"2010-02-01T19:56:42.235+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314045","id":"12314045","description":"","name":"0.21.0","archived":false,"released":true,"releaseDate":"2010-08-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314184","id":"12314184","description":"","name":"0.22.0","archived":false,"released":true,"releaseDate":"2011-12-10"}],"issuelinks":[{"id":"12330314","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330314","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"12456514","key":"MAPREDUCE-1499","self":"https://issues.apache.org/jira/rest/api/2/issue/12456514","fields":{"summary":"JobTracker.finalizeJob inverts lock order and causes potential deadlock","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-02-22T01:43:49.971+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312901","id":"12312901","name":"contrib/fair-share"}],"timeoriginalestimate":null,"description":"In testing the fair scheduler with preemption, I found a deadlock between updatePreemptionVariables and some code in the JobTracker. This was found while testing a backport of the fair scheduler to Hadoop 0.20, but it looks like it could also happen in trunk and 0.21. Details are in a comment below.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12434737","id":"12434737","filename":"deadlock.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-04T00:14:38.199+0000","size":38985,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12434737/deadlock.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12434430","id":"12434430","filename":"mapreduce-1436.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-01T20:37:11.173+0000","size":2231,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12434430/mapreduce-1436.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12435844","id":"12435844","filename":"mapreduce-1436-v2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-15T03:41:37.617+0000","size":6157,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12435844/mapreduce-1436-v2.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"14277","customfield_12312823":null,"summary":"Deadlock in preemption code in fair scheduler","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12828249","id":"12828249","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"Here is jstack output showing the problem:\n\n{code}\nFound one Java-level deadlock:\n=============================\n\"72353846@qtp0-7\":\n  waiting to lock monitor 0x00000000423f6370 (object 0x00007f22039e2b48, a org.apache.hadoop.mapred.JobTracker),\n  which is held by \"IPC Server handler 14 on 9001\"\n\"IPC Server handler 14 on 9001\":\n  waiting to lock monitor 0x0000000041cdc130 (object 0x00007f22039e2fa8, a org.apache.hadoop.mapred.FairScheduler),\n  which is held by \"FairScheduler update thread\"\n\"FairScheduler update thread\":\n  waiting to lock monitor 0x0000000041c29fa8 (object 0x00007f2260640948, a org.apache.hadoop.mapred.JobInProgress),\n  which is held by \"IPC Server handler 14 on 9001\"\n\nJava stack information for the threads listed above:\n===================================================\n\"72353846@qtp0-7\":\n\tat org.apache.hadoop.mapred.JobTracker.getClusterStatus(JobTracker.java:3071)\n\t- waiting to lock <0x00007f22039e2b48> (a org.apache.hadoop.mapred.JobTracker)\n\tat org.apache.hadoop.mapred.jobtracker_jsp._jspService(jobtracker_jsp.java:91)\n\tat org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:97)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:820)\n\tat org.mortbay.jetty.servlet.ServletHolder.handle(ServletHolder.java:502)\n\tat org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:363)\n\tat org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)\n\tat org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)\n\tat org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:766)\n\tat org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:417)\n\tat org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:230)\n\tat org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\n\tat org.mortbay.jetty.Server.handle(Server.java:324)\n\tat org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:534)\n\tat org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:864)\n\tat org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:533)\n\tat org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:207)\n\tat org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:403)\n\tat org.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:409)\n\tat org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:522)\n\"IPC Server handler 14 on 9001\":\n\tat org.apache.hadoop.mapred.JobTracker.finalizeJob(JobTracker.java:2115)\n\t- waiting to lock <0x00007f22039e2fa8> (a org.apache.hadoop.mapred.FairScheduler)\n\t- locked <0x00007f22039e33e0> (a java.util.TreeMap)\n\t- locked <0x00007f22039e2b48> (a org.apache.hadoop.mapred.JobTracker)\n\tat org.apache.hadoop.mapred.JobInProgress.garbageCollect(JobInProgress.java:2510)\n\t- locked <0x00007f2260640948> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobInProgress.jobComplete(JobInProgress.java:2146)\n\tat org.apache.hadoop.mapred.JobInProgress.completedTask(JobInProgress.java:2084)\n\t- locked <0x00007f2260640948> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobInProgress.updateTaskStatus(JobInProgress.java:883)\n\t- locked <0x00007f2260640948> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobTracker.updateTaskStatuses(JobTracker.java:3564)\n\tat org.apache.hadoop.mapred.JobTracker.processHeartbeat(JobTracker.java:2758)\n\t- locked <0x00007f22039e2b48> (a org.apache.hadoop.mapred.JobTracker)\n\tat org.apache.hadoop.mapred.JobTracker.heartbeat(JobTracker.java:2553)\n\t- locked <0x00007f22039e2b48> (a org.apache.hadoop.mapred.JobTracker)\n\tat sun.reflect.GeneratedMethodAccessor7.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:508)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:959)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:955)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:396)\n\tat org.apache.hadoop.ipc.Server$Handler.run(Server.java:953)\n\"FairScheduler update thread\":\n\tat org.apache.hadoop.mapred.JobInProgress.runningMaps(JobInProgress.java:549)\n\t- waiting to lock <0x00007f2260640948> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobSchedulable.getRunningTasks(JobSchedulable.java:103)\n\tat org.apache.hadoop.mapred.PoolSchedulable.getRunningTasks(PoolSchedulable.java:129)\n\tat org.apache.hadoop.mapred.FairScheduler.isStarvedForMinShare(FairScheduler.java:704)\n\tat org.apache.hadoop.mapred.FairScheduler.updatePreemptionVariables(FairScheduler.java:686)\n\tat org.apache.hadoop.mapred.FairScheduler.update(FairScheduler.java:595)\n\t- locked <0x00007f22039e2fa8> (a org.apache.hadoop.mapred.FairScheduler)\n\tat org.apache.hadoop.mapred.FairScheduler$UpdateThread.run(FairScheduler.java:277)\n{code}\n\nThe issue is that the JobTracker locks the JT, then a JobInProgress, and then tries to lock the FairScheduler in finalizeJob. However, the fair scheduler's updatePreemptionVariables code locks the scheduler before attempting to lock the JobInProgress. The right thing is to lock the JobTracker before the FairScheduler. This happens in update() (to get the cluster status) but not in updatePreemptionVariables().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-01T19:59:31.903+0000","updated":"2010-02-01T19:59:31.903+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12828261","id":"12828261","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"Here's a patch that fixes the problem as discussed above: In updatePreemptionVariables, we make sure to lock the JobTracker before locking the scheduler, and only then do we proceed to call functions which require locking JobInProgress (such as JobSchedulable.runningTasks()). ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-01T20:37:11.212+0000","updated":"2010-02-01T20:37:11.212+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12828276","id":"12828276","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Patch looks good to me. Confused why jcarder didn't pick this up when I ran it recently, but I'll investigate that separately.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-01T21:28:49.626+0000","updated":"2010-02-01T21:28:49.626+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12828277","id":"12828277","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"I've looked at the JobTracker code and the locking seems to be similar in trunk to how it is in 0.20. However, I'll double-check.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-01T21:35:59.466+0000","updated":"2010-02-01T21:35:59.466+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12828463","id":"12828463","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"Looked at the JT code in trunk again, and it does look like it could run into the same bug. Todd, is it okay for me to commit the patch? I'm going to commit it to both trunk and 0.21.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-02T06:07:51.459+0000","updated":"2010-02-02T06:07:51.459+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12828608","id":"12828608","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12434430/mapreduce-1436.patch\n  against trunk revision 905008.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Mapreduce-Patch-h6.grid.sp2.yahoo.net/425/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Mapreduce-Patch-h6.grid.sp2.yahoo.net/425/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Mapreduce-Patch-h6.grid.sp2.yahoo.net/425/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Mapreduce-Patch-h6.grid.sp2.yahoo.net/425/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-02-02T12:09:58.942+0000","updated":"2010-02-02T12:09:58.942+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12828821","id":"12828821","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"The patch contains no unit tests because it's a bug fix for a deadlock. The unit test failure is unrelated, as it is in streaming.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-02T23:04:02.510+0000","updated":"2010-02-02T23:04:02.510+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12829336","id":"12829336","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hey Matei. Here's another potential deadlock. Now that I see this one, I realize I actually ran into the one you're fixing here before - I had thought it was unique to the unit tests, but I think it really is a problem.\n\nCan you take a look at this cycle and see what you think? If it's a separate issue, maybe we can do it in a new jira. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-04T00:14:41.117+0000","updated":"2010-02-04T00:14:41.117+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12829508","id":"12829508","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Todd,\n\nIt looks like that particular problem won't happen with a real JobTracker because the JobTracker only calls listener.jobAdded/jobRemoved when it is already holding a lock on itself (e.g. in JobTracker.addJob). However, it might not hurt to acquire the lock in FairScheduler, in case this JobTracker behavior changes. Do you think it's better to do that, or to \"fix\" the fake TaskTrackerManager?\n\nIn older versions of the fair scheduler, I *always* locked the JT before locking the scheduler. Some of the Yahoo guys removed this because they said it led to scalability issues, though maybe that isn't a problem anymore.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-04T07:14:01.161+0000","updated":"2010-02-04T07:14:01.161+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12831071","id":"12831071","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hey Matei, sorry for the slow response - I forgot to watch this ticket.\n\nbq. JobTracker only calls listener.jobAdded/jobRemoved when it is already holding a lock on itself (e.g. in JobTracker.addJob).\n\nI think it's best to still synchronize on TaskTrackerManager here from within the fairsched. I think a synchronized block on a monitor you've already got locked has essentially no cost, and it will reduce the jcarder output so we can notice if we accidentally introduce \"real\" bugs later. Do you agree?\n\nbq. , I always locked the JT before locking the scheduler.\n\nI can see why the coarse locking isn't a great idea for scalability. In this case, though, we're just adding a lock in a place where we already assume the lock is taken, yea? (so it isn't any more coarse than before)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-08T19:25:53.751+0000","updated":"2010-02-08T19:25:53.751+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12832623","id":"12832623","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"Are you suggesting that I add a JobTracker lock in update() or in the JobListener methods? I think it's best to add it in update() because it also gets called from a separate thread. This actually happens quite rarely now (it used to be every few seconds, but it's every 15 seconds after MAPREDUCE-706, and can be set higher pretty safely).\n\nBTW, I found another deadlock that seems to be much rarer (it happened when I was submitting about 50 jobs simultaneously) but is not related to preemption:\n\n<code>\n\nFound one Java-level deadlock:\n=============================\n\"IPC Server handler 24 on 9001\":\n  waiting to lock monitor 0x0000000040c91750 (object 0x00007fc0243e2c20, a org.apache.hadoop.mapred.JobTracker),\n  which is held by \"IPC Server handler 0 on 9001\"\n\"IPC Server handler 0 on 9001\":\n  waiting to lock monitor 0x0000000040bc0770 (object 0x00007fc0243e3080, a org.apache.hadoop.mapred.FairScheduler),\n  which is held by \"FairScheduler update thread\"\n\"FairScheduler update thread\":\n  waiting to lock monitor 0x000000004095dd98 (object 0x00007fc0258bc0d0, a org.apache.hadoop.mapred.JobInProgress),\n  which is held by \"IPC Server handler 0 on 9001\"\n\nJava stack information for the threads listed above:\n===================================================\n\"IPC Server handler 24 on 9001\":\n\tat org.apache.hadoop.mapred.JobTracker.heartbeat(JobTracker.java:2487)\n\t- waiting to lock <0x00007fc0243e2c20> (a org.apache.hadoop.mapred.JobTracker)\n\tat sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:508)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:959)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:955)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:396)\n\tat org.apache.hadoop.ipc.Server$Handler.run(Server.java:953)\n\"IPC Server handler 0 on 9001\":\n\tat org.apache.hadoop.mapred.JobTracker.finalizeJob(JobTracker.java:2115)\n\t- waiting to lock <0x00007fc0243e3080> (a org.apache.hadoop.mapred.FairScheduler)\n\t- locked <0x00007fc0243e3420> (a java.util.TreeMap)\n\t- locked <0x00007fc0243e2c20> (a org.apache.hadoop.mapred.JobTracker)\n\tat org.apache.hadoop.mapred.JobInProgress.garbageCollect(JobInProgress.java:2510)\n\t- locked <0x00007fc0258bc0d0> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobInProgress.jobComplete(JobInProgress.java:2146)\n\tat org.apache.hadoop.mapred.JobInProgress.completedTask(JobInProgress.java:2084)\n\t- locked <0x00007fc0258bc0d0> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobInProgress.updateTaskStatus(JobInProgress.java:883)\n\t- locked <0x00007fc0258bc0d0> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobTracker.updateTaskStatuses(JobTracker.java:3564)\n\tat org.apache.hadoop.mapred.JobTracker.processHeartbeat(JobTracker.java:2758)\n\t- locked <0x00007fc0243e2c20> (a org.apache.hadoop.mapred.JobTracker)\n\tat org.apache.hadoop.mapred.JobTracker.heartbeat(JobTracker.java:2553)\n\t- locked <0x00007fc0243e2c20> (a org.apache.hadoop.mapred.JobTracker)\n\tat sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:508)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:959)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:955)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:396)\n\tat org.apache.hadoop.ipc.Server$Handler.run(Server.java:953)\n\"FairScheduler update thread\":\n\tat org.apache.hadoop.mapred.JobInProgress.scheduleReduces(JobInProgress.java:1203)\n\t- waiting to lock <0x00007fc0258bc0d0> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobSchedulable.updateDemand(JobSchedulable.java:53)\n\tat org.apache.hadoop.mapred.PoolSchedulable.updateDemand(PoolSchedulable.java:81)\n\tat org.apache.hadoop.mapred.FairScheduler.update(FairScheduler.java:577)\n\t- locked <0x00007fc0243e3080> (a org.apache.hadoop.mapred.FairScheduler)\n\tat org.apache.hadoop.mapred.FairScheduler$UpdateThread.run(FairScheduler.java:277)\n</code>\n\nThe problem in this one is that updateDemand() has to lock the jobs (briefly). That could be factored out above the other code in update(), but it seems safer to just lock the JT in all of update().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-11T18:48:48.431+0000","updated":"2010-02-11T18:48:48.431+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12833669","id":"12833669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"Here's a new patch that always locks the JobTracker before locking the FairScheduler in update(). This should resolve both of the deadlocks reported above. I've also increased the default update interval from 0.5 seconds to 2.5 seconds in this patch. The only negative impact of this should be that preemption and speculation take slightly longer to kick in. These are really the only reasons we need to call update() other than when jobs are added and removed; speculative tasks are counted in updateDemand, and preemption is checked regularly in updatePreemptionVariables().\n\nI've also thought a bit about the impact of coarser locking on performance of the JobTracker, and I think it's actually not that much. First of all, since assignTasks already locks the FairScheduler, we wouldn't get much farther by locking only the FS in update() and not the JT, because the JT calls assignTasks on every heartbeat anyway. Second, I timed update() on a simulated cluster with 2500 nodes, 4 slots per node, 100 jobs and 20 pools, and one call to update() took about 50 ms. With the new default update interval of 2500 ms, only 2% of the time in the JobTracker should be spent on this (and for such a large cluster, the update interval can be upped through the config file anyway).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-15T03:41:37.646+0000","updated":"2010-02-15T03:41:37.646+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12833670","id":"12833670","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm also reposting the second deadlock with better formatting in case my previous post was hard to read:\n\n{code}\nFound one Java-level deadlock:\n=============================\n\"IPC Server handler 24 on 9001\":\n  waiting to lock monitor 0x0000000040c91750 (object 0x00007fc0243e2c20, a org.apache.hadoop.mapred.JobTracker),\n  which is held by \"IPC Server handler 0 on 9001\"\n\"IPC Server handler 0 on 9001\":\n  waiting to lock monitor 0x0000000040bc0770 (object 0x00007fc0243e3080, a org.apache.hadoop.mapred.FairScheduler),\n  which is held by \"FairScheduler update thread\"\n\"FairScheduler update thread\":\n  waiting to lock monitor 0x000000004095dd98 (object 0x00007fc0258bc0d0, a org.apache.hadoop.mapred.JobInProgress),\n  which is held by \"IPC Server handler 0 on 9001\"\n\nJava stack information for the threads listed above:\n===================================================\n\"IPC Server handler 24 on 9001\":\n\tat org.apache.hadoop.mapred.JobTracker.heartbeat(JobTracker.java:2487)\n\t- waiting to lock <0x00007fc0243e2c20> (a org.apache.hadoop.mapred.JobTracker)\n\tat sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:508)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:959)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:955)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:396)\n\tat org.apache.hadoop.ipc.Server$Handler.run(Server.java:953)\n\"IPC Server handler 0 on 9001\":\n\tat org.apache.hadoop.mapred.JobTracker.finalizeJob(JobTracker.java:2115)\n\t- waiting to lock <0x00007fc0243e3080> (a org.apache.hadoop.mapred.FairScheduler)\n\t- locked <0x00007fc0243e3420> (a java.util.TreeMap)\n\t- locked <0x00007fc0243e2c20> (a org.apache.hadoop.mapred.JobTracker)\n\tat org.apache.hadoop.mapred.JobInProgress.garbageCollect(JobInProgress.java:2510)\n\t- locked <0x00007fc0258bc0d0> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobInProgress.jobComplete(JobInProgress.java:2146)\n\tat org.apache.hadoop.mapred.JobInProgress.completedTask(JobInProgress.java:2084)\n\t- locked <0x00007fc0258bc0d0> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobInProgress.updateTaskStatus(JobInProgress.java:883)\n\t- locked <0x00007fc0258bc0d0> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobTracker.updateTaskStatuses(JobTracker.java:3564)\n\tat org.apache.hadoop.mapred.JobTracker.processHeartbeat(JobTracker.java:2758)\n\t- locked <0x00007fc0243e2c20> (a org.apache.hadoop.mapred.JobTracker)\n\tat org.apache.hadoop.mapred.JobTracker.heartbeat(JobTracker.java:2553)\n\t- locked <0x00007fc0243e2c20> (a org.apache.hadoop.mapred.JobTracker)\n\tat sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:508)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:959)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:955)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:396)\n\tat org.apache.hadoop.ipc.Server$Handler.run(Server.java:953)\n\"FairScheduler update thread\":\n\tat org.apache.hadoop.mapred.JobInProgress.scheduleReduces(JobInProgress.java:1203)\n\t- waiting to lock <0x00007fc0258bc0d0> (a org.apache.hadoop.mapred.JobInProgress)\n\tat org.apache.hadoop.mapred.JobSchedulable.updateDemand(JobSchedulable.java:53)\n\tat org.apache.hadoop.mapred.PoolSchedulable.updateDemand(PoolSchedulable.java:81)\n\tat org.apache.hadoop.mapred.FairScheduler.update(FairScheduler.java:577)\n\t- locked <0x00007fc0243e3080> (a org.apache.hadoop.mapred.FairScheduler)\n\tat org.apache.hadoop.mapred.FairScheduler$UpdateThread.run(FairScheduler.java:277)\n\nFound 1 deadlock.\n{code}\n\nA review of the new patch would be appreciated!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-15T03:43:45.854+0000","updated":"2010-02-15T03:43:45.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12833700","id":"12833700","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12435844/mapreduce-1436-v2.patch\n  against trunk revision 909993.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Mapreduce-Patch-h6.grid.sp2.yahoo.net/453/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Mapreduce-Patch-h6.grid.sp2.yahoo.net/453/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Mapreduce-Patch-h6.grid.sp2.yahoo.net/453/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Mapreduce-Patch-h6.grid.sp2.yahoo.net/453/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-02-15T07:09:11.669+0000","updated":"2010-02-15T07:09:11.669+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12834665","id":"12834665","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hi Matei,\n\nI don't think this issue actually occurs in trunk - I'm speaking now about the top issue from this issue involving finalizeJob. MAPREDUCE-870 refactored this stuff, and finalizeJob therefore no longer has to go \"upwards\" to the scheduler lock.\n\nI turned on preemption and ran a couple of sleep jobs under jcarder, and it didn't identify this issue either. Just to sanity check myself, I added a synchronized (taskTrackerScheduler) { System.err.println(\"hi\"); } in the finalizeJob method, and reran the test. jcarder spit out the expected potential deadlock just like you saw it.\n\nI think, really, the JT was at fault here for inverting the lock heirarchy. It no longer does this, so I think we're safe without this patch.\n\nWhat do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-17T06:51:29.874+0000","updated":"2010-02-17T06:51:29.874+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12834690","id":"12834690","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"This doesn't look fairsched specific. Opened MAPREDUCE-1499","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-17T08:36:57.061+0000","updated":"2010-02-17T08:36:57.061+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12836438","id":"12836438","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"You're right Todd, it looks like with the new job retiring process, the JT lock is always grabbed before the fair scheduler lock, and neither of the two deadlocks I pointed out could occur. MAPREDUCE-870 seems to be in both trunk and 0.21, so everything should be fine. However, the issue in MAPREDUCE-1499 does affect Hadoop 0.20 and should be fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-21T20:19:43.251+0000","updated":"2010-02-21T20:19:43.251+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12836439","id":"12836439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm still a little concerned about the update thread not locking the JT all the time, but maybe I don't need to be. Just to clarify, the convention for locking is the following:\n\n* If both the JT and the FairScheduler must be locked, the JT is locked first.\n* If both the FairScheduler and a JIP must be locked, the FairScheduler is locked first.\n* If both the JT and a JIP must be locked, the JT is locked first.\n* If the JT, FS and JIP must all be locked, the order is JT -> FS -> JIP.\n\nIf this is it, then I think we're fine with the current usage.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-21T20:24:23.169+0000","updated":"2010-02-21T20:24:23.169+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12836441","id":"12836441","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Yep, I think your last bullet point is sufficient: there's an ordering of locks JT -> Scheduler -> JIP. A lock order is correct iff it is a subsequence of that ordering.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-21T20:32:44.177+0000","updated":"2010-02-21T20:32:44.177+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12836484","id":"12836484","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"Okay, in that case, I think everything is fine. I'm going to mark this JIRA as invalid. However, anyone who tries to backport the trunk fair scheduler to 0.20 might run into it, so hopefully they'll find this result. I'm assuming you guys included MAPREDUCE-870 or something similar in CDH?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-22T01:42:59.030+0000","updated":"2010-02-22T01:42:59.030+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12454977/comment/12836485","id":"12836485","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"Closing as \"invalid\" because it turns out that the issue doesn't happen in Hadoop trunk or 0.21. Todd opened MAPREDUCE-1499 about a related set of deadlocks that can happen in Hadoop 0.20 with any scheduler.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-22T01:43:49.860+0000","updated":"2010-02-22T01:43:49.860+0000"}],"maxResults":21,"total":21,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/MAPREDUCE-1436/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i02sv3:"}}