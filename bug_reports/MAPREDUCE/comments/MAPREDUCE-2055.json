[By guessing the scope of the work I feel like the patch is going to break Herriot compilation. So, here's an approximate patch for the problem if it will every come out.]