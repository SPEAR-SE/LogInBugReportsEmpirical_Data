[A straightforward change. Kindly review and let me know if it is acceptable or if there is a better way to do the same., +1 looks good to me. Anupam can you give the ant tests a try and see if they are ok with this change?, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12499101/MAPREDUCE-3181-branch0_23.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    -1 javadoc.  The javadoc tool appears to have generated 20 warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in .

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-MAPREDUCE-Build/1028//testReport/
Console output: https://builds.apache.org/job/PreCommit-MAPREDUCE-Build/1028//console

This message is automatically generated., Perhaps I'm missing something obvious, but I fail to see why this bug would only manifest itself with Kerberos enabled.

Also, can no test be written which would expose this bug and ensure it won't regress?, Anupam,
 Thinking abt this patch, how are other secure jobs running without this patch? , Anupam, something is weird. I can run secure jobs without this patch, we still need to investigate... any updates on this? Thanks.
, I haven't looked in detail at this but taking a quick look the bug doesn't show up without kerberos enabled because it doesn't ever try to load the yarn-site.xml without security on.  Looking at the stack trace:

at org.apache.hadoop.mapreduce.security.TokenCache.obtainTokensForNamenodes(TokenCache.java:83)
at org.apache.hadoop.mapreduce.lib.input.FileInputFormat.listStatus(FileInputFormat.java:205)

The obtainTokensForNamenodes eventually calls Master.getMasterPrincipal(conf) but only if security is enabled. There is if isSecurityEnabled in obtainTokensForNamenodes.  getMasterPrinicipal then expects yarn conf to be loaded because if the framework is yarn it does:
      masterAddress = conf.get(YarnConfiguration.RM_ADDRESS,
          YarnConfiguration.DEFAULT_RM_ADDRESS);


Its not all jobs that fail.  teragen, wordcount, etc. work fine but they don't take the same path.
, Thanks Tom. I hope your explanation helps clear up Aaron's and Arun's questions. As Tom pointed out, this problem is seem only on Terasort in a secure cluster because of the conditional to not even try this if security is disabled and because this gets hit before the ResourceManagerDelegate is ever called or created (causing yarn-site.xml to be 'normally' loaded). This does not happen with Teragen, for example, because TeraSort attempts to write the input splits to HDFS before running the actual MR.

Regarding the ant tests asked for by Mahadev, I see numerous failures due to timeout issues, most likely an artifact of MAPREDUCE-3176, as my changes are very simple.

Also, I have patch ready with an added unit test to ensure this does not regress - am running tests on it, will put it up shortly.
, Apologies - tried to write a unit test in a few different ways, but without using PowerMockito, I cannot seem to be able to make it non-trivial and non-absurd while actually testing the issue at hand (which is difficult IMO because of the way the default yarn-site.xml is set to be an empty configuration).

Thus, my patch remains as it is. Kindly let me know if you would like me to include the PowerMockito stub or if someone has a better way to unit test, else requesting for +1 review and commit., Anupam - this might be a bug in terasort itself. I can run normal sort. Might be due to the way it tries to construct input splits? I'd like to understand this a bit better before we commit this fix...

Also teragen might be broken with MAPREDUCE-2702, can you pls check?, Ok, I spent more time on this. I think I finally figured this out.

The reason 'normal' jobs work is that they don't call InputFormat.getSplits until they create a YARNRunner which, in turn, creates a YarnConfiguration for the first time. YarnConfiguration has a static block which adds yarn-(default,site).xml as 'default resources' into the Configuration. Thus any configuration created after loads these.

The fix afaics is to add yarn-(default,site).xml as default resources in JobConf via org.apache.hadoop.mapreduce.utilConfigUtil.loadResources the same time we add mapred-(default,site).xml., Straight-forward patch., Anupam, can you pls check to see if it works for you? Tx, I found another bug in TeraGen - TeraOutputFormat is broken, it overrides FileOutputCommitter and does nothing., Ok, this works - tested on a secure cluster., @arun/@anupam,

Make sure ant tests are all fine with this change. I think Hitesh might have tried it already., Anupam, if you don't mind I'll take this over. Thanks., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12499640/MAPREDUCE-3181.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 160 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in .

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-MAPREDUCE-Build/1064//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-MAPREDUCE-Build/1064//artifact/trunk/hadoop-mapreduce-project/patchprocess/newPatchFindbugsWarningshadoop-mapreduce-client-common.html
Findbugs warnings: https://builds.apache.org/job/PreCommit-MAPREDUCE-Build/1064//artifact/trunk/hadoop-mapreduce-project/patchprocess/newPatchFindbugsWarningshadoop-mapreduce-client-app.html
Findbugs warnings: https://builds.apache.org/job/PreCommit-MAPREDUCE-Build/1064//artifact/trunk/hadoop-mapreduce-project/patchprocess/newPatchFindbugsWarningshadoop-mapreduce-client-core.html
Console output: https://builds.apache.org/job/PreCommit-MAPREDUCE-Build/1064//console

This message is automatically generated., doesn't this now make the client yarn specific? should it somehow be conditionalized on mapreduce.framework.name, I thought about it, there isn't a good way to effect that. For now, this seems like a simple, straight-fwd change. Makes sense?, makes sense if it doesn't hurt anything., I just committed this., Integrated in Hadoop-Common-0.23-Commit #24 (See [https://builds.apache.org/job/Hadoop-Common-0.23-Commit/24/])
    Merge -c 1186458 from trunk to branch-0.23 to complete fix for MAPREDUCE-3181.

acmurthy : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1186459
Files : 
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapreduce/util/ConfigUtil.java
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/src/examples/org/apache/hadoop/examples/terasort/TeraOutputFormat.java
, Integrated in Hadoop-Common-trunk-Commit #1110 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/1110/])
    MAPREDUCE-3181. Fixed MapReduce runtime to load yarn-default.xml and yarn-site.xml.

acmurthy : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1186458
Files : 
* /hadoop/common/trunk/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapreduce/util/ConfigUtil.java
* /hadoop/common/trunk/hadoop-mapreduce-project/src/examples/org/apache/hadoop/examples/terasort/TeraOutputFormat.java
, Integrated in Hadoop-Hdfs-trunk-Commit #1189 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/1189/])
    MAPREDUCE-3181. Fixed MapReduce runtime to load yarn-default.xml and yarn-site.xml.

acmurthy : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1186458
Files : 
* /hadoop/common/trunk/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapreduce/util/ConfigUtil.java
* /hadoop/common/trunk/hadoop-mapreduce-project/src/examples/org/apache/hadoop/examples/terasort/TeraOutputFormat.java
, Integrated in Hadoop-Hdfs-0.23-Commit #25 (See [https://builds.apache.org/job/Hadoop-Hdfs-0.23-Commit/25/])
    Merge -c 1186458 from trunk to branch-0.23 to complete fix for MAPREDUCE-3181.

acmurthy : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1186459
Files : 
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapreduce/util/ConfigUtil.java
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/src/examples/org/apache/hadoop/examples/terasort/TeraOutputFormat.java
, Integrated in Hadoop-Mapreduce-trunk-Commit #1129 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/1129/])
    MAPREDUCE-3181. Fixed MapReduce runtime to load yarn-default.xml and yarn-site.xml.

acmurthy : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1186458
Files : 
* /hadoop/common/trunk/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapreduce/util/ConfigUtil.java
* /hadoop/common/trunk/hadoop-mapreduce-project/src/examples/org/apache/hadoop/examples/terasort/TeraOutputFormat.java
, Integrated in Hadoop-Mapreduce-0.23-Commit #25 (See [https://builds.apache.org/job/Hadoop-Mapreduce-0.23-Commit/25/])
    Merge -c 1186458 from trunk to branch-0.23 to complete fix for MAPREDUCE-3181.

acmurthy : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1186459
Files : 
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapreduce/util/ConfigUtil.java
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/src/examples/org/apache/hadoop/examples/terasort/TeraOutputFormat.java
, Integrated in Hadoop-Hdfs-0.23-Build #45 (See [https://builds.apache.org/job/Hadoop-Hdfs-0.23-Build/45/])
    Merge -c 1186458 from trunk to branch-0.23 to complete fix for MAPREDUCE-3181.

acmurthy : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1186459
Files : 
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapreduce/util/ConfigUtil.java
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/src/examples/org/apache/hadoop/examples/terasort/TeraOutputFormat.java
, Integrated in Hadoop-Mapreduce-0.23-Build #57 (See [https://builds.apache.org/job/Hadoop-Mapreduce-0.23-Build/57/])
    Merge -c 1186458 from trunk to branch-0.23 to complete fix for MAPREDUCE-3181.

acmurthy : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1186459
Files : 
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/src/main/java/org/apache/hadoop/mapreduce/util/ConfigUtil.java
* /hadoop/common/branches/branch-0.23/hadoop-mapreduce-project/src/examples/org/apache/hadoop/examples/terasort/TeraOutputFormat.java
]