[Example exception during a token update:

{noformat}
2014-07-28 15:00:00,226 [IPC Server handler 1 on 10020] ERROR hs.JHSDelegationTokenSecretManager: Unable to update token 35408
java.io.IOException: Could not rename hdfs:/xx/tokens/tb_408/tmp-token_35408 to hdfs:/xx/tokens/tb_408/token_35408
        at org.apache.hadoop.mapreduce.v2.hs.HistoryServerFileSystemStateStoreService.createFile(HistoryServerFileSystemStateStoreService.java:229)
        at org.apache.hadoop.mapreduce.v2.hs.HistoryServerFileSystemStateStoreService.updateToken(HistoryServerFileSystemStateStoreService.java:139)
        at org.apache.hadoop.mapreduce.v2.hs.JHSDelegationTokenSecretManager.updateStoredToken(JHSDelegationTokenSecretManager.java:131)
        at org.apache.hadoop.mapreduce.v2.hs.JHSDelegationTokenSecretManager.updateStoredToken(JHSDelegationTokenSecretManager.java:38)
        at org.apache.hadoop.security.token.delegation.AbstractDelegationTokenSecretManager.renewToken(AbstractDelegationTokenSecretManager.java:397)
        at org.apache.hadoop.mapreduce.v2.hs.HistoryClientService$HSClientProtocolHandler.renewDelegationToken(HistoryClientService.java:377)
        at org.apache.hadoop.mapreduce.v2.api.impl.pb.service.MRClientProtocolPBServiceImpl.renewDelegationToken(MRClientProtocolPBServiceImpl.java:272)
        at org.apache.hadoop.yarn.proto.MRClientProtocol$MRClientProtocolService$2.callBlockingMethod(MRClientProtocol.java:299)
        at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:585)
        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:928)
        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2013)
        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2009)
        at java.security.AccessController.doPrivileged(Native Method)
        at javax.security.auth.Subject.doAs(Subject.java:415)
        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1588)
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2007)
{noformat}, The previous unit tests didn't catch the update failure because the rename doesn't fail on the local filesystem but does on HDFS.

Attaching a patch that fixes update by removing the destination token file before trying to rename the temporary file to the final token file.  Crashing after the delete but before the rename is handled during recovery since it checks for a temporary update file without a corresponding token file and will use the temporary update file.

Patch also adds an HDFS unit test and a unit test to cover the crash-during-update scenario., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12658497/MAPREDUCE-6010.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-hs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-MAPREDUCE-Build/4775//testReport/
Console output: https://builds.apache.org/job/PreCommit-MAPREDUCE-Build/4775//console

This message is automatically generated., +1 Seems like a reasonable approach for more reliable atomicity in the fs state store., Thanks for the review, Daryn!  Committing this., FAILURE: Integrated in Hadoop-trunk-Commit #6065 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6065/])
MAPREDUCE-6010. HistoryServerFileSystemStateStore fails to update tokens. Contributed by Jason Lowe (jlowe: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1617984)
* /hadoop/common/trunk/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-hs/src/main/java/org/apache/hadoop/mapreduce/v2/hs/HistoryServerFileSystemStateStoreService.java
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-hs/src/test/java/org/apache/hadoop/mapreduce/v2/hs/TestHistoryServerFileSystemStateStoreService.java
, I committed this to trunk and branch-2., FAILURE: Integrated in Hadoop-Yarn-trunk #647 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/647/])
MAPREDUCE-6010. HistoryServerFileSystemStateStore fails to update tokens. Contributed by Jason Lowe (jlowe: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1617984)
* /hadoop/common/trunk/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-hs/src/main/java/org/apache/hadoop/mapreduce/v2/hs/HistoryServerFileSystemStateStoreService.java
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-hs/src/test/java/org/apache/hadoop/mapreduce/v2/hs/TestHistoryServerFileSystemStateStoreService.java
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk #1864 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1864/])
MAPREDUCE-6010. HistoryServerFileSystemStateStore fails to update tokens. Contributed by Jason Lowe (jlowe: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1617984)
* /hadoop/common/trunk/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-hs/src/main/java/org/apache/hadoop/mapreduce/v2/hs/HistoryServerFileSystemStateStoreService.java
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-hs/src/test/java/org/apache/hadoop/mapreduce/v2/hs/TestHistoryServerFileSystemStateStoreService.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1838 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1838/])
MAPREDUCE-6010. HistoryServerFileSystemStateStore fails to update tokens. Contributed by Jason Lowe (jlowe: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1617984)
* /hadoop/common/trunk/hadoop-mapreduce-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-hs/src/main/java/org/apache/hadoop/mapreduce/v2/hs/HistoryServerFileSystemStateStoreService.java
* /hadoop/common/trunk/hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-hs/src/test/java/org/apache/hadoop/mapreduce/v2/hs/TestHistoryServerFileSystemStateStoreService.java
]