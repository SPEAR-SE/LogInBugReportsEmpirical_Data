{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13125351","self":"https://issues.apache.org/jira/rest/api/2/issue/13125351","key":"HIVE-18287","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-12-15T22:32:56.287+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Dec 16 22:21:43 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18287/watchers","watchCount":3,"isWatching":false},"created":"2017-12-15T22:31:29.569+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329278","id":"12329278","description":"Branch 1.0 release","name":"1.0.0","archived":false,"released":true,"releaseDate":"2015-02-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12340338","id":"12340338","name":"2.4.0","archived":false,"released":false}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-12-16T22:21:43.979+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12320408","id":"12320408","name":"HiveServer2","description":"Tracks issues related to HiveServer2"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313866","id":"12313866","name":"Security"}],"timeoriginalestimate":null,"description":"Hiveserver2 needs permission 733 or above on scratch directory to start successfully.\r\nHS2 does not take into consideration the permission given to scratch dir via Ranger, it expects the permissions at HDFS level.\r\nEven if we give full access to 'hive' user from Ranger , the start of HS2 fails, it expects to have the permission from HDFS (#hdfs dfs -chmod 755 /tmp/hive)\r\n\r\n>> SessionState.java\r\n\r\n{code:java}\r\nprivate Path createRootHDFSDir(HiveConf conf) throws IOException { \r\nPath rootHDFSDirPath = new Path(HiveConf.getVar(conf, HiveConf.ConfVars.SCRATCHDIR)); \r\nFsPermission writableHDFSDirPermission = new FsPermission((short)00733); \r\nFileSystem fs = rootHDFSDirPath.getFileSystem(conf); \r\nif (!fs.exists(rootHDFSDirPath)) { \r\nUtilities.createDirsWithPermission(conf, rootHDFSDirPath, writableHDFSDirPermission, true); \r\n} \r\nFsPermission currentHDFSDirPermission = fs.getFileStatus(rootHDFSDirPath).getPermission(); \r\nif (rootHDFSDirPath != null && rootHDFSDirPath.toUri() != null) { \r\nString schema = rootHDFSDirPath.toUri().getScheme(); \r\nLOG.debug( \r\n\"HDFS root scratch dir: \" + rootHDFSDirPath + \" with schema \" + schema + \", permission: \" + \r\ncurrentHDFSDirPermission); \r\n} else { \r\nLOG.debug( \r\n\"HDFS root scratch dir: \" + rootHDFSDirPath + \", permission: \" + currentHDFSDirPermission); \r\n} \r\n// If the root HDFS scratch dir already exists, make sure it is writeable. \r\nif (!((currentHDFSDirPermission.toShort() & writableHDFSDirPermission \r\n.toShort()) == writableHDFSDirPermission.toShort())) { \r\nthrow new RuntimeException(\"The root scratch dir: \" + rootHDFSDirPath \r\n+ \" on HDFS should be writable. Current permissions are: \" + currentHDFSDirPermission); \r\n} \r\n{code}\r\n\r\n>> Error message :\r\n\r\n{code:java}\r\n2017-08-23 09:56:13,965 WARN [main]: server.HiveServer2 (HiveServer2.java:startHiveServer2(508)) - Error starting HiveServer2 on attempt 1, will retry in 60 seconds \r\njava.lang.RuntimeException: Error applying authorization policy on hive configuration: java.lang.RuntimeException: The root scratch dir: /tmp/hive on HDFS should be writable. Current permissions are: rwxr-x--- \r\nat org.apache.hive.service.cli.CLIService.init(CLIService.java:117) \r\nat org.apache.hive.service.CompositeService.init(CompositeService.java:59) \r\nat org.apache.hive.service.server.HiveServer2.init(HiveServer2.java:122) \r\nat org.apache.hive.service.server.HiveServer2.startHiveServer2(HiveServer2.java:474) \r\nat org.apache.hive.service.server.HiveServer2.access$700(HiveServer2.java:87) \r\nat org.apache.hive.service.server.HiveServer2$StartOptionExecutor.execute(HiveServer2.java:720) \r\nat org.apache.hive.service.server.HiveServer2.main(HiveServer2.java:593) \r\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) \r\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) \r\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) \r\nat java.lang.reflect.Method.invoke(Method.java:498) \r\nat org.apache.hadoop.util.RunJar.run(RunJar.java:233) \r\nat org.apache.hadoop.util.RunJar.main(RunJar.java:148) \r\nCaused by: java.lang.RuntimeException: java.lang.RuntimeException: The root scratch dir: /tmp/hive on HDFS should be writable. Current permissions are: rwxr-x--- \r\nat org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:547) \r\nat org.apache.hive.service.cli.CLIService.applyAuthorizationConfigPolicy(CLIService.java:130) \r\nat org.apache.hive.service.cli.CLIService.init(CLIService.java:115) \r\n... 12 more \r\nCaused by: java.lang.RuntimeException: The root scratch dir: /tmp/hive on HDFS should be writable. Current permissions are: rwxr-x--- \r\nat org.apache.hadoop.hive.ql.session.SessionState.createRootHDFSDir(SessionState.java:648) \r\nat org.apache.hadoop.hive.ql.session.SessionState.createSessionDirs(SessionState.java:580) \r\nat org.apache.hadoop.hive.ql.session.SessionState.start(SessionState.java:533) \r\n... 14 more\r\n{code}\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Scratch dir permission check doesn't honor Ranger based privileges","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thejas","name":"thejas","key":"thejas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thejas&avatarId=15902","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thejas&avatarId=15902","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thejas&avatarId=15902","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thejas&avatarId=15902"},"displayName":"Thejas M Nair","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajguru","name":"rajguru","key":"rajguru","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kunal Rajguru","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13125351/comment/16293372","id":"16293372","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thejas","name":"thejas","key":"thejas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thejas&avatarId=15902","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thejas&avatarId=15902","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thejas&avatarId=15902","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thejas&avatarId=15902"},"displayName":"Thejas M Nair","active":true,"timeZone":"America/Los_Angeles"},"body":"It needs to use FileSystem.access methods to verify permission, so that effective permission that includes Ranger permissions is used.\r\n\r\nThis might be an issue with Sentry based permission as well cc [~akolb]].\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thejas","name":"thejas","key":"thejas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thejas&avatarId=15902","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thejas&avatarId=15902","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thejas&avatarId=15902","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thejas&avatarId=15902"},"displayName":"Thejas M Nair","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-12-15T22:32:56.287+0000","updated":"2017-12-15T22:32:56.287+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13125351/comment/16293958","id":"16293958","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"body":"When Sentry is enabled, Hive runs everything as 'hive' user, so 'hive' user needs permissions to scratch dir. Sentry doesn't control scratch dir permissions. How does this work with Ranger?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-12-16T22:21:43.979+0000","updated":"2017-12-16T22:21:43.979+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18287/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3nz0v:"}}