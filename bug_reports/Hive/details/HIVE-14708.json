{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13002986","self":"https://issues.apache.org/jira/rest/api/2/issue/13002986","key":"HIVE-14708","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-09-06T22:21:42.499+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Sep 07 00:24:18 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-14708/watchers","watchCount":3,"isWatching":false},"created":"2016-09-06T17:36:45.453+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335837","id":"12335837","name":"2.2.0","archived":false,"released":true,"releaseDate":"2017-07-25"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-09-07T00:24:18.746+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12323400","id":"12323400","name":"Logical Optimizer","description":"Optimizations which are independent of runtime."}],"timeoriginalestimate":null,"description":"{code}\nhive (tpcds_bin_partitioned_orc_1000)> explain select count(1) from store_sales where ss_sold_date_sk NOT in (select d_date_sk from date_dim);\n\n    Stage-1\n      Reducer 2 vectorized, llap\n      File Output Operator [FS_52]\n        Group By Operator [GBY_51] (rows=1 width=8)\n          Output:[\"_col0\"],aggregations:[\"count(VALUE._col0)\"]\n        <-Map 1 [SIMPLE_EDGE] vectorized, llap\n          SHUFFLE [RS_50]\n            Group By Operator [GBY_49] (rows=1 width=8)\n              Output:[\"_col0\"],aggregations:[\"count(1)\"]\n              Select Operator [SEL_48] (rows=1 width=4)\n                Filter Operator [FIL_47] (rows=1 width=4)\n                  predicate:_col2 is null\n                  Map Join Operator [MAPJOIN_46] (rows=2879987999 width=4)\n                    Conds:MAPJOIN_45._col0=RS_43._col0(Left Outer),Output:[\"_col2\"]\n                  <-Map 5 [BROADCAST_EDGE] vectorized, llap\n                    BROADCAST [RS_43]\n                      PartitionCols:_col0\n                      Select Operator [SEL_42] (rows=73049 width=4)\n                        Output:[\"_col0\"]\n                        TableScan [TS_11] (rows=73049 width=4)\n                          tpcds_bin_partitioned_orc_1000@date_dim,date_dim,Tbl:COMPLETE,Col:COMPLETE,Output:[\"d_date_sk\"]\n                  <-Map Join Operator [MAPJOIN_45] (rows=2879987999 width=4)\n                      Conds:(Inner),Output:[\"_col0\"]\n                    <-Reducer 4 [BROADCAST_EDGE] vectorized, llap\n                      BROADCAST [RS_41]\n                        Select Operator [SEL_40] (rows=1 width=8)\n                          Filter Operator [FIL_39] (rows=1 width=8)\n                            predicate:(_col0 = 0)\n                            Group By Operator [GBY_38] (rows=1 width=8)\n                              Output:[\"_col0\"],aggregations:[\"count(VALUE._col0)\"]\n                            <-Map 3 [SIMPLE_EDGE] vectorized, llap\n                              SHUFFLE [RS_37]\n                                Group By Operator [GBY_36] (rows=1 width=8)\n                                  Output:[\"_col0\"],aggregations:[\"count()\"]\n                                  Select Operator [SEL_35] (rows=1 width=4)\n                                    Filter Operator [FIL_34] (rows=1 width=4)\n                                      predicate:d_date_sk is null\n                                      TableScan [TS_2] (rows=73049 width=4)\n                                        tpcds_bin_partitioned_orc_1000@date_dim,date_dim,Tbl:COMPLETE,Col:COMPLETE,Output:[\"d_date_sk\"]\n                    <-Select Operator [SEL_44] (rows=2879987999 width=4)\n                        Output:[\"_col0\"]\n                        TableScan [TS_0] (rows=2879987999 width=92)\n                          tpcds_bin_partitioned_orc_1000@store_sales,store_sales,Tbl:COMPLETE,Col:COMPLETE\n\n{code}\n\nThe 2nd scan is merely to count the number of NULLs and has {{predicate:d_date_sk is null}} in the operator.\n\nThe NULL checks can be done inline with the NOT-NULL codepath instead of producing 2 independent full-scans of the date_dim table.\n\nThis is not significant in a scenario like the above where the small table side is an actual HDFS table, but entirely throttles performance when the small side is actually an expensive aggregate.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Optimizer: NOT IN query scans one input two times","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13002986/comment/15468804","id":"15468804","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"I am not sure I follow. We need to know if there are any nulls in subqueries or not and we need to know that before we start generating resultset for outer query. Thus we count null first and then use that count to do a filter. I am not sure how is it possible to do this in a single scan. For reference: this rewrite is described on page 10 on [design doc | https://issues.apache.org/jira/secure/attachment/12614003/SubQuerySpec.pdf] on HIVE-784","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-09-06T22:21:42.499+0000","updated":"2016-09-06T22:21:42.499+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13002986/comment/15468847","id":"15468847","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"bq. I am not sure how is it possible to do this in a single scan\n\nHive actually does that in other scenarios, when inserting into tables. Try the following query in Tez\n\n{code}\ncreate temporary table null_date(nul bigint);\ncreate temporary table min_date(mm bigint);\n\nexplain \nfrom date_dim\ninsert overwrite table min_date select min(d_date_sk)\ninsert overwrite table null_date select count(1) where d_date_sk is null ;\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-09-06T22:42:07.653+0000","updated":"2016-09-06T22:42:07.653+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13002986/comment/15469063","id":"15469063","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"This is different than what you are asking, because result set is independent for two insert statement whereas for NOT IN one result set is used in the next one.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-09-07T00:24:18.746+0000","updated":"2016-09-07T00:24:18.746+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-14708/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i33alb:"}}