{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12917157","self":"https://issues.apache.org/jira/rest/api/2/issue/12917157","key":"HIVE-12548","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-12-10T21:56:28.500+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jul 05 11:24:41 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-12548/watchers","watchCount":6,"isWatching":false},"created":"2015-12-01T06:46:00.781+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-07-05T11:24:41.451+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325007","id":"12325007","name":"Hive"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12320408","id":"12320408","name":"HiveServer2","description":"Tracks issues related to HiveServer2"}],"timeoriginalestimate":null,"description":"[pool-3-thread-10]: Error occurred during processing of message.\njava.lang.RuntimeException: org.apache.thrift.transport.TTransportException: Invalid status -128\n\tat org.apache.thrift.transport.TSaslServerTransport$Factory.getTransport(TSaslServerTransport.java:219)\n\tat org.apache.hadoop.hive.thrift.HadoopThriftAuthBridge$Server$TUGIAssumingTransportFactory$1.run(HadoopThriftAuthBridge.java:739)\n\tat org.apache.hadoop.hive.thrift.HadoopThriftAuthBridge$Server$TUGIAssumingTransportFactory$1.run(HadoopThriftAuthBridge.java:736)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:356)\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1651)\n\tat org.apache.hadoop.hive.thrift.HadoopThriftAuthBridge$Server$TUGIAssumingTransportFactory.getTransport(HadoopThriftAuthBridge.java:736)\n\tat org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:268)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:745)\nCaused by: org.apache.thrift.transport.TTransportException: Invalid status -128\n\tat org.apache.thrift.transport.TSaslTransport.sendAndThrowMessage(TSaslTransport.java:232)\n\tat org.apache.thrift.transport.TSaslTransport.receiveSaslMessage(TSaslTransport.java:184)\n\tat org.apache.thrift.transport.TSaslServerTransport.handleSaslStartMessage(TSaslServerTransport.java:125)\n\tat org.apache.thrift.transport.TSaslTransport.open(TSaslTransport.java:271)\n\tat org.apache.thrift.transport.TSaslServerTransport.open(TSaslServerTransport.java:41)\n\tat org.apache.thrift.transport.TSaslServerTransport$Factory.getTransport(TSaslServerTransport.java:216)\n\t... 10 more","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Hive metastore goes down in Kerberos,sentry enabled CDH5.5 cluster","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narendrareddy14","name":"narendrareddy14","key":"narendrareddy14","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=narendrareddy14&avatarId=25537","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=narendrareddy14&avatarId=25537","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=narendrareddy14&avatarId=25537","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=narendrareddy14&avatarId=25537"},"displayName":"narendra reddy ganesana","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=narendrareddy14","name":"narendrareddy14","key":"narendrareddy14","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=narendrareddy14&avatarId=25537","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=narendrareddy14&avatarId=25537","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=narendrareddy14&avatarId=25537","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=narendrareddy14&avatarId=25537"},"displayName":"narendra reddy ganesana","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"RHEL 6.5 CLOUDERA CDH 5.5","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12917157/comment/15051722","id":"15051722","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=noslowerdna","name":"noslowerdna","key":"noslowerdna","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Olson","active":true,"timeZone":"America/Chicago"},"body":"We're seeing this stack trace, from an Oozie Java action that connects to the MetaStore in a Kerberos-secured cluster. We've tried to provide the Hive credentials as described in https://oozie.apache.org/docs/4.2.0/DG_ActionAuthentication.html with no success so far. Any advice would be appreciated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=noslowerdna","name":"noslowerdna","key":"noslowerdna","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Olson","active":true,"timeZone":"America/Chicago"},"created":"2015-12-10T21:56:28.500+0000","updated":"2015-12-10T21:56:28.500+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12917157/comment/15064686","id":"15064686","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=noslowerdna","name":"noslowerdna","key":"noslowerdna","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Olson","active":true,"timeZone":"America/Chicago"},"body":"After much debugging we were finally able to figure this out. Here are some code and config snippets that might be helpful for anyone else who runs into this cryptic exception.\n\n{noformat}\nfor (Token<?> token : UserGroupInformation.getCurrentUser().getTokens()) {\n  if (token.getKind().equals(DelegationTokenIdentifier.HIVE_DELEGATION_KIND)) {\n    conf.set(HIVE_METASTORE_TOKEN_SIGNATURE_PROPERTY, token.getService().toString());\n    break;\n  }\n}\n{noformat}\n\n{noformat}\nHiveConf hiveConf = new HiveConf();\nhiveConf.addResource(conf);\n{noformat}\n\n{noformat}\nif (System.getProperty(\"oozie.action.conf.xml\") != null) {\n  conf.addResource(new Path(\"file:///\", System.getProperty(\"oozie.action.conf.xml\")));\n}\nconf.addResource(\"hive-site.xml\");\n{noformat}\n\n{noformat}\nif (System.getenv(\"HADOOP_TOKEN_FILE_LOCATION\") != null) {\n  conf.set(\"mapreduce.job.credentials.binary\", System.getenv(\"HADOOP_TOKEN_FILE_LOCATION\"));\n}\n{noformat}\n\n{noformat}\nconf.set(\"yarn.application.classpath\", conf.get(\"yarn.application.classpath\") + \",/opt/cloudera/parcels/CDH/lib/hive/lib/*\");\n{noformat}\n\n{noformat}\n    <global>\n        <job-tracker>${jobTracker}</job-tracker>\n        <name-node>${nameNode}</name-node>\n        <job-xml>${concat(additionsPath, 'hive-site.xml')}</job-xml>\n        <job-xml>${concat(hadoopPropertyFilesPath, 'global-conf.xml')}</job-xml>\n        <configuration>\n            <property>\n                <name>oozie.launcher.mapreduce.job.user.classpath.first</name>\n                <value>true</value>\n            </property>\n        </configuration>\n    </global>\n\n    <credentials>\n        <credential name='hive_credentials' type='hcat'>\n            <property>\n                <name>hcat.metastore.uri</name>\n                <value>${hiveMetastoreURI}</value>\n            </property>\n            <property>\n                <name>hcat.metastore.principal</name>\n                <value>${hivePrincipal}</value>\n            </property>\n        </credential>\n    </credentials>\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=noslowerdna","name":"noslowerdna","key":"noslowerdna","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Olson","active":true,"timeZone":"America/Chicago"},"created":"2015-12-18T20:12:13.375+0000","updated":"2015-12-18T20:12:13.375+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12917157/comment/15358766","id":"15358766","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dbacwq","name":"dbacwq","key":"dbacwq","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Qiang","active":true,"timeZone":"Etc/UTC"},"body":"Hi Andrew:\n   We just run into this exception when connect to hive in CDH5.5.1 with kerberos and sentry. I tried your solution like this but it doesn't work.\n\n\n      HiveConf conf = new HiveConf(); \n      Configuration c = new Configuration();\n      if (System.getenv(\"HADOOP_TOKEN_FILE_LOCATION\") != null) {\n        c.set(\"mapreduce.job.credentials.binary\", System.getenv(\"HADOOP_TOKEN_FILE_LOCATION\"));\n      }\n      for (Token<?> token : UserGroupInformation.getCurrentUser().getTokens()) {\n        String tokenKind = token.getKind().toString().toUpperCase();\n        if (tokenKind.equals(\"MAPREDUCE_DELEGATION_TOKEN\") || tokenKind.equals(\"YARN_CLIENT_TOKEN\")) {\n          c.set(HIVE_METASTORE_TOKEN_SIGNATURE_PROPERTY, token.getService().toString());\n          break;\n        }\n      }\n      conf.addResource(c);\n\nAny suggestions? Or, can you tell me why should we supoort HIVE_METASTORE_TOKEN_SIGNATURE_PROPERTY with hive conf? \n\nThanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dbacwq","name":"dbacwq","key":"dbacwq","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Qiang","active":true,"timeZone":"Etc/UTC"},"created":"2016-07-01T10:32:46.280+0000","updated":"2016-07-01T10:32:46.280+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12917157/comment/15359017","id":"15359017","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=noslowerdna","name":"noslowerdna","key":"noslowerdna","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Olson","active":true,"timeZone":"America/Chicago"},"body":"[~dbacwq] It is difficult to suggest a solution for the problem of \"it doesn't work\". An exception stack trace or otherwise more details would be helpful.\n\nCan you confirm that you are using Oozie, with a Java action? I don't know much about Sentry. This code was only relevant for Oozie + Java action + Metastore + Kerberos. It should be applicable for CDH 5.x.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=noslowerdna","name":"noslowerdna","key":"noslowerdna","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Olson","active":true,"timeZone":"America/Chicago"},"created":"2016-07-01T14:15:31.238+0000","updated":"2016-07-01T14:15:31.238+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12917157/comment/15362377","id":"15362377","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qiang5714%40hotmail.com","name":"qiang5714@hotmail.com","key":"qiang5714@hotmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"weiqiang chen","active":true,"timeZone":"Etc/UTC"},"body":"Thanks Andrew, I have figured out the reason. I am using spark and I am writing code to get the token myself.\n\n\n\nOn Fri, Jul 1, 2016 at 10:16 PM +0800, \"Andrew Olson (JIRA)\" <jira@apache.org<mailto:jira@apache.org>> wrote:\n\n\n    [ https://issues.apache.org/jira/browse/HIVE-12548?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel&focusedCommentId=15359017#comment-15359017 ]\n\nAndrew Olson commented on HIVE-12548:\n-------------------------------------\n\n[~dbacwq] It is difficult to suggest a solution for the problem of \"it doesn't work\". An exception stack trace or otherwise more details would be helpful.\n\nCan you confirm that you are using Oozie, with a Java action? I don't know much about Sentry. This code was only relevant for Oozie + Java action + Metastore + Kerberos. It should be applicable for CDH 5.x.\n\n\n\n\n--\nThis message was sent by Atlassian JIRA\n(v6.3.4#6332)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qiang5714%40hotmail.com","name":"qiang5714@hotmail.com","key":"qiang5714@hotmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"weiqiang chen","active":true,"timeZone":"Etc/UTC"},"created":"2016-07-05T11:24:41.206+0000","updated":"2016-07-05T11:24:41.206+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-12548/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2p3m7:"}}