{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12768071","self":"https://issues.apache.org/jira/rest/api/2/issue/12768071","key":"HIVE-9398","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2015-01-16 17:09:24.112","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-9398/watchers","watchCount":1,"isWatching":false},"created":"2015-01-16T17:09:24.112+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324312","id":"12324312","description":"released","name":"0.12.0","archived":false,"released":true,"releaseDate":"2013-10-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324986","id":"12324986","description":"released","name":"0.13.0","archived":false,"released":true,"releaseDate":"2014-04-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-01-16T17:09:44.070+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12317407","id":"12317407","name":"Compression","description":"Issues related to data compression"}],"timeoriginalestimate":null,"description":"My lab Env:\nHive 0.13 \n\nIf the source table has .deflate compressed files and there is where condition,\nHive did not start small file merge feature.\nIf we have one partition table, and if we run SQL like:\nINSERT OVERWRITE TABLE target\nselect xxx from source where...;\n\nAfter that, \"target\" table has many empty files, and the number of files = the\nnumber of mappers. \n\nI can reproduce it in house, and here is minimum reproduce.\nIs it by design or do we need to fix it?\n\n----------------------------------------\n---------------Reproduce----------------\n----------------------------------------\n\n1. Create a source tables -- \"source_support\" and \"source_support2\" with the\nsame DDL.\n\"source_support\" is to store normal text files, \"source_support2\" will have\n.deflate compressed files.\n\nCREATE  TABLE source_support(\nonecol string \n)\nPARTITIONED BY (\n  partcol string)\nROW FORMAT SERDE\n  'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'\nSTORED AS INPUTFORMAT\n  'org.apache.hadoop.mapred.TextInputFormat'\nOUTPUTFORMAT\n  'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat';\n\nCREATE  TABLE source_support2(\nonecol string \n)\nPARTITIONED BY (\n  partcol string)\nROW FORMAT SERDE\n  'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'\nSTORED AS INPUTFORMAT\n  'org.apache.hadoop.mapred.TextInputFormat'\nOUTPUTFORMAT\n  'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat';\n\n2. Create a one-row data file:\n# cat /root/hao/000000_0\n'abc'\n\n3. Loading to 3 partitions of \"source_support\":\n\nLOAD DATA LOCAL INPATH '/root/hao/000000_0' INTO TABLE source_support\nPARTITION(partcol='2015-01-01');\nLOAD DATA LOCAL INPATH '/root/hao/000000_0' INTO TABLE source_support\nPARTITION(partcol='2015-01-02');\nLOAD DATA LOCAL INPATH '/root/hao/000000_0' INTO TABLE source_support\nPARTITION(partcol='2015-01-03');\n\nhive> select * from source_support;\nOK\n'abc'    2015-01-01\n'abc'    2015-01-02\n'abc'    2015-01-03\nTime taken: 0.836 seconds, Fetched: 3 row(s)\n\n4. Loading to \"source_support2\" from \"source_support\" to generate deflate\nfiles.\nset hive.exec.compress.output=true;\nINSERT OVERWRITE TABLE source_support2 PARTITION (partcol='2015-01-01')\nselect onecol from source_support where\npartcol='2015-01-01';\n\nset hive.exec.compress.output=true;\nINSERT OVERWRITE TABLE source_support2 PARTITION (partcol='2015-01-02')\nselect onecol from source_support where\npartcol='2015-01-02';\n\nset hive.exec.compress.output=true;\nINSERT OVERWRITE TABLE source_support2 PARTITION (partcol='2015-01-03')\nselect onecol from source_support where\npartcol='2015-01-03';\n\n\n5. Source has .deflate files even though the small file merge is enabled.\n\ndrop table testbysupport2;\nset hive.merge.mapfiles=true;\nset hive.merge.mapredfiles=true;\ncreate table testbysupport2 as \nSELECT 'policy-sale' data_source\nFROM source_support2\nWHERE onecol = '2015.01.04' and partcol in\n('2015-01-01','2015-01-02','2015-01-03');\n\n[root@n3a warehouse]# ls -altr testbysupport2\ntotal 1\ndrwxr-xr-x 42 xxx xxx 42 Jan 13 14:34 ..\n-rwxr-xr-x  1 root root  0 Jan 13 14:34 000002_0\n-rwxr-xr-x  1 root root  0 Jan 13 14:34 000001_0\n-rwxr-xr-x  1 root root  0 Jan 13 14:34 000000_0\ndrwxr-xr-x  2 root root  3 Jan 13 14:34 .\n\n6. If we remove the where condition \"onecol = '2015.01.04'\",\nsmall file merge is now enabled.\n\ndrop table testbysupport2;\nset hive.merge.mapfiles=true;\nset hive.merge.mapredfiles=true;\ncreate table testbysupport2 as \nSELECT 'policy-sale' data_source\nFROM source_support2\nWHERE  partcol in ('2015-01-01','2015-01-02','2015-01-03');\n\n[root@n3a warehouse]# ls -altr testbysupport2\ntotal 2\ndrwxr-xr-x 42 xxx xxx 42 Jan 13 14:37 ..\n-rwxr-xr-x  1 root root 36 Jan 13 14:37 000000_0\ndrwxr-xr-x  2 root root  1 Jan 13 14:37 .\n----------------------------------------\n---------------Reproduce----------------\n----------------------------------------","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Hive did not start small file merge if the source table has .deflate files","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haozhu","name":"haozhu","key":"haozhu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=haozhu&avatarId=20731","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=haozhu&avatarId=20731","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=haozhu&avatarId=20731","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=haozhu&avatarId=20731"},"displayName":"Hao Zhu","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haozhu","name":"haozhu","key":"haozhu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=haozhu&avatarId=20731","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=haozhu&avatarId=20731","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=haozhu&avatarId=20731","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=haozhu&avatarId=20731"},"displayName":"Hao Zhu","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-9398/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i24gsf:"}}