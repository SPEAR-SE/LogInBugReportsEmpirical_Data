{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12752852","self":"https://issues.apache.org/jira/rest/api/2/issue/12752852","key":"HIVE-8730","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329363","id":"12329363","name":"1.1.0","archived":false,"released":true,"releaseDate":"2015-03-07"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-11-20T21:32:08.688+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jan 22 20:00:43 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_6821686489_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-01-22T20:00:43.842+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-8730/watchers","watchCount":7,"isWatching":false},"created":"2014-11-04T21:05:57.460+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324986","id":"12324986","description":"released","name":"0.13.0","archived":false,"released":true,"releaseDate":"2014-04-21"}],"issuelinks":[{"id":"12406141","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12406141","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12769359","key":"HIVE-9445","self":"https://issues.apache.org/jira/rest/api/2/issue/12769359","fields":{"summary":"Revert HIVE-5700 - enforce single date format for partition column storage","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12406101","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12406101","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12769359","key":"HIVE-9445","self":"https://issues.apache.org/jira/rest/api/2/issue/12769359","fields":{"summary":"Revert HIVE-5700 - enforce single date format for partition column storage","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12400512","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12400512","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"inwardIssue":{"id":"12676740","key":"HIVE-5700","self":"https://issues.apache.org/jira/rest/api/2/issue/12676740","fields":{"summary":"enforce single date format for partition column storage","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-02-12T23:40:46.456+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312584","id":"12312584","name":"Metastore","description":"Tracks issue dealing with metastore."}],"timeoriginalestimate":null,"description":"If there is a none date value in the PART_KEY_VAL column within the PARTITION_KEY_VALS table in the metastore db, this will cause the HIVE-5700 script to fail. The failure will be picked up by the schemaTool causing the upgrade to fail. A classic example of a value that can be present without users really being aware is __HIVE_DEFAULT_PARTITION__ which is filled in by hive automatically when doing dynamic partitioning and value is not present in source data for the partition column.\n\nThe reason for the failure is that the upgrade script does not account for none date values. What it is currently:\n\n{code}\nUPDATE PARTITION_KEY_VALS\n  INNER JOIN PARTITIONS ON PARTITION_KEY_VALS.PART_ID = PARTITIONS.PART_ID\n  INNER JOIN PARTITION_KEYS ON PARTITION_KEYS.TBL_ID = PARTITIONS.TBL_ID\n    AND PARTITION_KEYS.INTEGER_IDX = PARTITION_KEY_VALS.INTEGER_IDX\n    AND PARTITION_KEYS.PKEY_TYPE = 'date'\nSET PART_KEY_VAL = IFNULL(DATE_FORMAT(cast(PART_KEY_VAL as date),'%Y-%m-%d'), PART_KEY_VAL);\n{code}\n\nWhat it should be to avoid issue: \n\n{code}\nUPDATE PARTITION_KEY_VALS\n  INNER JOIN PARTITIONS ON PARTITION_KEY_VALS.PART_ID = PARTITIONS.PART_ID\n  INNER JOIN PARTITION_KEYS ON PARTITION_KEYS.TBL_ID = PARTITIONS.TBL_ID\n    AND PARTITION_KEYS.INTEGER_IDX = PARTITION_KEY_VALS.INTEGER_IDX\n    AND PARTITION_KEYS.PKEY_TYPE = 'date'\n    AND PART_KEY_VAL != '__HIVE_DEFAULT_PARTITION__'\nSET PART_KEY_VAL = IFNULL(DATE_FORMAT(cast(PART_KEY_VAL as date),'%Y-%m-%d'), PART_KEY_VAL);\n{code}\n\n== Metastore DB\n\n{code}\nmysql> select * from PARTITION_KEY_VALS;\n+---------+----------------------------+-------------+\n| PART_ID | PART_KEY_VAL               | INTEGER_IDX |\n+---------+----------------------------+-------------+\n|     171 | 2099-12-31                 |           0 |\n|     172 | __HIVE_DEFAULT_PARTITION__ |           0 |\n|     184 | 2099-12-01                 |           0 |\n|     185 | 2099-12-30                 |           0 |\n+---------+----------------------------+-------------+\n{code} \n\n== stdout.log\n\n{code}\n0: jdbc:mysql://10.16.8.121:3306/metastore> !autocommit on\n0: jdbc:mysql://10.16.8.121:3306/metastore> SELECT 'Upgrading MetaStore schema from 0.12.0 to 0.13.0' AS ' '\n+---------------------------------------------------+--+\n|                                                   |\n+---------------------------------------------------+--+\n| Upgrading MetaStore schema from 0.12.0 to 0.13.0  |\n+---------------------------------------------------+--+\n0: jdbc:mysql://10.16.8.121:3306/metastore> SELECT '< HIVE-5700 enforce single date format for partition column storage >' AS ' '\n+------------------------------------------------------------------------+--+\n|                                                                        |\n+------------------------------------------------------------------------+--+\n| < HIVE-5700 enforce single date format for partition column storage >  |\n+------------------------------------------------------------------------+--+\n0: jdbc:mysql://10.16.8.121:3306/metastore> UPDATE PARTITION_KEY_VALS INNER JOIN PARTITIONS ON PARTITION_KEY_VALS.PART_ID = PARTITIONS.PART_ID INNER JOIN PARTITION_KEYS ON PARTITION_KEYS.TBL_ID = PARTITIONS.TBL_ID AND PARTITION_KEYS.INTEGER_IDX = PARTITION_KEY_VALS.INTEGER_IDX AND PARTITION_KEYS.PKEY_TYPE = 'date' SET PART_KEY_VAL = IFNULL(DATE_FORMAT(cast(PART_KEY_VAL as date),'%Y-%m-%d'), PART_KEY_VAL)\n{code}\n\n== stderr.log\n\n{code}\nexec /opt/cloudera/parcels/CDH-5.2.0-1.cdh5.2.0.p0.36/lib/hadoop/bin/hadoop jar /opt/cloudera/parcels/CDH-5.2.0-1.cdh5.2.0.p0.36/lib/hive/lib/hive-cli-0.13.1-cdh5.2.0.jar org.apache.hive.beeline.HiveSchemaTool -verbose -dbType mysql -upgradeSchema\nConnecting to jdbc:mysql://10.16.8.121:3306/metastore?useUnicode=true&characterEncoding=UTF-8\nConnected to: MySQL (version 5.1.73)\nDriver: MySQL-AB JDBC Driver (version mysql-connector-java-5.1.17-SNAPSHOT ( Revision: ${bzr.revision-id} ))\nTransaction isolation: TRANSACTION_READ_COMMITTED\nAutocommit status: true\n1 row selected (0.025 seconds)\n1 row selected (0.004 seconds)\nClosing: 0: jdbc:mysql://10.16.8.121:3306/metastore?useUnicode=true&characterEncoding=UTF-8\norg.apache.hadoop.hive.metastore.HiveMetaException: Upgrade FAILED! Metastore state would be inconsistent !!\norg.apache.hadoop.hive.metastore.HiveMetaException: Upgrade FAILED! Metastore state would be inconsistent !!\n\tat org.apache.hive.beeline.HiveSchemaTool.doUpgrade(HiveSchemaTool.java:252)\n\tat org.apache.hive.beeline.HiveSchemaTool.doUpgrade(HiveSchemaTool.java:220)\n\tat org.apache.hive.beeline.HiveSchemaTool.main(HiveSchemaTool.java:530)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:606)\n\tat org.apache.hadoop.util.RunJar.main(RunJar.java:212)\nCaused by: java.io.IOException: Schema script failed, errorcode 2\n\tat org.apache.hive.beeline.HiveSchemaTool.runBeeLine(HiveSchemaTool.java:410)\n\tat org.apache.hive.beeline.HiveSchemaTool.runBeeLine(HiveSchemaTool.java:383)\n\tat org.apache.hive.beeline.HiveSchemaTool.doUpgrade(HiveSchemaTool.java:247)\n\t... 7 more\n*** schemaTool failed ***\n{code}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"schemaTool failure when date partition has non-date value","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johndee","name":"johndee","key":"johndee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Johndee Burks","active":true,"timeZone":"America/Detroit"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johndee","name":"johndee","key":"johndee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Johndee Burks","active":true,"timeZone":"America/Detroit"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"CDH5.2","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12752852/comment/14220036","id":"14220036","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rnpridgeon","name":"rnpridgeon","key":"rnpridgeon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Pridgeon","active":true,"timeZone":"Etc/UTC"},"body":"The schema tool also fails to update PART_NAME in table PARTITIONS. Without this Hive will enter an infinite loop when a user attempts to drop the table.\n\nI would include the following Update statement in addition to handling none date type entries such as __HIVE_DEFAULT_PARTITION__\n\nUPDATE PARTITIONS JOIN PARTITION_KEYS ON PARTITIONS.TBL_ID= PARTITION_KEYS.TBL_ID  \nSET PART_NAME=ifnull(REPLACE(PART_NAME,RIGHT(PART_NAME,8),cast(RIGHT(PART_NAME,8) as date)),PART_NAME)\nWHERE PKEY_TYPE= 'date' and \nPART_NAME not like '%-%-%';\n\n\nRef:http://github.mtv.cloudera.com/CDH/hive/blob/cdh5-0.13.1_5.2.0/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java#1504\n\nLINE 1480:\n private List<Path> dropPartitionsAndGetLocations(RawStore ms, String dbName,\n      String tableName, Path tablePath, List<FieldSchema> partitionKeys, boolean checkLocation)\n      throws MetaException, IOException, NoSuchObjectException, InvalidObjectException,\n      InvalidInputException {\n      int partitionBatchSize = HiveConf.getIntVar(hiveConf,\n          ConfVars.METASTORE_BATCH_RETRIEVE_MAX);\n      Path tableDnsPath = null;\n      if (tablePath != null) {\n        tableDnsPath = wh.getDnsPath(tablePath);\n      }\n      List<Path> partPaths = new ArrayList<Path>();\n      Table tbl = ms.getTable(dbName, tableName);\n\n      // call dropPartition on each of the table's partitions to follow the\n      // procedure for cleanly dropping partitions.\n      while (true) {\n        List<Partition> partsToDelete = ms.getPartitions(dbName, tableName, partitionBatchSize);\n        if (partsToDelete == null || partsToDelete.isEmpty()) {\n          break;\n        }\n        List<String> partNames = new ArrayList<String>();\n        for (Partition part : partsToDelete) {\n          if (checkLocation && part.getSd() != null &&\n              part.getSd().getLocation() != null) {\n\n            Path partPath = wh.getDnsPath(new Path(part.getSd().getLocation()));\n            if (tableDnsPath == null ||\n                (partPath != null && !isSubdirectory(tableDnsPath, partPath))) {\n              if (!wh.isWritable(partPath.getParent())) {\n                throw new MetaException(\"Table metadata not deleted since the partition \" +\n                    Warehouse.makePartName(partitionKeys, part.getValues()) +\n                    \" has parent location \" + partPath.getParent() + \" which is not writable \" +\n                    \"by \" + hiveConf.getUser());\n              }\n              partPaths.add(partPath);\n            }\n          }\n          partNames.add(Warehouse.makePartName(tbl.getPartitionKeys(), part.getValues()));\n        }\n        ms.dropPartitions(dbName, tableName, partNames);\n      }\n      return partPaths;\n    }","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rnpridgeon","name":"rnpridgeon","key":"rnpridgeon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Pridgeon","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-20T21:32:08.688+0000","updated":"2014-11-20T21:32:08.688+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12752852/comment/14288127","id":"14288127","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"We are going to reverting HIVE-5700 in HIVE-9445.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2015-01-22T20:00:43.882+0000","updated":"2015-01-22T20:00:43.882+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-8730/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i21yrj:"}}