{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13118814","self":"https://issues.apache.org/jira/rest/api/2/issue/13118814","key":"HIVE-18080","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-11-17T08:29:52.003+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Nov 23 06:15:14 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18080/watchers","watchCount":6,"isWatching":false},"created":"2017-11-16T05:42:26.557+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-11-23T08:35:03.405+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"Use  Xeon(R) Platinum 8180 CPU to test the performance of [AVX512|https://en.wikipedia.org/wiki/AVX-512].\r\n{code}\r\n#cat /proc/cpuinfo |grep \"model name\"|head -n 1\r\nmodel name\t: Intel(R) Xeon(R) Platinum 8180 CPU @ 2.50GHz\r\n{code}\r\nBefore that I have compiled hive with JDK9 as JDK9 enables AVX512 \r\nUse hive microbenchmark(HIVE-10189) to evaluate the performance improvement. It seems performance(20%+) in cases in {{VectorizedArithmeticBench}},{{VectorizedComparisonBench}},{{VectorizedLikeBench}},{{VectorizedLogicBench}} execpt {{VectorizedLogicBench#IfExprLongColumnLongColumnBench}},{{VectorizedLogicBench#IfExprRepeatingLongColumnLongColumnBench}} and\r\n{{VectorizedLogicBench#IfExprLongColumnRepeatingLongColumnBench}}.The data is like following\r\nWhen i use Skylake CPU to evaluate the performance improvement of AVX512.\r\nI found the performance in VectorizedLogicBench is like following\r\n|| ||AVX2 us/op||AVX512 us/op ||  (AVX2-AVX512)/AVX2||\r\n|ColAndColBench|122510| 87014| 28.9%|\r\n|IfExprLongColumnLongColumnBench | 1325759| 1436073| -8.3% |\r\n|IfExprLongColumnRepeatingLongColumnBench|1397447|1480450|  -5.9%|\r\n|IfExprRepeatingLongColumnLongColumnBench|1401164|1483062|  -5.9% |\r\n|NotColBench|77042.83|51513.28|  33%|\r\n\r\nThere are degradation in IfExprLongColumnLongColumnBench,IfExprLongColumnRepeatingLongColumnBench, IfExprRepeatingLongColumnLongColumnBench, very confused why there is degradation on IfExprLongColumnLongColumnBench cases.\r\n\r\nHere we use {{taskset -cp 1 $pid}} to run the benchmark on single core to avoid the impact of dynamic CPU frequency scaling.\r\nmy script\r\n{code}\r\nexport JAVA_HOME=/home/zly/jdk-9.0.1/\r\nexport PATH=$JAVA_HOME/bin:$PATH\r\nexport LD_LIBRARY_PATH=/home/zly/jdk-9.0.1/mylib\r\nfor i in 0 1 2; do\r\njava -server -XX:UseAVX=3 -jar benchmarks.jar org.apache.hive.benchmark.vectorization.VectorizedLogicBench * -wi 10 -i 20 -f 1 -bm avgt -tu us >log.logic.avx3.single.$i & export pid=$!\r\ntaskset -cp 1 $pid\r\nwait $pid\r\ndone\r\n\r\nfor i in 0 1 2; do\r\njava -server -XX:UseAVX=2 -jar benchmarks.jar org.apache.hive.benchmark.vectorization.VectorizedLogicBench * -wi 10 -i 20 -f 1 -bm avgt -tu us >log.logic.avx2.single.$i & export pid=$!\r\ntaskset -cp 1 $pid\r\nwait $pid\r\ndone\r\n\r\n{code}\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12898999","id":"12898999","filename":"IFExpression_AVX2_Instruction.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-23T06:17:29.341+0000","size":157927,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12898999/IFExpression_AVX2_Instruction.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12898227","id":"12898227","filename":"log_logic.avx1.part","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-17T16:13:16.448+0000","size":6135001,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12898227/log_logic.avx1.part"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12898421","id":"12898421","filename":"log.logic.avx1.single.0","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-20T06:36:09.977+0000","size":32421,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12898421/log.logic.avx1.single.0"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Performance degradation on VectorizedLogicBench#IfExprLongColumnLongColumnBench when AVX512 is enabled","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16254783","id":"16254783","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"[~teddy.choi]: Can you help view it as you are familiar with the code, thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-16T05:43:09.551+0000","updated":"2017-11-16T05:43:09.551+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16254829","id":"16254829","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"[~teddy.choi]: I retested {{VectorizedLogicBench#IfExprLongColumnLongColumnBench}},{{VectorizedLogicBench#IfExprRepeatingLongColumnLongColumnBench}} and\r\n{{VectorizedLogicBench#IfExprLongColumnRepeatingLongColumnBench}} in AVX1 and AVX2\r\nthe result is \r\nAVX1\r\n{code}\r\no.a.h.b.v.VectorizedLogicBench.IfExprLongColumnLongColumnBench.bench             avgt       20  1595748.343 Â± 16887.073  us/op\r\no.a.h.b.v.VectorizedLogicBench.IfExprLongColumnRepeatingLongColumnBench.bench    avgt       20  1735827.809 Â± 18129.173  us/op\r\no.a.h.b.v.VectorizedLogicBench.IfExprRepeatingLongColumnLongColumnBench.bench    avgt       20  1768004.314 Â± 14489.511  us/op\r\n{code}\r\n\r\nAVX2\r\n{code}\r\no.a.h.b.v.VectorizedLogicBench.IfExprLongColumnLongColumnBench.bench             avgt       20  1691559.843 Â± 118986.372  us/op\r\no.a.h.b.v.VectorizedLogicBench.IfExprLongColumnRepeatingLongColumnBench.bench    avgt       20  1837327.456 Â±  76084.038  us/op\r\no.a.h.b.v.VectorizedLogicBench.IfExprRepeatingLongColumnLongColumnBench.bench    avgt       20  1760544.684 Â±  93512.838  us/op\r\n{code}\r\n\r\nthe test script I used\r\n{code}\r\nexport JAVA_HOME=/home/zly/sr601/jmh/jdk-9.0.1/\r\nexport PATH=$JAVA_HOME/bin:$PATH\r\nexport LD_LIBRARY_PATH=/home/zly/sr601/jmh/jdk-9.0.1/mylib\r\nfor i in 0 1 2; do\r\njava -server -XX:UseAVX=1 -jar benchmarks.jar org.apache.hive.benchmark.vectorization.VectorizedLogicBench * -wi 10 -i 20 -f 1 -bm avgt -tu us >log.logic.avx1.single.$i & export pid=$!\r\ntaskset -cp 1 $pid\r\nwait $pid\r\ndone\r\n\r\nfor i in 0 1 2; do\r\njava -server -XX:UseAVX=2 -jar benchmarks.jar org.apache.hive.benchmark.vectorization.VectorizedLogicBench * -wi 10 -i 20 -f 1 -bm avgt -tu us >log.logic.avx2.single.$i & export pid=$!\r\ntaskset -cp 1 $pid\r\nwait $pid\r\ndone\r\n{code}\r\n\r\nIt seems that no much improvement comparing AVX1 and AVX2.  Can you spend some time to help find the root cause? Thanks!\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-16T06:38:55.323+0000","updated":"2017-11-16T06:41:44.869+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16256474","id":"16256474","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"[~mmccline]: can you help see the issue? very thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-17T04:54:40.930+0000","updated":"2017-11-17T04:54:40.930+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16256644","id":"16256644","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"[~kellyzly]: post the output for \"-XX:PrintAssembly\" so that we can compare the AVX1 and AVX2 native code.\r\n\r\nSee comments on HIVE-10180 which have the relevant output for a different benchmark.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-11-17T08:29:52.003+0000","updated":"2017-11-17T08:29:52.003+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16256666","id":"16256666","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"[~gopalv]: use\r\n{code}\r\njava  -XX:+UseSuperWord -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -Xcomp -XX:CompileCommand=*IfExprLongColumnLongColumn.evaluate  -server -XX:UseAVX=1 -jar benchmarks.jar org.apache.hive.benchmark.vectorization.VectorizedLogicBench * -wi 10 -i 5 -f 2 -bm avgt -tu us > log_logic.avx1 2>&1\r\n{code}\r\n\r\n the output of AVX1 is attached, sorry i'm not very understand the assembly code. Can you help to view it, thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-17T08:45:22.968+0000","updated":"2017-11-17T08:57:02.894+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16256677","id":"16256677","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"the output of AVX1 will be uploaded later.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-17T08:58:40.506+0000","updated":"2017-11-17T08:58:40.506+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16257168","id":"16257168","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"the output of the -XX:+PrintAssembly is too much, I attached part of the output as log_logic.avx1.part. The problem here is to \r\nlocate the assembly code related to the expression used in IfExprLongColumnLongColumnBench\r\n{code}\r\n  outputVector[i] = (~(vector1[i] - 1) & vector2[i]) | ((vector1[i] - 1) & vector3[i]);\r\n{code}\r\n\r\nNot very understand assembly, need time to investigate.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-17T16:15:12.104+0000","updated":"2017-11-17T16:15:12.104+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16257261","id":"16257261","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"[~kellyzly]: If you're running this on a linux machine, can you please use -prof perfasm in JMH?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-11-17T17:23:49.119+0000","updated":"2017-11-17T17:23:49.119+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16258853","id":"16258853","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"[~gopalv]: using following command with {{-prof perfasm}} to run the VectorizedLogicBench#IfExprLongColumnLongColumnBench in AVX1\r\n{code}\r\nexport JAVA_HOME=/home/zly/sr601/jdk-9.0.1/\r\nexport PATH=$JAVA_HOME/bin:$PATH\r\nexport LD_LIBRARY_PATH=/home/zly/sr601/jdk-9.0.1/mylib\r\ni=0\r\njava -server -XX:UseAVX=1 -jar benchmarks.jar  -prof perfasm org.apache.hive.benchmark.vectorization.VectorizedLogicBench * -wi 10 -i 20 -f 1 -bm avgt -tu us >log.logic.avx1.single.$i & export pid=$!\r\ntaskset -cp 1 $pid\r\nwait $pid\r\n{code}\r\n\r\nthe [log.logic.avx1.single.0|https://issues.apache.org/jira/secure/attachment/12898421/log.logic.avx1.single.0] attached, find some warning\r\n{code}\r\nPrintAssembly processed: 51105 total address lines.\r\nPerf output processed (skipped 1.020 seconds):\r\n Column 1: cycles (0 events)\r\n Column 2: instructions (0 events)\r\n\r\n....[Hottest Regions]...............................................................................\r\n....................................................................................................\r\n                  <totals>\r\n\r\n....[Hottest Methods (after inlining)]..............................................................\r\n....................................................................................................\r\n                  <totals>\r\n\r\n....[Distribution by Area]..........................................................................\r\n....................................................................................................\r\n                  <totals>\r\n\r\nWARNING: The perf event count is suspiciously low (0). The performance data might be\r\ninaccurate or misleading. Try to do the profiling again, or tune up the sampling frequency.\r\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-20T06:34:31.188+0000","updated":"2017-11-20T06:38:55.570+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16258856","id":"16258856","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"[~gopalv]:\r\n{{-prof perfasm}} depends [PrintAssembly|https://wiki.openjdk.java.net/display/HotSpot/PrintAssembly] while PrintAssembly depends on [Kenai project|http://www.oracle.com/splash/kenai.com/decommissioning/index.html]. Oracle closes \r\nKenai project. I download hsdis.so from others. Not sure this outdated hsdis.so can print assembly the instruction of AVX512 or not.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-20T06:40:04.379+0000","updated":"2017-11-20T06:40:04.379+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118814/comment/16263861","id":"16263861","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"I use vtune to see the assembly code of following code(If expression)\r\n{code}\r\nimport java.util.Random;\r\n\r\n/**\r\n *  * Created by lzhang66 on 11/13/2017.\r\n *   */\r\npublic class If {\r\n  static long[] in1, in2,in3,out;\r\n  public static void main(String[] args){\r\n    if( args.length == 3){\r\n      long warmIter=Long.parseLong(args[0]);\r\n      System.out.println(\"warmIter num:\"+warmIter);\r\n      long iter=Long.parseLong(args[1]);\r\n      System.out.println(\"iter num:\"+iter);\r\n      boolean enableHive10238= Boolean.parseBoolean(args[2]);\r\n      long startTime = System.currentTimeMillis();\r\n      calc(warmIter, iter,enableHive10238);\r\n      long endTime   = System.currentTimeMillis();\r\n      long totalTime = endTime - startTime;\r\n      System.out.println(\"Total time:\"+totalTime);\r\n    }else{\r\n      System.out.println(\"2 parameter need. Like java ReductionInt [warmIter] [iter] [enable\");\r\n      System.exit(0);\r\n    }\r\n\r\n  }\r\n\r\n  public static void calc(long warmIter, long iter, boolean enableHive10238)\r\n  {\r\n    in1 = new long [1026];\r\n    in2 = new long [1026];\r\n    in3 = new long [1026];\r\n\r\n    Random rand = new Random(435437646);\r\n    for(int i=0; i<in1.length; i++)\r\n    {\r\n      in1[i] = rand.nextLong();\r\n    }\r\n\r\n    for(int i=0; i<in2.length; i++)\r\n    {\r\n      in2[i] = rand.nextLong();\r\n    }\r\n\r\n    for (int j = 0; j < warmIter; j++)\r\n    {\r\n       reduction_kernel(in1, in2, in1.length, enableHive10238);\r\n    }\r\n\r\n    long start = System.currentTimeMillis();\r\n    for (int j = 0; j < iter; j++)\r\n    {\r\n      reduction_kernel(in1, in2, in1.length, enableHive10238);\r\n    }\r\n\r\n    long elapsedTimeMillis = System.currentTimeMillis()-start;\r\n    System.out.println(\"Iterations Per milli Second:\" + (iter)/elapsedTimeMillis+\" ipms\");\r\n  }\r\n\r\n  private static void reduction_kernel(long[] in1, long[] in2, int length, boolean enableHive10238) {\r\n    out = new long[1026];\r\n    if (enableHive10238) {\r\n      for (int i1 = 0; i1 < in1.length; i1++) {\r\n        out[i1] = (~(in1[i1] - 1L) & in2[i1]) |(( in1[i1] - 1L)& in3[i1]);\r\n      }\r\n    } else {\r\n      for (int i1 = 0; i1 < in1.length; i1++) {\r\n        out[i1] = (in1[i1] - 1L)>0? in2[i1]: in3[i1];\r\n      }\r\n    }\r\n  }\r\n}\r\n{code}\r\n\r\nrun {{java If 5000 50000 true}} to enable the patch of HIVE-10238  and run {{java  If 5000 50000 false}} to disable the patch of HIVE-10238. Here there is three parameters, para1 means warmIter number, para2 means  Iter number, para3 means with/wot HIVE-10238's patch.  In the attached picture, I saw AVX2 instructions of if expression( {code}(in1[i1] - 1L)>0? in2[i1]: in3[i1]{code}).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-23T06:15:14.749+0000","updated":"2017-11-23T06:15:14.749+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18080/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3muvb:"}}