{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13103824","self":"https://issues.apache.org/jira/rest/api/2/issue/13103824","key":"HIVE-17573","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-01-04T06:01:38.087+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Mar 23 18:24:46 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17573/watchers","watchCount":6,"isWatching":false},"created":"2017-09-21T06:11:07.892+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340268","id":"12340268","name":"3.0.0","archived":false,"released":true,"releaseDate":"2018-05-21"}],"issuelinks":[{"id":"12516041","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12516041","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13105676","key":"HIVE-17632","self":"https://issues.apache.org/jira/rest/api/2/issue/13105676","fields":{"summary":"Build Hive with JDK9","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12515755","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12515755","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"13104819","key":"HIVE-17599","self":"https://issues.apache.org/jira/rest/api/2/issue/13104819","fields":{"summary":"LLAP: Automatically pre-compile all of ORC, Tez & LLAP using Java jaotc","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-23T18:24:46.606+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12328311","id":"12328311","name":"llap"}],"timeoriginalestimate":null,"description":"The perf diff between JDK8 -> JDK9 seems to be significant.  \n\nTPC-H Q6 on JDK8 takes 32s on a single node + 1 Tb scale warehouse. \nTPC-H Q6 on JDK9 takes 19s on the same host + same data.\n\nThe performance difference seems to come from better JIT and better NUMA handling.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"LLAP: JDK9 support fixes","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13103824/comment/16310797","id":"16310797","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"[~gopalv]:\r\nIt seems that on tpch_text_10(10g), there is no big difference between JDK9 and JDK8 for [TPC-H Q6| https://github.com/kellyzly/hive-testbench/blob/hive14/sample-queries-tpch/tpch_query6.sql] on my machine( 1 node with CPU E5-2690 v2, 40 cores,62g )\r\n\r\njdk8: 54.189s\r\n\r\njdk9: 67.86s\r\n\r\n{quote}\r\nThe performance difference seems to come from better JIT and better NUMA handling.\r\n{quote}\r\n\r\nFrom which tool, you can get above conclusion? Have you test it on machine with NUMA architecture?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-01-04T06:01:38.087+0000","updated":"2018-01-04T06:01:38.087+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13103824/comment/16310895","id":"16310895","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"[~kellyzly]: I'm using LLAP with ORC, loaded using the bin_flat tpc-h script in hive-testbench.\r\n\r\nhttps://github.com/hortonworks/hive-testbench/tree/hdp26/ddl-tpch/bin_flat\r\n\r\nThe hardware is {{Intel(R) Xeon(R) CPU E5-2640 v2 @ 2.00GHz}}, with 256Gb RAM and with the following NUMA organization\r\n\r\nThe memory is split as 128Gb Xmx + 32Gb cache for 24 executors, with a 180Gb container, which pretty much can fit the entire Q6 data in cache at the 1Tb scale.\r\n\r\nIf you have the text-cache enabled (this takes multiple flags), you might be able to get similar performance from the text data as well, but the significant ORC speedup comes from loading data into lineitem in a natural order (the production-like ingest results in one file per day).\r\n\r\n{code}\r\navailable: 2 nodes (0-1)\r\nnode 0 cpus: 0 1 2 3 4 5 6 7 16 17 18 19 20 21 22 23\r\nnode 0 size: 131037 MB\r\nnode 0 free: 127359 MB\r\nnode 1 cpus: 8 9 10 11 12 13 14 15 24 25 26 27 28 29 30 31\r\nnode 1 size: 131072 MB\r\nnode 1 free: 127987 MB\r\nnode distances:\r\nnode   0   1 \r\n  0:  10  21 \r\n  1:  21  10 \r\n{code}\r\n\r\nThe setup uses a giant TLAB maximum so that the in-thread allocations go to the same NUMA zone.\r\n\r\n{{-XX:TLABSize=128m -XX:+ResizeTLAB -XX:+UseNUMA -XX:+AggressiveOpts -XX:MetaspaceSize=1024m}}\r\n\r\nJDK9 seems to wake up the producer-consumer pair on the same NUMA zone (the IO elevator allocates, passes the array to the executor thread and executor passes it back instead of throwing it to GC deref).\r\n\r\nI'm not sure there's any actual movement on JEP-157 which would probably help this thread-to-thread object passing much more.\r\n\r\nbq. From which tool, you can get above conclusion?\r\n\r\nhttps://github.com/t3rmin4t0r/perf-map-agent/blob/jitdump/jit-objdump.sh\r\n\r\nThat's the script which I use to attach GDB to a running JIT process and extract a JIT sample, with the additional CPU perf events.\r\n\r\nHere's an example of the final report I gather from the JIT (this was sent to Intel JDK team as a perf report, to see if they could fix {{public String(byte ascii[], int hibyte, int offset, int count)}} to be faster for very small strings).\r\n\r\nhttp://people.apache.org/~gopalv/perf-29529.tbz2\r\n\r\nThis is a perf event capture which contains for Q6 on text data (instead of ORC)\r\n\r\n{code}\r\nperf record -ag -e cycles,instructions,branch-misses,LLC-prefetch-misses,cache-misses,LLC-store-misses,LLC-load-misses\r\n{code}\r\n\r\nalong with the JIT generated assembly.\r\n\r\nIf you're on a x86_64 machine, then I guess run-report.sh should work.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2018-01-04T07:18:31.161+0000","updated":"2018-01-04T07:18:31.161+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13103824/comment/16312596","id":"16312596","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"body":"[~gopalv]: thanks for your reply and tool.  \r\nbq.JDK9 seems to wake up the producer-consumer pair on the same NUMA zone (the IO elevator allocates, passes the array to the executor thread and executor passes it back instead of throwing it to GC deref).\r\n If I don't add {{-XX:+UseNUMA}}, I guess the optimization about NUMA handling will not benefit the query, is it right? UseNUMA is disabled by default.\r\nbq.the IO elevator allocates, passes the array to the executor thread and executor passes it back instead of throwing it to GC deref\r\nI guess this will reduce less GC.\r\n\r\nFrom my test result, what i found is GC is less in JDK9 comparing JDK8 on Hive on Spark  in long queries([link|https://docs.google.com/presentation/d/1cK9ZfUliAggH3NJzSvexTPwkXpbsM7Dm0o0kdmuFQUU/edit#slide=id.p]). Maybe this is because G1GC is the default garbage collector and the purpose of [G1GC|https://docs.oracle.com/javase/9/gctuning/garbage-first-garbage-collector.htm#JSGCT-GUID-0394E76A-1A8F-425E-A0D0-B48A3DC82B42] is less GC time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyzly","name":"kellyzly","key":"kellyzly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liyunzhang","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-01-05T07:24:35.886+0000","updated":"2018-01-05T07:24:35.886+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13103824/comment/16411847","id":"16411847","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajadash2006%40gmail.com","name":"rajadash2006@gmail.com","key":"rajadash2006@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"PRAFUL DASH","active":true,"timeZone":"Asia/Kolkata"},"body":"Its very Important guys , please get this done as you know already jdk 10 is going to available  soon,  so need to fix / make this compatable asap.\r\n\r\n \r\n\r\nThanks,\r\n\r\nPRAFUL","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajadash2006%40gmail.com","name":"rajadash2006@gmail.com","key":"rajadash2006@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"PRAFUL DASH","active":true,"timeZone":"Asia/Kolkata"},"created":"2018-03-23T18:24:46.606+0000","updated":"2018-03-23T18:24:46.606+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17573/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3kc3r:"}}