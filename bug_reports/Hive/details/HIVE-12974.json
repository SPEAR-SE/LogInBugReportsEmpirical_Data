{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12935646","self":"https://issues.apache.org/jira/rest/api/2/issue/12935646","key":"HIVE-12974","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Feb 04 09:36:48 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-12974/watchers","watchCount":2,"isWatching":false},"created":"2016-02-01T15:32:25.218+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324986","id":"12324986","description":"released","name":"0.13.0","archived":false,"released":true,"releaseDate":"2014-04-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-02-04T09:36:48.177+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325007","id":"12325007","name":"Hive"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12320408","id":"12320408","name":"HiveServer2","description":"Tracks issues related to HiveServer2"}],"timeoriginalestimate":null,"description":"I've created a custom implementation of the `PasswdAuthenticationProvider` interface, based on OAuth2. I think the code is irrelevant for the problem I'm experiencing, nevertheless, it can be found [here | https://github.com/telefonicaid/fiware-cosmos/blob/master/cosmos-hive-auth-provider/src/main/java/com/telefonica/iot/cosmos/hive/authprovider/OAuth2AuthenticationProviderImpl.java].\n\nI've configured `hive-site.xml` with the following properties:\n\n{code}\n    <property>\n       <name>hive.server2.authentication</name>\n       <value>CUSTOM</value>\n    </property>\n    <property>\n       <name>hive.server2.custom.authentication.class</name>\n       <value>com.telefonica.iot.cosmos.hive.authprovider.OAuth2AuthenticationProviderImpl</value>\n    </property>\n{code}\n\nThen I've restarted the Hive service and I've connected a JDBC based remote client with success. This is an example of a successful run found in `/var/log/hive/hiveserver2.log`:\n\n{code}\n    2016-02-01 11:52:44,515 INFO  [pool-5-thread-5]: authprovider.HttpClientFactory (HttpClientFactory.java:<init>(66)) - Setting max total connections (500)\n    2016-02-01 11:52:44,515 INFO  [pool-5-thread-5]: authprovider.HttpClientFactory (HttpClientFactory.java:<init>(67)) - Setting default max connections per route (100)\n    2016-02-01 11:52:44,799 INFO  [pool-5-thread-5]: authprovider.HttpClientFactory (OAuth2AuthenticationProviderImpl.java:Authenticate(65)) - Doing request: GET https://account.lab.fiware.org/user?access_token=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx HTTP/1.1\n    2016-02-01 11:52:44,800 INFO  [pool-5-thread-5]: authprovider.HttpClientFactory (OAuth2AuthenticationProviderImpl.java:Authenticate(76)) - Response received: {\"organizations\": [], \"displayName\": \"frb\", \"roles\": [{\"name\": \"provider\", \"id\": \"106\"}], \"app_id\": \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\", \"email\": \"frb@tid.es\", \"id\": \"frb\"}\n    2016-02-01 11:52:44,801 INFO  [pool-5-thread-5]: authprovider.HttpClientFactory (OAuth2AuthenticationProviderImpl.java:Authenticate(104)) - User frb authenticated\n    2016-02-01 11:52:44,868 INFO  [pool-5-thread-5]: thrift.ThriftCLIService (ThriftCLIService.java:OpenSession(188)) - Client protocol version: HIVE_CLI_SERVICE_PROTOCOL_V6\n    2016-02-01 11:52:44,871 INFO  [pool-5-thread-5]: session.SessionState (SessionState.java:start(358)) - No Tez session required at this point. hive.execution.engine=mr.\n    2016-02-01 11:52:44,873 INFO  [pool-5-thread-5]: session.SessionState (SessionState.java:start(358)) - No Tez session required at this point. hive.execution.engine=mr.\n{code}\n\nThe problem is after that the following error appears in a recurrent manner:\n\n{code}\n    2016-02-01 11:52:48,227 ERROR [pool-5-thread-4]: server.TThreadPoolServer (TThreadPoolServer.java:run(215)) - Error occurred during processing of message.\n    java.lang.RuntimeException: org.apache.thrift.transport.TTransportException\n    \tat org.apache.thrift.transport.TSaslServerTransport$Factory.getTransport(TSaslServerTransport.java:219)\n    \tat org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:189)\n    \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    \tat java.lang.Thread.run(Thread.java:745)\n    Caused by: org.apache.thrift.transport.TTransportException\n    \tat org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:132)\n    \tat org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)\n    \tat org.apache.thrift.transport.TSaslTransport.receiveSaslMessage(TSaslTransport.java:182)\n    \tat org.apache.thrift.transport.TSaslServerTransport.handleSaslStartMessage(TSaslServerTransport.java:125)\n    \tat org.apache.thrift.transport.TSaslTransport.open(TSaslTransport.java:253)\n    \tat org.apache.thrift.transport.TSaslServerTransport.open(TSaslServerTransport.java:41)\n    \tat org.apache.thrift.transport.TSaslServerTransport$Factory.getTransport(TSaslServerTransport.java:216)\n    \t... 4 more\n    2016-02-01 11:53:18,323 ERROR [pool-5-thread-5]: server.TThreadPoolServer (TThreadPoolServer.java:run(215)) - Error occurred during processing of message.\n    java.lang.RuntimeException: org.apache.thrift.transport.TTransportException\n    \tat org.apache.thrift.transport.TSaslServerTransport$Factory.getTransport(TSaslServerTransport.java:219)\n    \tat org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:189)\n    \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    \tat java.lang.Thread.run(Thread.java:745)\n    Caused by: org.apache.thrift.transport.TTransportException\n    \tat org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:132)\n    \tat org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)\n    \tat org.apache.thrift.transport.TSaslTransport.receiveSaslMessage(TSaslTransport.java:182)\n    \tat org.apache.thrift.transport.TSaslServerTransport.handleSaslStartMessage(TSaslServerTransport.java:125)\n    \tat org.apache.thrift.transport.TSaslTransport.open(TSaslTransport.java:253)\n    \tat org.apache.thrift.transport.TSaslServerTransport.open(TSaslServerTransport.java:41)\n    \tat org.apache.thrift.transport.TSaslServerTransport$Factory.getTransport(TSaslServerTransport.java:216)\n    \t... 4 more\n{code}\n\nWhy? I've seen in several other questions this occurs when using the default value of `hive.server2.authentication`, i.e. `SASL`, and the client is not doing the handshake. But in my case, the value of such a property is `CUSTOM`. I cannot understand it, and any help would be really appreciated.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"HiveServer2: Thrift SASL related exception when using custom PasswdAuthenticationProvider","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frbattid","name":"frbattid","key":"frbattid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francisco Romero Bueno","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frbattid","name":"frbattid","key":"frbattid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francisco Romero Bueno","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"HDP-2.1","customfield_12313520":null,"customfield_12311020":null,"duedate":"2016-02-01","customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12935646/comment/15126395","id":"15126395","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frbattid","name":"frbattid","key":"frbattid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francisco Romero Bueno","active":true,"timeZone":"Etc/UTC"},"body":"I've seen this other similar issue https://issues.apache.org/jira/browse/HIVE-12754","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frbattid","name":"frbattid","key":"frbattid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francisco Romero Bueno","active":true,"timeZone":"Etc/UTC"},"created":"2016-02-01T15:33:04.985+0000","updated":"2016-02-01T15:33:04.985+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12935646/comment/15127960","id":"15127960","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frbattid","name":"frbattid","key":"frbattid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francisco Romero Bueno","active":true,"timeZone":"Etc/UTC"},"body":"I've found there are periodical requests to the HiveServer2... from the HiveServer2 itself! These are the requests that are resulting in Thrift SASL errors:\n\n{code}\n$ sudo tcpdump -i lo port 10000\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on lo, link-type EN10MB (Ethernet), capture size 65535 bytes\n...\n...\n10:18:48.183469 IP dev-fiwr-bignode-11.hi.inet.ndmp > dev-fiwr-bignode-11.hi.inet.55758: Flags [.], ack 7, win 512, options [nop,nop,TS val 1034162147 ecr 1034162107], length 0\n^C\n21 packets captured\n42 packets received by filter\n0 packets dropped by kernel\n[fiware-portal@dev-fiwr-bignode-11 ~]$ sudo netstat -nap | grep 55758\ntcp        0      0 10.95.76.91:10000           10.95.76.91:55758           CLOSE_WAIT  7190/java           \ntcp        0      0 10.95.76.91:55758           10.95.76.91:10000           FIN_WAIT2   -                   \n[fiware-portal@dev-fiwr-bignode-11 ~]$ ps -ef | grep 7190\nhive      7190     1  1 10:10 ?        00:00:10 /usr/java/jdk1.7.0_71//bin/java -Xmx1024m -Djava.net.preferIPv4Stack=true -Dhadoop.log.dir=/var/log/hadoop/hive -Dhadoop.log.file=hadoop.log -Dhadoop.home.dir=/usr/lib/hadoop -Dhadoop.id.str=hive -Dhadoop.root.logger=INFO,console -Djava.library.path=:/usr/lib/hadoop/lib/native/Linux-amd64-64:/usr/lib/hadoop/lib/native -Dhadoop.policy.file=hadoop-policy.xml -Djava.net.preferIPv4Stack=true -Xmx1024m -Xmx4096m -Dhadoop.security.logger=INFO,NullAppender org.apache.hadoop.util.RunJar /usr/lib/hive/lib/hive-service-0.13.0.2.1.7.0-784.jar org.apache.hive.service.server.HiveServer2 -hiveconf hive.metastore.uris=\" \" -hiveconf hive.log.file=hiveserver2.log -hiveconf hive.log.dir=/var/log/hive\n1011     14158 12305  0 10:19 pts/1    00:00:00 grep 7190\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frbattid","name":"frbattid","key":"frbattid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francisco Romero Bueno","active":true,"timeZone":"Etc/UTC"},"created":"2016-02-02T09:33:38.787+0000","updated":"2016-02-02T09:33:38.787+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12935646/comment/15132034","id":"15132034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frbattid","name":"frbattid","key":"frbattid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francisco Romero Bueno","active":true,"timeZone":"Etc/UTC"},"body":"More research about the connections sent from HiveServer2 to HiveServer2. Data packets always sent 5 bytes, the following ones (hexadecimal): 22 41 30 30 31\n\nAny idea about these connections?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frbattid","name":"frbattid","key":"frbattid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francisco Romero Bueno","active":true,"timeZone":"Etc/UTC"},"created":"2016-02-04T09:36:48.177+0000","updated":"2016-02-04T09:36:48.177+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-12974/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2s8lr:"}}