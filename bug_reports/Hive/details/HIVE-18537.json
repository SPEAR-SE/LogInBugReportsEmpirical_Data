{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13133603","self":"https://issues.apache.org/jira/rest/api/2/issue/13133603","key":"HIVE-18537","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Feb 06 09:04:25 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18537/watchers","watchCount":2,"isWatching":false},"created":"2018-01-25T07:05:11.577+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334255","id":"12334255","name":"2.1.0","archived":false,"released":true,"releaseDate":"2016-06-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342053","id":"12342053","name":"2.3.2","archived":false,"released":true,"releaseDate":"2017-11-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-12T08:44:51.532+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325007","id":"12325007","name":"Hive"}],"timeoriginalestimate":null,"description":"Sample test case to re-produce the issue. The issue does not occur if *hive.cbo.enable=false*\r\n{code:java}\r\ncreate table test_cbo (\r\n `a` BIGINT,\r\n `b` STRING,\r\n `c` TIMESTAMP,\r\n `d` STRING\r\n );\r\nSELECT 1\r\n FROM\r\n (SELECT\r\n DISTINCT\r\n a AS a_,\r\n b AS b_,\r\n rank() over (partition BY a ORDER BY c DESC) AS c_,\r\n d AS d_\r\n FROM test_cbo\r\n WHERE b = 'some_filter' ) n\r\n WHERE c_ = 1;\r\n{code}\r\nFails with, \r\n{code:java}\r\nException in thread \"main\" java.lang.AssertionError: Internal error: Cannot add expression of different type to set:\r\nset type is RecordType(BIGINT a_, INTEGER c_, VARCHAR(2147483647) CHARACTER SET \"UTF-16LE\" COLLATE \"ISO-8859-1$en_US$primary\" d_) NOT NULL\r\nexpression type is RecordType(BIGINT a_, VARCHAR(2147483647) CHARACTER SET \"UTF-16LE\" COLLATE \"ISO-8859-1$en_US$primary\" c_, INTEGER d_) NOT NULL\r\nset is rel#112:HiveAggregate.HIVE.[](input=HepRelVertex#121,group={0, 2, 3})\r\nexpression is HiveProject#123{code}\r\nThis might be related to https://issues.apache.org/jira/browse/CALCITE-1868.\r\n  ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"[Calcite-CBO] Queries with a nested distinct clause and a windowing function seem to fail with calcite Assertion error","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amrk7","name":"amrk7","key":"amrk7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amruth S","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amrk7","name":"amrk7","key":"amrk7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amruth S","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13133603/comment/16342459","id":"16342459","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amrk7","name":"amrk7","key":"amrk7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amruth S","active":true,"timeZone":"Etc/UTC"},"body":"RelDataTypeFactoryImpl's LoadingCache seem to create Fields with indices based on the current row ordering. \r\n\r\nBut in AggregateProjectPullUpConstantsRule, the navigable map that stores the constants seem to hash it against the original ordinal. So when iterating over the fieldlist of aggregate row types to create, to create the projection again, wrong datatypes are getting mapped against the column names.\r\n\r\nIn this particular example shared, the original type is a(bigint), c(integer), d(varchar). But post the transformation the type ends up as  a(bigint), c(varchar), d(integer) failing in type equivalence. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amrk7","name":"amrk7","key":"amrk7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amruth S","active":true,"timeZone":"Etc/UTC"},"created":"2018-01-28T05:54:12.140+0000","updated":"2018-01-28T05:54:12.140+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13133603/comment/16353597","id":"16353597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amrk7","name":"amrk7","key":"amrk7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amruth S","active":true,"timeZone":"Etc/UTC"},"body":"With just calcite libraries, the same table def and query works. The issue comes only with hive classes overriding calcite's.\r\n\r\nWe have mitigated this currently by capturing the AssertionError and skipping the optimization.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amrk7","name":"amrk7","key":"amrk7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amruth S","active":true,"timeZone":"Etc/UTC"},"created":"2018-02-06T09:04:25.269+0000","updated":"2018-02-06T09:04:25.269+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18537/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3pccf:"}}