{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12525237","self":"https://issues.apache.org/jira/rest/api/2/issue/12525237","key":"HIVE-2472","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316178","id":"12316178","description":"released","name":"0.8.0","archived":false,"released":true,"releaseDate":"2011-12-16"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-09-29T21:49:45.725+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Nov 11 11:01:45 UTC 2011","customfield_12310420":"40364","customfield_12312320":null,"customfield_12310222":"10002_*:*_2_*:*_641996796_*|*_1_*:*_2_*:*_3022167613_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-11-11T06:13:27.212+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-2472/watchers","watchCount":2,"isWatching":false},"created":"2011-09-29T20:24:03.090+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12345411","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12345411","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12407019","key":"HIVE-33","self":"https://issues.apache.org/jira/rest/api/2/issue/12407019","fields":{"summary":"[Hive]: Add optimizer statistics in Hive","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21141&avatarType=issuetype","name":"New Feature","subtask":false,"avatarId":21141}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsurowka","name":"rsurowka","key":"rsurowka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Sur贸wka","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-02-02T22:09:31.259+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12314312","id":"12314312","name":"Statistics"}],"timeoriginalestimate":null,"description":"We need to add a Statistics task at the end of a CTAS query in order to update the metastore statistics for the table being created.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12497066","id":"12497066","filename":"HIVE-2472.1.patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kevinwilfong","name":"kevinwilfong","key":"kevinwilfong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Wilfong","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-29T21:48:17.999+0000","size":78889,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12497066/HIVE-2472.1.patch.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502208","id":"12502208","filename":"HIVE-2472.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsurowka","name":"rsurowka","key":"rsurowka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Sur贸wka","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T19:45:33.215+0000","size":98197,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12502208/HIVE-2472.2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502211","id":"12502211","filename":"HIVE-2472.3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsurowka","name":"rsurowka","key":"rsurowka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Sur贸wka","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T20:06:25.145+0000","size":97281,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12502211/HIVE-2472.3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502879","id":"12502879","filename":"HIVE-2472.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsurowka","name":"rsurowka","key":"rsurowka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Sur贸wka","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-08T04:09:48.522+0000","size":114245,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12502879/HIVE-2472.4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12503305","id":"12503305","filename":"HIVE-2472.5.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsurowka","name":"rsurowka","key":"rsurowka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Sur贸wka","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-10T23:35:12.443+0000","size":117002,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12503305/HIVE-2472.5.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"3300","customfield_12312823":null,"summary":"Metastore statistics are not being updated for CTAS queries.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kevinwilfong","name":"kevinwilfong","key":"kevinwilfong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Wilfong","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kevinwilfong","name":"kevinwilfong","key":"kevinwilfong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Wilfong","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13117643","id":"13117643","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2120/\n-----------------------------------------------------------\n\nReview request for hive, Yongqiang He and Ning Zhang.\n\n\nSummary\n-------\n\n(This is not needed for RC-2)\n\nI modified StatsTask so that it could be created from a CTAS query.\n\nThe StatsTask is created where StatsTask are typically created, but instead of being appended to the final MoveTask it is stored in the QB.  This is because the SemanticAnalyzer appends the task to create the table to the task tree in order to ensure atomicity.  The StatsTask requires that the table already be created, by putting it in the QB, the SemanticAnalyzer is able to access it and append to it to the create table task.\n\n\nThis addresses bug HIVE-2472.\n    https://issues.apache.org/jira/browse/HIVE-2472\n\n\nDiffs\n-----\n\n  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1177363 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1177363 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/QB.java 1177363 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1177363 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1177363 \n  trunk/ql/src/test/results/clientpositive/ctas.q.out 1177363 \n  trunk/ql/src/test/results/clientpositive/merge3.q.out 1177363 \n  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1177363 \n  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1177363 \n\nDiff: https://reviews.apache.org/r/2120/diff\n\n\nTesting\n-------\n\nI ran a CTAS query and verified the stats appeared in the console at the end of the query, and that they were stored in the table's metadata.\n\nI ran the unit test queries, and updated the output of the ones which use CTAS queries\n\n\nThanks,\n\nKevin\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-29T21:49:45.725+0000","updated":"2011-09-29T21:49:45.725+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13143477","id":"13143477","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2583/\n-----------------------------------------------------------\n\n(Updated 2011-11-03 19:46:23.842574)\n\n\nReview request for Ning Zhang and Kevin Wilfong.\n\n\nSummary\n-------\n\nNow table stats will be collected for CTAS queries.\n\n\nThis addresses bug HIVE-2472.\n    https://issues.apache.org/jira/browse/HIVE-2472\n\n\nDiffs\n-----\n\n  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 \n  trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/database.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 \n\nDiff: https://reviews.apache.org/r/2583/diff\n\n\nTesting\n-------\n\nrun ant tests with overwrite option, changes to out files are part of the diff\n\n\nThanks,\n\nRobert\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T19:47:32.360+0000","updated":"2011-11-03T19:47:32.360+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13143478","id":"13143478","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsurowka","name":"rsurowka","key":"rsurowka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Sur贸wka","active":true,"timeZone":"Etc/UTC"},"body":"The diff for HIVE-2472.2.patch can be found at https://reviews.apache.org/r/2583/diff/#index_header (last version). ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsurowka","name":"rsurowka","key":"rsurowka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Sur贸wka","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T19:48:12.576+0000","updated":"2011-11-03T19:48:12.576+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13143483","id":"13143483","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2583/\n-----------------------------------------------------------\n\n(Updated 2011-11-03 19:50:15.818785)\n\n\nReview request for Ning Zhang and Kevin Wilfong.\n\n\nSummary (updated)\n-------\n\nExplanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):\n\n\nBecause CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.\n\nThere were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.\n\nFileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). \n\nNext issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.\n\nAnother thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.\n\nFinally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).\n\n\nI noticed that to database.q.out \"Cannot get table db1.db1.conflict_name\" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.\n\n\nThis addresses bug HIVE-2472.\n    https://issues.apache.org/jira/browse/HIVE-2472\n\n\nDiffs\n-----\n\n  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 \n  trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/database.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 \n\nDiff: https://reviews.apache.org/r/2583/diff\n\n\nTesting\n-------\n\nrun ant tests with overwrite option, changes to out files are part of the diff\n\n\nThanks,\n\nRobert\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T19:51:33.496+0000","updated":"2011-11-03T19:51:33.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13143494","id":"13143494","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2583/\n-----------------------------------------------------------\n\n(Updated 2011-11-03 20:05:20.364390)\n\n\nReview request for Ning Zhang and Kevin Wilfong.\n\n\nChanges\n-------\n\nIn version 3 there was a missclick mistake I made in eclipse (after the out files were already generated, but before I diffed the patch). It is corrected now, please ignore 3rd version, and when looking for changes compare version 4 with version 2. \n\n\nSummary\n-------\n\nExplanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):\n\n\nBecause CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.\n\nThere were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.\n\nFileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). \n\nNext issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.\n\nAnother thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.\n\nFinally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).\n\n\nI noticed that to database.q.out \"Cannot get table db1.db1.conflict_name\" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.\n\n\nThis addresses bug HIVE-2472.\n    https://issues.apache.org/jira/browse/HIVE-2472\n\n\nDiffs (updated)\n-----\n\n  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 \n  trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/database.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 \n  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 \n\nDiff: https://reviews.apache.org/r/2583/diff\n\n\nTesting\n-------\n\nrun ant tests with overwrite option, changes to out files are part of the diff\n\n\nThanks,\n\nRobert\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T20:05:32.035+0000","updated":"2011-11-03T20:05:32.035+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13145886","id":"13145886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2583/#review3089\n-----------------------------------------------------------\n\n\n\ntrunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java\n<https://reviews.apache.org/r/2583/#comment6894>\n\n    why do we need to check partitions.size() == 0? Isn't it the case that when a partitioned table first created and there is no partitions yet, it will satisfy this condition? \n\n\n\ntrunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java\n<https://reviews.apache.org/r/2583/#comment6895>\n\n    code style nitpick: space between 'if' and '(' \n\n\n\ntrunk/ql/src/test/results/clientpositive/ctas.q.out\n<https://reviews.apache.org/r/2583/#comment6896>\n\n    Here I think the plan should be stage-3 (StatsTask) depends on stage-4 (DDLTask), which depends on stage-0 (MoveTask).\n    \n    Also can you change the .q file to add describe formatted <created_table> to verify that the stats are gathered for the newly created table after CTAS?\n\n\n\ntrunk/ql/src/test/results/clientpositive/ctas.q.out\n<https://reviews.apache.org/r/2583/#comment6897>\n\n    Same here. \n\n\n- Ning\n\n\nOn 2011-11-03 20:05:20, Robert Sur贸wka wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/2583/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-11-03 20:05:20)\nbq.  \nbq.  \nbq.  Review request for Ning Zhang and Kevin Wilfong.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):\nbq.  \nbq.  \nbq.  Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.\nbq.  \nbq.  There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.\nbq.  \nbq.  FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). \nbq.  \nbq.  Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.\nbq.  \nbq.  Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.\nbq.  \nbq.  Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).\nbq.  \nbq.  \nbq.  I noticed that to database.q.out \"Cannot get table db1.db1.conflict_name\" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.\nbq.  \nbq.  \nbq.  This addresses bug HIVE-2472.\nbq.      https://issues.apache.org/jira/browse/HIVE-2472\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 \nbq.    trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 \nbq.    trunk/ql/src/test/results/clientpositive/database.q.out 1196269 \nbq.    trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 \nbq.    trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 \nbq.    trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/2583/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  run ant tests with overwrite option, changes to out files are part of the diff\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Robert\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-07T22:26:51.584+0000","updated":"2011-11-07T22:26:51.584+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13146052","id":"13146052","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-11-07 22:24:59, Ning Zhang wrote:\nbq.  >\n\nActually after CTAS the partitions collection wasn't null, whereas it was just empty (I also commented on it near the end of the diff description). I will do all other changes requested ASAP, thank you. \n\n\n- Robert\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2583/#review3089\n-----------------------------------------------------------\n\n\nOn 2011-11-03 20:05:20, Robert Sur贸wka wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/2583/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-11-03 20:05:20)\nbq.  \nbq.  \nbq.  Review request for Ning Zhang and Kevin Wilfong.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):\nbq.  \nbq.  \nbq.  Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.\nbq.  \nbq.  There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.\nbq.  \nbq.  FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). \nbq.  \nbq.  Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.\nbq.  \nbq.  Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.\nbq.  \nbq.  Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).\nbq.  \nbq.  \nbq.  I noticed that to database.q.out \"Cannot get table db1.db1.conflict_name\" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.\nbq.  \nbq.  \nbq.  This addresses bug HIVE-2472.\nbq.      https://issues.apache.org/jira/browse/HIVE-2472\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 \nbq.    trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 \nbq.    trunk/ql/src/test/results/clientpositive/database.q.out 1196269 \nbq.    trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 \nbq.    trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 \nbq.    trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/2583/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  run ant tests with overwrite option, changes to out files are part of the diff\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Robert\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-08T02:54:51.427+0000","updated":"2011-11-08T02:54:51.427+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13146069","id":"13146069","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2583/\n-----------------------------------------------------------\n\n(Updated 2011-11-08 04:08:52.506156)\n\n\nReview request for Ning Zhang and Kevin Wilfong.\n\n\nChanges\n-------\n\nI implemented all the change requests (hopefully), with one exception that I already commented about.\n\n\nSummary\n-------\n\nExplanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):\n\n\nBecause CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.\n\nThere were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.\n\nFileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). \n\nNext issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.\n\nAnother thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.\n\nFinally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).\n\n\nI noticed that to database.q.out \"Cannot get table db1.db1.conflict_name\" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.\n\n\nThis addresses bug HIVE-2472.\n    https://issues.apache.org/jira/browse/HIVE-2472\n\n\nDiffs (updated)\n-----\n\n  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 \n  trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 \n  trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 \n  trunk/ql/src/test/results/clientpositive/database.q.out 1199067 \n  trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 \n  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 \n  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 \n\nDiff: https://reviews.apache.org/r/2583/diff\n\n\nTesting\n-------\n\nrun ant tests with overwrite option, changes to out files are part of the diff\n\n\nThanks,\n\nRobert\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-08T04:10:51.474+0000","updated":"2011-11-08T04:10:51.474+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13146438","id":"13146438","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-11-07 22:24:59, Ning Zhang wrote:\nbq.  > trunk/ql/src/test/results/clientpositive/ctas.q.out, line 25\nbq.  > <https://reviews.apache.org/r/2583/diff/4/?file=56200#file56200line25>\nbq.  >\nbq.  >     Here I think the plan should be stage-3 (StatsTask) depends on stage-4 (DDLTask), which depends on stage-0 (MoveTask).\nbq.  >     \nbq.  >     Also can you change the .q file to add describe formatted <created_table> to verify that the stats are gathered for the newly created table after CTAS?\n\nChange to amend this was done in Semantic Analyzer around line 7050\n\n\n- Robert\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2583/#review3089\n-----------------------------------------------------------\n\n\nOn 2011-11-08 04:08:52, Robert Sur贸wka wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/2583/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-11-08 04:08:52)\nbq.  \nbq.  \nbq.  Review request for Ning Zhang and Kevin Wilfong.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):\nbq.  \nbq.  \nbq.  Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.\nbq.  \nbq.  There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.\nbq.  \nbq.  FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). \nbq.  \nbq.  Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.\nbq.  \nbq.  Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.\nbq.  \nbq.  Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).\nbq.  \nbq.  \nbq.  I noticed that to database.q.out \"Cannot get table db1.db1.conflict_name\" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.\nbq.  \nbq.  \nbq.  This addresses bug HIVE-2472.\nbq.      https://issues.apache.org/jira/browse/HIVE-2472\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 \nbq.    trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/database.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/2583/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  run ant tests with overwrite option, changes to out files are part of the diff\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Robert\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-08T17:59:51.852+0000","updated":"2011-11-08T17:59:51.852+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13147520","id":"13147520","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2583/#review3124\n-----------------------------------------------------------\n\n\n\ntrunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java\n<https://reviews.apache.org/r/2583/#comment6939>\n\n    style nitpick: removing tab.\n\n\n\ntrunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java\n<https://reviews.apache.org/r/2583/#comment6959>\n\n    here, rather than checkin partitions.size()==0, I think it's better to change getPartitionList() to return null when it is CTAS (i.e., getLoadFileDesc() != null). \n\n\n\ntrunk/ql/src/test/results/clientpositive/database.q.out\n<https://reviews.apache.org/r/2583/#comment6958>\n\n    I suspect this is caused by the change in SemanticAnalyzer.java around line 7906. Can you test if this is caused by that change? If so you'll need to resolve this rather than updating the .out file. \n\n\n\ntrunk/ql/src/test/results/clientpositive/merge3.q.out\n<https://reviews.apache.org/r/2583/#comment6960>\n\n    here stage-2 should only depends on stage-6.\n    \n    also please add 'desc formatted <tbl>' to verify the stats are correct.\n\n\n\ntrunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out\n<https://reviews.apache.org/r/2583/#comment6961>\n\n    same: stage-2 should only depends on stage-4.\n\n\n- Ning\n\n\nOn 2011-11-08 04:08:52, Robert Sur贸wka wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/2583/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-11-08 04:08:52)\nbq.  \nbq.  \nbq.  Review request for Ning Zhang and Kevin Wilfong.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):\nbq.  \nbq.  \nbq.  Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.\nbq.  \nbq.  There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.\nbq.  \nbq.  FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). \nbq.  \nbq.  Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.\nbq.  \nbq.  Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.\nbq.  \nbq.  Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).\nbq.  \nbq.  \nbq.  I noticed that to database.q.out \"Cannot get table db1.db1.conflict_name\" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.\nbq.  \nbq.  \nbq.  This addresses bug HIVE-2472.\nbq.      https://issues.apache.org/jira/browse/HIVE-2472\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 \nbq.    trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/database.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/2583/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  run ant tests with overwrite option, changes to out files are part of the diff\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Robert\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-10T06:53:51.919+0000","updated":"2011-11-10T06:53:51.919+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13147894","id":"13147894","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-11-10 06:52:08, Ning Zhang wrote:\nbq.  >\n\nThis code is not a part of this patch!\n\n\nbq.  On 2011-11-10 06:52:08, Ning Zhang wrote:\nbq.  > trunk/ql/src/test/results/clientpositive/database.q.out, line 1224\nbq.  > <https://reviews.apache.org/r/2583/diff/5/?file=56835#file56835line1224>\nbq.  >\nbq.  >     I suspect this is caused by the change in SemanticAnalyzer.java around line 7906. Can you test if this is caused by that change? If so you'll need to resolve this rather than updating the .out file.\n\nI strongly doubt it, as no other code in Hive except the one I added myself, knows that db name is being stored there. Yet I will check it. \n\n\nbq.  On 2011-11-10 06:52:08, Ning Zhang wrote:\nbq.  > trunk/ql/src/test/results/clientpositive/merge3.q.out, line 60\nbq.  > <https://reviews.apache.org/r/2583/diff/5/?file=56836#file56836line60>\nbq.  >\nbq.  >     here stage-2 should only depends on stage-6.\nbq.  >     \nbq.  >     also please add 'desc formatted <tbl>' to verify the stats are correct.\n\nI will investigate this in the following one, it is actually quite strange (possibly generating out file failed), thank you. \n\n\n- Robert\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2583/#review3124\n-----------------------------------------------------------\n\n\nOn 2011-11-08 04:08:52, Robert Sur贸wka wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/2583/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-11-08 04:08:52)\nbq.  \nbq.  \nbq.  Review request for Ning Zhang and Kevin Wilfong.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):\nbq.  \nbq.  \nbq.  Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.\nbq.  \nbq.  There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.\nbq.  \nbq.  FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). \nbq.  \nbq.  Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.\nbq.  \nbq.  Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.\nbq.  \nbq.  Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).\nbq.  \nbq.  \nbq.  I noticed that to database.q.out \"Cannot get table db1.db1.conflict_name\" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.\nbq.  \nbq.  \nbq.  This addresses bug HIVE-2472.\nbq.      https://issues.apache.org/jira/browse/HIVE-2472\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 \nbq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 \nbq.    trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/database.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 \nbq.    trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/2583/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  run ant tests with overwrite option, changes to out files are part of the diff\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Robert\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-10T18:30:51.347+0000","updated":"2011-11-10T18:30:51.347+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13148112","id":"13148112","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2583/\n-----------------------------------------------------------\n\n(Updated 2011-11-10 23:34:41.924906)\n\n\nReview request for Ning Zhang and Kevin Wilfong.\n\n\nChanges\n-------\n\nHopefully all the earlier mentioned problems have been amended. Actually there was a bug in my code that caused \"Cannot get table db1.db1.conflict_name\" to happen, it's solved by change in LoadFileDesc.java around line 45.\n\n\nSummary\n-------\n\nExplanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):\n\n\nBecause CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.\n\nThere were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.\n\nFileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). \n\nNext issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.\n\nAnother thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.\n\nFinally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).\n\n\nI noticed that to database.q.out \"Cannot get table db1.db1.conflict_name\" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.\n\n\nThis addresses bug HIVE-2472.\n    https://issues.apache.org/jira/browse/HIVE-2472\n\n\nDiffs (updated)\n-----\n\n  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1200588 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1200588 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1200588 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1200588 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1200588 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1200588 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1200588 \n  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1200588 \n  trunk/ql/src/test/queries/clientpositive/ctas.q 1200588 \n  trunk/ql/src/test/queries/clientpositive/merge3.q 1200588 \n  trunk/ql/src/test/results/clientpositive/ctas.q.out 1200588 \n  trunk/ql/src/test/results/clientpositive/database.q.out 1200588 \n  trunk/ql/src/test/results/clientpositive/merge3.q.out 1200588 \n  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1200588 \n  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1200588 \n\nDiff: https://reviews.apache.org/r/2583/diff\n\n\nTesting\n-------\n\nrun ant tests with overwrite option, changes to out files are part of the diff\n\n\nThanks,\n\nRobert\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-10T23:35:51.968+0000","updated":"2011-11-10T23:35:51.968+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13148128","id":"13148128","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nzhang","name":"nzhang","key":"nzhang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ning Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"+1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nzhang","name":"nzhang","key":"nzhang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ning Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-10T23:59:56.536+0000","updated":"2011-11-10T23:59:56.536+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13148287","id":"13148287","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nzhang","name":"nzhang","key":"nzhang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ning Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Committed. Thanks Robert and Kevin!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nzhang","name":"nzhang","key":"nzhang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ning Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-11T06:13:27.288+0000","updated":"2011-11-11T06:13:27.288+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525237/comment/13148421","id":"13148421","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hive-trunk-h0.21 #1076 (See [https://builds.apache.org/job/Hive-trunk-h0.21/1076/])\n    HIVE-2472. Metastore statistics are not being updated for CTAS queries. (Robert Surowka via Ning Zhang)\n\nnzhang : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1200744\nFiles : \n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java\n* /hive/trunk/ql/src/test/queries/clientpositive/ctas.q\n* /hive/trunk/ql/src/test/queries/clientpositive/merge3.q\n* /hive/trunk/ql/src/test/results/clientpositive/ctas.q.out\n* /hive/trunk/ql/src/test/results/clientpositive/database.q.out\n* /hive/trunk/ql/src/test/results/clientpositive/merge3.q.out\n* /hive/trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out\n* /hive/trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-11T11:01:45.498+0000","updated":"2011-11-11T11:01:45.498+0000"}],"maxResults":15,"total":15,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-2472/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i00x4v:"}}