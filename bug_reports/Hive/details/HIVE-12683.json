{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12922144","self":"https://issues.apache.org/jira/rest/api/2/issue/12922144","key":"HIVE-12683","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-12-15T22:18:30.627+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Dec 16 18:52:38 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-12683/watchers","watchCount":3,"isWatching":false},"created":"2015-12-15T21:39:09.789+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-12-16T18:52:38.307+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"We have started to look into testing tez query engine. From initial results, we are getting 30% performance boost over Hive on smaller data set(1-10 GB) but Hive starts to perform better than Tez as data size increases. Like when we run a hive query with Tez on about 2.3 TB worth of data, it performs worse than hive alone.(~20% less performance) Details are in the post below.\n\nOn a cluster with 1.3 TB RAM, I set the following property :\n\nset tez.task.resource.memory.mb=10000; set tez.am.resource.memory.mb=59205; set tez.am.launch.cmd-opts =-Xmx47364m; set hive.tez.container.size=59205; set hive.tez.java.opts=-Xmx47364m; set tez.am.grouping.max-size=36700160000;\n\nIs it normal or I am missing some property / not configuring some property properly? Also, I am using an older version of Tez as of now. Could that be the issue too? I still have to bootstrap latest version of Tez on EMR and test it and see if that could do any better.\n\nThought of asking here too\n\nhttp://www.jwplayer.com/blog/hive-with-tez-on-emr/","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Does Tez run slower than hive on larger dataset (~2.5 TB)?","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15058961","id":"15058961","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"body":"Moving this jira to Hive for now. It will be good to start the discussion there as this pertains to Hive regardless of whether it uses MR or Tez as its internal execution engine. \n\nFWIW, issues such as this are usually better off being raised on the Hive user mailing list for discussion/analysis and a bug created later based on the findings. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-12-15T22:18:30.627+0000","updated":"2015-12-15T22:18:30.627+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15058963","id":"15058963","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"body":"\\cc [~hagleitn] [~gopalv]\n\n[~rohitgarg1989] Can you attach the yarn application logs for the query that was slow. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-12-15T22:19:31.599+0000","updated":"2015-12-15T22:19:31.599+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15058967","id":"15058967","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"body":"Additional info such as the query text as well as the explain would be useful. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-12-15T22:22:01.643+0000","updated":"2015-12-15T22:22:01.643+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15058968","id":"15058968","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"body":"Nevermind - just noticed that the query text is on the blog. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-12-15T22:22:48.451+0000","updated":"2015-12-15T22:22:48.451+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15058972","id":"15058972","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for the reply Hitesh. I didn't save the logs but I will re-launch EMR cluster and re-run the application and provide you with logs ASAP.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-15T22:23:43.384+0000","updated":"2015-12-15T22:23:43.384+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15058975","id":"15058975","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"body":"ohh yes the query is there","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-15T22:24:05.783+0000","updated":"2015-12-15T22:24:05.783+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15058980","id":"15058980","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"From your blog - are you using 59Gb Tez containers?\n\nset hive.tez.container.size=59205;","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-12-15T22:25:39.930+0000","updated":"2015-12-15T22:25:39.930+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15058999","id":"15058999","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"body":"I tried lot of different settings. This was one of them and which worked. It came from the below formulas. Not sure if thats the right way to estimate it.\n\nWe used the following formulae to guide us in determining YARN and MapReduce memory configurations:\n\nNumber of containers =  min (2 * cores, 1.8 * disks, (Total available RAM) / min_container_size)\nReserved Memory = Memory for stack memory\nTotal available RAM = Total RAM of the cluster – Reserved Memory\nDisks = Number of data disks per machine\nmin_container_size = Minimum container size (in RAM). Its value is dependent on RAM available\nRAM-per-container = max(min_container_size, (Total Available RAM) / containers)\n\nFor example, for our cluster, we had 32 CPU cores, 244 GB RAM, and 2 disks per node.\n\nReserved Memory = 38 GB\nContainer Size = 2 GB\nAvailable RAM = (244-38) GB = 206 GB\nNumber of containers = min (2*32, 1.8* 2, 206/2) = min (64,3.6, 103) = ~4\nRAM-per-container = max (2, 206/4) = max (2, 51.5) = ~52 GB\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-15T22:32:48.202+0000","updated":"2015-12-15T22:32:48.202+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15059023","id":"15059023","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"Pretty sure all of that math is for 10k RPM disks - SSDs don't exactly follow the same rules.\n\nFor r3.8xl, my recommendation from measurement was 24 containers x 8 Gb containers for optimum performance.\n\nEMR's default configs for Hive might not be the best for Tez, you might want to reconfigure hive-site.xml based on the Ambari default install instead.\n\nSomething like your Test 2 might be OOM'ing due to lack of S3 file closures - instead of increasing the memory Xmx so high, you might want to turn on the scalable partitioned insert from HIVE-6455.\n\nMost of what you describe here isn't necessarily a bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-12-15T22:43:54.083+0000","updated":"2015-12-15T22:43:54.083+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15059037","id":"15059037","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"body":"For SSDs, you should be able to run a few more containers per node. Maybe try with say 8 containers sized to 20 GB each ( Xmx 16G ) as a start. \n\nAlso, you may want to try the large group-by query with \"hive.map.aggr\" set to false to help with the OOMs. \n\n\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-12-15T22:48:25.416+0000","updated":"2015-12-15T22:48:25.416+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15060175","id":"15060175","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for your inputs. I will try these changes and see if that would give me any performance boost over hive query engine.\n\nThis was the OOM error I was getting before I tweaked memory settings :\n\n0 FATAL [Socket Reader #1 for port 55739] org.apache.hadoop.yarn.YarnUncaughtExceptionHandler: Thread Thread[Socket Reader #1 for port 55739,5,main] threw an Error.  Shutting down now...\njava.lang.OutOfMemoryError: GC overhead limit exceeded\n\tat java.nio.ByteBuffer.allocate(ByteBuffer.java:331)\n\tat org.apache.hadoop.ipc.Server$Connection.readAndProcess(Server.java:1510)\n\tat org.apache.hadoop.ipc.Server$Listener.doRead(Server.java:750)\n\tat org.apache.hadoop.ipc.Server$Listener$Reader.doRunLoop(Server.java:624)\n\tat org.apache.hadoop.ipc.Server$Listener$Reader.run(Server.java:595)\n2015-12-07 20:31:32,859 FATAL [AsyncDispatcher event handler] org.apache.hadoop.yarn.event.AsyncDispatcher: Error in dispatcher thread\njava.lang.OutOfMemoryError: GC overhead limit exceeded\n2015-12-07 20:31:30,590 WARN [IPC Server handler 0 on 55739] org.apache.hadoop.ipc.Server: IPC Server handler 0 on 55739, call heartbeat({  containerId=container_1449516549171_0001_01_000100, requestId=10184, startIndex=0, maxEventsToGet=0, taskAttemptId=null, eventCount=0 }), rpc version=2, client version=19, methodsFingerPrint=557389974 from 10.10.30.35:47028 Call#11165 Retry#0: error: java.lang.OutOfMemoryError: GC overhead limit exceeded\njava.lang.OutOfMemoryError: GC overhead limit exceeded\n\tat javax.security.auth.SubjectDomainCombiner.optimize(SubjectDomainCombiner.java:464)\n\tat javax.security.auth.SubjectDomainCombiner.combine(SubjectDomainCombiner.java:267)\n\tat java.security.AccessControlContext.goCombiner(AccessControlContext.java:499)\n\tat java.security.AccessControlContext.optimize(AccessControlContext.java:407)\n\tat java.security.AccessController.getContext(AccessController.java:501)\n\tat javax.security.auth.Subject.doAs(Subject.java:412)\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1548)\n\tat org.apache.hadoop.ipc.Server$Handler.run(Server.java:2007)\n2015-12-07 20:32:53,495 INFO [Thread-60] amazon.emr.metrics.MetricsSaver: Saved 4:3 records to /mnt/var/em/raw/i-782f08c8_20151207_7921_07921_raw.bin\n2015-12-07 20:32:53,495 INFO [AsyncDispatcher event handler] org.apache.hadoop.yarn.event.AsyncDispatcher: Exiting, bbye..\n2015-12-07 20:32:50,435 INFO [IPC Server handler 20 on 55739] org.apache.hadoop.ipc.Server: IPC Server handler 20 on 55739, call getTask(org.apache.tez.common.ContainerContext@409a6aa9), rpc version=2, client version=19, methodsFingerPrint=557389974 from 10.10.30.33:33644 Call#11094 Retry#0: error: java.io.IOException: java.lang.OutOfMemoryError: GC overhead limit exceeded\njava.io.IOException: java.lang.OutOfMemoryError: GC overhead limit exceeded\n2015-12-07 20:32:29,117 WARN [IPC Server handler 23 on 55739] org.apache.hadoop.ipc.Server: IPC Server handler 23 on 55739, call getTask(org.apache.tez.common.ContainerContext@7c7e6992), rpc version=2, client version=19, methodsFingerPrint=557389974 from 10.10.30.38:44218 Call#11260 Retry#0: error: java.lang.OutOfMemoryError: GC overhead limit exceeded\njava.lang.OutOfMemoryError: GC overhead limit exceeded\n2015-12-07 20:32:53,497 INFO [Thread-60] amazon.emr.metrics.MetricsSaver: Saved 1:1 records to /mnt/var/em/raw/i-782f08c8_20151207_7921_07921_raw.bin\n2015-12-07 20:32:53,498 INFO [Thread-61] amazon.emr.metrics.MetricsSaver: Saved 1:1 records to /mnt/var/em/raw/i-782f08c8_20151207_7921_07921_raw.bin\n2015-12-07 20:32:53,498 INFO [Thread-2] org.apache.tez.dag.app.DAGAppMaster: DAGAppMaster received a signal. Signaling TaskScheduler\n2015-12-07 20:32:53,498 INFO [Thread-2] org.apache.tez.dag.app.rm.TaskSchedulerEventHandler: TaskScheduler notified that iSignalled was : true\n2015-12-07 20:32:53,499 INFO [Thread-2] org.apache.tez.dag.history.HistoryEventHandler: Stopping HistoryEventHandler\n2015-12-07 20:32:53,499 INFO [Thread-2] org.apache.tez.dag.history.recovery.RecoveryService: Stopping RecoveryService\n2015-12-07 20:32:53,499 INFO [Thread-2] org.apache.tez.dag.history.recovery.RecoveryService: Closing Summary Stream\n2015-12-07 20:32:53,499 INFO [LeaseRenewer:hadoop@10.10.30.148:9000] org.apache.hadoop.util.ExitUtil: Halt with status -1 Message: HaltException","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-16T15:43:55.237+0000","updated":"2015-12-16T15:43:55.237+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15060179","id":"15060179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"body":"I will update here with the results.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-16T15:44:53.128+0000","updated":"2015-12-16T15:44:53.128+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15060302","id":"15060302","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"body":"It seems like the application master is running out of memory. What is the Tez AM being configured for in terms of memory and Xmx?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-12-16T17:04:00.916+0000","updated":"2015-12-16T17:04:00.916+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15060337","id":"15060337","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"body":"yeah...it was application master..we read somewhere Tez AM memory and Xmx settings should be same as tez container. So, in one of our tests and which ran (as mentioned in the blog), we did\n\nset tez.am.resource.memory.mb=59205;\nset tez.am.launch.cmd-opts =-Xmx47364m;\n\nWe were tweaking the following properties mainly :\n\nset tez.task.resource.memory.mb\nset tez.am.resource.memory.mb\nset tez.am.launch.cmd-opts \nset hive.tez.container.size\nset hive.tez.java.opts\nset tez.am.grouping.max-size","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-16T17:17:59.534+0000","updated":"2015-12-16T17:17:59.534+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15060465","id":"15060465","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"body":"The Tez AM resource sizing has no relation to the task container sizing. That said, for various benchmarks done in the past, I dont believe anyone has needed to go beyond 16GB for the Tez AM for very large DAGs.\n\n[~rohitgarg1989] What was the AM size configured to when the OOM happened? If you are running a version older than Tez 0.7.0, there were some memory issues that require a large AM size i.e. large being say 16 GB but for 0.7.0 and higher, even 4 GB should be sufficient for a decent sized DAG. You can set it to 8 GB to be safe for now with Xmx say 6.4 GB and that should be sufficient. If you still hit an OOM with 8 GB, a jira against Tez with the heap dump would be helpful. \n\n[~gopalv] anything to add? any configs that need to be tuned / turned off for Hive that ends up using more memory in the AM? Any implicit caching of splits, etc?  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitesh","name":"hitesh","key":"hitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitesh Shah","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-12-16T18:25:35.483+0000","updated":"2015-12-16T18:25:35.483+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15060484","id":"15060484","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"body":"Thanks Hitesh for the inputs. I am going to try the recommended settings and update the results here. The AM size was 1024MB. I was just using the bootstrap script provided by Amazon for initial testing. They had an older version of Tez (I think 0.4 or 0.5).\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rohitgarg1989","name":"rohitgarg1989","key":"rohitgarg1989","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rohit garg","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-16T18:33:57.150+0000","updated":"2015-12-16T18:33:57.150+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12922144/comment/15060525","id":"15060525","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"The known 0.4.x OOMs were during split-generation for uncompressed text files (HIVE-10746) or when combine inputformat is used on S3 (HADOOP-11584).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-12-16T18:52:38.307+0000","updated":"2015-12-16T18:52:38.307+0000"}],"maxResults":17,"total":17,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-12683/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2pxtz:"}}