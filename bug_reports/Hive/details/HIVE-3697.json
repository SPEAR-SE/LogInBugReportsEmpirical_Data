{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12615496","self":"https://issues.apache.org/jira/rest/api/2/issue/12615496","key":"HIVE-3697","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323587","id":"12323587","description":"Hive 0.11.0","name":"0.11.0","archived":false,"released":true,"releaseDate":"2013-05-15"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-11-11T20:36:54.115+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jan 07 17:40:49 UTC 2013","customfield_12310420":"256784","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_5104601254_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-01-07T17:40:49.394+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-3697/watchers","watchCount":3,"isWatching":false},"created":"2012-11-09T15:44:08.188+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317742","id":"12317742","description":"released","name":"0.9.0","archived":false,"released":true,"releaseDate":"2012-04-30"}],"issuelinks":[{"id":"12360129","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12360129","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12606227","key":"HIVE-3431","self":"https://issues.apache.org/jira/rest/api/2/issue/12606227","fields":{"summary":"Avoid race conditions while downloading resources from non-local filesystem","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/5","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/trivial.svg","name":"Trivial","id":"5"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-16T21:10:40.457+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"I've seen situations where utilizing JAR files on HDFS can cause job failures via CNFE or JVM crashes. \n\nThis is difficult to replicate, seems to be related to JAR size, latency between client and HDFS cluster, but I've got some example stack traces below. Seems that the calls made to FileSystem (copyToLocal) which are static and will be executed to delete the current local copy can cause the file(s) to be removed during job processing.\n\nWe should consider changing the default for hive.downloaded.resources.dir to include some level of uniqueness per job. We should not consider hive.session.id however, as execution of multiple statements via the same user/session which might access the same JAR files will utilize the same session.\n\nA proposal might be to utilize System.nanoTime() -- which might be enough to avoid the issue, although it's not perfect (depends on JVM and system for level of precision) as part of the default (/tmp/${user.name}/resources/System.nanoTime()/). \n\nIf anyone else has hit this, would like to capture environment information as well. Perhaps there is something else at play here. \n\nHere are some examples of the errors:\n\nfor i in {0..2}; do hive -S -f query.q& done\n[2] 48405\n[3] 48406\n[4] 48407\n% #\n# A fatal error has been detected by the Java Runtime Environment:\n#\n#  SIGBUS (0x7) at pc=0x00007fb10bd931f0, pid=48407, tid=140398456698624\n#\n# JRE version: 6.0_31-b04\n# Java VM: Java HotSpot(TM) 64-Bit Server VM (20.6-b01 mixed mode linux-amd64 compressed oops)\n# Problematic frame:\n# C  [libzip.so+0xb1f0]  __int128+0x60\n#\n# An error report file with more information is saved as:\n# /home/.../hs_err_pid48407.log\n#\n# If you would like to submit a bug report, please visit:\n#   http://java.sun.com/webapps/bugreport/crash.jsp\n# The crash happened outside the Java Virtual Machine in native code.\n# See problematic frame for where to report the bug.\n#\njava.lang.NoClassDefFoundError: com/example/udf/Lower\n        at java.lang.Class.forName0(Native Method)\n        at java.lang.Class.forName(Class.java:247)\n        at org.apache.hadoop.hive.ql.exec.FunctionTask.getUdfClass(FunctionTask.java:105)\n        at org.apache.hadoop.hive.ql.exec.FunctionTask.createFunction(FunctionTask.java:75)\n        at org.apache.hadoop.hive.ql.exec.FunctionTask.execute(FunctionTask.java:63)\n        at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:153)\n        at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:57)\n        at org.apache.hadoop.hive.ql.Driver.launchTask(Driver.java:1331)\n        at org.apache.hadoop.hive.ql.Driver.execute(Driver.java:1117)\n        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:950)\n        at org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:258)\n        at org.apache.hadoop.hive.cli.CliDriver.processCmd(CliDriver.java:215)\n        at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:406)\n        at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:341)\n        at org.apache.hadoop.hive.cli.CliDriver.processReader(CliDriver.java:439)\n        at org.apache.hadoop.hive.cli.CliDriver.processFile(CliDriver.java:449)\n        at org.apache.hadoop.hive.cli.CliDriver.processInitFiles(CliDriver.java:485)\n        at org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:692)\n        at org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:607)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.hadoop.util.RunJar.main(RunJar.java:208)\nCaused by: java.lang.ClassNotFoundException: com.example.udf.Lower\n        at java.net.URLClassLoader$1.run(URLClassLoader.java:202)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at java.net.URLClassLoader.findClass(URLClassLoader.java:190)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:306)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:247)\n        ... 24 more\nFAILED: Execution Error, return code -101 from org.apache.hadoop.hive.ql.exec.FunctionTask\n\nAnother:\nfor i in {0..2}; do hive -S -f query.q& done\n[1] 16294 \n[2] 16295 \n[3] 16296 \n[]$ Couldn't create directory /tmp/ctm/resources/\nCouldn't create directory /tmp/ctm/resources/","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"107479","customfield_12312823":null,"summary":"External JAR files on HDFS can lead to race condition with hive.downloaded.resources.dir","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctm","name":"ctm","key":"ctm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris McConnell","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctm","name":"ctm","key":"ctm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris McConnell","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12615496/comment/13494986","id":"13494986","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joecrobak","name":"joecrobak","key":"joecrobak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Crobak","active":true,"timeZone":"America/New_York"},"body":"We've seen this to. Our workaround is a shell script that looks something like this:\n\n{code}\nTMP_DIR=/tmp/hive-$$\nmkdir -p $TMP_DIR\nHADOOP_CLIENT_OPTS=\"-Dhive.downloaded.resources.dir=$TMP_DIR\"\nhive $@\nrc=$?\nrm -r $TMP_DIR\nexit $rc\n{code}\n\nThis solution eliminates the problem in our case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joecrobak","name":"joecrobak","key":"joecrobak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Crobak","active":true,"timeZone":"America/New_York"},"created":"2012-11-11T20:36:54.115+0000","updated":"2012-11-11T20:36:54.115+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12615496/comment/13495261","id":"13495261","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctm","name":"ctm","key":"ctm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris McConnell","active":true,"timeZone":"Etc/UTC"},"body":"Hey Joe,\n\nThanks for the work around, seems to work well for me also. I'll look into the possibility of changing the parent directory as well within the HiveConf to do something similar. \n\nCheers,\nChris","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctm","name":"ctm","key":"ctm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris McConnell","active":true,"timeZone":"Etc/UTC"},"created":"2012-11-12T13:46:15.975+0000","updated":"2012-11-12T13:46:15.975+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12615496/comment/13546083","id":"13546083","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"HIVE-3431 should fix this issue. Please reopen if you find otherwise.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-01-07T17:40:49.419+0000","updated":"2013-01-07T17:40:49.419+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-3697/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ir2f:"}}