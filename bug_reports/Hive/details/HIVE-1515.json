{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12470960","self":"https://issues.apache.org/jira/rest/api/2/issue/12470960","key":"HIVE-1515","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2010-08-10T01:11:19.322+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Aug 13 01:10:21 UTC 2010","customfield_12310420":"42464","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-1515/watchers","watchCount":2,"isWatching":false},"created":"2010-08-06T05:56:53.223+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315150","id":"12315150","description":"released","name":"0.7.0","archived":false,"released":true,"releaseDate":"2011-03-29"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-08-13T01:10:55.726+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"set hive.exec.compress.output = true;\nset hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;\nset mapred.min.split.size=256;\nset mapred.min.split.size.per.node=256;\nset mapred.min.split.size.per.rack=256;\nset mapred.max.split.size=256;\n\nset hive.archive.enabled = true;\n\ndrop table combine_3_srcpart_seq_rc;\n\ncreate table combine_3_srcpart_seq_rc (key int , value string) partitioned by (ds string, hr string) stored as sequencefile;\n\ninsert overwrite table combine_3_srcpart_seq_rc partition (ds=\"2010-08-03\", hr=\"00\") select * from src;\n\ninsert overwrite table combine_3_srcpart_seq_rc partition (ds=\"2010-08-03\", hr=\"001\") select * from src;\n\nALTER TABLE combine_3_srcpart_seq_rc ARCHIVE PARTITION (ds=\"2010-08-03\", hr=\"00\");\nALTER TABLE combine_3_srcpart_seq_rc ARCHIVE PARTITION (ds=\"2010-08-03\", hr=\"001\");\n\nselect key, value, ds, hr from combine_3_srcpart_seq_rc where ds=\"2010-08-03\" order by key, hr limit 30;\n\ndrop table combine_3_srcpart_seq_rc;\n\n\nwill fail.\n\njava.io.IOException: Invalid file name: har:/data/users/heyongqiang/hive-trunk-clean/build/ql/test/data/warehouse/combine_3_srcpart_seq_rc/ds=2010-08-03/hr=001/data.har/data/users/heyongqiang/hive-trunk-clean/build/ql/test/data/warehouse/combine_3_srcpart_seq_rc/ds=2010-08-03/hr=001 in har:/data/users/heyongqiang/hive-trunk-clean/build/ql/test/data/warehouse/combine_3_srcpart_seq_rc/ds=2010-08-03/hr=00/data.har\n\nThe reason it fails is because:\nthere are 2 input paths (one for each partition) for the above query:\n1): har:/Users/heyongqiang/Documents/workspace/Hive-Index/build/ql/test/data/warehouse/combine_3_srcpart_seq_rc/ds=2010-08-03/hr=00/data.har/Users/heyongqiang/Documents/workspace/Hive-Index/build/ql/test/data/warehouse/combine_3_srcpart_seq_rc/ds=2010-08-03/hr=00\n2): har:/Users/heyongqiang/Documents/workspace/Hive-Index/build/ql/test/data/warehouse/combine_3_srcpart_seq_rc/ds=2010-08-03/hr=001/data.har/Users/heyongqiang/Documents/workspace/Hive-Index/build/ql/test/data/warehouse/combine_3_srcpart_seq_rc/ds=2010-08-03/hr=001\nBut when doing path.getFileSystem() for these 2 input paths. they both return same one file system instance which points the first caller, in this case which is har:/Users/heyongqiang/Documents/workspace/Hive-Index/build/ql/test/data/warehouse/combine_3_srcpart_seq_rc/ds=2010-08-03/hr=00/data.har\n\nThe reason here is Hadoop's FileSystem has a global cache, and when trying to load a FileSystem instance from a given path, it only take the path's scheme and username to lookup the cache. So when we do Path.getFileSystem for the second har path, it actually returns the file system handle for the first path.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12451450","id":"12451450","filename":"hive-1515.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=he+yongqiang","name":"he yongqiang","key":"he yongqiang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"He Yongqiang","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-06T18:41:03.540+0000","size":10293,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12451450/hive-1515.1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12451974","id":"12451974","filename":"hive-1515.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=he+yongqiang","name":"he yongqiang","key":"he yongqiang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"He Yongqiang","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-13T01:10:20.979+0000","size":7184,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12451974/hive-1515.2.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"123156","customfield_12312823":null,"summary":"archive is not working when multiple partitions inside one table are archived.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=he+yongqiang","name":"he yongqiang","key":"he yongqiang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"He Yongqiang","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=he+yongqiang","name":"he yongqiang","key":"he yongqiang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"He Yongqiang","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12470960/comment/12896755","id":"12896755","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hbasereviewboard","name":"hbasereviewboard","key":"hbasereviewboard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"HBase Review Board","active":true,"timeZone":"Etc/UTC"},"body":"Message from: \"Yongqiang He\" <heyongqiangict@gmail.com>\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttp://review.cloudera.org/r/598/\n-----------------------------------------------------------\n\nReview request for Hive Developers.\n\n\nSummary\n-------\n\narchive is not working when multiple partitions inside one table are archived.\n\n\nThis addresses bug hive-1515.\n    http://issues.apache.org/jira/browse/hive-1515\n\n\nDiffs\n-----\n\n  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/DDLTask.java 982490 \n  trunk/ql/src/test/queries/clientpositive/archive_2.q PRE-CREATION \n  trunk/ql/src/test/results/clientpositive/archive_2.q.out PRE-CREATION \n\nDiff: http://review.cloudera.org/r/598/diff\n\n\nTesting\n-------\n\n\nThanks,\n\nYongqiang\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hbasereviewboard","name":"hbasereviewboard","key":"hbasereviewboard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"HBase Review Board","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-10T01:11:19.322+0000","updated":"2010-08-10T01:11:19.322+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12470960/comment/12897533","id":"12897533","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pauly","name":"pauly","key":"pauly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Paul Yang","active":true,"timeZone":"America/Los_Angeles"},"body":"See comments on reviewboard.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pauly","name":"pauly","key":"pauly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Paul Yang","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-08-12T01:09:37.356+0000","updated":"2010-08-12T01:09:37.356+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12470960/comment/12897537","id":"12897537","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hbasereviewboard","name":"hbasereviewboard","key":"hbasereviewboard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"HBase Review Board","active":true,"timeZone":"Etc/UTC"},"body":"Message from: \"Paul Yang\" <pyang@facebook.com>\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttp://review.cloudera.org/r/598/#review853\n-----------------------------------------------------------\n\n\nTalked to Yongqiang offline about this one. The way that this patch attempts to fix the caching issue is to append some path information to the host so that we create a new HAR filesystem instance for different HAR files. The way that this is implemented now, a \"-\" and path information in added to the host e.g. har://hdfs-localhost-user--warehouse--mytable:50030... if the original were har://hdfs-localhost:50030. However, the HAR filesystem does not ignore the stuff after the second \"-\" and so has errors when trying to connect to the underlying filesystem. A possible fix would be to modify HiveHarFileSystem to extend the initialize() method so that the characters after the second \"-\" is ignored.\n\n- Paul\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hbasereviewboard","name":"hbasereviewboard","key":"hbasereviewboard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"HBase Review Board","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-12T01:20:25.921+0000","updated":"2010-08-12T01:20:25.921+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12470960/comment/12898028","id":"12898028","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=he+yongqiang","name":"he yongqiang","key":"he yongqiang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"He Yongqiang","active":true,"timeZone":"Etc/UTC"},"body":"Attache a possible fix.\n\nTalked with Namit and Paul this afternoon about this issue. Actually there is config which can disable FileSystem cache: fs.%s.impl.disable.cache . where %s is the filesystem schema, for archive, it's har.\n\nSo if you set \"fs.har.impl.disable.cache\" to false, the archive will automatically work. This should be the clean way to fix this issue.\nIn order to do this, you need to apply https://issues.apache.org/jira/browse/HADOOP-6231 if your hadoop does not include the code to disable FileSystem cache.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=he+yongqiang","name":"he yongqiang","key":"he yongqiang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"He Yongqiang","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-13T01:10:21.057+0000","updated":"2010-08-13T01:10:21.057+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-1515/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0lfgv:"}}