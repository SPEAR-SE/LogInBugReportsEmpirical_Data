{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13093476","self":"https://issues.apache.org/jira/rest/api/2/issue/13093476","key":"HIVE-17280","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340268","id":"12340268","name":"3.0.0","archived":false,"released":true,"releaseDate":"2018-05-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12340338","id":"12340338","name":"2.4.0","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/11","id":"11","description":"","name":"Done"},"customfield_12312322":null,"customfield_12310220":"2017-08-29T17:58:45.595+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue May 22 23:59:03 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2876223173_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-09-11T20:22:39.463+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17280/watchers","watchCount":5,"isWatching":false},"created":"2017-08-09T13:25:36.346+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12332384","id":"12332384","name":"1.2.1","archived":false,"released":true,"releaseDate":"2015-06-26"}],"issuelinks":[{"id":"12515041","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12515041","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"13098144","key":"HIVE-17403","self":"https://issues.apache.org/jira/rest/api/2/issue/13098144","fields":{"summary":"Fail concatenation for unmanaged and transactional tables","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-22T23:59:03.382+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325007","id":"12325007","name":"Hive"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12323200","id":"12323200","name":"Spark","description":"Hive on Spark"}],"timeoriginalestimate":null,"description":"Hive concatenation causes data loss if the ORC files in the table were written by Spark.\n\nHere are the steps to reproduce the problem:\n - create a table;\n{code:java}\nhive\nhive> create table aa (a string, b int) stored as orc;\n{code}\n - insert 2 rows using Spark;\n{code:java}\nspark-shell\nscala> case class AA(a:String, b:Int)\nscala> val df = sc.parallelize(Array(AA(\"b\",2),AA(\"c\",3) )).toDF\nscala> df.write.insertInto(\"aa\")\n{code}\n - change table schema;\n{code:java}\nhive\nhive> alter table aa add columns(aa string, bb int);\n{code}\n - insert other 2 rows with Spark\n{code:java}\nspark-shell\nscala> case class BB(a:String, b:Int, aa:String, bb:Int)\nscala> val df = sc.parallelize(Array(BB(\"b\",2,\"b\",2),BB(\"c\",3,\"c\",3) )).toDF\nscala> df.write.insertInto(\"aa\")\n{code}\n - at this point, running a select statement with Hive returns correctly *4 rows* in the table; then run the concatenation\n{code:java}\nhive\nhive> alter table aa concatenate;\n{code}\n\n\nAt this point, a select returns only *3 rows, ie. a row is missing*.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Data loss in CONCATENATE ORC created by Spark","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaido","name":"mgaido","key":"mgaido","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgaido&avatarId=34522","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgaido&avatarId=34522","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgaido&avatarId=34522","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgaido&avatarId=34522"},"displayName":"Marco Gaido","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaido","name":"mgaido","key":"mgaido","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgaido&avatarId=34522","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgaido&avatarId=34522","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgaido&avatarId=34522","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgaido&avatarId=34522"},"displayName":"Marco Gaido","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Spark 1.6.3","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13093476/comment/16145785","id":"16145785","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanth_j","name":"prasanth_j","key":"prasanth_j","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Jayachandran","active":true,"timeZone":"America/Los_Angeles"},"body":"Do you happen to know the filenames generated by spark? \nHive has some assumptions around filenames when moving the files from staging to final target directory. Recently encountered similar issue (HIVE-17403) which could be related to this as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanth_j","name":"prasanth_j","key":"prasanth_j","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Jayachandran","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-29T17:58:45.595+0000","updated":"2017-08-29T17:58:45.595+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13093476/comment/16146882","id":"16146882","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaido","name":"mgaido","key":"mgaido","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgaido&avatarId=34522","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgaido&avatarId=34522","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgaido&avatarId=34522","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgaido&avatarId=34522"},"displayName":"Marco Gaido","active":true,"timeZone":"Etc/UTC"},"body":"The names of the files are:\n\n{noformat}\n/apps/hive/warehouse/aa/part-00000\n/apps/hive/warehouse/aa/part-00000_copy_1\n/apps/hive/warehouse/aa/part-00001\n/apps/hive/warehouse/aa/part-00001_copy_1\n/apps/hive/warehouse/aa/part-00001_copy_2\n/apps/hive/warehouse/aa/part-00002\n/apps/hive/warehouse/aa/part-00002_copy_1\n/apps/hive/warehouse/aa/part-00003\n/apps/hive/warehouse/aa/part-00003_copy_1\n{noformat}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaido","name":"mgaido","key":"mgaido","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgaido&avatarId=34522","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgaido&avatarId=34522","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgaido&avatarId=34522","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgaido&avatarId=34522"},"displayName":"Marco Gaido","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-30T08:28:36.203+0000","updated":"2017-08-30T08:28:36.203+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13093476/comment/16146914","id":"16146914","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanth_j","name":"prasanth_j","key":"prasanth_j","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Jayachandran","active":true,"timeZone":"America/Los_Angeles"},"body":"That is certainly not the format that hive expects. After concatenation, merged and unmerged (incompatible) files gets moved to a staging directory. Then MoveTask moves the files from staging directory to final destination directory (which is also the source directory in case of concatenation). There are certain assumptions around filenames for bucketing, speculative execution etc. in move task. In the example files that you had provided, part-00000_copy_1 and part-00001_copy_1 will be considered same file written by different tasks (from speculative execution) and the largest file will be picked as the winner of speculated execution. This is the same issue as HIVE-17403. Hive usually writes files with format 000000_0 where 000000 is task id/bucket id and digit after _  is considered a task attempt. I am working on a patch that will restrict concatenation for external tables. And for hive managed tables, load data command will make sure the filenames conform to Hive's expectation. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanth_j","name":"prasanth_j","key":"prasanth_j","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Jayachandran","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-30T08:52:28.940+0000","updated":"2017-08-30T08:52:28.940+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13093476/comment/16146933","id":"16146933","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaido","name":"mgaido","key":"mgaido","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgaido&avatarId=34522","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgaido&avatarId=34522","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgaido&avatarId=34522","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgaido&avatarId=34522"},"displayName":"Marco Gaido","active":true,"timeZone":"Etc/UTC"},"body":"I see, but this won't fix the problem with files written by Spark. This is the way Spark names files to managed tables. Thus the issue will still be there.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaido","name":"mgaido","key":"mgaido","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgaido&avatarId=34522","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgaido&avatarId=34522","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgaido&avatarId=34522","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgaido&avatarId=34522"},"displayName":"Marco Gaido","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-30T09:15:19.261+0000","updated":"2017-08-30T09:15:19.261+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13093476/comment/16154377","id":"16154377","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanth_j","name":"prasanth_j","key":"prasanth_j","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Jayachandran","active":true,"timeZone":"America/Los_Angeles"},"body":"[~mgaido] Posted a patch to HIVE-17403 that will fix the issue (along with adding restrictions). Tested this locally and it worked. If concatenation finds incompatible file, it will rename to Hive's convention to avoid the issue that I mentioned above. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanth_j","name":"prasanth_j","key":"prasanth_j","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Jayachandran","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-09-05T21:50:09.058+0000","updated":"2017-09-05T21:55:57.013+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13093476/comment/16161922","id":"16161922","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanth_j","name":"prasanth_j","key":"prasanth_j","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Jayachandran","active":true,"timeZone":"America/Los_Angeles"},"body":"Fix for this got committed via HIVE-17403. Closing this as done.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanth_j","name":"prasanth_j","key":"prasanth_j","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Jayachandran","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-09-11T20:22:39.498+0000","updated":"2017-09-11T20:22:39.498+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13093476/comment/16486088","id":"16486088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vgarg","name":"vgarg","key":"vgarg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=vgarg&avatarId=30430","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=vgarg&avatarId=30430","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=vgarg&avatarId=30430","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=vgarg&avatarId=30430"},"displayName":"Vineet Garg","active":true,"timeZone":"America/Los_Angeles"},"body":"Hive 3.0.0 has been released so closing this jira.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vgarg","name":"vgarg","key":"vgarg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=vgarg&avatarId=30430","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=vgarg&avatarId=30430","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=vgarg&avatarId=30430","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=vgarg&avatarId=30430"},"displayName":"Vineet Garg","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-22T23:59:03.379+0000","updated":"2018-05-22T23:59:03.379+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17280/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3ild3:"}}