{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13179310","self":"https://issues.apache.org/jira/rest/api/2/issue/13179310","key":"HIVE-20401","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-08-16T14:57:21.074+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Aug 17 17:49:20 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-20401/watchers","watchCount":4,"isWatching":false},"created":"2018-08-16T09:29:05.071+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12332952","id":"12332952","description":"branch-1.2 HEAD","name":"1.2.2","archived":false,"released":true,"releaseDate":"2017-04-06"}],"issuelinks":[{"id":"12541155","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12541155","type":{"id":"12310051","name":"Supercedes","inward":"is superceded by","outward":"supercedes","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310051"},"inwardIssue":{"id":"12639490","key":"HIVE-4239","self":"https://issues.apache.org/jira/rest/api/2/issue/12639490","fields":{"summary":"Remove lock on compilation stage","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-08-17T17:49:20.103+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324409","id":"12324409","name":"Beeline"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12320408","id":"12320408","name":"HiveServer2","description":"Tracks issues related to HiveServer2"}],"timeoriginalestimate":null,"description":"HiveServer2  process often gets stuck , and jstack shows about one hundred thread is blocked at the following code,waiting the resource *0x00000003c0acca40*\r\n{code:java}\r\n\"HiveServer2-Handler-Pool: Thread-935985\" #935985 prio=5 os_prio=0 tid=0x00007fd71470c000 nid=0x3e1f waiting for monitor entry [0x00007fd6d6eee000]\r\n\tat org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:1144)\r\n\t- waiting to lock <0x00000003c0acca40> (a java.lang.Object)\r\n\tat org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:1139)\r\n\tat org.apache.hive.service.cli.operation.SQLOperation.prepare(SQLOperation.java:110)\r\n\tat org.apache.hive.service.cli.operation.SQLOperation.runInternal(SQLOperation.java:181)\r\n\tat org.apache.hive.service.cli.operation.Operation.run(Operation.java:257)\r\n\tat org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementInternal(HiveSessionImpl.java:423)\r\n\tat org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementAsync(HiveSessionImpl.java:410)\r\n\tat sun.reflect.GeneratedMethodAccessor199.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.apache.hive.service.cli.session.HiveSessionProxy.invoke(HiveSessionProxy.java:78)\r\n\tat org.apache.hive.service.cli.session.HiveSessionProxy.access$000(HiveSessionProxy.java:36)\r\n\tat org.apache.hive.service.cli.session.HiveSessionProxy$1.run(HiveSessionProxy.java:63)\r\n\tat java.security.AccessController.doPrivileged(Native Method)\r\n\tat javax.security.auth.Subject.doAs(Subject.java:422)\r\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1962)\r\n\tat org.apache.hive.service.cli.session.HiveSessionProxy.invoke(HiveSessionProxy.java:59)\r\n\tat com.sun.proxy.$Proxy22.executeStatementAsync(Unknown Source)\r\n\tat org.apache.hive.service.cli.CLIService.executeStatementAsync(CLIService.java:275)\r\n\tat org.apache.hive.service.cli.thrift.ThriftCLIService.ExecuteStatement(ThriftCLIService.java:492)\r\n\tat org.apache.hive.service.cli.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1313)\r\n\tat org.apache.hive.service.cli.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1298)\r\n\tat org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39)\r\n\tat org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39)\r\n\tat org.apache.hadoop.hive.thrift.HadoopThriftAuthBridge$Server$TUGIAssumingProcessor.process(HadoopThriftAuthBridge.java:698)\r\n\tat org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:285)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n{code}\r\n\r\n We find one thread locked the resource *0x00000003c0acca40*: ,and the jstack is as follow:\r\n{code:java}\r\n\"HiveServer2-Handler-Pool: Thread-809399\" #809399 prio=5 os_prio=0 tid=0x00007fd71433e000 nid=0x37c0 in Object.wait() [0x00007fd6d04b8000]\r\n   java.lang.Thread.State: WAITING (on object monitor)\r\n\tat java.lang.Object.wait(Native Method)\r\n\tat java.lang.Object.wait(Object.java:502)\r\n\tat org.apache.hadoop.util.concurrent.AsyncGet$Util.wait(AsyncGet.java:59)\r\n\tat org.apache.hadoop.ipc.Client.getRpcResponse(Client.java:1483)\r\n\t- locked <0x00000003d9ab5d80> (a org.apache.hadoop.ipc.Client$Call)\r\n\tat org.apache.hadoop.ipc.Client.call(Client.java:1441)\r\n\tat org.apache.hadoop.ipc.Client.call(Client.java:1351)\r\n\tat org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:235)\r\n\tat org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:116)\r\n\tat com.sun.proxy.$Proxy18.getEZForPath(Unknown Source)\r\n\tat org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.getEZForPath(ClientNamenodeProtocolTranslatorPB.java:1413)\r\n\tat sun.reflect.GeneratedMethodAccessor225.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:409)\r\n\tat org.apache.hadoop.io.retry.RetryInvocationHandler$Call.invokeMethod(RetryInvocationHandler.java:163)\r\n\tat org.apache.hadoop.io.retry.RetryInvocationHandler$Call.invoke(RetryInvocationHandler.java:155)\r\n\tat org.apache.hadoop.io.retry.RetryInvocationHandler$Call.invokeOnce(RetryInvocationHandler.java:95)\r\n\t- locked <0x00000003d9ab5dc8> (a org.apache.hadoop.io.retry.RetryInvocationHandler$Call)\r\n\tat org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:346)\r\n\tat com.sun.proxy.$Proxy19.getEZForPath(Unknown Source)\r\n\tat org.apache.hadoop.hdfs.DFSClient.getEZForPath(DFSClient.java:2810)\r\n\tat org.apache.hadoop.hdfs.DistributedFileSystem$51.doCall(DistributedFileSystem.java:2270)\r\n\tat org.apache.hadoop.hdfs.DistributedFileSystem$51.doCall(DistributedFileSystem.java:2267)\r\n\tat org.apache.hadoop.fs.FileSystemLinkResolver.resolve(FileSystemLinkResolver.java:81)\r\n\tat org.apache.hadoop.hdfs.DistributedFileSystem.getEZForPath(DistributedFileSystem.java:2286)\r\n\tat org.apache.hadoop.hdfs.client.HdfsAdmin.getEncryptionZoneForPath(HdfsAdmin.java:350)\r\n\tat org.apache.hadoop.hive.shims.Hadoop23Shims$HdfsEncryptionShim.isPathEncrypted(Hadoop23Shims.java:1221)\r\n\tat org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.isPathEncrypted(SemanticAnalyzer.java:1883)\r\n\tat org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.getStrongestEncryptedTablePath(SemanticAnalyzer.java:1964)\r\n\tat org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.getStagingDirectoryPathname(SemanticAnalyzer.java:1996)\r\n\tat org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.getMetaData(SemanticAnalyzer.java:1809)\r\n\tat org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.getMetaData(SemanticAnalyzer.java:1544)\r\n\tat org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genResolvedParseTree(SemanticAnalyzer.java:10076)\r\n\tat org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:10127)\r\n\tat org.apache.hadoop.hive.ql.parse.CalcitePlanner.analyzeInternal(CalcitePlanner.java:210)\r\n\tat org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:227)\r\n\tat org.apache.hadoop.hive.ql.Driver.compile(Driver.java:425)\r\n\tat org.apache.hadoop.hive.ql.Driver.compile(Driver.java:309)\r\n\tat org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:1145)\r\n\t- locked <0x00000003c0acca40> (a java.lang.Object)\r\n\tat org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:1139)\r\n\tat org.apache.hive.service.cli.operation.SQLOperation.prepare(SQLOperation.java:110)\r\n\tat org.apache.hive.service.cli.operation.SQLOperation.runInternal(SQLOperation.java:181)\r\n\tat org.apache.hive.service.cli.operation.Operation.run(Operation.java:257)\r\n\tat org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementInternal(HiveSessionImpl.java:423)\r\n\tat org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementAsync(HiveSessionImpl.java:410)\r\n\tat sun.reflect.GeneratedMethodAccessor199.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.apache.hive.service.cli.session.HiveSessionProxy.invoke(HiveSessionProxy.java:78)\r\n\tat org.apache.hive.service.cli.session.HiveSessionProxy.access$000(HiveSessionProxy.java:36)\r\n\tat org.apache.hive.service.cli.session.HiveSessionProxy$1.run(HiveSessionProxy.java:63)\r\n\tat java.security.AccessController.doPrivileged(Native Method)\r\n\tat javax.security.auth.Subject.doAs(Subject.java:422)\r\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1962)\r\n\tat org.apache.hive.service.cli.session.HiveSessionProxy.invoke(HiveSessionProxy.java:59)\r\n\tat com.sun.proxy.$Proxy22.executeStatementAsync(Unknown Source)\r\n\tat org.apache.hive.service.cli.CLIService.executeStatementAsync(CLIService.java:275)\r\n\tat org.apache.hive.service.cli.thrift.ThriftCLIService.ExecuteStatement(ThriftCLIService.java:492)\r\n\tat org.apache.hive.service.cli.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1313)\r\n\tat org.apache.hive.service.cli.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1298)\r\n\tat org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39)\r\n\tat org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39)\r\n\tat org.apache.hadoop.hive.thrift.HadoopThriftAuthBridge$Server$TUGIAssumingProcessor.process(HadoopThriftAuthBridge.java:698)\r\n\tat org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:285)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n\tat java.lang.Thread.run(Thread.java:745)\r\n{code}\r\n\r\nIt seems that Thread-809399 which locked the resource *0x00000003c0acca40* is waiting for rpc response， leading to other threads are blocked. Does anyone know what caused this?   Hadoop version is 2.8.2.  Attachment is full jstack.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12935849","id":"12935849","filename":"HiveServer2_jstack.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhangbutao","name":"zhangbutao","key":"zhangbutao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"zhangbutao","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-16T11:19:57.063+0000","size":277099,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12935849/HiveServer2_jstack.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"HiveServer2 is blocked at org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:1144)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhangbutao","name":"zhangbutao","key":"zhangbutao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"zhangbutao","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhangbutao","name":"zhangbutao","key":"zhangbutao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"zhangbutao","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13179310/comment/16582641","id":"16582641","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"body":"Looks like the second thread acquires the compile lock and is waiting from HDFS side to find out if that path is encrypted location or not. Do you see any errors in the namenode logs?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-16T14:57:21.074+0000","updated":"2018-08-16T14:57:21.074+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13179310/comment/16583034","id":"16583034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=belugabehr","name":"belugabehr","key":"belugabehr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BELUGA BEHR","active":true,"timeZone":"America/New_York"},"body":"May also be related to \"small files\"... if the Hive data set has many small files in it, the Hive compile stage can take a long time to download all of the file information.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=belugabehr","name":"belugabehr","key":"belugabehr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BELUGA BEHR","active":true,"timeZone":"America/New_York"},"created":"2018-08-16T20:35:12.963+0000","updated":"2018-08-16T20:35:12.963+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13179310/comment/16584146","id":"16584146","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhangbutao","name":"zhangbutao","key":"zhangbutao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"zhangbutao","active":true,"timeZone":"Etc/UTC"},"body":"[~vihangk1] [~belugabehr]Thank you for attention. We have multiple HiveServer2 instances for loading balance. We didn't find  any obvious errors in namenode logs. Once the hiveserver2 got stuck ,it would have thousands of CLOSED_WAIT connection status on port 10000. We find the execution sql of  *Thread-809399* which locked the resource  *0x00000003c0acca40*  is *select * from table_name limit 10* .  And FetchTask  (hive.fetch.task.conversion= more) is used,  so this sql job would not  produce mr jobs.  Therefore, we doubt that whether this sql generated a full table scan operation using FetchTask, and if the data of table is very large with many small files ,it would cause  HiveServer2 got stuck.\r\nBy the way, the data of table has been updated so we could't know the specific table data size when HiveServe2 got stuck , and its data size is 16 GB now. We test the sql of select * from table_name limit 10, and the return result is just ok. Maybe more data would cause HS2 got stuck. \r\nThe above is my analysis. Do you think this is a correct analysis? Thansk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhangbutao","name":"zhangbutao","key":"zhangbutao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"zhangbutao","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-17T16:35:59.627+0000","updated":"2018-08-17T16:35:59.627+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13179310/comment/16584213","id":"16584213","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"body":"I am not so sure it is related to the data size. If you look at the error stack above the HS2 when it was compiling the query acquired the compile lock below\r\n\r\n{code}\r\n\tat org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:1145)\r\n\t- locked <0x00000003c0acca40> (a java.lang.Object)\r\n\tat org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:1139)\r\n{code}\r\n\r\nand then it issues HDFS RPC call\r\n\r\nat org.apache.hadoop.hdfs.client.HdfsAdmin.getEncryptionZoneForPath(HdfsAdmin.java:350)\r\n\r\nwhich must not be returning for a long time. All this while, no other query can be compiled on this particular HS2 node. You should look at namenode (or possibly datanode logs I am not very sure on that) around that time to see what was going on to find out the root cause. When you repeated the test did you make sure that the same HS2 was compiling the query since you are using load balancer it is possible that the query was compiled by some other HS2 which does not have this problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-17T17:49:20.103+0000","updated":"2018-08-17T17:49:20.103+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-20401/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3x3xb:"}}