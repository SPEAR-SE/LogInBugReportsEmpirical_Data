{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12993334","self":"https://issues.apache.org/jira/rest/api/2/issue/12993334","key":"HIVE-14372","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-08-31T00:39:55.700+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Sep 08 07:17:06 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-14372/watchers","watchCount":3,"isWatching":false},"created":"2016-07-28T18:37:44.825+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junjie","name":"junjie","key":"junjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Junjie Chen","active":true,"timeZone":"Asia/Shanghai"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-09-08T07:23:22.632+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324409","id":"12324409","name":"Beeline"}],"timeoriginalestimate":null,"description":"Case 1:\nI can replace the realm with any garbage realm, and it still works.\n{code}\n[root@c62-n3 ~]# beeline\nBeeline version 0.10.0-cdh4.2.0 by Apache Hive\nbeeline> !connect jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3.intuit.test@ABC.XYZ \nscan complete in 4ms\nConnecting to jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3.intuit.test@ABC.XYZ\nEnter username for jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3.intuit.test@ABC.XYZ: \nEnter password for jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3.intuit.test@ABC.XYZ: \nConnected to: Hive (version 0.10.0)\nDriver: Hive (version 0.10.0-cdh4.2.0)\nTransaction isolation: TRANSACTION_REPEATABLE_READ\n0: jdbc:hive2://c62-n3.intuit.test:10000/> show tables;\n-----------\ntab_name\n-----------\nt1\nt2\ntest\n-----------\n3 rows selected (1.749 seconds)\n0: jdbc:hive2://c62-n3.intuit.test:10000/>\n{code}\n\nCase 2:\nI can keep the garbage realm, but if I use a different hostname (notice I've truncated it to c62-n3.intuit instead of c62-n3.intuit.test), it fails (as it should) but the error message is not at all user-friendly.\n\n{code}\n[root@c62-n3 ~]# beeline\nBeeline version 0.10.0-cdh4.2.0 by Apache Hive\nbeeline> !connect jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3.intuit@ABC \nscan complete in 4ms\nConnecting to jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3.intuit@ABC\nEnter username for jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3.intuit@ABC: \nEnter password for jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3.intuit@ABC: \n13/06/10 08:34:29 ERROR transport.TSaslTransport: SASL negotiation failure\njavax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Server not found in Kerberos database (7) - UNKNOWN_SERVER)]\nat com.sun.security.sasl.gsskerb.GssKrb5Client.evaluateChallenge(GssKrb5Client.java:194)\nat org.apache.thrift.transport.TSaslClientTransport.handleSaslStartMessage(TSaslClientTransport.java:94)\nat org.apache.thrift.transport.TSaslTransport.open(TSaslTransport.java:253)\nat org.apache.thrift.transport.TSaslClientTransport.open(TSaslClientTransport.java:37)\nat org.apache.hadoop.hive.thrift.client.TUGIAssumingTransport$1.run(TUGIAssumingTransport.java:52)\nat org.apache.hadoop.hive.thrift.client.TUGIAssumingTransport$1.run(TUGIAssumingTransport.java:49)\nat java.security.AccessController.doPrivileged(Native Method)\nat javax.security.auth.Subject.doAs(Subject.java:396)\nat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1408)\nat org.apache.hadoop.hive.thrift.client.TUGIAssumingTransport.open(TUGIAssumingTransport.java:49)\nat org.apache.hive.jdbc.HiveConnection.openTransport(HiveConnection.java:156)\nat org.apache.hive.jdbc.HiveConnection.<init>(HiveConnection.java:96)\nat org.apache.hive.jdbc.HiveDriver.connect(HiveDriver.java:104)\nat java.sql.DriverManager.getConnection(DriverManager.java:582)\nat java.sql.DriverManager.getConnection(DriverManager.java:185)\nat org.apache.hive.beeline.DatabaseConnection.connect(DatabaseConnection.java:152)\nat org.apache.hive.beeline.DatabaseConnection.getConnection(DatabaseConnection.java:193)\nat org.apache.hive.beeline.Commands.connect(Commands.java:965)\nat org.apache.hive.beeline.Commands.connect(Commands.java:896)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\nat java.lang.reflect.Method.invoke(Method.java:597)\nat org.apache.hive.beeline.ReflectiveCommandHandler.execute(ReflectiveCommandHandler.java:66)\nat org.apache.hive.beeline.BeeLine.dispatch(BeeLine.java:755)\nat org.apache.hive.beeline.BeeLine.begin(BeeLine.java:631)\nat org.apache.hive.beeline.BeeLine.mainWithInputRedirection(BeeLine.java:380)\nat org.apache.hive.beeline.BeeLine.main(BeeLine.java:364)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\nat java.lang.reflect.Method.invoke(Method.java:597)\nat org.apache.hadoop.util.RunJar.main(RunJar.java:208)\nCaused by: GSSException: No valid credentials provided (Mechanism level: Server not found in Kerberos database (7) - UNKNOWN_SERVER)\nat sun.security.jgss.krb5.Krb5Context.initSecContext(Krb5Context.java:663)\nat sun.security.jgss.GSSContextImpl.initSecContext(GSSContextImpl.java:230)\nat sun.security.jgss.GSSContextImpl.initSecContext(GSSContextImpl.java:162)\nat com.sun.security.sasl.gsskerb.GssKrb5Client.evaluateChallenge(GssKrb5Client.java:175)\n... 32 more\nCaused by: KrbException: Server not found in Kerberos database (7) - UNKNOWN_SERVER\nat sun.security.krb5.KrbTgsRep.<init>(KrbTgsRep.java:64)\nat sun.security.krb5.KrbTgsReq.getReply(KrbTgsReq.java:185)\nat sun.security.krb5.internal.CredentialsUtil.serviceCreds(CredentialsUtil.java:294)\nat sun.security.krb5.internal.CredentialsUtil.acquireServiceCreds(CredentialsUtil.java:106)\nat sun.security.krb5.Credentials.acquireServiceCreds(Credentials.java:557)\nat sun.security.jgss.krb5.Krb5Context.initSecContext(Krb5Context.java:594)\n... 35 more\nCaused by: KrbException: Identifier doesn't match expected value (906)\nat sun.security.krb5.internal.KDCRep.init(KDCRep.java:133)\nat sun.security.krb5.internal.TGSRep.init(TGSRep.java:58)\nat sun.security.krb5.internal.TGSRep.<init>(TGSRep.java:53)\nat sun.security.krb5.KrbTgsRep.<init>(KrbTgsRep.java:46)\n... 40 more\norg.apache.thrift.transport.TTransportException: GSS initiate failed\nat org.apache.thrift.transport.TSaslTransport.sendAndThrowMessage(TSaslTransport.java:221)\nat org.apache.thrift.transport.TSaslTransport.open(TSaslTransport.java:297)\nat org.apache.thrift.transport.TSaslClientTransport.open(TSaslClientTransport.java:37)\nat org.apache.hadoop.hive.thrift.client.TUGIAssumingTransport$1.run(TUGIAssumingTransport.java:52)\nat org.apache.hadoop.hive.thrift.client.TUGIAssumingTransport$1.run(TUGIAssumingTransport.java:49)\nat java.security.AccessController.doPrivileged(Native Method)\nat javax.security.auth.Subject.doAs(Subject.java:396)\nat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1408)\nat org.apache.hadoop.hive.thrift.client.TUGIAssumingTransport.open(TUGIAssumingTransport.java:49)\nat org.apache.hive.jdbc.HiveConnection.openTransport(HiveConnection.java:156)\nat org.apache.hive.jdbc.HiveConnection.<init>(HiveConnection.java:96)\nat org.apache.hive.jdbc.HiveDriver.connect(HiveDriver.java:104)\nat java.sql.DriverManager.getConnection(DriverManager.java:582)\nat java.sql.DriverManager.getConnection(DriverManager.java:185)\nat org.apache.hive.beeline.DatabaseConnection.connect(DatabaseConnection.java:152)\nat org.apache.hive.beeline.DatabaseConnection.getConnection(DatabaseConnection.java:193)\nat org.apache.hive.beeline.Commands.connect(Commands.java:965)\nat org.apache.hive.beeline.Commands.connect(Commands.java:896)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\nat java.lang.reflect.Method.invoke(Method.java:597)\nat org.apache.hive.beeline.ReflectiveCommandHandler.execute(ReflectiveCommandHandler.java:66)\nat org.apache.hive.beeline.BeeLine.dispatch(BeeLine.java:755)\nat org.apache.hive.beeline.BeeLine.begin(BeeLine.java:631)\nat org.apache.hive.beeline.BeeLine.mainWithInputRedirection(BeeLine.java:380)\nat org.apache.hive.beeline.BeeLine.main(BeeLine.java:364)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\nat java.lang.reflect.Method.invoke(Method.java:597)\nat org.apache.hadoop.util.RunJar.main(RunJar.java:208)\nError: Invalid URL: jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3.intuit@ABC (state=08S01,code=0)\n{code}\n\nCase 3:\nIf I truncate the hostname portion of the principal to the shortname (hive/c62-n3), it works. This should fail, since the principal 'hive/c62-n3' does not exist.\n{code}\n[root@c62-n3 ~]# beeline\nBeeline version 0.10.0-cdh4.2.0 by Apache Hive\nbeeline> !connect jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3@ABC \nscan complete in 3ms\nConnecting to jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3@ABC\nEnter username for jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3@ABC: \nEnter password for jdbc:hive2://c62-n3.intuit.test:10000/;principal=hive/c62-n3@ABC: \nConnected to: Hive (version 0.10.0)\nDriver: Hive (version 0.10.0-cdh4.2.0)\nTransaction isolation: TRANSACTION_REPEATABLE_READ\n0: jdbc:hive2://c62-n3.intuit.test:10000/> show tables;\n-----------\ntab_name\n-----------\nt1\nt2\ntest\n-----------\n3 rows selected (1.553 seconds)\n0: jdbc:hive2://c62-n3.intuit.test:10000/>\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Odd behavior with Beeline parsing server principal in Kerberized environment","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12993334/comment/15450614","id":"15450614","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junjie","name":"junjie","key":"junjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Junjie Chen","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi Vihang Karajgaonkar\n\nI can reproduce case 1 and case 2, but cannot reproduce case 3. Can you run klist -k <keytab> to check whether you added server hostname to some principle? Or could you please dump klist -k <keytab>? \n\nFurthermore, if would be better if you can set beeline log level to debug and paste output for case 1 and case 2. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junjie","name":"junjie","key":"junjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Junjie Chen","active":true,"timeZone":"Asia/Shanghai"},"created":"2016-08-31T00:39:55.700+0000","updated":"2016-08-31T00:39:55.700+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12993334/comment/15473060","id":"15473060","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junjie","name":"junjie","key":"junjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Junjie Chen","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~vihangk1]\n\nEther the JDK API createSaslClient do not accept the realm parameter,  see: createSaslClient(String[] mechanisms, String authorizationId, String protocol, String serverName, Map<String,?> props, CallbackHandler cbh) or underlying security provider com.sun.security.sasl.Provider (GssKrb5Client.java in com.sun.security.sasl.gsskerb.GssKrb5Client) do not accept realm parameter, since Kerberos V5 mechanism will map hostname to canonical principal format in three ways (refer to [1] and [2]). For example,  the underlying security provider will read your kerberos configuration krb5.conf to generate a realm through the [domain_realm] section. \n\nCurrently, though the hive code check whether there is a realm part, it doesn't use it at all. I think the realm check should be removed according to java API definition, and user could configure realm in krb5.conf.  what do you think?\n\n[1]: https://web.mit.edu/kerberos/krb5-1.13/doc/admin/realm_config.html \n[2]: https://docs.oracle.com/javase/8/docs/technotes/guides/security/jgss/single-signon.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junjie","name":"junjie","key":"junjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Junjie Chen","active":true,"timeZone":"Asia/Shanghai"},"created":"2016-09-08T07:17:06.961+0000","updated":"2016-09-08T07:23:22.514+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-14372/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i31n2n:"}}