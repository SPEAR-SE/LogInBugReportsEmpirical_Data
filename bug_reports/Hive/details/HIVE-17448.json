{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13099530","self":"https://issues.apache.org/jira/rest/api/2/issue/13099530","key":"HIVE-17448","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Sep 04 05:19:14 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17448/watchers","watchCount":2,"isWatching":false},"created":"2017-09-04T04:51:09.275+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335838","id":"12335838","description":"Maintenance branch for 2.1 ","name":"2.1.1","archived":false,"released":true,"releaseDate":"2016-12-08"}],"issuelinks":[{"id":"12513741","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12513741","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"13017919","key":"HIVE-15124","self":"https://issues.apache.org/jira/rest/api/2/issue/13017919","fields":{"summary":"Fix OrcInputFormat to use reader's schema for include boolean array","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-09-07T00:25:50.023+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12328244","id":"12328244","name":"ORC"}],"timeoriginalestimate":null,"description":"When ORC files have been created with older schema, which had smaller set of struct fields, and schema have been changed to one with more struct fields, and there are sibling fields of struct type going after struct itself, ArrayIndexOutOfBoundsException is being thrown. Steps to reproduce:\n{code:none}\ncreate external table test_broken_struct(a struct<f1:int, f2:int>, b int) stored as orc;\ninsert into table test_broken_struct \n    select named_struct(\"f1\", 1, \"f2\", 2), 3;\ndrop table test_broken_struct;\ncreate external table test_broken_struct(a struct<f1:int, f2:int, f3:int>, b int) stored as orc;\nselect * from test_broken_struct;\n{code}\nSame scenario is not causing crash on hive 0.14.\n\nDebug log and stack trace:\n{code:none}\n2017-09-07T00:21:40,266  INFO [main] orc.OrcInputFormat: Using schema evolution configuration variables schema.evol\nution.columns [a, b] / schema.evolution.columns.types [struct<f1:int,f2:int,f3:int>, int] (isAcidRead false)\n2017-09-07T00:21:40,267 DEBUG [main] orc.OrcInputFormat: No ORC pushdown predicate\n2017-09-07T00:21:40,267  INFO [main] orc.ReaderImpl: Reading ORC rows from hdfs://cluster-7199-m/user/hive/warehous\ne/test_broken_struct/000000_0 with {include: [true, true, true, true, true], offset: 3, length: 159, schema: struct\n<a:struct<f1:int,f2:int,f3:int>,b:int>}\nFailed with exception java.io.IOException:java.lang.ArrayIndexOutOfBoundsException: 5\n2017-09-07T00:21:40,273 ERROR [main] CliDriver: Failed with exception java.io.IOException:java.lang.ArrayIndexOutOf\nBoundsException: 5\njava.io.IOException: java.lang.ArrayIndexOutOfBoundsException: 5\n        at org.apache.hadoop.hive.ql.exec.FetchOperator.getNextRow(FetchOperator.java:521)\n        at org.apache.hadoop.hive.ql.exec.FetchOperator.pushRow(FetchOperator.java:428)\n        at org.apache.hadoop.hive.ql.exec.FetchTask.fetch(FetchTask.java:146)\n        at org.apache.hadoop.hive.ql.Driver.getResults(Driver.java:2098)\n        at org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:252)\n        at org.apache.hadoop.hive.cli.CliDriver.processCmd(CliDriver.java:183)\n        at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:399)\n        at org.apache.hadoop.hive.cli.CliDriver.executeDriver(CliDriver.java:776)\n        at org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:714)\n        at org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:641)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:498)\n        at org.apache.hadoop.util.RunJar.run(RunJar.java:221)\n        at org.apache.hadoop.util.RunJar.main(RunJar.java:136)\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 5\n        at org.apache.orc.impl.SchemaEvolution.buildConversionFileTypesArray(SchemaEvolution.java:195)\n        at org.apache.orc.impl.SchemaEvolution.buildConversionFileTypesArray(SchemaEvolution.java:253)\n        at org.apache.orc.impl.SchemaEvolution.<init>(SchemaEvolution.java:59)\n        at org.apache.orc.impl.RecordReaderImpl.<init>(RecordReaderImpl.java:149)\n        at org.apache.hadoop.hive.ql.io.orc.RecordReaderImpl.<init>(RecordReaderImpl.java:63)\n        at org.apache.hadoop.hive.ql.io.orc.ReaderImpl.rowsOptions(ReaderImpl.java:87)\n        at org.apache.hadoop.hive.ql.io.orc.OrcInputFormat.createReaderFromFile(OrcInputFormat.java:314)\n        at org.apache.hadoop.hive.ql.io.orc.OrcInputFormat$OrcRecordReader.<init>(OrcInputFormat.java:225)\n        at org.apache.hadoop.hive.ql.io.orc.OrcInputFormat.getRecordReader(OrcInputFormat.java:1691)\n        at org.apache.hadoop.hive.ql.exec.FetchOperator$FetchInputFormatSplit.getRecordReader(FetchOperator.java:69\n5)\n        at org.apache.hadoop.hive.ql.exec.FetchOperator.getRecordReader(FetchOperator.java:333)\n        at org.apache.hadoop.hive.ql.exec.FetchOperator.getNextRow(FetchOperator.java:459)\n        ... 15 more\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12885189","id":"12885189","filename":"HIVE-17448.1-branch-2.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chemikadze","name":"chemikadze","key":"chemikadze","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nikolay Sokolov","active":true,"timeZone":"Etc/UTC"},"created":"2017-09-04T05:19:28.620+0000","size":2768,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12885189/HIVE-17448.1-branch-2.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ArrayIndexOutOfBoundsException on ORC tables after adding a struct field","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chemikadze","name":"chemikadze","key":"chemikadze","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nikolay Sokolov","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chemikadze","name":"chemikadze","key":"chemikadze","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nikolay Sokolov","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Reproduced on Dataproc 1.1, 1.2 (Hive 2.1).","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13099530/comment/16152133","id":"16152133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chemikadze","name":"chemikadze","key":"chemikadze","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nikolay Sokolov","active":true,"timeZone":"Etc/UTC"},"body":"Is not reproducing when there is no trailing fields -- struct comparison seem to trim unmatched fields, but outside (row's) struct comparison does not take into account different number of fields.\nAttaching possible naive patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chemikadze","name":"chemikadze","key":"chemikadze","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nikolay Sokolov","active":true,"timeZone":"Etc/UTC"},"created":"2017-09-04T05:19:14.744+0000","updated":"2017-09-04T05:19:14.744+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17448/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3jlqn:"}}