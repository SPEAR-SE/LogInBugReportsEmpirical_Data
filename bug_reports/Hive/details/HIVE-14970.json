{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13012501","self":"https://issues.apache.org/jira/rest/api/2/issue/13012501","key":"HIVE-14970","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Nov 02 21:39:03 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-14970/watchers","watchCount":3,"isWatching":false},"created":"2016-10-14T23:23:10.925+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-11-02T21:39:15.971+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"Running on a regular CLI driver\n{noformat}\nCREATE TABLE src_bucket(key STRING, value STRING) CLUSTERED BY (key) SORTED BY (key) INTO 2 BUCKETS;\n\ninsert into table src_bucket select key,value from srcpart limit 10;\ndfs -ls ${hiveconf:hive.metastore.warehouse.dir}/src_bucket/;\nselect *, INPUT__FILE__NAME from src_bucket;\nselect * from src_bucket tablesample (bucket 1 out of 2) s;\nselect * from src_bucket tablesample (bucket 2 out of 2) s;\n\ninsert into table src_bucket select key,value from srcpart limit 10;\ndfs -ls ${hiveconf:hive.metastore.warehouse.dir}/src_bucket/;\nselect *, INPUT__FILE__NAME from src_bucket;\nselect * from src_bucket tablesample (bucket 1 out of 2) s;\nselect * from src_bucket tablesample (bucket 2 out of 2) s;\n{noformat}\n\nResults in the following (with masking disabled and grepping away the noise).\nLooks like bucket mapping completely breaks due to extra files, which may have implications for all the optimizations that depend on them.\nThis should work or at least fail if this is not supported.\n{noformat}\nPREHOOK: query: CREATE TABLE src_bucket(key STRING, value STRING) CLUSTERED BY (key) SORTED BY (key) INTO 2 BUCKETS\nPREHOOK: query: insert into table src_bucket select key,value from srcpart limit 10\nFound 2 items\n-rwxr-xr-x   1 sergey staff         46 2016-10-14 16:09 pfile:///Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0\n-rwxr-xr-x   1 sergey staff         68 2016-10-14 16:09 pfile:///Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\nPREHOOK: query: select *, INPUT__FILE__NAME from src_bucket\n165\tval_165\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0\n255\tval_255\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0\n484\tval_484\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0\n86\tval_86\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0\n238\tval_238\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n27\tval_27\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n278\tval_278\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n311\tval_311\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n409\tval_409\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n98\tval_98\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\nPREHOOK: query: select * from src_bucket tablesample (bucket 1 out of 2) s\n165\tval_165\n255\tval_255\n484\tval_484\n86\tval_86\nPREHOOK: query: select * from src_bucket tablesample (bucket 2 out of 2) s\n238\tval_238\n27\tval_27\n278\tval_278\n311\tval_311\n409\tval_409\n98\tval_98\n{noformat}\nSo far so good.\n{noformat}\nPREHOOK: query: insert into table src_bucket select key,value from srcpart limit 10\nFound 4 items\n-rwxr-xr-x   1 sergey staff         46 2016-10-14 16:09 pfile:///Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0\n-rwxr-xr-x   1 sergey staff         46 2016-10-14 16:09 pfile:///Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0_copy_1\n-rwxr-xr-x   1 sergey staff         68 2016-10-14 16:09 pfile:///Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n-rwxr-xr-x   1 sergey staff         68 2016-10-14 16:09 pfile:///Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0_copy_1\nPREHOOK: query: select *, INPUT__FILE__NAME from src_bucket\n165\tval_165\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0\n255\tval_255\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0\n484\tval_484\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0\n86\tval_86\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0\n165\tval_165\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0_copy_1\n255\tval_255\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0_copy_1\n484\tval_484\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0_copy_1\n86\tval_86\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000000_0_copy_1\n238\tval_238\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n27\tval_27\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n278\tval_278\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n311\tval_311\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n409\tval_409\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n98\tval_98\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0\n238\tval_238\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0_copy_1\n27\tval_27\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0_copy_1\n278\tval_278\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0_copy_1\n311\tval_311\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0_copy_1\n409\tval_409\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0_copy_1\n98\tval_98\tpfile:/Users/sergey/git/hive/itests/qtest/target/warehouse/src_bucket/000001_0_copy_1\nPREHOOK: query: select * from src_bucket tablesample (bucket 1 out of 2) s\n165\tval_165\n255\tval_255\n484\tval_484\n86\tval_86\nPREHOOK: query: select * from src_bucket tablesample (bucket 2 out of 2) s\n{noformat}\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"repeated insert into is broken for buckets (incorrect results for tablesample, BucketingSortingReduceSinkOptimizer)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13012501/comment/15576862","id":"15576862","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hagleitn] [~gopalv] [~prasanth_j] [~ekoifman] [~ashutoshc] fyi\nI am not sure who knows more about this aspect of bucketing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-10-14T23:26:17.984+0000","updated":"2016-10-14T23:26:17.984+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13012501/comment/15583230","id":"15583230","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"According to [~gopalv] this is specific to table sample.\nPerhaps we should disable or remove SamplePruner entirely, and check other places to make sure that noone else makes this assumption (one file per bucket, in order)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-10-17T19:43:25.415+0000","updated":"2016-10-17T19:43:25.415+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13012501/comment/15630619","id":"15630619","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"[~ashutoshc] [~gopalv] I believe this can also affect BucketingSortingReduceSinkOptimizer - storeBucketPathMapping stores it based on file order","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-11-02T21:39:03.750+0000","updated":"2016-11-02T21:39:03.750+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-14970/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i34x87:"}}