{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12644521","self":"https://issues.apache.org/jira/rest/api/2/issue/12644521","key":"HIVE-4421","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323587","id":"12323587","description":"Hive 0.11.0","name":"0.11.0","archived":false,"released":true,"releaseDate":"2013-05-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324312","id":"12324312","description":"released","name":"0.12.0","archived":false,"released":true,"releaseDate":"2013-10-15"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-04-25T06:16:14.450+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu May 09 02:10:15 UTC 2013","customfield_12310420":"324886","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_1076832376_*|*_1_*:*_1_*:*_50863500_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-05-08T04:52:34.767+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-4421/watchers","watchCount":5,"isWatching":false},"created":"2013-04-25T03:37:38.936+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=owen.omalley","name":"owen.omalley","key":"owen.omalley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=29697","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=29697","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=29697","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=29697"},"displayName":"Owen O'Malley","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-16T21:10:25.995+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312585","id":"12312585","name":"Serializers/Deserializers","description":"Tracks issues dealing with serdes"}],"timeoriginalestimate":null,"description":"Currently, for tables with many string columns, it is possible to significantly underestimate the memory used by the ORC dictionaries and cause the query to run out of memory in the task. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12580488","id":"12580488","filename":"HIVE-4421.D10545.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-04-25T06:16:14.572+0000","size":28100,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12580488/HIVE-4421.D10545.1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12581263","id":"12581263","filename":"HIVE-4421.D10545.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-04-30T23:18:14.417+0000","size":32326,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12581263/HIVE-4421.D10545.2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12581366","id":"12581366","filename":"HIVE-4421.D10545.3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-01T15:38:13.760+0000","size":34930,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12581366/HIVE-4421.D10545.3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12581442","id":"12581442","filename":"HIVE-4421.D10545.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-01T23:54:15.249+0000","size":40611,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12581442/HIVE-4421.D10545.4.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"325232","customfield_12312823":null,"summary":"Improve memory usage by ORC dictionaries","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=owen.omalley","name":"owen.omalley","key":"owen.omalley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=29697","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=29697","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=29697","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=29697"},"displayName":"Owen O'Malley","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=owen.omalley","name":"owen.omalley","key":"owen.omalley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=29697","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=29697","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=29697","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=29697"},"displayName":"Owen O'Malley","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13641476","id":"13641476","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"omalley requested code review of \"HIVE-4421 [jira] Improve memory usage by ORC dictionaries\".\n\nReviewers: JIRA\n\nHIVE-4421 Improve ORC dictionary memory usage and tracking\n\nCurrently, for tables with many string columns, it is possible to significantly underestimate the memory used by the ORC dictionaries and cause the query to run out of memory in the task.\n\nTEST PLAN\n  EMPTY\n\nREVISION DETAIL\n  https://reviews.facebook.net/D10545\n\nAFFECTED FILES\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicByteArray.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicIntArray.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/RedBlackTree.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/StringRedBlackTree.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/WriterImpl.java\n  ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestStringRedBlackTree.java\n  ql/src/test/resources/orc-file-dump.out\n\nMANAGE HERALD RULES\n  https://reviews.facebook.net/herald/view/differential/\n\nWHY DID I GET THIS EMAIL?\n  https://reviews.facebook.net/herald/transcript/25221/\n\nTo: JIRA, omalley\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-04-25T06:16:14.450+0000","updated":"2013-04-25T06:16:14.450+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13641999","id":"13641999","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=owen.omalley","name":"owen.omalley","key":"owen.omalley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=29697","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=29697","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=29697","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=29697"},"displayName":"Owen O'Malley","active":true,"timeZone":"America/Los_Angeles"},"body":"This patch does three things:\n* Improves the memory usage while writing ORC dictionaries by removing the counts and just storing offsets instead of offsets and lengths.\n* Improves the tracking of how much memory is used by the dictionaries by tracking the allocation rather than the usage.\n* Reduces the size of some of the allocation sizes of the integer arrays.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=owen.omalley","name":"owen.omalley","key":"owen.omalley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=29697","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=29697","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=29697","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=29697"},"displayName":"Owen O'Malley","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-04-25T17:45:22.428+0000","updated":"2013-04-25T17:45:22.428+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13646138","id":"13646138","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"omalley updated the revision \"HIVE-4421 [jira] Improve memory usage by ORC dictionaries\".\n\n  Changed the memory manager to check on each 5000 total rows added. This seems to give the best trade off between handling too many writers in a small heap and still managing memory pretty accurately.\n\nReviewers: JIRA\n\nREVISION DETAIL\n  https://reviews.facebook.net/D10545\n\nCHANGE SINCE LAST DIFF\n  https://reviews.facebook.net/D10545?vs=32889&id=33201#toc\n\nAFFECTED FILES\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicByteArray.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicIntArray.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/MemoryManager.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/OutStream.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/PositionedOutputStream.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/RedBlackTree.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/StringRedBlackTree.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/WriterImpl.java\n  ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestMemoryManager.java\n  ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestStringRedBlackTree.java\n  ql/src/test/resources/orc-file-dump.out\n\nTo: JIRA, omalley\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-04-30T23:18:14.269+0000","updated":"2013-04-30T23:18:14.269+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13646655","id":"13646655","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"omalley updated the revision \"HIVE-4421 [jira] Improve memory usage by ORC dictionaries\".\n\n  I've updated the TestOrcFile unit test to reflect the changes.\n\nReviewers: JIRA\n\nREVISION DETAIL\n  https://reviews.facebook.net/D10545\n\nCHANGE SINCE LAST DIFF\n  https://reviews.facebook.net/D10545?vs=33201&id=33219#toc\n\nAFFECTED FILES\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicByteArray.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicIntArray.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/MemoryManager.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/OutStream.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/PositionedOutputStream.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/RedBlackTree.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/StringRedBlackTree.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/WriterImpl.java\n  ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestMemoryManager.java\n  ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestOrcFile.java\n  ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestStringRedBlackTree.java\n  ql/src/test/resources/orc-file-dump.out\n\nTo: JIRA, omalley\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-01T15:38:13.636+0000","updated":"2013-05-01T15:38:13.636+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13646783","id":"13646783","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"ashutoshc has requested changes to the revision \"HIVE-4421 [jira] Improve memory usage by ORC dictionaries\".\n\n  Logic in patch mostly looks good. Just requesting for more comments, though ORC is already have pretty good comments. Also, I didn't understand changes in RedBlackTree. I assume you have improved memory accounting for it. But it will be great if you can spell out what was the problem earlier which you are fixing in this patch.\n\nINLINE COMMENTS\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/MemoryManager.java:44 \"added to..\" is repeated.\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/MemoryManager.java:47 I think its better to define this in HiveConf as well, so that we can up or down this value without needing to recompile Hive. Specially, since size of row is unbounded. Size of 5K rows are very much data dependent. e.g., I recently saw a table which had more than 100 string columns.\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/MemoryManager.java:141 I think it will be good to add a note in comment about usage of synchronized keyword, ie the scenario where this method might be invoked from different threads.\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/MemoryManager.java:94 It will be good to add a comment on when oldVal could possibly be null. On the first reading of code, it wasn't obvious to me.\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicIntArray.java:138 Better name : getSizeInBytes ?\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/MemoryManager.java:142 It will be good to add a comment saying that every 5000 rows added across all writers we request each writer to flush their content to disk if they are using memory beyond their quota.\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/OutStream.java:233 I didnt get when current ByteBuffer could be null. It will always be non-null when this method is invoked. Isnt it? Will be good to add a comment if the case is otherwise.\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/OutStream.java:236 Just for my own clarity, this will be null when compression is off, right ?\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/OutStream.java:37 It will be good to add a comment for all these 3 ByteBuffers for what kind of data are they holding.\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/WriterImpl.java:687 Pardon my ignorance. I didn't get what countOutput was meant for earlier and why it is no longer required.\n\nREVISION DETAIL\n  https://reviews.facebook.net/D10545\n\nBRANCH\n  h-4421\n\nARCANIST PROJECT\n  hive\n\nTo: JIRA, ashutoshc, omalley\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-01T18:16:14.172+0000","updated":"2013-05-01T18:16:14.172+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13647093","id":"13647093","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"omalley updated the revision \"HIVE-4421 [jira] Improve memory usage by ORC dictionaries\".\n\n  Addressed Ashutosh's suggestions.\n\nReviewers: ashutoshc, JIRA\n\nREVISION DETAIL\n  https://reviews.facebook.net/D10545\n\nCHANGE SINCE LAST DIFF\n  https://reviews.facebook.net/D10545?vs=33219&id=33249#toc\n\nAFFECTED FILES\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicByteArray.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicIntArray.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/MemoryManager.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/OutStream.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/PositionedOutputStream.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/RedBlackTree.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/StringRedBlackTree.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/orc/WriterImpl.java\n  ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestMemoryManager.java\n  ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestOrcFile.java\n  ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestStringRedBlackTree.java\n  ql/src/test/resources/orc-file-dump.out\n\nTo: JIRA, ashutoshc, omalley\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-01T23:54:15.110+0000","updated":"2013-05-01T23:54:15.110+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13647306","id":"13647306","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"omalley has commented on the revision \"HIVE-4421 [jira] Improve memory usage by ORC dictionaries\".\n\n  Ashutosh, I incorporated most of your input. The 5000 rows between memory checks is just how often we check the writers against the size of their allocation. If there is enough memory, it doesn't result in any IO. I don't think there would be enough use to justify making it into a HiveConf variable.\n\n  You asked why I removed the countOutput and the answer is that we didn't have immediate plans to use it, the use case for it was relatively rare and it saved some memory & complexity.\n\nREVISION DETAIL\n  https://reviews.facebook.net/D10545\n\nTo: JIRA, ashutoshc, omalley\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-02T05:24:15.707+0000","updated":"2013-05-02T05:24:15.707+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13647660","id":"13647660","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"ashutoshc has accepted the revision \"HIVE-4421 [jira] Improve memory usage by ORC dictionaries\".\n\n  +1 will commit if tests pass.\n\nREVISION DETAIL\n  https://reviews.facebook.net/D10545\n\nBRANCH\n  h-4421\n\nARCANIST PROJECT\n  hive\n\nTo: JIRA, ashutoshc, omalley\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-02T16:12:14.156+0000","updated":"2013-05-02T16:12:14.156+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13651621","id":"13651621","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"Committed to trunk. Thanks, Owen!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-08T04:52:34.788+0000","updated":"2013-05-08T04:52:34.788+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13651881","id":"13651881","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hive-trunk-h0.21 #2091 (See [https://builds.apache.org/job/Hive-trunk-h0.21/2091/])\n    HIVE-4421 : Improve memory usage by ORC dictionaries (Owen Omalley via Ashutosh Chauhan) (Revision 1480159)\n\n     Result = FAILURE\nhashutosh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1480159\nFiles : \n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicByteArray.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicIntArray.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/MemoryManager.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/OutStream.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/PositionedOutputStream.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/RedBlackTree.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/StringRedBlackTree.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/WriterImpl.java\n* /hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestMemoryManager.java\n* /hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestOrcFile.java\n* /hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestStringRedBlackTree.java\n* /hive/trunk/ql/src/test/resources/orc-file-dump.out\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-08T13:29:19.028+0000","updated":"2013-05-08T13:29:19.028+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12644521/comment/13652673","id":"13652673","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hive-trunk-hadoop2 #188 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/188/])\n    HIVE-4421 : Improve memory usage by ORC dictionaries (Owen Omalley via Ashutosh Chauhan) (Revision 1480159)\n\n     Result = ABORTED\nhashutosh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1480159\nFiles : \n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicByteArray.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/DynamicIntArray.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/MemoryManager.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/OutStream.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/PositionedOutputStream.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/RedBlackTree.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/StringRedBlackTree.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/orc/WriterImpl.java\n* /hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestMemoryManager.java\n* /hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestOrcFile.java\n* /hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestStringRedBlackTree.java\n* /hive/trunk/ql/src/test/resources/orc-file-dump.out\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-09T02:10:15.774+0000","updated":"2013-05-09T02:10:15.774+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-4421/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1k1v3:"}}