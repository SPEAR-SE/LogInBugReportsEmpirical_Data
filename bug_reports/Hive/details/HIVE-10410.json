{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12822499","self":"https://issues.apache.org/jira/rest/api/2/issue/12822499","key":"HIVE-10410","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-04-21T00:21:25.985+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Sep 14 10:46:44 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_8771399160_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-07-31T12:05:13.545+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-10410/watchers","watchCount":21,"isWatching":false},"created":"2015-04-20T23:35:14.423+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326829","id":"12326829","description":"0.13 maintenance release 1","name":"0.13.1","archived":false,"released":true,"releaseDate":"2014-06-06"}],"issuelinks":[{"id":"12429240","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12429240","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12835892","key":"HIVE-10956","self":"https://issues.apache.org/jira/rest/api/2/issue/12835892","fields":{"summary":"HS2 leaks HMS connections","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12421902","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12421902","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12822412","key":"HIVE-10404","self":"https://issues.apache.org/jira/rest/api/2/issue/12822412","fields":{"summary":"hive.exec.parallel=true causes \"out of sequence response\" and SocketTimeoutException: Read timed out","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12427226","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12427226","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12745198","key":"HIVE-8320","self":"https://issues.apache.org/jira/rest/api/2/issue/12745198","fields":{"summary":"Error in MetaException(message:Got exception: org.apache.thrift.transport.TTransportException java.net.SocketTimeoutException: Read timed out)","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-09-14T10:46:44.777+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12320408","id":"12320408","name":"HiveServer2","description":"Tracks issues related to HiveServer2"}],"timeoriginalestimate":null,"description":"On our secure Hadoop cluster, queries submitted to HiveServer2 through JDBC occasionally trigger odd Thrift exceptions with messages such as \"Read a negative frame size (-2147418110)!\" or \"out of sequence response\" in HiveServer2's connections to the metastore. For certain metastore calls (for example, showDatabases), these Thrift exceptions are converted to MetaExceptions in HiveMetaStoreClient, which prevents RetryingMetaStoreClient from retrying these calls and thus causes the failure to bubble out to the JDBC client.\n\nNote that as far as we can tell, this issue appears to only affect queries that are submitted with the runAsync flag on TExecuteStatementReq set to true (which, in practice, seems to mean all JDBC queries), and it appears to only manifest when HiveServer2 is using the new HTTP transport mechanism. When both these conditions hold, we are able to fairly reliably reproduce the issue by spawning about 100 simple, concurrent hive queries (we have been using \"show databases\"), two or three of which typically fail. However, when either of these conditions do not hold, we are no longer able to reproduce the issue.\n\nSome example stack traces from the HiveServer2 logs:\n\n{noformat}\n2015-04-16 13:54:55,486 ERROR hive.log: Got exception: org.apache.thrift.transport.TTransportException Read a negative frame size (-2147418110)!\norg.apache.thrift.transport.TTransportException: Read a negative frame size (-2147418110)!\n        at org.apache.thrift.transport.TSaslTransport.readFrame(TSaslTransport.java:435)\n        at org.apache.thrift.transport.TSaslTransport.read(TSaslTransport.java:414)\n        at org.apache.thrift.transport.TSaslClientTransport.read(TSaslClientTransport.java:37)\n        at org.apache.thrift.transport.TTransport.readAll(TTransport.java:84)\n        at org.apache.hadoop.hive.thrift.TFilterTransport.readAll(TFilterTransport.java:62)\n        at org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:378)\n        at org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:297)\n        at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:204)\n        at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:69)\n        at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Client.recv_get_databases(ThriftHiveMetastore.java:600)\n        at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Client.get_databases(ThriftHiveMetastore.java:587)\n        at org.apache.hadoop.hive.metastore.HiveMetaStoreClient.getDatabases(HiveMetaStoreClient.java:837)\n        at org.apache.sentry.binding.metastore.SentryHiveMetaStoreClient.getDatabases(SentryHiveMetaStoreClient.java:60)\n        at sun.reflect.GeneratedMethodAccessor20.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:606)\n        at org.apache.hadoop.hive.metastore.RetryingMetaStoreClient.invoke(RetryingMetaStoreClient.java:90)\n        at com.sun.proxy.$Proxy6.getDatabases(Unknown Source)\n        at org.apache.hadoop.hive.ql.metadata.Hive.getDatabasesByPattern(Hive.java:1139)\n        at org.apache.hadoop.hive.ql.exec.DDLTask.showDatabases(DDLTask.java:2445)\n        at org.apache.hadoop.hive.ql.exec.DDLTask.execute(DDLTask.java:364)\n        at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:153)\n        at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:85)\n        at org.apache.hadoop.hive.ql.Driver.launchTask(Driver.java:1554)\n        at org.apache.hadoop.hive.ql.Driver.execute(Driver.java:1321)\n        at org.apache.hadoop.hive.ql.Driver.runInternal(Driver.java:1139)\n        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:962)\n        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:957)\n        at org.apache.hive.service.cli.operation.SQLOperation.runInternal(SQLOperation.java:145)\n        at org.apache.hive.service.cli.operation.SQLOperation.access$000(SQLOperation.java:69)\n        at org.apache.hive.service.cli.operation.SQLOperation$1$1.run(SQLOperation.java:200)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at javax.security.auth.Subject.doAs(Subject.java:415)\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1642)\n        at org.apache.hadoop.hive.shims.HadoopShimsSecure.doAs(HadoopShimsSecure.java:502)\n        at org.apache.hive.service.cli.operation.SQLOperation$1.run(SQLOperation.java:213)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n\n{noformat}\n\nThe above exception being converted into a MetaException and re-thrown:\n\n{noformat}\n2015-04-16 13:54:55,486 ERROR hive.ql.exec.DDLTask: org.apache.hadoop.hive.ql.metadata.HiveException: MetaException(message:Got exception: org.apache.thrift.transport.TTransportException Read a negative frame size (-2147418110)!)\n        at org.apache.hadoop.hive.ql.metadata.Hive.getDatabasesByPattern(Hive.java:1141)\n        at org.apache.hadoop.hive.ql.exec.DDLTask.showDatabases(DDLTask.java:2445)\n        at org.apache.hadoop.hive.ql.exec.DDLTask.execute(DDLTask.java:364)\n        at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:153)\n        at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:85)\n        at org.apache.hadoop.hive.ql.Driver.launchTask(Driver.java:1554)\n        at org.apache.hadoop.hive.ql.Driver.execute(Driver.java:1321)\n        at org.apache.hadoop.hive.ql.Driver.runInternal(Driver.java:1139)\n        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:962)\n        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:957)\n        at org.apache.hive.service.cli.operation.SQLOperation.runInternal(SQLOperation.java:145)\n        at org.apache.hive.service.cli.operation.SQLOperation.access$000(SQLOperation.java:69)\n        at org.apache.hive.service.cli.operation.SQLOperation$1$1.run(SQLOperation.java:200)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at javax.security.auth.Subject.doAs(Subject.java:415)\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1642)\n        at org.apache.hadoop.hive.shims.HadoopShimsSecure.doAs(HadoopShimsSecure.java:502)\n        at org.apache.hive.service.cli.operation.SQLOperation$1.run(SQLOperation.java:213)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: MetaException(message:Got exception: org.apache.thrift.transport.TTransportException Read a negative frame size (-2147418110)!)\n        at org.apache.hadoop.hive.metastore.MetaStoreUtils.logAndThrowMetaException(MetaStoreUtils.java:1116)\n        at org.apache.hadoop.hive.metastore.HiveMetaStoreClient.getDatabases(HiveMetaStoreClient.java:839)\n        at org.apache.sentry.binding.metastore.SentryHiveMetaStoreClient.getDatabases(SentryHiveMetaStoreClient.java:60)\n        at sun.reflect.GeneratedMethodAccessor20.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:606)\n        at org.apache.hadoop.hive.metastore.RetryingMetaStoreClient.invoke(RetryingMetaStoreClient.java:90)\n        at com.sun.proxy.$Proxy6.getDatabases(Unknown Source)\n        at org.apache.hadoop.hive.ql.metadata.Hive.getDatabasesByPattern(Hive.java:1139)\n        ... 22 more\n\n{noformat}\n\nThe above MetaException causing the query as a whole to fail:\n\n{noformat}\n2015-04-16 13:54:55,486 ERROR org.apache.hive.service.cli.operation.Operation: Error running hive query:\norg.apache.hive.service.cli.HiveSQLException: Error while processing statement: FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask. MetaException(message:Got exception: org.apache.thrift.transport.TTransportException Read a negative frame size (-2147418110)!)\n        at org.apache.hive.service.cli.operation.SQLOperation.runInternal(SQLOperation.java:148)\n        at org.apache.hive.service.cli.operation.SQLOperation.access$000(SQLOperation.java:69)\n        at org.apache.hive.service.cli.operation.SQLOperation$1$1.run(SQLOperation.java:200)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at javax.security.auth.Subject.doAs(Subject.java:415)\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1642)\n        at org.apache.hadoop.hive.shims.HadoopShimsSecure.doAs(HadoopShimsSecure.java:502)\n        at org.apache.hive.service.cli.operation.SQLOperation$1.run(SQLOperation.java:213)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n\n{noformat}\n\nAn \"out of sequence response\" that occurred shortly after the above exception and may have been triggered by it:\n\n{noformat}\n2015-04-16 13:54:55,498 ERROR hive.log: Got exception: org.apache.thrift.TApplicationException get_databases failed: out of sequence response\norg.apache.thrift.TApplicationException: get_databases failed: out of sequence response\n        at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:76)\n        at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Client.recv_get_databases(ThriftHiveMetastore.java:600)\n        at org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Client.get_databases(ThriftHiveMetastore.java:587)\n        at org.apache.hadoop.hive.metastore.HiveMetaStoreClient.getDatabases(HiveMetaStoreClient.java:837)\n        at org.apache.sentry.binding.metastore.SentryHiveMetaStoreClient.getDatabases(SentryHiveMetaStoreClient.java:60)\n        at sun.reflect.GeneratedMethodAccessor20.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:606)\n        at org.apache.hadoop.hive.metastore.RetryingMetaStoreClient.invoke(RetryingMetaStoreClient.java:90)\n        at com.sun.proxy.$Proxy6.getDatabases(Unknown Source)\n        at org.apache.hadoop.hive.ql.metadata.Hive.getDatabasesByPattern(Hive.java:1139)\n        at org.apache.hadoop.hive.ql.exec.DDLTask.showDatabases(DDLTask.java:2445)\n        at org.apache.hadoop.hive.ql.exec.DDLTask.execute(DDLTask.java:364)\n        at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:153)\n        at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:85)\n        at org.apache.hadoop.hive.ql.Driver.launchTask(Driver.java:1554)\n        at org.apache.hadoop.hive.ql.Driver.execute(Driver.java:1321)\n        at org.apache.hadoop.hive.ql.Driver.runInternal(Driver.java:1139)\n        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:962)\n        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:957)\n        at org.apache.hive.service.cli.operation.SQLOperation.runInternal(SQLOperation.java:145)\n        at org.apache.hive.service.cli.operation.SQLOperation.access$000(SQLOperation.java:69)\n        at org.apache.hive.service.cli.operation.SQLOperation$1$1.run(SQLOperation.java:200)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at javax.security.auth.Subject.doAs(Subject.java:415)\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1642)\n        at org.apache.hadoop.hive.shims.HadoopShimsSecure.doAs(HadoopShimsSecure.java:502)\n        at org.apache.hive.service.cli.operation.SQLOperation$1.run(SQLOperation.java:213)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)\n        at java.util.concurrent.FutureTask.run(FutureTask.java:262)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n\n{noformat}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12737713","id":"12737713","filename":"HIVE-10410.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"created":"2015-06-04T22:29:03.217+0000","size":1478,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12737713/HIVE-10410.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Apparent race condition in HiveServer2 causing intermittent query failures","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"CDH 5.3.3\nCentOS 6.4","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14504016","id":"14504016","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vgumashta","name":"vgumashta","key":"vgumashta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vaibhav Gumashta","active":true,"timeZone":"America/Los_Angeles"},"body":"[~Richard Williams] Can you try with an embedded metastore rather than a remote one? This has been reported for the non-http transport mode as well with remote metastore: HIVE-6893","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vgumashta","name":"vgumashta","key":"vgumashta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vaibhav Gumashta","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-21T00:21:25.985+0000","updated":"2015-04-21T00:21:25.985+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14504025","id":"14504025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmokhtar","name":"mmokhtar","key":"mmokhtar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mmokhtar&avatarId=21863","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mmokhtar&avatarId=21863","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mmokhtar&avatarId=21863","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mmokhtar&avatarId=21863"},"displayName":"Mostafa Mokhtar","active":true,"timeZone":"America/Los_Angeles"},"body":"[~ekoifman] FYI.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmokhtar","name":"mmokhtar","key":"mmokhtar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mmokhtar&avatarId=21863","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mmokhtar&avatarId=21863","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mmokhtar&avatarId=21863","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mmokhtar&avatarId=21863"},"displayName":"Mostafa Mokhtar","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-21T00:30:31.894+0000","updated":"2015-04-21T00:30:31.894+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14504058","id":"14504058","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"body":"In HIVE-10404 the \"out of sequence response\" is caused by threads sharing instance of Hive which effectively shares MetaStoreClient which itself is not thread safe.  Maybe something similar is happening here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-21T00:45:01.235+0000","updated":"2015-04-21T00:45:01.235+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14508162","id":"14508162","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"body":"[~vgumashta] I can confirm that this issue only seems to manifest with a remote metastore.\n\n[~ekoifman] That's what I suspect as well. I was taking a look at the code that implements asynchronous execution of submitted statements in org.apache.hive.service.cli.operation.SqlOperation, and I noticed this suspicious-looking bit of code in the runInternal method:\n\n{noformat}\n// ThreadLocal Hive object needs to be set in background thread.\n// The metastore client in Hive is associated with right user.\nfinal Hive parentHive = getSessionHive();\n// Current UGI will get used by metastore when metsatore is in embedded mode\n// So this needs to get passed to the new background thread\nfinal UserGroupInformation currentUGI = getCurrentUGI(opConfig);\n// Runnable impl to call runInternal asynchronously,\n// from a different thread\nRunnable backgroundOperation = new Runnable() {\n@Override\npublic void run() {\n  PrivilegedExceptionAction<Object> doAsAction = new PrivilegedExceptionAction<Object>() {\n    @Override\n    public Object run() throws HiveSQLException {\n      Hive.set(parentHive);\n      SessionState.setCurrentSessionState(parentSessionState);\n      // Set current OperationLog in this async thread for keeping on saving query log.\n      registerCurrentOperationLog();\n      try {\n        runQuery(opConfig);\n      } catch (HiveSQLException e) {\n        setOperationException(e);\n        LOG.error(\"Error running hive query: \", e);\n      } finally {\n        unregisterOperationLog();\n      }\n      return null;\n    }\n  };\n\n{noformat}\n\nCorrect me if I'm wrong, but it seems to me that passing the parent thread's ThreadLocal Hive object to Hive.set in the children will effectively thwart the usage of ThreadLocal, resulting in the children and the parent all sharing the same Hive object. There are a number of paths in which calls to one of the Hive.get methods result in the current ThreadLocal Hive object being removed from the ThreadLocal map and replaced with a new Hive instance; however, I don't see anything that guarantees that that always happens on the first call to Hive.get in the child threads.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"created":"2015-04-22T23:37:44.097+0000","updated":"2015-04-22T23:37:44.097+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14508195","id":"14508195","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"body":"I think you are right, ThreadLocal in this case doesn't prevent multiple threads sharing a connection.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-23T00:15:11.057+0000","updated":"2015-04-23T00:15:11.057+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14514779","id":"14514779","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"body":"Yep, that was it--after removing the call to Hive.set that passes in the parent's Hive object, the problem went away. \n\nLooking back at SQLOperation's history, it looks like that call was introduced in HIVE-6864 to ensure that user information gets propagated from the thread that submits the asynchronous operation to the pooled thread that executes it. However, HIVE-6907 added a UserGroupInformation.doAs call to the submitted operation that seems as though it should accomplish the same thing without causing the pooled thread to share a connection with the submitting thread. \n\n[~vgumashta] and [~ekoifman], do you agree that HIVE-6907 makes the call to Hive.set unnecessary? If so, I'll regenerate my patch based on the Hive trunk (since we're running Hive 0.13.1, the version I'm currently running was based on that instead) and submit it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"created":"2015-04-27T19:30:30.472+0000","updated":"2015-04-27T19:30:30.472+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14570898","id":"14570898","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"[~Richard Williams] We ran into the same problem and I also think that the sharing Hive object (MetaStoreClient) of parent session in child threads can cause the observed issue. What is your use scenario? Do you have multiple concurrent statements running with same connection?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2015-06-03T14:20:34.151+0000","updated":"2015-06-03T14:20:34.151+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14571864","id":"14571864","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"[~Richard Williams] are you still working on the patch?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2015-06-04T00:01:46.787+0000","updated":"2015-06-04T00:01:46.787+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14572981","id":"14572981","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"I think not only the Hive object, but also sessionState and HiveConf shared in child threads may also cause the race issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2015-06-04T15:33:51.548+0000","updated":"2015-06-04T15:33:51.548+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14573694","id":"14573694","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"body":"[~ctang.ma] Specifically, we have found that this issue occurs whenever numerous JDBC clients (or rather, numerous clients that set the runAsync flag in TExecuteStatementReq to true, as JDBC does) are executing queries against HiveServer2 concurrently, as that is what causes multiple threads in the async execution thread pool to use their shared MetaStoreClient at once. \n\nI'll go ahead and regenerate the patch we've been running based on the Hive trunk. It's very simplistic--it just removes the code that sets the Hive objects in the pooled threads to the Hive object from the calling thread. As for the shared SessionState and HiveConf, those are suspicious as well, and might be causing other problems; however, since we began patching HiveServer2 to prevent the sharing of the Hive object, this particular issue has disappeared for us.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"created":"2015-06-04T22:24:16.763+0000","updated":"2015-06-04T22:24:16.763+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14575005","id":"14575005","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thejas","name":"thejas","key":"thejas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thejas&avatarId=15902","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thejas&avatarId=15902","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thejas&avatarId=15902","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thejas&avatarId=15902"},"displayName":"Thejas M Nair","active":true,"timeZone":"America/Los_Angeles"},"body":"[~Richard Williams]\nAre you sharing the same session for multiple queries in your cluster or set hive.exec.parallel=true ? That is only case where I think this would happen.\nAlso, there is a problem with the change in the patch. The HiveMetaStoreClient within Hive object is associated with a specific user, so if it re-uses any Hive object from the current thread, it would get the wrong user. There is a safeguard against this that was added recently, but it would result in an expensive creation of new Hive object and (hive metastore client).\nI think instead of pursing that option, we should just look at synchronizing thrift client use within metastore client. There is already a HiveMetaStoreClient.newSynchronizedClient that Hive object could use to get a synchronized client.\n\nWe also need to look at other issues like what [~ctang.ma] mentioned, but all of it does not have to happen in this jira.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thejas","name":"thejas","key":"thejas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thejas&avatarId=15902","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thejas&avatarId=15902","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thejas&avatarId=15902","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thejas&avatarId=15902"},"displayName":"Thejas M Nair","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-05T18:51:05.033+0000","updated":"2015-06-05T18:51:05.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14575389","id":"14575389","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"body":"[~thejas] In the test case I use to reproduce this issue, I'm not sharing a session among multiple queries or setting hive.exec.parallel=true. I am, however, using the same session across multiple calls to the HiveServer2 Thrift API--in particular, I'm running many concurrent processes that each open a session, execute an asynchronous operation, poll HiveServer2 for the status of that operation until it completes, and then close their session. I think that what's happening is that the foreground thread is continuing to talk to the metastore using its Hive object while the pooled background thread is executing the asynchronous operation (and thus also using the same Hive object).\n\nRight, the issue you mentioned is what I was talking about in my earlier comment--the patch I uploaded relies on the UserGroupInformation.doAs call in the submitted background operation to ensure that the current user in the background thread is the same as the current user in the foreground thread. Thus, when the background thread calls Hive.get, the call to isCurrentUserOwner will return false if the existing MetaStoreClient is associated with the wrong user and a new connection, this time associated with the correct user, will be created. Presumably the code that does this is the safeguard you're referring to?\n\n{noformat}\n  public static Hive get(HiveConf c, boolean needsRefresh) throws HiveException {\n    Hive db = hiveDB.get();\n    if (db == null || needsRefresh || !db.isCurrentUserOwner()) {\n      if (db != null) {\n        LOG.debug(\"Creating new db. db = \" + db + \", needsRefresh = \" + needsRefresh +\n          \", db.isCurrentUserOwner = \" + db.isCurrentUserOwner());\n      }\n      closeCurrent();\n      c.set(\"fs.scheme.class\", \"dfs\");\n      Hive newdb = new Hive(c);\n      hiveDB.set(newdb);\n      return newdb;\n    }\n\n{noformat}\n\nWe haven't noticed any performance issues attributable to frequent reconnections to the metastore to as a result of this change. Then again, we probably wouldn't; we're using Sentry and thus have HiveServer2 impersonation disabled, so I would expect the current user to always be the user running the HiveServer2 process. When I get a chance, I'll try changing Hive.createMetaStoreClient to wrap the client it creates using HiveMetaStoreClient.newSynchronizedClient instead of removing the code that sets the background thread's Hive object.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"created":"2015-06-05T23:12:30.724+0000","updated":"2015-06-05T23:12:30.724+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14577330","id":"14577330","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ngangam","name":"ngangam","key":"ngangam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Naveen Gangam","active":true,"timeZone":"America/New_York"},"body":"[~thejas] [~ctang.ma] Given this issue and the latest comments, should the patch for HIVE-6893 be committed? It had resolved a few issues for customers that has been running with the fix. Thoughts? Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ngangam","name":"ngangam","key":"ngangam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Naveen Gangam","active":true,"timeZone":"America/New_York"},"created":"2015-06-08T15:18:49.212+0000","updated":"2015-06-08T15:18:49.212+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14606525","id":"14606525","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jxiang","name":"jxiang","key":"jxiang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jimmy Xiang","active":true,"timeZone":"America/Los_Angeles"},"body":"HIVE-10956 fixed some HiveMetaStoreClient sync issue. It should help, in case it is a race to HMS.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jxiang","name":"jxiang","key":"jxiang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jimmy Xiang","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-29T22:12:19.719+0000","updated":"2015-06-29T22:12:19.719+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14644916","id":"14644916","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"body":"[~jxiang] We have been running CDH 5.4.4 (which includes HIVE-10956) without our attached patch to prevent sharing of connections among threads for about two weeks now, and this problem has not reemerged. Unless other people are still running into this issue after applying the patch for HIVE-10956 ([~ctang.ma]?), I think it's safe to say that the patch for HIVE-10956 has fixed this issue as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Richard+Williams","name":"Richard Williams","key":"richard williams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Williams","active":true,"timeZone":"America/Havana"},"created":"2015-07-28T19:42:24.964+0000","updated":"2015-07-28T19:42:24.964+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14649138","id":"14649138","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jxiang","name":"jxiang","key":"jxiang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jimmy Xiang","active":true,"timeZone":"America/Los_Angeles"},"body":"[~rich williams], thanks a lot for reporting the issue, and the verification. I marked the issue fixed for now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jxiang","name":"jxiang","key":"jxiang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jimmy Xiang","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-31T12:05:13.574+0000","updated":"2015-07-31T12:05:13.574+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822499/comment/14743350","id":"14743350","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mvildano","name":"mvildano","key":"mvildano","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marat Vildanov","active":true,"timeZone":"Etc/UTC"},"body":"Is this error fixed for hive 0.13.1 version? We can still observer this issue. Are the parches for https://issues.apache.org/jira/browse/HIVE-10956 issue merged into 0.13.1 hive version?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mvildano","name":"mvildano","key":"mvildano","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marat Vildanov","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-14T10:46:44.777+0000","updated":"2015-09-14T10:46:44.777+0000"}],"maxResults":17,"total":17,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-10410/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2difb:"}}