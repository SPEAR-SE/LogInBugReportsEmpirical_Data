{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12693095","self":"https://issues.apache.org/jira/rest/api/2/issue/12693095","key":"HIVE-6364","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324986","id":"12324986","description":"released","name":"0.13.0","archived":false,"released":true,"releaseDate":"2014-04-21"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-03-18T16:55:16.588+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sun Mar 23 16:56:30 UTC 2014","customfield_12310420":"371681","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_7541091_*|*_1_*:*_2_*:*_4068789571_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-03-23T16:56:30.713+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-6364/watchers","watchCount":5,"isWatching":false},"created":"2014-02-04T12:37:40.098+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12382452","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12382452","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"12630265","key":"HIVE-3969","self":"https://issues.apache.org/jira/rest/api/2/issue/12630265","fields":{"summary":"Session state for hive server should be cleaned-up","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/5","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/trivial.svg","name":"Trivial","id":"5"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-23T16:56:30.752+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12320408","id":"12320408","name":"HiveServer2","description":"Tracks issues related to HiveServer2"}],"timeoriginalestimate":null,"description":"SessionState is created for each session in HS2. If we do any add jars, a class loader is set in the SessionState's conf object. This class loader should also be set in each thread that serves request of the same session.\n\nScenario (both requests are in the same session)-\n{noformat}\n// req 1\nadd jar foo.jar // Served by thread th1, this updates class loader and sets in SessionState.conf\n\n// req2 served by th2, such that th1 != th2\nCREATE TEMPORARY FUNCTION foo_udf AS 'some class in foo.jar' \n// This can throw class not found error, because although \n// the new thread (th2) gets the same session state as th1,\n// the class loader is different (Thread.currentThread.getContextClassLoader()\n\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12626868","id":"12626868","filename":"HIVE-6364.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"created":"2014-02-04T12:57:06.212+0000","size":2661,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12626868/HIVE-6364.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"371981","customfield_12312823":null,"summary":"HiveServer2 - Request serving thread should get class loader from existing SessionState","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693095/comment/13890625","id":"13890625","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"body":"Raised review board request - https://reviews.apache.org/r/17708/","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"created":"2014-02-04T12:56:33.667+0000","updated":"2014-02-04T12:56:33.667+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693095/comment/13890627","id":"13890627","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"body":"attaching patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"created":"2014-02-04T12:57:06.217+0000","updated":"2014-02-04T12:57:06.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693095/comment/13892132","id":"13892132","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"body":"There's another issue - In SessionState.registerJar class loader is obtained from the current thread. If the current thread was used during another session, then the current session can get some jars from that session.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"created":"2014-02-05T14:11:46.731+0000","updated":"2014-02-05T14:11:46.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693095/comment/13939467","id":"13939467","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"Although, HIVE-3969 is marked as duplicate, I don't think it is a duplicate. This one fixes the problem of having right class loader for a thread serving the query, whereas HIVE-3969 talks about unloading registered jars. So, it seems there are two independent problem, both of which needs to be fixed.\n[~jaideepdhok] would you like to rebase your patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-18T16:55:16.588+0000","updated":"2014-03-18T16:55:16.588+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693095/comment/13939592","id":"13939592","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jdere","name":"jdere","key":"jdere","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Dere","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Jaideep, when I tried debugging hiveserver2 due to HIVE-6672, it appeared that there was a thread running for each connection (session).  Non-SQL commands (such as ADD JAR), were being run within this session thread and so the classloader for the session thread had the JARs loaded.  When a SQL command was executed the session thread would start a new thread, and it appeared that this new thread was using the same classloader (and had the added JARs in the classloader's list of URLs). Were you seeing different behavior  in your testing (I was running this on Mac, I think with jdk 1.6, not sure if it would have been different)?\n\nIn the patch, the thread's classloader is getting set to the HiveConf's classloader .. where is the HiveConf's classloader getting set from? Do we need to worry about having to make sure this classloader is updated whenever a JAR is added to the classpath?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jdere","name":"jdere","key":"jdere","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Dere","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-18T18:26:36.092+0000","updated":"2014-03-18T18:26:36.092+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693095/comment/13940018","id":"13940018","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"body":"[~ashutoshc] I will put up a new patch.\n[~jdere] Add jar will always update the class loader. That's the current behaviour. I think the first class loader is set using the conf.getClassLoader method, if nothing is set it will return the default class loader.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaideepdhok","name":"jaideepdhok","key":"jaideepdhok","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaideep Dhok","active":true,"timeZone":"Asia/Singapore"},"created":"2014-03-19T00:42:57.336+0000","updated":"2014-03-19T00:42:57.336+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693095/comment/13941027","id":"13941027","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"I think [~navis] 's patch on HIVE-3969 is more complete and subsumes current patch. So, I guess we should try to get that one and close this one. Although, [~jaideepdhok] 's [earlier point | https://issues.apache.org/jira/browse/HIVE-6364?focusedCommentId=13892132&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13892132] about jars on a thread being visible across session is still there. Though, I am not sure how will that negatively impact query execution and way to fix it. That probably can be taken up as follow-up of HIVE-3969","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-19T21:37:04.101+0000","updated":"2014-03-19T21:37:04.101+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12693095/comment/13944477","id":"13944477","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"Fixed via HIVE-3969","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-23T16:56:30.745+0000","updated":"2014-03-23T16:56:30.745+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-6364/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1s20v:"}}