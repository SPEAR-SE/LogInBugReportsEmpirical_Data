{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13029423","self":"https://issues.apache.org/jira/rest/api/2/issue/13029423","key":"HIVE-15474","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335837","id":"12335837","name":"2.2.0","archived":false,"released":true,"releaseDate":"2017-07-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2016-12-20T13:49:27.638+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jan 06 09:31:44 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_210745_*|*_3_*:*_1_*:*_9146_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_1459806491","customfield_12312321":null,"resolutiondate":"2017-01-06T09:31:44.294+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-15474/watchers","watchCount":6,"isWatching":false},"created":"2016-12-20T11:57:58.475+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335837","id":"12335837","name":"2.2.0","archived":false,"released":true,"releaseDate":"2017-07-25"}],"issuelinks":[{"id":"12489485","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12489485","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12978170","key":"HIVE-14002","self":"https://issues.apache.org/jira/rest/api/2/issue/12978170","fields":{"summary":"Extend limit propagation to subsequent RS operators","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-07-26T00:03:11.532+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12323401","id":"12323401","name":"Physical Optimizer","description":"Optimizations which are dependent on runtime"}],"timeoriginalestimate":null,"description":"The goal is to extend the work started in HIVE-14002.\n\nFor instance, given the following query:\n\n{code:sql}\nexplain\nselect key, value, count(key + 1) as agg1 from src \ngroup by key, value\norder by key, value, agg1 limit 20;\n{code}\n\nWe generate the following physical plan:\n{{TS1 - GBY2 - RS3 - GBY4 - RS5 - SEL6 - LIM7 - FS8}}\n\nWe can push the limit to RS3 operator, as we will generate records for the _top N_ keys, and thus, GBY4 will produce the _top N_ results. However, currently we do not do it.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12845376","id":"12845376","filename":"HIVE-15474.01.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-03T12:27:56.022+0000","size":60941,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12845376/HIVE-15474.01.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12845788","id":"12845788","filename":"HIVE-15474.03.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-05T12:46:52.327+0000","size":64025,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12845788/HIVE-15474.03.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12844057","id":"12844057","filename":"HIVE-15474.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-20T12:01:58.363+0000","size":14409,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12844057/HIVE-15474.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Extend limit propagation for chain of RS-GB-RS operators","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15764250","id":"15764250","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12844057/HIVE-15474.patch\n\n{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 11 failed/errored test(s), 10822 tests executed\n*Failed tests:*\n{noformat}\nTestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=234)\nTestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=39)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_sort_array] (batchId=59)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2653/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2653/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2653/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 11 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12844057 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-12-20T13:49:27.638+0000","updated":"2016-12-20T13:49:27.638+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15764272","id":"15764272","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"body":"[~ashutoshc], could you take a look? Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-20T13:56:44.549+0000","updated":"2016-12-20T13:56:44.549+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15764826","id":"15764826","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xuefuz","name":"xuefuz","key":"xuefuz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Xuefu Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Didn't read the patch, but I'm trying to understand if it's valid to push limit to group by. People frequently use order by and limit get rank functionality.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xuefuz","name":"xuefuz","key":"xuefuz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Xuefu Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-20T18:02:26.940+0000","updated":"2016-12-20T18:02:26.940+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15764900","id":"15764900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"body":"[~xuefuz], thanks for leaving the comment, it would be great if you could take a look at the patch too.\n\nPropagating limit _N_ to GBy is valid iff GBy columns are a prefix of the OBy columns. This is due to the fact that GBy will not produce duplicates for those columns, while Hive implementation based on RS ensures that GBy output actually follows a certain order. Thus, we know that the GBy will output the top _N_ records.\n\nI took a conservative approach as we need to be sure that we remain correct; it might be that the condition could be relaxed even further for some corner cases. However, we should not do it without double checking the theoretical background.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-20T18:35:34.224+0000","updated":"2016-12-20T18:35:34.224+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15765068","id":"15765068","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xuefuz","name":"xuefuz","key":"xuefuz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Xuefu Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~jcamachorodriguez], thanks for the explanation. \n\nRe: GBy will not produce duplicates for those columns, while Hive implementation based on RS ensures that GBy output actually follows a certain order.\n\nThis assumption isn't always true, actually. While MR-styled shuffle has that property (maybe Tez too), but it's not true for Hive on Spark where groups are not necessarily ordered.\n\nNevertheless, I'm still not 100% if there is any impact. In fact, looking at test cases in the patch, I'm sure of the plan difference. Thus, it would be very helpful if you can provide explain output for the example query for both w and w/o the optimization.\n\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xuefuz","name":"xuefuz","key":"xuefuz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Xuefu Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-20T19:43:18.778+0000","updated":"2016-12-20T19:43:18.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15765176","id":"15765176","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"body":"[~xuefuz], thanks for the feedback. It is indeed true for MR and Tez. I am not so familiar with Spark as the backend. If it does not return ordered groups, are you sure the sequence of operators is still RS-GB-RS? That would mean that other optimizations, such as ReduceSinkDeDuplication, do not work properly (\\?). In turn, I would argue that RS is a physical operator that has certain semantics that should be respected, no matter the backend. However, if the sequence of operators is still that one, I can just disable the optimization for Hive on Spark.\n\n--\n\nGiven this query:\n{code:sql}\nexplain\nselect key, value, count(key + 1) as agg1 from src \ngroup by key, value\norder by key, value, agg1 limit 20;\n{code}\n\nExplain plan without patch:\n{code}\nSTAGE DEPENDENCIES:\n  Stage-1 is a root stage\n  Stage-2 depends on stages: Stage-1\n  Stage-0 depends on stages: Stage-2\n\nSTAGE PLANS:\n  Stage: Stage-1\n    Map Reduce\n      Map Operator Tree:\n          TableScan\n            alias: src\n            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE\n            Select Operator\n              expressions: key (type: string), value (type: string), (UDFToDouble(key) + 1.0) (type: double)\n              outputColumnNames: _col0, _col1, _col2\n              Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE\n              Group By Operator\n                aggregations: count(_col2)\n                keys: _col0 (type: string), _col1 (type: string)\n                mode: hash\n                outputColumnNames: _col0, _col1, _col2\n                Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE\n                Reduce Output Operator\n                  key expressions: _col0 (type: string), _col1 (type: string)\n                  sort order: ++\n                  Map-reduce partition columns: _col0 (type: string), _col1 (type: string)\n                  Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE\n                  value expressions: _col2 (type: bigint)\n      Reduce Operator Tree:\n        Group By Operator\n          aggregations: count(VALUE._col0)\n          keys: KEY._col0 (type: string), KEY._col1 (type: string)\n          mode: mergepartial\n          outputColumnNames: _col0, _col1, _col2\n          Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE\n          File Output Operator\n            compressed: false\n            table:\n                input format: org.apache.hadoop.mapred.SequenceFileInputFormat\n                output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\n                serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe\n\n  Stage: Stage-2\n    Map Reduce\n      Map Operator Tree:\n          TableScan\n            Reduce Output Operator\n              key expressions: _col0 (type: string), _col1 (type: string), _col2 (type: bigint)\n              sort order: +++\n              Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE\n              TopN Hash Memory Usage: 0.3\n      Reduce Operator Tree:\n        Select Operator\n          expressions: KEY.reducesinkkey0 (type: string), KEY.reducesinkkey1 (type: string), KEY.reducesinkkey2 (type: bigint)\n          outputColumnNames: _col0, _col1, _col2\n          Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE\n          Limit\n            Number of rows: 20\n            Statistics: Num rows: 20 Data size: 200 Basic stats: COMPLETE Column stats: NONE\n            File Output Operator\n              compressed: false\n              Statistics: Num rows: 20 Data size: 200 Basic stats: COMPLETE Column stats: NONE\n              table:\n                  input format: org.apache.hadoop.mapred.SequenceFileInputFormat\n                  output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\n                  serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe\n\n  Stage: Stage-0\n    Fetch Operator\n      limit: 20\n      Processor Tree:\n        ListSink\n{code}\n\nExplain plan with patch:\n{code}\nSTAGE DEPENDENCIES:\n  Stage-1 is a root stage\n  Stage-2 depends on stages: Stage-1\n  Stage-0 depends on stages: Stage-2\n\nSTAGE PLANS:\n  Stage: Stage-1\n    Map Reduce\n      Map Operator Tree:\n          TableScan\n            alias: src\n            Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE\n            Select Operator\n              expressions: key (type: string), value (type: string), (UDFToDouble(key) + 1.0) (type: double)\n              outputColumnNames: _col0, _col1, _col2\n              Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE\n              Group By Operator\n                aggregations: count(_col2)\n                keys: _col0 (type: string), _col1 (type: string)\n                mode: hash\n                outputColumnNames: _col0, _col1, _col2\n                Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE\n                Reduce Output Operator\n                  key expressions: _col0 (type: string), _col1 (type: string)\n                  sort order: ++\n                  Map-reduce partition columns: _col0 (type: string), _col1 (type: string)\n                  Statistics: Num rows: 500 Data size: 5312 Basic stats: COMPLETE Column stats: NONE\n                  TopN Hash Memory Usage: 0.3\n                  value expressions: _col2 (type: bigint)\n      Reduce Operator Tree:\n        Group By Operator\n          aggregations: count(VALUE._col0)\n          keys: KEY._col0 (type: string), KEY._col1 (type: string)\n          mode: mergepartial\n          outputColumnNames: _col0, _col1, _col2\n          Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE\n          File Output Operator\n            compressed: false\n            table:\n                input format: org.apache.hadoop.mapred.SequenceFileInputFormat\n                output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\n                serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe\n\n  Stage: Stage-2\n    Map Reduce\n      Map Operator Tree:\n          TableScan\n            Reduce Output Operator\n              key expressions: _col0 (type: string), _col1 (type: string), _col2 (type: bigint)\n              sort order: +++\n              Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE\n              TopN Hash Memory Usage: 0.3\n      Reduce Operator Tree:\n        Select Operator\n          expressions: KEY.reducesinkkey0 (type: string), KEY.reducesinkkey1 (type: string), KEY.reducesinkkey2 (type: bigint)\n          outputColumnNames: _col0, _col1, _col2\n          Statistics: Num rows: 250 Data size: 2656 Basic stats: COMPLETE Column stats: NONE\n          Limit\n            Number of rows: 20\n            Statistics: Num rows: 20 Data size: 200 Basic stats: COMPLETE Column stats: NONE\n            File Output Operator\n              compressed: false\n              Statistics: Num rows: 20 Data size: 200 Basic stats: COMPLETE Column stats: NONE\n              table:\n                  input format: org.apache.hadoop.mapred.SequenceFileInputFormat\n                  output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\n                  serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe\n\n  Stage: Stage-0\n    Fetch Operator\n      limit: 20\n      Processor Tree:\n        ListSink\n{code}\n\nObserve the only difference is the TopN annotation in the first stage, which prevents shuffling all the data.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-20T20:32:09.680+0000","updated":"2016-12-20T20:35:27.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15765925","id":"15765925","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xuefuz","name":"xuefuz","key":"xuefuz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Xuefu Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"[~lirui], could you also take a look at the proposal and comment here?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xuefuz","name":"xuefuz","key":"xuefuz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Xuefu Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-21T02:47:27.228+0000","updated":"2016-12-21T02:47:27.228+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15766929","id":"15766929","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lirui","name":"lirui","key":"lirui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Li","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~jcamachorodriguez], I think it's an interesting optimization and please help me understand it better. For groupBy + orderBy query, we'll roughly have the following operator chain (assuming map side aggregation is on - GBY1 and RS2):\n{{GBY1 -- RS2 -- GBY3 -- FS4 -- TS5 -- RS6 -- SEL7 -- FS8}}\nIs the proposal to push the limit into GBY3, so that we'll have less data for the sorting stage? If so, I think that requires the output of GBY3 already being sorted, right? For MR (and probably Tez too) the shuffled data is sorted by key within each partition, which means the input to GBY3 is sorted. So you're implying that given a sorted input, GBY operator will maintain that order in output?\nIf my understanding is correct so far, this will have some problem with Hive on Spark. Because for Spark, the groupBy shuffling doesn't guarantee an order - the input to GBY3 may not be sorted. This makes sense in that groupBy semantic doesn't require a specific ordering. But maybe we can make some change to adapt to this optimization. Actually I'm also wondering: if we use parallel order by (to use a range partitioner rather than a hash partitioner in RS2), we can do the groupBy and orderBy in a single stage, which may improve performance in some cases.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lirui","name":"lirui","key":"lirui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Li","active":true,"timeZone":"Asia/Shanghai"},"created":"2016-12-21T12:24:50.259+0000","updated":"2016-12-21T12:24:50.259+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15782893","id":"15782893","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"body":"[~lirui], sorry for taking some time replying, I was away for a few days.\n\nI have updated the description of this issue to try to explain better what I am trying to do. I think initial description was too brief and vague.\n\nGiven the physical plan you provide, we will propagate the limit from RS4 into RS2 (observe the explain plan above). RS2 produces the _top N_ keys for each partition; thus, GBY3 operator produces only results for those keys. Observe in the patch that there is no change for the GBY operator.\n\nConcerning Spark. My current understanding is that the chain of operators is the same. But I was thinking further about it, and this optimization should not pose any problem in that context, since GBY logic has not changed. If Spark chooses to ignore RS2 since it is not sorting the input for GBY3, that should be fine: the limit is in the RS2 operator, not in GBY3. Spark will not benefit from the optimization, but it still remains correct.\n\n{quote}\nActually I'm also wondering: if we use parallel order by (to use a range partitioner rather than a hash partitioner in RS2), we can do the groupBy and orderBy in a single stage, which may improve performance in some cases.\n{quote}\nIt might be beneficial in some cases indeed. However, it is a complex cost-based decision which would need multiple extensions, as I can think on multiple factors that would influence it, e.g., data skew, number of records for the top N groups, the limit of records itself, etc.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-28T13:36:30.698+0000","updated":"2016-12-28T13:36:30.698+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15786788","id":"15786788","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lirui","name":"lirui","key":"lirui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Li","active":true,"timeZone":"Asia/Shanghai"},"body":"[~jcamachorodriguez], thanks very much for the detailed explanations :) For Spark, the operator chain is something like this:\n{{GBY1 – RS2 – GBY3 – RS4 – SEL5 – FS6}}\nSince RS2 can produce the top N keys, I think this optimization doesn't require the input to GBY3 to be sorted. I mean we still feed the top N keys to GBY3, but after shuffling, those keys may not be in a sorted order. And the result should remain correct. Is that right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lirui","name":"lirui","key":"lirui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Li","active":true,"timeZone":"Asia/Shanghai"},"created":"2016-12-30T03:43:58.670+0000","updated":"2016-12-30T03:43:58.670+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15787225","id":"15787225","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"body":"That is correct :)\n\nI will update the patch to add the new q test to the MiniSparkCliDriver too.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-30T08:42:36.358+0000","updated":"2016-12-30T08:43:25.067+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15795077","id":"15795077","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12845376/HIVE-15474.01.patch\n\n{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 10914 tests executed\n*Failed tests:*\n{noformat}\nTestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=233)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[case_sensitivity] (batchId=61)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[input_testxpath] (batchId=28)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_coalesce] (batchId=75)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_llap_counters] (batchId=136)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)\norg.apache.hive.hcatalog.pig.TestTextFileHCatStorer.testPartColsInData (batchId=172)\norg.apache.hive.hcatalog.pig.TestTextFileHCatStorer.testStoreMultiTables (batchId=172)\norg.apache.hive.hcatalog.pig.TestTextFileHCatStorer.testWriteVarchar (batchId=172)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2764/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2764/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2764/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 9 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12845376 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2017-01-03T13:33:16.922+0000","updated":"2017-01-03T13:33:16.922+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15797276","id":"15797276","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lirui","name":"lirui","key":"lirui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Li","active":true,"timeZone":"Asia/Shanghai"},"body":"Thanks [~jcamachorodriguez] for enabling the Spark test. It looks good to me.\nOne more question, you mentioned the optimization works iff GBy columns are a prefix of the OBy columns. How about when the OBy columns are prefix of GBy columns? Won't the optimization work for that too?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lirui","name":"lirui","key":"lirui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Li","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-04T05:56:54.918+0000","updated":"2017-01-04T05:56:54.918+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15798665","id":"15798665","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"body":"[~lirui], the combination with _ReduceDeduplication_ makes the trick in the case you describe.\n\nConsider the following query:\n{code:sql}\nselect key, value, value2, count(key + 1) as agg1 from src \ngroup by key, value, value2\norder by key, value limit 20;\n{code}\nIn this case, OBy columns are a prefix of GBy columns. RS[4] in this case will end up with columns _key, value, value2_. Then limit will be pushed by the new extension to the RS[2].\n\nAs I stated above, I took a conservative approach as we need to be sure that we remain correct; it might be that the condition could be relaxed even further for some corner cases. However, I did not want to do it without checking the theoretical background further.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-04T16:31:10.370+0000","updated":"2017-01-04T16:31:10.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15800947","id":"15800947","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lirui","name":"lirui","key":"lirui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Li","active":true,"timeZone":"Asia/Shanghai"},"body":"I see. Thanks [~jcamachorodriguez].\nInstead of having another {{checkKeys}}, can we do some refactor to reuse the current one? I think they're essentially the same - checking whether some keys are prefix of another series?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lirui","name":"lirui","key":"lirui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Li","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-05T09:58:04.379+0000","updated":"2017-01-05T09:58:04.379+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15801201","id":"15801201","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"body":"[~ruili], thanks for the feedback.\n\nI have created two methods that are more generic (_checkPrefixKeys_ and _checkPrefixKeysUpstream_) and moved them to ExprNodeDescUtils. Now they rely on the same logic. Could you take a look to the new patch? Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-05T12:09:18.191+0000","updated":"2017-01-05T12:09:18.191+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15801404","id":"15801404","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12845788/HIVE-15474.03.patch\n\n{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 10915 tests executed\n*Failed tests:*\n{noformat}\nTestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=233)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[case_sensitivity] (batchId=61)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[input_testxpath] (batchId=28)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_coalesce] (batchId=75)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_basic] (batchId=134)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=135)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[offset_limit_ppd_optimizer] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=139)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_3] (batchId=92)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2800/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2800/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2800/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 9 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12845788 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2017-01-05T13:56:37.640+0000","updated":"2017-01-05T13:56:37.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15801521","id":"15801521","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"body":"Fails seem unrelated; none of the age=1 failures can be reproduced locally.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-05T14:44:04.864+0000","updated":"2017-01-05T14:44:04.864+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15803369","id":"15803369","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lirui","name":"lirui","key":"lirui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Li","active":true,"timeZone":"Asia/Shanghai"},"body":"Thanks for the update [~jcamachorodriguez]. +1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lirui","name":"lirui","key":"lirui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Li","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-06T03:17:38.532+0000","updated":"2017-01-06T03:17:38.532+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13029423/comment/15804105","id":"15804105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"body":"Pushed to master, thanks for reviewing [~lirui]!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jcamachorodriguez","name":"jcamachorodriguez","key":"jcamachorodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesus Camacho Rodriguez","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-06T09:31:44.637+0000","updated":"2017-01-06T09:31:44.637+0000"}],"maxResults":20,"total":20,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-15474/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i37tin:"}}