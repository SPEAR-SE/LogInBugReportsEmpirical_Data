{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12976265","self":"https://issues.apache.org/jira/rest/api/2/issue/12976265","key":"HIVE-13959","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334255","id":"12334255","name":"2.1.0","archived":false,"released":true,"releaseDate":"2016-06-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2016-06-07T17:46:33.904+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 14 21:26:17 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2669681_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_670616283","customfield_12312321":null,"resolutiondate":"2016-06-14T21:26:17.816+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-13959/watchers","watchCount":2,"isWatching":false},"created":"2016-06-07T02:24:51.962+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-06-21T15:05:59.311+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12317303","id":"12317303","name":"Locking","description":"Issues related to the Locking system"}],"timeoriginalestimate":null,"description":"releaseLocks in MoveTask releases all locks under a HiveLockObject pathNames. But some of locks under this pathNames might be for other queries and should not be released.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12809813","id":"12809813","filename":"HIVE-13959.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2016-06-13T11:09:21.381+0000","size":1996,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12809813/HIVE-13959.1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12808724","id":"12808724","filename":"HIVE-13959.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2016-06-07T17:59:42.291+0000","size":1777,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12808724/HIVE-13959.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12808546","id":"12808546","filename":"HIVE-13959.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2016-06-07T03:08:46.989+0000","size":1777,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12808546/HIVE-13959.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"MoveTask should only release its query associated locks","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15317734","id":"15317734","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"The patch only releases the locks held for MoveTask related query, where the lock was once acquired for this query and in the ctx.getHiveLocks(), so ctx.getHiveLocks().remove(lock) returns true.\nHave done manual tests with two Hive debug sessions running two different queries, and verified that one query with MoveTask does not remove the locks acquired for the other query running in other session.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2016-06-07T03:08:46.992+0000","updated":"2016-06-07T03:08:46.992+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15317735","id":"15317735","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"[~alangates], [~ychena], could you review the patch? Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2016-06-07T03:09:21.633+0000","updated":"2016-06-07T03:09:21.633+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15318990","id":"15318990","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12808546/HIVE-13959.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 26 failed/errored test(s), 10223 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_table_stats\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_create_func1\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert\norg.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_constprog_partitioner\norg.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_auto_sortmerge_join_9\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_bucketsortoptimize_insert_7\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_groupby4_map_skew\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_groupby_bigdata\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_groupby_resolution\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_groupby_sort_1_23\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_join_literals\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_join_merging\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_mapreduce1\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_skewjoinopt2\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_statsfs\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union_remove_19\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union_remove_4\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union_remove_8\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union_view\norg.apache.hive.jdbc.TestJdbcWithLocalClusterSpark.testPermFunc\norg.apache.hive.jdbc.TestJdbcWithMiniMr.testPermFunc\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/31/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/31/console\nTest logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-31/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 26 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12808546 - PreCommit-HIVE-MASTER-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-06-07T17:46:33.904+0000","updated":"2016-06-07T17:46:33.904+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15319023","id":"15319023","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"The TestSparkCliDriver test failures seem not related to this patch, they might be due to infra issue (java.lang.IllegalStateException: Error trying to obtain executor info: java.lang.IllegalStateException: RPC channel is closed.). All other failures are aged and also not related to this patch.\nKick off another run of precommit build test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2016-06-07T17:59:18.290+0000","updated":"2016-06-07T17:59:18.290+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15319241","id":"15319241","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ychena","name":"ychena","key":"ychena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongzhi Chen","active":true,"timeZone":"Etc/UTC"},"body":"[~ctang.ma]\nI do not quite understand how MoveTask releases all locks under a HiveLockObject pathNames.\nIt looks for me as following:\nOne LoadTableDesc object map to one WriteEntity;\none WriteEntity map to one List<HiveLockObj>.\nThese list of HiveLockObj are all created during acquireLocks related to the query.\nIn the releaseLocks code, lockObj.getObj() return HiveLockObject\nList<HiveLock> locks = lockMgr.getLocks(lockObj.getObj(), false, true);\nHiveLockObject equals method need both \npathNames are same and HiveLockObjectData are same. \nHiveLockObjectData equals method need query_id, lock_mode, lock_time... are all same. \nSo I think the locks return by getLocks should all related to the query. \nTherefore, MoveTask has no chance to release other query's locks. \nDo I miss something? \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ychena","name":"ychena","key":"ychena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongzhi Chen","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-07T19:57:53.558+0000","updated":"2016-06-07T19:57:53.558+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15319545","id":"15319545","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12808724/HIVE-13959.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 11 failed/errored test(s), 10223 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_table_stats\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_create_func1\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert\norg.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_constprog_partitioner\norg.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3\norg.apache.hive.jdbc.TestJdbcWithLocalClusterSpark.testPermFunc\norg.apache.hive.jdbc.TestJdbcWithMiniMr.testPermFunc\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/36/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/36/console\nTest logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-36/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 11 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12808724 - PreCommit-HIVE-MASTER-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-06-07T22:02:38.813+0000","updated":"2016-06-07T22:02:38.813+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15319761","id":"15319761","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"[~ychena] Thanks for the review. For your analysis and questions, please see below:\nYes -- one WriteEntity map to one List<HiveLockObj>\nYes -- These list of HiveLockObj are all created during acquireLocks related to the query.\nYes -- In the releaseLocks code, lockObj.getObj() return HiveLockObject\nThe problem is here: List<HiveLock> locks = lockMgr.getLocks(lockObj.getObj(), false, true); it returns all locks under the pathName which might not related to this MoveTask query:\n{code} \nThe getLocks method in ZookeeperHiveLockManager:\nprivate static List<HiveLock> getLocks(HiveConf conf,\n      HiveLockObject key, String parent, boolean verifyTablePartition, boolean fetchData)\n      throws LockException {\n    List<HiveLock> locks = new ArrayList<HiveLock>();\n    List<String> children;\n    boolean recurse = true;\n    String commonParent;\n\n    try {\n      if (key != null) {\n        commonParent = \"/\" + parent + \"/\" + key.getName();\n        children = curatorFramework.getChildren().forPath(commonParent); \n        /* ==> this call returns all locks under commonParent, say db/cdhpart/LOCK-SHARE-000000, db/cdhpart/LOCK-SHARE-000001 for pathNames db/cdhpart */\n        recurse = false;\n      }\n      else {\n        commonParent = \"/\" + parent;\n        children = curatorFramework.getChildren().forPath(commonParent);\n      }\n    } catch (Exception e) {\n      // no locks present\n      return locks;\n    }\n{code}\nFor an example, if we run query1 in one session \"insert overwrite table cdhpart partition (level1= 'l1', level2='l2', level3 = 'l3', level4) select key, value, level4 from cdhsrc;\" and query2 in the other session concurrently \"select * from cdhpart where level1 = 'l1'\"\nquery1 and query2 both have its own znode (lock) under pathNames (db/cdhpart/) say LOCK-SHARE-000000, LOCK-SHARE-000001 respectively, the getLocks for HiveLockObject key with its getName() value db/cdhpart/ will return both LOCK-SHARE-000000, LOCK-SHARE-000001. But LOCK-SHARE-000001 is not in the ctx.getHiveLocks(), the lock list for the query1, so ctx.getHiveLocks().remove() returns false because the HiveLockObjectData.equals always return false due to the different queryStr/queryId, therefore lockMgr.unlock(lock) should not be called to unlock the LOCK-SHARE-000001 for query2.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2016-06-08T00:17:39.330+0000","updated":"2016-06-08T00:17:39.330+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15320673","id":"15320673","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ychena","name":"ychena","key":"ychena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongzhi Chen","active":true,"timeZone":"Etc/UTC"},"body":"It seems that the ZookeeperHiveLockManager may have some issue, it does not store and use HiveLockObjectData\nSee EmbeddedLockManager.java \nhttps://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockManager.java#L403","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ychena","name":"ychena","key":"ychena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongzhi Chen","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-08T14:46:49.485+0000","updated":"2016-06-08T14:46:49.485+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15327164","id":"15327164","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"[~ychena] I made the change in ZookeeperHiveManager as we discussed offline. Please take a look. Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2016-06-13T11:09:21.386+0000","updated":"2016-06-13T11:09:21.386+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15327506","id":"15327506","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12809813/HIVE-13959.1.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 10224 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert\norg.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/106/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/106/console\nTest logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-106/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 4 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12809813 - PreCommit-HIVE-MASTER-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-06-13T14:37:39.572+0000","updated":"2016-06-13T14:37:39.572+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15327551","id":"15327551","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"The failed tests seem not related to the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2016-06-13T15:06:31.906+0000","updated":"2016-06-13T15:06:31.906+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15327753","id":"15327753","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ychena","name":"ychena","key":"ychena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongzhi Chen","active":true,"timeZone":"Etc/UTC"},"body":"After talked with [~ctang.ma], getLocks return all the locks related to the path. It seems a consistent behavior in EmbeddedLockManager\nand ZooKeeperHiveLockManager. \nSo the first patch is a good fix.\n+1 for the fix HIVE-13959.patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ychena","name":"ychena","key":"ychena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongzhi Chen","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-13T17:02:35.454+0000","updated":"2016-06-13T17:02:35.454+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976265/comment/15330647","id":"15330647","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"body":"HIVE-13959.patch has committed to 2.2.0 and 2.1.1. Thanks [~ychena] for review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ctang.ma","name":"ctang.ma","key":"ctang.ma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chaoyu Tang","active":true,"timeZone":"America/New_York"},"created":"2016-06-14T21:26:17.854+0000","updated":"2016-06-14T21:26:17.854+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-13959/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2z23j:"}}