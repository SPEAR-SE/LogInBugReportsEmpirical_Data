{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12906914","self":"https://issues.apache.org/jira/rest/api/2/issue/12906914","key":"HIVE-12228","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-10-27T23:41:38.221+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Oct 28 20:35:27 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_595031858_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-10-28T20:38:22.114+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-12228/watchers","watchCount":2,"isWatching":false},"created":"2015-10-21T23:21:10.281+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326829","id":"12326829","description":"0.13 maintenance release 1","name":"0.13.1","archived":false,"released":true,"releaseDate":"2014-06-06"}],"issuelinks":[{"id":"12447233","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12447233","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12712840","key":"HIVE-7027","self":"https://issues.apache.org/jira/rest/api/2/issue/12712840","fields":{"summary":"Hive job fails when referencing a view that explodes an array","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12447308","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12447308","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12735658","key":"HIVE-7826","self":"https://issues.apache.org/jira/rest/api/2/issue/12735658","fields":{"summary":"Dynamic partition pruning on Tez","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21141&avatarType=issuetype","name":"New Feature","subtask":false,"avatarId":21141}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-10-28T20:38:22.136+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325007","id":"12325007","name":"Hive"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12324798","id":"12324798","name":"Query Planning"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313585","id":"12313585","name":"UDF","description":"This includes the UDFs and UDAFs"}],"timeoriginalestimate":null,"description":"The following simple nested query with UDF returns Struct would fail on Hive 0.13.1 . The UDF java code is attached as {{SimpleStruct.java}}\n\n{noformat}\nADD JAR simplestruct.jar;\nCREATE TEMPORARY FUNCTION simplestruct AS 'test.SimpleStruct';\n\nSELECT *\n  FROM (\n    SELECT *\n    from mytest\n ) subquery\nWHERE simplestruct(subquery.testStr).first\n{noformat}\n\nThe error message is \n{noformat}\nCaused by: org.apache.hadoop.hive.ql.metadata.HiveException: Hive Runtime Error while processing row {\"testint\":1,\"testname\":\"haha\",\"teststr\":\"hehe\"}\n        at org.apache.hadoop.hive.ql.exec.MapOperator.process(MapOperator.java:549)\n        at org.apache.hadoop.hive.ql.exec.mr.ExecMapper.map(ExecMapper.java:177)\n        ... 8 more\nCaused by: java.lang.RuntimeException: cannot find field teststr from [0:_col0, 1:_col1, 2:_col2]\n        at org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorUtils.getStandardStructFieldRef(ObjectInspectorUtils.java:415)\n        at org.apache.hadoop.hive.serde2.objectinspector.StandardStructObjectInspector.getStructFieldRef(StandardStructObjectInspector.java:150)\n..............................\n{noformat}\n\nThe query works fine if we replace the UDF returns Boolean. By comparing the query plan, we note when using the {{SimpleStruct}} UDF, the query plan is \n{noformat}\n          TableScan\n            Select Operator\n              Filter Operator\n                Select Operator\n{noformat}\nThe first Select Operator would rename the columns to {{col_k}}, which cause this trouble. If we use some UDF returns Boolean, the query plan becomes \n{noformat}\n          TableScan\n            Filter Operator\n              Select Operator\n{noformat}\n\nIt looks like the Query Planner failed to push down the Filter Operator when the predicate is based on a UDF returns Struct. \n\nThis bug was fixed in Hive 1.2.1, but we cannot find the ticket to fix it.\n\n\nAppendix: \nThe table {{mytest}} is created in the following way\n{noformat}\nCREATE TABLE mytest(testInt INT, testName STRING, testStr STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY ',' STORED AS TEXTFILE;\n\nLOAD DATA LOCAL INPATH 'test.txt' INTO TABLE mytest;\n{noformat}\nThe file {{test.txt}} is a simple CSV file.\n{noformat}\n1,haha,hehe\n2,my,test\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12767906","id":"12767906","filename":"SimpleStruct.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=freepeter","name":"freepeter","key":"freepeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wenlei Xie","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-10-21T23:22:09.484+0000","size":2521,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12767906/SimpleStruct.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Hive 0.13.1 Error for nested query with UDF returns Struct type","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=freepeter","name":"freepeter","key":"freepeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wenlei Xie","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=freepeter","name":"freepeter","key":"freepeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wenlei Xie","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12906914/comment/14968157","id":"14968157","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=freepeter","name":"freepeter","key":"freepeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wenlei Xie","active":true,"timeZone":"America/Los_Angeles"},"body":"The {{SimpleStruct}} UDF java code to reproduce the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=freepeter","name":"freepeter","key":"freepeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wenlei Xie","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-10-21T23:22:09.488+0000","updated":"2015-10-21T23:22:09.488+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12906914/comment/14977385","id":"14977385","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erwaman","name":"erwaman","key":"erwaman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anthony Hsu","active":true,"timeZone":"America/Los_Angeles"},"body":"This was fixed by HIVE-7027, right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erwaman","name":"erwaman","key":"erwaman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Anthony Hsu","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-10-27T23:41:38.221+0000","updated":"2015-10-27T23:41:38.221+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12906914/comment/14979178","id":"14979178","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=freepeter","name":"freepeter","key":"freepeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wenlei Xie","active":true,"timeZone":"America/Los_Angeles"},"body":"This bug consists of two parts. \n\n1. The query cannot be executed without the predicate pushdown because the column descriptor associated can be changed in an unexpected way during Hive query transformation under some certain conditions.  This was fixed in HIVE-7027. The essence of the patch is an [one line fix|https://github.com/apache/hive/commit/cf2ad57d21a77ad4f6f2deb72a576b90275d6055#diff-e0b3d4ba0783fc2f31724d01aa6f65a7]  fix that makes sure the column description are copied.\n\n2. Hive 0.13.1 didn't perform the predicate pushdown for {{UDF().xx}} because of the following lines in [oah.hive.ql.ppdOpProcFactory.createFilter|https://github.com/apache/hive/blob/branch-0.13/ql/src/java/org/apache/hadoop/hive/ql/ppd/OpProcFactory.java#L706]:\n{code}\n    ExprNodeDesc condn = ExprNodeDescUtils.mergePredicates(preds);\n    if(!(condn instanceof ExprNodeGenericFuncDesc)) {\n      return null;\n    }\n{code}\n\nThis was fixed as a by-product in HIVE-7826, see the [changes to OpProcFactory class |https://github.com/apache/hive/commit/98992da55cbe7b2647bad7bb69f9587c320c805a#diff-3e9f4827f7991810570353623f74f3d9]\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=freepeter","name":"freepeter","key":"freepeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wenlei Xie","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-10-28T20:35:27.789+0000","updated":"2015-10-28T20:35:27.789+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-12228/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2ncof:"}}