{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13002760","self":"https://issues.apache.org/jira/rest/api/2/issue/13002760","key":"HIVE-14705","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334886","id":"12334886","name":"2.0.1","archived":false,"released":true,"releaseDate":"2016-05-25"}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Sep 05 16:58:25 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-14705/watchers","watchCount":2,"isWatching":false},"created":"2016-09-05T16:55:55.560+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329363","id":"12329363","name":"1.1.0","archived":false,"released":true,"releaseDate":"2015-03-07"}],"issuelinks":[{"id":"12489861","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12489861","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13029997","key":"HIVE-15495","self":"https://issues.apache.org/jira/rest/api/2/issue/13029997","fields":{"summary":"subquery's column alias can not be the same with partition column name ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12494177","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12494177","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13042462","key":"HIVE-15888","self":"https://issues.apache.org/jira/rest/api/2/issue/13042462","fields":{"summary":"constant propagation optimizer failed when query has the same alias with subquery","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12479538","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12479538","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12962139","key":"HIVE-13602","self":"https://issues.apache.org/jira/rest/api/2/issue/12962139","fields":{"summary":"TPCH q16 return wrong result when CBO is on","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-02-14T02:56:13.061+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"The following queries show the bug:\n\n*Setup:*\n\n{code}\ncreate table test (a int);\ninsert into test values (7);\n{code}\n\n*Produces Wrong Results:*\n\n{code}\nselect * from (select a-1 as a from test where a=7) z;\n\n+------+--+\n| z.a  |\n+------+--+\n| 7    |\n+------+--+\n{code}\n\n*Produces Correct Results:*\n\n{code}\nselect * from (select a-1 as a1 from test where a=7) z;\n\n+-------+--+\n| z.a1  |\n+-------+--+\n| 6     |\n+-------+--+\n{code}\n\nNote this only happens with subqueries, as the following query returns the correct value of 6 {{select a-1 as a from test where a=7}}\n\nThis affects version 1.1.0 but has been fixed in version 2.1.0 by HIVE-13602","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Hive outer queries is not picking up the right column from subqueries","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13002760/comment/15465410","id":"15465410","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"body":"Details about the fix and the bug are below:\n\n*Background:*\n\nQueries:\n\nQuery 1: {{select * from (select a-1 as a from test where a=7) z}}\nQuery 2: {{select a-1 as a from test where a=7}}\nQuery 3: {{select * from (select a-1 as a1 from test where a=7) z}}\n\nConstant Propagation:\n\n* Constant Propagation in MySQL: https://dev.mysql.com/doc/internals/en/optimizer-constant-propagation.html\n* Expression Folding in MySQL: https://dev.mysql.com/doc/internals/en/optimizer-folding-constants.html\n* Constants can only be propagated from a parent to a child, if an operator has no constants inside it and is passed no constants, then the child operator will see no constants\n\nCode:\n\n* The bug + fix is encapsulated within the Constant Propagate Rule in the RBO - specifically the {{ConstantPropagateProcCtx}} and {{ConstantPropagateProcFactory}} classes\n* The {{ConstantPropagate}} rule walks through the operator tree and invokes the corresponding method in the {{ConstantPropagateProcFactory}} class for each operator\n** For example, if the walker hits a {{FilterOperator}} it invokes the {{ConstantPropagateFilterProc.process}} method - this method is responsible for doing any constant propagation for the given operator\n* Each invocation of the {{process}} method is passed in a shared context called {{ConstantPropagateProcCtx}} which contains a map called {{opToConstantExprs}}; this map is important because it tracks a column to constants mapping; it is updated as constants are propagated\n* {{ConstantPropagateProcFactory.propagate}} propagates constants inside assingment operators, only {{=}} and {{is null}} are supported\n* {{ConstantPropagateProcFactory.foldExprFull}} folds expressions, this essentially evaluates any deterministic UDF operator whose parameters are constants\n* {{ConstantPropagateProcFactory.foldOperator}} looks through the list of propagated constants and tries to replace any columns with their constant equivalent\n\n*Stepping Through Query 1:*\n\n* The {{TableScanOperator}} is processed first, but no constant propagation occurs here\n* The {{FilterOperator}} will be \"folded\" via the {{propagate}} method; basically, this means that the expression {{a = 7}} is added to the map {{opToConstantExprs}}\n* The {{SelectOperator}} from the sub-query is processed next\n** {{ConstantPropagateProcCtx.getPropagatedConstants}} is invoked; this method is responsible for getting all the constants that should be propagated from the parent operators to the current operator, in this case it fetches all the constants from the {{FilterOperator}}\n** {{foldOperator}} is invoked; this method will take the constants from the previous step and replace any columns with there new constant values, so in this case {{a}} is replaced with a value of 7\n** {{foldExprFull}} is invoked; this method will take the {{a - 1}} clause in the select statement and fold it to a value of 6, it can do this because it knows that {{a}} is now a constant with a value of 7\n\n*The Bug:*\n\n* The bug occurs after expression folding is done in the {{ConstantPropagateSelectProc.process}} method, the code doesn't update the {{opToConstantExprs}} map with the new value of {{a}} (it should update it to 6, but it doesn't so the value remains 7)\n* When the walker hits the next {{SelectOperator}} (the one in the outer query), it propagates the value of {{z.a}} as 7, rather than 6\n\n*Why Query 2 Succeeds:*\n\n* The same bug occurs in query 2, but it has no impact because there is only one select operator\n* After {{foldExprFull}} completes, the new column value {{6}} is returned, the operator is updated so that the schema reflects the update, but the map {{opToConstantExprs}} is not updated; since this the last relevant operator that is walked by the Constant Propagate Rule it doesn't matter if the map is up to date or not\n\n*Why Query 3 Succeeds:*\n\n* Query 3 works due to an unrelated bug inside the {{ConstantPropagateProcCtx.resolve}} method\n* The bug causes the {{ConstantPropagateProcCtx.getPropagatedConstants}} to return an empty list when processing the {{SelectOperator}} in the sub-query\n* Since the list returned is empty, the {{opToConstantExprs}} map has no entries for the {{SelectOperator}}, so a failure to update the {{opToConstantExprs}} map doesn't cause any issues\n* This bug causes constant propagation to not occur from the inner {{SelectOperator}} to the outer {{SelectOperator}}\n** Hive is evaluatoing the inner query first and then selecting all of its results\n** It should realize that the {{select *}} clause will always return a value of 6\n** This bug will not cause the query to return incorrect results, but it will have a performance impact\n** The bug is fixed by HIVE-13602, but the changes are non-trivial, the original approach needs to be revised, so for now I am leaving it as is","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-05T16:57:43.398+0000","updated":"2016-09-05T16:57:43.398+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13002760/comment/15465412","id":"15465412","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"body":"Leaving this open in case we want to backport a fix to the 1.1.0 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-05T16:58:25.569+0000","updated":"2016-09-05T16:58:25.569+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-14705/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i33973:"}}