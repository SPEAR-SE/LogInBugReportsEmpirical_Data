{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12543945","self":"https://issues.apache.org/jira/rest/api/2/issue/12543945","key":"HIVE-2821","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2012-05-15T09:19:06.883+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Oct 02 06:47:22 UTC 2012","customfield_12310420":"229183","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_19107906288_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-10-02T06:47:22.051+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-2821/watchers","watchCount":4,"isWatching":false},"created":"2012-02-24T03:02:15.775+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":["optimizer","ql","union"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315150","id":"12315150","description":"released","name":"0.7.0","archived":false,"released":true,"releaseDate":"2011-03-29"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-10-02T06:47:22.061+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"create table src (key string, value string);\ncreate table src1 (key string, value string);\n\nselect count(*) from (\nselect /+mapjoin(b)/ a.*\nfrom src a\njoin \nsrc1 b\non a.key=b.key\nwhere a.key=48\nunion all\nselect /+mapjoin(bb)/ aa.*\nfrom src aa\njoin \nsrc1 bb\non aa.key=bb.key\nwhere aa.key=100\n) t;\n\nFAILED: Hive Internal Error: java.lang.NullPointerException(null)\njava.lang.NullPointerException\nat org.apache.hadoop.hive.ql.optimizer.ppr.PartitionPruner.prune(PartitionPruner.java:156)\nat org.apache.hadoop.hive.ql.optimizer.GenMapRedUtils.setTaskPlan(GenMapRedUtils.java:553)\nat org.apache.hadoop.hive.ql.optimizer.GenMapRedUtils.setTaskPlan(GenMapRedUtils.java:514)\nat org.apache.hadoop.hive.ql.optimizer.GenMapRedUtils.initPlan(GenMapRedUtils.java:125)\nat org.apache.hadoop.hive.ql.optimizer.GenMRRedSink1.process(GenMRRedSink1.java:76)\nat org.apache.hadoop.hive.ql.optimizer.GenMRRedSink3.process(GenMRRedSink3.java:64)\nat org.apache.hadoop.hive.ql.lib.DefaultRuleDispatcher.dispatch(DefaultRuleDispatcher.java:89)\nat org.apache.hadoop.hive.ql.lib.DefaultGraphWalker.dispatch(DefaultGraphWalker.java:88)\nat org.apache.hadoop.hive.ql.parse.GenMapRedWalker.walk(GenMapRedWalker.java:55)\nat org.apache.hadoop.hive.ql.parse.GenMapRedWalker.walk(GenMapRedWalker.java:67)\nat org.apache.hadoop.hive.ql.parse.GenMapRedWalker.walk(GenMapRedWalker.java:67)\nat org.apache.hadoop.hive.ql.parse.GenMapRedWalker.walk(GenMapRedWalker.java:67)\nat org.apache.hadoop.hive.ql.parse.GenMapRedWalker.walk(GenMapRedWalker.java:67)\nat org.apache.hadoop.hive.ql.parse.GenMapRedWalker.walk(GenMapRedWalker.java:67)\nat org.apache.hadoop.hive.ql.parse.GenMapRedWalker.walk(GenMapRedWalker.java:67)\nat org.apache.hadoop.hive.ql.parse.GenMapRedWalker.walk(GenMapRedWalker.java:67)\nat org.apache.hadoop.hive.ql.parse.GenMapRedWalker.walk(GenMapRedWalker.java:67)\nat org.apache.hadoop.hive.ql.lib.DefaultGraphWalker.startWalking(DefaultGraphWalker.java:102)\nat org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.genMapRedTasks(SemanticAnalyzer.java:6946)\nat org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:7247)\nat org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:240)\nat org.apache.hadoop.hive.ql.Driver.compile(Driver.java:431)\nat org.apache.hadoop.hive.ql.Driver.compile(Driver.java:337)\nat org.apache.hadoop.hive.ql.Driver.run(Driver.java:904)\nat org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:279)\nat org.apache.hadoop.hive.cli.CliDriver.processCmd(CliDriver.java:228)\nat org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:417)\nat org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:350)\nat org.apache.hadoop.hive.cli.CliDriver.processReader(CliDriver.java:451)\nat org.apache.hadoop.hive.cli.CliDriver.processFile(CliDriver.java:461)\nat org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:675)\nat org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:585)\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\nat java.lang.reflect.Method.invoke(Method.java:597)\nat org.apache.hadoop.util.RunJar.main(RunJar.java:186)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"12646","customfield_12312823":null,"summary":"union  with two mapjoin will throw NPE ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caofangkun","name":"caofangkun","key":"caofangkun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=caofangkun&avatarId=23151","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=caofangkun&avatarId=23151","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=caofangkun&avatarId=23151","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=caofangkun&avatarId=23151"},"displayName":"caofangkun","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caofangkun","name":"caofangkun","key":"caofangkun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=caofangkun&avatarId=23151","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=caofangkun&avatarId=23151","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=caofangkun&avatarId=23151","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=caofangkun&avatarId=23151"},"displayName":"caofangkun","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux zongren-VirtualBox 3.0.0-14-generic #23-Ubuntu SMP Mon Nov 21 20:34:47 UTC 2011 i686 i686 i386 GNU/Linux\n\njava version \"1.6.0_25\"\n\nhadoop-0.20.2-cdh3u0\n\nhive-0.7.0-cdh3u0","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543945/comment/13275282","id":"13275282","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ransom","name":"ransom","key":"ransom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhiqiang He","active":true,"timeZone":"Asia/Shanghai"},"body":"I tried it in hive 0.8.1 \nselect count(*) from (\nselect /*+ MAPJOIN(b) */ a.* from src a join src1 b on a.key=b.key where a.key=48\nunion all\nselect /*+ MAPJOIN(b) */ aa.* from src aa\njoin src1 bb on aa.key=bb.key where aa.key=100\n) t;\n\nit was success.\ni also tried this:\n\nselect count(1) from (\nselect key,value from (select /*+ MAPJOIN(b) */ a.* from src a join  src1 b on a.key=b.key where a.key=48) t1 \nunion all\n select key,value from (select /*+ MAPJOIN(b) */ aa.* from src aa join src1 bb on aa.key=bb.key where aa.key=100) t2 \n) t3;\n\nit ok.\n\nso It's only happened in hive0.7 version.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ransom","name":"ransom","key":"ransom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhiqiang He","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-05-15T09:19:06.883+0000","updated":"2012-05-15T09:19:06.883+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543945/comment/13276606","id":"13276606","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuzone","name":"yuzone","key":"yuzone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhang Xinyu","active":true,"timeZone":"Etc/UTC"},"body":"hive> explain select count(1) from (    \n    > select key,value from (select /*+ MAPJOIN(b) */ a.key, a.value from src a join src1 b on a.key=b.key) t1 \n    > union all\n    > select key,value from (select /*+ MAPJOIN(bb) */ aa.key, aa.value from src aa join src1 bb on aa.key=bb.key) t2 \n    > ) t3;\nFAILED: Hive Internal Error: java.lang.NullPointerException(null)\njava.lang.NullPointerException\n\tat org.apache.hadoop.hive.ql.optimizer.ppr.PartitionPruner.prune(PartitionPruner.java:170)\n\tat org.apache.hadoop.hive.ql.optimizer.GenMapRedUtils.setTaskPlan(GenMapRedUtils.java:553)\n\tat org.apache.hadoop.hive.ql.optimizer.GenMapRedUtils.setTaskPlan(GenMapRedUtils.java:514)\n\tat org.apache.hadoop.hive.ql.optimizer.GenMapRedUtils.initPlan(GenMapRedUtils.java:125)\n\tat org.apache.hadoop.hive.ql.optimizer.GenMRRedSink1.process(GenMRRedSink1.java:76)\n\tat org.apache.hadoop.hive.ql.optimizer.GenMRRedSink3.process(GenMRRedSink3.java:64)\n\tat org.apache.hadoop.hive.ql.lib.DefaultRuleDispatcher.dispatch(DefaultRuleDispatcher.java:89)\n...\n\nenvironment: hive-05b8af0(0.8.1release); Mac 10.7.3; java 1.6.0_31-b04-415-11M3635.\n\nI debug in eclipse to see how to generate mapjoin plan, find current logic depends on the sequence walk each TableScanOperator.\n\nFor case like: \nTS_1 -> \\\nTS_2 ->  Mapjoin_3 -> \\\n....................TS_4 -> Mapjoin_5\nmust walk TS_1 or TS_2 first, or hive will throw NPE;\n\nFor case like:\nTS_1 -> \\\nTS_2 -> Mapjoin_3 -> Union_4 -> \\\n.....................................TS_5 -> Mapjoin_6\nmust walk TS_5 first, or throw NPE;\n\nWhat i do is to replace \"private HashMap<String, Operator<? extends Serializable>> topOps;\"(in SemanticAnalyzer.java) with \"private LinkedHashMap<String, Operator<? extends Serializable>> topOps;\"  and hack a Transform in Optimizer.java to adjust the sequence of each TSOperator. I tested, it works well.\n\nBut that is not enough for case like Mapjoin union all Mapjoin(map only union) then followed by a reducer. I have another hack, in ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java:\n123c123\n<     if (!seenOps.contains(currTopOp)) {\n---\n>     if (!seenOps.contains(currTopOp) && currTopOp!=null) {\nIt's toooooo hack, and not even tested by running job(its plan from explain is OK). I'm waiting for official patch too.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuzone","name":"yuzone","key":"yuzone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhang Xinyu","active":true,"timeZone":"Etc/UTC"},"created":"2012-05-16T08:52:06.869+0000","updated":"2012-05-16T08:52:06.869+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543945/comment/13467535","id":"13467535","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"No longer reproducible on trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-02T06:47:22.060+0000","updated":"2012-10-02T06:47:22.060+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-2821/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i02isn:"}}