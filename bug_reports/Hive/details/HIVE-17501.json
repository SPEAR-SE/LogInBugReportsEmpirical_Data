{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13101277","self":"https://issues.apache.org/jira/rest/api/2/issue/13101277","key":"HIVE-17501","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2017-09-11 14:17:37.539","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_380164_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-09-11T14:23:57.653+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17501/watchers","watchCount":2,"isWatching":false},"created":"2017-09-11T14:17:37.539+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335838","id":"12335838","description":"Maintenance branch for 2.1 ","name":"2.1.1","archived":false,"released":true,"releaseDate":"2016-12-08"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335837","id":"12335837","name":"2.2.0","archived":false,"released":true,"releaseDate":"2017-07-25"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-09-11T14:23:57.697+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12320810","id":"12320810","name":"Tez","description":"Hive utilizing Tez framework"}],"timeoriginalestimate":null,"description":"Hive2 w/ LLAP on Tez doesn't allow a currently used, default session to be skipped mostly because of this line https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/exec/tez/TezSessionPoolManager.java#L365.\n\nHowever, some clients such as Hue 4, allow multiple sessions to be used per user. Under this configuration, a Thrift client will send a request to either reuse or open a new session. The reuse request could include the session id of a currently used snippet being executed in Hue, this causes HS2 to throw an exception:\n\n{noformat}\n2017-09-10T17:51:36,548 INFO  [Thread-89]: tez.TezSessionPoolManager (TezSessionPoolManager.java:canWorkWithSameSession(512)) - The current user: hive, session user: hive\n2017-09-10T17:51:36,549 ERROR [Thread-89]: exec.Task (TezTask.java:execute(232)) - Failed to execute tez graph.\norg.apache.hadoop.hive.ql.metadata.HiveException: The pool session sessionId=5b61a578-6336-41c5-860d-9838166f97fe, queueName=llap, user=hive, doAs=false, isOpen=true, isDefault=true, expires in 591015330ms should have been returned to the pool\n\tat org.apache.hadoop.hive.ql.exec.tez.TezSessionPoolManager.canWorkWithSameSession(TezSessionPoolManager.java:534) ~[hive-exec-2.1.0.2.6.1.0-129.jar:2.1.0.2.6.1.0-129]\n\tat org.apache.hadoop.hive.ql.exec.tez.TezSessionPoolManager.getSession(TezSessionPoolManager.java:544) ~[hive-exec-2.1.0.2.6.1.0-129.jar:2.1.0.2.6.1.0-129]\n\tat org.apache.hadoop.hive.ql.exec.tez.TezTask.execute(TezTask.java:147) [hive-exec-2.1.0.2.6.1.0-129.jar:2.1.0.2.6.1.0-129]\n\tat org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:197) [hive-exec-2.1.0.2.6.1.0-129.jar:2.1.0.2.6.1.0-129]\n\tat org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:100) [hive-exec-2.1.0.2.6.1.0-129.jar:2.1.0.2.6.1.0-129]\n\tat org.apache.hadoop.hive.ql.exec.TaskRunner.run(TaskRunner.java:79) [hive-exec-2.1.0.2.6.1.0-129.jar:2.1.0.2.6.1.0-129]\n{noformat}\n\nNote that every query is issued as a single 'hive' user to share the LLAP daemon pool, a set of pre-determined number of AMs is initialized at setup time. Thus, HS2 should allow new sessions from a Thrift client to be used out of the pool, or an existing session to be skipped and an unused session from the pool to be returned. The logic to throw an exception in the  `canWorkWithSameSession` doesn't make sense to me.\n\nI have a solution to fix this issue in my local branch at https://github.com/thaibui/hive/commit/078a521b9d0906fe6c0323b63e567f6eee2f3a70. When applied, the log will become like so\n\n{noformat}\n2017-09-10T09:15:33,578 INFO  [Thread-239]: tez.TezSessionPoolManager (TezSessionPoolManager.java:canWorkWithSameSession(533)) - Skipping default session sessionId=6638b1da-0f8a-405e-85f0-9586f484e6de, queueName=llap, user=hive, doAs=false, isOpen=true, isDefault=true, expires in 591868732ms since it is being used.\n{noformat}\n\nA test case is provided in my branch to demonstrate how it works. If possible I would like this patch to be applied to version 2.1, 2.2 and master. Since we are using 2.1 LLAP in production with Hue 4, this patch is critical to our success.\n\nAlternatively, if this patch is too broad in scope, I propose adding an option to allow \"skipping of currently used default sessions\". With this new option default to \"false\", existing behavior won't change unless the option is turned on.\n\nP/s: I'm not an contributor &/ committer, this will be my first time contributing to Hive and the Apache foundation. Any early review is greatly appreciated, thanks!","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Hive should allow default Tez sessions to be skipped","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thai.bui","name":"thai.bui","key":"thai.bui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thai Bui","active":true,"timeZone":"America/Detroit"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thai.bui","name":"thai.bui","key":"thai.bui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thai Bui","active":true,"timeZone":"America/Detroit"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"HDP 2.6.1.0-129, Hue 4.0","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17501/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3jwjr:"}}