{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13144595","self":"https://issues.apache.org/jira/rest/api/2/issue/13144595","key":"HIVE-18940","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-03-13T18:51:07.670+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Mar 30 17:36:58 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18940/watchers","watchCount":6,"isWatching":false},"created":"2018-03-13T02:51:11.022+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340268","id":"12340268","name":"3.0.0","archived":false,"released":true,"releaseDate":"2018-05-21"}],"issuelinks":[{"id":"12529214","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12529214","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13088777","key":"SENTRY-1855","self":"https://issues.apache.org/jira/rest/api/2/issue/13088777","fields":{"summary":"Improve scalability of permission delta updates","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12529215","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12529215","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13079310","key":"HIVE-16886","self":"https://issues.apache.org/jira/rest/api/2/issue/13079310","fields":{"summary":"HMS log notifications may have duplicated event IDs if multiple HMS are running concurrently","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-30T17:36:58.898+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312584","id":"12312584","name":"Metastore","description":"Tracks issue dealing with metastore."}],"timeoriginalestimate":null,"description":"The implementation of DbNotificationListener uses a single row to store current notification ID and uses {{SELECT FOR UPDATE}} to lock the row. This serializes all write DDL operations which isn't good.\r\n\r\nWe should consider using database auto-increment for notification ID instead. Especially on mMySQL/innoDb it is supported natively with relatively light-weight locking. \r\n\r\nThis creates potential issue for consumers though because such IDs may have holes. There are two types of holes - transient hole for a transaction which have not committed yet and will be committed shortly and permanent holes for transactions that fail. Consumers need to deal with it. It may be useful to add DB-generated timestamp as well to assist in recovery from holes.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Hive notifications serialize all write DDL operations","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[{"id":"13149208","key":"HIVE-19086","self":"https://issues.apache.org/jira/rest/api/2/issue/13149208","fields":{"summary":"Write notifications in bulk only when commitTransaction actually commits","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16396451","id":"16396451","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"body":"[~LinaAtAustin] [~kkalyan] [~spena] FYI.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-13T02:51:43.685+0000","updated":"2018-03-13T02:51:43.685+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16397463","id":"16397463","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thejas","name":"thejas","key":"thejas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thejas&avatarId=15902","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thejas&avatarId=15902","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thejas&avatarId=15902","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thejas&avatarId=15902"},"displayName":"Thejas M Nair","active":true,"timeZone":"America/Los_Angeles"},"body":"For replication purposes, and perhaps for sentry delta updates capture as well, the EVENT_ID has to be in the order of commit.\r\nFor example, if the EVENT_ID 5 has been written and then consumed by replication program, it would then only look for rows where EVENT_ID > 5. So if there are two concurrent transactions writing new rows and one of them with EVENT_ID 5 commits before EVENT_ID 4, then EVENT_ID 4 would get missed.\r\nHoles would be OK, what is not OK is that for another application to see row with EVENT_ID 5 getting visible before one with EVENT_ID 4.\r\n\r\nDB generated timestamp has same issue, unless it can represent the commit sequence.\r\n\r\nI believe the use of database autoincrement field was considered in HIVE-16886 and it wasn't meeting this criteria. \r\n\r\ncc [~anishek]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thejas","name":"thejas","key":"thejas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thejas&avatarId=15902","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thejas&avatarId=15902","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thejas&avatarId=15902","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thejas&avatarId=15902"},"displayName":"Thejas M Nair","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-13T18:51:07.670+0000","updated":"2018-03-13T18:54:33.761+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16398036","id":"16398036","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"body":"[~thejas] Yes, you are correct, this is a nice assumption to work from, the only problem is that there is no way we can guarantee it *and* avoid global synchronization of all write HMS events. This means that we need to think about alternative solutions that can relax the accepted behavior of notification stream. We might provide both 'strict' and 'relaxed' modes, which is Ok, but complicates HMS even more because we may need different tables and HM methods to implement the two.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-14T03:19:14.572+0000","updated":"2018-03-14T03:19:14.572+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16399869","id":"16399869","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"body":"I think part of the issue is that the event id generation mechanism is done using a different table which always has 1 row {{NOTIFICATION_SEQUENCE}} Why can't we use auto-increment directly on the {{NOTIFICATION_LOG}} table for event id? I know derby doesn't support auto-increment but I think most production clusters will be not using derby. Designing a feature just to make it work for derby does not seem to be a good idea. If derby doesn't support auto-increments we should treat it as an exception and handle that in the code separately. We should also separate event ID and commit id for an event. Currently, the event id is strictly tied with the actual commit time which is why we have to hold the lock at the generation time until the transaction commits which in theory could take a long time. Also, the timing of generating the event id and actual commit is non-obvious in the code. So it is easy to miss that while writing the code.\r\n\r\nI think it would be great to use something like auto-increment to just uniquely identify a notification log message. The actual commit id should be generated from a global monotonically increasing number at the actual commit time. This number should apply to all the events pertaining to that transaction. A transaction which alters 1000 partitions should not have 1000 different ids because they were not committed one by one in 1000 transactions. They were all committed as one transaction and hence ideally should only generate one commit id. This would greatly help with the lock durations for long transactions because now commit lock is held for a constant time irrespective of how long that transaction ran.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-15T03:38:01.639+0000","updated":"2018-03-15T03:38:01.639+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16399904","id":"16399904","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anishek","name":"anishek","key":"anishek","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"anishek","active":true,"timeZone":"Asia/Kolkata"},"body":"having a separate global commit id might not solve the problem since association between the events ( if we use auto increment ) and the global commit has to be done in the same txn. Also since we cant have ordering of the commit ids different to the point of commits, lock on this table will have to be taken to make sure one txn commits before the other one can commit.  if there was some way to do fine grained control such that txn's with commit ids fire the db (COMMIT sql statement) in order of their id's. We can trim down the time the lock is taken by doing some directsql and putting in commit-id based ordering, which again across multiple metastores would add latency to the whole process. \r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anishek","name":"anishek","key":"anishek","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"anishek","active":true,"timeZone":"Asia/Kolkata"},"created":"2018-03-15T04:37:31.646+0000","updated":"2018-03-15T04:37:31.646+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16399924","id":"16399924","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"body":"[~vihangk1] The major problem with all auto-increment approaches is that clients have to deal with holes in the stream of IDs and the hole can be temporary (there is transaction in flight) or permanent (transaction failed). I am not convinced that we must produce events in the commit order but it is important to not loose events (and guarantee that within a session the order is preserved).\r\n\r\nSessions usually have a nice property that they send some operations to HMS, wait for completion and only then send another one. Interleaving ordering between different sessions should be fine. Unfortunately, HMS APIs do not include any session ID (otherwise we could use it to partition locks).\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-15T05:13:59.586+0000","updated":"2018-03-15T05:13:59.586+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16400948","id":"16400948","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"body":"I think may be I didn't make my suggestion very clear. I did not suggest using auto-increment for commit id. auto-increment is just use to uniquely identify an event. This useful because now we are adding tons of information in one event. So instead of creating one giant event we can create several small events. The relationship between a commit id and event id is one to many. There could be many event ids associated with one commit id. The commit id itself is a monotonically increasing global number generated just before a transaction does an actual commit. Here is the pseudo code of my suggestion above:\r\n\r\nModify NOTIFICATION_LOG to add a new field CommitID\r\n\r\nModify NOTIFICATION_LOG table such that EVENT_ID is an auto-increment\r\n\r\nRemove the use of NOTIFICATION_SEQUENCE (or perhaps we can reuse it to generate commit id)\r\n\r\nNow here is how the methods generating events might look like\r\n{code:java}\r\npublic someMethodWhichGeneratesEvents() {\r\nList<Event> allEventsInThisTransaction;\r\nopenTransaction(allEventsInThisTransaction);\r\n//do some work which adds events to allEventsInThisTransaction\r\n//openTransaction again; pass the allEventsInThisTransaction\r\nopenTransaction(allEventsInThisTransaction);\r\n//dummy commit\r\ncommit(allEventsInThisTransaction);\r\n//actual commit\r\ncommit(allEventsInThisTransaction);\r\n}\r\n{code}\r\n The commits would look like this\r\n  \r\n{code:java}\r\npublic boolean commit(List<Event> eventsInThisTransaction) {\r\ncounter--;\r\n//if this is an actual commit\r\nif (counter == 0) {\r\n//generate one monotonically increasing number from database\r\n//same logic as used for generating event id currently from NOTIFICATION_SEQUENCE table\r\n//lock is held for a constant time irrespective of how many events this transaction generates\r\ncommitId = getCommitID();\r\n//add events\r\nfor (Event event : eventsInThisTransaction) {\r\n  event.setCommitId(commitID);\r\n  addNotificationEvent(event);\r\n}\r\nreturn pm.commit();\r\n}\r\n{code}\r\n \r\n\r\nSo if the commit fails, no events are generated. If the commit succeeds all the events are generated with unique event ids and the same commit id. If there are holes in commit id, it means that the transaction has failed and is guaranteed never to be filled.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-15T18:46:27.344+0000","updated":"2018-03-15T20:17:59.501+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16405155","id":"16405155","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asherman","name":"asherman","key":"asherman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=asherman&avatarId=31918","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=asherman&avatarId=31918","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=asherman&avatarId=31918","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=asherman&avatarId=31918"},"displayName":"Andrew Sherman","active":true,"timeZone":"America/Los_Angeles"},"body":"The restriction that  the EVENT_ID has to be in the order of commit is presumably having a major impact on concurrency in the HMS DBMS. It effectively serializes avery transaction. Has there been any thought to relaxing this restriction? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asherman","name":"asherman","key":"asherman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=asherman&avatarId=31918","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=asherman&avatarId=31918","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=asherman&avatarId=31918","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=asherman&avatarId=31918"},"displayName":"Andrew Sherman","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-19T17:25:31.297+0000","updated":"2018-03-19T17:25:31.297+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16405643","id":"16405643","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thejas","name":"thejas","key":"thejas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thejas&avatarId=15902","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thejas&avatarId=15902","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thejas&avatarId=15902","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thejas&avatarId=15902"},"displayName":"Thejas M Nair","active":true,"timeZone":"America/Los_Angeles"},"body":"[~vihangk1]'s approach of accumulating the events and only getting the lock towards end seems like a reasonable way to reduce the duration lock is held to a very small time, for metastore calls that lead to several events. Other parts of the transactions can go ahead in parallel.\r\nIt doesn't have to use same commitID for all events, getting new values should be OK, as long as the lock on NOTIFICATION_SEQUENCE is obtained at the end.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thejas","name":"thejas","key":"thejas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thejas&avatarId=15902","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thejas&avatarId=15902","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thejas&avatarId=15902","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thejas&avatarId=15902"},"displayName":"Thejas M Nair","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-20T00:29:45.248+0000","updated":"2018-03-20T00:29:45.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16408289","id":"16408289","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"body":"Another improvement based on [~akolb]'s suggestion above is to break the lock for each unique {{dbname.tblname}} pair and generate the commit ids specific to that individual entity. So instead of having one row blocking the whole world in NOTIFICATION_SEQUENCE table, it would now have multiple rows one for each table. This would obviously mean that clients will have to smarter and will need to store the last commit id on an individual table basis. Since this will be a change of behavior, this will have to be done using a configurable option so that existing clients can still use the current way and move to the later when they are ready by switching the config. The biggest advantage of this approach is that practically no transaction will ever block since conflicting transactions are not allowed in the first place using ZK locks at the query compilation time. The disadvantage here is added complexity on both server and client side. Server needs to handle corner cases well (create/drop database events). Clients will need added logic to store the commit id on an individual table level.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-21T17:22:52.145+0000","updated":"2018-03-21T17:22:52.145+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16420734","id":"16420734","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"body":"One immediate improvement that we can make that will help somewhat.\r\n\r\n# Collect all notifications in the ObjectStore instance\r\n# When commitTransaction() really does a commit push all notifications in one shot using bulk update.\r\n\r\nThis should reduce the amount of time the lock is held.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-30T17:20:05.770+0000","updated":"2018-03-30T17:20:05.770+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16420741","id":"16420741","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"body":"As [~vihangk1] noticed the problem is even worse since DbNotifictionListener also does file system calls as part of creating notifications and these can significantly increase the hold time for the lock.\r\n\r\nAlso note that any consumer (e.g. replication) who tries to get last notification ID will be blocked as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-30T17:24:51.704+0000","updated":"2018-03-30T17:24:51.704+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16420745","id":"16420745","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"body":"[~akolb] the pseudo code in my comment above collects the events until the actual commit time. Is that not what you suggested? I can take a stab at this based on the suggestions above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-30T17:29:00.865+0000","updated":"2018-03-30T17:29:00.865+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16420752","id":"16420752","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"body":"[~vihangk1] Pretty much what you suggested - I am just thinking that we can make just this change until we figure out some bigger change that may require client changes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-30T17:35:47.475+0000","updated":"2018-03-30T17:35:47.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144595/comment/16420755","id":"16420755","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"body":"Another interesting question - is it possible to do expensive work (like listing file systems, etc) outside of the transaction altogether?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-30T17:36:58.898+0000","updated":"2018-03-30T17:36:58.898+0000"}],"maxResults":15,"total":15,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18940/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3r7mn:"}}