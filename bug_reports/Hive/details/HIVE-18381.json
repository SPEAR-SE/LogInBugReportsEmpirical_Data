{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13128688","self":"https://issues.apache.org/jira/rest/api/2/issue/13128688","key":"HIVE-18381","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jan 05 07:28:44 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18381/watchers","watchCount":1,"isWatching":false},"created":"2018-01-05T03:26:12.346+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329363","id":"12329363","name":"1.1.0","archived":false,"released":true,"releaseDate":"2015-03-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wmky_kk","name":"wmky_kk","key":"wmky_kk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"youchuikai","active":true,"timeZone":"Asia/Shanghai"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-01-05T07:30:04.262+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325007","id":"12325007","name":"Hive"}],"timeoriginalestimate":null,"description":"\r\n\r\n{code:sql}\r\n// the push user belong to the test_rw group\r\nhive> dfs -getfacl /user/hive/warehouse1/test1.db;\r\n# file: /user/hive/warehouse1/test1.db\r\n# owner: root\r\n# group: hive\r\nuser::rwx\r\ngroup::rwx\r\ngroup:test_r:r-x\r\ngroup:test_rw:rwx\r\nmask::rwx\r\nother::---\r\ndefault:user::rwx\r\ndefault:group::rwx\r\ndefault:group:test_r:r-x\r\ndefault:group:test_rw:rwx\r\ndefault:mask::rwx\r\ndefault:other::---\r\n\r\nhive> drop table test1.youck_66;\r\nFAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask. MetaException(message:Table metadata not deleted since hdfs://nameservice-test1/user/hive/warehouse1/test1.db is not writable by push)\r\n{code}\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Drop table operation isn't consider that hdfs acl privilege of the table location parent path  ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wmky_kk","name":"wmky_kk","key":"wmky_kk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"youchuikai","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wmky_kk","name":"wmky_kk","key":"wmky_kk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"youchuikai","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"hive-1.1.0-cdh5.8.4","customfield_12313520":null,"customfield_12311020":null,"duedate":"2018-01-31","customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13128688/comment/16312602","id":"16312602","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wmky_kk","name":"wmky_kk","key":"wmky_kk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"youchuikai","active":true,"timeZone":"Asia/Shanghai"},"body":"*fix this bug.*\r\n{code:java}\r\nIndex: src/main/java/org/apache/hadoop/hive/metastore/Warehouse.java\r\nIDEA additional info:\r\nSubsystem: com.intellij.openapi.diff.impl.patch.CharsetEP\r\n<+>UTF-8\r\n===================================================================\r\n--- src/main/java/org/apache/hadoop/hive/metastore/Warehouse.java\t(date 1515137061000)\r\n+++ src/main/java/org/apache/hadoop/hive/metastore/Warehouse.java\t(date 1515137079737)\r\n@@ -43,6 +43,8 @@\r\n import org.apache.hadoop.fs.FileStatus;\r\n import org.apache.hadoop.fs.FileSystem;\r\n import org.apache.hadoop.fs.Path;\r\n+import org.apache.hadoop.fs.permission.AclEntry;\r\n+import org.apache.hadoop.fs.permission.AclStatus;\r\n import org.apache.hadoop.fs.permission.FsAction;\r\n import org.apache.hadoop.hive.common.FileUtils;\r\n import org.apache.hadoop.hive.common.HiveStatsUtils;\r\n@@ -250,8 +252,10 @@\r\n             return false;\r\n         }\r\n         final FileStatus stat;\r\n+        final AclStatus aclStas;\r\n         try {\r\n             stat = getFs(path).getFileStatus(path);\r\n+            aclStas = getFs(path).getAclStatus(path);\r\n         } catch (FileNotFoundException fnfe){\r\n             // File named by path doesn't exist; nothing to validate.\r\n             return true;\r\n@@ -266,23 +270,38 @@\r\n         } catch (LoginException le) {\r\n             throw new IOException(le);\r\n         }\r\n-        String user = ugi.getShortUserName();\r\n+        String user = ugi.getShortUserName();   // kaikai\r\n+        String[] groups = ugi.getGroupNames(); // groups 获取的是metastore的组用户信息。\r\n         //check whether owner can delete\r\n         if (stat.getOwner().equals(user) &&\r\n                 stat.getPermission().getUserAction().implies(FsAction.WRITE)) {\r\n             return true;\r\n         }\r\n+\r\n         //check whether group of the user can delete\r\n         if (stat.getPermission().getGroupAction().implies(FsAction.WRITE)) {\r\n-            String[] groups = ugi.getGroupNames();\r\n             if (ArrayUtils.contains(groups, stat.getGroup())) {\r\n                 return true;\r\n             }\r\n         }\r\n+\r\n         //check whether others can delete (uncommon case!!)\r\n         if (stat.getPermission().getOtherAction().implies(FsAction.WRITE)) {\r\n             return true;\r\n         }\r\n+\r\n+        // add extra\r\n+        List<AclEntry> list = aclStas.getEntries();\r\n+        for (AclEntry aclEntry : list){\r\n+            if (aclEntry.getScope().toString() != \"DEFAULT\" && aclEntry.getPermission().implies(FsAction.WRITE) && aclEntry.getName() != \"null\"){\r\n+                if (aclEntry.getType().toString() == \"USER\" && aclEntry.getName().equals(user)){\r\n+                    LOG.info(\"acl user is\" + aclEntry.getName() + \";\" + \"hive cli user is \" + user);\r\n+                    return true;\r\n+                } else if (aclEntry.getType().toString() == \"GROUP\" && ArrayUtils.contains(groups, aclEntry.getName())){\r\n+                    return true;\r\n+                }\r\n+            }\r\n+        }\r\n         return false;\r\n     }\r\n   /*\r\n\r\n{code}\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wmky_kk","name":"wmky_kk","key":"wmky_kk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"youchuikai","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-01-05T07:28:44.824+0000","updated":"2018-01-05T07:28:44.824+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18381/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3ojjb:"}}