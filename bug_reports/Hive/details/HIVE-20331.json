{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13177461","self":"https://issues.apache.org/jira/rest/api/2/issue/13177461","key":"HIVE-20331","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12343343","id":"12343343","name":"4.0.0","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-08-08T18:16:29.643+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 16 18:25:16 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_82536898_*|*_3_*:*_1_*:*_30010_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_2_*:*_698354699","customfield_12312321":null,"resolutiondate":"2018-08-16T18:25:16.579+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-20331/watchers","watchCount":2,"isWatching":false},"created":"2018-08-07T17:29:55.008+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335838","id":"12335838","description":"Maintenance branch for 2.1 ","name":"2.1.1","archived":false,"released":true,"releaseDate":"2016-12-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-08-16T18:25:16.606+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12323401","id":"12323401","name":"Physical Optimizer","description":"Optimizations which are dependent on runtime"}],"timeoriginalestimate":null,"description":"The following query with Union, Lateral view and Join will fail during execution with the exception below.\r\n{noformat}\r\ncreate table t1(col1 int);\r\nSELECT 1 AS `col1`\r\nFROM t1\r\nUNION ALL\r\n  SELECT 2 AS `col1`\r\n  FROM\r\n    (SELECT col1\r\n     FROM t1\r\n    ) x1\r\n    JOIN\r\n      (SELECT col1\r\n      FROM\r\n        (SELECT \r\n          Row_Number() over (PARTITION BY col1 ORDER BY col1) AS `col1`\r\n        FROM t1\r\n        ) x2 lateral VIEW explode(map(10,1))`mapObj` AS `col2`, `col3`\r\n      ) `expdObj`      \r\n{noformat}\r\n\r\n{noformat}\r\nCaused by: org.apache.hadoop.hive.ql.metadata.HiveException: Hive internal error: cannot find parent in the child operator!\r\n        at org.apache.hadoop.hive.ql.exec.Operator.initialize(Operator.java:362) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]\r\n        at org.apache.hadoop.hive.ql.exec.MapOperator.initializeMapOperator(MapOperator.java:509) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]\r\n        at org.apache.hadoop.hive.ql.exec.mr.ExecMapper.configure(ExecMapper.java:116) ~[hive-exec-4.0.0-SNAPSHOT.jar:4.0.0-SNAPSHOT]\r\n{noformat}\r\n\r\nAfter debugging, seems we have issues in GenMRFileSink1 class in which we are setting incorrect aliasToWork to the MapWork.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12935042","id":"12935042","filename":"HIVE-20331.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-09T21:04:50.436+0000","size":6886,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12935042/HIVE-20331.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Query with union all, lateral view and Join fails with \"cannot find parent in the child operator\"","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13177461/comment/16573453","id":"16573453","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"body":"patch-1: The MR physical optimizer traverses the operator tree to generate the MR tasks starting from top TS operators. During the traverse, GenMRProcContext context is shared to carry over some necessary info across the optimizer rules, while some of the info like currUnionOp should be reset when the new TS is visited, otherwise, when the descendent  operators of such new TS were visited,  they would incorrectly refer to previous currUnionOp and later GenMRFileSink1 would incorrectly optimize Union plan.\r\n\r\nThis patch resets some fields in the GenMRProcContext when the new TS is visited.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-08T16:25:31.900+0000","updated":"2018-08-08T16:25:31.900+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13177461/comment/16573638","id":"16573638","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"| (/) *{color:green}+1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n|| || || || {color:brown} master Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  8m 18s{color} | {color:green} master passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m  3s{color} | {color:green} master passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 38s{color} | {color:green} master passed {color} |\r\n| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  3m 58s{color} | {color:blue} ql in master has 2305 extant Findbugs warnings. {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 55s{color} | {color:green} master passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  1m 23s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m  4s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  1m  4s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 37s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  4m  2s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 56s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 12s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black} 23m 38s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Optional Tests |  asflicense  javac  javadoc  findbugs  checkstyle  compile  |\r\n| uname | Linux hiveptest-server-upstream 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /data/hiveptest/working/yetus_PreCommit-HIVE-Build-13104/dev-support/hive-personality.sh |\r\n| git revision | master / 7dce7b7 |\r\n| Default Java | 1.8.0_111 |\r\n| findbugs | v3.0.0 |\r\n| modules | C: ql U: ql |\r\n| Console output | http://104.198.109.242/logs//PreCommit-HIVE-Build-13104/yetus.txt |\r\n| Powered by | Apache Yetus    http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2018-08-08T18:16:29.643+0000","updated":"2018-08-08T18:16:29.643+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13177461/comment/16575383","id":"16575383","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"body":"Seems there is a glitch causing the job result not posted. https://builds.apache.org/job/PreCommit-HIVE-Build/13104/. All the tests passed but I will retrigger it.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-09T21:04:27.175+0000","updated":"2018-08-09T21:04:27.175+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13177461/comment/16575730","id":"16575730","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"| (/) *{color:green}+1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n|| || || || {color:brown} master Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  8m 32s{color} | {color:green} master passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m  8s{color} | {color:green} master passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 39s{color} | {color:green} master passed {color} |\r\n| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  4m  6s{color} | {color:blue} ql in master has 2305 extant Findbugs warnings. {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 58s{color} | {color:green} master passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  1m 24s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m  8s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  1m  8s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 40s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  4m 13s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 58s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 14s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black} 24m 30s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Optional Tests |  asflicense  javac  javadoc  findbugs  checkstyle  compile  |\r\n| uname | Linux hiveptest-server-upstream 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /data/hiveptest/working/yetus_PreCommit-HIVE-Build-13139/dev-support/hive-personality.sh |\r\n| git revision | master / 3dc736f |\r\n| Default Java | 1.8.0_111 |\r\n| findbugs | v3.0.0 |\r\n| modules | C: ql U: ql |\r\n| Console output | http://104.198.109.242/logs//PreCommit-HIVE-Build-13139/yetus.txt |\r\n| Powered by | Apache Yetus    http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2018-08-10T03:43:43.833+0000","updated":"2018-08-10T03:43:43.833+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13177461/comment/16575741","id":"16575741","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12935042/HIVE-20331.1.patch\n\n{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.\n\n{color:green}SUCCESS:{color} +1 due to 14874 tests passed\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/13139/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/13139/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-13139/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.YetusPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12935042 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2018-08-10T04:17:12.506+0000","updated":"2018-08-10T04:17:12.506+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13177461/comment/16576858","id":"16576858","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~aihuaxu] Do you know how does this relate to the code in {{GenMRRedSink3}} which resets the unionOp at this line [https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRRedSink3.java#L108]\r\n\r\nIs this Rule not triggered for some reason? Can you please post the original plan before the patch and after the patch? Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-10T21:19:10.912+0000","updated":"2018-08-10T21:19:10.912+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13177461/comment/16576918","id":"16576918","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"body":"GenMRRedSink3 won't get triggered in this case (it's triggered in union followed by RS operator).\r\n\r\nHere are the plans with and without the patch. As you can see, the union operator is incorrectly to Stage-4.\r\n\r\nBefore:\r\n{noformat}\r\nSTAGE DEPENDENCIES:\r\n  Stage-4 is a root stage\r\n  Stage-6 depends on stages: Stage-4\r\n  Stage-2 depends on stages: Stage-6\r\n  Stage-0 depends on stages: Stage-2\r\n\r\nSTAGE PLANS:\r\n  Stage: Stage-4\r\n    Map Reduce\r\n      Map Operator Tree:\r\n          TableScan\r\n            alias: t1\r\n            Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n            Reduce Output Operator\r\n              key expressions: col1 (type: int)\r\n              sort order: +\r\n              Map-reduce partition columns: col1 (type: int)\r\n              Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n          TableScan\r\n            Union\r\n              Statistics: Num rows: 10 Data size: 88 Basic stats: COMPLETE Column stats: PARTIAL\r\n              File Output Operator\r\n                compressed: false\r\n                Statistics: Num rows: 10 Data size: 88 Basic stats: COMPLETE Column stats: PARTIAL\r\n                table:\r\n                    input format: org.apache.hadoop.mapred.SequenceFileInputFormat\r\n                    output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\r\n                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe\r\n      Reduce Operator Tree:\r\n        Select Operator\r\n          expressions: KEY.reducesinkkey0 (type: int)\r\n          outputColumnNames: _col0\r\n          Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n          PTF Operator\r\n            Function definitions:\r\n                Input definition\r\n                  input alias: ptf_0\r\n                  output shape: _col0: int\r\n                  type: WINDOWING\r\n                Windowing table definition\r\n                  input alias: ptf_1\r\n                  name: windowingtablefunction\r\n                  order by: _col0 ASC NULLS FIRST\r\n                  partition by: _col0\r\n                  raw input shape:\r\n                  window functions:\r\n                      window function definition\r\n                        alias: Row_Number_window_0\r\n                        name: Row_Number\r\n                        window function: GenericUDAFRowNumberEvaluator\r\n                        window frame: ROWS PRECEDING(MAX)~FOLLOWING(MAX)\r\n                        isPivotResult: true\r\n            Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n            Select Operator\r\n              Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n              Lateral View Forward\r\n                Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n                Select Operator\r\n                  Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n                  Lateral View Join Operator\r\n                    outputColumnNames: _col1, _col2\r\n                    Statistics: Num rows: 4 Data size: 4 Basic stats: COMPLETE Column stats: NONE\r\n                    Select Operator\r\n                      Statistics: Num rows: 4 Data size: 4 Basic stats: COMPLETE Column stats: NONE\r\n                      File Output Operator\r\n                        compressed: false\r\n                        table:\r\n                            input format: org.apache.hadoop.mapred.SequenceFileInputFormat\r\n                            output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\r\n                            serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe\r\n                Select Operator\r\n                  expressions: map(10:1) (type: map<int,int>)\r\n                  outputColumnNames: _col0\r\n                  Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n                  UDTF Operator\r\n                    Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n                    function name: explode\r\n                    Lateral View Join Operator\r\n                      outputColumnNames: _col1, _col2\r\n                      Statistics: Num rows: 4 Data size: 4 Basic stats: COMPLETE Column stats: NONE\r\n                      Select Operator\r\n                        Statistics: Num rows: 4 Data size: 4 Basic stats: COMPLETE Column stats: NONE\r\n                        File Output Operator\r\n                          compressed: false\r\n                          table:\r\n                              input format: org.apache.hadoop.mapred.SequenceFileInputFormat\r\n                              output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\r\n                              serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe\r\n\r\n  Stage: Stage-6\r\n    Map Reduce Local Work\r\n      Alias -> Map Local Tables:\r\n        _u1-subquery2:x1:t1\r\n          Fetch Operator\r\n            limit: -1\r\n      Alias -> Map Local Operator Tree:\r\n        _u1-subquery2:x1:t1\r\n          TableScan\r\n            alias: t1\r\n            Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: COMPLETE\r\n            Select Operator\r\n              Statistics: Num rows: 2 Data size: 16 Basic stats: COMPLETE Column stats: COMPLETE\r\n              HashTable Sink Operator\r\n                keys:\r\n                  0\r\n                  1\r\n\r\n  Stage: Stage-2\r\n    Map Reduce\r\n      Map Operator Tree:\r\n          TableScan\r\n            alias: t1\r\n            Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: COMPLETE\r\n            Select Operator\r\n              expressions: 1 (type: int)\r\n              outputColumnNames: _col0\r\n              Statistics: Num rows: 2 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE\r\n              Union\r\n                Statistics: Num rows: 10 Data size: 88 Basic stats: COMPLETE Column stats: PARTIAL\r\n                File Output Operator\r\n                  compressed: false\r\n                  Statistics: Num rows: 10 Data size: 88 Basic stats: COMPLETE Column stats: PARTIAL\r\n                  table:\r\n                      input format: org.apache.hadoop.mapred.SequenceFileInputFormat\r\n                      output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\r\n                      serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe\r\n          TableScan\r\n            Map Join Operator\r\n              condition map:\r\n                   Inner Join 0 to 1\r\n              keys:\r\n                0\r\n                1\r\n              Statistics: Num rows: 8 Data size: 80 Basic stats: COMPLETE Column stats: NONE\r\n              Select Operator\r\n                expressions: 2 (type: int)\r\n                outputColumnNames: _col0\r\n                Statistics: Num rows: 8 Data size: 80 Basic stats: COMPLETE Column stats: NONE\r\n                Union\r\n                  Statistics: Num rows: 10 Data size: 88 Basic stats: COMPLETE Column stats: PARTIAL\r\n                  File Output Operator\r\n                    compressed: false\r\n                    Statistics: Num rows: 10 Data size: 88 Basic stats: COMPLETE Column stats: PARTIAL\r\n                    table:\r\n                        input format: org.apache.hadoop.mapred.SequenceFileInputFormat\r\n                        output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\r\n                        serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe\r\n      Local Work:\r\n        Map Reduce Local Work\r\n\r\n  Stage: Stage-0\r\n    Fetch Operator\r\n      limit: -1\r\n      Processor Tree:\r\n        ListSink\r\n{noformat}\r\nAfter \r\n{noformat}\r\nSTAGE DEPENDENCIES:\r\n  Stage-4 is a root stage\r\n  Stage-6 depends on stages: Stage-4\r\n  Stage-2 depends on stages: Stage-6\r\n  Stage-0 depends on stages: Stage-2\r\n\r\nSTAGE PLANS:\r\n  Stage: Stage-4\r\n    Map Reduce\r\n      Map Operator Tree:\r\n          TableScan\r\n            alias: t1\r\n            Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n            Reduce Output Operator\r\n              key expressions: col1 (type: int)\r\n              sort order: +\r\n              Map-reduce partition columns: col1 (type: int)\r\n              Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n      Execution mode: vectorized\r\n      Reduce Operator Tree:\r\n        Select Operator\r\n          expressions: KEY.reducesinkkey0 (type: int)\r\n          outputColumnNames: _col0\r\n          Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n          PTF Operator\r\n            Function definitions:\r\n                Input definition\r\n                  input alias: ptf_0\r\n                  output shape: _col0: int\r\n                  type: WINDOWING\r\n                Windowing table definition\r\n                  input alias: ptf_1\r\n                  name: windowingtablefunction\r\n                  order by: _col0 ASC NULLS FIRST\r\n                  partition by: _col0\r\n                  raw input shape:\r\n                  window functions:\r\n                      window function definition\r\n                        alias: Row_Number_window_0\r\n                        name: Row_Number\r\n                        window function: GenericUDAFRowNumberEvaluator\r\n                        window frame: ROWS PRECEDING(MAX)~FOLLOWING(MAX)\r\n                        isPivotResult: true\r\n            Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n            Select Operator\r\n              Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n              Lateral View Forward\r\n                Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n                Select Operator\r\n                  Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n                  Lateral View Join Operator\r\n                    outputColumnNames: _col1, _col2\r\n                    Statistics: Num rows: 4 Data size: 4 Basic stats: COMPLETE Column stats: NONE\r\n                    Select Operator\r\n                      Statistics: Num rows: 4 Data size: 4 Basic stats: COMPLETE Column stats: NONE\r\n                      File Output Operator\r\n                        compressed: false\r\n                        table:\r\n                            input format: org.apache.hadoop.mapred.SequenceFileInputFormat\r\n                            output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\r\n                            serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe\r\n                Select Operator\r\n                  expressions: map(10:1) (type: map<int,int>)\r\n                  outputColumnNames: _col0\r\n                  Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n                  UDTF Operator\r\n                    Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE\r\n                    function name: explode\r\n                    Lateral View Join Operator\r\n                      outputColumnNames: _col1, _col2\r\n                      Statistics: Num rows: 4 Data size: 4 Basic stats: COMPLETE Column stats: NONE\r\n                      Select Operator\r\n                        Statistics: Num rows: 4 Data size: 4 Basic stats: COMPLETE Column stats: NONE\r\n                        File Output Operator\r\n                          compressed: false\r\n                          table:\r\n                              input format: org.apache.hadoop.mapred.SequenceFileInputFormat\r\n                              output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\r\n                              serde: org.apache.hadoop.hive.serde2.lazybinary.LazyBinarySerDe\r\n\r\n  Stage: Stage-6\r\n    Map Reduce Local Work\r\n      Alias -> Map Local Tables:\r\n        _u1-subquery2:x1:t1\r\n          Fetch Operator\r\n            limit: -1\r\n      Alias -> Map Local Operator Tree:\r\n        _u1-subquery2:x1:t1\r\n          TableScan\r\n            alias: t1\r\n            Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: COMPLETE\r\n            Select Operator\r\n              Statistics: Num rows: 2 Data size: 16 Basic stats: COMPLETE Column stats: COMPLETE\r\n              HashTable Sink Operator\r\n                keys:\r\n                  0\r\n                  1\r\n\r\n  Stage: Stage-2\r\n    Map Reduce\r\n      Map Operator Tree:\r\n          TableScan\r\n            alias: t1\r\n            Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: COMPLETE\r\n            Select Operator\r\n              expressions: 1 (type: int)\r\n              outputColumnNames: _col0\r\n              Statistics: Num rows: 2 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE\r\n              Union\r\n                Statistics: Num rows: 10 Data size: 88 Basic stats: COMPLETE Column stats: PARTIAL\r\n                File Output Operator\r\n                  compressed: false\r\n                  Statistics: Num rows: 10 Data size: 88 Basic stats: COMPLETE Column stats: PARTIAL\r\n                  table:\r\n                      input format: org.apache.hadoop.mapred.SequenceFileInputFormat\r\n                      output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\r\n                      serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe\r\n          TableScan\r\n            Map Join Operator\r\n              condition map:\r\n                   Inner Join 0 to 1\r\n              keys:\r\n                0\r\n                1\r\n              Statistics: Num rows: 8 Data size: 80 Basic stats: COMPLETE Column stats: NONE\r\n              Select Operator\r\n                expressions: 2 (type: int)\r\n                outputColumnNames: _col0\r\n                Statistics: Num rows: 8 Data size: 80 Basic stats: COMPLETE Column stats: NONE\r\n                Union\r\n                  Statistics: Num rows: 10 Data size: 88 Basic stats: COMPLETE Column stats: PARTIAL\r\n                  File Output Operator\r\n                    compressed: false\r\n                    Statistics: Num rows: 10 Data size: 88 Basic stats: COMPLETE Column stats: PARTIAL\r\n                    table:\r\n                        input format: org.apache.hadoop.mapred.SequenceFileInputFormat\r\n                        output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat\r\n                        serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe\r\n      Local Work:\r\n        Map Reduce Local Work\r\n\r\n  Stage: Stage-0\r\n    Fetch Operator\r\n      limit: -1\r\n      Processor Tree:\r\n        ListSink\r\n{noformat}\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-10T22:17:26.962+0000","updated":"2018-08-10T22:17:26.962+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13177461/comment/16580543","id":"16580543","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"body":"+1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vihangk1","name":"vihangk1","key":"vihangk1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vihang Karajgaonkar","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-14T23:34:34.886+0000","updated":"2018-08-14T23:34:34.886+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13177461/comment/16582902","id":"16582902","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"body":"Pushed to master. Thanks [~vihangk1] for viewing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aihuaxu","name":"aihuaxu","key":"aihuaxu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aihua Xu","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-16T18:25:16.598+0000","updated":"2018-08-16T18:25:16.598+0000"}],"maxResults":9,"total":9,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-20331/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3wsj3:"}}