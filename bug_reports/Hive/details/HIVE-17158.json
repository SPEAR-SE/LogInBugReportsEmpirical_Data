{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13089505","self":"https://issues.apache.org/jira/rest/api/2/issue/13089505","key":"HIVE-17158","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jul 24 13:30:49 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_4135549_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-07-24T13:31:11.771+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17158/watchers","watchCount":2,"isWatching":false},"created":"2017-07-24T12:22:16.276+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340268","id":"12340268","name":"3.0.0","archived":false,"released":true,"releaseDate":"2018-05-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-07-24T13:31:11.820+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324409","id":"12324409","name":"Beeline"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312590","id":"12312590","name":"Testing Infrastructure","description":"Tracks issues with tests and testing infrastructure."}],"timeoriginalestimate":null,"description":"The output of the BeeLine tests is sometimes flaky, especially if the query is a fast one\n\nThe output is sometime this:\n{code}\nPREHOOK: query: select explode(array('a', 'b'))\nPREHOOK: type: QUERY\nPREHOOK: Input: _dummy_database@_dummy_table\n#### A masked pattern was here ####\nPOSTHOOK: query: select explode(array('a', 'b'))\nPOSTHOOK: type: QUERY\nPOSTHOOK: Input: _dummy_database@_dummy_table\n#### A masked pattern was here ####\na\nb\n{code}\n\nSometime this:\n{code}\na\nb\nPREHOOK: query: select explode(array('a', 'b'))\nPREHOOK: type: QUERY\nPREHOOK: Input: _dummy_database@_dummy_table\n#### A masked pattern was here ####\nPOSTHOOK: query: select explode(array('a', 'b'))\nPOSTHOOK: type: QUERY\nPOSTHOOK: Input: _dummy_database@_dummy_table\n#### A masked pattern was here ####\n{code}\n\nNotice, that the actual query result is either before, or after the stuff printed by the hooks.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"BeeLine Query Log and Query Result print order is not defined","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13089505/comment/16098296","id":"16098296","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"body":"The root cause of the issue is that if the LogRunnable is interrupted before started then there is no InterruptedException thrown, and the {{showRemainingLogsIfAny}} is not called. \n\n{code}\n  private Runnable createLogRunnable(final Statement statement) {\n    if (statement instanceof HiveStatement) {\n      final HiveStatement hiveStatement = (HiveStatement) statement;\n\n      Runnable runnable = new Runnable() {\n        @Override\n        public void run() {\n          while (hiveStatement.hasMoreLogs() && !Thread.currentThread().isInterrupted()) {\n            try {\n              // fetch the log periodically and output to beeline console\n              for (String log : hiveStatement.getQueryLog()) {\n                if (!beeLine.isTestMode()) {\n                  beeLine.info(log);\n                } else {\n                  // In test mode print the logs to the output\n                  beeLine.output(log);\n                }\n              }\n              Thread.sleep(DEFAULT_QUERY_PROGRESS_INTERVAL);\n            } catch (SQLException e) {\n              beeLine.error(new SQLWarning(e));\n              return;\n            } catch (InterruptedException e) {\n              beeLine.debug(\"Getting log thread is interrupted, since query is done!\");\n              showRemainingLogsIfAny(statement);              <-- We expect to print the logs here, but if no exception, no logs\n              return;\n            }\n          }\n        }\n      };\n      return runnable;\n    } else {\n[..]\n    }\n  }\n{code}\n\nThe log printed when the ResultSet is queried, or in the finally stage.\n{code}\n          do {\n            ResultSet rs = stmnt.getResultSet();\n            try {\n              int count = beeLine.print(rs);\n              long end = System.currentTimeMillis();\n\n              beeLine.info(\n                  beeLine.loc(\"rows-selected\", count) + \" \" + beeLine.locElapsedTime(end - start));\n            } finally {\n              if (logThread != null) {\n                logThread.join(DEFAULT_QUERY_PROGRESS_THREAD_TIMEOUT);\n                showRemainingLogsIfAny(stmnt);\n                logThread = null;\n              }\n              rs.close();\n            }\n          } while (BeeLine.getMoreResults(stmnt));\n{code}\n\n{code}\n      } finally {\n        if (logThread != null) {\n          if (!logThread.isInterrupted()) {\n            logThread.interrupt();\n          }\n          logThread.join(DEFAULT_QUERY_PROGRESS_THREAD_TIMEOUT);\n          showRemainingLogsIfAny(stmnt);\n        }\n        if (stmnt != null) {\n          stmnt.close();\n        }\n      }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"created":"2017-07-24T12:34:10.140+0000","updated":"2017-07-24T12:34:10.140+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13089505/comment/16098408","id":"16098408","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"body":"Ok. I was looking at old code. This was solved by HIVE-15473","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"created":"2017-07-24T13:30:49.549+0000","updated":"2017-07-24T13:30:49.549+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17158/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3hxe7:"}}