{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13020602","self":"https://issues.apache.org/jira/rest/api/2/issue/13020602","key":"HIVE-15199","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340269","id":"12340269","name":"2.3.0","archived":false,"released":true,"releaseDate":"2017-07-18"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2016-11-15T11:30:29.297+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Nov 23 18:45:35 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_163154842_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_608084247","customfield_12312321":null,"resolutiondate":"2016-11-23T18:45:34.953+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-15199/watchers","watchCount":8,"isWatching":false},"created":"2016-11-14T20:31:36.178+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12486801","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12486801","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13021416","key":"HADOOP-13823","self":"https://issues.apache.org/jira/rest/api/2/issue/13021416","fields":{"summary":"s3a rename: fail if dest file exists","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}},{"id":"12486739","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12486739","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12936219","key":"HIVE-12988","self":"https://issues.apache.org/jira/rest/api/2/issue/12936219","fields":{"summary":"Improve dynamic partition loading IV","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12501165","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12501165","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13062219","key":"HIVE-16402","self":"https://issues.apache.org/jira/rest/api/2/issue/13062219","fields":{"summary":"Upgrade to Hadoop 2.8.0","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12501163","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12501163","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13062755","key":"HIVE-16411","self":"https://issues.apache.org/jira/rest/api/2/issue/13062755","fields":{"summary":"Revert HIVE-15199","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21148&avatarType=issuetype","name":"Task","subtask":false,"avatarId":21148}}}},{"id":"12487346","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12487346","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"outwardIssue":{"id":"13023066","key":"HIVE-15280","self":"https://issues.apache.org/jira/rest/api/2/issue/13023066","fields":{"summary":"Hive.mvFile() misses the \".\" char when joining the filename + extension","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-07-21T18:26:21.630+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325007","id":"12325007","name":"Hive"}],"timeoriginalestimate":null,"description":"Any INSERT INTO statement run on S3 tables and when the scratch directory is saved on S3 is deleting old rows of the table.\n\n{noformat}\nhive> set hive.blobstore.use.blobstore.as.scratchdir=true;\n\nhive> create table t1 (id int, name string) location 's3a://spena-bucket/t1';\n\nhive> insert into table t1 values (1,'name1');\n\nhive> select * from t1;\n1       name1\n\nhive> insert into table t1 values (2,'name2');\n\nhive> select * from t1;\n2       name2\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12840269","id":"12840269","filename":"HIVE-15199.10.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-23T15:53:35.408+0000","size":16260,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12840269/HIVE-15199.10.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12839914","id":"12839914","filename":"HIVE-15199.8.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-21T23:53:31.499+0000","size":20147,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12839914/HIVE-15199.8.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12840142","id":"12840142","filename":"HIVE-15199.9.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-22T22:37:01.876+0000","size":16104,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12840142/HIVE-15199.9.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"INSERT INTO data on S3 is replacing the old rows with the new ones","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15665000","id":"15665000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"This issue is happening on the following code (Hive.java):\n{noformat}\nprivate static void copyFiles(...) {\n...\n  if (renameNonLocal) {\n      for (int counter = 1; !destFs.rename(srcP,destPath); counter++) {\n           destPath = new Path(destf, name + (\"_copy_\" + counter) + filetype);\n       }\n  } else {\n       destPath = mvFile(conf, srcP, destPath, isSrcLocal, srcFs, destFs, name, filetype);\n  }\n...\n}\n{noformat}\n\nEven if the file already exists on S3, the {{destFs.rename()}} call is renaming the file. \nThis does not happen with HDFS. If the file exists on HDFS, then the rename will fail, and the _copy_ string will be appended to the filename, and retry the rename.\n\n[~stevel@apache.org] Do you know if this is a known bug on the Hadoop side?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-14T20:59:37.043+0000","updated":"2016-11-14T20:59:37.043+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15666900","id":"15666900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajesh.balamohan","name":"rajesh.balamohan","key":"rajesh.balamohan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Balamohan","active":true,"timeZone":"Asia/Kolkata"},"body":"This is covered in test cases in branch-2 for S3 https://github.com/apache/hadoop/blob/branch-2/hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/ITestS3AFileSystemContract.java#L103\n\nNeed to change Hive to make use of {{destFs.exists}} and do a rename.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajesh.balamohan","name":"rajesh.balamohan","key":"rajesh.balamohan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Balamohan","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-11-15T11:30:29.297+0000","updated":"2016-11-15T11:30:29.297+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15667531","id":"15667531","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yalovyyi","name":"yalovyyi","key":"yalovyyi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yalovyyi&avatarId=24941","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yalovyyi&avatarId=24941","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yalovyyi&avatarId=24941","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yalovyyi&avatarId=24941"},"displayName":"Illya Yalovyy","active":true,"timeZone":"America/Los_Angeles"},"body":"destFs.exists will require another call to S3, that could affect performance. I think it should be addressed in s3a implementation. It should provide consistent behavior with HDFS.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yalovyyi","name":"yalovyyi","key":"yalovyyi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yalovyyi&avatarId=24941","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yalovyyi&avatarId=24941","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yalovyyi&avatarId=24941","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yalovyyi&avatarId=24941"},"displayName":"Illya Yalovyy","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-11-15T16:10:15.901+0000","updated":"2016-11-15T16:10:15.901+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15667862","id":"15667862","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"body":"The code block Sergio posted looks like it could have some major inefficiencies, even for HDFS. If my understanding is correct, the code basically tries to rename the data with the suffix {{... + \"_copy_\" + counter}}, if it fails (because the files already exists), it increments the counter and then tries again. This doesn't sound like a scalable solution, what happens if there are 1000 files under the directory, any insert will require explicitly checking for the existence of files from {{... + \"_copy_0\"}} to {{... + \"_copy_1000\"}}. On HDFS, and especially on S3, this doesn't seem to be a very efficient approach (would be good to confirm this behavior).\n\nIf the logic above is indeed what happens, there could be a few different ways to fix this.\n\n1: Append an UUID to the end of the file name rather than using a counter, since UUID are globally unique there should be no chance of conflict\n2: Append the query_id + a synchronized counter ({{private synchronized long counter}}) to the file name","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-15T18:21:02.200+0000","updated":"2016-11-15T18:21:02.200+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15667931","id":"15667931","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"sounds related to HADOOP-13402\n\nI am not going to express any opinion about what is \"the correct\" behaviour we should expect from rename, as I don't think anyone knows that. If you look at the [FS Specification|https://hadoop.apache.org/docs/stable2/hadoop-project-dist/hadoop-common/filesystem/filesystem.html] we're pretty explicit that rename is hard, and that there are different behaviours by different filesystems are.\n\nI'm not defending S3A here, just noting I'm not 100% sure of what HDFS does itself here, and how that compares to the semantics of posix's rename call (which is different from the unix command line {{mv}} operation).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2016-11-15T18:50:41.269+0000","updated":"2016-11-15T18:50:41.269+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15671136","id":"15671136","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"Guys, [~ashutoshc], could you help me review the patch?\n\nWhat it does is to use the alternative condition {{mvFile}} when the destination filesystem is a blobstore. And, because this {{mvFile}} was calling {{destFs.exists()}} for every file on S3, then I changed it to get a list of files, and check whether the {{destf}} exists or not on that list.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-16T17:55:46.401+0000","updated":"2016-11-16T17:55:46.401+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15671234","id":"15671234","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"body":"[~spena] a few comments:\n\n* It may be better to take a hybrid of the list files approach + the exists approach; for blobstores like S3 listfiles is only eventually consistent; this means listfiles may not return all the files that are actually there. One way to get around this is to first do the listfiles, and then checks if the targetFilename exists or not. This has the advantage of the perf gains of using listfiles, but avoids the consistency problems\n* I remember we discussed offline about concerns w.r.t multiple INSERT INTO queries running against the same table, but I just remembered that Hive Locking (https://cwiki.apache.org/confluence/display/Hive/Locking) should prevent that from ever happening, correct?\n* It would be nice (although not necessary) if we changed the name of {{renameNonLocal}} to something more descriptive","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-16T18:34:31.881+0000","updated":"2016-11-16T18:34:47.488+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15671431","id":"15671431","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"[~stakiar] Thanks. I updated the patch with:\n\n- Using an hybrid solution that checks if a file exists on the list status or if exists on the FS.\n- Change the renameNonLocal to renameIsAllowed\n\nFor the Hive lock, yes, Hive should have a lock to avoid another client inserts data on the same table.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-16T19:53:27.434+0000","updated":"2016-11-16T19:53:27.434+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15671747","id":"15671747","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12839221/HIVE-15199.2.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 209 failed/errored test(s), 10664 tests executed\n*Failed tests:*\n{noformat}\nTestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=109)\n\t[enforce_order.q,ppd_join2.q,smb_mapjoin_21.q,load_dyn_part15.q,udf_min.q,groupby_resolution.q,mapjoin_memcheck.q,subquery_exists.q,join27.q,alter_merge_stats_orc.q,union_remove_2.q,vector_orderby_5.q,groupby6_map_skew.q,join12.q,union9.q]\nTestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=128)\n\t[union_remove_15.q,bucket_map_join_tez1.q,groupby7_noskew.q,bucketmapjoin1.q,subquery_multiinsert.q,auto_join8.q,auto_join6.q,groupby2_map_skew.q,lateral_view_explode2.q,join28.q,load_dyn_part1.q,skewjoinopt17.q,skewjoin_union_remove_1.q,union_remove_20.q,bucketmapjoin5.q]\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[add_part_multiple] (batchId=62)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[alter_merge_2_orc] (batchId=67)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[alter_partition_coltype] (batchId=23)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[alter_table_add_partition] (batchId=16)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[alter_table_update_status] (batchId=71)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[array_map_access_nonconstant] (batchId=20)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[autoColumnStats_3] (batchId=50)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[autoColumnStats_5] (batchId=37)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[avro_add_column2] (batchId=80)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[avrocountemptytbl] (batchId=73)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[ba_table_udfs] (batchId=22)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[cbo_rp_insert] (batchId=10)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[columnStatsUpdateForStatsOptimizer_2] (batchId=27)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[column_names_with_leading_and_trailing_spaces] (batchId=21)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[complex_alias] (batchId=15)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[concat_op] (batchId=66)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[constantPropWhen] (batchId=31)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[constantfolding] (batchId=67)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[constprog_when_case] (batchId=52)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[create_merge_compressed] (batchId=38)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[cte_5] (batchId=30)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[cte_7] (batchId=23)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[cte_mat_5] (batchId=2)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[dbtxnmgr_query1] (batchId=65)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[decimal_precision] (batchId=47)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[distinct_stats] (batchId=64)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[except_all] (batchId=41)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[exim_01_nonpart] (batchId=48)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[exim_03_nonpart_over_compat] (batchId=5)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[exim_08_nonpart_rename] (batchId=55)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[exim_10_external_managed] (batchId=62)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[exim_12_external_location] (batchId=49)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[exim_13_managed_location] (batchId=35)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[exim_14_managed_location_over_existing] (batchId=48)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[exim_22_import_exist_authsuccess] (batchId=17)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[exim_24_import_nonexist_authsuccess] (batchId=17)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[folder_predicate] (batchId=4)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[groupby_distinct_samekey] (batchId=51)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[groupby_grouping_window] (batchId=29)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[groupby_nullvalues] (batchId=72)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[implicit_decimal] (batchId=61)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert0] (batchId=4)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert1] (batchId=22)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert2] (batchId=77)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_acid_not_bucketed] (batchId=62)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_compressed] (batchId=73)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_into1] (batchId=19)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_into2] (batchId=79)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_into3] (batchId=24)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_into4] (batchId=16)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_into5] (batchId=29)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_into_with_schema2] (batchId=34)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_nonacid_from_acid] (batchId=66)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_acid_not_bucketed] (batchId=16)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_nonascii] (batchId=42)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=56)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insertoverwrite_bucket] (batchId=61)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insertvalues_espchars] (batchId=63)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[join42] (batchId=22)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[join43] (batchId=5)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[join_cond_pushdown_unqual5] (batchId=60)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[join_on_varchar] (batchId=41)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[json_serde1] (batchId=31)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[llap_uncompressed] (batchId=52)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[load_orc] (batchId=70)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[macro_1] (batchId=45)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[macro_duplicate] (batchId=36)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[mapjoin2] (batchId=9)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[mapjoin_memcheck] (batchId=37)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[mapjoin_test_outer] (batchId=1)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[materialized_view_authorization_sqlstd] (batchId=42)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[materialized_view_create] (batchId=64)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[materialized_view_describe] (batchId=61)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[multi_insert_with_join2] (batchId=70)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[multi_insert_with_join] (batchId=59)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[nonreserved_keywords_insert_into1] (batchId=24)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_merge11] (batchId=35)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_merge8] (batchId=75)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_merge9] (batchId=24)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_merge_incompat1] (batchId=60)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_merge_incompat2] (batchId=75)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_ppd_schema_evol_1b] (batchId=30)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_ppd_schema_evol_2b] (batchId=14)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_ppd_str_conversion] (batchId=28)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_schema_evolution_float] (batchId=30)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_vectorization_ppd] (batchId=36)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_wide_table] (batchId=77)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[parquet_array_map_emptynullvals] (batchId=30)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[parquet_ctas] (batchId=60)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[parquet_join2] (batchId=9)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[parquet_join] (batchId=18)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[parquet_ppd_partition] (batchId=7)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[parquet_schema_evolution] (batchId=67)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[parquet_type_promotion] (batchId=75)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[partition_coltype_literals] (batchId=12)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[ppd_join5] (batchId=32)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[ptfgroupbyjoin] (batchId=76)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[quotedid_basic] (batchId=54)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[rename_table_update_column_stats] (batchId=33)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[selectindate] (batchId=56)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[setop_no_distinct] (batchId=72)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[skewjoin_onesideskew] (batchId=64)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[smb_join_partition_key] (batchId=12)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[stats16] (batchId=4)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[statsfs] (batchId=41)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[tez_join_hash] (batchId=47)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[truncate_column_merge] (batchId=55)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_folder_constants] (batchId=46)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udtf_replicate_rows] (batchId=75)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[union37] (batchId=64)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[union_date_trim] (batchId=70)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[union_paren] (batchId=42)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[unionall_join_nullconstant] (batchId=35)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[unionall_unbalancedppd] (batchId=2)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_aggregate_9] (batchId=35)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_aggregate_without_gby] (batchId=47)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_binary_join_groupby] (batchId=73)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_bround] (batchId=30)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_bucket] (batchId=23)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_cast_constant] (batchId=8)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_char_4] (batchId=79)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_char_cast] (batchId=59)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_char_simple] (batchId=41)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_coalesce_2] (batchId=64)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_custom_udf_configure] (batchId=59)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_data_types] (batchId=68)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_date_1] (batchId=19)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_mapjoin] (batchId=50)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_round] (batchId=32)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_round_2] (batchId=21)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_distinct_2] (batchId=46)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_groupby_3] (batchId=58)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_interval_1] (batchId=14)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_left_outer_join2] (batchId=58)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_null_projection] (batchId=8)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_orderby_5] (batchId=37)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_outer_join0] (batchId=55)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_reduce1] (batchId=25)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_reduce2] (batchId=35)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_reduce3] (batchId=25)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_string_concat] (batchId=29)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_string_decimal] (batchId=2)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_struct_in] (batchId=41)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_varchar_4] (batchId=27)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_varchar_simple] (batchId=68)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_when_case_null] (batchId=32)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vectorized_bucketmapjoin1] (batchId=22)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vectorized_date_funcs] (batchId=68)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vectorized_distinct_gby] (batchId=67)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vectorized_timestamp] (batchId=69)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vectorized_timestamp_funcs] (batchId=27)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[view_alias] (batchId=74)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[windowing_windowspec4] (batchId=59)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=91)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_4] (batchId=91)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[delete_non_acid_table] (batchId=83)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[insert_into5] (batchId=83)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[materialized_view_authorization_create_no_grant] (batchId=83)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[materialized_view_authorization_create_no_select_perm] (batchId=83)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[materialized_view_authorization_drop_other] (batchId=83)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[materialized_view_authorization_no_select_perm] (batchId=83)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[materialized_view_drop2] (batchId=83)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[materialized_view_drop] (batchId=83)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[materialized_view_replace_with_view] (batchId=83)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[partition_column_names_with_leading_and_trailing_spaces] (batchId=83)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[update_non_acid_table] (batchId=83)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[add_part_multiple] (batchId=121)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[alter_merge_orc] (batchId=119)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[create_merge_compressed] (batchId=110)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[insert_into1] (batchId=101)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[insert_into2] (batchId=130)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[insert_into3] (batchId=104)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[mapjoin_decimal] (batchId=121)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[mapjoin_test_outer] (batchId=92)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[multi_insert_with_join] (batchId=120)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[parquet_join] (batchId=100)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[ppd_join5] (batchId=107)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[stats16] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[statsfs] (batchId=111)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[union_date_trim] (batchId=126)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[union_top_level] (batchId=118)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_cast_constant] (batchId=96)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_char_4] (batchId=130)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_data_types] (batchId=125)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_decimal_mapjoin] (batchId=115)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_distinct_2] (batchId=114)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_groupby_3] (batchId=119)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_string_concat] (batchId=106)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_varchar_4] (batchId=105)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vectorization_short_regress] (batchId=112)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vectorized_ptf] (batchId=119)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vectorized_timestamp_funcs] (batchId=105)\norg.apache.hadoop.hive.metastore.hbase.TestHBaseMetastoreSql.insertIntoTable (batchId=191)\norg.apache.hadoop.hive.metastore.hbase.TestHBaseMetastoreSql.partitionedTable (batchId=191)\norg.apache.hadoop.hive.metastore.hbase.TestHBaseMetastoreSql.table (batchId=191)\norg.apache.hadoop.hive.ql.lockmgr.TestDbTxnManager2.testCompletedTxnComponents (batchId=268)\norg.apache.hadoop.hive.ql.lockmgr.TestDbTxnManager2.testMerge3Way01 (batchId=268)\norg.apache.hadoop.hive.ql.lockmgr.TestDbTxnManager2.testMerge3Way02 (batchId=268)\norg.apache.hadoop.hive.ql.lockmgr.TestDbTxnManager2.testMultiInsert (batchId=268)\norg.apache.hive.hcatalog.listener.TestDbNotificationListener.sqlCTAS (batchId=217)\norg.apache.hive.hcatalog.listener.TestDbNotificationListener.sqlInsertPartition (batchId=217)\norg.apache.hive.hcatalog.listener.TestDbNotificationListener.sqlInsertTable (batchId=217)\norg.apache.hive.jdbc.TestJdbcDriver2.testNullResultSet (batchId=211)\norg.apache.hive.jdbc.TestJdbcDriver2.testSerializedExecution (batchId=211)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2156/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2156/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2156/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 209 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12839221 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-11-16T21:50:22.452+0000","updated":"2016-11-16T21:50:22.452+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15672593","id":"15672593","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"body":"* Is the goal to trigger mvFile when the destination file is a blobstore? I don't think thats the right approach because a {{FileUtils.copy}} will do a client-side copy when running on S3, data will be downloaded from HDFS to HS2 and then uploaded to S3; the target should be to do a server-side copy (happens internally on S3). A server side copy can only be triggered by called {{FileSystem.rename}}.\n* The listing optimization can be applied to HDFS too, right? It should increase perf when running on HDFS too.\n* A bit orthogonal to this JIRA, but {{mvFile}} should probably be called copyFile because it always copies data.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-17T03:40:10.715+0000","updated":"2016-11-17T03:40:10.715+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15673317","id":"15673317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"# as sahil notes, blobstore copy calls must be in object store to get internal bandwidth *and avoid download costs*.\n# that can currently only be done in rename(); if we ever added a copy() command to the FS API, your life would be better\n# the fact that rename returns \"false\" without details makes things worse. FWIW I'm modifying spark's inner rename to throw exceptions —but as as that isn't the public FS API, it's of no use here. Though I could add an option to s3a to always throw those exceptions (a subclass of IOE) if the caller needed it. Would that help? it'd only be broadly useful if HDFS &c also did that\n\nNow, what is needed to be done here? \n# handle the situation where a list of an object store path can be out of sync with the actual contents, something that surfaces in S3 and swift. the exists/getFileStatus() call is more robust there.\n# handle the situation where rename(src, dest), src is a file and dest is a file, will copy src onto dest.  \n\nShort term: check the destination. I know some people will worry about the cost of the existence check, but remember this is going to trigger a copy operation, which is O(data) at about 6-8 MB/s: if you are committing large files, things will be slow.\n\nLooking at the rename semantics as tested in {{AbstractContractRenameTest}}, the test {{testRenameFileOverExistingFile}} has the comment \"handles filesystems that will overwrite the destination as well as those that do not (i.e. HDFS).\". It's not just s3a which lets you rename over a test, so apparently does local file://. Interestingly: azure wasb:// doesn't, nor does s3n.\n\n\nI think we can consider the fact that s3a lets you overwrite an existing destination to be a bug, based on its inconsistency with HDFS, Azure, s3n, etc. Indeed, the difference between s3a and s3n makes it harder to say \"s3a is a drop-in replacement for s3n\". Created HADOOP-13823 for you.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2016-11-17T10:13:33.904+0000","updated":"2016-11-17T10:13:33.904+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15673914","id":"15673914","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"You're right, I will do the change to use a rename() instead. This should be used on HDFS as well.\n\nThe {{mvFile}} method name is good I think, Hive is moving the file from source to target by copy and delete the file from source. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-17T14:53:13.755+0000","updated":"2016-11-17T14:53:13.755+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15674461","id":"15674461","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"Attached a new patch that addresses feedback comments. This patch will call listFiles() whatever the filesystem is, HDFS or S3, and it will call the rename() method on S3 as well to take advantage of the server-side copy.\n\n[~steve_l] Thanks for creating the bug on HADOOP. Your suggestion about the exception, when will that happen? When the destination file already exists? Isn't going to be inconsistent with the HDFS rename() that it doesn't throw the exception?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-17T18:31:09.658+0000","updated":"2016-11-17T18:31:09.658+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15674563","id":"15674563","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12839415/HIVE-15199.4.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10695 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_1] (batchId=90)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=91)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2170/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2170/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2170/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 5 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12839415 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-11-17T19:17:08.412+0000","updated":"2016-11-17T19:17:08.412+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15674630","id":"15674630","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"body":"* The patch does a {{listStatus}} for each file it needs to rename, is that necessary? It may be more efficient if only one {{listStatus}} is done outside the for loop in {{copyFiles}}\n\nI would suggest modifying the following code block:\n\n{code}\n    fs.listStatus(dirPath, new PathFilter() {\n      @Override\n      public boolean accept(Path path) {\n        if (path.getName().startsWith(filename)) {\n          fileSet.add(path);\n        }\n\n        return false;\n      }\n    });\n{code}\n\nIs the use of the {{PathFilter}} necessary, a {{PathFilter}} is typically used to filter out certain files from a {{listStatus}} call, but here is it being used to populate the {{fileSet}} object; we should be able to accomplish the same thing without using the {{PathFilter}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-17T19:47:42.421+0000","updated":"2016-11-17T19:47:42.421+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15674822","id":"15674822","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"Yeah, doing the listSTatus() once will be better. I'll try that.\n\nAbout the PathFilter, I used it to fill the Set<> during the listStatus(), and avoid listStatus() to create the FileStatus[] array, and then me walking through the array to push the elements to the Set<> again. I just need the path, and that way I avoid creating FileStatus objects on memory. Regarding using a Set<>, I see this is faster by walking to the different _copy_ files and check if they're contained on the Set ( O(N) ) than walking through the FileStatus[] once per every new _copy_ file ( O(N*N) ).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-17T21:08:39.586+0000","updated":"2016-11-17T21:08:39.586+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15677502","id":"15677502","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"All tests fail due to this error:\n{noformat}\n[ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:2.19.1:test (default-test) on project hive-it-qfile: Unable to generate classpath: org.apache.maven.artifact.resolver.ArtifactResolutionException: Unable to get dependency information for org.apache.maven.surefire:surefire-junit4:jar:2.19.1: Failed to retrieve POM for org.apache.maven.surefire:surefire-junit4:jar:2.19.1: Could not transfer artifact org.apache.maven.surefire:surefire-junit4:pom:2.19.1 from/to central (https://repo.maven.apache.org/maven2): hostname in certificate didn't match: <repo.maven.apache.org> != <repo1.maven.org> OR <repo1.maven.org>\n{noformat}\n\nThis is not related to the patch, but there's no way to validate it. I'll wait until the problem goes away.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-18T19:16:55.172+0000","updated":"2016-11-18T19:16:55.172+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15677959","id":"15677959","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"body":"In {{mvFile}} should {{while (!destFs.rename(sourcePath, destFilePath))}} be changed to {{while (!destFs.exists(destFilePath) && !destFs.rename(sourcePath, destFilePath))}} this way we always check if the file exists before renaming. While slightly less performant on HDFS, its much safer for S3 since {{listFiles}} may not return the entire contents of the directory (since its an eventually consistent operation).\n\nOther than that +1 assuming Hive QA comes back normally.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-18T22:27:16.253+0000","updated":"2016-11-18T22:27:16.253+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15678226","id":"15678226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12839599/HIVE-15199.5.patch\n\n{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 13 failed/errored test(s), 10668 tests executed\n*Failed tests:*\n{noformat}\nTestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=108)\n\t[tez_joins_explain.q,transform2.q,groupby5.q,cbo_semijoin.q,bucketmapjoin13.q,union_remove_6_subq.q,groupby2_map_multi_distinct.q,load_dyn_part9.q,multi_insert_gby2.q,vectorization_11.q,groupby_position.q,avro_compression_enabled_native.q,smb_mapjoin_8.q,join21.q,auto_join16.q]\nTestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=118)\n\t[stats12.q,groupby4.q,union_top_level.q,groupby10.q,subquery_in.q,mapjoin_filter_on_outerjoin.q,auto_sortmerge_join_4.q,limit_partition_metadataonly.q,load_dyn_part4.q,union3.q,groupby_multi_single_reducer.q,smb_mapjoin_14.q,groupby3_noskew_multi_distinct.q,stats18.q,union_remove_21.q]\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_3] (batchId=90)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.org.apache.hadoop.hive.cli.TestSparkCliDriver (batchId=94)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[escape_sortby1] (batchId=111)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[groupby_multi_single_reducer3] (batchId=111)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[join29] (batchId=111)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[leftsemijoin] (batchId=111)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[statsfs] (batchId=111)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[union_remove_6] (batchId=111)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2202/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2202/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2202/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 13 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12839599 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-11-19T00:35:02.306+0000","updated":"2016-11-19T00:35:02.306+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15679190","id":"15679190","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"if you do listStatus(path, recursive=true) you don't get back a filestatus array, you get an interator back; on s3a branch 2.8+ this goes through the results of the list, triggering new listing requests on demand: https://github.com/apache/hadoop/blob/trunk/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/Listing.java#L171\n\nTo make effective use of this feature, you do have to list through the results, otherwise it won't do the listing operation...you may as well build the set up from that iteration\n\n{code}\n\nRemoteIterator<FileStatus> it = fs.listStatus(path, true)\nwhile (it.hasNext()) {\n  FileStatus s = it.next()\n if (!fileSet.contains(s)) {\n   fileSet.add(s);\n }\n}\n\n{code}\n\nOn other filesystems listStatus does a recursive treewalk, no more/less expensive than doing it in your own code\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2016-11-19T12:35:00.290+0000","updated":"2016-11-19T12:35:00.290+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15682094","id":"15682094","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"[~stevel@apache.org] What call is better to use, listStatus() or listFiles()? I've heard listFiles() would be better if I want to get files recursively. I'm using listFiles() in the patch instead. Is that ok?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-21T00:18:53.195+0000","updated":"2016-11-21T00:18:53.195+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15682107","id":"15682107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"Seems all tests are flaky and no related to this patch. I'm attaching a new one that contains one little change to include the {{destFs.exists()}} call. This will also check if those flaky tests are not failing anymore.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-21T00:27:34.385+0000","updated":"2016-11-21T00:27:34.385+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15682195","id":"15682195","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12839735/HIVE-15199.6.patch\n\n{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 19 failed/errored test(s), 10728 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_sortmerge_join_2] (batchId=43)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[bucket_map_join_spark2] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[bucketmapjoin2] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[cbo_udf_udaf] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[groupby_cube1] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[join13] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[join_vc] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[ptf_decimal] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[sample3] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[smb_mapjoin_19] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[stats16] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[union23] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[union31] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[union] (batchId=93)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[union_remove_7] (batchId=93)\norg.apache.hive.spark.client.TestSparkClient.testJobSubmission (batchId=272)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2220/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2220/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2220/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 19 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12839735 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-11-21T01:34:18.012+0000","updated":"2016-11-21T01:34:18.012+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15684089","id":"15684089","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"All those tests are passing on my local machine. I'll rerun the tests on HiveQA as I see other JIRAs are not failing anymore. They might have already fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-21T16:58:05.141+0000","updated":"2016-11-21T16:58:05.141+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15684283","id":"15684283","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"you are right, I am wrong: serves me right for commenting without staring at the code. you should be calling; I got confused by naming.\n\nyou should be invoking\n\n{code}\nRemoteIterator<LocatedFileStatus> listFiles(Path f,  boolean recursive) \n{code}\nwith recursive = true.\n\nthis defaults to a standard recursive treewalk; on object stores we can do an O(1) listing of all child files, irrespective of directory depth and width. For anything other than a flat directory, this is a significant speedup","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2016-11-21T18:10:45.798+0000","updated":"2016-11-22T15:19:46.710+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15684424","id":"15684424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12839839/HIVE-15199.7.patch\n\n{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10729 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=91)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_4] (batchId=91)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2228/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2228/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2228/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 5 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12839839 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-11-21T19:00:05.057+0000","updated":"2016-11-21T19:00:05.057+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15684448","id":"15684448","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"[~aihuaxu] [~ashutoshc] Could any of you help me review this patch or if you can refer me anyone with knowledge of this code? It was already reviewed by the folks on this JIRA. Tests are passing, and the S3 tests passed to. I just need a committer do a +1 before commit it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-21T19:11:26.928+0000","updated":"2016-11-21T19:11:26.928+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15684931","id":"15684931","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yalovyyi","name":"yalovyyi","key":"yalovyyi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yalovyyi&avatarId=24941","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yalovyyi&avatarId=24941","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yalovyyi&avatarId=24941","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yalovyyi&avatarId=24941"},"displayName":"Illya Yalovyy","active":true,"timeZone":"America/Los_Angeles"},"body":"I really like having query_id as part of the name. It helps a lot with many problems. For s3 in particular eventual consistency is one of them.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yalovyyi","name":"yalovyyi","key":"yalovyyi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yalovyyi&avatarId=24941","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yalovyyi&avatarId=24941","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yalovyyi&avatarId=24941","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yalovyyi&avatarId=24941"},"displayName":"Illya Yalovyy","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-11-21T22:24:18.270+0000","updated":"2016-11-21T22:24:18.270+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15684935","id":"15684935","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yalovyyi","name":"yalovyyi","key":"yalovyyi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yalovyyi&avatarId=24941","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yalovyyi&avatarId=24941","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yalovyyi&avatarId=24941","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yalovyyi&avatarId=24941"},"displayName":"Illya Yalovyy","active":true,"timeZone":"America/Los_Angeles"},"body":"[~spena], I would love to take a look at this patch, but I don't see a link to a review board. Did I miss it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yalovyyi","name":"yalovyyi","key":"yalovyyi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yalovyyi&avatarId=24941","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yalovyyi&avatarId=24941","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yalovyyi&avatarId=24941","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yalovyyi&avatarId=24941"},"displayName":"Illya Yalovyy","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-11-21T22:26:01.208+0000","updated":"2016-11-21T22:26:01.208+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15684948","id":"15684948","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"[~yalovyyi] I just linked the RB to the jira. https://reviews.apache.org/r/53966/","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-21T22:30:54.116+0000","updated":"2016-11-21T22:30:54.116+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15684955","id":"15684955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"That would be really helpful. I don't know how hard or easy that would be as I've seen Hive uses the _copy_# in other parts of the code. We could try to solve that in another jira as a good supportability item for S3.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-21T22:34:25.644+0000","updated":"2016-11-21T22:34:25.644+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15685151","id":"15685151","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"Attach a new patch that do not call {{destFs.exists}} when HDFS is used. This is to avoid performance penalties when HDFS Is used.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-21T23:53:31.503+0000","updated":"2016-11-21T23:53:31.503+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15685334","id":"15685334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12839914/HIVE-15199.8.patch\n\n{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10716 tests executed\n*Failed tests:*\n{noformat}\nTestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=108)\n\t[tez_joins_explain.q,transform2.q,groupby5.q,cbo_semijoin.q,bucketmapjoin13.q,union_remove_6_subq.q,groupby2_map_multi_distinct.q,load_dyn_part9.q,multi_insert_gby2.q,vectorization_11.q,groupby_position.q,avro_compression_enabled_native.q,smb_mapjoin_8.q,join21.q,auto_join16.q]\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2234/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2234/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2234/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 5 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12839914 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-11-22T01:24:17.729+0000","updated":"2016-11-22T01:24:17.729+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15687108","id":"15687108","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"I do think I'd rather fix this in s3, because it is adding 2 GET calls and a LIST before each rename, calls which take place in the rename itself. And of course, when Hadoop 2.8 or derivatives change s3a's rename to == HDFS, the check will be superfluous. Similarly, once you have a consistent FS view (s3guard, etc),  you are less likely to see a mismatch between listing and stat-ing. If you are, it means something else is writing to the same dir, putting you in trouble.\n\nWould it be possible to set this up to make it easy to turn off in future. For example: create the JIRA on stripping the exists check out?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2016-11-22T15:58:52.487+0000","updated":"2016-11-22T15:58:52.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15687154","id":"15687154","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"I moved the listFiles() to the beginning of the method to avoid calling it for each new rename. However, we still have the 2 GET calls on each rename (exists && rename), I added a validation to do this on S3 only, and leave only the rename call on HDFS.\n\nAs you mentioned, when S3Guard is released, this would help us a lot on consistency, and we could remove the exists() call. I think the listFiles() is still beneficial so Hive can figure out the next filename to use when renaming the file.\n\nThe code change is pretty easy, so I can create a Jira to remove it in the future.\n{noformat}\n+      boolean isBlobStoragePath = BlobStorageUtils.isBlobStoragePath(conf, destDirPath);\n+      while ((isBlobStoragePath && destFs.exists(destFilePath)) || !destFs.rename(sourcePath, destFilePath)) {\n+        destFilePath = createCopyFilePath(destDirPath, name, type, ++counter);\n+      }\n{noformat}\n\nIs the S3Guard going to be released on Hadoop 2.8?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-22T16:17:52.126+0000","updated":"2016-11-22T16:17:52.126+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15687764","id":"15687764","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"The HIVE-14535 branch might be interesting to compare, since it prevents multiple queries from using the same path.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-11-22T20:12:58.637+0000","updated":"2016-11-22T20:12:58.637+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15687962","id":"15687962","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yalovyyi","name":"yalovyyi","key":"yalovyyi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yalovyyi&avatarId=24941","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yalovyyi&avatarId=24941","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yalovyyi&avatarId=24941","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yalovyyi&avatarId=24941"},"displayName":"Illya Yalovyy","active":true,"timeZone":"America/Los_Angeles"},"body":"[~spena] Thank you for the CR link. I have added some comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yalovyyi","name":"yalovyyi","key":"yalovyyi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yalovyyi&avatarId=24941","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yalovyyi&avatarId=24941","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yalovyyi&avatarId=24941","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yalovyyi&avatarId=24941"},"displayName":"Illya Yalovyy","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-11-22T21:32:10.945+0000","updated":"2016-11-22T21:32:10.945+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15687963","id":"15687963","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"body":"[~yalovyyi] what other problems with S3 do you think this would help with? In what way would this help with eventual consistency? I agree having the query-id in the file name is good, but I do agree with Sergio that we need to be careful and see what other parts of the code rely on the file name. We should also be wary if any external clients rely on these file names.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stakiar","name":"stakiar","key":"stakiar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sahil Takiar","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-22T21:32:36.832+0000","updated":"2016-11-22T21:32:36.832+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15688151","id":"15688151","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"Addressed issues from [~yalovyyi] on the RB.\n\nAlso, I'll keep to the if (!exists || !rename) condition on S3, and not using the listFiles() to avoid OOM issues with concurrent HS2 requests. We can design a better performance approach in a different JIRA.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-22T22:37:01.880+0000","updated":"2016-11-22T22:37:01.880+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15688250","id":"15688250","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ychena","name":"ychena","key":"ychena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongzhi Chen","active":true,"timeZone":"Etc/UTC"},"body":"+1 for 9th patch pending tests","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ychena","name":"ychena","key":"ychena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongzhi Chen","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-22T23:15:11.875+0000","updated":"2016-11-22T23:15:11.875+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15688635","id":"15688635","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12840142/HIVE-15199.9.patch\n\n{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 29 failed/errored test(s), 10717 tests executed\n*Failed tests:*\n{noformat}\nTestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=118)\n\t[stats12.q,groupby4.q,union_top_level.q,groupby10.q,subquery_in.q,mapjoin_filter_on_outerjoin.q,auto_sortmerge_join_4.q,limit_partition_metadataonly.q,load_dyn_part4.q,union3.q,groupby_multi_single_reducer.q,smb_mapjoin_14.q,groupby3_noskew_multi_distinct.q,stats18.q,union_remove_21.q]\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[annotate_stats_deep_filters] (batchId=80)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[dynamic_partition_insert] (batchId=50)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[input43] (batchId=2)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[load_orc] (batchId=70)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[load_orc_part] (batchId=13)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_merge11] (batchId=36)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_merge12] (batchId=56)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_merge9] (batchId=24)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_merge_incompat3] (batchId=8)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[global_limit] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_llap_counters1] (batchId=131)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_llap_counters] (batchId=135)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_basic] (batchId=131)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_merge11] (batchId=143)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_merge9] (batchId=140)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_merge_incompat3] (batchId=137)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)\norg.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[orc_merge9] (batchId=156)\norg.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[parallel_orderby] (batchId=157)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[orc_merge12] (batchId=90)\norg.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver[parallel_orderby] (batchId=81)\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[load_orc_negative_part] (batchId=83)\norg.apache.hive.hcatalog.pig.TestSequenceFileHCatStorer.testWriteDecimal (batchId=170)\norg.apache.hive.hcatalog.pig.TestSequenceFileHCatStorer.testWriteDecimalXY (batchId=170)\norg.apache.hive.spark.client.TestSparkClient.testJobSubmission (batchId=272)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2250/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2250/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2250/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 29 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12840142 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-11-23T02:19:54.471+0000","updated":"2016-11-23T02:19:54.471+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15691000","id":"15691000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12840269/HIVE-15199.10.patch\n\n{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 10718 tests executed\n*Failed tests:*\n{noformat}\nTestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=107)\n\t[groupby_grouping_id2.q,input17.q,bucketmapjoin12.q,ppd_gby_join.q,auto_join10.q,ptf_rcfile.q,vectorized_rcfile_columnar.q,vector_elt.q,ppd_join5.q,ppd_join.q,join_filters_overlap.q,join_cond_pushdown_1.q,timestamp_3.q,load_dyn_part6.q,stats_noscan_2.q]\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2263/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2263/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2263/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 4 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12840269 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-11-23T18:42:32.252+0000","updated":"2016-11-23T18:42:32.252+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020602/comment/15691008","id":"15691008","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"body":"Thanks all for the code review. I committed this to master.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spena","name":"spena","key":"spena","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergio Peña","active":true,"timeZone":"America/Chicago"},"created":"2016-11-23T18:45:35.173+0000","updated":"2016-11-23T18:45:35.173+0000"}],"maxResults":43,"total":43,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-15199/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i36b2n:"}}