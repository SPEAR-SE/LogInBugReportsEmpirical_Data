{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12689589","self":"https://issues.apache.org/jira/rest/api/2/issue/12689589","key":"HIVE-6225","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Dec 02 14:24:07 UTC 2014","customfield_12310420":"368556","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_27530649706_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-12-02T14:24:41.490+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-6225/watchers","watchCount":3,"isWatching":false},"created":"2014-01-17T23:00:31.824+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12395322","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12395322","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"outwardIssue":{"id":"12737244","key":"HIVE-7895","self":"https://issues.apache.org/jira/rest/api/2/issue/12737244","fields":{"summary":"Storage based authorization should consider sticky bit for drop actions","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-12-02T14:24:41.526+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12317300","id":"12317300","name":"Authorization","description":"Security Subcomponent"}],"timeoriginalestimate":null,"description":"Sticky bit works on HDFS, preventing a user from removing an item created by another user in a directory with permissions of 1777.\n\nHowever, Hive allows the table to be dropped even after setting hive.metastore.authorization.storage.checks to true and /user/hive/metastore to 1777 ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"368860","customfield_12312823":null,"summary":"hive.metastore.authorization.storage.checks doesn't respect sticky bit","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caseyjbrotherton","name":"caseyjbrotherton","key":"caseyjbrotherton","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Casey Brotherton","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caseyjbrotherton","name":"caseyjbrotherton","key":"caseyjbrotherton","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Casey Brotherton","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12689589/comment/13875377","id":"13875377","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caseyjbrotherton","name":"caseyjbrotherton","key":"caseyjbrotherton","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Casey Brotherton","active":true,"timeZone":"America/Chicago"},"body":"Appears to be a problem with drop_table_core from HiveMetaStore calling isWritable on the parent path of a table. \n\nisWritable is a method in the Warehouse object, and just does a normal check of writable permissions.\n\nIt appears a new method is required, that will be passed in the path for the table, and will check for the sticky bit of the parent, and in that case, check the owner of the table path. \nOtherwise will call isWritable on the parent.\n\nIn addition to drop_table_core, there are other suspect calls to isWritable within HiveMetaStore.java. \n ( All of the calls below to a getParent should be evaluated to see if there is a change, or delete to a child within the parent...In that case, the sticky bit may need to be checked. )\n\n if (!wh.isWritable(path)) { \n if (!wh.isWritable(tablePath.getParent())) { \n if (!wh.isWritable(tblPath.getParent())) { \n if (!wh.isWritable(partPath.getParent())) { \n if (!wh.isWritable(archiveParentDir.getParent())) { \n if (!wh.isWritable(partPath.getParent())) { \n if (!wh.isWritable(tblPath.getParent())) {\n\nHow HDFS handles the permissions is by definition correct. It is just that the hive.metastore.authorization.storage.checks forces Hive to guess how HDFS will react before starting the action.\nFor example: with the current code, with /user/hive/warehouse having permissions 1777 , and a table foo created by casey.\nIf you logged in as johndoe, and dropped foo...It would remove foo from the metastore, and then there would be an error within the Hive logs as johndoe was not able to remove the directory from HDFS. \n\n( Adapted from logs in the customer's environment to remove customer host names. )\n2013-09-19 14:33:00,485 INFO hive.metastore.hivemetastoressimpl: deleting hdfs://host.com:8020/user/hive/warehouse/foo\n2013-09-19 14:33:00,499 WARN org.apache.hadoop.fs.TrashPolicyDefault: Can't create trash directory: hdfs://host.com:8020/user/johndoe/.Trash/Current/user/hive/warehouse\n2013-09-19 14:33:00,602 ERROR hive.log: Got exception: java.io.IOException Failed to move to trash: hdfs://host.com:8020/user/hive/warehouse/foo\n2013-09-19 14:33:00,603 ERROR hive.log: java.io.IOException: Failed to move to trash: hdfs://host.com:8020/user/hive/warehouse/foo\nat org.apache.hadoop.fs.TrashPolicyDefault.moveToTrash(TrashPolicyDefault.java:154)\nat org.apache.hadoop.fs.Trash.moveToTrash(Trash.java:109)\n...\n\nWhy I suggest a new method, is that knowledge of the table ownership is needed as well as the permissions of the parent directory.\n\n\nInteresting side note, when one enables hive.security.metastore.authorization.manager to be org.apache.hadoop.hive.ql.security.authorization.StorageBasedAuthorizationProvider \nand enables hive.metastore.pre.event.listeners ( With org.apache.hadoop.hive.ql.security.authorization.AuthorizationPreEventListener ), the StorageBasedAuthorizationProvider \nattempts to perform similar checks, but seems to always check the current table directory, and not the parent at all. In addition, the code does not check the \nsticky bit of any directories.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caseyjbrotherton","name":"caseyjbrotherton","key":"caseyjbrotherton","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Casey Brotherton","active":true,"timeZone":"America/Chicago"},"created":"2014-01-17T23:07:36.370+0000","updated":"2014-01-17T23:07:36.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12689589/comment/14231533","id":"14231533","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caseyjbrotherton","name":"caseyjbrotherton","key":"caseyjbrotherton","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Casey Brotherton","active":true,"timeZone":"America/Chicago"},"body":"The code has changed significantly since this Jira was opened.  There are also several Jiras addressing the same:\n\nHIVE-7927\nHIVE-7895\n\nCancelling this Jira, will open a new Jira if there is still concerns.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caseyjbrotherton","name":"caseyjbrotherton","key":"caseyjbrotherton","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Casey Brotherton","active":true,"timeZone":"America/Chicago"},"created":"2014-12-02T14:24:07.912+0000","updated":"2014-12-02T14:24:07.912+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-6225/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1rivz:"}}