{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13109398","self":"https://issues.apache.org/jira/rest/api/2/issue/13109398","key":"HIVE-17810","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-11-07T15:53:57.204+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Nov 07 15:53:57 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17810/watchers","watchCount":2,"isWatching":false},"created":"2017-10-13T22:55:12.474+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-11-07T18:54:11.760+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12320409","id":"12320409","name":"HCatalog","description":"Tracks issues related to the HCatalog"}],"timeoriginalestimate":null,"description":"I've attached a simple test case using the AvroSerde (which generates it's own columns) that, when run will throw this error:\r\n{noformat}\r\n2017-10-13T15:49:17,697 ERROR [pool-6-thread-2] metastore.RetryingHMSHandler: MetaException(message:java.lang.NullPointerException)\r\n\tat org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.newMetaException(HiveMetaStore.java:6560)\r\n\tat org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.create_table_with_environment_context(HiveMetaStore.java:1635)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.apache.hadoop.hive.metastore.RetryingHMSHandler.invokeInternal(RetryingHMSHandler.java:148)\r\n\tat org.apache.hadoop.hive.metastore.RetryingHMSHandler.invoke(RetryingHMSHandler.java:107)\r\n\tat com.sun.proxy.$Proxy30.create_table_with_environment_context(Unknown Source)\r\n\tat org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Processor$create_table_with_environment_context.getResult(ThriftHiveMetastore.java:11710)\r\n\tat org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Processor$create_table_with_environment_context.getResult(ThriftHiveMetastore.java:11694)\r\n\tat org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39)\r\n\tat org.apache.hadoop.hive.metastore.TUGIBasedProcessor$1.run(TUGIBasedProcessor.java:110)\r\n\tat org.apache.hadoop.hive.metastore.TUGIBasedProcessor$1.run(TUGIBasedProcessor.java:106)\r\n\tat java.security.AccessController.doPrivileged(Native Method)\r\n\tat javax.security.auth.Subject.doAs(Subject.java:422)\r\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1807)\r\n\tat org.apache.hadoop.hive.metastore.TUGIBasedProcessor.process(TUGIBasedProcessor.java:118)\r\n\tat org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:286)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n\tat java.lang.Thread.run(Thread.java:745)\r\nCaused by: java.lang.NullPointerException\r\n\tat org.apache.hadoop.hive.metastore.MetaStoreUtils.validateTblColumns(MetaStoreUtils.java:621)\r\n\tat org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.create_table_core(HiveMetaStore.java:1433)\r\n\tat org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.create_table_core(HiveMetaStore.java:1420)\r\n\tat org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.create_table_with_environment_context(HiveMetaStore.java:1621)\r\n\t... 20 more\r\n{noformat}\r\n\r\nBy default the StorageDescriptor in the HCatTable class has a null column list.  When calling hCatTable.cols(emptyList), the hCatTable will determine that the list is equal to it's current column list and won't set the empty column list on the StorageDescriptor, thus leading to the NullPointerException.\r\n\r\nA workaround is to call HCatTable.cols with a list that contains a fake field, and then call HCatTable.cols with an empty list.  This will set the column list on the StorageDescriptor to the empty list, and allow the table to be created.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Creating a table through HCatClient without specifying columns throws a NullPointerException on the server","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stephenpatel","name":"stephenpatel","key":"stephenpatel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Stephen Patel","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stephenpatel","name":"stephenpatel","key":"stephenpatel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Stephen Patel","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13109398/comment/16204312","id":"16204312","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stephenpatel","name":"stephenpatel","key":"stephenpatel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Stephen Patel","active":true,"timeZone":"America/Chicago"},"body":"I put this in the TestHCatClient class:\r\n{code}\r\n/**\r\n   * This test tests that a Create Table statement without columns works\r\n   * @throws Exception\r\n   */\r\n  @Test\r\n  public void testNoColumnTableInstantiation() throws Exception {\r\n    HCatClient client = HCatClient.create(new Configuration(hcatConf));\r\n\r\n\r\n    String dbName = \"default\";\r\n    String tblName = \"testNoColumnTableInstantiation\";\r\n    ArrayList<HCatFieldSchema> cols = new ArrayList<HCatFieldSchema>();\r\n    HCatTable table = new HCatTable(dbName, tblName)\r\n                                .cols(cols)\r\n                                .serdeLib(AvroSerDe.class.getName())\r\n                                .tblProps(ImmutableMap.of(\"avro.schema.literal\", \"{\\\"type\\\": \\\"record\\\",\" +\r\n                                        \"\\\"namespace\\\": \\\"com.example\\\",\" +\r\n                                        \"\\\"name\\\": \\\"FullName\\\",\" +\r\n                                        \"\\\"fields\\\": [{ \\\"name\\\": \\\"first\\\", \\\"type\\\": \\\"string\\\" }] }\"))\r\n                                .inputFileFormat(AvroContainerInputFormat.class.getName())\r\n                                .outputFileFormat(AvroContainerOutputFormat.class.getName());\r\n\r\n    client.dropTable(dbName, tblName, true);\r\n    try {\r\n      // Create an avro table with no columns\r\n      client.createTable(HCatCreateTableDesc\r\n              .create(table, false)\r\n              .build());\r\n    }catch (Throwable e){\r\n      fail(\"An error occurred creating Columnless table: \"+e.getMessage());\r\n    }\r\n  }\r\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stephenpatel","name":"stephenpatel","key":"stephenpatel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Stephen Patel","active":true,"timeZone":"America/Chicago"},"created":"2017-10-13T22:58:54.934+0000","updated":"2017-10-13T22:58:54.934+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13109398/comment/16242239","id":"16242239","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spatel89","name":"spatel89","key":"spatel89","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen Patel","active":true,"timeZone":"Etc/UTC"},"body":"I can't seem to attach a file, but here's a patch:\r\n\r\n{noformat}\r\ndiff --git hcatalog/webhcat/java-client/src/main/java/org/apache/hive/hcatalog/api/HCatTable.java hcatalog/webhcat/java-client/src/main/java/org/apache/hive/hcatalog/api/HCatTable.java\r\nindex 99af291..070fb48 100644\r\n--- hcatalog/webhcat/java-client/src/main/java/org/apache/hive/hcatalog/api/HCatTable.java\r\n+++ hcatalog/webhcat/java-client/src/main/java/org/apache/hive/hcatalog/api/HCatTable.java\r\n@@ -18,11 +18,7 @@\r\n  */\r\n package org.apache.hive.hcatalog.api;\r\n \r\n-import java.util.ArrayList;\r\n-import java.util.EnumSet;\r\n-import java.util.HashMap;\r\n-import java.util.List;\r\n-import java.util.Map;\r\n+import java.util.*;\r\n \r\n import com.google.common.collect.Maps;\r\n import org.apache.commons.lang.StringUtils;\r\n@@ -131,6 +127,7 @@ public HCatTable(String dbName, String tableName) {\r\n     this.sd.getSerdeInfo().setSerializationLib(DEFAULT_SERDE_CLASS);\r\n     this.sd.getSerdeInfo().setParameters(new HashMap<String, String>());\r\n     this.sd.getSerdeInfo().getParameters().put(serdeConstants.SERIALIZATION_FORMAT, \"1\"); // Default serialization format.\r\n+    this.sd.setCols(new ArrayList<FieldSchema>());\r\n   }\r\n \r\n   HCatTable(Table hiveTable) throws HCatException {\r\ndiff --git hcatalog/webhcat/java-client/src/test/java/org/apache/hive/hcatalog/api/TestHCatClient.java hcatalog/webhcat/java-client/src/test/java/org/apache/hive/hcatalog/api/TestHCatClient.java\r\nindex 78e767e..85697ba 100644\r\n--- hcatalog/webhcat/java-client/src/test/java/org/apache/hive/hcatalog/api/TestHCatClient.java\r\n+++ hcatalog/webhcat/java-client/src/test/java/org/apache/hive/hcatalog/api/TestHCatClient.java\r\n@@ -30,7 +30,9 @@\r\n import java.util.Random;\r\n \r\n import com.google.common.base.Function;\r\n+import com.google.common.collect.ImmutableMap;\r\n import com.google.common.collect.Iterables;\r\n+import org.apache.avro.Schema;\r\n import org.apache.hadoop.conf.Configuration;\r\n import org.apache.hadoop.fs.Path;\r\n import org.apache.hadoop.hive.conf.HiveConf;\r\n@@ -43,11 +45,14 @@\r\n import org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat;\r\n import org.apache.hadoop.hive.ql.io.RCFileInputFormat;\r\n import org.apache.hadoop.hive.ql.io.RCFileOutputFormat;\r\n+import org.apache.hadoop.hive.ql.io.avro.AvroContainerInputFormat;\r\n+import org.apache.hadoop.hive.ql.io.avro.AvroContainerOutputFormat;\r\n import org.apache.hadoop.hive.ql.io.orc.OrcInputFormat;\r\n import org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat;\r\n import org.apache.hadoop.hive.ql.io.orc.OrcSerde;\r\n import org.apache.hadoop.hive.ql.metadata.Table;\r\n import org.apache.hadoop.hive.serde.serdeConstants;\r\n+import org.apache.hadoop.hive.serde2.avro.AvroSerDe;\r\n import org.apache.hadoop.hive.serde2.columnar.LazyBinaryColumnarSerDe;\r\n import org.apache.hadoop.hive.shims.Utils;\r\n import org.apache.hadoop.mapred.TextInputFormat;\r\n@@ -225,7 +230,7 @@ public void testBasicDDLCommands() throws Exception {\r\n       table2.getSerdeParams().get(serdeConstants.COLLECTION_DELIM));\r\n     assertEquals(\"checking \" + serdeConstants.SERIALIZATION_NULL_FORMAT, Character.toString('\\006'),\r\n       table2.getSerdeParams().get(serdeConstants.SERIALIZATION_NULL_FORMAT));\r\n-    \r\n+\r\n     assertTrue(table2.getLocation().toLowerCase().matches(\".*\" + (\"/\" + db + \".db/\" + tableTwo).toLowerCase()));\r\n \r\n     HCatCreateTableDesc tableDesc3 = HCatCreateTableDesc.create(db,\r\n@@ -285,6 +290,39 @@ public void testEmptyTableInstantiation() throws Exception {\r\n   }\r\n \r\n   /**\r\n+   * This test tests that a Create Table statement without columns works\r\n+   * @throws Exception\r\n+   */\r\n+  @Test\r\n+  public void testNoColumnTableInstantiation() throws Exception {\r\n+    HCatClient client = HCatClient.create(new Configuration(hcatConf));\r\n+\r\n+\r\n+    String dbName = \"default\";\r\n+    String tblName = \"testNoColumnTableInstantiation\";\r\n+    ArrayList<HCatFieldSchema> cols = new ArrayList<HCatFieldSchema>();\r\n+    HCatTable table = new HCatTable(dbName, tblName)\r\n+                                .cols(cols)\r\n+                                .serdeLib(AvroSerDe.class.getName())\r\n+                                .tblProps(ImmutableMap.of(\"avro.schema.literal\", \"{\\\"type\\\": \\\"record\\\",\" +\r\n+                                        \"\\\"namespace\\\": \\\"com.example\\\",\" +\r\n+                                        \"\\\"name\\\": \\\"FullName\\\",\" +\r\n+                                        \"\\\"fields\\\": [{ \\\"name\\\": \\\"first\\\", \\\"type\\\": \\\"string\\\" }] }\"))\r\n+                                .inputFileFormat(AvroContainerInputFormat.class.getName())\r\n+                                .outputFileFormat(AvroContainerOutputFormat.class.getName());\r\n+\r\n+    client.dropTable(dbName, tblName, true);\r\n+    try {\r\n+      // Create an avro table with no columns\r\n+      client.createTable(HCatCreateTableDesc\r\n+              .create(table, false)\r\n+              .build());\r\n+    }catch (Throwable e){\r\n+      fail(\"An error occurred creating Columnless table: \"+e.getMessage());\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n    * Verifies that an inner map is present inside an outer map, with\r\n    * all values being equal.\r\n    */\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=spatel89","name":"spatel89","key":"spatel89","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen Patel","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-07T15:53:57.204+0000","updated":"2017-11-07T15:53:57.204+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17810/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3l9mv:"}}