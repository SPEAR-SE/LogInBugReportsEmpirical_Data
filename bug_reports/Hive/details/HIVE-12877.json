{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12931374","self":"https://issues.apache.org/jira/rest/api/2/issue/12931374","key":"HIVE-12877","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-01-16T03:19:16.740+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Feb 01 07:26:25 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-12877/watchers","watchCount":1,"isWatching":false},"created":"2016-01-15T06:40:38.655+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12332384","id":"12332384","name":"1.2.1","archived":false,"released":true,"releaseDate":"2015-06-26"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-02-01T07:26:25.006+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313710","id":"12313710","name":"Indexing"}],"timeoriginalestimate":null,"description":"Hive created the index using the extracted file length when the file is  the compressed,\nbut when to divide the data into pieces in MapReduce,Hive use the file length to compare with the extracted file length,if\nIf it found that these two lengths are not matched, It filters out the file.So the query will lose some data.\nI modified the source code and make hive index can be used when the files is compressed,please test it.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12785470","id":"12785470","filename":"19-index_compressed_file.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"created":"2016-02-01T07:20:18.058+0000","size":15114257,"mimeType":"application/gzip","content":"https://issues.apache.org/jira/secure/attachment/12785470/19-index_compressed_file.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12785468","id":"12785468","filename":"HIVE-12877.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"created":"2016-02-01T07:20:18.051+0000","size":2435,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12785468/HIVE-12877.1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12782464","id":"12782464","filename":"HIVE-12877.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"created":"2016-01-15T07:05:24.281+0000","size":1248,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12782464/HIVE-12877.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12785469","id":"12785469","filename":"index_query_compressed_file_failure.q","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"created":"2016-02-01T07:20:18.055+0000","size":2499,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12785469/index_query_compressed_file_failure.q"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Hive use index for queries will lose some data if the Query file is compressed.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"This problem exists in all Hive versions.no matter what platform","customfield_12313520":null,"customfield_12311020":null,"duedate":"2016-01-15","customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12931374/comment/15101328","id":"15101328","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"body":"I create partitioned table and load .gz file into the partition:\nCREATE EXTERNAL TABLE IF NOT EXISTS if_pmt_note_staging (\napsdactno string, date_tr string, apsdjrnno string, apsdseqno string, province_code string\n) partitioned by (batch_id string);\n\nalter table if_pmt_note_staging add partition (batch_id='201510') location '/hive/if_pmt_note_staging';\n\nThe location '/hive/if_pmt_note_staging' has some .gz files. such as 1.gz,2.gz and so on\n\nthen I create index:\n\nCREATE INDEX index_if_pmt_note_staging_date_tr \nON TABLE if_pmt_note_staging (date_tr) \nAS 'org.apache.hadoop.hive.ql.index.compact.CompactIndexHandler' \nWITH DEFERRED REBUILD \nIN TABLE t_index_if_pmt_note_staging_date_tr; \n\nalter index index_if_pmt_note_staging_date_tr on if_pmt_note_staging rebuild; \n\nCREATE INDEX index_apsh_province_code_apsdprocod_apsdactno_tr\nON TABLE apsh (apsdprocod) \nAS 'org.apache.hadoop.hive.ql.index.compact.CompactIndexHandler' \nWITH DEFERRED REBUILD\nIN TABLE t_index_province_code_apsdprocod_apsdactno_tr;\n\nwhen I excute query use the the index date_tr:\nselect * from if_pmt_note_staging where date_tr='20121205';\n\nI found that some of the data should be queried without query. such as the matched data in the 3.gz file\n\nThe hive logs print as follows:\nsplit start : 10336\nsplit end : 59916\n...................\n\nIt is true that hiveIndexResult.contains function Filter out some files in the HiveIndexedInputFormat,  the function list as below:\n\n  public boolean contains(FileSplit split) throws HiveException {\n  \n    ....................\n    for (Long offset : bucket.getOffsets()) {\n      if ((offset >= split.getStart())\n          && (offset <= split.getStart() + split.getLength())) {\n        return true;\n      }\n    }\n   }\nthe offset length  is the length of the file after decompression ,but the split.getLength() is the length of the file before decompression. so some files may filter out by this function.\nIt seemed this section of code isn't necessary, we can delete it. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"created":"2016-01-15T06:51:49.403+0000","updated":"2016-01-15T06:51:49.403+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12931374/comment/15101336","id":"15101336","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"body":"   Hive use index for queries will lose some data if the Query file is compressed.\n   Hive created the index using the extracted file length when use the file is  the compressed, but when to divide the data into pieces in MapReduce,Hive use the file length to compare with the extracted file length,If it found that these two lengths are not matched, It filters out the file.So the query will lose some data.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"created":"2016-01-15T07:03:56.952+0000","updated":"2016-01-15T07:03:56.952+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12931374/comment/15102955","id":"15102955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12782464/HIVE-12877.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 6 failed/errored test(s), 10019 tests executed\n*Failed tests:*\n{noformat}\nTestHWISessionManager - did not produce a TEST-*.xml file\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_tez_union\norg.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import\norg.apache.hadoop.hive.ql.exec.spark.session.TestSparkSessionManagerImpl.testMultiSessionMultipleUse\norg.apache.hadoop.hive.ql.exec.spark.session.TestSparkSessionManagerImpl.testSingleSessionMultipleUse\norg.apache.hive.jdbc.TestSSL.testSSLVersion\n{noformat}\n\nTest results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6642/testReport\nConsole output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6642/console\nTest logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-6642/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 6 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12782464 - PreCommit-HIVE-TRUNK-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-01-16T03:19:16.740+0000","updated":"2016-01-16T03:19:16.740+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12931374/comment/15106046","id":"15106046","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"body":"None of the test failures here are related or regressions, could you please take a quick look at this patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"created":"2016-01-19T00:53:34.541+0000","updated":"2016-01-19T00:53:34.541+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12931374/comment/15125499","id":"15125499","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"[~yangfang] Can you add test in the patch ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-01-31T20:51:58.081+0000","updated":"2016-01-31T20:52:30.045+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12931374/comment/15125875","id":"15125875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"body":"I have add .q test in index_query_compressed_file_failure.q, 19-index_compressed_file.gz is my compressed file which used for test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangfang","name":"yangfang","key":"yangfang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangfang","active":true,"timeZone":"Etc/UTC"},"created":"2016-02-01T07:26:25.006+0000","updated":"2016-02-01T07:26:25.006+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-12877/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2riaf:"}}