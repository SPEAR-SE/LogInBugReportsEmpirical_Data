{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13060234","self":"https://issues.apache.org/jira/rest/api/2/issue/13060234","key":"HIVE-16332","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-08-29T12:48:56.380+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Aug 29 12:48:56 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-16332/watchers","watchCount":1,"isWatching":false},"created":"2017-03-30T02:51:19.015+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":["patch"],"customfield_12312333":null,"customfield_12310230":"orc array","customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335838","id":"12335838","description":"Maintenance branch for 2.1 ","name":"2.1.1","archived":false,"released":true,"releaseDate":"2016-12-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=houzhizhen","name":"houzhizhen","key":"houzhizhen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhizhen Hou","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-09-14T01:29:14.075+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12328244","id":"12328244","name":"ORC"}],"timeoriginalestimate":null,"description":"##The step to reproduce the result.\n1. First crate a text format table with array type field in hive.\n\n```\n create table test_text_orc (\n  col_int bigint,\n  col_text string, \n  col_array array<string>, \n  col_map map<string, string>\n  ) \n  PARTITIONED BY (\n   day string\n   )\n   ROW FORMAT DELIMITED\n FIELDS TERMINATED BY ',' \n collection items TERMINATED  BY ']'\n map keys TERMINATED BY ':'\n  ;\n \n```\n2. Create new text file hive-orc-text-file-array-error-test.txt.\n```\n1,text_value1,array_value1]array_value2]array_value3, map_key1:map_value1,map_key2:map_value2\n2,text_value2,array_value4, map_key1:map_value3\n,text_value3,, map_key1:]map_key3:map_value3\n```\n3.  Load the data into one partition.\n\n```\n LOAD DATA local INPATH '.hive-orc-text-file-array-error-test.txt' overwrite into table test_text_orc partition(day=20170329)\n```\n\n4. select the data to verify the result.\n```\nhive> select * from test.test_text_orc;\nOK\n1\ttext_value1\t[\"array_value1\",\"array_value2\",\"array_value3\"]\t{\" map_key1\":\"map_value1\",\"map_key2\":\"map_value2\"}\t20170329\n2\ttext_value2\t[\"array_value4\"]\t{\"map_key1\":\"map_value3\"}\t20170329\nNULL\ttext_value3\t[]\t{\" map_key1\":\"\",\"map_key3\":\"map_value3\"}\t20170329\n\n```\n5. Alter table format of table to orc;\n```\n\n alter table test_text_orc set fileformat orc;\n```\n6. Check the result again, and you can see the  error result.\n\n```\nhive> select * from test.test_text_orc;\nOK\n1\ttext_value1\t[\"array_value1\",\"array_value2\",\"array_value3\"]\t{\" map_key1\":\"map_value1\",\"map_key2\":\"map_value2\"}\t20170329\n2\ttext_value2\t[\"array_value4\",\"array_value2\",\"array_value3\"]\t{\"map_key1\":\"map_value3\"}\t20170329\nNULL\ttext_value3\t[\"array_value4\",\"array_value2\",\"array_value3\"]\t{\"map_key3\":\"map_value3\",\" map_key1\":\"\"}\t20170329\n```","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12884219","id":"12884219","filename":"HIVE-16332.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=houzhizhen","name":"houzhizhen","key":"houzhizhen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhizhen Hou","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-29T09:53:46.798+0000","size":1125,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12884219/HIVE-16332.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"When create a partitioned text format table with one partition, after we change the format of table to orc, then the array type field may output error.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=houzhizhen","name":"houzhizhen","key":"houzhizhen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhizhen Hou","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=houzhizhen","name":"houzhizhen","key":"houzhizhen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhizhen Hou","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13060234/comment/15948343","id":"15948343","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=houzhizhen","name":"houzhizhen","key":"houzhizhen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhizhen Hou","active":true,"timeZone":"Etc/UTC"},"body":"\n##  Reason Analysis\n ObjectInspectorConverters$ListConverter instance does not clean the data of previous record, \n When the size of  array of current row is less than that of previous row, it data of list will not be fully overwrite \n and the not overwrited data will be output.\n\n## Code Analysis\nIn FetchOperator.nextRow. At first, it deserializes the value using the currSerDe, currSerDe is the SerDe of partition.\nSecond, ObjectConverter is an instance of ObjectInspectorConverters$StructConverter\n```\n         Object deserialized = currSerDe.deserialize(value);\n          if (ObjectConverter != null) {\n            deserialized = ObjectConverter.convert(deserialized);\n          }\n```\nIn method convert,  it read out every field value in turn, and it uses the consponding  converter to convert the field value.\nAfter change the format of table to orc,  with the  type field array, the consponding convert is ObjectInspectorConverters$ListConverter.\n```\n@Override\n    public Object convert(Object input) {\n      if (input == null) {\n        return null;\n      }\n\n      int minFields = Math.min(inputFields.size(), outputFields.size());\n      // Convert the fields\n      for (int f = 0; f < minFields; f++) {\n        Object inputFieldValue = inputOI.getStructFieldData(input, inputFields.get(f));\n        Object outputFieldValue = fieldConverters.get(f).convert(inputFieldValue);\n        outputOI.setStructFieldData(output, outputFields.get(f), outputFieldValue);\n      }\n\n      // set the extra fields to null\n      for (int f = minFields; f < outputFields.size(); f++) {\n        outputOI.setStructFieldData(output, outputFields.get(f), null);\n      }\n\n      return output;\n    }\n  }\n  ```\n  \n  In Method ObjectInspectorConverters$ListConverter.convert,  it first creates separate element converter for each element.\n  Then, it call outputIO.resize(output,size). \n  Finally, it set every converted element to outputOI.\n  ```\n  @Override\n    public Object convert(Object input) {\n      if (input == null) {\n        return null;\n      }\n      // Create enough elementConverters\n      // NOTE: we have to have a separate elementConverter for each element,\n      // because the elementConverters can reuse the internal object.\n      // So it's not safe to use the same elementConverter to convert multiple\n      // elements.\n      int size = inputOI.getListLength(input);\n      while (elementConverters.size() < size) {\n        elementConverters.add(getConverter(inputElementOI, outputElementOI));\n      }\n\n      // Convert the elements\n      outputOI.resize(output, size);\n      for (int index = 0; index < size; index++) {\n        Object inputElement = inputOI.getListElement(input, index);\n        Object outputElement = elementConverters.get(index).convert(\n            inputElement);\n        outputOI.set(output, index, outputElement);\n      }\n      return output;\n    }\n\n  }\n  ```\n   The problem is in method resize, it does not clear all the data of previous, simply calls ensureCapacity. \n   When the size of  array of current row is less than that of previous row, it data of list will not be fully overwrite and the not overwrited data will be output.\n  ```\n  public Object resize(Object list, int newSize) {\n      ((ArrayList) list).ensureCapacity(newSize);\n      return list;\n    }\n  ```\n  \n  ## The method of amending.\n```\n  public Object resize(Object list, int newSize) {\n  ((ArrayList) list).clear();\n  return list;\n}\n\n```","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=houzhizhen","name":"houzhizhen","key":"houzhizhen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhizhen Hou","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-30T03:20:47.930+0000","updated":"2017-03-30T03:20:47.930+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13060234/comment/16145025","id":"16145025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=houzhizhen","name":"houzhizhen","key":"houzhizhen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhizhen Hou","active":true,"timeZone":"Etc/UTC"},"body":"IMHO, the ArrayList.ensureCapacity  does not clear all the data of previous row.\n      When the size of array of current row is less than that of previous row, it data of list will not be fully   overwrite and the not overwrite data will be output.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=houzhizhen","name":"houzhizhen","key":"houzhizhen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhizhen Hou","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-29T09:54:43.217+0000","updated":"2017-08-29T09:54:43.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13060234/comment/16145226","id":"16145226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12884219/HIVE-16332.1.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 6 failed/errored test(s), 11000 tests executed\n*Failed tests:*\n{noformat}\nTestTxnCommandsBase - did not produce a TEST-*.xml file (likely timed out) (batchId=280)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=61)\norg.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_vectorized_dynamic_partition_pruning] (batchId=169)\norg.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=234)\norg.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=234)\norg.apache.hadoop.hive.cli.TestSparkCliDriver.org.apache.hadoop.hive.cli.TestSparkCliDriver (batchId=102)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/6580/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/6580/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6580/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 6 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12884219 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2017-08-29T12:48:56.380+0000","updated":"2017-08-29T12:48:56.380+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-16332/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3cz9z:"}}