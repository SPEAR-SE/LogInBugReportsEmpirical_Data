{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13078040","self":"https://issues.apache.org/jira/rest/api/2/issue/13078040","key":"HIVE-16844","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340268","id":"12340268","name":"3.0.0","archived":false,"released":true,"releaseDate":"2018-05-21"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-06-07T18:15:50.503+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue May 22 23:58:53 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_8080_*|*_3_*:*_1_*:*_489782_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_545739815","customfield_12312321":null,"resolutiondate":"2017-06-14T00:09:51.963+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-16844/watchers","watchCount":12,"isWatching":false},"created":"2017-06-07T16:25:54.326+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12506654","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12506654","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13080080","key":"HIVE-16908","self":"https://issues.apache.org/jira/rest/api/2/issue/13080080","fields":{"summary":"Failures in TestHcatClient due to HIVE-16844","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12506655","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12506655","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13080080","key":"HIVE-16908","self":"https://issues.apache.org/jira/rest/api/2/issue/13080080","fields":{"summary":"Failures in TestHcatClient due to HIVE-16844","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-22T23:58:53.964+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312584","id":"12312584","name":"Metastore","description":"Tracks issue dealing with metastore."}],"timeoriginalestimate":null,"description":"The code path in ObjectStore.java currently leaks BoneCP (or Hikari) connection pools when a new configuration object is passed in. The code needs to ensure that the persistence-factory is closed before it is nullified.\n\nThe relevant code is [here|https://github.com/apache/hive/blob/master/metastore/src/java/org/apache/hadoop/hive/metastore/ObjectStore.java#L290]. Note that pmf is set to null, but the underlying connection pool is not closed.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12871856","id":"12871856","filename":"HIVE-16844.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-07T16:33:59.321+0000","size":630,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12871856/HIVE-16844.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Fix Connection leak in ObjectStore when new Conf object is used","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16041357","id":"16041357","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12871856/HIVE-16844.1.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 12 failed/errored test(s), 10820 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[materialized_view_create_rewrite] (batchId=237)\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_basic] (batchId=140)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=145)\norg.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=232)\norg.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=232)\norg.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query78] (batchId=232)\norg.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testBootstrapFunctionReplication (batchId=216)\norg.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testCreateFunctionIncrementalReplication (batchId=216)\norg.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testCreateFunctionWithFunctionBinaryJarsOnHDFS (batchId=216)\norg.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=177)\norg.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=177)\norg.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=177)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/5568/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/5568/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-5568/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 12 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12871856 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2017-06-07T18:15:50.503+0000","updated":"2017-06-07T18:15:50.503+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16048533","id":"16048533","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cwsteinbach","name":"cwsteinbach","key":"cwsteinbach","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Carl Steinbach","active":true,"timeZone":"America/Los_Angeles"},"body":"+1\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cwsteinbach","name":"cwsteinbach","key":"cwsteinbach","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Carl Steinbach","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-14T00:06:13.995+0000","updated":"2017-06-14T00:06:13.995+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16048538","id":"16048538","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cwsteinbach","name":"cwsteinbach","key":"cwsteinbach","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Carl Steinbach","active":true,"timeZone":"America/Los_Angeles"},"body":"Committed to master. Thanks Sunitha!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cwsteinbach","name":"cwsteinbach","key":"cwsteinbach","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Carl Steinbach","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-14T00:09:51.992+0000","updated":"2017-06-14T00:09:51.992+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16051475","id":"16051475","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sankarh","name":"sankarh","key":"sankarh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sankarh&avatarId=29945","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sankarh&avatarId=29945","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sankarh&avatarId=29945","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sankarh&avatarId=29945"},"displayName":"Sankar Hariappan","active":true,"timeZone":"Asia/Kolkata"},"body":"[~sbeeram]\n\nLooks like this patch has broken the build. \nBelow tests from TestReplicationScenariosAcrossInstances are failing ever since this patch has gone into master.\n{quote}\norg.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testBootstrapFunctionReplication (batchId=216)\norg.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testCreateFunctionIncrementalReplication (batchId=216)\norg.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testCreateFunctionWithFunctionBinaryJarsOnHDFS (batchId=216)\n{quote}\n\nI'll fix it for TestReplicationScenariosAcrossInstances along with my HIVE-16785 patch.\nCould you please check if this change broken any other tests?\n\ncc [~thejas], [~anishek], [~sushanth]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sankarh","name":"sankarh","key":"sankarh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sankarh&avatarId=29945","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sankarh&avatarId=29945","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sankarh&avatarId=29945","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sankarh&avatarId=29945"},"displayName":"Sankar Hariappan","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-06-16T06:49:23.247+0000","updated":"2017-06-16T06:49:23.247+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16051973","id":"16051973","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"body":"[~sankarh] I am tracking the failures via  HIVE-16908 - the failures were in TestHcatClient. Thanks for taking care of the TestReplicationScenariosAcrossInstances test. Does that test create multiple instances of metastore? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-16T14:30:21.783+0000","updated":"2017-06-16T14:30:21.783+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16052695","id":"16052695","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sankarh","name":"sankarh","key":"sankarh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sankarh&avatarId=29945","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sankarh&avatarId=29945","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sankarh&avatarId=29945","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sankarh&avatarId=29945"},"displayName":"Sankar Hariappan","active":true,"timeZone":"Asia/Kolkata"},"body":"[~sbeeram] Yes, it does create multiple metastore instances with different configurations. I tried to keep the configurations same and looks it is working now locally. Will submit the patch and see if the error is gone in pre-commit build.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sankarh","name":"sankarh","key":"sankarh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sankarh&avatarId=29945","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sankarh&avatarId=29945","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sankarh&avatarId=29945","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sankarh&avatarId=29945"},"displayName":"Sankar Hariappan","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-06-17T05:22:29.777+0000","updated":"2017-06-17T05:22:29.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16056902","id":"16056902","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"body":"[~sankarh] I am running into some issue fixing the unit tests and wondering if you have some input. I tried using an approach similar to what you did to fix the failures in TestReplicationScenariosAcrossInstances : ie, use the same configuration, but a different source and destination db name. However, the serialize and deserialize methods encode/decode the db and table names. I was able to work around them somewhat for: \norg.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (by resetting the target dbname via HCatTable interface)\nand \norg.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (by doing a string replace of dbName on the partition-spec string).\n\nBut for org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema, I have hit a block; I can't update the dbname through the HCatAddPartitionDesc APIs nor HCatPartition APIs. I could add methods to either of these to update the dbname (HCatTable allows that), but I am beginning to wonder if this is right approach. \n\nRunning multiple instances of Metastore within the same JVM is probably error prone as there could be other static variables in classes that might have unintended sharing, similar to how it has been an issue with this tests that this change broke. Are we better off handling these tests via integration tests and not unit tests? The other option might be to mock out the db completely.\n\nLet me know if you have further input on this. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-21T03:01:23.412+0000","updated":"2017-06-21T03:01:23.412+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16057073","id":"16057073","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sankarh","name":"sankarh","key":"sankarh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sankarh&avatarId=29945","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sankarh&avatarId=29945","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sankarh&avatarId=29945","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sankarh&avatarId=29945"},"displayName":"Sankar Hariappan","active":true,"timeZone":"Asia/Kolkata"},"body":"[~sbeeram]\nYes, you are right about running multiple instances of Metastore within same JVM. It is error prone. \nTestReplicationScenariosAcrossInstances worked fine by keeping the configurations same. But, it beats the purpose of having separate WarehouseInstances for primary and replica warehouses. With this fix, both primary and replica seems to share the same metastore dbs and also share common paths for replication dumps which is not great. Now, I'm trying to see if it is possible to instantiate metastore only once for the entire test suit.\n\nAnother approach would be to mock the ObjectStore class and keep only relevant methods used by our tests. We may override ObjectStore through the config hive.metastore.rawstore.impl. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sankarh","name":"sankarh","key":"sankarh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sankarh&avatarId=29945","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sankarh&avatarId=29945","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sankarh&avatarId=29945","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sankarh&avatarId=29945"},"displayName":"Sankar Hariappan","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-06-21T07:00:37.143+0000","updated":"2017-06-21T07:00:37.143+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16075583","id":"16075583","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mithun","name":"mithun","key":"mithun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mithun&avatarId=18936","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mithun&avatarId=18936","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mithun&avatarId=18936","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mithun&avatarId=18936"},"displayName":"Mithun Radhakrishnan","active":true,"timeZone":"America/Los_Angeles"},"body":"Sorry to resurrect this discussion. I was pondering over the solution on HIVE-16908, and wondered whether the solution here is complete. Here's the code to {{ObjectStore::setConf()}}:\n\n{code:java|title=ObjectStore.java}\n  @Override\n  @SuppressWarnings(\"nls\")\n  public void setConf(Configuration conf) {\n    // Although an instance of ObjectStore is accessed by one thread, there may\n    // be many threads with ObjectStore instances. So the static variables\n    // pmf and prop need to be protected with locks.\n    pmfPropLock.lock();\n    try {\n      isInitialized = false;\n      hiveConf = conf;\n      configureSSL(conf);\n      Properties propsFromConf = getDataSourceProps(conf);\n      boolean propsChanged = !propsFromConf.equals(prop);\n\n      if (propsChanged) {\n        if (pmf != null){\n          clearOutPmfClassLoaderCache(pmf);\n          // close the underlying connection pool to avoid leaks\n          pmf.close();\n        }\n        pmf = null;\n        prop = null;\n      }\n    ...\n  }\n{code}\n\nNote that {{pmfPropLock}} is locked before {{pmf.close()}} is called. But this is also the only place where {{pmfPropLock}} is used. So, if another thread is in the middle of accessing {{pmf}}, it is possible that the instance is messed up for that thread.\nBefore this code change, resetting {{pmf}} would not affect any threads with an outstanding reference.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mithun","name":"mithun","key":"mithun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mithun&avatarId=18936","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mithun&avatarId=18936","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mithun&avatarId=18936","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mithun&avatarId=18936"},"displayName":"Mithun Radhakrishnan","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-07-05T22:58:20.743+0000","updated":"2017-07-05T22:58:20.743+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16079001","id":"16079001","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"body":"Thanks [~mithun] for the review.\n\nI am still getting familiar with the Hive code base, so do pardon my ignorance (and the length of this comment)! Later in this comment I have more notes on the connection leak itself, but essentially you are right - we are pulling the plug on the connections while another thread is possibly using it.\nAlso, on closer inspection of the code/comments I came across [this|https://github.com/apache/hive/blob/master/metastore/src/java/org/apache/hadoop/hive/metastore/ObjectStore.java#L8344]:\n{quote}\n   * The NucleusContext cache gets freed up only on calling a close on it.\n   * We're not closing NucleusContext since it does a bunch of other things which we don't want.\n{quote}\n\nIt looks like a decision was made earlier to not close...\n\nI am not sure yet if there is a better way to handle it, however, there are a few questions that pop up:\n- When the pmf reference is cleared, it seems like the assumption is that the earlier connection pool is GC'ed - is that right? It looks like thats not occurring in our case. We are using BoneCP\\(!\\), but I do recollect trying HikariCP as well and the problem was reproducible. However, I did not probe further to see if Hikari offers idle connection cleanup etc. My unvalidated assumption is that we have min connections in the pool as 1 and with no idle connection reclamation, we have active references thats preventing GC...\n- Another way of looking at the issue, albeit contrived, is that the connection being used by a thread can become invalid if the remote end closes it for whatever reason and the application should deal with it gracefully - and the connection pool getting closed is a degenerate instance of this. So, if we have code similar to what we have in RetryingHMSHandler, it would handle the state invalidation gracefully, right?\n- Another issue with not closing the pool is that we now have parts of code using different JDO config while the other thread(s) could continue to use older config indefinitely. Thats perhaps not desirable either, right?\n\nEarly last week I had spent some time looking through the code a bit more, as up until then I wasn't sure what execution paths actually led to the leak. I believe one possibility is this:\na) Most calls to the Metastore go through RetryingHMSHandler that has the logic to retry and reload the configuration in case of errors. So, this code path sees new configuration if one is available soon after a DB error.\nb) Calls going through DBTokenStore, access RawStore directly and hence not only miss out on the retrying logic, but also continue to use old configuration through a HiveConf object instantiated at startup.\n\nIt looks like in our case, with frequent calls to getDelegationToken, we end up with cases where (a) and (b) interleave, resulting in connection pool objects getting leaked.\n\nI am just beginning to catch up on the implementation of HCatClientHMSImpl/HCatUtil and will need to look through a bit more through that code on the JDO configuration that will ultimately get used etc.\n\nI do appreciate any comments/pointers you have regarding this. Also, let me know if you think its better to revert the change until this is sorted out.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-08T06:57:21.816+0000","updated":"2017-07-08T06:59:04.330+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16099357","id":"16099357","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"body":"[~mithun] Do you have further input on this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-25T01:16:13.986+0000","updated":"2017-07-25T01:16:13.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16100549","id":"16100549","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mithun","name":"mithun","key":"mithun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mithun&avatarId=18936","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mithun&avatarId=18936","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mithun&avatarId=18936","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mithun&avatarId=18936"},"displayName":"Mithun Radhakrishnan","active":true,"timeZone":"America/Los_Angeles"},"body":"[~sbeeram], my apologies for the radio silence.\n\nbq. ... let me know if you think its better to revert the change until this is sorted out.\nYour argument regarding connection-leaks is (and was) a compelling one. Keeping the {{PersistenceManagementFactory}} open in lieu of addressing the concurrency issue would not be right. As such, perhaps it's best to keep this commit for the moment.\n\nbq. ... we are pulling the plug on the connections while another thread is possibly using it.\nI'll examine the code more closely to see if retries from other threads will go through. This code is nasty. :/\n\nbq. I am just beginning to catch up on the implementation of HCatClientHMSImpl/HCatUtil and will need to look through a bit more through that code on the JDO configuration that will ultimately get used etc.\nThis isn't all that much to that side of the code. It functions purely as an HMSClient. I'm not sure that it has bearing on the JDO-config (unless I've missed something again).\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mithun","name":"mithun","key":"mithun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mithun&avatarId=18936","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mithun&avatarId=18936","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mithun&avatarId=18936","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mithun&avatarId=18936"},"displayName":"Mithun Radhakrishnan","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-07-25T18:48:30.921+0000","updated":"2017-07-25T18:48:30.921+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13078040/comment/16486054","id":"16486054","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vgarg","name":"vgarg","key":"vgarg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=vgarg&avatarId=30430","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=vgarg&avatarId=30430","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=vgarg&avatarId=30430","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=vgarg&avatarId=30430"},"displayName":"Vineet Garg","active":true,"timeZone":"America/Los_Angeles"},"body":"Hive 3.0.0 has been released so closing this jira.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vgarg","name":"vgarg","key":"vgarg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=vgarg&avatarId=30430","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=vgarg&avatarId=30430","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=vgarg&avatarId=30430","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=vgarg&avatarId=30430"},"displayName":"Vineet Garg","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-22T23:58:53.960+0000","updated":"2018-05-22T23:58:53.960+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-16844/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3fzon:"}}