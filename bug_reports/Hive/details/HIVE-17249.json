{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13092353","self":"https://issues.apache.org/jira/rest/api/2/issue/13092353","key":"HIVE-17249","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Aug 04 02:21:47 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17249/watchers","watchCount":1,"isWatching":false},"created":"2017-08-04T02:21:02.114+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12332384","id":"12332384","name":"1.2.1","archived":false,"released":true,"releaseDate":"2015-06-26"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-08-04T02:28:22.088+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312584","id":"12312584","name":"Metastore","description":"Tracks issue dealing with metastore."}],"timeoriginalestimate":null,"description":"We are running into a problem with data getting lost when loading data in parallel into a partitioned Hive table. The data loader runs on multiple nodes and it dynamically creates partitions as it needs them, using the org.apache.hadoop.hive.metastore.HiveMetaStoreClient.appendPartition(String,\nString, String) interface. We assume that if multiple processes try to create the same partition at the same time, only one of them succeeds while the others fail.\n\nWhat we are seeing is that the partition gets created, but a few of the created files end up in the .Trash folder in HDFS. From the metastore log, we assume the following is happening in the threads of the metastore server:\n\n- Thread 1: A first process tries to create a partition.\n- Thread 1: The org.apache.hadoop.hive.metastore.HiveMetaStore.append_common() method\ncreates the HDFS directory.\n- Thread 2: A second process tries to create the same partition.\n- Thread 2: Notices that the directory already exists and skips the step of creating it.\n- Thread 2: Update the metastore.\n- Thread 2: Return success to the caller.\n- Caller 2: Create a file in the partition directory and start inserting.\n- Thread 1: Try to update the metastore, but this fails, since thread 2 already has inserted the partition. Retry the operation, but it still fails.\n- Thread 1: Abort the transaction and move the HDFS directory to the trash, since it knows that it created the directory.\n- Thread 1: Return failure to the caller.\n\nThe second caller can now continue to load data successfully, but the file it loads is actually already in the trash. It returns success, but the data is not inserted and not visible in the table.\n\nNote that in our case, the caller(s) that got an error continue as well - they ignore the error. I think they automatically create the HDFS partition directory when they create their output files. These processes can insert data successfully, the data that is lost is from the process that successfully created the partition, we believe.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12880335","id":"12880335","filename":"partition1log.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hzeller","name":"hzeller","key":"hzeller","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Zeller","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-04T02:21:29.225+0000","size":18256,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12880335/partition1log.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Concurrent appendPartition calls lead to data loss","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hzeller","name":"hzeller","key":"hzeller","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Zeller","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hzeller","name":"hzeller","key":"hzeller","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Zeller","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Hortonworks HDP 2.4.\nMySQL metastore.","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092353/comment/16113818","id":"16113818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hzeller","name":"hzeller","key":"hzeller","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Zeller","active":true,"timeZone":"America/Los_Angeles"},"body":"Attached is an extract of messages relating to one partition from the\nhivemetastore.log file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hzeller","name":"hzeller","key":"hzeller","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Zeller","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-04T02:21:47.033+0000","updated":"2017-08-04T02:21:47.033+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-17249/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3ieif:"}}