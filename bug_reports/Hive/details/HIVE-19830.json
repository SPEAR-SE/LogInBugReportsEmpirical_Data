{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13164920","self":"https://issues.apache.org/jira/rest/api/2/issue/13164920","key":"HIVE-19830","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-06-09T00:00:35.274+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jun 15 06:28:57 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-19830/watchers","watchCount":4,"isWatching":false},"created":"2018-06-08T13:08:15.030+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340338","id":"12340338","name":"2.4.0","archived":false,"released":false}],"issuelinks":[{"id":"12536073","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12536073","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"outwardIssue":{"id":"13164923","key":"IMPALA-7152","self":"https://issues.apache.org/jira/rest/api/2/issue/13164923","fields":{"summary":"Enable test_drop_partition_from_hive when related Hive change is available in Impala","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szita","name":"szita","key":"szita","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Szita","active":true,"timeZone":"Europe/Budapest"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-06-15T06:28:57.932+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325007","id":"12325007","name":"Hive"}],"timeoriginalestimate":null,"description":"// create a table with 2 partitions where both partitions share the same location and inserting a single line to one of them.\r\ncreate table test (i int) partitioned by (j int) stored as parquet;\r\nalter table test add partition (j=1) location 'hdfs://localhost:20500/test-warehouse/test/j=1';\r\nalter table test add partition (j=2) location 'hdfs://localhost:20500/test-warehouse/test/j=1';\r\ninsert into table test partition (j=1) values (1);\r\n\r\n// select * show this single line in both partitions as expected.\r\nselect * from test;\r\n1 1\r\n1 2\r\n\r\n// however, sum() doesn't add up the line for all the partitions. This is +Issue #1+.\r\nselect sum( i), sum(j) from test;\r\n1 2\r\n\r\n// On the file system there is a common dir for the 2 partitions that is expected.\r\nhdfs dfs -ls hdfs://localhost:20500/test-warehouse/test/\r\nFound 1 items\r\ndrwxr-xr-x - gaborkaszab supergroup 0 2018-06-08 10:54 hdfs://localhost:20500/test-warehouse/test/j=1\r\n\r\n// Let's drop one of the partitions now!\r\nalter table test drop partition (j=2);\r\n// running the same hdfs dfs -ls command shows that the j=1 directory is dropped. I think this is a good behavior, we just have to document that this is the expected case.\r\n// select * from test; returns zero rows, this is still as expected.\r\n\r\n// Even though the dir is dropped j=1 partition is still visible with show partitions. This is +Issue #2+.\r\nshow partitions test;\r\nj=1\r\n\r\nAfter dropping the directory with Hive, when Impala reloads it's partitions it asks Hive to tell what are the existing partitions. Apparently, Hive sends down a list with j=1 partition included and then Impala takes it as an existing one and doesn't drop it from Catalog's cache. Here Hive shouldn't send that partition down. This is +Issue #3+.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Inconsistent behavior when multiple partitions point to the same location","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gaborkaszab","name":"gaborkaszab","key":"gaborkaszab","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gabor Kaszab","active":true,"timeZone":"Europe/Budapest"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gaborkaszab","name":"gaborkaszab","key":"gaborkaszab","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gabor Kaszab","active":true,"timeZone":"Europe/Budapest"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13164920/comment/16506717","id":"16506717","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"The 2nd issue is by design. Having partitions like that for Hive is not supported for regular tables.\r\nIt's assumed that data is managed by Hive and so Hive deletes the directory when it's dropped... for the case where Hive should not manage the data, an external table should be used.\r\nThe first one does look like it could be a bug for external tables, but again for regular tables such a use case is not supported.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-09T00:00:35.274+0000","updated":"2018-06-09T00:00:35.274+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13164920/comment/16507843","id":"16507843","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gaborkaszab","name":"gaborkaszab","key":"gaborkaszab","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gabor Kaszab","active":true,"timeZone":"Europe/Budapest"},"body":"I have heard about users taking advantage of having multiple partitions pointing to the same location. For example with a table that is partitioned by date it is common to create an extra partition called 'latest' and point it to another partition's location and change the location once new partitions are introduced.\r\nI feel that considering this pattern is used in production it should be guaranteed that the queries on these partition return consistent results. i.e. the listing of partitions shouldn't show a partition that actually doesn't exist anymore.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gaborkaszab","name":"gaborkaszab","key":"gaborkaszab","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gabor Kaszab","active":true,"timeZone":"Europe/Budapest"},"created":"2018-06-11T09:28:42.994+0000","updated":"2018-06-11T09:28:42.994+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13164920/comment/16508443","id":"16508443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"Hive metadata is source of truth for managed tables... in fact recently Hive is moving even further in that direction (such as with ACID, where what is on disk doesn't matter for metadata at all, and only ACID state in metastore matters; or with stats-based queries, where Hive assumes for managed tables that all data changes are made thru Hive, and can be accounted for to update or at least invalidate the stats).\r\nThere are features that cover various scenarios like the ones you mention (e.g. views, materialized views, or finally external tables where Hive makes no assumptions about data).\r\nPointing partitions to the same directory is simply not supported, and it generally works only by accident - i.e. as long as deletes are not involved; it could perhaps be supported, but it needs to be done as an explicit feature (symlink partitions?). Even comparing the JIRA description to the \"latest\" partition use case, for example, shows semantic discrepancy - for the j=1 and j=2 example, you want the same directory to be read twice for sum(), but if you have a \"latest\" partition you wouldn't want it double counted with the actual date partition. So there needs to be some explicit semantics that Hive needs to be aware of, for this to work.\r\n\r\ncc [~ashutoshc] for more context.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-11T17:58:25.208+0000","updated":"2018-06-11T18:01:02.848+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13164920/comment/16512267","id":"16512267","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gaborkaszab","name":"gaborkaszab","key":"gaborkaszab","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gabor Kaszab","active":true,"timeZone":"Europe/Budapest"},"body":"Thanks for your explanation [~sershe]!\r\n I have the feeling that since people use this technique in production it would make sense to start a conversation of how to make this supported in some way even if it's an abuse of the available functionalities. And I would also include dropping these special partitions in this conversation. If it ends up as a feature request it's totally fine for me.\r\n\r\n\r\n +Showing data when multiple partitions share the same location:+\r\n Here I see 2 approaches:\r\n\r\n1) Show the same data as many times as the number of partitions we have pointing on that location. In addition, a sum() should also take this multiplication into account. \r\n\r\n2) Show a particular line of data only once no matter how many partitions share this same data. sum() should also follow this approach. It's also an interesting question which partition should we pick in this case to show e.g. for a 'select *'. I have no preference here other than making this deterministic.\r\n\r\n \r\n\r\n+Dropping partitons when multiple partitions share the same location+\r\n\r\nHere I think it's fine to drop the folder for the partition. Comparing to the current behaviour my only ask here would be to don't show the other partitions pointing to the deleted folder to appear as valid partitions e.g. when a 'show partitions' is invoked or any other system asks the list of valid partitions.\r\n\r\n \r\n\r\nWhat do you think, does this make sense?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gaborkaszab","name":"gaborkaszab","key":"gaborkaszab","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gabor Kaszab","active":true,"timeZone":"Europe/Budapest"},"created":"2018-06-14T10:15:58.165+0000","updated":"2018-06-14T10:15:58.165+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13164920/comment/16513413","id":"16513413","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gaborkaszab","name":"gaborkaszab","key":"gaborkaszab","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gabor Kaszab","active":true,"timeZone":"Europe/Budapest"},"body":"When you drop a partition like this it would also be an option to show an error to the user saying that the partition can't be dropped as that would also affect other partitions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gaborkaszab","name":"gaborkaszab","key":"gaborkaszab","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gabor Kaszab","active":true,"timeZone":"Europe/Budapest"},"created":"2018-06-15T06:28:57.932+0000","updated":"2018-06-15T06:28:57.932+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-19830/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3unr3:"}}