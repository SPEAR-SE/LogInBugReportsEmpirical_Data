{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12749193","self":"https://issues.apache.org/jira/rest/api/2/issue/12749193","key":"HIVE-8519","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-04-10T20:04:22.859+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Oct 06 00:10:35 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-8519/watchers","watchCount":12,"isWatching":false},"created":"2014-10-20T08:57:41.679+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12320745","id":"12320745","description":"released","name":"0.10.0","archived":false,"released":true,"releaseDate":"2013-01-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-10-06T00:10:35.552+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312584","id":"12312584","name":"Metastore","description":"Tracks issue dealing with metastore."}],"timeoriginalestimate":null,"description":"We got a lot of exception as below when doing a drop table partition, which made hive query every every slow. For example, it will cost 250s while executing use db_test;\n\nLog:\n2014-10-17 04:04:46,873 ERROR Datastore.Persist (Log4JLogger.java:error(115)) - Update of object \"org.apache.hadoop.hive.metastore.model.MStorageDescriptor@13c9c4b3\" using statement \"UPDATE `SDS` SET `CD_ID`=? WHERE `SD_ID`=?\" failed : java.sql.SQLException: Lock wait timeout exceeded; try restarting transaction\n        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:1074)\n        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4096)\n        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4028)\n        at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2490)\n        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2651)\n        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2734)\n        at com.mysql.jdbc.PreparedStatement.executeInternal(PreparedStatement.java:2155)\n        at com.mysql.jdbc.PreparedStatement.executeUpdate(PreparedStatement.java:2458)\n        at com.mysql.jdbc.PreparedStatement.executeUpdate(PreparedStatement.java:2375)\n        at com.mysql.jdbc.PreparedStatement.executeUpdate(PreparedStatement.java:2359)\n        at org.apache.commons.dbcp.DelegatingPreparedStatement.executeUpdate(DelegatingPreparedStatement.java:105)\n        at org.apache.commons.dbcp.DelegatingPreparedStatement.executeUpdate(DelegatingPreparedStatement.java:105)\n        at org.datanucleus.store.rdbms.ParamLoggingPreparedStatement.executeUpdate(ParamLoggingPreparedStatement.java:399)\n        at org.datanucleus.store.rdbms.SQLController.executeStatementUpdate(SQLController.java:439)\n        at org.datanucleus.store.rdbms.request.UpdateRequest.execute(UpdateRequest.java:374)\n        at org.datanucleus.store.rdbms.RDBMSPersistenceHandler.updateTable(RDBMSPersistenceHandler.java:417)\n        at org.datanucleus.store.rdbms.RDBMSPersistenceHandler.updateObject(RDBMSPersistenceHandler.java:390)\n        at org.datanucleus.state.JDOStateManager.flush(JDOStateManager.java:5012)\n        at org.datanucleus.FlushOrdered.execute(FlushOrdered.java:106)\n        at org.datanucleus.ExecutionContextImpl.flushInternal(ExecutionContextImpl.java:4019)\n        at org.datanucleus.ExecutionContextThreadedImpl.flushInternal(ExecutionContextThreadedImpl.java:450)\n        at org.datanucleus.store.query.Query.prepareDatastore(Query.java:1575)\n        at org.datanucleus.store.query.Query.executeQuery(Query.java:1760)\n        at org.datanucleus.store.query.Query.executeWithArray(Query.java:1672)\n        at org.datanucleus.api.jdo.JDOQuery.execute(JDOQuery.java:243)\n        at org.apache.hadoop.hive.metastore.ObjectStore.listStorageDescriptorsWithCD(ObjectStore.java:2185)\n        at org.apache.hadoop.hive.metastore.ObjectStore.removeUnusedColumnDescriptor(ObjectStore.java:2131)\n        at org.apache.hadoop.hive.metastore.ObjectStore.preDropStorageDescriptor(ObjectStore.java:2162)\n        at org.apache.hadoop.hive.metastore.ObjectStore.dropPartitionCommon(ObjectStore.java:1361)\n        at org.apache.hadoop.hive.metastore.ObjectStore.dropPartition(ObjectStore.java:1301)\n        at sun.reflect.GeneratedMethodAccessor17.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.hadoop.hive.metastore.RetryingRawStore.invoke(RetryingRawStore.java:111)\n        at $Proxy4.dropPartition(Unknown Source)\n        at org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.drop_partition_common(HiveMetaStore.java:1865)\n        at org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.drop_partition(HiveMetaStore.java:1911)\n        at sun.reflect.GeneratedMethodAccessor52.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.hadoop.hive.metastore.RetryingHMSHandler.invoke(RetryingHMSHandler.java:105)\n        at $Proxy5.drop_partition(Unknown Source)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Hive metastore lock wait timeout","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jasonliao","name":"jasonliao","key":"jasonliao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Liao, Xiaoge","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jasonliao","name":"jasonliao","key":"jasonliao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Liao, Xiaoge","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12749193/comment/14490276","id":"14490276","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=azotcsit","name":"azotcsit","key":"azotcsit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexey Zotov","active":true,"timeZone":"Europe/Moscow"},"body":"I've seen the same issue when I was trying to delete table with ~30.000 partitions, looks like it fails by timeout during getting information about partitions. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=azotcsit","name":"azotcsit","key":"azotcsit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexey Zotov","active":true,"timeZone":"Europe/Moscow"},"created":"2015-04-10T20:04:22.859+0000","updated":"2015-04-10T20:04:22.859+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12749193/comment/14944297","id":"14944297","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sushanth","name":"sushanth","key":"sushanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sushanth&avatarId=26812","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sushanth&avatarId=26812","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sushanth&avatarId=26812","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sushanth&avatarId=26812"},"displayName":"Sushanth Sowmyan","active":true,"timeZone":"America/Los_Angeles"},"body":"I notice a similar issue when I try to drop a table with about 50000 partitions.\n\nEssentially, what seems to be happening with that flow is the following:\n\na) Deleting a table requires deleting all partition objects for that table, Table->Partition is a 1:many mapping\nb) Deleting the partition objects requires deleting a all SD objects associated with the partitions, Partition->SD is a 1:1 mapping\nc) Deleting SD objects requires looking for all CDs pointed to by the SDs, and wherever a CD has no more SDs pointing to it, we need to drop the CD in question, SD->CD is a many:1 mapping.\nd) If a CD is to be deleted, we need to drop all List<MFieldSchema> associated with it (COLUMNS_V2 where CD_ID in list of CDs to delete.)\n\nThe big inefficiency here is that SD->CD is a many:1 mapping with a goal of reusing CDs for efficiency, but in practice, we don't. But the fact that it is many:1, not 1:1, means we need to do that additional check before dropping rather than simply dropping. This combination hits us in the worst way possible for both of those.\n\nWe need to rethink the way we use our objects and either drop the many:1 intent or actually make sure that we create a unique CD for every SD, or this is not going to be scalable. Other solutions that bypass this wonky model may also exist that we have to work out.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sushanth","name":"sushanth","key":"sushanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sushanth&avatarId=26812","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sushanth&avatarId=26812","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sushanth&avatarId=26812","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sushanth&avatarId=26812"},"displayName":"Sushanth Sowmyan","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-10-06T00:10:35.552+0000","updated":"2015-10-06T00:10:35.552+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-8519/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i21cjb:"}}