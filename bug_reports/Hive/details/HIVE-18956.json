{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13145082","self":"https://issues.apache.org/jira/rest/api/2/issue/13145082","key":"HIVE-18956","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-05-07T09:46:17.053+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon May 07 09:46:17 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18956/watchers","watchCount":2,"isWatching":false},"created":"2018-03-14T16:20:03.174+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/5","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/trivial.svg","name":"Trivial","id":"5"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340268","id":"12340268","name":"3.0.0","archived":false,"released":true,"releaseDate":"2018-05-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342053","id":"12342053","name":"2.3.2","archived":false,"released":true,"releaseDate":"2017-11-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-07T10:02:11.037+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312585","id":"12312585","name":"Serializers/Deserializers","description":"Tracks issues dealing with serdes"}],"timeoriginalestimate":null,"description":"{code}\r\n  @Override\r\n  public Writable serialize(Object o, ObjectInspector objectInspector) throws SerDeException {\r\n    if(badSchema) {\r\n      throw new BadSchemaException();\r\n    }\r\n    return getSerializer().serialize(o, objectInspector, columnNames, columnTypes, schema);\r\n  }\r\n\r\n  @Override\r\n  public Object deserialize(Writable writable) throws SerDeException {\r\n    if(badSchema) {\r\n      throw new BadSchemaException();\r\n    }\r\n    return getDeserializer().deserialize(columnNames, columnTypes, writable, schema);\r\n  }\r\n\r\n...\r\n\r\n  private AvroDeserializer getDeserializer() {\r\n    if(avroDeserializer == null) {\r\n      avroDeserializer = new AvroDeserializer();\r\n    }\r\n\r\n    return avroDeserializer;\r\n  }\r\n\r\n  private AvroSerializer getSerializer() {\r\n    if(avroSerializer == null) {\r\n      avroSerializer = new AvroSerializer();\r\n    }\r\n\r\n    return avroSerializer;\r\n  }\r\n{code}\r\n\r\n{{getDeserializer}} and {{getSerializer}} methods are not thread safe, so neither are {{deserialize}} and {{serialize}} methods.  It probably didn't matter with MapReduce, but now that we have Spark/Tez, it may be an issue.\r\n\r\nYou could visualize a scenario where three threads all enter {{getSerializer}} and all see that {{avroSerializer}} is _null_ and create three instances, then they would fight to assign the new object to the {{avroSerializer}} variable.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"AvroSerDe Race Condition","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=belugabehr","name":"belugabehr","key":"belugabehr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BELUGA BEHR","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=belugabehr","name":"belugabehr","key":"belugabehr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BELUGA BEHR","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13145082/comment/16465693","id":"16465693","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gonglinglei","name":"gonglinglei","key":"gonglinglei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"gonglinglei","active":true,"timeZone":"Etc/UTC"},"body":"{code:java}\r\n  @Override\r\n  public void initialize(Configuration configuration, Properties properties) throws SerDeException {\r\n...\r\n    if(!badSchema) {\r\n      this.avroSerializer = new AvroSerializer();\r\n      this.avroDeserializer = new AvroDeserializer();\r\n    }\r\n  }\r\n{code}\r\n\r\nIt's already fixed in HIVE-18410, since both {{AvroSerializer}} and {{AvroDeserializer}} now get instance in {{initialize}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gonglinglei","name":"gonglinglei","key":"gonglinglei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"gonglinglei","active":true,"timeZone":"Etc/UTC"},"created":"2018-05-07T09:46:17.053+0000","updated":"2018-05-07T10:02:11.024+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18956/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3ramn:"}}