{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13125273","self":"https://issues.apache.org/jira/rest/api/2/issue/13125273","key":"HIVE-18284","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-04-02T01:51:28.559+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Apr 02 16:06:49 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18284/watchers","watchCount":4,"isWatching":false},"created":"2017-12-15T16:36:43.430+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341418","id":"12341418","name":"2.3.1","archived":false,"released":true,"releaseDate":"2017-10-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342053","id":"12342053","name":"2.3.2","archived":false,"released":true,"releaseDate":"2017-11-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lynchlee","name":"lynchlee","key":"lynchlee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lynchlee&avatarId=29719","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lynchlee&avatarId=29719","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lynchlee&avatarId=29719","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lynchlee&avatarId=29719"},"displayName":"Lynch Lee","active":true,"timeZone":"Asia/Hong_Kong"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-04-02T16:06:49.036+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312586","id":"12312586","name":"Query Processor","description":"Tracks issues dealing with query processing."}],"timeoriginalestimate":null,"description":"A Null Pointer Exception occurs when inserting data with 'distribute by' clause. The following snippet query reproduces this issue:\r\n\r\n\r\n{code:java}\r\ncreate table table1 (col1 string, datekey int);\r\ninsert into table1 values ('ROW1', 1), ('ROW2', 2), ('ROW3', 1);\r\ncreate table table2 (col1 string) partitioned by (datekey int);\r\n\r\nset hive.exec.dynamic.partition.mode=nonstrict;\r\ninsert into table table2\r\nPARTITION(datekey)\r\nselect col1,\r\ndatekey\r\nfrom table1\r\ndistribute by datekey ;\r\n{code}\r\n\r\nI could run the insert query without the error if I remove Distribute By  or use Cluster By clause.\r\nIt seems that the issue happens because Distribute By does not guarantee clustering or sorting properties on the distributed keys.\r\n\r\nFileSinkOperator removes the previous fsp. FileSinkOperator will remove the previous fsp which might be re-used when we use Distribute By.\r\nhttps://github.com/apache/hive/blob/branch-2.3/ql/src/java/org/apache/hadoop/hive/ql/exec/FileSinkOperator.java#L972\r\n\r\nThe following stack trace is logged.\r\n\r\n{code:java}\r\nVertex failed, vertexName=Reducer 2, vertexId=vertex_1513111717879_0056_1_01, diagnostics=[Task failed, taskId=task_1513111717879_0056_1_01_000000, diagnostics=[TaskAttempt 0 failed, info=[Error: Error while running task ( failure ) : attempt_1513111717879_0056_1_01_000000_0:java.lang.RuntimeException: org.apache.hadoop.hive.ql.metadata.HiveException: Hive Runtime Error while processing row (tag=0) {\"key\":{},\"value\":{\"_col0\":\"ROW3\",\"_col1\":1}}\r\n\tat org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:211)\r\n\tat org.apache.hadoop.hive.ql.exec.tez.TezProcessor.run(TezProcessor.java:168)\r\n\tat org.apache.tez.runtime.LogicalIOProcessorRuntimeTask.run(LogicalIOProcessorRuntimeTask.java:370)\r\n\tat org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:73)\r\n\tat org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:61)\r\n\tat java.security.AccessController.doPrivileged(Native Method)\r\n\tat javax.security.auth.Subject.doAs(Subject.java:422)\r\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1698)\r\n\tat org.apache.tez.runtime.task.TaskRunner2Callable.callInternal(TaskRunner2Callable.java:61)\r\n\tat org.apache.tez.runtime.task.TaskRunner2Callable.callInternal(TaskRunner2Callable.java:37)\r\n\tat org.apache.tez.common.CallableWithNdc.call(CallableWithNdc.java:36)\r\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\nCaused by: org.apache.hadoop.hive.ql.metadata.HiveException: Hive Runtime Error while processing row (tag=0) {\"key\":{},\"value\":{\"_col0\":\"ROW3\",\"_col1\":1}}\r\n\tat org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource$GroupIterator.next(ReduceRecordSource.java:365)\r\n\tat org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource.pushRecord(ReduceRecordSource.java:250)\r\n\tat org.apache.hadoop.hive.ql.exec.tez.ReduceRecordProcessor.run(ReduceRecordProcessor.java:317)\r\n\tat org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:185)\r\n\t... 14 more\r\nCaused by: java.lang.NullPointerException\r\n\tat org.apache.hadoop.hive.ql.exec.FileSinkOperator.process(FileSinkOperator.java:762)\r\n\tat org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:897)\r\n\tat org.apache.hadoop.hive.ql.exec.SelectOperator.process(SelectOperator.java:95)\r\n\tat org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource$GroupIterator.next(ReduceRecordSource.java:356)\r\n\t... 17 more\r\n{code}\r\n\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"NPE when inserting data with 'distribute by' clause","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"EMR","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13125273/comment/16421873","id":"16421873","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lynchlee","name":"lynchlee","key":"lynchlee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lynchlee&avatarId=29719","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lynchlee&avatarId=29719","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lynchlee&avatarId=29719","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lynchlee&avatarId=29719"},"displayName":"Lynch Lee","active":true,"timeZone":"Asia/Hong_Kong"},"body":"Emmm, [~tanakahda] I can not reproduce the issue you reported ...\r\n\r\n`Env:\r\n\r\nCentOS Linux release 7.4.1708 (Core) \r\n\r\nJDK 1.8.0_31\r\n\r\nHive 2.3.2`\r\n\r\n...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lynchlee","name":"lynchlee","key":"lynchlee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lynchlee&avatarId=29719","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lynchlee&avatarId=29719","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lynchlee&avatarId=29719","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lynchlee&avatarId=29719"},"displayName":"Lynch Lee","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2018-04-02T01:51:28.559+0000","updated":"2018-04-02T01:51:28.559+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13125273/comment/16421874","id":"16421874","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lynchlee","name":"lynchlee","key":"lynchlee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lynchlee&avatarId=29719","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lynchlee&avatarId=29719","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lynchlee&avatarId=29719","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lynchlee&avatarId=29719"},"displayName":"Lynch Lee","active":true,"timeZone":"Asia/Hong_Kong"},"body":"Your sql scripts work fine on my hive ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lynchlee","name":"lynchlee","key":"lynchlee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lynchlee&avatarId=29719","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lynchlee&avatarId=29719","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lynchlee&avatarId=29719","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lynchlee&avatarId=29719"},"displayName":"Lynch Lee","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2018-04-02T01:52:02.209+0000","updated":"2018-04-02T01:52:02.209+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13125273/comment/16421875","id":"16421875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lynchlee","name":"lynchlee","key":"lynchlee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lynchlee&avatarId=29719","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lynchlee&avatarId=29719","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lynchlee&avatarId=29719","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lynchlee&avatarId=29719"},"displayName":"Lynch Lee","active":true,"timeZone":"Asia/Hong_Kong"},"body":"{{Also ,  could you skip into your hive, and print your runtime env here, just use {color:#FF0000}hive -e \"set;\"{color}}}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lynchlee","name":"lynchlee","key":"lynchlee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lynchlee&avatarId=29719","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lynchlee&avatarId=29719","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lynchlee&avatarId=29719","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lynchlee&avatarId=29719"},"displayName":"Lynch Lee","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2018-04-02T01:57:55.950+0000","updated":"2018-04-02T01:57:55.950+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13125273/comment/16422678","id":"16422678","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"body":"I confirmed this error on Amazon EMR.\r\n1. Launch EMR cluster with default configuration (1 Master, 2 core nodes)\r\n2. Login into EMR master node and run the Hive query\r\n\r\n \r\n{code:java}\r\n$ hive\r\nLogging initialized using configuration in file:/etc/hive/conf.dist/hive-log4j2.properties Async: false\r\n hive> create table table1 (col1 string, datekey int);\r\n OK\r\n Time taken: 1.366 seconds\r\n hive> insert into table1 values ('ROW1', 1), ('ROW2', 2), ('ROW3', 1);\r\n Query ID = hadoop_20180402160142_71903d85-0ff5-470b-98eb-5adc78273a8f\r\n Total jobs = 1\r\n Launching Job 1 out of 1\r\n Status: Running (Executing on YARN cluster with App id application_1522682563701_0002)\r\n----------------------------------------------------------------------------------------------\r\n VERTICES MODE STATUS TOTAL COMPLETED RUNNING PENDING FAILED KILLED \r\n ----------------------------------------------------------------------------------------------\r\n Map 1 .......... container SUCCEEDED 1 1 0 0 0 0 \r\n ----------------------------------------------------------------------------------------------\r\n VERTICES: 01/01 [==========================>>] 100% ELAPSED TIME: 5.48 s \r\n ----------------------------------------------------------------------------------------------\r\n Loading data to table default.table1\r\n OK\r\n Time taken: 19.633 seconds\r\n hive> create table table2 (col1 string) partitioned by (datekey int);\r\n OK\r\n Time taken: 0.069 seconds\r\n hive> set hive.exec.dynamic.partition.mode=nonstrict;\r\n hive> insert into table table2\r\n > PARTITION(datekey)\r\n > select col1,\r\n > datekey\r\n > from table1\r\n > distribute by datekey ;\r\n Query ID = hadoop_20180402160205_eb9e5292-776e-4af7-a8b1-eb002441c3f1\r\n Total jobs = 1\r\n Launching Job 1 out of 1\r\n Status: Running (Executing on YARN cluster with App id application_1522682563701_0002)\r\n----------------------------------------------------------------------------------------------\r\n VERTICES MODE STATUS TOTAL COMPLETED RUNNING PENDING FAILED KILLED \r\n ----------------------------------------------------------------------------------------------\r\n Map 1 .......... container SUCCEEDED 1 1 0 0 0 0 \r\n Reducer 2 container RUNNING 1 0 0 1 4 0 \r\n ----------------------------------------------------------------------------------------------\r\n VERTICES: 01/02 [=============>>-------------] 50% ELAPSED TIME: 15.75 s \r\n ----------------------------------------------------------------------------------------------\r\n Status: Failed\r\n Vertex failed, vertexName=Reducer 2, vertexId=vertex_1522682563701_0002_2_01, diagnostics=[Task failed, taskId=task_1522682563701_0002_2_01_000000, diagnostics=[TaskAttempt 0 failed, info=[Error: Error while running task ( failure ) : attempt_1522682563701_0002_2_01_000000_0:java.lang.RuntimeException: org.apache.hadoop.hive.ql.metadata.HiveException: Hive Runtime Error while processing row (tag=0) {\"key\":{},\"value\":{\"_col0\":\"ROW3\",\"_col1\":1}}\r\n at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:211)\r\n at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.run(TezProcessor.java:168)\r\n at org.apache.tez.runtime.LogicalIOProcessorRuntimeTask.run(LogicalIOProcessorRuntimeTask.java:370)\r\n at org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:73)\r\n at org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:61)\r\n at java.security.AccessController.doPrivileged(Native Method)\r\n at javax.security.auth.Subject.doAs(Subject.java:422)\r\n at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1836)\r\n at org.apache.tez.runtime.task.TaskRunner2Callable.callInternal(TaskRunner2Callable.java:61)\r\n at org.apache.tez.runtime.task.TaskRunner2Callable.callInternal(TaskRunner2Callable.java:37)\r\n at org.apache.tez.common.CallableWithNdc.call(CallableWithNdc.java:36)\r\n at java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\n at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n at java.lang.Thread.run(Thread.java:748)\r\n Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: Hive Runtime Error while processing row (tag=0) {\"key\":{},\"value\":{\"_col0\":\"ROW3\",\"_col1\":1}}\r\n at org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource$GroupIterator.next(ReduceRecordSource.java:365)\r\n at org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource.pushRecord(ReduceRecordSource.java:250)\r\n at org.apache.hadoop.hive.ql.exec.tez.ReduceRecordProcessor.run(ReduceRecordProcessor.java:317)\r\n at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:185)\r\n ... 14 more\r\n{code}\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-02T16:06:49.036+0000","updated":"2018-04-02T16:06:49.036+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18284/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3nyjr:"}}