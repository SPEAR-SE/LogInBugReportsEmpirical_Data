{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12741223","self":"https://issues.apache.org/jira/rest/api/2/issue/12741223","key":"HIVE-8089","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2014-09-17T20:53:00.322+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Sep 18 01:50:29 UTC 2014","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_433803363_*|*_5_*:*_2_*:*_3951_*|*_4_*:*_1_*:*_20902","customfield_12312321":null,"resolutiondate":"2014-09-18T01:53:24.033+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-8089/watchers","watchCount":2,"isWatching":false},"created":"2014-09-13T01:22:55.849+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-09-18T01:53:24.061+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"It seems like hive supports order by, limit in sub queries (compiler doesn't complain). However ordering seems to be lost based on where you place the limit.   I haven't debugged the issue.\n\nex:\nselect key, c_int from (select key, c_int from (select key, c_int from t1 order by c_int limit 5)t1)t1;\nnull\tNULL\nnull\tNULL\n1\t1\n1\t1\n1\t1\n\nselect key, c_int from (select key, c_int from (select key, c_int from t1 order by c_int)t1 limit 5)t1;\n1\t1\n1\t1\n1\t1\nnull\tNULL\nnull\tNULL\n\nselect key, c_int from (select key, c_int from (select key, c_int from t1 order by c_int limit 5)t1 limit 5)t1;\n1\t1\n1\t1\n1\t1\nnull\tNULL\nnull\tNULL","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Ordering is lost when limit is put in outer query","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpullokkaran","name":"jpullokkaran","key":"jpullokkaran","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laljo John Pullokkaran","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpullokkaran","name":"jpullokkaran","key":"jpullokkaran","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laljo John Pullokkaran","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741223/comment/14137966","id":"14137966","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"At first glance it seems by design... ordering of the table is not preserved (or at least there's no guarantee about ordering) when one selects from a table w/o order by. So, why should it be preserved from subquery?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-17T20:53:00.322+0000","updated":"2014-09-17T20:53:00.322+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741223/comment/14137972","id":"14137972","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpullokkaran","name":"jpullokkaran","key":"jpullokkaran","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laljo John Pullokkaran","active":true,"timeZone":"America/Los_Angeles"},"body":"We support order in subquery when limit is present; but ordering fails only when a limit is specified in outer query.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpullokkaran","name":"jpullokkaran","key":"jpullokkaran","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laljo John Pullokkaran","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-17T20:58:35.581+0000","updated":"2014-09-17T20:58:35.581+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741223/comment/14138005","id":"14138005","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"it seems that ordering in the subquery should have no effect on any outer limits, and outer limits cannot have effect on nested query.\nSo if I have numbers 1..10, and so select N from (select N order by N limit 5), that should return 1..5.\nIf we have select N from (select N order by N) limit 5 we can return any 5 numbers in any order, because it's just like insert into T select N order by N, then select N from T limit 5 - table happens to be sorted and so result may be 1..5, but no order is guaranteed and so it can be anything, strictly speaking...\nI will take a look if this is easy to make this behavior more \"user-friendly\"","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-17T21:23:04.456+0000","updated":"2014-09-17T21:24:11.489+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741223/comment/14138102","id":"14138102","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"Seems to be caused by addition of a stage.\n{noformat}\nselect key, value\n  from (select key, value\n    from src order by value limit 5)t1;\n\nselect key, value\n    from (select key, value\n      from src order by value limit 5)t1 limit 5;\n{noformat}\ndoesn't exhibit the issue and two queries have very similar plan; wrapping both with \n{noformat}\nselect * from (...)t1\n{noformat}\ncauses the 2nd query to add another stage with tablescan and limit, and causes the results to differ.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-17T22:15:20.412+0000","updated":"2014-09-17T22:15:20.412+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741223/comment/14138379","id":"14138379","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"I double checked on Tez; stage is also added there. Even though reducesink of the first stage sends data in the order of the subquery, it arrives at the first select of the next stage in different order.\nHeavily reformatted logs from logging added to ReduceSink, FileSink and Select - time, container id, part of log line (number for select is just Java object id):\n{noformat}\n18:36:57,719,1411004090043_0003_01_000003,1807797632 selecting 0, val_0, \n18:36:57,730,1411004090043_0003_01_000003,Reducesinking 0, val_0, \n18:36:57,751,1411004090043_0003_01_000003,1807797632 selecting 0, val_0, \n18:36:57,763,1411004090043_0003_01_000003,Reducesinking 0, val_0, \n18:36:57,784,1411004090043_0003_01_000003,1807797632 selecting 0, val_0, \n18:36:57,795,1411004090043_0003_01_000003,Reducesinking 0, val_0, \n18:36:57,818,1411004090043_0003_01_000003,1807797632 selecting 10, val_10, \n18:36:57,830,1411004090043_0003_01_000003,Reducesinking 10, val_10, \n18:36:57,852,1411004090043_0003_01_000003,1807797632 selecting 100, val_100, \n18:36:57,863,1411004090043_0003_01_000003,Reducesinking 100, val_100, \n\n\n18:36:58,096,1411004090043_0003_01_000002,107130125 selecting 100, val_100, \n18:36:58,107,1411004090043_0003_01_000002,1473175752 selecting 100, val_100, \n18:36:58,147,1411004090043_0003_01_000002,Filesinking 100, val_100, \n18:36:58,159,1411004090043_0003_01_000002,107130125 selecting 10, val_10, \n18:36:58,169,1411004090043_0003_01_000002,1473175752 selecting 10, val_10, \n18:36:58,180,1411004090043_0003_01_000002,Filesinking 10, val_10, \n18:36:58,191,1411004090043_0003_01_000002,107130125 selecting 0, val_0, \n18:36:58,202,1411004090043_0003_01_000002,1473175752 selecting 0, val_0, \n18:36:58,213,1411004090043_0003_01_000002,Filesinking 0, val_0, \n18:36:58,224,1411004090043_0003_01_000002,107130125 selecting 0, val_0, \n18:36:58,235,1411004090043_0003_01_000002,1473175752 selecting 0, val_0, \n18:36:58,246,1411004090043_0003_01_000002,Filesinking 0, val_0, \n18:36:58,258,1411004090043_0003_01_000002,107130125 selecting 0, val_0, \n18:36:58,269,1411004090043_0003_01_000002,1473175752 selecting 0, val_0, \n18:36:58,280,1411004090043_0003_01_000002,Filesinking 0, val_0, \n{noformat}\n\nIt's good that this came up in q files because on the cluster, with multiple containers potentially in each stage, ordering will not be possible to enforce.\n\nThe issue happens just because stage is added, not because of limit specifically.\nSo, if order is needed, it needs to be enforced... in current hive contract that doesn't happen.\n\nIf CBO moves limits around in such manner it (or Hive) also needs to propagate order by so it is enforced between stages.\nWe could do a hacky patch to prevent limit from adding a stage in this case, but I suspect other cases can also happen...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-18T01:50:29.541+0000","updated":"2014-09-18T01:52:04.254+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-8089/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2003r:"}}