{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12959387","self":"https://issues.apache.org/jira/rest/api/2/issue/12959387","key":"HIVE-13531","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2016-04-16T22:34:55.488+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon May 22 13:48:04 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_34643999547_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-05-22T13:48:04.002+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-13531/watchers","watchCount":3,"isWatching":false},"created":"2016-04-16T14:28:04.568+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329363","id":"12329363","name":"1.1.0","archived":false,"released":true,"releaseDate":"2015-03-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-05-22T13:48:04.112+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313585","id":"12313585","name":"UDF","description":"This includes the UDFs and UDAFs"}],"timeoriginalestimate":null,"description":"According to the code in ql/src/java/org/apache/hadoop/hive/ql/udf/generic/GenericUDTFJSONTuple.java the HashCache should never grow larger than 16 entries. In the last OOM of Hive Server 2 I found this HashCache with over 1 million java.util.LinkedHashMap$Entry objects.\n\nThe code looks right and works single threaded as it should when I tested it isolated. The only problem I can imagine with my limited Hive source code knowledge that it is accessed concurrently and somewhere the cleanup with removeEldestEntry is not working in that case.\n\nI had this problem with Hive 1.1.0 but the current implementation in master looks the same for the HashCache.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Cache in json_tuple UDF grows larger than it should","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=juergen_thomann","name":"juergen_thomann","key":"juergen_thomann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jürgen Thomann","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=juergen_thomann","name":"juergen_thomann","key":"juergen_thomann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jürgen Thomann","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"CDH 5.5.0 with Java 1.8.0_45","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12959387/comment/15244443","id":"15244443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"The concurrent access might be due to local fetch-task conversions.\n\n{{set hive.fetch.task.conversion=none;}}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-04-16T22:34:55.488+0000","updated":"2016-04-16T22:34:55.488+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12959387/comment/15288935","id":"15288935","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=juergen_thomann","name":"juergen_thomann","key":"juergen_thomann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jürgen Thomann","active":true,"timeZone":"Europe/Berlin"},"body":"I investigated the problem now a bit more after the second heap dump and this problem can be reproduced if this UDF is used at the same time in multiple queries.\n\nI'm not sure which is the best version to solve this problem, but there are at least 2 possible fixes.\n1. Change the HashCache to a synchronized Map which is easily done with Collections.synchronizedMap\n2. remove the static from the declaration of jsonObjectCache. I not sure why it is static, but if two different queries uses json_tuple they would use the same cache at the moment which would reduce the effective cache size for each query.\n\nAnother thing is the use of INIT_SIZE = 32 and CACHE_SIZE = 16 with a load factor of 0.6f. Wouldn't it make more sense to increase the load factor to nearly one and increase the CACHE_SIZE to 28 or something in that area?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=juergen_thomann","name":"juergen_thomann","key":"juergen_thomann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jürgen Thomann","active":true,"timeZone":"Europe/Berlin"},"created":"2016-05-18T13:17:18.446+0000","updated":"2016-05-18T13:17:18.446+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12959387/comment/16019597","id":"16019597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=juergen_thomann","name":"juergen_thomann","key":"juergen_thomann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jürgen Thomann","active":true,"timeZone":"Europe/Berlin"},"body":"is fixed by https://issues.apache.org/jira/browse/HIVE-16060","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=juergen_thomann","name":"juergen_thomann","key":"juergen_thomann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jürgen Thomann","active":true,"timeZone":"Europe/Berlin"},"created":"2017-05-22T13:48:04.091+0000","updated":"2017-05-22T13:48:04.091+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-13531/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2w7sn:"}}