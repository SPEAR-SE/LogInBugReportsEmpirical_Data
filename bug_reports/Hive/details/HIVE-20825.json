{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13194568","self":"https://issues.apache.org/jira/rest/api/2/issue/13194568","key":"HIVE-20825","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-10-29T20:58:55.187+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Nov 07 17:01:01 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-20825/watchers","watchCount":4,"isWatching":false},"created":"2018-10-27T05:35:03.868+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341418","id":"12341418","name":"2.3.1","archived":false,"released":true,"releaseDate":"2017-10-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342053","id":"12342053","name":"2.3.2","archived":false,"released":true,"releaseDate":"2017-11-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12344319","id":"12344319","name":"2.3.4","archived":false,"released":true,"releaseDate":"2018-11-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-11-07T17:02:47.679+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325007","id":"12325007","name":"Hive"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12328244","id":"12328244","name":"ORC"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12322671","id":"12322671","name":"Transactions","description":"Transaction management and ACID"}],"timeoriginalestimate":null,"description":"When using Hive ACID Merge (supported with the ORC format) to update/insert data, bucket files with 0 byte or 3 bytes (file content contains three characters: ORC) are generated during MERGE INTO operations which finish with no errors. Subsequent queries on the base table will get \"Not a valid ORC file\" error.\r\n\r\n \r\n\r\nThe following script can be used to reproduce the issue(note that with small amount of data like this increasing the number of buckets could result in query working, but with large data set it will fail no matter what bucket size):\r\n\r\nset hive.auto.convert.join=false;\r\n set hive.enforce.bucketing=true;\r\n set hive.exec.dynamic.partition.mode = nonstrict;\r\n set hive.support.concurrency=true;\r\n set hive.txn.manager = org.apache.hadoop.hive.ql.lockmgr.DbTxnManager;\r\n\r\ndrop table if exists mergedelta_txt_1;\r\n drop table if exists mergedelta_txt_2;\r\n\r\nCREATE TABLE mergedelta_txt_1 (\r\n id_str varchar(12), time_key int, value bigint)\r\n PARTITIONED BY (date_key int)\r\n ROW FORMAT DELIMITED\r\n STORED AS TEXTFILE;\r\n\r\nCREATE TABLE mergedelta_txt_2 (\r\n id_str varchar(12), time_key int, value bigint)\r\n PARTITIONED BY (date_key int)\r\n ROW FORMAT DELIMITED\r\n STORED AS TEXTFILE;\r\n\r\nINSERT INTO TABLE mergedelta_txt_1\r\n partition(date_key=20170103)\r\n VALUES\r\n (\"AB94LIENR0\",46700,12345676836978),\r\n (\"AB94LIENR1\",46825,12345676836978),\r\n (\"AB94LIENS0\",46709,12345676836978),\r\n (\"AB94LIENS1\",46834,12345676836978),\r\n (\"AB94LIENT0\",46709,12345676836978),\r\n (\"AB94LIENT1\",46834,12345676836978),\r\n (\"AB94LIENU0\",46718,12345676836978),\r\n (\"AB94LIENU1\",46844,12345676836978),\r\n (\"AB94LIENV0\",46719,12345676836978),\r\n (\"AB94LIENV1\",46844,12345676836978),\r\n (\"AB94LIENW0\",46728,12345676836978),\r\n (\"AB94LIENW1\",46854,12345676836978),\r\n (\"AB94LIENX0\",46728,12345676836978),\r\n (\"AB94LIENX1\",46854,12345676836978),\r\n (\"AB94LIENY0\",46737,12345676836978),\r\n (\"AB94LIENY1\",46863,12345676836978),\r\n (\"AB94LIENZ0\",46738,12345676836978),\r\n (\"AB94LIENZ1\",46863,12345676836978),\r\n (\"AB94LIERA0\",47176,12345676836982),\r\n (\"AB94LIERA1\",47302,12345676836982);\r\n\r\nINSERT INTO TABLE mergedelta_txt_2\r\n partition(date_key=20170103)\r\n VALUES \r\n (\"AB94LIENT1\",46834,12345676836978),\r\n (\"AB94LIENU0\",46718,12345676836978),\r\n (\"AB94LIENU1\",46844,12345676836978),\r\n (\"AB94LIENV0\",46719,12345676836978),\r\n (\"AB94LIENV1\",46844,12345676836978),\r\n (\"AB94LIENW0\",46728,12345676836978),\r\n (\"AB94LIENW1\",46854,12345676836978),\r\n (\"AB94LIENX0\",46728,12345676836978),\r\n (\"AB94LIENX1\",46854,12345676836978),\r\n (\"AB94LIENY0\",46737,12345676836978),\r\n (\"AB94LIENY1\",46863,12345676836978),\r\n (\"AB94LIENZ0\",46738,12345676836978),\r\n (\"AB94LIENZ1\",46863,12345676836978),\r\n (\"AB94LIERA0\",47176,12345676836982),\r\n (\"AB94LIERA1\",47302,12345676836982),\r\n (\"AB94LIERA2\",47418,12345676836982),\r\n (\"AB94LIERB0\",47176,12345676836982),\r\n (\"AB94LIERB1\",47302,12345676836982),\r\n (\"AB94LIERB2\",47418,12345676836982),\r\n (\"AB94LIERC0\",47185,12345676836982);\r\n\r\nDROP TABLE IF EXISTS mergebase_1;\r\n CREATE TABLE mergebase_1 (\r\n id_str varchar(12) , time_key int , value bigint)\r\n PARTITIONED BY (date_key int)\r\n CLUSTERED BY (id_str,time_key) INTO 4 BUCKETS\r\n STORED AS ORC\r\n TBLPROPERTIES (\r\n 'orc.compress'='SNAPPY',\r\n 'pk_columns'='id_str,date_key,time_key',\r\n 'NO_AUTO_COMPACTION'='true',\r\n 'transactional'='true');\r\n\r\nMERGE INTO mergebase_1 AS base\r\n USING (SELECT * \r\n FROM (\r\n SELECT id_str ,time_key ,value, date_key, rank() OVER (PARTITION BY id_str,date_key,time_key ORDER BY id_str,date_key,time_key) AS rk \r\n FROM mergedelta_txt_1\r\n DISTRIBUTE BY date_key\r\n ) rankedtbl \r\n WHERE rankedtbl.rk=1\r\n ) AS delta\r\n ON delta.id_str=base.id_str AND delta.date_key=base.date_key AND delta.time_key=base.time_key\r\n WHEN MATCHED THEN UPDATE SET value=delta.value\r\n WHEN NOT MATCHED THEN INSERT VALUES ( delta.id_str , delta.time_key , delta.value, delta.date_key);\r\n\r\nMERGE INTO mergebase_1 AS base\r\n USING (SELECT * \r\n FROM (\r\n SELECT id_str ,time_key ,value, date_key, rank() OVER (PARTITION BY id_str,date_key,time_key ORDER BY id_str,date_key,time_key) AS rk \r\n FROM mergedelta_txt_2\r\n DISTRIBUTE BY date_key\r\n ) rankedtbl \r\n WHERE rankedtbl.rk=1\r\n ) AS delta\r\n ON delta.id_str=base.id_str AND delta.date_key=base.date_key AND delta.time_key=base.time_key\r\n WHEN MATCHED THEN UPDATE SET value=delta.value\r\n WHEN NOT MATCHED THEN INSERT VALUES ( delta.id_str , delta.time_key , delta.value, delta.date_key);\r\n\r\nselect count(*) from mergebase_1;","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12945948","id":"12945948","filename":"hive-merge-invalid-orc-repro.hql","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tomzeng","name":"tomzeng","key":"tomzeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tomzeng&avatarId=22942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tomzeng&avatarId=22942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tomzeng&avatarId=22942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tomzeng&avatarId=22942"},"displayName":"Tom Zeng","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-10-28T03:42:05.272+0000","size":3959,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12945948/hive-merge-invalid-orc-repro.hql"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12945864","id":"12945864","filename":"hive-merge-invalid-orc-repro.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tomzeng","name":"tomzeng","key":"tomzeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tomzeng&avatarId=22942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tomzeng&avatarId=22942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tomzeng&avatarId=22942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tomzeng&avatarId=22942"},"displayName":"Tom Zeng","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-10-27T05:37:35.667+0000","size":47607,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12945864/hive-merge-invalid-orc-repro.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Hive ACID Merge generates invalid ORC files (bucket files 0 or 3 bytes in length) causing the \"Not a valid ORC file\" error","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tomzeng","name":"tomzeng","key":"tomzeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tomzeng&avatarId=22942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tomzeng&avatarId=22942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tomzeng&avatarId=22942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tomzeng&avatarId=22942"},"displayName":"Tom Zeng","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tomzeng","name":"tomzeng","key":"tomzeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tomzeng&avatarId=22942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tomzeng&avatarId=22942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tomzeng&avatarId=22942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tomzeng&avatarId=22942"},"displayName":"Tom Zeng","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Hive 2.3.x on Amazon EMR 5.8.0 to 5.18.0. Open source build of Hive 2.3.4","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13194568/comment/16667760","id":"16667760","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"body":"Perhaps HIVE-14014 is relevant.\r\nI tried these examples on master and branch-2.2 and I don't see the error (count returns 25) nor do I see any empty (3-byte) files.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-10-29T20:58:55.187+0000","updated":"2018-10-29T20:58:55.187+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13194568/comment/16668031","id":"16668031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tomzeng","name":"tomzeng","key":"tomzeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tomzeng&avatarId=22942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tomzeng&avatarId=22942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tomzeng&avatarId=22942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tomzeng&avatarId=22942"},"displayName":"Tom Zeng","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Eugene for testing it. I could reproduce this with a 3 node 5.18.0 EMR cluster using the quick launch option. And I've tried a number of other EMR clusters of different sizes and versions and able to reproduce. This could be EMR specific then. I will find a different env to try this on to confirm.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tomzeng","name":"tomzeng","key":"tomzeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tomzeng&avatarId=22942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tomzeng&avatarId=22942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tomzeng&avatarId=22942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tomzeng&avatarId=22942"},"displayName":"Tom Zeng","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-10-30T02:36:39.178+0000","updated":"2018-10-30T02:36:39.178+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13194568/comment/16678507","id":"16678507","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tomzeng","name":"tomzeng","key":"tomzeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tomzeng&avatarId=22942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tomzeng&avatarId=22942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tomzeng&avatarId=22942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tomzeng&avatarId=22942"},"displayName":"Tom Zeng","active":true,"timeZone":"America/Los_Angeles"},"body":"[~ekoifman] can you try this on Hive 2.3.4? Looks like this is broken on 2.3.x. I haven't been able to get Hive 3+ working yet, will update here once I am able to run Hive 3.  Hive Merge works well on Hive 2.2.1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tomzeng","name":"tomzeng","key":"tomzeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tomzeng&avatarId=22942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tomzeng&avatarId=22942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tomzeng&avatarId=22942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tomzeng&avatarId=22942"},"displayName":"Tom Zeng","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-11-07T17:01:01.462+0000","updated":"2018-11-07T17:02:11.642+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-20825/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3zpgf:"}}