{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13043958","self":"https://issues.apache.org/jira/rest/api/2/issue/13043958","key":"HIVE-15965","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-03-25T22:39:09.964+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Mar 25 22:39:09 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-15965/watchers","watchCount":6,"isWatching":false},"created":"2017-02-17T11:09:21.682+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335838","id":"12335838","description":"Maintenance branch for 2.1 ","name":"2.1.1","archived":false,"released":true,"releaseDate":"2016-12-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-03-25T22:39:09.964+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312584","id":"12312584","name":"Metastore","description":"Tracks issue dealing with metastore."}],"timeoriginalestimate":null,"description":"*Background*\nIn our setup we have a shared standalone MetaStore server running on EMR that is accessed by various clients (Hive CLI, HiveServer2, Spark etc.) and connects to an external MariaDB database for the MetaStore DB. It came to our attention that MetaStore (or rather the underlying DataNucleus / BoneCP combo) will keep re-using the same DB connections even when those get suddenly closed for a reason that renders them unusable.\n\nFor instance, due to a bug in the MariaDB JDBC driver v1.3.6 (see https://jira.mariadb.org/browse/CONJ-270), a huge query including over 8 thousand parameter placeholders (e.g. partition IDs in case of a {{get_partitions_by_expr}} function call)\nwill yield a {{java.nio.BufferOverflowException}} and cause the SQL connection be closed by the driver itself.\n\nThis will ultimately result in the abortion of all further MetaStore Thrift calls due to the failure of {{bonecp.ConnectionHandle.prepareStatement()}}.\n\nSuch scenarios will be then caught by DataNucleus and translated to an appropriate {{JDOException}}, only to be \"ignored\" by the MetaStore.{{RetryingHMSHandler}} will, of course, continue retrying the failing operation, but this is already pointless by that time since they will invariably fail as long as the SQL connection remains closed. Please see the attached MetaStore log [^hive.log] for details\n\n(captured from Hive 2.1.1 running on Windows in Eclipse IDE).\n\n *Proposed behavior*\n\nWe suggest that MetaStore should automatically renew the DB connection whenever:\n\n* The connection gets closed by one of the underlying frameworks (DataNucleus, BoneCP, JDBC driver); or\n* Query timeout is detected.\n\nThis feature should be optional and configurable (disabled by default for backward compatibility). Reconnection failures could probably be treated as fatal errors and cause the immediate termination of MetaStore.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340268","id":"12340268","name":"3.0.0","archived":false,"released":true,"releaseDate":"2018-05-21"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12853253","id":"12853253","filename":"hive.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=massdosage%40gmail.com","name":"massdosage@gmail.com","key":"massdosage@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mass Dosage","active":true,"timeZone":"Europe/London"},"created":"2017-02-17T11:10:26.074+0000","size":457605,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12853253/hive.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Metastore incorrectly re-uses a broken database connection","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=massdosage%40gmail.com","name":"massdosage@gmail.com","key":"massdosage@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mass Dosage","active":true,"timeZone":"Europe/London"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=massdosage%40gmail.com","name":"massdosage@gmail.com","key":"massdosage@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mass Dosage","active":true,"timeZone":"Europe/London"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13043958/comment/15871683","id":"15871683","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=massdosage%40gmail.com","name":"massdosage@gmail.com","key":"massdosage@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mass Dosage","active":true,"timeZone":"Europe/London"},"body":"Log file from a test that reproduces the issue","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=massdosage%40gmail.com","name":"massdosage@gmail.com","key":"massdosage@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mass Dosage","active":true,"timeZone":"Europe/London"},"created":"2017-02-17T11:10:26.094+0000","updated":"2017-02-17T11:10:26.094+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13043958/comment/15942014","id":"15942014","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pxiong","name":"pxiong","key":"pxiong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pengcheng Xiong","active":true,"timeZone":"America/Los_Angeles"},"body":"Hello, I am deferring this to Hive 3.0 as we are going to cut the first RC and it is not marked as blocker. Please feel free to commit to the branch if this can be resolved before the release.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pxiong","name":"pxiong","key":"pxiong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pengcheng Xiong","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-03-25T22:39:09.964+0000","updated":"2017-03-25T22:39:09.964+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-15965/votes","votes":4,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3a8ev:"}}