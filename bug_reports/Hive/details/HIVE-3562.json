{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12611120","self":"https://issues.apache.org/jira/rest/api/2/issue/12611120","key":"HIVE-3562","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324312","id":"12324312","description":"released","name":"0.12.0","archived":false,"released":true,"releaseDate":"2013-10-15"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-10-10T05:21:02.643+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Apr 02 06:50:53 UTC 2015","customfield_12310420":"246897","customfield_12312320":null,"customfield_12310222":"10002_*:*_5_*:*_18705155029_*|*_1_*:*_5_*:*_9151062161_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-08-28T15:02:57.787+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-3562/watchers","watchCount":19,"isWatching":false},"created":"2012-10-10T05:12:40.621+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/5","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/trivial.svg","name":"Trivial","id":"5"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"9.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12373898","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12373898","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12663731","key":"HIVE-5093","self":"https://issues.apache.org/jira/rest/api/2/issue/12663731","fields":{"summary":"Use a combiner for LIMIT with GROUP BY and ORDER BY operators","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12450150","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12450150","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12910195","key":"HIVE-12329","self":"https://issues.apache.org/jira/rest/api/2/issue/12910195","fields":{"summary":"Turn on limit pushdown optimization by default","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12374447","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12374447","type":{"id":"12310051","name":"Supercedes","inward":"is superceded by","outward":"supercedes","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310051"},"outwardIssue":{"id":"12663731","key":"HIVE-5093","self":"https://issues.apache.org/jira/rest/api/2/issue/12663731","fields":{"summary":"Use a combiner for LIMIT with GROUP BY and ORDER BY operators","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-11-25T02:54:58.624+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"Queries with limit clause (with reasonable number), for example\n{noformat}\nselect * from src order by key limit 10;\n{noformat}\n\nmakes operator tree, \nTS-SEL-RS-EXT-LIMIT-FS\n\nBut LIMIT can be partially calculated in RS, reducing size of shuffling.\nTS-SEL-RS(TOP-N)-EXT-LIMIT-FS\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12548523","id":"12548523","filename":"HIVE-3562.D5967.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2012-10-10T05:21:02.684+0000","size":19572,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12548523/HIVE-3562.D5967.1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12560156","id":"12560156","filename":"HIVE-3562.D5967.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-10T08:03:19.990+0000","size":44317,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12560156/HIVE-3562.D5967.2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12563009","id":"12563009","filename":"HIVE-3562.D5967.3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-03T01:22:11.285+0000","size":67615,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12563009/HIVE-3562.D5967.3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12575492","id":"12575492","filename":"HIVE-3562.D5967.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-03-26T08:25:14.658+0000","size":85315,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12575492/HIVE-3562.D5967.4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12580643","id":"12580643","filename":"HIVE-3562.D5967.5.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-04-26T01:38:14.043+0000","size":92688,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12580643/HIVE-3562.D5967.5.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12598877","id":"12598877","filename":"HIVE-3562.D5967.6.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-20T00:42:52.287+0000","size":87727,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12598877/HIVE-3562.D5967.6.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12599898","id":"12599898","filename":"HIVE-3562.D5967.7.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-26T09:01:00.886+0000","size":105125,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12599898/HIVE-3562.D5967.7.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12599929","id":"12599929","filename":"HIVE-3562.D5967.8.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-26T11:18:52.483+0000","size":107220,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12599929/HIVE-3562.D5967.8.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12600080","id":"12600080","filename":"HIVE-3562.D5967.9.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-27T01:52:55.485+0000","size":106970,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12600080/HIVE-3562.D5967.9.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"44035","customfield_12312823":null,"summary":"Some limit can be pushed down to map stage","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13472986","id":"13472986","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"body":"without pushdown, \nMap output bytes   9312\nMap output records  500\n\nwith pushdown, \nMap output bytes    981\nMap output records   53\n\ncan be optimized further.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"created":"2012-10-10T05:16:13.132+0000","updated":"2012-10-10T05:16:13.132+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13472988","id":"13472988","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis requested code review of \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\nReviewers: JIRA\n\n  DPAL-1910 Some limit can be pushed down to map stage\n\n  Queries with limit clause (with reasonable number), for example\n\n  select * from src order by key limit 10;\n\n  makes operator tree,\n  TS-SEL-RS-EXT-LIMIT-FS\n\n  But LIMIT can be partially calculated in RS, reducing size of shuffling.\n  TS-SEL-RS(TOP-N)-EXT-LIMIT-FS\n\nTEST PLAN\n  EMPTY\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nAFFECTED FILES\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n  ql/src/test/queries/clientpositive/limit_pushdown.q\n  ql/src/test/results/clientpositive/limit_pushdown.q.out\n\nMANAGE HERALD DIFFERENTIAL RULES\n  https://reviews.facebook.net/herald/view/differential/\n\nWHY DID I GET THIS EMAIL?\n  https://reviews.facebook.net/herald/transcript/14199/\n\nTo: JIRA, navis\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2012-10-10T05:21:02.643+0000","updated":"2012-10-10T05:21:02.643+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13500118","id":"13500118","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"body":"I'm interested in this particular optimization. Let's say the table src have N rows and we're interested in top-K. If the rows in T are in almost descending order and we're interested in ascending Top-K (this is very likely when ordering by timestamps), then the number of memcopies will be N * K. See code fragment:\n\n{code}\n+    public boolean isTopN(byte[] key) {\n+      int index = Arrays.binarySearch(keys, key, C);\n+      index = index < 0 ? -index -1 : index;\n+      if (index >= keys.length - 1) {\n+        return false;\n+      }\n+      System.arraycopy(keys, index, keys, index + 1, keys.length - index - 1);\n+      keys[index] = Arrays.copyOf(key, key.length);\n+      return true;\n+    }\n+  }\n{code}\n\nYou could use a linked list, but binary search is not an option in that case.\n\nAn alternate approach to the problem is to use a combination of Hive and Hadoop changes.\n\nHadoop change:\n* New parameter map.sort.limitrecords which determines how many records each mapper in a job will send to every reducer\n* When writing out local files after sorting, map-task stops after map.sort.limitrecords records for each reducer\n* Effectively, each mapper sends out its top-K records\n\nHive change:\n* Determining when the Top-K optimization is applicable and setting K in ReduceSinkDesc\n* Passing the K value along to MapredWork\n* ExecDriver sets map.sort.limitrecords before executing the job corresponding to the MapredWork\n\nThis change will reduce the amount of I/O that happens on the map-side (writing only 10 rows per reducer as opposed to entire table) and can have a big effect on performance. Furthermore, it is possible to make the sort on the mapper side a top-k sort which can further improve performance - but the deep pocket is really the I/O savings. In my experiments, I see a 5x performance improvement for such queries.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"created":"2012-11-19T10:16:15.498+0000","updated":"2012-11-19T10:16:15.498+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13500165","id":"13500165","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"body":"Apologies, you can use a heap to maintain a top-k as opposed to an array or a linked list. \n\nYou may also want to consider the case where the top-k do not fit in memory. One possibility would be to employ this optimization only if K is less than some threshold.\n\nThis approach has the advantage that it is a Hive-only change and does not depend on a Hadoop change. That is a pretty big plus.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"created":"2012-11-19T11:34:25.356+0000","updated":"2012-11-19T11:34:25.356+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13511402","id":"13511402","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"body":"I think it would be simple to keep it a hive only change.\nI agree that Hadoop change is more general, but it may be painful/time-consuming to backport.\nIn most of the cases, k would be small, and it makes perfect sense to put a limit on k, as you suggested above.\n\nWhat do you think ?\nShould we go with the hive-only change ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-12-06T14:12:51.691+0000","updated":"2012-12-06T14:12:51.691+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13511418","id":"13511418","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"body":"Hive-only change is fine. A heap-based isTopN() implementation will be good.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-06T14:34:39.848+0000","updated":"2012-12-06T14:34:39.848+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13511434","id":"13511434","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"body":"Cool, can you also review ?\nI will start reviewing too.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-12-06T14:57:55.727+0000","updated":"2012-12-06T14:57:55.727+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13511441","id":"13511441","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"body":"comments on phabricator","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-12-06T15:08:35.307+0000","updated":"2012-12-06T15:08:35.307+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13511442","id":"13511442","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"njain has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  As per jira comments, can you add a new parameter for the limit on k ?\n\nINLINE COMMENTS\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:73 Instead of checking for instanceof, can you add a method in Operator() - something like\n  canLimitBePushed() with a lot of comments, and then the above operators can have this to true.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:358  Can you add a heap based implementation as suggested in jira ?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:86 Can you add lot of comments here - when is this set ?\n  what queries will it benefit etc. ?\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java:460 add these in hive-default.xml.template\n  ql/src/test/queries/clientpositive/limit_pushdown.q:7 can you add another positive/negative test ?\n\n  explain select value, sum(key) from src group by value limit 10;\n\n  The limit should be used in the 2nd MR job if u r inserting into a table.\n  ql/src/test/queries/clientpositive/limit_pushdown.q:10 For the 2 negative queries, can you insert into a table also -\n  then the optm. should help\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nTo: JIRA, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-06T15:09:08.460+0000","updated":"2012-12-06T15:09:08.460+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13511477","id":"13511477","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"tarball has requested changes to the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Not sure if I'm following the right protocol here. Marking this as \"Request Changes\" per my comments.\n\nINLINE COMMENTS\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java:460 Minor suggestion, feel free to ignore :) Prefer parameter name  \"hive.limit.twophase.enable\".\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:129 Why not limit 0 (unless hive optimizes those away)?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:305 Is this variable not used at all?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:323 This code seems error prone. It has a side effect that's difficult to understand - it is not obvious that the caller must wipe out value before the next row is processed. Any particular reason we're caching it at all?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:346 If o1 and o2 are null, shouldn't this return 0?\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nBRANCH\n  DPAL-1910\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-06T15:55:08.983+0000","updated":"2012-12-06T15:55:08.983+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13511482","id":"13511482","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"body":"Added my comments to Phabricator. I'm new to these tools and the process. So, please forgive any mistakes on my part. \n\nGood stuff, Navis!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-06T16:00:39.827+0000","updated":"2012-12-06T16:00:39.827+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13527685","id":"13527685","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"body":"I just wanted to start small not affecting flow over operators but.. ok, I'll do it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"created":"2012-12-10T02:14:13.577+0000","updated":"2012-12-10T02:14:13.577+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13527759","id":"13527759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis updated the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\nReviewers: JIRA, tarball\n\n  Addressed some comments (submitting for fail-fast review)\n\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nAFFECTED FILES\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n  conf/hive-default.xml.template\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n  ql/src/test/queries/clientpositive/limit_pushdown.q\n  ql/src/test/results/clientpositive/limit_pushdown.q.out\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-10T08:03:19.939+0000","updated":"2012-12-10T08:03:19.939+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13527803","id":"13527803","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"tarball has requested changes to the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\nINLINE COMMENTS\n  conf/hive-default.xml.template:1407 Why is optimization disabled by default? This is good stuff and should be switched on!\n  conf/hive-default.xml.template:1413 10 million seems like a really large threshold. Maybe in the 50k range?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:378 The current implementation doesn't look like a heap to me. Why not simply use java.util.PriorityQueue?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:383 Shouldn't nulls be equal to each other?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:379 Better name? TopNHeap?\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nBRANCH\n  DPAL-1910\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-10T09:43:20.079+0000","updated":"2012-12-10T09:43:20.079+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13528572","id":"13528572","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Is this right direction?\n\nINLINE COMMENTS\n  conf/hive-default.xml.template:1407 It's like a convention. When this patch is believed to be fully stable, it'll be so.\n  conf/hive-default.xml.template:1413 It's size of memory, not number of rows. 10M seemed to be conservative enough.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:378 I just wanted to keep it compact as is possible because this can be used with map aggregation. I'm thinking of interface which can be implemented by user and configured to be used for this.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:383 In RS, o2 is the key and cannot be null and also, making this class support null key needs some more works. I just ignored that case but yes, some comments could be useful at the least.\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nBRANCH\n  DPAL-1910\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-11T01:27:20.044+0000","updated":"2012-12-11T01:27:20.044+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13533636","id":"13533636","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"body":"comments on phabricator","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-12-17T04:22:03.737+0000","updated":"2012-12-17T04:22:03.737+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13533638","id":"13533638","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"njain has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  The general direction looks OK\n\nINLINE COMMENTS\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:79 TODO\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:45 spelling: operator\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:79 Followup: add a new method in Operator.\n  ql/src/test/queries/clientpositive/limit_pushdown.q:26 Looks like this optimization should also help if the limit is in a sub-query:\n  Can you add a test ?\n\n  something like:\n\n  select ..  from\n  (select key, count(1) from src group by key order by key limit 2) subq\n  join\n  (select key, count(1) from src group by key order by key limit 2) subq2 ..\n\n\n  The optimization should be applied to both the sub-queries\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nBRANCH\n  DPAL-1910\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-17T04:24:11.484+0000","updated":"2012-12-17T04:24:11.484+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13542639","id":"13542639","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis updated the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\nReviewers: JIRA, tarball\n\n  Addressed comments\n  Prevent multi-GBY single-RS case\n\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nAFFECTED FILES\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n  conf/hive-default.xml.template\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n  ql/src/test/queries/clientpositive/limit_pushdown.q\n  ql/src/test/results/clientpositive/limit_pushdown.q.out\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-03T01:22:11.195+0000","updated":"2013-01-03T01:22:11.195+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13542689","id":"13542689","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"body":"Looks good to me. +1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-03T03:43:41.424+0000","updated":"2013-01-03T03:43:41.424+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13542690","id":"13542690","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"tarball has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Looks good to me. +1\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-03T03:44:11.576+0000","updated":"2013-01-03T03:44:11.576+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13546643","id":"13546643","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"njain has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\nINLINE COMMENTS\n  conf/hive-default.xml.template:1434 Can you add more details here - a example query would really help ?\n  ql/src/test/queries/clientpositive/limit_pushdown.q:16 What is so special about 40 ?\n\n  set hive.limit.pushdown.heap.threshold explicitly at the beginning of the test, makes the\n  test easier to maintain in the long run.\n\n  ql/src/test/queries/clientpositive/limit_pushdown.q:34 What is the difference between this and line 3 ?\n\n  ql/src/test/queries/clientpositive/limit_pushdown.q:10 I think this plan is not correct.\n\n  Let us say, the values are\n  v1\n  v2\n  ..\n  v10\n  v11\n  v12\n  ..\n  v20\n\n  The first mapper does not have v8-10, so it emits v1-v7, v11-v13\n  The second mapper contains data for all values, but it only emits v1-v10\n\n  Since it does not involves a order by, it is possible that the data for v11 will get picked up, which does not contain data from the second mapper. If you are pushing the limit up, you should create an additional MR job which orders the rows - in the above example, making sure that only v1-v10 are picked up.\n\n  Am I missing something here ?\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-08T06:16:12.272+0000","updated":"2013-01-08T06:16:12.272+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13546648","id":"13546648","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"body":"comments","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"created":"2013-01-08T06:28:41.609+0000","updated":"2013-01-08T06:28:41.609+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13546649","id":"13546649","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"njain has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\nINLINE COMMENTS\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:75 remove the TODO\n  ql/src/test/queries/clientpositive/limit_pushdown.q:51 There is no test where the limit is > hive.limit.pushdown.heap.threshold.\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:87 Do you want to compare the threshold with the actual limit here ?\n\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-08T06:30:11.192+0000","updated":"2013-01-08T06:30:11.192+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13546661","id":"13546661","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"njain has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Sorry, my earlier comments were assuming that the threshold is for number of rows\n\nINLINE COMMENTS\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java:483 Coming to a earlier comment from Sivaramakrishnan Narayanan, would it be simpler if this was the number of rows ?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:414 Define 40 as a constant somewhere\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-08T06:56:11.382+0000","updated":"2013-01-08T06:56:11.382+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13546703","id":"13546703","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"njain has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  I thought about it, even with group bys, my question is still valid.\n  I think, there is a bug.\n\n  Do you think it would be simpler to allocate a heap with (upto) topN entries instead - throw\n  the memory threshold out. If limit < threshold, use this optimization, otherwise just ignore this\n  optimization.\n\nINLINE COMMENTS\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:441 Isn't there a bug here ?\n\n  You are using keyValues last entry to figure out whether it needs to be expanded or not.\n  It may have an issue at the boundary - say entry 40th when a legit. entry is found.\n  It might be simpler to pass the fact whether the entry was found or not.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:468 This is not true if an entry is being inserted in between.\n  I mean, if topN is 100, and we already have 100 entries.\n\n  If we are inserting 50th entry, we should not be increasing usage\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-08T08:42:11.273+0000","updated":"2013-01-08T08:42:11.273+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13546822","id":"13546822","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  I think I'm wrong about GBY cases. Should be fixed definitely (in next week, maybe).\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-08T12:14:12.002+0000","updated":"2013-01-08T12:14:12.002+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13563464","id":"13563464","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  I'm also confusing about GBY cases. I mean group by query with \"no ordering\" clause, for example,\n\n  select key,count(value) from src group by key limit 10;\n\n  I think top-K is still applicable. If key is ranged from K1 to K100, all values for K1~K10 from any mapper are transferred to reducer, which makes valid result. Isn't it?\n\n  And for changing threshold from memory to row count, map aggregation would be a good example, which is using memory percent. I also think current implementation is too clumsy, but general direction is right.\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-26T12:07:11.597+0000","updated":"2013-01-26T12:07:11.597+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13613611","id":"13613611","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis updated the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  1. Used Heap for ORDER BY and Map for GROUP BY\n  2. Added tests for spill/break\n  3. Changed to use percentage for memory threshold\n\nReviewers: tarball, JIRA\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nCHANGE SINCE LAST DIFF\n  https://reviews.facebook.net/D5967?vs=24861&id=30483#toc\n\nAFFECTED FILES\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n  conf/hive-default.xml.template\n  ql/build.xml\n  ql/ivy.xml\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHashForGBY.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n  ql/src/test/queries/clientpositive/limit_pushdown.q\n  ql/src/test/results/clientpositive/limit_pushdown.q.out\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-03-26T08:25:14.539+0000","updated":"2013-03-26T08:25:14.539+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13619381","id":"13619381","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"body":"Passed all tests","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"created":"2013-04-02T00:48:56.217+0000","updated":"2013-04-02T00:48:56.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13640368","id":"13640368","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"body":"can you refresh ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=namit","name":"namit","key":"namit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Namit Jain","active":true,"timeZone":"Asia/Kolkata"},"created":"2013-04-24T12:12:53.324+0000","updated":"2013-04-24T12:12:53.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13642489","id":"13642489","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis updated the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Refactoring & bug fix\n\nReviewers: tarball, JIRA\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nCHANGE SINCE LAST DIFF\n  https://reviews.facebook.net/D5967?vs=30483&id=32943#toc\n\nAFFECTED FILES\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n  conf/hive-default.xml.template\n  ql/build.xml\n  ql/ivy.xml\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n  ql/src/test/queries/clientpositive/join_vc.q\n  ql/src/test/queries/clientpositive/limit_pushdown.q\n  ql/src/test/results/clientpositive/join_vc.q.out\n  ql/src/test/results/clientpositive/limit_pushdown.q.out\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-04-26T01:38:13.872+0000","updated":"2013-04-26T01:38:13.872+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13668536","id":"13668536","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"I have implemented a similar fix as a Combiner in MR (LimitNKeys and LimitNValues) instead of using a hash/heap in-memory.\n\nThis seems to be a lot more memory friendly since it doesn't need any extra memory, but it doesn't help the speed of the sort operations as the data size reduction is post-sort.\n\nAnd since it works for any writable, it only needs a simple single class implementation (no comparators within the combiner).\n\nThe combiner is only run if there are multiple spills, but if the combiner can be forced by setting \"min.num.spills.for.combine\" = 0, then we can set a top-k (unique keys/values) selection sort via \"map.sort.class\" config instead of the default QuickSort impl, without any change to the hadoop core at all.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2013-05-28T18:33:35.118+0000","updated":"2013-05-28T18:33:35.118+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13738847","id":"13738847","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"[~gopalv] Your approach sounds interesting, lot less intrusive and memory friendly indeed. If you still have a patch around this, would you like to post it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-13T21:19:13.548+0000","updated":"2013-08-13T21:19:13.548+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13739324","id":"13739324","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\n{color:red}Overall{color}: -1 no tests executed\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12580643/HIVE-3562.D5967.5.patch\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/429/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/429/console\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.PrepPhase\nTests failed with: NonZeroExitCodeException: Command 'bash /data/hive-ptest/working/scratch/source-prep.sh' failed with exit status 1 and output '+ [[ -n '' ]]\n+ export 'ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128'\n+ ANT_OPTS='-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128'\n+ cd /data/hive-ptest/working/\n+ tee /data/hive-ptest/logs/PreCommit-HIVE-Build-429/source-prep.txt\n+ mkdir -p maven ivy\n+ [[ svn = \\s\\v\\n ]]\n+ [[ -n '' ]]\n+ [[ -d apache-svn-trunk-source ]]\n+ [[ ! -d apache-svn-trunk-source/.svn ]]\n+ [[ ! -d apache-svn-trunk-source ]]\n+ cd apache-svn-trunk-source\n+ svn revert -R .\nReverted 'serde/src/java/org/apache/hadoop/hive/serde2/ColumnProjectionUtils.java'\nReverted 'ql/src/test/results/compiler/plan/join2.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input2.q.xml'\nReverted 'ql/src/test/results/compiler/plan/join3.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input3.q.xml'\nReverted 'ql/src/test/results/compiler/plan/join4.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input4.q.xml'\nReverted 'ql/src/test/results/compiler/plan/join5.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input5.q.xml'\nReverted 'ql/src/test/results/compiler/plan/join6.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input_testxpath2.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input6.q.xml'\nReverted 'ql/src/test/results/compiler/plan/join7.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input7.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input_testsequencefile.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input8.q.xml'\nReverted 'ql/src/test/results/compiler/plan/join8.q.xml'\nReverted 'ql/src/test/results/compiler/plan/union.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input9.q.xml'\nReverted 'ql/src/test/results/compiler/plan/udf1.q.xml'\nReverted 'ql/src/test/results/compiler/plan/udf4.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input_testxpath.q.xml'\nReverted 'ql/src/test/results/compiler/plan/udf6.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input_part1.q.xml'\nReverted 'ql/src/test/results/compiler/plan/groupby1.q.xml'\nReverted 'ql/src/test/results/compiler/plan/udf_case.q.xml'\nReverted 'ql/src/test/results/compiler/plan/groupby2.q.xml'\nReverted 'ql/src/test/results/compiler/plan/subq.q.xml'\nReverted 'ql/src/test/results/compiler/plan/groupby3.q.xml'\nReverted 'ql/src/test/results/compiler/plan/groupby4.q.xml'\nReverted 'ql/src/test/results/compiler/plan/groupby5.q.xml'\nReverted 'ql/src/test/results/compiler/plan/groupby6.q.xml'\nReverted 'ql/src/test/results/compiler/plan/case_sensitivity.q.xml'\nReverted 'ql/src/test/results/compiler/plan/udf_when.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input20.q.xml'\nReverted 'ql/src/test/results/compiler/plan/sample1.q.xml'\nReverted 'ql/src/test/results/compiler/plan/sample2.q.xml'\nReverted 'ql/src/test/results/compiler/plan/sample3.q.xml'\nReverted 'ql/src/test/results/compiler/plan/sample4.q.xml'\nReverted 'ql/src/test/results/compiler/plan/sample5.q.xml'\nReverted 'ql/src/test/results/compiler/plan/sample6.q.xml'\nReverted 'ql/src/test/results/compiler/plan/sample7.q.xml'\nReverted 'ql/src/test/results/compiler/plan/cast1.q.xml'\nReverted 'ql/src/test/results/compiler/plan/join1.q.xml'\nReverted 'ql/src/test/results/compiler/plan/input1.q.xml'\nReverted 'ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestIntegerCompressionReader.java'\nReverted 'ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestBitFieldReader.java'\nReverted 'ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestRunLengthIntegerReader.java'\nReverted 'ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestRunLengthByteReader.java'\nReverted 'ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestBitPack.java'\nReverted 'ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestInStream.java'\nReverted 'ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestOrcFile.java'\nReverted 'ql/src/test/org/apache/hadoop/hive/ql/io/sarg/TestSearchArgumentImpl.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/exec/TableScanOperator.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/orc/Reader.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/orc/BitFieldReader.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/orc/OrcInputFormat.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/orc/RecordReaderImpl.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/orc/OrcSerde.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/orc/RunLengthByteReader.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/orc/InStream.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/orc/ReaderImpl.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/sarg/SearchArgument.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/sarg/SearchArgumentImpl.java'\nReverted 'ql/src/java/org/apache/hadoop/hive/ql/io/HiveInputFormat.java'\n++ awk '{print $2}'\n++ egrep -v '^X|^Performing status on external'\n++ svn status --no-ignore\n+ rm -rf build hcatalog/build hcatalog/core/build hcatalog/storage-handlers/hbase/build hcatalog/server-extensions/build hcatalog/webhcat/svr/build hcatalog/webhcat/java-client/build hcatalog/hcatalog-pig-adapter/build common/src/gen ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestRecordReaderImpl.java\n+ svn update\n\nFetching external item into 'hcatalog/src/test/e2e/harness'\nExternal at revision 1513744.\n\nAt revision 1513744.\n+ patchCommandPath=/data/hive-ptest/working/scratch/smart-apply-patch.sh\n+ patchFilePath=/data/hive-ptest/working/scratch/build.patch\n+ [[ -f /data/hive-ptest/working/scratch/build.patch ]]\n+ chmod +x /data/hive-ptest/working/scratch/smart-apply-patch.sh\n+ /data/hive-ptest/working/scratch/smart-apply-patch.sh /data/hive-ptest/working/scratch/build.patch\nThe patch does not appear to apply with p0 to p2\n+ exit 1\n'\n{noformat}\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2013-08-14T07:06:39.607+0000","updated":"2013-08-14T07:06:39.607+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13740269","id":"13740269","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"I have created HIVE-5093 to hold my limit combiner patch (rebased to trunk & turned off by default).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2013-08-14T22:05:32.385+0000","updated":"2013-08-14T22:05:32.385+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13744568","id":"13744568","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis updated the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Rebased to trunk\n\nReviewers: tarball, JIRA\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nCHANGE SINCE LAST DIFF\n  https://reviews.facebook.net/D5967?vs=32943&id=38379#toc\n\nAFFECTED FILES\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n  conf/hive-default.xml.template\n  ql/build.xml\n  ql/ivy.xml\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n  ql/src/test/queries/clientpositive/limit_pushdown.q\n  ql/src/test/results/clientpositive/limit_pushdown.q.out\n\nTo: JIRA, tarball, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-20T00:42:52.162+0000","updated":"2013-08-20T00:42:52.162+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13744728","id":"13744728","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\n{color:green}Overall{color}: +1 all checks pass\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12598877/HIVE-3562.D5967.6.patch\n\n{color:green}SUCCESS:{color} +1 2886 tests passed\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/482/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/482/console\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\n{noformat}\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2013-08-20T05:45:46.405+0000","updated":"2013-08-20T05:45:46.405+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13747625","id":"13747625","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"As always, high quality work, Navis! \nLeft few implementation comments on phabricator. Most important ones are:\n1. Is it possible to use one DataStructure (TreeSet probably) for two implementations of ReduceSinkHash. If so, that will simplify this code quite a bit.\n2. Not sure how RS corresponding to distinct will be handled with this optimization. So, I requested for test cases for it.\n\nCool stuff. Lets get this in!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-22T16:18:47.893+0000","updated":"2013-08-22T16:18:47.893+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13747626","id":"13747626","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"ashutoshc has requested changes to the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\nINLINE COMMENTS\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java:528 I think we don't need a boolean flag. If user has set hive.limit.pushdown.memory.usage=0 it is pretty clear he wants the optimization to be disabled.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java:1187 I didnt fully follow the example here. What are the keys/values/rows here?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:154 select key from src limit 0; implies user doesn't want any data, so RS doesnt need to emit any thing, this optimization is still valid and super useful here. Isn't it? So, this should be limit < 0, instead limit <=0\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:157 Can you add a comment why you are subtracting limit * 64 in this calculation of threshold?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:171 I think we need not to special handle limit = 0 by null'ing the collector. As I said above better is to make RSHash to null in that case. This avoids a null check of collector in processOp().\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:325 As I noted above, lets not have this null check. Apart from you null'ing the collector above, could there ever be case when it will be null. I dont think so, in that case lets remove this if-branch from inner loop.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:340 Shall this be instead collect(keyWritable, value) ?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:343 Didn't get your comment for retry here. Can you add more comment for it?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:346 collect() instead of out.collect() ?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:434-436 transient?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:471 It will be good to add a LOG.DEBUG() here saying, disabling ReduceSinkHash.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:477 I didn't get your TODO here. Can you explain?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:495 Better name: remove ?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:498 Add a comment here saying values[index] could be null, if flush() was called after this value is added but before remove() is called.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:535 You are using PriorityQueue almost like a sorted set.  I think java.util.TreeSet will suffice what you need here.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:566 I dont see you making use of any feature corresponding to Map interface. Looks like TreeSet would be sufficient here as well.\n\n  If it so that at both places we can use TreeSet than we do need not these two diff implementation of ReduceSinkHash. This will simplify code quite a bit.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:253-264 This handling of distinct keys case can also be refactored to use ReduceSinkHash. Will be a good idea to take this up in a follow up jira.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:535 Also need to mark it transient.\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:91 If we are able to use one DataStructure in ReduceSinkHash (either TreeSet or some other) for both cases, we wont need this boolean.\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:46 How are enforcing this condition of applying this optimization only for last RS. Can you add comments about this.\n  ql/src/test/queries/clientpositive/limit_pushdown.q:14 Can you also add a test for following query with this optimization on:\n  explain select distinct(key) from src limit 20;\n  explain select count(distinct(key)) from src group by key limit 20;\n\n  select distinct(key) from src limit 20;\n  select count(distinct(key)) from src group by key limit 20;\n  ql/src/test/queries/clientpositive/limit_pushdown.q:43 It will be good to seprate these queries where optimization will not be fired in a seprate .q file.\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nBRANCH\n  HIVE-3562\n\nARCANIST PROJECT\n  hive\n\nTo: JIRA, tarball, ashutoshc, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-22T16:18:55.135+0000","updated":"2013-08-22T16:18:55.135+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13747635","id":"13747635","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=appodictic","name":"appodictic","key":"appodictic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Edward Capriolo","active":true,"timeZone":"Etc/UTC"},"body":"{quote}1. Is it possible to use one DataStructure (TreeSet probably) for two implementations of ReduceSinkHash. If so, that will simplify this code quite a bit.{quote}\nI think we are better off using the MinMaxPriorityQueue\n\nhttp://highscalability.com/blog/2013/5/22/strategy-stop-using-linked-lists.html\n\nStructures that use Node's are really inefficient in java. The pointers bloat the structure, and the non-local memory access and causes a lot of cache misses. I benched a similar scenario sorting large tree sets, and even though the big O is smaller (believe it or not) to sort a list then maintain a treeSet.  MinMaxPriorityQueue has a middle-ground implementation which real world works much faster then TreeSet. \n\n{code}\n\n\nimport java.util.ArrayList;\nimport java.util.Collection;\nimport java.util.Collections;\nimport java.util.LinkedList;\nimport java.util.List;\nimport java.util.Random;\nimport java.util.TreeSet;\n\npublic class TreeSetTest {\n\n    static Random r = new Random();\n   \n    public static void main(String [] args){\n       \n        doIt(500000,new TreeSet<Double>());\n        doIt(500000,new TreeSet<Double>());\n        doIt(500000,new TreeSet<Double>());\n        doIt(500000,new TreeSet<Double>());\n        {\n        List<Double> arrayList = new ArrayList<Double>();\n        doIt(500000,arrayList);\n        sortIt(arrayList);\n        }\n        {\n            List<Double> arrayList = new ArrayList<Double>();\n            doIt(500000,arrayList);\n            sortIt(arrayList);\n            }\n        {\n            List<Double> arrayList = new LinkedList<Double>();\n            doIt(500000,arrayList);\n            sortIt(arrayList);\n            }\n       \n        {\n            List<Double> arrayList = new ArrayList<Double>();\n            doIt(500000,arrayList);\n            sortIt(arrayList);\n            }\n        {\n            List<Double> arrayList = new ArrayList<Double>();\n            doIt(500000,arrayList);\n            sortIt(arrayList);\n            }\n        doIt(500000,new TreeSet<Double>());\n        doIt(500000,new TreeSet<Double>());\n        {\n            List<Double> arrayList = new LinkedList<Double>();\n            doIt(500000,arrayList);\n            sortIt(arrayList);\n            }\n       \n       \n    }\n   \n    public static void sortIt(List l){\n        long start = System.currentTimeMillis();\n        Collections.sort(l);\n        long end = System.currentTimeMillis();\n        System.out.println(l.getClass().getName()+\" sort it \"+ (end-start));\n    }\n   \n    public static void doIt(int n, Collection l){\n        long start = System.currentTimeMillis();\n        for (int i =0;i<n;i++){\n            randomDouble(l);\n        }\n        long end = System.currentTimeMillis();\n        System.out.println(l.getClass().getName()+\" add it \"+ (end-start));\n    }\n   \n    private static void randomDouble(Collection l){\n        int rangeMin=0;\n        int rangeMax=20000000;\n              \n        double randomValue = rangeMin + (rangeMax - rangeMin) * r.nextDouble();\n        l.add(randomValue);\n    }\n}\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=appodictic","name":"appodictic","key":"appodictic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Edward Capriolo","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-22T16:27:03.098+0000","updated":"2013-08-22T16:27:03.098+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13747643","id":"13747643","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"[~navis] Can you also add a test case for following query with both this optimization on as well as reducesink dedup optimization on? This will trigger a case for one merged RS for both group by and order by.\n select value,avg(key) from src group by value order by value limit 20;\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-22T16:36:36.324+0000","updated":"2013-08-22T17:07:17.472+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13747647","id":"13747647","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"[~appodictic] I dont care which DS you pick, I am looking for simplicity of implementation. Current patch has two implementation for RSHash which only differs on choice of DS and it appears to me that in both cases underlying DS is used in very similar fashion. If one can be used (whichever it is), this will make code simpler to read, understand and less bug prone.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-22T16:41:35.034+0000","updated":"2013-08-22T16:41:35.034+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13747649","id":"13747649","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=appodictic","name":"appodictic","key":"appodictic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Edward Capriolo","active":true,"timeZone":"Etc/UTC"},"body":"Makes sense.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=appodictic","name":"appodictic","key":"appodictic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Edward Capriolo","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-22T16:42:52.375+0000","updated":"2013-08-22T16:42:52.375+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13748676","id":"13748676","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"[~navis] It occurred to me that this optimization will become very powerful in combination with HIVE-4002 Imagine a case where there is a limit which can be pushed up in front of last RS. Than mappers will output very little data and with HIVE-4002 we can eliminate reducer altogether. Though these two optimizations cannot occur simultaneously in their current form since RSHash is implemented inside RS. We need to reimplement RSHash in FS. Alternative approach could be to implement RSHash as an operator which can than be put in front of either RS or FS. What do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-23T16:18:26.986+0000","updated":"2013-08-23T16:18:26.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13748683","id":"13748683","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhuai","name":"yhuai","key":"yhuai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yhuai&avatarId=23452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yhuai&avatarId=23452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yhuai&avatarId=23452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yhuai&avatarId=23452"},"displayName":"Yin Huai","active":true,"timeZone":"America/New_York"},"body":"Implementing RSHash as an operator sounds good. We can also use it in front of the RS of the right table of left semi join. Right now, there is a GBY. It is not straightforward in the query plan.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhuai","name":"yhuai","key":"yhuai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yhuai&avatarId=23452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yhuai&avatarId=23452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yhuai&avatarId=23452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yhuai&avatarId=23452"},"displayName":"Yin Huai","active":true,"timeZone":"America/New_York"},"created":"2013-08-23T16:31:49.394+0000","updated":"2013-08-23T16:31:49.394+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13749290","id":"13749290","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Thanks for a review.\n\nINLINE COMMENTS\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java:528 I thought it's a convention of hive to make configurations for enable/disable and threshold each, which was requested several times till now for me for other issues. I'll address that.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java:1187 Legend : A(a) --> key A, value a, row A(a)\n\n  If each mapper takes rows lite this\n  MAP1(RS) : 40(a)-10(b)-30(c)-10(d)-70(e)-80(f)\n  MAP2(RS) : 90(g)-80(h)-60(i)-40(j)-30(k)-20(l)\n  MAP3(RS) : 40(m)-50(n)-30(o)-30(p)-60(q)-70(r)\n\n  REDUCER : 10(b,d)-20(l)-30(c,k,o)-40(a,j,m)-50(n)-60(i,q)-70(e,r)-80(f,h)-90(g)\n  REDUCER(LIMIT 3) : 10(b,d)-20(l)-30(c,k,o)\n\n  with this patch\n\n  MAP1 : 40(a)-10(b)-30(c)-10(d)\n  MAP2 : 40(j)-30(k)-20(l)\n  MAP3 : 40(m)-50(n)-30(o)-30(p)\n\n  REDUCER : 10(b,d)-20(l)-30(c,k,o)-40(a,j,m)-50(n)\n  REDUCER(LIMIT 3) : 10(b,d)-20(l)-30(c,k,o)\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:154 I thought limit 0 is not realistic and can be used for some kind of testing. I'll address that case but making Hash seemed a little much.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:157 ReduceSinkHash makes arrays for key/value/hashes. It's for compensating those (not exact but I like the number).\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:325 I think there was a test for RS operator which has no collector. I'll check that.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:340 Right. I've missed that.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:343 It's possible to add key/value to hash which is flushed right before. But I just forwarded it.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:346 Right.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:434-436 It's not serializable class. But I'll add transient mod.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:471 I'll leave log message in the processOp() method.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:477 Return value can be false only if it's for GBY. False means the key exists already in RS hash.\n  For case A(a)->A(b)->B(c) with limit 5, the first A(a) will be stored into hash. For the second A(b), value b should be stored, which means values should be byte[][][] using additional array for each index consuming more memory. But I suspected that case could be a common case with map aggregation. So I just decided to forward A(b) to output collector.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:495 It does not remove anything. This is called after index is removed from RS hash.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:498 Good.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:535 Main difference of HashForOrder from HashForGroupBy is that it should store duplicated keys. As described in comments, A->B->B->C limit 3 should store A,B,B not A,B,C. I believe this behavior can be possibly implemented with simple TreeSet but thought this is way simpler.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:566 I prefer Map rather than Set but I'll change that.\n  ql/src/test/queries/clientpositive/limit_pushdown.q:14 ok\n  ql/src/test/queries/clientpositive/limit_pushdown.q:43 ok.\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:46 This is not exact description. RS for limit (not last RS). I'll change this, too.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:253-264 Looks promising. Need more investigation on implementation of distinct.\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nBRANCH\n  HIVE-3562\n\nARCANIST PROJECT\n  hive\n\nTo: JIRA, tarball, ashutoshc, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-24T03:56:52.004+0000","updated":"2013-08-24T03:56:52.004+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13749292","id":"13749292","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"body":"I think RSHash should be a entity that can be used in various operators but not independent operator, because the behavior might be dependent to each operator. In current implementation, I've modified RS only but the better way to implement this is calculating limit for each operators (bottom up way like CP or PPD) and make HASH for them. (Limit for GBY should be handled in GBY and for simple limit, RS, etc.)\n\nThere seemed remain much works to do. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"created":"2013-08-24T04:05:30.065+0000","updated":"2013-08-24T04:05:30.065+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13749296","id":"13749296","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"I agree that will be quite a bit of work and given that this patch is out there for long, We should try to get this in without major rework. Though, I think hash for FS will make this optimization with HIVE-4002 real cool.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-24T04:21:44.950+0000","updated":"2013-08-24T04:21:44.950+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13749302","id":"13749302","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"body":"Then, FS will be needed for context of limiting rows(limit, key expressions, etc.). I'll consider that, too.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"created":"2013-08-24T04:38:49.542+0000","updated":"2013-08-24T04:38:49.542+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13749303","id":"13749303","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"Correct. Thanks a lot for considering. I am fine doing that in seprate jira. FSHashSink will expand scope of this jira unnecessarily.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-24T04:41:23.137+0000","updated":"2013-08-24T04:41:23.137+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13749306","id":"13749306","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"ashutoshc has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Good stuff!\n\nINLINE COMMENTS\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java:528 Yeah I know historically we have done that way. But in my experience having more configs always confuses users instead of helping.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java:1187 Looks good. Can you update the patch with this?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:157 Sounds good. Please add it in comment.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:325 Sounds good.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:343 I see. I think just forwarding in this case is simple and better thing to do. So, lets leave it that way. Can you add a comment saying its possible to retry to add this to hash, but we don't do that yet. Also, collect()\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:434-436 Ah.. right. Than better not to add transient, otherwise will cause confusion.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:477 I see. Can you add comment here that further optimization like this is possible here. We can do this later.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:495 OK.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:535 I see. Missed this difference of duplicates. My major motivation in trying to unifying these two is so that in optimization rule we need not to worry about detecting whether there is a GBY in mapper or not.\n  If using TreeSet will not over complicate this, I will suggest that. But if that complicates things too much here, I am fine with current implementation as well. I will let you decide on that.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:566 Here, using Set is definitely cleaner (and memory efficient) as far as I can see.\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:46 Thanks.\n  ql/src/test/queries/clientpositive/limit_pushdown.q:14 Thanks. Also, as I said in comment add\n  select value,avg(key) from src group by value order by value limit 20;\n  with reduce sink dedup optimization on.\n  ql/src/test/queries/clientpositive/limit_pushdown.q:43 Thanks.\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nBRANCH\n  HIVE-3562\n\nARCANIST PROJECT\n  hive\n\nTo: JIRA, tarball, ashutoshc, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-24T04:46:52.695+0000","updated":"2013-08-24T04:46:52.695+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13749927","id":"13749927","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis updated the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Addressed some comments\n\nReviewers: ashutoshc, JIRA, tarball\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nCHANGE SINCE LAST DIFF\n  https://reviews.facebook.net/D5967?vs=38379&id=39009#toc\n\nAFFECTED FILES\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n  conf/hive-default.xml.template\n  ql/build.xml\n  ql/ivy.xml\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n  ql/src/test/queries/clientpositive/limit_pushdown.q\n  ql/src/test/queries/clientpositive/limit_pushdown_negative.q\n  ql/src/test/results/clientpositive/limit_pushdown.q.out\n  ql/src/test/results/clientpositive/limit_pushdown_negative.q.out\n\nTo: JIRA, tarball, ashutoshc, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-26T09:01:00.809+0000","updated":"2013-08-26T09:01:00.809+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13750007","id":"13750007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis updated the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Missed ASF header\n  Removed unnecessary array creation in RS\n\nReviewers: ashutoshc, JIRA, tarball\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nCHANGE SINCE LAST DIFF\n  https://reviews.facebook.net/D5967?vs=39009&id=39015#toc\n\nAFFECTED FILES\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n  conf/hive-default.xml.template\n  ql/build.xml\n  ql/ivy.xml\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n  ql/src/test/queries/clientpositive/limit_pushdown.q\n  ql/src/test/queries/clientpositive/limit_pushdown_negative.q\n  ql/src/test/results/clientpositive/limit_pushdown.q.out\n  ql/src/test/results/clientpositive/limit_pushdown_negative.q.out\n\nTo: JIRA, tarball, ashutoshc, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-26T11:18:52.429+0000","updated":"2013-08-26T11:18:52.429+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13750398","id":"13750398","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"ashutoshc has commented on the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Looks pretty good. Just requesting to add few more comments.\n\nINLINE COMMENTS\n  conf/hive-default.xml.template:1586-1590 We can remove this now.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java:1186 Just to add more clarity, say something like: we can push the limit above GBY (running in Reducer), since that will generate single row for each group. This doesn't necessarily hold for GBY (running in Mappers), so we don't push limit above it.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:182 It will be good to add comment about what this field is holding. Add a comment saying: This two dimensional array holds key data and a corresponding Union object which contains the tag identifying the aggregate expression for distinct columns.\n\n  Ideally, instead of this 2-D array, we should have probably enhanced HiveKey class for this logic. We should do that in a follow-up jira.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:267 I didnt follow this logic completely.\n  Seems like this is an optimization not to evaluate union object repeatedly and do system copy for it. Can you add a comment explaining this?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:271 seems like it will be null only for all i = 0. If so, better do if (i==0) check ? Also add comment when this will be null and when it will be non-null?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java:260 You made changes to this section, because you found bug or are you purely refactoring this? If you hit upon the bug, can you explain what was it?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java:50-51 It will be good to add comment about what these 2D arrays are holding?\n  ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java:52 Also, add comment saying this array holds hashcode for keys.\n\n  Also, add note that indices of all these arrays must line up.\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java:82 Nice Comments!\n  ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java:34 It will be good to add a javadoc for this class.\n  ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java:36 Also javadoc for this interface.\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nTo: JIRA, tarball, ashutoshc, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-26T18:50:52.268+0000","updated":"2013-08-26T18:50:52.268+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13750876","id":"13750876","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"navis updated the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  Addressed comments\n\nReviewers: ashutoshc, JIRA, tarball\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nCHANGE SINCE LAST DIFF\n  https://reviews.facebook.net/D5967?vs=39015&id=39051#toc\n\nAFFECTED FILES\n  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n  conf/hive-default.xml.template\n  ql/build.xml\n  ql/ivy.xml\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n  ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java\n  ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n  ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n  ql/src/test/queries/clientpositive/limit_pushdown.q\n  ql/src/test/queries/clientpositive/limit_pushdown_negative.q\n  ql/src/test/results/clientpositive/limit_pushdown.q.out\n  ql/src/test/results/clientpositive/limit_pushdown_negative.q.out\n\nTo: JIRA, tarball, ashutoshc, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-27T01:52:55.428+0000","updated":"2013-08-27T01:52:55.428+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13750955","id":"13750955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"body":"ashutoshc has accepted the revision \"HIVE-3562 [jira] Some limit can be pushed down to map stage\".\n\n  +1\n\nREVISION DETAIL\n  https://reviews.facebook.net/D5967\n\nBRANCH\n  HIVE-3562\n\nARCANIST PROJECT\n  hive\n\nTo: JIRA, tarball, ashutoshc, navis\nCc: njain\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phabricator%40reviews.facebook.net","name":"phabricator@reviews.facebook.net","key":"phabricator@reviews.facebook.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Phabricator","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-27T04:40:53.497+0000","updated":"2013-08-27T04:40:53.497+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13751276","id":"13751276","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"body":"I'm on vacation till next tuesday. Feel free to modify this patch, thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"created":"2013-08-27T14:01:14.158+0000","updated":"2013-08-27T14:01:14.158+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13752476","id":"13752476","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"Committed to trunk. Thanks, Navis for your persistence on this one!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-28T15:02:57.805+0000","updated":"2013-08-28T15:02:57.805+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13752490","id":"13752490","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"Good work Navis.\n\nLet me mark HIVE-5093 as obsoleted by this - no need for that hack anymore.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2013-08-28T15:13:02.954+0000","updated":"2013-08-28T15:13:02.954+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13752529","id":"13752529","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Hive-trunk-hadoop2-ptest #74 (See [https://builds.apache.org/job/Hive-trunk-hadoop2-ptest/74/])\nHIVE-3562 : Some limit can be pushed down to map stage (Navis via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1518234)\n* /hive/trunk/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n* /hive/trunk/conf/hive-default.xml.template\n* /hive/trunk/ql/build.xml\n* /hive/trunk/ql/ivy.xml\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n* /hive/trunk/ql/src/test/queries/clientpositive/limit_pushdown.q\n* /hive/trunk/ql/src/test/queries/clientpositive/limit_pushdown_negative.q\n* /hive/trunk/ql/src/test/results/clientpositive/limit_pushdown.q.out\n* /hive/trunk/ql/src/test/results/clientpositive/limit_pushdown_negative.q.out\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-28T16:10:48.417+0000","updated":"2013-08-28T16:10:48.417+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13752543","id":"13752543","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"body":"Good stuff, Navis!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=snarayanan","name":"snarayanan","key":"snarayanan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sivaramakrishnan Narayanan","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-28T16:24:09.833+0000","updated":"2013-08-28T16:24:09.833+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13752552","id":"13752552","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Hive-trunk-hadoop1-ptest #142 (See [https://builds.apache.org/job/Hive-trunk-hadoop1-ptest/142/])\nHIVE-3562 : Some limit can be pushed down to map stage (Navis via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1518234)\n* /hive/trunk/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n* /hive/trunk/conf/hive-default.xml.template\n* /hive/trunk/ql/build.xml\n* /hive/trunk/ql/ivy.xml\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n* /hive/trunk/ql/src/test/queries/clientpositive/limit_pushdown.q\n* /hive/trunk/ql/src/test/queries/clientpositive/limit_pushdown_negative.q\n* /hive/trunk/ql/src/test/results/clientpositive/limit_pushdown.q.out\n* /hive/trunk/ql/src/test/results/clientpositive/limit_pushdown_negative.q.out\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-28T16:30:56.537+0000","updated":"2013-08-28T16:30:56.537+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13753307","id":"13753307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in Hive-trunk-h0.21 #2295 (See [https://builds.apache.org/job/Hive-trunk-h0.21/2295/])\nHIVE-3562 : Some limit can be pushed down to map stage (Navis via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1518234)\n* /hive/trunk/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n* /hive/trunk/conf/hive-default.xml.template\n* /hive/trunk/ql/build.xml\n* /hive/trunk/ql/ivy.xml\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n* /hive/trunk/ql/src/test/queries/clientpositive/limit_pushdown.q\n* /hive/trunk/ql/src/test/queries/clientpositive/limit_pushdown_negative.q\n* /hive/trunk/ql/src/test/results/clientpositive/limit_pushdown.q.out\n* /hive/trunk/ql/src/test/results/clientpositive/limit_pushdown_negative.q.out\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-29T05:14:02.083+0000","updated":"2013-08-29T05:14:02.083+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13753365","id":"13753365","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"ABORTED: Integrated in Hive-trunk-hadoop2 #387 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/387/])\nHIVE-3562 : Some limit can be pushed down to map stage (Navis via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1518234)\n* /hive/trunk/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java\n* /hive/trunk/conf/hive-default.xml.template\n* /hive/trunk/ql/build.xml\n* /hive/trunk/ql/ivy.xml\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ExtractOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ForwardOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/GroupByOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/ReduceSinkOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/SelectOperator.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/TopNHash.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/io/HiveKey.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/LimitPushdownOptimizer.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/Optimizer.java\n* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/ReduceSinkDesc.java\n* /hive/trunk/ql/src/test/queries/clientpositive/limit_pushdown.q\n* /hive/trunk/ql/src/test/queries/clientpositive/limit_pushdown_negative.q\n* /hive/trunk/ql/src/test/results/clientpositive/limit_pushdown.q.out\n* /hive/trunk/ql/src/test/results/clientpositive/limit_pushdown_negative.q.out\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-29T06:33:44.279+0000","updated":"2013-08-29T06:33:44.279+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13795963","id":"13795963","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"This issue has been fixed and released as part of 0.12 release. If you find further issues, please create a new jira and link it to this one.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-10-15T23:30:04.008+0000","updated":"2013-10-15T23:30:04.008+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13805523","id":"13805523","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"Quick question - is it intended that excluded is only counted when the key is thrown out immediately? So if this doesn't happen it is likely to self-disable.\nIf the keys all go to the heap and later get evicted, it can still be useful to output less rows esp. if the data size is big and N is comparatively small.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-10-25T17:59:15.575+0000","updated":"2013-10-25T17:59:15.575+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13808846","id":"13808846","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"body":"[~sershe] Sorry for late reply. I thought the cost of top-n hash(array copy, memory usage, etc.) would be bigger than possible gain of unknown future. Better policy might be implemented in following issue by someone with good idea.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=navis","name":"navis","key":"navis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=navis&avatarId=19885","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=navis&avatarId=19885","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=navis&avatarId=19885","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=navis&avatarId=19885"},"displayName":"Navis","active":true,"timeZone":"Asia/Seoul"},"created":"2013-10-30T08:21:40.013+0000","updated":"2013-10-30T08:21:40.013+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/13809865","id":"13809865","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"Let me file a jira...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-10-31T02:40:13.403+0000","updated":"2013-10-31T02:40:13.403+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611120/comment/14392243","id":"14392243","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=leftylev","name":"leftylev","key":"lefty@hortonworks.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lefty%40hortonworks.com&avatarId=15906","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lefty%40hortonworks.com&avatarId=15906","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lefty%40hortonworks.com&avatarId=15906","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lefty%40hortonworks.com&avatarId=15906"},"displayName":"Lefty Leverenz","active":true,"timeZone":"America/New_York"},"body":"Doc note & questions:  This adds *hive.limit.pushdown.memory.usage* to HiveConf.java, so it has been documented in the wiki with the description \"The maximum memory to be used for hash in RS operator for top K selection. The default value '-1' means no limit.\"\n\nQ1:  Does RS mean reduce sink?  (If so, I'll explain that in the description.)\nQ2:  What values can be set?  (The template file originally said the default was 0.3, which implies it's a proportion of total memory or some such.)\n\n* [Configuration Properties -- hive.limit.pushdown.memory.usage | https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties#ConfigurationProperties-hive.limit.pushdown.memory.usage]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=leftylev","name":"leftylev","key":"lefty@hortonworks.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lefty%40hortonworks.com&avatarId=15906","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lefty%40hortonworks.com&avatarId=15906","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lefty%40hortonworks.com&avatarId=15906","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lefty%40hortonworks.com&avatarId=15906"},"displayName":"Lefty Leverenz","active":true,"timeZone":"America/New_York"},"created":"2015-04-02T06:50:53.768+0000","updated":"2015-04-02T06:55:30.562+0000"}],"maxResults":69,"total":69,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-3562/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07win:"}}