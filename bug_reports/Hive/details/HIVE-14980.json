{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13012644","self":"https://issues.apache.org/jira/rest/api/2/issue/13012644","key":"HIVE-14980","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/10004","id":"10004","description":"Not A Bug","name":"Not A Bug"},"customfield_12312322":null,"customfield_12310220":"2016-10-17T19:23:30.140+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Oct 02 19:21:38 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_30399643027_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-10-02T19:21:38.799+0000","workratio":0,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-14980/watchers","watchCount":5,"isWatching":false},"created":"2016-10-15T23:00:55.862+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":345600,"aggregatetimeoriginalestimate":345600,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334255","id":"12334255","name":"2.1.0","archived":false,"released":true,"releaseDate":"2016-06-20"}],"issuelinks":[{"id":"12486734","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12486734","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13020715","key":"HIVE-15202","self":"https://issues.apache.org/jira/rest/api/2/issue/13020715","fields":{"summary":"Concurrent compactions for the same partition may generate malformed folder structure","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahipal.jupalli","name":"mahipal.jupalli","key":"mahipal.jupalli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahipal Jupalli","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-10-02T19:21:38.885+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312584","id":"12312584","name":"Metastore","description":"Tracks issue dealing with metastore."},{"self":"https://issues.apache.org/jira/rest/api/2/component/12322671","id":"12322671","name":"Transactions","description":"Transaction management and ACID"}],"timeoriginalestimate":345600,"description":"I have two tables (TABLEA, TABLEB). If I manually trigger compaction after each INSERT into TABLEB from TABLEA, compactions are triggered on random metastore asynchronously and are stepping on each other which is causing the data to be deleted.\n\nExample here: \nTABLEA - has 10k rows. \n\ninsert into mj.tableb select * from mj.tablea;\nalter table mj.tableb compact 'MINOR';\ninsert into mj.tableb select * from mj.tablea;\nalter table mj.tableb compact 'MINOR';\n\nOnce all the compactions are complete, I should ideally see 20k rows in TABLEB. But I see only 10k rows (Only the rows INSERTED before the last compaction persist, the old rows are deleted. I believe the old delta files are deleted). \n\nTo further confirm the bug, if I do only one compaction after two inserts, I see 20k rows in TABLEB.\n\nProposed Fix:\nI have identified the bug in the code, it requires an additional check in the org.apache.hadoop.hive.ql.txn.compactor.Worker class to check for any active compactions on the table/partition. I will 'share the details of the fix once I test it.","customfield_10010":null,"timetracking":{"originalEstimate":"96h","remainingEstimate":"96h","originalEstimateSeconds":345600,"remainingEstimateSeconds":345600},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":345600,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Minor compaction when triggered simultaniously on the same table/partition deletes data","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahipal.jupalli","name":"mahipal.jupalli","key":"mahipal.jupalli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahipal Jupalli","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahipal.jupalli","name":"mahipal.jupalli","key":"mahipal.jupalli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahipal Jupalli","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":345600,"percent":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10430","value":"Patch","id":"10430"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10431","value":"Important","id":"10431"}],"progress":{"progress":0,"total":345600,"percent":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13012644/comment/15578923","id":"15578923","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahipal.jupalli","name":"mahipal.jupalli","key":"mahipal.jupalli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahipal Jupalli","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi,\n\nMy idea is to replicate the same checks from the org.apache.hadoop.hive.ql.txn.compactor.Initiator.java to the org.apache.hadoop.hive.ql.txn.compactor.Worker.java logic.\n\n{code:title=org.apache.hadoop.hive.ql.txn.compactor.Initiator.java|borderStyle=solid}\n// Figure out if there are any currently running compactions on the same table or partition.\n  private boolean lookForCurrentCompactions(ShowCompactResponse compactions,\n                                            CompactionInfo ci) {\n    if (compactions.getCompacts() != null) {\n      for (ShowCompactResponseElement e : compactions.getCompacts()) {\n         if ((e.getState().equals(TxnStore.WORKING_RESPONSE) || e.getState().equals(TxnStore.INITIATED_RESPONSE)) &&\n            e.getDbname().equals(ci.dbname) &&\n            e.getTablename().equals(ci.tableName) &&\n            (e.getPartitionname() == null && ci.partName == null ||\n                  e.getPartitionname().equals(ci.partName))) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n\npublic void run(){\n    //...\n    if (lookForCurrentCompactions(currentCompactions, ci)) {\n        LOG.debug(\"Found currently initiated or working compaction for \" + ci.getFullPartitionName() + \" so we will not initiate another compaction\");\n        continue;\n    }\n    //...\n}\n{code}\n\n{code:title=org.apache.hadoop.hive.ql.txn.compactor.Worker.java|borderStyle=solid}\npublic void run() {\n      //...\n          // This chicanery is to get around the fact that the table needs to be final in order to\n        // go into the doAs below.\n        final Table t = t1;\n\n        ShowCompactResponse currentCompactions = txnHandler.showCompact(new ShowCompactRequest());\n        if (lookForCurrentCompactions(currentCompactions, ci)) {\n          LOG.debug(\"Found currently initiated or working compaction for \" +\n              ci.getFullPartitionName() + \" so we will not initiate another compaction\");\n          continue;\n        }\n        \n        // Find the partition we will be working with, if there is one.\n        Partition p = null;\n      //...\n      //Figure out if there are any currently running compactions on the same table or partition.\n private boolean lookForCurrentCompactions(ShowCompactResponse compactions,\n                                           CompactionInfo ci) {\n   if (compactions.getCompacts() != null) {\n     for (ShowCompactResponseElement e : compactions.getCompacts()) {\n        if ((e.getState().equals(TxnStore.WORKING_RESPONSE) || e.getState().equals(TxnStore.INITIATED_RESPONSE)) &&\n           e.getDbname().equals(ci.dbname) &&\n           e.getTablename().equals(ci.tableName) &&\n           (e.getPartitionname() == null && ci.partName == null ||\n                 e.getPartitionname().equals(ci.partName))) {\n         return true;\n       }\n     }\n   }\n   return false;\n }\n}\n  //...\n{code}\n\nPlease let me know if this is the correct approach.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahipal.jupalli","name":"mahipal.jupalli","key":"mahipal.jupalli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahipal Jupalli","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-10-15T23:27:58.716+0000","updated":"2016-10-15T23:28:53.682+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13012644/comment/15583187","id":"15583187","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"cc [~ekoifman] \n\nShould the compactor just use locks?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-10-17T19:23:30.140+0000","updated":"2016-10-17T19:23:30.140+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13012644/comment/15583692","id":"15583692","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"body":"Relying on \"show compactions\" is not atomic so it's not a complete fix.\nIt should use locks of some kind, but not in the current lock manager.  MutexAPI.acquireLock(String) was meant to support the kind of locking that this needs but it's not quite complete.  If you use </db/table/partition> for the key, and use this from Worker, it will achieve the proper synchronization atomically and the \"lock\" will be released if the process dies.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-10-17T22:26:26.460+0000","updated":"2016-10-17T22:26:26.460+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13012644/comment/15710467","id":"15710467","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"body":"This should now be fixed via HIVE-15202","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-01T01:23:37.090+0000","updated":"2016-12-01T01:23:37.090+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13012644/comment/16188659","id":"16188659","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"body":"fixed in HIVE-15202","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ekoifman","name":"ekoifman","key":"ekoifman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Koifman","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-02T19:21:38.865+0000","updated":"2017-10-02T19:21:38.865+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-14980/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i34y3z:"}}