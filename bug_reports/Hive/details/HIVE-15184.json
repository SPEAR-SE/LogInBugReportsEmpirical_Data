{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13020094","self":"https://issues.apache.org/jira/rest/api/2/issue/13020094","key":"HIVE-15184","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-03-28T18:18:45.062+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Oct 05 07:36:30 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-15184/watchers","watchCount":3,"isWatching":false},"created":"2016-11-11T11:59:44.019+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12332154","id":"12332154","description":"","name":"1.3.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334886","id":"12334886","name":"2.0.1","archived":false,"released":true,"releaseDate":"2016-05-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334255","id":"12334255","name":"2.1.0","archived":false,"released":true,"releaseDate":"2016-06-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335837","id":"12335837","name":"2.2.0","archived":false,"released":true,"releaseDate":"2017-07-25"}],"issuelinks":[{"id":"12486338","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12486338","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13016129","key":"HIVE-15090","self":"https://issues.apache.org/jira/rest/api/2/issue/13016129","fields":{"summary":"Temporary DB failure can stop ExpiredTokenRemover thread","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-10-05T07:36:30.937+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12320408","id":"12320408","name":"HiveServer2","description":"Tracks issues related to HiveServer2"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312584","id":"12312584","name":"Metastore","description":"Tracks issue dealing with metastore."}],"timeoriginalestimate":null,"description":"After HIVE-15090 committed we discussed it with [~thejas] and agreed, that it would be even better if the DelegateTokenStore implementation could decide if an error is recoverable or not. Since the DelegationTokenStore is not mentioned as a Hive API it is possible to change the interface, so we could change the implementations shipped with Hive to use the new functionality, and if someone uses it's own implementation of DelegationTokenStore, then he should do the matching changes himself","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12838568","id":"12838568","filename":"HIVE-15184.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"created":"2016-11-11T15:56:52.645+0000","size":4485,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12838568/HIVE-15184.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Add the possibility to separate recoverable and not recoverable errors in DelegationTokenStore","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/15657397","id":"15657397","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"body":"Hi [~thejas],\n\nSomething like this was in your head?\n\nI think this is quiet elegant solution for the DBTokenStore. Tested this patch, and it handles nicely when I switch on/off the database server. The testing method was the same as in HIVE-15090.\n\nAs for the ZooKeeperTokenStore I have yet to find such a nice solution. If you have any idea, I am open to any suggestions :)\n\nThanks,\nPeter","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"created":"2016-11-11T15:56:52.650+0000","updated":"2016-11-11T15:56:52.650+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/15663357","id":"15663357","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"body":"I have tested this with ZooKeeperTokenStore too.\nWhat I have found that the CuratorFramework handles failures in a RetryLoop.callWithRetry, so my guess is that the transient errors are handled by the framework. The specific error which caused HIVE-13090 and HIVE-13075 is handled by their specific patch.\n\nSo I think we are good to go if we agree on this solution.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"created":"2016-11-14T10:06:48.753+0000","updated":"2016-11-14T10:06:48.753+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/15663360","id":"15663360","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"body":"The results are not posted automatically, so I have copied them here:\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12838568/HIVE-15184.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 10637 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=91)\norg.apache.hive.spark.client.TestSparkClient.testJobSubmission (batchId=272)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2089/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2089/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2089/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 4 tests failed\n{noformat}\n\nThis message is automatically generated.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"created":"2016-11-14T10:07:53.522+0000","updated":"2016-11-14T10:07:53.522+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/15663373","id":"15663373","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"body":"The errors are not related:\n- HIVE-15116 Flaky test: TestMiniLlapLocalCliDriver.testCliDriver join_acid_non_acid\n- HIVE-15115 Flaky test: TestMiniLlapLocalCliDriver.testCliDriver union_fast_stats\n- HIVE-15084 Flaky test: TestMiniTezCliDriver:explainanalyze_2, 3, 4, 5\n- HIVE-15168 Flaky test: TestSparkClient.testJobSubmission (still flaky)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"created":"2016-11-14T10:12:06.932+0000","updated":"2016-11-14T10:12:06.932+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/15945661","id":"15945661","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"body":"[~pvary], could you explain why we are calling runtime.exit() in case of unrecoverable error? It seems like we are saying that the metastore should not work anymore if we are not able to cleanup expired tokens. Seems a little extreme to me.\n\nYou mentioned that you tested this with shutting the db down, what would happen if it was a transient connection exception? In our environment, we are seeing this: \n{noformat}\n2017-03-28 17:03:26,192 ERROR thrift.TokenStoreDelegationTokenSecretManager (TokenStoreDelegationTokenSecretManager.java:run(331)) - ExpiredTokenRemover thread received unexpected exception. org.apache.hadoop.hive.thrift\n.DelegationTokenStore$TokenStoreException: javax.jdo.JDODataStoreException: Communications link failure\n{noformat}\n\nIt appears that the above is triggered when we somehow end up reusing a \"dead\" connection (we are still investigating this). Anyway, just wanted to mention that it might be better to reconsider the exit() option.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-28T18:18:45.062+0000","updated":"2017-03-28T18:18:45.062+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/15945792","id":"15945792","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12838568/HIVE-15184.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 10514 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[escape_comments] (batchId=231)\norg.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[comments] (batchId=35)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[columnstats_part_coltype] (batchId=153)\norg.apache.hive.hcatalog.api.TestHCatClient.testTransportFailure (batchId=172)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/4417/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/4417/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4417/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 4 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12838568 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2017-03-28T19:37:01.684+0000","updated":"2017-03-28T19:37:01.684+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/15946979","id":"15946979","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"body":"[~sbeeram]: If the thread is stopped, then the TokeStore become a memory leak by accumulating the token objects forever. We will get an OOM error eventually, but after a longer period of time, and at that moment we will have very hard time to identify the original problem which caused this. That is why I think it is better for the long term, to exit immediately.\nThe {{JDODataStoreException}} is a subclass of {{JDOCanRetryException}}, so after this patch the MetaStore will try to recover.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"created":"2017-03-29T11:58:17.111+0000","updated":"2017-03-29T11:58:17.111+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/15947497","id":"15947497","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for the clarification [~pvary]. \n\nThe memory leak would be a concern for MemoryTokenStore right? In case of a persistent store based TokenStore, specifically  in the db case, we'll accumulate rows infinitely, which may  ulltimately degrade the service. Let me know if I am missing something. For the latter (db/zk) case a metric/alert might be an option to consider?\n\nIf we do go down path of shutting the service down on failure to cleanup, would be great if we can make the documentation clearer as to why we think its one of the fatal errors. \n\nFor this final point, I don't have a clear answer either yet, but did want to bring it up: is there a better way than using getRuntime.exit()? For ex, if we are writing unit-tests for the token-remover, it could result in the test jvm exiting unexpectedly if for some reason we end up tracing that block, right? Can we signal the main application thread to exit using a different approach?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sbeeram","name":"sbeeram","key":"sbeeram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sbeeram&avatarId=30539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sbeeram&avatarId=30539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sbeeram&avatarId=30539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sbeeram&avatarId=30539"},"displayName":"Sunitha Beeram","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-29T16:56:21.933+0000","updated":"2017-03-29T16:56:21.933+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/15948946","id":"15948946","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"body":"Thanks [~sbeeram] for taking a look at this! I thought nobody will be interested about this patch :)\n\nThe {{TokenStoreDelegationTokenSecretManager}} extends {{DelegationTokenSecretManager}} which in turn extends {{AbstractDelegationTokenSecretManager}}. There is a cache for the currentTokens in {{AbstractDelegationTokenSecretManager}} which we are actively using in TokenStoreDelegationTokenSecretManager.\n\n{code:title=\"AbstractDelegationTokenSecretManager\"}\n  /** \n   * Cache of currently valid tokens, mapping from DelegationTokenIdentifier \n   * to DelegationTokenInformation. Protected by this object lock.\n   */\n  protected final Map<TokenIdent, DelegationTokenInformation> currentTokens \n      = new HashMap<TokenIdent, DelegationTokenInformation>();\n{code}\n\n{code:title=TokenStoreDelegationTokenSecretManager}\n  protected void rollMasterKeyExt() throws IOException {\n    Map<Integer, DelegationKey> keys = reloadKeys();\n    int currentKeyId = super.currentId;\n    HiveDelegationTokenSupport.rollMasterKey(TokenStoreDelegationTokenSecretManager.this);\n    List<DelegationKey> keysAfterRoll = Arrays.asList(getAllKeys());\n[..]\n  }\n{code}\nReading the code above, I think the memory leak would be a concern independently of the actual TokenStore implementation, what do you think?\n\nAbout the documentation of the exit, here it is what we do:\n- Print out the original exception\n- Print out that we think the exception is unrecoverable\n- Call {{Runtime.getRuntime().exit(-1)}}\nWhat kind of documentation is in your mind? More comments in the code? Better error message? Anything else?\n\nAbout the way of exit, yeah, it is a little drastic way of exiting the metastore. To be honest I only replicated the solution which was used before https://github.com/apache/hive/blob/40a12d5535d4b81d297b3529bec7f35bf713b251/shims/common/src/main/java/org/apache/hadoop/hive/thrift/TokenStoreDelegationTokenSecretManager.java#L333\nI am open for any suggestions :)\n\nThanks again for the review,\nPeter \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"created":"2017-03-30T12:11:05.164+0000","updated":"2017-03-30T12:11:05.164+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/16191967","id":"16191967","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"[~thejas] do you want to guide this thru to completion?\nI looked at the patch and it mostly makes sense to me. Why is the pom change needed? Doesn't look like the new shims code uses jdo.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-04T20:12:47.908+0000","updated":"2017-10-04T20:12:47.908+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/16192325","id":"16192325","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12838568/HIVE-15184.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 11200 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestAccumuloCliDriver.testCliDriver[accumulo_predicate_pushdown] (batchId=232)\norg.apache.hadoop.hive.cli.TestAccumuloCliDriver.testCliDriver[accumulo_single_sourced_multi_insert] (batchId=232)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[optimize_nullscan] (batchId=162)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=157)\norg.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_explainuser_1] (batchId=171)\norg.apache.hadoop.hive.cli.TestTezPerfCliDriver.testCliDriver[query14] (batchId=240)\norg.apache.hadoop.hive.cli.TestTezPerfCliDriver.testCliDriver[query23] (batchId=240)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/7126/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/7126/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-7126/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 7 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12838568 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2017-10-05T01:06:46.842+0000","updated":"2017-10-05T01:06:46.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13020094/comment/16192562","id":"16192562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"body":"IIRC we need the new jars, to be able to check the Exception thrown by JDBC:\n{code}\nif (cause instanceof JDOCanRetryException) {   <-- for this line only :)\n{code}\nThanks for looking at this [~sershe]!\n\nPeter","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pvary","name":"pvary","key":"pvary","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Vary","active":true,"timeZone":"Europe/Budapest"},"created":"2017-10-05T07:36:30.937+0000","updated":"2017-10-05T07:36:30.937+0000"}],"maxResults":12,"total":12,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-15184/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i367xr:"}}