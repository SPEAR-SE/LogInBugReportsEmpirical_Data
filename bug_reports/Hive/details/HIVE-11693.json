{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12860624","self":"https://issues.apache.org/jira/rest/api/2/issue/12860624","key":"HIVE-11693","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-08-31T17:36:44.874+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Nov 14 01:01:44 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-11693/watchers","watchCount":9,"isWatching":false},"created":"2015-08-31T08:05:21.388+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=selinazh","name":"selinazh","key":"selinazh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=selinazh&avatarId=19244","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=selinazh&avatarId=19244","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=selinazh&avatarId=19244","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=selinazh&avatarId=19244"},"displayName":"Selina Zhang","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-11-15T16:46:22.826+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[],"timeoriginalestimate":null,"description":"Got this when executing a simple query with latest hive build + tez latest version.\n\n{noformat}\nError: Failure while running task: attempt_1439860407967_0291_2_03_000045_0:java.lang.RuntimeException: java.lang.RuntimeException: Hive Runtime Error while closing operators: java.lang.RuntimeException: java.io.IOException: Please check if you are invoking moveToNext() even after it returned false.\nat org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:171)\nat org.apache.hadoop.hive.ql.exec.tez.TezProcessor.run(TezProcessor.java:137)\nat org.apache.tez.runtime.LogicalIOProcessorRuntimeTask.run(LogicalIOProcessorRuntimeTask.java:349)\nat org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:71)\nat org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:60)\nat java.security.AccessController.doPrivileged(Native Method)\nat javax.security.auth.Subject.doAs(Subject.java:422)\nat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1628)\nat org.apache.tez.runtime.task.TaskRunner2Callable.callInternal(TaskRunner2Callable.java:60)\nat org.apache.tez.runtime.task.TaskRunner2Callable.callInternal(TaskRunner2Callable.java:35)\nat org.apache.tez.common.CallableWithNdc.call(CallableWithNdc.java:36)\nat java.util.concurrent.FutureTask.run(FutureTask.java:266)\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\nat java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.RuntimeException: Hive Runtime Error while closing operators: java.lang.RuntimeException: java.io.IOException: Please check if you are invoking moveToNext() even after it returned false.\nat org.apache.hadoop.hive.ql.exec.tez.ReduceRecordProcessor.close(ReduceRecordProcessor.java:316)\nat org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:162)\n... 14 more\nCaused by: org.apache.hadoop.hive.ql.metadata.HiveException: java.lang.RuntimeException: java.io.IOException: Please check if you are invoking moveToNext() even after it returned false.\nat org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.fetchOneRow(CommonMergeJoinOperator.java:412)\nat org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.fetchNextGroup(CommonMergeJoinOperator.java:375)\nat org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.doFirstFetchIfNeeded(CommonMergeJoinOperator.java:482)\nat org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.joinFinalLeftData(CommonMergeJoinOperator.java:434)\nat org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.closeOp(CommonMergeJoinOperator.java:384)\nat org.apache.hadoop.hive.ql.exec.Operator.close(Operator.java:616)\nat org.apache.hadoop.hive.ql.exec.tez.ReduceRecordProcessor.close(ReduceRecordProcessor.java:292)\n... 15 more\nCaused by: java.lang.RuntimeException: java.io.IOException: Please check if you are invoking moveToNext() even after it returned false.\nat org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource.pushRecord(ReduceRecordSource.java:291)\nat org.apache.hadoop.hive.ql.exec.CommonMergeJoinOperator.fetchOneRow(CommonMergeJoinOperator.java:400)\n... 21 more\nCaused by: java.io.IOException: Please check if you are invoking moveToNext() even after it returned false.\nat org.apache.tez.runtime.library.common.ValuesIterator.hasCompletedProcessing(ValuesIterator.java:223)\nat org.apache.tez.runtime.library.common.ValuesIterator.moveToNext(ValuesIterator.java:105)\nat org.apache.tez.runtime.library.input.OrderedGroupedKVInput$OrderedGroupedKeyValuesReader.next(OrderedGroupedKVInput.java:308)\nat org.apache.hadoop.hive.ql.exec.tez.KeyValuesFromKeyValues.next(KeyValuesFromKeyValues.java:46)\nat org.apache.hadoop.hive.ql.exec.tez.ReduceRecordSource.pushRecord(ReduceRecordSource.java:249)\n... 22 more\n{noformat}\n\nNot sure if this is related to HIVE-11016. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12766760","id":"12766760","filename":"HIVE-11693.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajesh.balamohan","name":"rajesh.balamohan","key":"rajesh.balamohan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Balamohan","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-10-15T10:04:04.860+0000","size":1281,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12766760/HIVE-11693.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"CommonMergeJoinOperator throws exception with tez","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajesh.balamohan","name":"rajesh.balamohan","key":"rajesh.balamohan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Balamohan","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajesh.balamohan","name":"rajesh.balamohan","key":"rajesh.balamohan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Balamohan","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/14723754","id":"14723754","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"Is there a warning log added in HIVE-11016 present in the logs?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-08-31T17:36:44.874+0000","updated":"2015-08-31T17:36:44.874+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/14724349","id":"14724349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajesh.balamohan","name":"rajesh.balamohan","key":"rajesh.balamohan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Balamohan","active":true,"timeZone":"Asia/Kolkata"},"body":"[~sershe] - Are you referring to \"LOG.warn(\"fetchDone[\" + tag + \"] was set to true (by a recursive call) and will be reset\");\" ?. No, I do not find that in the logs. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajesh.balamohan","name":"rajesh.balamohan","key":"rajesh.balamohan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Balamohan","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-08-31T23:03:15.397+0000","updated":"2015-08-31T23:03:15.397+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/14724365","id":"14724365","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"body":"Well, then it's some other issue","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sershe","name":"sershe","key":"sershe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Shelukhin","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-08-31T23:11:42.422+0000","updated":"2015-08-31T23:11:42.422+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/14958604","id":"14958604","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajesh.balamohan","name":"rajesh.balamohan","key":"rajesh.balamohan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Balamohan","active":true,"timeZone":"Asia/Kolkata"},"body":"attaching query (col names and table names modified) which caused the issue.\n\n{noformat}\n\nSELECT v1.rid,\n       v1.`jeid`,\n       v1.`jelid`,\n       v1.`jeldesc`,\n       v1.`jehdesc`,\n       v1.`dorc`,\n       v1.`la`,\n       `lad`,\n       `lac`,\n       `lacc`,\n       v1.`ejei`,\n       `activity`,\n       v1.`cacid`,\n       v1.`cuid`,\n       `p`,\n       `fn`,\n       `ln`,\n       `n`,\n       `pd`,\n       `pr`,\n       `pt`\nFROM v_flat_journal_entry_ext v1\nJOIN\n  (SELECT `jeid`,\n          `jelid`,\n          `ejeid`,\n          `cuid`,\n          `pid`,\n          count(*) AS cnd\n   FROM v_flat_journal_entry_ext\n   GROUP BY `jeid`,\n            `jelid`,\n            `ejeid`,\n            `cuid`,\n            `pid`\n   HAVING cnd > 1) test ON (test.`pid` = v1.`pid`);   \n{noformat}\n\nBasically, CommonMergeJoinOperator::fetchNextGroup had the issue.\ne.g it entered the following condition in code (foundNextKeyGroup[t]=false, fetchDone[t]=false, t=1, orderLen=2, posBigTable=0)\n\nFixing it in ReduceRecordSource which deals with the readers.  Need to check if the same has to be done in MapRecordSource.\n\n[~gopalv], [~sershe] - Please review when you find time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajesh.balamohan","name":"rajesh.balamohan","key":"rajesh.balamohan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajesh Balamohan","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-10-15T10:04:04.867+0000","updated":"2015-10-15T10:04:04.867+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/14960782","id":"14960782","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12766760/HIVE-11693.1.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 2 failed/errored test(s), 9694 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation\norg.apache.hive.jdbc.TestSSL.testSSLVersion\n{noformat}\n\nTest results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5676/testReport\nConsole output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5676/console\nTest logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5676/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 2 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12766760 - PreCommit-HIVE-TRUNK-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2015-10-16T14:26:20.004+0000","updated":"2015-10-16T14:26:20.004+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/15302701","id":"15302701","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=selinazh","name":"selinazh","key":"selinazh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=selinazh&avatarId=19244","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=selinazh&avatarId=19244","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=selinazh&avatarId=19244","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=selinazh&avatarId=19244"},"displayName":"Selina Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"[~rajesh.balamohan], we hit the same issue recently. But I think the patch you attached did not fix the root problem. \n\nThe issue is actually CommonMergeJoinOperator only set big table position when it has inputs for big table. \n\n{code:title=CommonMergeJoinOperator.java}\n  @Override\n  public void process(Object row, int tag) throws HiveException {\n    posBigTable = (byte) conf.getBigTablePosition();\n...\n{code}\n\nIf the input is empty, the above method will not be called. In the query you listed, a subquery is involved. The generated table is tagged as 0, while the left table is tagged as 1.  GenTezWork.java set the big table position as 1 for both reduce work and CommonJoinOperator. In reduce phase, when ReduceRecordProcessor got executed, it retrieves the record from big table:\n\n{code:title=ReduceRecordProcessor.java}\n@Override\n  void run() throws Exception {\n....\n    // run the operator pipeline\n    while (sources[bigTablePosition].pushRecord()) {\n    }\n  }\n{code}\n\nThe big table position here is 1. If the input from the big table is empty, this is the only place pushRecord() be called to read big table. However, because the CommonMergeJoinOperator missed set big table position, in closeOp() part, it will think tag 1 is small table, so another pushRecord() is called to retrieve table content. Then we see the exception listed in this JIRA. \n\nPlease let me know if my analysis has problem. If you think it is correct, can you update the patch?\n\nThanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=selinazh","name":"selinazh","key":"selinazh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=selinazh&avatarId=19244","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=selinazh&avatarId=19244","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=selinazh&avatarId=19244","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=selinazh&avatarId=19244"},"displayName":"Selina Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-26T19:01:39.479+0000","updated":"2016-05-26T19:01:39.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/15364709","id":"15364709","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mithun","name":"mithun","key":"mithun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mithun&avatarId=18936","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mithun&avatarId=18936","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mithun&avatarId=18936","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mithun&avatarId=18936"},"displayName":"Mithun Radhakrishnan","active":true,"timeZone":"America/Los_Angeles"},"body":"[~rajesh.balamohan], et al., [~selinazh]'s analysis here seems accurate. Wouldn't her suggestion (i.e. to move {{posBigTable = (byte) conf.getBigTablePosition();}} to {{initializeOp()}}) fix the problem?\n\nWould anyone else like to comment?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mithun","name":"mithun","key":"mithun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mithun&avatarId=18936","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mithun&avatarId=18936","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mithun&avatarId=18936","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mithun&avatarId=18936"},"displayName":"Mithun Radhakrishnan","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-07-06T17:36:48.778+0000","updated":"2016-07-06T17:36:48.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/15364712","id":"15364712","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"That sounds reasonable - since this is unassigned and AFAIK [~rajesh.balamohan] has been dragged into hadoop-common/hdfs, can [~selinazh] take over and provide a patch?\n\nFor now, this is +1 - tests pending.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-07-06T17:41:23.180+0000","updated":"2016-07-06T17:41:23.180+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/15364738","id":"15364738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mithun","name":"mithun","key":"mithun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mithun&avatarId=18936","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mithun&avatarId=18936","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mithun&avatarId=18936","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mithun&avatarId=18936"},"displayName":"Mithun Radhakrishnan","active":true,"timeZone":"America/Los_Angeles"},"body":"Kewl. Assigned to [~selinazh]. Should have our patch out soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mithun","name":"mithun","key":"mithun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mithun&avatarId=18936","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mithun&avatarId=18936","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mithun&avatarId=18936","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mithun&avatarId=18936"},"displayName":"Mithun Radhakrishnan","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-07-06T17:51:59.405+0000","updated":"2016-07-06T17:51:59.405+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/15417699","id":"15417699","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mithun","name":"mithun","key":"mithun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mithun&avatarId=18936","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mithun&avatarId=18936","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mithun&avatarId=18936","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mithun&avatarId=18936"},"displayName":"Mithun Radhakrishnan","active":true,"timeZone":"America/Los_Angeles"},"body":"[~selinazh], could we please post our solution to this JIRA?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mithun","name":"mithun","key":"mithun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mithun&avatarId=18936","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mithun&avatarId=18936","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mithun&avatarId=18936","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mithun&avatarId=18936"},"displayName":"Mithun Radhakrishnan","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-11T18:14:00.719+0000","updated":"2016-08-11T18:14:00.719+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/15418137","id":"15418137","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12766760/HIVE-11693.1.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 6 failed/errored test(s), 10418 tests executed\n*Failed tests:*\n{noformat}\nTestMsgBusConnection - did not produce a TEST-*.xml file\nTestQueryLifeTimeHook - did not produce a TEST-*.xml file\norg.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_orc_llap_counters\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_explainuser_1\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_explainuser_2\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_tez_join_hash\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/857/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/857/console\nTest logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-857/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 6 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12766760 - PreCommit-HIVE-MASTER-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-08-11T23:45:46.952+0000","updated":"2016-08-11T23:45:46.952+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/15662346","id":"15662346","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=premal","name":"premal","key":"premal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Premal Shah","active":true,"timeZone":"Etc/UTC"},"body":"[~selinazh] Is there a patch available? \n\nAfter applying the patch (https://issues.apache.org/jira/secure/attachment/12766760/HIVE-11693.1.patch), I noticed incorrect data after a left outer join.\n\nThis query returns the right number of rows\n{noformat}\nSELECT COUNT(*)\nFROM\n    account\n    LEFT JOIN contact ON contact.account_id = account.id\n;\n{noformat}\n\nBut, if I have a complex sub-query on the right, then I get 0 rows back\n{noformat}\nSELECT COUNT(*)\nFROM\n    account\n    LEFT JOIN (\n        SELECT DISTINCT\n            contact.email_domain AS email_domain,\n            contact.account_id\n        FROM\n            contact\n            JOIN (\n                SELECT\n                    account_id,\n                    COUNT(DISTINCT email_domain) AS email_domain_count\n                FROM\n                    contact\n                GROUP BY\n                    account_id\n                ) email_domain_counts\n                ON contact.account_id = email_domain_counts.account_id\n                    AND email_domain_counts.email_domain_count = 1\n        WHERE\n            contact.account_id != ''\n    ) contact ON contact.account_id = account.id\n;\n{noformat}\n\nIf, I change hive.execution.engine to mr, then it returns the number of rows in account\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=premal","name":"premal","key":"premal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Premal Shah","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-13T23:53:03.751+0000","updated":"2016-11-15T16:46:22.136+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12860624/comment/15662437","id":"15662437","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"body":"\n\nHere are the results of testing the latest attachment:\nhttps://issues.apache.org/jira/secure/attachment/12766760/HIVE-11693.1.patch\n\n{color:red}ERROR:{color} -1 due to no test(s) being added or modified.\n\n{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 10692 tests executed\n*Failed tests:*\n{noformat}\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)\norg.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)\norg.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=91)\norg.apache.hive.spark.client.TestSparkClient.testJobSubmission (batchId=272)\n{noformat}\n\nTest results: https://builds.apache.org/job/PreCommit-HIVE-Build/2103/testReport\nConsole output: https://builds.apache.org/job/PreCommit-HIVE-Build/2103/console\nTest logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2103/\n\nMessages:\n{noformat}\nExecuting org.apache.hive.ptest.execution.TestCheckPhase\nExecuting org.apache.hive.ptest.execution.PrepPhase\nExecuting org.apache.hive.ptest.execution.ExecutionPhase\nExecuting org.apache.hive.ptest.execution.ReportingPhase\nTests exited with: TestsFailedException: 4 tests failed\n{noformat}\n\nThis message is automatically generated.\n\nATTACHMENT ID: 12766760 - PreCommit-HIVE-Build","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiveqa","name":"hiveqa","key":"hiveqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hiveqa&avatarId=17060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hiveqa&avatarId=17060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hiveqa&avatarId=17060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hiveqa&avatarId=17060"},"displayName":"Hive QA","active":true,"timeZone":"America/Chicago"},"created":"2016-11-14T01:01:44.808+0000","updated":"2016-11-14T01:01:44.808+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-11693/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2jl67:"}}