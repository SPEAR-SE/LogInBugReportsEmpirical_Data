{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13144602","self":"https://issues.apache.org/jira/rest/api/2/issue/13144602","key":"HIVE-18942","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310843","id":"12310843","key":"HIVE","name":"Hive","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-03-13T13:24:42.532+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Mar 13 22:38:22 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18942/watchers","watchCount":4,"isWatching":false},"created":"2018-03-13T03:27:33.040+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340268","id":"12340268","name":"3.0.0","archived":false,"released":true,"releaseDate":"2018-05-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-13T22:38:22.992+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312584","id":"12312584","name":"Metastore","description":"Tracks issue dealing with metastore."}],"timeoriginalestimate":null,"description":"ALTER TABLE handler in HiveAlterHandler has this code:\r\n{code:java}\r\nif (isPartitionedTable) {\r\n  parts = msdb.getPartitions(newt.getDbName(), newt.getTableName(), -1);\r\n  MetaStoreListenerNotifier.notifyEvent(transactionalListeners,\r\n          EventMessage.EventType.ADD_PARTITION,\r\n          new AddPartitionEvent(newt, parts, true, handler),\r\n          environmentContext);\r\n}{code}\r\n\r\nThe problem is that table may contain huge number of partitions and the event will contain all of them. Partition object itself isn't very small either, so we may end up with huge events which would be stored and then transmitted over the wire to consumers.\r\n\r\n[~spena] [~kkalyan] [~lina.li] [~vaidyand] FYI.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ALTER TABLE may generate huge event (with all partitions)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akolb","name":"akolb","key":"akolb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Kolbasov","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144602/comment/16396929","id":"16396929","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kkalyan","name":"kkalyan","key":"kkalyan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kkalyan&avatarId=29757","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kkalyan&avatarId=29757","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kkalyan&avatarId=29757","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kkalyan&avatarId=29757"},"displayName":"kalyan kumar kalvagadda","active":true,"timeZone":"Etc/UTC"},"body":"[~akolb] That may not be the case.\r\n\r\nAddPartitionEvent that is generated here is different from the NotificationEvent that is inserted in the NOTIFICATION_LOG table.\r\n\r\n{noformat}\r\n  public void onAlterTable(AlterTableEvent tableEvent) throws MetaException {\r\n    Table before = tableEvent.getOldTable();\r\n    Table after = tableEvent.getNewTable();\r\n    NotificationEvent event =\r\n        new NotificationEvent(0, now(), EventType.ALTER_TABLE.toString(), msgFactory\r\n            .buildAlterTableMessage(before, after, tableEvent.getIsTruncateOp()).toString());\r\n    event.setDbName(after.getDbName());\r\n    event.setTableName(after.getTableName());\r\n    process(event, tableEvent);\r\n  }\r\n{noformat}\r\n \r\nThis is how later table JSON is constructed as sentry is interested in below things in the alter table notification\r\n# Old Db Name\r\n# New Db Name\r\n# Old Table Name\r\n# New Table Name\r\n# Old Location\r\n# New Location\r\n\r\n{noformat}\r\n  public JSONAlterTableMessage(String server, String servicePrincipal, Table tableObjBefore, Table tableObjAfter, Long timestamp) {\r\n    this.server = server;\r\n    this.servicePrincipal = servicePrincipal;\r\n    this.db = tableObjBefore.getDbName();\r\n    this.table = tableObjBefore.getTableName();\r\n    this.timestamp = timestamp;\r\n\r\n    try {\r\n      this.tableObjBeforeJson = JSONMessageFactory.createTableObjJson(tableObjBefore);\r\n      this.tableObjAfterJson = JSONMessageFactory.createTableObjJson(tableObjAfter);\r\n    } catch (TException var7) {\r\n      throw new IllegalArgumentException(\"Could not serialize: \", var7);\r\n    }\r\n\r\n    this.checkValid();\r\n  }\r\n{noformat}\r\n\r\n\r\nI think the NotificationEvent inserted in NOTIFICATION_LOG table may not have details of the partitions. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kkalyan","name":"kkalyan","key":"kkalyan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kkalyan&avatarId=29757","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kkalyan&avatarId=29757","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kkalyan&avatarId=29757","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kkalyan&avatarId=29757"},"displayName":"kalyan kumar kalvagadda","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-13T13:24:42.532+0000","updated":"2018-03-13T13:24:42.532+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144602/comment/16397777","id":"16397777","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=LinaAtAustin","name":"LinaAtAustin","key":"linaataustin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linaataustin&avatarId=31361","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linaataustin&avatarId=31361","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linaataustin&avatarId=31361","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linaataustin&avatarId=31361"},"displayName":"Na Li","active":true,"timeZone":"America/Chicago"},"body":"[~kkalyan] The event type is \"EventMessage.EventType.ADD_PARTITION\", not \"EventType.ALTER_TABLE\". It puts all partitions in the event.\r\n{code:java}\r\nIn DbNotificationListener\r\n\r\npublic void onAddPartition (AddPartitionEvent partitionEvent)\r\nthrows MetaException {\r\nTable t = partitionEvent.getTable();\r\nNotificationEvent event = new NotificationEvent(0, now(),\r\nHCatConstants.HCAT_ADD_PARTITION_EVENT,\r\nmsgFactory.buildAddPartitionMessage(t, partitionEvent.getPartitions()).toString());\r\nevent.setDbName(t.getDbName());\r\nevent.setTableName(t.getTableName());\r\nenqueue(event, partitionEvent);\r\n}\r\n\r\n{code}\r\nÂ ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=LinaAtAustin","name":"LinaAtAustin","key":"linaataustin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linaataustin&avatarId=31361","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linaataustin&avatarId=31361","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linaataustin&avatarId=31361","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linaataustin&avatarId=31361"},"displayName":"Na Li","active":true,"timeZone":"America/Chicago"},"created":"2018-03-13T22:34:39.839+0000","updated":"2018-03-13T22:34:39.839+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144602/comment/16397782","id":"16397782","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kkalyan","name":"kkalyan","key":"kkalyan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kkalyan&avatarId=29757","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kkalyan&avatarId=29757","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kkalyan&avatarId=29757","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kkalyan&avatarId=29757"},"displayName":"kalyan kumar kalvagadda","active":true,"timeZone":"Etc/UTC"},"body":"oh, i see. The title of the jira was misleading.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kkalyan","name":"kkalyan","key":"kkalyan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kkalyan&avatarId=29757","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kkalyan&avatarId=29757","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kkalyan&avatarId=29757","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kkalyan&avatarId=29757"},"displayName":"kalyan kumar kalvagadda","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-13T22:38:22.992+0000","updated":"2018-03-13T22:38:22.992+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HIVE-18942/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3r7o7:"}}