[[~wzheng] could you review please, patch looks good. +1, {noformat}

Test Name Duration Age
 org.apache.hadoop.hive.llap.tezplugins.TestLlapTaskSchedulerService.testDelayedLocalityNodeCommErrorImmediateAllocation	10 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_groupby8_map	1 min 5 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_bucketmapjoin_negative3	1.4 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_bucketmapjoin11	0.95 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_cbo_udf_udaf	1 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_skewjoinopt13	1.2 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_join0	0.86 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_avro_joins_native	0.74 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_stats13	0.53 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_groupby10	0.89 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_vector_cast_constant	0.83 sec	1
 org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_smb_mapjoin_14	0.9 sec	1
 org.apache.hadoop.hive.llap.daemon.impl.comparator.TestShortestJobFirstComparator.testWaitQueueComparatorWithinDagPriority	5.1 sec	2
 org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_join32	6.2 sec	3
 org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver_encryption_select_read_only_encrypted_tbl	1 min 23 sec	3
 org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver_encryption_insert_partition_dynamic	1 min 16 sec	3
 org.apache.hadoop.hive.llap.tezplugins.TestLlapTaskCommunicator.testFinishableStateUpdateFailure	2.7 sec	6
 org.apache.hadoop.hive.metastore.TestHiveMetaStorePartitionSpecs.testFetchingPartitionsWithDifferentSchemas	3 sec	7
 org.apache.hadoop.hive.metastore.TestHiveMetaStorePartitionSpecs.testAddPartitions	3 sec	7
 org.apache.hadoop.hive.metastore.TestHiveMetaStoreGetMetaConf.testGetMetaConfDefault	10 sec	8
 org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver_encryption_insert_partition_static	2 min 2 sec	9
 org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_selectindate	13 sec	13
 org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_avrocountemptytbl	10 sec	13
 org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_order_null	35 sec	13
 org.apache.hive.hcatalog.api.repl.commands.TestCommands.org.apache.hive.hcatalog.api.repl.commands.TestCommands	20 sec	13
 org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver_encryption_join_with_different_encryption_keys	1 min 49 sec	13
 org.apache.hive.minikdc.TestHiveAuthFactory.testStartTokenManagerForMemoryTokenStore	1.8 sec	13
 org.apache.hive.minikdc.TestHiveAuthFactory.testStartTokenManagerForDBTokenStore	0.38 sec	13
 org.apache.hadoop.hive.metastore.TestHiveMetaStorePartitionSpecs.testGetPartitionSpecs_WithAndWithoutPartitionGrouping	3.4 sec	13
 org.apache.hive.minikdc.TestMiniHiveKdc.testLogin	1 min 32 sec	13
 org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3	7.2 sec	13
 org.apache.hadoop.hive.cli.TestMinimrCliDriver.org.apache.hadoop.hive.cli.TestMinimrCliDriver	54 sec	13
{noformat}

test failures are not related, The fix makes Acid queries respect hive.optimize.sort.dynamic.partition setting.  In case of update/delete the query plan is not optimal (it has 2 ReduceSinks which will be addressed in a separate ticket)  but now the user has a choice of whether to use hive.optimize.sort.dynamic.partition.

thanks Wei for the review, committed to branch-1 and master, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12801997/HIVE-13646.2.patch

{color:red}ERROR:{color} -1 due to build exiting with an error

Test results: http://ec2-54-177-240-2.us-west-1.compute.amazonaws.com/job/PreCommit-HIVE-MASTER-Build/181/testReport
Console output: http://ec2-54-177-240-2.us-west-1.compute.amazonaws.com/job/PreCommit-HIVE-MASTER-Build/181/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-181/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Tests exited with: NonZeroExitCodeException
Command 'bash /data/hive-ptest/working/scratch/source-prep.sh' failed with exit status 1 and output '+ [[ -n /usr/java/jdk1.7.0_45-cloudera ]]
+ export JAVA_HOME=/usr/java/jdk1.7.0_45-cloudera
+ JAVA_HOME=/usr/java/jdk1.7.0_45-cloudera
+ export PATH=/usr/java/jdk1.7.0_45-cloudera/bin/:/usr/lib64/qt-3.3/bin:/usr/local/apache-maven-3.0.5/bin:/usr/java/jdk1.7.0_45-cloudera/bin:/usr/local/apache-ant-1.9.1/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/hiveptest/bin
+ PATH=/usr/java/jdk1.7.0_45-cloudera/bin/:/usr/lib64/qt-3.3/bin:/usr/local/apache-maven-3.0.5/bin:/usr/java/jdk1.7.0_45-cloudera/bin:/usr/local/apache-ant-1.9.1/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/hiveptest/bin
+ export 'ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m '
+ ANT_OPTS='-Xmx1g -XX:MaxPermSize=256m '
+ export 'M2_OPTS=-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128'
+ M2_OPTS='-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128'
+ cd /data/hive-ptest/working/
+ tee /data/hive-ptest/logs/PreCommit-HIVE-MASTER-Build-181/source-prep.txt
+ [[ false == \t\r\u\e ]]
+ mkdir -p maven ivy
+ [[ git = \s\v\n ]]
+ [[ git = \g\i\t ]]
+ [[ -z master ]]
+ [[ -d apache-github-source-source ]]
+ [[ ! -d apache-github-source-source/.git ]]
+ [[ ! -d apache-github-source-source ]]
+ cd apache-github-source-source
+ git fetch origin
From https://github.com/apache/hive
   a88050b..cbebb4d  master     -> origin/master
+ git reset --hard HEAD
HEAD is now at a88050b HIVE-13671: Add PerfLogger to log4j2.properties logger (Prasanth Jayachandran reviewed by Sergey Shelukhin)
+ git clean -f -d
Removing ql/src/test/queries/clientpositive/parquet_array_map_emptynullvals.q
Removing ql/src/test/results/clientpositive/parquet_array_map_emptynullvals.q.out
+ git checkout master
Already on 'master'
Your branch is behind 'origin/master' by 1 commit, and can be fast-forwarded.
+ git reset --hard origin/master
HEAD is now at cbebb4d HIVE-12837 : Better memory estimation/allocation for hybrid grace hash join during hash table loading (Wei Zheng, reviewed by Vikram Dixit K)
+ git merge --ff-only origin/master
Already up-to-date.
+ git gc
+ patchCommandPath=/data/hive-ptest/working/scratch/smart-apply-patch.sh
+ patchFilePath=/data/hive-ptest/working/scratch/build.patch
+ [[ -f /data/hive-ptest/working/scratch/build.patch ]]
+ chmod +x /data/hive-ptest/working/scratch/smart-apply-patch.sh
+ /data/hive-ptest/working/scratch/smart-apply-patch.sh /data/hive-ptest/working/scratch/build.patch
The patch does not appear to apply with p0, p1, or p2
+ exit 1
'
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12801997 - PreCommit-HIVE-MASTER-Build, Hi [~ekoifman] and [~wzheng], thanks for your work to make hive.optimize.sort.dynamic.partition compatible with ACID tables. However, it seems that extra work is needed to make them work together. After I discuss with [~prasanth_j], this problem sounds serious as we are getting wrong #rows and also wrong total data size which will result in correctness issue and also performance issue. Could you guys take a look at HIVE-13773? I have attached a t.q and a wrong t.q.out and it can be easily repro on master. If I revert the patch in this JIRA, it works fine. Thanks. also ccing [~ashutoshc].]