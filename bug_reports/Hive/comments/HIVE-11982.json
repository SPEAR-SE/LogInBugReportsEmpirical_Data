[HIVE-11333 and some other recent changes (not sure which one yet), makes prunedColLists.get(child) sometimes return null.
Will make the code to use genColLists for union opts. , Need code review., Change looks good +1,  Would it be possible to add a test to prevent it from breaking yet again?, [~szehon], I do not know how to add test. The failed tests can pass in both TestCliDriver and TestMinimrCliDriver without fix; but it will fail in both local test and cluster test if I do manually. It may relate to the sequence of generating the query plan.
With the fix, manual tests pass.  So I think, after HIVE-11333,  only genColLists can guarantee to return right prunelist for union., 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12764116/HIVE-11982.1.patch

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 9623 tests executed
*Failed tests:*
{noformat}
TestMiniTezCliDriver-vectorization_16.q-mapjoin_mapjoin.q-groupby2.q-and-12-more - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_vector_groupby_reduce
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_vector_groupby_reduce
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5465/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5465/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5465/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12764116 - PreCommit-HIVE-TRUNK-Build, The failures are not related. , Thanks Yongzhi, would still be good to take a look to see if we can add the test (the difference between local mode vs CliDriver), I believe its the settings as we discussed.  As we are moving towards the policy of needing a test for every change, and plus we don't want it be broken again as by HIVE-11333, I finally figured out the mystery of the query plan difference between unit test and local or cluster manual test:

The unit tests set hive.in.test to true through data/conf/hive-site.xml. This flag does a lot of magic, one of them is in 
static String canHandleQbForCbo(QueryProperties queryProperties, HiveConf conf,... method.
If I change the code
boolean isInTest = conf.getBoolVar(ConfVars.HIVE_IN_TEST);
to
boolean isInTest = false;

The unit test query plan will be same as manual tests. 

The problem is how to control the code in my qfile test.
I can not set hive.in.test to false in the qfile for it will throw exception on the set statement. Should we add a new property to check in canHandleQbForCbo method? (Something like NeedCheckHiveInTest and default to true?).




, That's unfortunate.  Thanks for looking, it seems we tried our best.  +1, Committed to master, thanks Yongzhi!]