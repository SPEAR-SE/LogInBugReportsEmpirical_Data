[[~rhbutani] please consider this for 0.13 release., Does the issue impact all aggregates? I have seen that count(distinct..) tests are passing, including tpcds queries., Allow for COUNT(DISTINCT expr) wich happens to work, by accident, dur to how reduce side handles the aggregate merge for COUNT(DISTINCT), +1, 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12639447/HIVE-6873.2.patch

{color:red}ERROR:{color} -1 due to 2 failed/errored test(s), 5570 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.ql.security.TestStorageBasedClientSideAuthorizationProvider.testSimplePrivileges
org.apache.hive.service.cli.thrift.TestThriftHttpCLIService.testExecuteStatementAsync
{noformat}

Test results: http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2198/testReport
Console output: http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2198/console

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 2 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12639447, Failures are unrelated to the patch, It seems to me that all aggregates are working fine. The reason is that in a query like:
select sum(distinct a) from T group by b;
The map-side aggregation treats (b, a) as the key, therefore distinct values of a are getting propagated to the reducer, and for the distinct scenario reducer only takes the key and discards the values. 
, [~jnp] From how I read GroupByOptimizer.java@227, I reckon there are some cases when the reduce side does expect the mapper to had been doing the correct aggregation:
{code}
          // Partial aggregation is not done for distincts on the mapper
          // However, if the data is bucketed/sorted on the distinct key, partial aggregation
          // can be performed on the mapper.
{code}, Here is a scenario where we get incorrect result. It shows up on sorted bucketed column with hive.map.groupby.sorted=true, and only on group by queries with no keys.

Here are the steps:

hive> Create table T(a int, b int) clustered by (a) sorted by (a) stored as orc;

load following data:
300  1
300  1
300  1
300  1
300  1

hive> set hive.map.groupby.sorted=true;

hive> select sum(distinct a) from T;  // Incorrect result.
hive> select count(distinct a) from T;  // This is also incorrect.

, The attached patch fixes the issue by disabling the optimization for sorted/bucketed columns if vectorization is on. This change impacts only the specific scenario being hit in the example above. A test is also added to reproduce the above scenario, and another test for normal distinct case., +1, +1 for 0.13, 

{color:green}Overall{color}: +1 all checks pass

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12639682/HIVE-6873.3.patch

{color:green}SUCCESS:{color} +1 5614 tests passed

Test results: http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2216/testReport
Console output: http://bigtop01.cloudera.org:8080/job/PreCommit-HIVE-Build/2216/console

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12639682, Thanks for finding the problem repro and fix!, set hive.map.groupby.sorted=true; was the missing part for meâ€¦

From: Jitendra Nath Pandey (JIRA) [mailto:jira@apache.org]
Sent: Friday, April 11, 2014 1:02 AM
To: Remus Rusanu
Subject: [jira] [Commented] (HIVE-6873) DISTINCT clause in aggregates is handled incorrectly by vectorized execution

[cid:image001.png@01CF557F.FDF58F90]

Jitendra Nath Pandey<https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jnp> commented on [Bug] HIVE-6873<https://issues.apache.org/jira/browse/HIVE-6873>




Re: DISTINCT clause in aggregates is handled incorrectly by vectorized execution<https://issues.apache.org/jira/browse/HIVE-6873>



Here is a scenario where we get incorrect result. It shows up on sorted bucketed column with hive.map.groupby.sorted=true, and only on group by queries with no keys.

Here are the steps:

hive> Create table T(a int, b int) clustered by (a) sorted by (a) stored as orc;

load following data:
300 1
300 1
300 1
300 1
300 1

hive> set hive.map.groupby.sorted=true;

hive> select sum(distinct a) from T; // Incorrect result.
hive> select count(distinct a) from T; // This is also incorrect.


[Add Comment]<https://issues.apache.org/jira/browse/HIVE-6873#add-comment>

Add Comment<https://issues.apache.org/jira/browse/HIVE-6873#add-comment>






This message was sent by Atlassian JIRA (v6.2#6252-sha1:aa34325)

[Atlassian logo]




, Committed to trunk and 0.13
Thanks Jitendra, Remus and Ashutosh]