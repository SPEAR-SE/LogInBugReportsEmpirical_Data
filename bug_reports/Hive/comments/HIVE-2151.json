[I have hit this issue too., 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/696/
-----------------------------------------------------------

Review request for hive.


Summary
-------

Too many open files in running negative cli tests


This addresses bug HIVE-2151.
    https://issues.apache.org/jira/browse/HIVE-2151


Diffs
-----

  trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java 1100117 

Diff: https://reviews.apache.org/r/696/diff


Testing
-------


Thanks,

Yongqiang

, We did an offline review and found a better fix. Yongqiang will upload a new patch soon. , 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/696/
-----------------------------------------------------------

(Updated 2011-05-06 19:17:48.260294)


Review request for hive.


Changes
-------

new diff


Summary
-------

Too many open files in running negative cli tests


This addresses bug HIVE-2151.
    https://issues.apache.org/jira/browse/HIVE-2151


Diffs (updated)
-----

  trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java 1100117 

Diff: https://reviews.apache.org/r/696/diff


Testing
-------


Thanks,

Yongqiang

, Can you update the review board with the latest patch? It's much easier to add comments.

In ZooKeeperHiveLockManager.close(), I'm not sure if the change is desired. According to the comment, it simply close the client to release transient locks. The later removeAllRedundantNodes() call may be needed after the client close to clean up further. So changing the order may results in undesired behavior. Namit, can you comment on this?

Driver.java:148, add comments wht ctx needs to set HiveLockManager. , removeAllRedundantNodes() leaks a zookeeper connection. it should be put before closing zookeeper instance because it is still using the zookeeper instance., 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/696/
-----------------------------------------------------------

(Updated 2011-05-09 17:15:15.221624)


Review request for hive.


Changes
-------

reverted the change in ZooKeeperHiveLockManager's close, but put a zookeeper close in removeReduantNodes
added more comments in Driver.


Summary
-------

Too many open files in running negative cli tests


This addresses bug HIVE-2151.
    https://issues.apache.org/jira/browse/HIVE-2151


Diffs (updated)
-----

  trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java 1101116 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/lockmgr/zookeeper/ZooKeeperHiveLockManager.java 1101116 

Diff: https://reviews.apache.org/r/696/diff


Testing
-------


Thanks,

Yongqiang

, Talked with namit offline, this new patch reverted the change in ZooKeeperHiveLockManager's close, but put a zookeeper close in removeReduantNodes.
Also added more comments in Driver to address Ning's last comments., +1. Will commit if tests pass, Yongqiang, the TestClilDriver failed (index_auto.q, etc.). It seems the change is conflict with the recent bitmap index changes. Can you take a look? , Ning, it seems the index_auto.q still fail without this patch. Can you verify?, It has been passing fine in Jenkins:

https://builds.apache.org/hudson/job/Hive-trunk-h0.20/717/
, i got a failure on a clean check out when running index_auto.q. But when i run again, the error is not there. And also after apply the patch, there is also no error. 

Ning, can you do a 'ant clean run'?, OK. I got why it failed. index_auto.q build index to /tmp/index_where. I had run the test before under root, which makes the owner of /tmp/index_where root. Running the same test using my own user will fail because of write permission. 

Going forward I think we should change all index building tests to make results under trunk/build/ rather than /tmp, so that ant clean will clean all side effects., Good catch, Ning! At least we should make sure the /tmp/xxx dir got removed at the end of the testcase, if making it use build/tmp/ is not easy to do. , Yongqiang, you can reference the build directory using '${system:build.dir.hive}', which is defined in build-common.xml. Can you open a JIRA and fix all such index tests? , Committed. Thanks Yongqiang!, Integrated in Hive-trunk-h0.20 #726 (See [https://builds.apache.org/hudson/job/Hive-trunk-h0.20/726/])
    ]