[No test attached in patch since this is an intermittent failure. The chance we hit that is relatively low (We saw 1 occurrence out of 3311)., Can we update with the affected versions for this problem?, Is there a possibility for more fine grained sync? That would add sync to every Hive.get call as far as I can tell.. Can it just assign currentMetaVars to local variable and then do checks on that?
, 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12761939/HIVE-11935.1.patch

{color:red}ERROR:{color} -1 due to 6 failed/errored test(s), 9581 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_vector_groupby_reduce
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_vector_groupby_reduce
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation
org.apache.hive.hcatalog.streaming.TestStreaming.testAddPartition
org.apache.hive.hcatalog.streaming.TestStreaming.testInterleavedTransactionBatchCommits
org.apache.hive.hcatalog.streaming.TestStreaming.testTransactionBatchAbortAndCommit
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5404/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5404/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5404/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12761939 - PreCommit-HIVE-TRUNK-Build, Ok, let's use the local copy then., 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12762426/HIVE-11935.2.patch

{color:red}ERROR:{color} -1 due to 3 failed/errored test(s), 9644 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_vector_groupby_reduce
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_vector_groupby_reduce
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5443/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5443/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5443/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12762426 - PreCommit-HIVE-TRUNK-Build, Removing fixed version (2.0) from Unresolved JIRA in preparation for the release. Please use target version field instead (if not already set) if you think this should be shipped as part of 2.0, +1, looks fine, though I wonder if the TestHCatClient failure is related.  Also, is it an issue that one thread is calling the client after another has closed it?, Yes, this is about thread synchronization. The test we saw is a concurrency test. The only reason HS2 throw the exception is isCompatibleWith and close are called by different threads and mixed temporally. The patch take Sergey's route which make a local copy of currentMetaVars. There is slight chance that close get called between check and make local copy, but chance is much smaller since we are safe in the while loop., Patch committed to master and branch-1. Thanks Alan for review!]