[The file is opened when:
Resource res = ucp.getResource(path, false);
{noformat}
URLClassLoader$1.run() line: 358 [local variables unavailable]	
URLClassLoader$1.run() line: 355	
AccessController.doPrivileged(PrivilegedExceptionAction<T>, AccessControlContext) line: not available [native method]	
URLClassLoader.findClass(String) line: 354	
URLClassLoader(ClassLoader).loadClass(String, boolean) line: 425	
URLClassLoader(ClassLoader).loadClass(String) line: 358	
Class<T>.forName0(String, boolean, ClassLoader) line: not available [native method]	
Class<T>.forName(String, boolean, ClassLoader) line: 270	
Registry.registerToSessionRegistry(String, FunctionInfo) line: 460	
Registry.getQualifiedFunctionInfo(String) line: 438	
Registry.getFunctionInfo(String) line: 250	
FunctionRegistry.getFunctionInfo(String) line: 465	
FunctionRegistry.impliesOrder(String) line: 1523	
CalcitePlanner(SemanticAnalyzer).doPhase1GetAllAggregations(ASTNode, HashMap<String,ASTNode>, List<ASTNode>) line: 526	

{noformat}


And closed by:
List<IOException> errors = ucp.closeLoaders();
{noformat}
URLClassLoader.close() line: 286 [local variables unavailable]	
JavaUtils.closeClassLoader(ClassLoader) line: 110	
JavaUtils.closeClassLoadersTo(ClassLoader, ClassLoader) line: 87	
SessionState.close() line: 1450	
HiveSessionImplwithUGI(HiveSessionImpl).close() line: 566	
HiveSessionImplwithUGI.close() line: 110	
NativeMethodAccessorImpl.invoke0(Method, Object, Object[]) line: not available [native method]	
NativeMethodAccessorImpl.invoke(Object, Object[]) line: 57	
DelegatingMethodAccessorImpl.invoke(Object, Object[]) line: 43	
Method.invoke(Object, Object...) line: 606	
HiveSessionProxy.invoke(Method, Object[]) line: 78	
HiveSessionProxy.access$000(HiveSessionProxy, Method, Object[]) line: 36	
HiveSessionProxy$1.run() line: 63	
AccessController.doPrivileged(PrivilegedExceptionAction<T>, AccessControlContext) line: not available [native method]	
Subject.doAs(Subject, PrivilegedExceptionAction<T>) line: 415	
UserGroupInformation.doAs(PrivilegedExceptionAction<T>) line: 1628	
HiveSessionProxy.invoke(Object, Method, Object[]) line: 59	
$Proxy23.close() line: not available	
SessionManager.closeSession(SessionHandle) line: 279	
CLIService.closeSession(SessionHandle) line: 237	
{noformat}

The test sometimes fails sometimes succeeds, these are java API, not sure why it has random behaviors.
, The leak will become worse if the program in a while loop: connect, query, close connection.  Any thoughts on this, [~navis]?
Thanks, If I add:       JavaUtils.closeClassLoader(loader); at the end of Registry.registerToSessionRegistry method, the leak problem is solved. Which close the loader right after use. Is that a solution? 

It seems that not all the loaders covered when JavaUtils.closeClassLoadersTo is called. Is that possible current loader has peers?

Thanks

, Need code review, In a session, there are possible several classloaders used (for example different threads used for queries), at the session close time, it may not   get all the classloaders to close them which caused the leak. Fixed it by add all the classloaders used in registerToSessionRegistry method to a set and close them at the session close time. , 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12729275/HIVE-10453.1.patch

{color:red}ERROR:{color} -1 due to 74 failed/errored test(s), 7959 tests executed
*Failed tests:*
{noformat}
TestMiniSparkOnYarnCliDriver - did not produce a TEST-*.xml file
TestMiniTezCliDriver-auto_join30.q-vector_data_types.q-filter_join_breaktask.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-auto_sortmerge_join_13.q-alter_merge_2_orc.q-insert_values_dynamic_partitioned.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-dynpart_sort_optimization2.q-tez_bmj_schema_evolution.q-orc_merge5.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-enforce_order.q-auto_join1.q-vector_decimal_2.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-orc_vectorization_ppd.q-custom_input_output_format.q-vector_groupby_reduce.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-script_pipe.q-insert_values_non_partitioned.q-subquery_in.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-tez_union2.q-unionDistinct_1.q-auto_sortmerge_join_8.q-and-8-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-update_orig_table.q-union2.q-vectorized_bucketmapjoin1.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vector_coalesce.q-auto_sortmerge_join_7.q-dynamic_partition_pruning.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vector_decimal_10_0.q-vector_decimal_trailing.q-lvj_mapjoin.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vector_decimal_round.q-cbo_windowing.q-tez_schema_evolution.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vector_distinct_2.q-load_dyn_part2.q-join1.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vector_interval_2.q-orc_merge6.q-mapreduce1.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vector_partition_diff_num_cols.q-tez_joins_explain.q-vector_decimal_aggregate.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vectorization_10.q-vector_partitioned_date_time.q-vector_non_string_partition.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vectorization_13.q-update_after_multiple_inserts.q-mapreduce2.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vectorization_16.q-mapjoin_mapjoin.q-groupby2.q-and-12-more - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vectorized_parquet.q-vector_char_mapjoin1.q-tez_insert_overwrite_local_directory_1.q-and-12-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-bucketmapjoin6.q-constprog_partitioner.q-infer_bucket_sort_dyn_part.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-external_table_with_space_in_location_path.q-infer_bucket_sort_merge.q-auto_sortmerge_join_16.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-groupby2.q-import_exported_table.q-bucketizedhiveinputformat.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-index_bitmap3.q-stats_counter_partitioned.q-temp_table_external.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-infer_bucket_sort_map_operators.q-join1.q-bucketmapjoin7.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-infer_bucket_sort_num_buckets.q-disable_merge_for_bucketing.q-uber_reduce.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-infer_bucket_sort_reducers_power_two.q-scriptfile1.q-scriptfile1_win.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-leftsemijoin_mr.q-load_hdfs_file_with_space_in_the_name.q-root_dir_external_table.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-list_bucket_dml_10.q-bucket_num_reducers.q-bucket6.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-load_fs2.q-file_with_header_footer.q-ql_rewrite_gbtoidx_cbo_1.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-parallel_orderby.q-reduce_deduplicate.q-ql_rewrite_gbtoidx_cbo_2.q-and-1-more - did not produce a TEST-*.xml file
TestMinimrCliDriver-ql_rewrite_gbtoidx.q-smb_mapjoin_8.q - did not produce a TEST-*.xml file
TestMinimrCliDriver-schemeAuthority2.q-bucket4.q-input16_cc.q-and-1-more - did not produce a TEST-*.xml file
TestSparkCliDriver-auto_join24.q-vector_decimal_aggregate.q-bucketmapjoin_negative.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-auto_join30.q-vector_data_types.q-filter_join_breaktask.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-auto_join9.q-load_dyn_part12.q-union14.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-auto_join_reordering_values.q-auto_sortmerge_join_7.q-insert1.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-avro_decimal_native.q-bucketmapjoin12.q-ppd_outer_join2.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-bucketmapjoin10.q-skewjoinopt19.q-bucketmapjoin11.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-bucketmapjoin4.q-groupby7.q-input14.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-bucketsortoptimize_insert_4.q-union_remove_15.q-union32.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-bucketsortoptimize_insert_7.q-enforce_order.q-join36.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-escape_distributeby1.q-join11.q-smb_mapjoin_10.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-groupby4.q-timestamp_null.q-auto_join23.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-groupby_complex_types.q-groupby3_map.q-vectorization_10.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-groupby_map_ppr_multi_distinct.q-table_access_keys_stats.q-union30.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-join13.q-tez_joins_explain.q-order.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-join2.q-script_pipe.q-groupby_map_ppr.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-join39.q-stats12.q-union27.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-join_cond_pushdown_unqual4.q-union_remove_1.q-mapjoin_mapjoin.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-join_rc.q-vectorized_rcfile_columnar.q-union12.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-load_dyn_part5.q-list_bucket_dml_2.q-ppd_join2.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-multigroupby_singlemr.q-union_remove_9.q-smb_mapjoin_21.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-parallel_join1.q-avro_joins.q-groupby_ppr.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-ppd_gby_join.q-stats2.q-groupby_rollup1.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-ppd_join4.q-join9.q-ppd_join3.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-ppd_transform.q-ptf_seqfile.q-join18.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-ptf_general_queries.q-skewjoin_noskew.q-ptf_rcfile.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-skewjoinopt15.q-bucketmapjoin3.q-join35.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-skewjoinopt16.q-scriptfile1.q-udf_in_file.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-skewjoinopt3.q-multi_insert_mixed.q-auto_join18.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-skewjoinopt8.q-join_cond_pushdown_3.q-groupby7_noskew.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-smb_mapjoin_15.q-auto_sortmerge_join_13.q-auto_join18_multi_distinct.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-smb_mapjoin_4.q-auto_join19.q-mapreduce1.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-stats13.q-join_casesensitive.q-join8.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-timestamp_lazy.q-date_udf.q-auto_join4.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-union_remove_7.q-skewjoin_union_remove_2.q-vectorization_13.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-union_top_level.q-bucketmapjoin_negative3.q-union_remove_23.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-vector_distinct_2.q-load_dyn_part2.q-bucketmapjoin7.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-vector_groupby_3.q-auto_sortmerge_join_4.q - did not produce a TEST-*.xml file
TestSparkCliDriver-vectorization_16.q-groupby10.q-timestamp_comparison.q-and-12-more - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_udaf_histogram_numeric
org.apache.hive.hcatalog.streaming.TestStreaming.testEndpointConnection
org.apache.hive.jdbc.TestSSL.testSSLConnectionWithProperty
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3661/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3661/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-3661/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 74 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12729275 - PreCommit-HIVE-TRUNK-Build, The spark and tez test failures are related to some classloaders used in Registry.registerToSessionRegistry method
 can be used even session is closed which is very strange. Make more changes to separate client session based classloaders from the rest. , Re-attach the second patch for the pre-commit does not run it after 4 days. , 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12730845/HIVE-10453.2.patch

{color:red}ERROR:{color} -1 due to 25 failed/errored test(s), 8900 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_authorization_parts
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver_encryption_insert_partition_dynamic
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver_encryption_insert_partition_static
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver_encryption_join_unencrypted_tbl
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver_encryption_join_with_different_encryption_keys
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver_encryption_load_data_to_encrypted_tables
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver_encryption_select_read_only_encrypted_tbl
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_disallow_transform
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_droppartition
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_sba_drop_table
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_alterpart_loc
org.apache.hadoop.hive.ql.security.TestStorageBasedClientSideAuthorizationProvider.testSimplePrivileges
org.apache.hadoop.hive.ql.security.TestStorageBasedMetastoreAuthorizationDrops.testDropDatabase
org.apache.hadoop.hive.ql.security.TestStorageBasedMetastoreAuthorizationDrops.testDropPartition
org.apache.hadoop.hive.ql.security.TestStorageBasedMetastoreAuthorizationDrops.testDropTable
org.apache.hadoop.hive.ql.security.TestStorageBasedMetastoreAuthorizationDrops.testDropView
org.apache.hadoop.hive.ql.security.TestStorageBasedMetastoreAuthorizationProvider.testSimplePrivileges
org.apache.hadoop.hive.ql.security.TestStorageBasedMetastoreAuthorizationProviderWithACL.testSimplePrivileges
org.apache.hadoop.hive.ql.security.TestStorageBasedMetastoreAuthorizationReads.testReadDbFailure
org.apache.hadoop.hive.ql.security.TestStorageBasedMetastoreAuthorizationReads.testReadDbSuccess
org.apache.hadoop.hive.ql.security.TestStorageBasedMetastoreAuthorizationReads.testReadTableFailure
org.apache.hadoop.hive.ql.security.TestStorageBasedMetastoreAuthorizationReads.testReadTableSuccess
org.apache.hadoop.hive.ql.security.authorization.plugin.sqlstd.TestSQLStdHiveAccessControllerHS2.testConfigProcessing
org.apache.hadoop.hive.ql.security.authorization.plugin.sqlstd.TestSQLStdHiveAccessControllerHS2.testConfigProcessingCustomSetWhitelistAppend
org.apache.hive.jdbc.TestJdbcWithLocalClusterSpark.testTempTable
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3780/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/3780/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-3780/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 25 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12730845 - PreCommit-HIVE-TRUNK-Build, The failures are not related to the patch:
Excepting 1 test, the rest failures aged more than 20.
I tested the new failure test in my local machine, it passed:
Running org.apache.hive.jdbc.TestJdbcWithLocalClusterSpark
Tests run: 5, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 76.162 sec - in org.apache.hive.jdbc.TestJdbcWithLocalClusterSpark

Results :

Tests run: 5, Failures: 0, Errors: 0, Skipped: 0

[~szehon], [~csun] and [~xuefuz], could you review the change? Thanks, Good catch, +1.  One minor question is 'CUDFLoader' method name a typo, or intentional?, Thanks [~szehon] for reviewing it. The CUDFLoader means classloader related to load udf jars. C means class. I am not good with names. , OK, as long as its not a typo and means something :)  No problem., Committed to trunk, thanks Yongzhi!, Thanks [~szehon], This is a good candidate for 1.2.1. I'll commit it to the branch as well. Thanks [~ychena] and [~szehon] for getting this in., Committed to 1.2.1., [~ychena] In our internal testing, we found that closing the classloader removes certain jars from the classpath, resulting in ClassNotFoundException. I'm reopening the jira and reverting the patch from the respective branches via the linked jira., I'm trying to reproduce this locally before I revert this (will add more comments on HIVE-10970). , [~ychena] I'm marking this as resolved and continuing discussion on HIVE-10970.]