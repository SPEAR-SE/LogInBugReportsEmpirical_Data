[Thanks for submitting this, Mikhail. Note that this was introduced in 0.9. In 0.7, this was not a problem ..., mbautin requested code review of "[jira] [HIVE-3772] Fix a concurrency bug in LazyBinaryUtils due to a static field (patch by Reynold Xin)".
Reviewers: ashutoshc, njain, raghotham, JIRA

  Reynold Xin's patch needed by the Shark project. https://github.com/amplab/hive/commit/17e1c3dd2f6d8eca767115dc46d5a880aed8c765
  (writeVLong should not use a static field due to concurrency concerns.)

TEST PLAN
  Unit tests

REVISION DETAIL
  https://reviews.facebook.net/D7155

AFFECTED FILES
  serde/src/java/org/apache/hadoop/hive/serde2/lazybinary/LazyBinaryUtils.java

MANAGE HERALD DIFFERENTIAL RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/16935/

To: ashutoshc, njain, raghotham, JIRA, mbautin
, Attaching trunk patch., dhruba has resigned from the revision "[jira] [HIVE-3772] Fix a concurrency bug in LazyBinaryUtils due to a static field (patch by Reynold Xin)".

REVISION DETAIL
  https://reviews.facebook.net/D7155

To: ashutoshc, njain, raghotham, JIRA, zshao, heyongqiang, nzhang, jsichi, pauly, amareshwarisr, cwsteinbach, mbautin
, zshao has requested changes to the revision "[jira] [HIVE-3772] Fix a concurrency bug in LazyBinaryUtils due to a static field (patch by Reynold Xin)".

  Please take this opportunity to fix all static variables in this file.

  By the way, a better way to fix is to use ThreadLocal.  That's more effiicient because then we don't need to call new in these low-level functions.


INLINE COMMENTS
  serde/src/java/org/apache/hadoop/hive/serde2/lazybinary/LazyBinaryUtils.java:126 Is this a problem for multi-threaded access as well?

REVISION DETAIL
  https://reviews.facebook.net/D7155

BRANCH
  HIVE-3772-static-vLongBytes

To: ashutoshc, njain, raghotham, JIRA, zshao, heyongqiang, nzhang, jsichi, pauly, amareshwarisr, cwsteinbach, mbautin
, mbautin updated the revision "[jira] [HIVE-3772] Fix a concurrency bug in LazyBinaryUtils due to a static field (patch by Reynold Xin)".
Reviewers: ashutoshc, njain, raghotham, JIRA, zshao, heyongqiang, nzhang, jsichi, pauly, amareshwarisr, cwsteinbach

  Addressing Zheng's comment by using ThreadLocal.

REVISION DETAIL
  https://reviews.facebook.net/D7155

AFFECTED FILES
  serde/src/java/org/apache/hadoop/hive/serde2/lazybinary/LazyBinaryUtils.java

To: ashutoshc, njain, raghotham, JIRA, zshao, heyongqiang, nzhang, jsichi, pauly, amareshwarisr, cwsteinbach, mbautin
, Is there any change of this get fixed in 0.11?, The patch applies cleanly to the current 0.11 branch HEAD so it seems like a good candidate for maintenance 0.11.1 release?, Looking now., I am +1. Thread local is not perfect but surely better then static., 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12597250/HIVE-3772.1.patch.txt

{color:red}ERROR:{color} -1 due to 2 failed/errored test(s), 2774 tests executed
*Failed tests:*
{noformat}
org.apache.hcatalog.mapreduce.TestHCatExternalDynamicPartitioned.testHCatDynamicPartitionedTable
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_script_broken_pipe1
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/381/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/381/console

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests failed with: TestsFailedException: 2 tests failed
{noformat}

This message is automatically generated., Committed. Thanks all., Thank you so much, Edward., Edward, any chance it can be also backported into 0.11.1 ?, FAILURE: Integrated in Hive-trunk-hadoop2-ptest #51 (See [https://builds.apache.org/job/Hive-trunk-hadoop2-ptest/51/])
HIVE-3772 Fix concurrency bug in LazyBinaryUtils due to a static field (Mikhail Bautin via egc)

Submitted by:Mikhail Bautin and Reynold Xin	
Reviewed by: Edward Capriolo	
Approved by: Edward Capriolo (ecapriolo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1512758)
* /hive/trunk/serde/src/java/org/apache/hadoop/hive/serde2/lazybinary/LazyBinaryUtils.java
, Generally in hive we do not back port we just move forward. There are not many .1 or .2 releases. , Got it, thanks for the explanation., SUCCESS: Integrated in Hive-trunk-hadoop1-ptest #122 (See [https://builds.apache.org/job/Hive-trunk-hadoop1-ptest/122/])
HIVE-3772 Fix concurrency bug in LazyBinaryUtils due to a static field (Mikhail Bautin via egc)

Submitted by:Mikhail Bautin and Reynold Xin	
Reviewed by: Edward Capriolo	
Approved by: Edward Capriolo (ecapriolo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1512758)
* /hive/trunk/serde/src/java/org/apache/hadoop/hive/serde2/lazybinary/LazyBinaryUtils.java
, ABORTED: Integrated in Hive-trunk-hadoop2 #350 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/350/])
HIVE-3772 Fix concurrency bug in LazyBinaryUtils due to a static field (Mikhail Bautin via egc)

Submitted by:Mikhail Bautin and Reynold Xin	
Reviewed by: Edward Capriolo	
Approved by: Edward Capriolo (ecapriolo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1512758)
* /hive/trunk/serde/src/java/org/apache/hadoop/hive/serde2/lazybinary/LazyBinaryUtils.java
, SUCCESS: Integrated in Hive-trunk-h0.21 #2260 (See [https://builds.apache.org/job/Hive-trunk-h0.21/2260/])
HIVE-3772 Fix concurrency bug in LazyBinaryUtils due to a static field (Mikhail Bautin via egc)

Submitted by:Mikhail Bautin and Reynold Xin	
Reviewed by: Edward Capriolo	
Approved by: Edward Capriolo (ecapriolo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1512758)
* /hive/trunk/serde/src/java/org/apache/hadoop/hive/serde2/lazybinary/LazyBinaryUtils.java
, This issue has been fixed and released as part of 0.12 release. If you find further issues, please create a new jira and link it to this one.]