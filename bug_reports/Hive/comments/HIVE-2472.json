[
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2120/
-----------------------------------------------------------

Review request for hive, Yongqiang He and Ning Zhang.


Summary
-------

(This is not needed for RC-2)

I modified StatsTask so that it could be created from a CTAS query.

The StatsTask is created where StatsTask are typically created, but instead of being appended to the final MoveTask it is stored in the QB.  This is because the SemanticAnalyzer appends the task to create the table to the task tree in order to ensure atomicity.  The StatsTask requires that the table already be created, by putting it in the QB, the SemanticAnalyzer is able to access it and append to it to the create table task.


This addresses bug HIVE-2472.
    https://issues.apache.org/jira/browse/HIVE-2472


Diffs
-----

  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1177363 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1177363 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/QB.java 1177363 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1177363 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1177363 
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1177363 
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1177363 
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1177363 
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1177363 

Diff: https://reviews.apache.org/r/2120/diff


Testing
-------

I ran a CTAS query and verified the stats appeared in the console at the end of the query, and that they were stored in the table's metadata.

I ran the unit test queries, and updated the output of the ones which use CTAS queries


Thanks,

Kevin

, 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2583/
-----------------------------------------------------------

(Updated 2011-11-03 19:46:23.842574)


Review request for Ning Zhang and Kevin Wilfong.


Summary
-------

Now table stats will be collected for CTAS queries.


This addresses bug HIVE-2472.
    https://issues.apache.org/jira/browse/HIVE-2472


Diffs
-----

  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/database.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 

Diff: https://reviews.apache.org/r/2583/diff


Testing
-------

run ant tests with overwrite option, changes to out files are part of the diff


Thanks,

Robert

, The diff for HIVE-2472.2.patch can be found at https://reviews.apache.org/r/2583/diff/#index_header (last version). , 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2583/
-----------------------------------------------------------

(Updated 2011-11-03 19:50:15.818785)


Review request for Ning Zhang and Kevin Wilfong.


Summary (updated)
-------

Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):


Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.

There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.

FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). 

Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.

Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.

Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).


I noticed that to database.q.out "Cannot get table db1.db1.conflict_name" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.


This addresses bug HIVE-2472.
    https://issues.apache.org/jira/browse/HIVE-2472


Diffs
-----

  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/database.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 

Diff: https://reviews.apache.org/r/2583/diff


Testing
-------

run ant tests with overwrite option, changes to out files are part of the diff


Thanks,

Robert

, 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2583/
-----------------------------------------------------------

(Updated 2011-11-03 20:05:20.364390)


Review request for Ning Zhang and Kevin Wilfong.


Changes
-------

In version 3 there was a missclick mistake I made in eclipse (after the out files were already generated, but before I diffed the patch). It is corrected now, please ignore 3rd version, and when looking for changes compare version 4 with version 2. 


Summary
-------

Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):


Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.

There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.

FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). 

Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.

Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.

Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).


I noticed that to database.q.out "Cannot get table db1.db1.conflict_name" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.


This addresses bug HIVE-2472.
    https://issues.apache.org/jira/browse/HIVE-2472


Diffs (updated)
-----

  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/database.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 

Diff: https://reviews.apache.org/r/2583/diff


Testing
-------

run ant tests with overwrite option, changes to out files are part of the diff


Thanks,

Robert

, 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2583/#review3089
-----------------------------------------------------------



trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java
<https://reviews.apache.org/r/2583/#comment6894>

    why do we need to check partitions.size() == 0? Isn't it the case that when a partitioned table first created and there is no partitions yet, it will satisfy this condition? 



trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java
<https://reviews.apache.org/r/2583/#comment6895>

    code style nitpick: space between 'if' and '(' 



trunk/ql/src/test/results/clientpositive/ctas.q.out
<https://reviews.apache.org/r/2583/#comment6896>

    Here I think the plan should be stage-3 (StatsTask) depends on stage-4 (DDLTask), which depends on stage-0 (MoveTask).
    
    Also can you change the .q file to add describe formatted <created_table> to verify that the stats are gathered for the newly created table after CTAS?



trunk/ql/src/test/results/clientpositive/ctas.q.out
<https://reviews.apache.org/r/2583/#comment6897>

    Same here. 


- Ning


On 2011-11-03 20:05:20, Robert Surówka wrote:
bq.  
bq.  -----------------------------------------------------------
bq.  This is an automatically generated e-mail. To reply, visit:
bq.  https://reviews.apache.org/r/2583/
bq.  -----------------------------------------------------------
bq.  
bq.  (Updated 2011-11-03 20:05:20)
bq.  
bq.  
bq.  Review request for Ning Zhang and Kevin Wilfong.
bq.  
bq.  
bq.  Summary
bq.  -------
bq.  
bq.  Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):
bq.  
bq.  
bq.  Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.
bq.  
bq.  There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.
bq.  
bq.  FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). 
bq.  
bq.  Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.
bq.  
bq.  Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.
bq.  
bq.  Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).
bq.  
bq.  
bq.  I noticed that to database.q.out "Cannot get table db1.db1.conflict_name" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.
bq.  
bq.  
bq.  This addresses bug HIVE-2472.
bq.      https://issues.apache.org/jira/browse/HIVE-2472
bq.  
bq.  
bq.  Diffs
bq.  -----
bq.  
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 
bq.    trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 
bq.    trunk/ql/src/test/results/clientpositive/database.q.out 1196269 
bq.    trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 
bq.    trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 
bq.    trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 
bq.  
bq.  Diff: https://reviews.apache.org/r/2583/diff
bq.  
bq.  
bq.  Testing
bq.  -------
bq.  
bq.  run ant tests with overwrite option, changes to out files are part of the diff
bq.  
bq.  
bq.  Thanks,
bq.  
bq.  Robert
bq.  
bq.

, 

bq.  On 2011-11-07 22:24:59, Ning Zhang wrote:
bq.  >

Actually after CTAS the partitions collection wasn't null, whereas it was just empty (I also commented on it near the end of the diff description). I will do all other changes requested ASAP, thank you. 


- Robert


-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2583/#review3089
-----------------------------------------------------------


On 2011-11-03 20:05:20, Robert Surówka wrote:
bq.  
bq.  -----------------------------------------------------------
bq.  This is an automatically generated e-mail. To reply, visit:
bq.  https://reviews.apache.org/r/2583/
bq.  -----------------------------------------------------------
bq.  
bq.  (Updated 2011-11-03 20:05:20)
bq.  
bq.  
bq.  Review request for Ning Zhang and Kevin Wilfong.
bq.  
bq.  
bq.  Summary
bq.  -------
bq.  
bq.  Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):
bq.  
bq.  
bq.  Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.
bq.  
bq.  There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.
bq.  
bq.  FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). 
bq.  
bq.  Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.
bq.  
bq.  Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.
bq.  
bq.  Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).
bq.  
bq.  
bq.  I noticed that to database.q.out "Cannot get table db1.db1.conflict_name" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.
bq.  
bq.  
bq.  This addresses bug HIVE-2472.
bq.      https://issues.apache.org/jira/browse/HIVE-2472
bq.  
bq.  
bq.  Diffs
bq.  -----
bq.  
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1196269 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1196269 
bq.    trunk/ql/src/test/results/clientpositive/ctas.q.out 1196269 
bq.    trunk/ql/src/test/results/clientpositive/database.q.out 1196269 
bq.    trunk/ql/src/test/results/clientpositive/merge3.q.out 1196269 
bq.    trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1196269 
bq.    trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1196269 
bq.  
bq.  Diff: https://reviews.apache.org/r/2583/diff
bq.  
bq.  
bq.  Testing
bq.  -------
bq.  
bq.  run ant tests with overwrite option, changes to out files are part of the diff
bq.  
bq.  
bq.  Thanks,
bq.  
bq.  Robert
bq.  
bq.

, 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2583/
-----------------------------------------------------------

(Updated 2011-11-08 04:08:52.506156)


Review request for Ning Zhang and Kevin Wilfong.


Changes
-------

I implemented all the change requests (hopefully), with one exception that I already commented about.


Summary
-------

Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):


Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.

There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.

FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). 

Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.

Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.

Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).


I noticed that to database.q.out "Cannot get table db1.db1.conflict_name" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.


This addresses bug HIVE-2472.
    https://issues.apache.org/jira/browse/HIVE-2472


Diffs (updated)
-----

  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 
  trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 
  trunk/ql/src/test/results/clientpositive/database.q.out 1199067 
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 

Diff: https://reviews.apache.org/r/2583/diff


Testing
-------

run ant tests with overwrite option, changes to out files are part of the diff


Thanks,

Robert

, 

bq.  On 2011-11-07 22:24:59, Ning Zhang wrote:
bq.  > trunk/ql/src/test/results/clientpositive/ctas.q.out, line 25
bq.  > <https://reviews.apache.org/r/2583/diff/4/?file=56200#file56200line25>
bq.  >
bq.  >     Here I think the plan should be stage-3 (StatsTask) depends on stage-4 (DDLTask), which depends on stage-0 (MoveTask).
bq.  >     
bq.  >     Also can you change the .q file to add describe formatted <created_table> to verify that the stats are gathered for the newly created table after CTAS?

Change to amend this was done in Semantic Analyzer around line 7050


- Robert


-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2583/#review3089
-----------------------------------------------------------


On 2011-11-08 04:08:52, Robert Surówka wrote:
bq.  
bq.  -----------------------------------------------------------
bq.  This is an automatically generated e-mail. To reply, visit:
bq.  https://reviews.apache.org/r/2583/
bq.  -----------------------------------------------------------
bq.  
bq.  (Updated 2011-11-08 04:08:52)
bq.  
bq.  
bq.  Review request for Ning Zhang and Kevin Wilfong.
bq.  
bq.  
bq.  Summary
bq.  -------
bq.  
bq.  Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):
bq.  
bq.  
bq.  Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.
bq.  
bq.  There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.
bq.  
bq.  FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). 
bq.  
bq.  Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.
bq.  
bq.  Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.
bq.  
bq.  Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).
bq.  
bq.  
bq.  I noticed that to database.q.out "Cannot get table db1.db1.conflict_name" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.
bq.  
bq.  
bq.  This addresses bug HIVE-2472.
bq.      https://issues.apache.org/jira/browse/HIVE-2472
bq.  
bq.  
bq.  Diffs
bq.  -----
bq.  
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 
bq.    trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 
bq.    trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/database.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 
bq.  
bq.  Diff: https://reviews.apache.org/r/2583/diff
bq.  
bq.  
bq.  Testing
bq.  -------
bq.  
bq.  run ant tests with overwrite option, changes to out files are part of the diff
bq.  
bq.  
bq.  Thanks,
bq.  
bq.  Robert
bq.  
bq.

, 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2583/#review3124
-----------------------------------------------------------



trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java
<https://reviews.apache.org/r/2583/#comment6939>

    style nitpick: removing tab.



trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java
<https://reviews.apache.org/r/2583/#comment6959>

    here, rather than checkin partitions.size()==0, I think it's better to change getPartitionList() to return null when it is CTAS (i.e., getLoadFileDesc() != null). 



trunk/ql/src/test/results/clientpositive/database.q.out
<https://reviews.apache.org/r/2583/#comment6958>

    I suspect this is caused by the change in SemanticAnalyzer.java around line 7906. Can you test if this is caused by that change? If so you'll need to resolve this rather than updating the .out file. 



trunk/ql/src/test/results/clientpositive/merge3.q.out
<https://reviews.apache.org/r/2583/#comment6960>

    here stage-2 should only depends on stage-6.
    
    also please add 'desc formatted <tbl>' to verify the stats are correct.



trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out
<https://reviews.apache.org/r/2583/#comment6961>

    same: stage-2 should only depends on stage-4.


- Ning


On 2011-11-08 04:08:52, Robert Surówka wrote:
bq.  
bq.  -----------------------------------------------------------
bq.  This is an automatically generated e-mail. To reply, visit:
bq.  https://reviews.apache.org/r/2583/
bq.  -----------------------------------------------------------
bq.  
bq.  (Updated 2011-11-08 04:08:52)
bq.  
bq.  
bq.  Review request for Ning Zhang and Kevin Wilfong.
bq.  
bq.  
bq.  Summary
bq.  -------
bq.  
bq.  Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):
bq.  
bq.  
bq.  Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.
bq.  
bq.  There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.
bq.  
bq.  FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). 
bq.  
bq.  Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.
bq.  
bq.  Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.
bq.  
bq.  Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).
bq.  
bq.  
bq.  I noticed that to database.q.out "Cannot get table db1.db1.conflict_name" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.
bq.  
bq.  
bq.  This addresses bug HIVE-2472.
bq.      https://issues.apache.org/jira/browse/HIVE-2472
bq.  
bq.  
bq.  Diffs
bq.  -----
bq.  
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 
bq.    trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 
bq.    trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/database.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 
bq.  
bq.  Diff: https://reviews.apache.org/r/2583/diff
bq.  
bq.  
bq.  Testing
bq.  -------
bq.  
bq.  run ant tests with overwrite option, changes to out files are part of the diff
bq.  
bq.  
bq.  Thanks,
bq.  
bq.  Robert
bq.  
bq.

, 

bq.  On 2011-11-10 06:52:08, Ning Zhang wrote:
bq.  >

This code is not a part of this patch!


bq.  On 2011-11-10 06:52:08, Ning Zhang wrote:
bq.  > trunk/ql/src/test/results/clientpositive/database.q.out, line 1224
bq.  > <https://reviews.apache.org/r/2583/diff/5/?file=56835#file56835line1224>
bq.  >
bq.  >     I suspect this is caused by the change in SemanticAnalyzer.java around line 7906. Can you test if this is caused by that change? If so you'll need to resolve this rather than updating the .out file.

I strongly doubt it, as no other code in Hive except the one I added myself, knows that db name is being stored there. Yet I will check it. 


bq.  On 2011-11-10 06:52:08, Ning Zhang wrote:
bq.  > trunk/ql/src/test/results/clientpositive/merge3.q.out, line 60
bq.  > <https://reviews.apache.org/r/2583/diff/5/?file=56836#file56836line60>
bq.  >
bq.  >     here stage-2 should only depends on stage-6.
bq.  >     
bq.  >     also please add 'desc formatted <tbl>' to verify the stats are correct.

I will investigate this in the following one, it is actually quite strange (possibly generating out file failed), thank you. 


- Robert


-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2583/#review3124
-----------------------------------------------------------


On 2011-11-08 04:08:52, Robert Surówka wrote:
bq.  
bq.  -----------------------------------------------------------
bq.  This is an automatically generated e-mail. To reply, visit:
bq.  https://reviews.apache.org/r/2583/
bq.  -----------------------------------------------------------
bq.  
bq.  (Updated 2011-11-08 04:08:52)
bq.  
bq.  
bq.  Review request for Ning Zhang and Kevin Wilfong.
bq.  
bq.  
bq.  Summary
bq.  -------
bq.  
bq.  Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):
bq.  
bq.  
bq.  Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.
bq.  
bq.  There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.
bq.  
bq.  FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). 
bq.  
bq.  Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.
bq.  
bq.  Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.
bq.  
bq.  Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).
bq.  
bq.  
bq.  I noticed that to database.q.out "Cannot get table db1.db1.conflict_name" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.
bq.  
bq.  
bq.  This addresses bug HIVE-2472.
bq.      https://issues.apache.org/jira/browse/HIVE-2472
bq.  
bq.  
bq.  Diffs
bq.  -----
bq.  
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1199067 
bq.    trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1199067 
bq.    trunk/ql/src/test/queries/clientpositive/ctas.q 1199067 
bq.    trunk/ql/src/test/results/clientpositive/ctas.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/database.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/merge3.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1199067 
bq.    trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1199067 
bq.  
bq.  Diff: https://reviews.apache.org/r/2583/diff
bq.  
bq.  
bq.  Testing
bq.  -------
bq.  
bq.  run ant tests with overwrite option, changes to out files are part of the diff
bq.  
bq.  
bq.  Thanks,
bq.  
bq.  Robert
bq.  
bq.

, 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2583/
-----------------------------------------------------------

(Updated 2011-11-10 23:34:41.924906)


Review request for Ning Zhang and Kevin Wilfong.


Changes
-------

Hopefully all the earlier mentioned problems have been amended. Actually there was a bug in my code that caused "Cannot get table db1.db1.conflict_name" to happen, it's solved by change in LoadFileDesc.java around line 45.


Summary
-------

Explanation of how stats for CTAS were added (line numbers may be slightly off due to repository changes):


Because CTAS contains an INSERT, the approach was to reuse as much, from what is already there for INSERT, as possible.

There were 2 main issues: to make sure that FileSinkOperators will gather stats, and that there will be StatsTask that will then aggregate them and store to Metastore.

FileSinkOperator gathers stats if conf.isGatherStats (line 576) is true. It is set to true upon adding StatsTask in GenMRFileSink1 (126) which will happen if isInsertTable will be true, which is set in 105 (I didn't change comment since it is still being set due to INSERT OVERWRITE that is just a part of the CTAS). To make it true, one must set that CTAS contains insert into the table, add the TableSpec, which was done in SemanticAnalyzer (1051) (BaseSemanticAnalyzer tableSpec() must had been changed to support TOK_CREATETABLE). 

Next issue, was to supply to StatsWork (part of StatsTask) information about the table being created. To do that, database name was added to CreateTableDesc, and it is set in SemanticAnalyzer (7878). Then this CreateTableDesc is added to LoadFileDesc (just to get table info) in SemanticAnalyzer(4000), which then is added to StatsWork in GenMRFileFileSink1 (170). This StatskWork is later used by StatsTask to get the table info.

Another thing was that StatsTask would be called before the CreateTableTask. To remedy that, a change in SemanticAnalyzer(7048) was made, so for CTAS the StatsTask will be moved to be after the crtTblTask.

Finally in StatsTask, support for the LoadFileDesc was added (which is present for CTAS). Importantly, line 306 was changed, since for CTAS there was an empty partitionList, instead of null (this last change took me around 3 hours to find, since this was last place I looked at, when figuring what's wrong).


I noticed that to database.q.out "Cannot get table db1.db1.conflict_name" in line 1224 was added, but it wasn't present there in previous diff version that contained exactly same Java code, so I assume it is due to some other work happening concurrently.


This addresses bug HIVE-2472.
    https://issues.apache.org/jira/browse/HIVE-2472


Diffs (updated)
-----

  trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java 1200588 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java 1200588 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java 1200588 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1200588 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java 1200588 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java 1200588 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java 1200588 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java 1200588 
  trunk/ql/src/test/queries/clientpositive/ctas.q 1200588 
  trunk/ql/src/test/queries/clientpositive/merge3.q 1200588 
  trunk/ql/src/test/results/clientpositive/ctas.q.out 1200588 
  trunk/ql/src/test/results/clientpositive/database.q.out 1200588 
  trunk/ql/src/test/results/clientpositive/merge3.q.out 1200588 
  trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out 1200588 
  trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out 1200588 

Diff: https://reviews.apache.org/r/2583/diff


Testing
-------

run ant tests with overwrite option, changes to out files are part of the diff


Thanks,

Robert

, +1., Committed. Thanks Robert and Kevin!, Integrated in Hive-trunk-h0.21 #1076 (See [https://builds.apache.org/job/Hive-trunk-h0.21/1076/])
    HIVE-2472. Metastore statistics are not being updated for CTAS queries. (Robert Surowka via Ning Zhang)

nzhang : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1200744
Files : 
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/StatsTask.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/CreateTableDesc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/LoadFileDesc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PlanUtils.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/StatsWork.java
* /hive/trunk/ql/src/test/queries/clientpositive/ctas.q
* /hive/trunk/ql/src/test/queries/clientpositive/merge3.q
* /hive/trunk/ql/src/test/results/clientpositive/ctas.q.out
* /hive/trunk/ql/src/test/results/clientpositive/database.q.out
* /hive/trunk/ql/src/test/results/clientpositive/merge3.q.out
* /hive/trunk/ql/src/test/results/clientpositive/rcfile_createas1.q.out
* /hive/trunk/ql/src/test/results/clientpositive/smb_mapjoin9.q.out
]