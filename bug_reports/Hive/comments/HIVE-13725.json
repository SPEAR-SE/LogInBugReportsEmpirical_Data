[Would it make sense to make a thread safe metastore client generally available? 
The "out of sequence response" issue keeps showing up periodically as new code is being added.  
Something like https://docs.oracle.com/javase/7/docs/api/java/util/Collections.html#synchronizedList(java.util.List)

, [~ekoifman] Agree. Will take that into consideration in my patch., We run into this problem when having multiple streaming destinations with their own connection and batches.  We get this error while heartbeating some transactions while committing a batch.  Why should separate batches require thread safety?  , [~vgumashta], I am removing 2.1.0 as target because the RC will be created tomorrow. Please feel free to commit to branch-2.1 anyway and fix for 2.1.0 if this happens before the release, or let me know if this is a Blocker. Thanks, [~dedels] It's basically a bug in the implementation.  You create a HiveEndPoint, from which you create a StreamingConnection, from which you create TransactionBatch.  There is a single IMetaStoreClient in the StreamingConnection which is shared among all TransactionBatches created from it and IMetaStoreClient is not thread safe., [~vgumashta] should this be Patch Available?  For some reason I don't see Submit Patch button in this ticket?!, [~ekoifman] Sorry should've done that before. Just made it patch available, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12809484/HIVE-13725.1.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10223 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_auto_mult_tables_compact
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_constprog_partitioner
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/94/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/94/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-94/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12809484 - PreCommit-HIVE-MASTER-Build, Test failures look unrelated. [~ekoifman] / [~wzheng] can you review?, [~vgumashta] is it feasible to add a test here?
More importantly, this is not a generally available thread safe metastore client.  Using proxy is probably a perf overhead which makes sense if you are creating a general purpose client

If this is specifically for use by HiveEndPoint it seems like making a custom client that will do simple delegation (with sychronized wrapper) is more appropriate since this only uses 4-5 methods.  Something like DbTxnManager.SynchronizedMetaStoreClient, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12812006/HIVE-13725.2.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 6 failed/errored test(s), 10250 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_constantPropagateForSubQuery
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3
org.apache.hive.jdbc.TestJdbcWithMiniLlap.testLlapInputFormatEndToEnd
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/197/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/197/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-197/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12812006 - PreCommit-HIVE-MASTER-Build, TransactionBatchImpl has "this.heartbeaterMSClient = msClient;"  this looks wrong

In DbTxnManager, instead of 
bq. private static int heartbeaterMSClientCount = 0;
bq. private static Object heartBeaterClientCountLock = new Object();

can heartbeaterMSClientCount be AtomicInteger?

I also think that doing "LOG.warn("The number of hearbeater metastore client has ex..." from synchronized block is suboptimal.
I would also modify the message to include both current client count and thread count.  I think it would be more useful.
, [~vgumashta] please look at addendum.txt.  Could you incorporate it into your next patch?  It adds a test and fixes exception propagation in Heartbeater., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12813561/HIVE-13725.5.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 10255 tests executed
*Failed tests:*
{noformat}
TestMiniTezCliDriver-vectorization_13.q-tez_bmj_schema_evolution.q-schema_evol_text_nonvec_mapwork_part_all_primitive.q-and-12-more - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/270/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/270/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-270/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12813561 - PreCommit-HIVE-MASTER-Build, Test failures are unrelated., +1, Committed to master and branch-1. Thanks for reviewing [~ekoifman]., [~jcamachorodriguez] Can this be committed to the 2.1 branch? It's an important fix and will be good to have in the next 2.1 maint release., Pushed to 2.1.1, Go ahead! Thanks]