[i will take a look now, Cool. Thanks Chinna! Just a suggestions, I think reverting the change in HIVE-2145 and make a deeper investigation of why it threw NPE in the test case of HIVE-2145 and fix that seems to be a better solution. , SemanticAnalyzer.genReduceSinkPlan() added a function validation check for orderby and sortby in the same flow clusterby also executing so it is throwing execption for the clusterby also.

Orderby and Sortby wont support the functions so need to add the function validation check. 
Now validation check is modified like it should check only for the orderby and sortby.

Patch is uploaded and testcases are executing, 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2479/
-----------------------------------------------------------

Review request for hive and Ning Zhang.


Summary
-------

SemanticAnalyzer.genReduceSinkPlan() added a function validation check for orderby and sortby in the same flow clusterby also executing so it is throwing execption for the clusterby also.

Orderby and Sortby wont support the functions so need to add the function validation check. 
Now validation check is modified like it should check only for the orderby and sortby.


This addresses bug HIVE-2512.
    https://issues.apache.org/jira/browse/HIVE-2512


Diffs
-----

  trunk/ql/src/test/results/clientnegative/sortby_function.q.out PRE-CREATION 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ErrorMsg.java 1186306 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java 1186306 
  trunk/ql/src/test/queries/clientnegative/orderby_function.q 1186306 
  trunk/ql/src/test/queries/clientnegative/sortby_function.q PRE-CREATION 
  trunk/ql/src/test/results/clientnegative/orderby_function.q.out 1186306 

Diff: https://reviews.apache.org/r/2479/diff


Testing
-------

All unit tests passed


Thanks,

chinna

, Chinna, I think the point for this JIRA is to allow functions in the orderby/sortby/clusterby, not just disallow them in some use cases found useful. In fact, we can find use cases for using functions in all orderby/osrtby/clusterby, and MySQL allows putting functions in the orderby clause for example.

So in order to fix this, I think we should examine what the root cause that HIVE-2145 gives NPE and fix that by still allowing functions in these clauses. The description of HIVE-2145 is misleading (in terms of suggested solutions), I've fixed that. Does this make sense?, when i am analysing the HIVE-2145 i have verified the sql syntax it is not allowing functions for orderby/sortby so i have added a function check validation. I did't verify the mysql use cases. With this impression i have analyzed HIVE-2512.

I will check the MySQL use cases...Thanks, Chinna, the Hive wiki may only say it requires column names, but I think the syntax Hive.q may allow functions in orderby/sortby. 

At the same time, would you mind upload a patch to revert HIVE-2145 first? Without reverting it, it breaks backward compatibility and have introduced some problems in our production. , First i will upload patch to revert HIVE-2145.  sorry for the inconvenience., HIVE-2512.1.patch uploaded by reverting HIVE-2145, +1. Thanks for the quick response Chinna. , Integrated in Hive-trunk-h0.21 #1032 (See [https://builds.apache.org/job/Hive-trunk-h0.21/1032/])
    HIVE-2512. After HIVE-2145, Hive disallow any use of function in cluster-by clause (Chinna Rao Lalam via Ning Zhang)

nzhang : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1188473
Files : 
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ErrorMsg.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
* /hive/trunk/ql/src/test/queries/clientnegative/orderby_function.q
* /hive/trunk/ql/src/test/results/clientnegative/orderby_function.q.out
, select key, count(1) cnt from src group by key order by count(1) limit 10;

Here order by is requested with the aggregate function in execution flow of this query in org.apache.hadoop.hive.ql.parse.TypeCheckProcFactory.DefaultExprProcessor.getXpathOrFuncExprNodeDesc(ASTNode, boolean, ArrayList<ExprNodeDesc>, TypeCheckCtx) while constructing ExprNodeGenericFuncDesc it is expecting GenericUDF() but here it is requested with aggregate function so it is returning null and it is throwing NullPointerException

So before constructing ExprNodeGenericFuncDesc added a check if it is UDAF throw exception

And it should work with below queries ,

select key,min(key) from src group by key having min(key) > 100;
select key,min(key) as mininum from src group by key order by mininum;, 
-----------------------------------------------------------
This is an automatically generated e-mail. To reply, visit:
https://reviews.apache.org/r/2479/
-----------------------------------------------------------

(Updated 2011-11-08 16:03:21.111741)


Review request for hive and Ning Zhang.


Changes
-------

select key, count(1) cnt from src group by key order by count(1) limit 10;

Here order by is requested with the aggregate function in execution flow of this query in org.apache.hadoop.hive.ql.parse.TypeCheckProcFactory.DefaultExprProcessor.getXpathOrFuncExprNodeDesc(ASTNode, boolean, ArrayList<ExprNodeDesc>, TypeCheckCtx) while constructing ExprNodeGenericFuncDesc it is expecting GenericUDF() but here it is requested with aggregate function so it is returning null and it is throwing NullPointerException

So before constructing ExprNodeGenericFuncDesc added a check if it is UDAF throw exception

And it should work with below queries ,

select key,min(key) from src group by key having min(key) > 100;
select key,min(key) as mininum from src group by key order by mininum;


Summary
-------

SemanticAnalyzer.genReduceSinkPlan() added a function validation check for orderby and sortby in the same flow clusterby also executing so it is throwing execption for the clusterby also.

Orderby and Sortby wont support the functions so need to add the function validation check. 
Now validation check is modified like it should check only for the orderby and sortby.


This addresses bug HIVE-2512.
    https://issues.apache.org/jira/browse/HIVE-2512


Diffs (updated)
-----

  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ErrorMsg.java 1198626 
  trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java 1198626 
  trunk/ql/src/test/queries/clientnegative/orderby_function.q PRE-CREATION 
  trunk/ql/src/test/queries/clientnegative/orderby_function1.q PRE-CREATION 
  trunk/ql/src/test/queries/clientnegative/orderby_function2.q PRE-CREATION 
  trunk/ql/src/test/queries/clientnegative/sortby_function.q PRE-CREATION 
  trunk/ql/src/test/queries/clientpositive/orderby_function.q PRE-CREATION 
  trunk/ql/src/test/results/clientnegative/orderby_function.q.out PRE-CREATION 
  trunk/ql/src/test/results/clientnegative/orderby_function1.q.out PRE-CREATION 
  trunk/ql/src/test/results/clientnegative/orderby_function2.q.out PRE-CREATION 
  trunk/ql/src/test/results/clientnegative/sortby_function.q.out PRE-CREATION 
  trunk/ql/src/test/results/clientpositive/orderby_function.q.out PRE-CREATION 

Diff: https://reviews.apache.org/r/2479/diff


Testing
-------

All unit tests passed


Thanks,

chinna

, This is an old one. What is the status here? Has this been superseded by something else or is the bug still existing? I suspect we will need to rebase. Is it still worth it to anyone?, Please open new jira, still it is a problem on master.]