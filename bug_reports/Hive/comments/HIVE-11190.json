[GitHub user sundapeng opened a pull request:

    https://github.com/apache/hive/pull/45

    HIVE-11190: ConfVars.METASTORE_FILTER_HOOK in authorization V2 should not be hard code when the value is not default

    ConfVars.METASTORE_FILTER_HOOK in authorization V2 should not be hard code when the value is not default

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/sundapeng/hive HIVE-11190

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/hive/pull/45.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #45
    
----
commit db87e59f6e1b213bfea9b6e84c056716c20210d5
Author: Sun Dapeng <sdp@apache.org>
Date:   2015-07-07T05:49:26Z

    HIVE-11190: ConfVars.METASTORE_FILTER_HOOK in authorization V2 should not be hard code when the value is not default

----
, [~dapengsun], thanks for your patch. LGTM for the patch. 
[~thejas], do you have any further comments on this patch?, [~dapengsun] When V2 authorization mode is used, the HiveAuthorizer.filterListCmdObjects is expected to be called by authorization implementations. 
The SessionState.setAuthorizerV2Config call sets up the config so that things work appropriately for V2 authorization, and it includes this change.
My concern is that if user might set this field to a custom value without ensuring that the HiveAuthorizer  call also gets made.

What is the use case you have in mind ? Are you using sql standard authorization in this case or another custom V2 authorization implementation ? Would it work to move the logic from your custom filter hook to HiveAuthorizer.filterListCmdObjects implementation ?
, A nit -
       conf.get(ConfVars.METASTORE_FILTER_HOOK.name(), ConfVars.METASTORE_FILTER_HOOK.getDefaultValue())
can be replaced with equivalent, and more readable form supported by HiveConf -
conf.getVar(ConfVars.METASTORE_FILTER_HOOK), [~Ferd] Thanks for bringing this to my attention. Really appreciate it. (Its hard to keep track with volume of changes in hive!)
, Hi [~thejas], thank you for your comments. I think it's not a good practice to override METASTORE_FILTER_HOOK by hard code. In a conservative  way, we may provide the user a warning in the log or description to warn this property is overrided in the run time. 
Any thoughts?, Hi [~thejas] 
{quote}
What is the use case you have in mind ? Are you using sql standard authorization in this case or another custom V2 authorization implementation ? Would it work to move the logic from your custom filter hook to HiveAuthorizer.filterListCmdObjects implementation ?
{quote}
Yes, I'm using {{another custom V2 authorization implementation}}, I think it's good suggestion to move the logic to HiveAuthorizer.filterListCmdObjects implementation. 
Hi [~Ferd]
{quote}
 I think it's not a good practice to override METASTORE_FILTER_HOOK by hard code. In a conservative way, we may provide the user a warning in the log or description to warn this property is overrided in the run time. 
{quote}
This is a good suggestion, I'm agreed with you. 

, Hi [~thejas], if you are also agreed with [~Ferd], I would rename the title of jira and work on the patch., Hi [~thejas]
About {{AuthorizationMetaStoreFilterHook}}, I found {{commandString}} didn't set to HiveAuthzContext. Is it an issue? do you think I should open a ticket to fix it?
https://github.com/apache/hive/blob/29af41c7822789b178416a6b416fb87e75deda78/ql/src/java/org/apache/hadoop/hive/ql/security/authorization/plugin/AuthorizationMetaStoreFilterHook.java#L77, I agree , it makes sense to update the description of the config param to say that it is overridden with another value when authorization V2 is used. 
Also, log a warning if user had set it to a non default value.

bq. About AuthorizationMetaStoreFilterHook, I found commandString didn't set to HiveAuthzContext. Is it an issue? do you think I should open a ticket to fix it?
For calls that lead to the HiveAuthorizer.filterListCmdObjects , there will be a call made to checkPrivileges as well, that call would have the command string as well. I am not sure if there is a good way to get the commandstring in AuthorizationMetaStoreFilterHook call (with current interface). 
, 

{color:green}Overall{color}: +1 all checks pass

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12744398/HIVE-11190.002.patch

{color:green}SUCCESS:{color} +1 9138 tests passed

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4552/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4552/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-4552/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12744398 - PreCommit-HIVE-TRUNK-Build, [~dapengsun] Thanks for the patch, this makes it much better. Can you also make following changes while you are at it ? - 
 # replace  the use of the string  "org.apache.hadoop.hive.ql.security.authorization.plugin.AuthorizationMetaStoreFilterHook" with AuthorizationMetaStoreFilterHook.class.getName() ? (less chances of typos happening).
 # update the description of ConfVars.METASTORE_FILTER_HOOK to say that it gets overridden when V2 auth is used ?

, Thank you for your comments, [~thejas] . 
{quote}
replace the use of the string "org.apache.hadoop.hive.ql.security.authorization.plugin.AuthorizationMetaStoreFilterHook" with AuthorizationMetaStoreFilterHook.class.getName() ? (less chances of typos happening).
{quote}
Good suggestion. I will update it in next patch.
{quote}
update the description of ConfVars.METASTORE_FILTER_HOOK to say that it gets overridden when V2 auth is used ?
{quote}
The description of {{ConfVars.METASTORE_FILTER_HOOK}} is "If hive.security.authorization.manager is set to instance of HiveAuthorizerFactory, then this value is ignored.". Do you think it still need to update?, I didn't realize the config description already said that. So, no change required there.
, Update patch according [~thejas] 's comments., 

{color:green}Overall{color}: +1 all checks pass

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12744639/HIVE-11190.003.patch

{color:green}SUCCESS:{color} +1 9150 tests passed

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4569/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4569/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-4569/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12744639 - PreCommit-HIVE-TRUNK-Build, +1, Committed to the branch-1 and master. Thanks [~thejas] for your review and [~dapengsun] for the patch., Thank [~thejas] and [~Ferd] for your review., Github user sundapeng closed the pull request at:

    https://github.com/apache/hive/pull/45
]