[RB might help
{noformat}
+        CancellableCleanerCallable queryCleanerTask = pendingQueryCleanerTasks.get(queryIdentifier);
+        if (queryCleanerTask != null) {
+          boolean cancelled = queryCleanerTask.cancel();
+          if (!cancelled) {
+            throw new IOException("Unable to cancel pending query cleanup for " + queryIdentifier);
{noformat}
what it completes just before we try to cancel?

, Whoops, forgot to add RB link:  https://reviews.apache.org/r/48886/, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12811479/HIVE-14052.1.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 12 failed/errored test(s), 10235 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_constantPropagateForSubQuery
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_repair
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3
org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_table_nonprintable
org.apache.hadoop.hive.llap.tezplugins.TestLlapTaskSchedulerService.testDelayedLocalityNodeCommErrorImmediateAllocation
org.apache.hadoop.hive.ql.metadata.TestHiveMetaStoreChecker.testPartitionsCheck
org.apache.hadoop.hive.ql.metadata.TestHiveMetaStoreChecker.testTableCheck
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/176/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/176/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-176/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 12 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12811479 - PreCommit-HIVE-MASTER-Build, [~sershe] [~sseth] review?
For you question about if the cleanup completes just before trying to cancel, yeah I guess the cancel would fail (as well as the submit).
Couple options here:
- Just allow the cancel (and the fragment submission) to fail. Hopefully this is not a common case.
- Add a DONE state here and have cancel() succeed if the cleanup is already done, Why should cancel and esp. submit fail? I was referring to that as more of a thread safety issue than logic issue. I will take a look some time this week., [~sseth] [~sershe] can you take a look?, Attaching an updated patch which does the following.

- Avoids local dir creation in case of external services
- Attempts to cleanup structures on fragment completion.
- Queues some cleanup for a later point.

Note: One side affect could be overwritten log files (If new fragments show up after a minute of the last known fragment completing).

[~jdere], [~sershe] - could you please take a look. , Is it possible to post an RB?
Also just wondering, why does external submission be handled differently, cannot external client make the same calls at Tez AM? , 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12868367/HIVE-14052.02.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10717 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[materialized_view_create_rewrite] (batchId=236)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[table_nonprintable] (batchId=140)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=144)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_3] (batchId=97)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3] (batchId=97)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/5287/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/5287/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-5287/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12868367 - PreCommit-HIVE-Build, Review Board link., bq. Also just wondering, why does external submission be handled differently, cannot external client make the same calls at Tez AM?
Mainly because there's no central system which can come in and inform daemons when a query completes. (Some of this could potentially be done for the regular flow as well). 
Additional enhancements are required to detect when an AM goes down. This will likely be via ZK at some point. Will need to re-visit this at that point, to see if external clients can use the same process., Updated patch., I think this looks good .. [~sershe] any other comments?, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12868614/HIVE-14052.04.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10730 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[table_nonprintable] (batchId=140)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[columnstats_part_coltype] (batchId=156)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=144)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_3] (batchId=97)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3] (batchId=97)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/5315/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/5315/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-5315/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12868614 - PreCommit-HIVE-Build, Is creating a new app ID from scratch necessary? I'm not sure which comment below it refers to. Wouldn't there be 3 app IDs per app (instead of 3 before) now?
, An AppId needs to be created (required for a bunch of processing). We also need a hive queryId, which is a string. The appId was being used as this unique identifier. However, it wasn't being used everywhere, which resulted in multiple log files. The patch moves the AppId creation further up, and uses it in the config so that a single log file is created.
Same as a regular query - 2 appIds. One for the query, one for LLAP itself., Hmm.. makes sense. I thought there were now 2 create calls per query. +1
, Thanks. Committing., Hive 3.0.0 has been released so closing this jira.]