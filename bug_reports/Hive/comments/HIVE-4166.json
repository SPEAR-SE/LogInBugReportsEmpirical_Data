[[~cdrome] If are using the trunk, you might want to try enabling the impersonation via hive.server2.enable.impersonation instead of hive.server2.enable.doAs. The impersonation in that case is handled at the HiveSession level instead of thrift processor level.
, Initial patch that fixes this failure. Will continue to test., [~prasadm] thanks for the comment. We are working with a patched version of 0.10, but I will keep this in mind.

The original code assumed it was okay to close all FileSystem resources at the end of each call to process, with HiveServer2 this assumption no longer holds. So it should be fixed to ensure that doAs works properly or doAs should be deprecated in favor of impersonation., Fixed patch., Updated trunk patch., Updated patch., Fixes the problem in HiveServer2 which causes certain operations to fail by closing the FileSystem when the connection is closed., For the record, I was able to stress-test a version of this code and verify that we're not leaking FileSystem instances. So we know that the fix for HIVE-3098 isn't undone here. This fix now works for HS2 and HCatalog., Argh. This patch has gone stale. I'll get a rebased version of this shortly.]