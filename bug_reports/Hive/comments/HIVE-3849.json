[navis requested code review of "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".
Reviewers: JIRA

  Verifying HIVE-3847, I've found an exception is thrown before meeting the error situation described in it. Something like,

  FAILED: SemanticException [Error 10025]: Line 40:6 Expression not in GROUP BY key 'crit5'

TEST PLAN
  EMPTY

REVISION DETAIL
  https://reviews.facebook.net/D7713

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/ErrorMsg.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/DDLTask.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/Hive.g
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/CreateViewDesc.java
  ql/src/test/queries/clientnegative/alter_view_as_select_not_exist.q
  ql/src/test/queries/clientnegative/alter_view_as_select_with_partition.q
  ql/src/test/queries/clientpositive/alter_view_as_select.q
  ql/src/test/queries/clientpositive/groupby_multi_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_mutli_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q
  ql/src/test/results/clientnegative/alter_view_as_select_not_exist.q.out
  ql/src/test/results/clientnegative/alter_view_as_select_with_partition.q.out
  ql/src/test/results/clientnegative/create_or_replace_view1.q.out
  ql/src/test/results/clientnegative/create_or_replace_view2.q.out
  ql/src/test/results/clientnegative/create_or_replace_view3.q.out
  ql/src/test/results/clientpositive/alter_view_as_select.q.out
  ql/src/test/results/clientpositive/create_view.q.out
  ql/src/test/results/clientpositive/groupby_multi_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_mutli_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_multi_single_reducer3.q.out

MANAGE HERALD DIFFERENTIAL RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/18501/

To: JIRA, navis
, navis updated the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".
Reviewers: JIRA

  rebased to trunk


REVISION DETAIL
  https://reviews.facebook.net/D7713

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
  ql/src/test/queries/clientpositive/groupby_multi_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_mutli_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q
  ql/src/test/results/clientpositive/groupby_multi_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_mutli_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_multi_single_reducer3.q.out

To: JIRA, navis
, Passed all tests, comments on phabricator, njain has commented on the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

INLINE COMMENTS
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q:50 Do you need to have mapjoin hint in the query ?

  I am trying to remove support for mapjoin hint whenever possible.
  https://issues.apache.org/jira/browse/HIVE-3784,

  and this test may not work.

  Even if it does, do you need a map-join hint.

REVISION DETAIL
  https://reviews.facebook.net/D7713

To: JIRA, navis
Cc: njain
, navis has commented on the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

INLINE COMMENTS
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q:50 It's reported query as not working from HIVE-2791 and too complicated for me to simplify. I'll look into this more.

REVISION DETAIL
  https://reviews.facebook.net/D7713

To: JIRA, navis
Cc: njain
, navis updated the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".
Reviewers: JIRA

  Removed MapJoin hint from test case


REVISION DETAIL
  https://reviews.facebook.net/D7713

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
  ql/src/test/queries/clientpositive/groupby_multi_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_mutli_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q
  ql/src/test/results/clientpositive/groupby_multi_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_mutli_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_multi_single_reducer3.q.out

To: JIRA, navis
Cc: njain
, comments on phabricator, njain has commented on the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

INLINE COMMENTS
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q:5 Why not have the same test with hive.optimize.ppd set to true also ?
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q:7 Can you add a test where there is an expression on the where clause ?

  from src
  insert overwrite table e1
  select value, count(*)
  where src.key + src.key = 100 or src.key + 7 = 207 or src.key = 300
  group by value
  .....


REVISION DETAIL
  https://reviews.facebook.net/D7713

To: JIRA, navis
Cc: njain
, navis updated the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".
Reviewers: JIRA

  Addressed comments


REVISION DETAIL
  https://reviews.facebook.net/D7713

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
  ql/src/test/queries/clientpositive/groupby_multi_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_mutli_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q
  ql/src/test/results/clientpositive/groupby_multi_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_mutli_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_multi_single_reducer3.q.out

To: JIRA, navis
Cc: njain
, +1 Running tests., All the tests passed except groupby_multi_single_reducer3.q Navis can you take a look., HIVE-3699 changed test result. Fixed that., navis updated the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".
Reviewers: JIRA

  Fixed test result which is affected by HIVE-3699


REVISION DETAIL
  https://reviews.facebook.net/D7713

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
  ql/src/test/queries/clientpositive/groupby_multi_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_mutli_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q
  ql/src/test/results/clientpositive/groupby_multi_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_mutli_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_multi_single_reducer3.q.out

To: JIRA, navis
Cc: njain
, njain has commented on the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:8704 Can you fix the comments ?
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:8654 Can you add some comments for this function ?
  Detailed comments would really help in maintaining it in the long term.
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:3571 Either change the name of the function or add a lot of comments.
  You are not removing from keys, from removing keys from the mapping passed in.

  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:3540 Add some comments here.

  Some of the expressions are already passed in the reduce Keys - they need not be
  passed again in the values. A example query would really help.




REVISION DETAIL
  https://reviews.facebook.net/D7713

To: JIRA, navis
Cc: njain
, minor comments, [~navis] Lets try to get this in. Would you like to address Namit's comments?, navis has commented on the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:3540 I've seen it's booked on other issue.
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:3571 added comments.
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:8654 added comments.
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:8704 fiexed.

REVISION DETAIL
  https://reviews.facebook.net/D7713

To: JIRA, navis
Cc: njain
, navis updated the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".
Reviewers: JIRA

  Addressed comments


REVISION DETAIL
  https://reviews.facebook.net/D7713

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
  ql/src/test/queries/clientpositive/groupby_multi_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_mutli_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q
  ql/src/test/results/clientpositive/groupby_multi_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_mutli_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_multi_single_reducer3.q.out

To: JIRA, navis
Cc: njain
, Thanks Navis for update. [~namit] would you like to take a look?, Yes, let me take a look, comments, njain has commented on the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:3537 Do you think it would be easier to change genAllExprNodeDesc to return
  Map<ASTNode, ExprNodeDesc> ?

  It might involve a change in TypeCheckProcFactory, but it will make it
  much more readable.
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:3548 nit: formatting
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:3569 Can you add correct comments for this function ?

  The predicates will be removed from mapping if they are passed in keys
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q:8 It might be a good idea to add a test where the grouping key is present in
  the where clause.

REVISION DETAIL
  https://reviews.facebook.net/D7713

To: JIRA, navis
Cc: njain
, navis updated the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

  For addressing comment, I've generified some important entities and found it's affeting many classes.
  @namit; I think this is not what you expected, or is it?

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D7713

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D7713?vs=26973&id=27243#toc

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/exec/Operator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/Task.java
  ql/src/java/org/apache/hadoop/hive/ql/index/IndexPredicateAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/DefaultGraphWalker.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/DefaultRuleDispatcher.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/Dispatcher.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/GraphWalker.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/Node.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/NodeProcessor.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/PreOrderWalker.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/Rule.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/RuleExactMatch.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/RuleRegExp.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/TaskGraphWalker.java
  ql/src/java/org/apache/hadoop/hive/ql/lib/Utils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractBucketJoinProc.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/BucketMapJoinOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPruner.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRFileSink1.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMROperator.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRRedSink1.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRRedSink2.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRRedSink3.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRTableScan1.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMRUnion1.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GroupByOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/MapJoinFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/MapJoinProcessor.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/PrunerExpressionOperatorFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/PrunerOperatorFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ReduceSinkDeDuplication.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/SamplePruner.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/SkewJoinOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/SortedMergeBucketMapJoinOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/index/RewriteCanApplyCtx.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/index/RewriteCanApplyProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/index/RewriteQueryUsingAggregateIndex.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/index/RewriteQueryUsingAggregateIndexCtx.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/lineage/ExprProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/lineage/OpProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrOpProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/BucketingSortingOpProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/CommonJoinResolver.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/LocalMapJoinProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/MapJoinResolver.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/MetadataOnlyOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/SkewJoinProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/SkewJoinResolver.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/index/IndexWhereProcessor.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/physical/index/IndexWhereTaskDispatcher.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/unionproc/UnionProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/ASTNode.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/BaseSemanticAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/DDLSemanticAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/PrintOpTreeProcessor.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/TableAccessAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/ExprNodeDesc.java
  ql/src/java/org/apache/hadoop/hive/ql/ppd/ExprWalkerProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/ppd/OpProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/ppd/PredicateTransitivePropagate.java
  ql/src/java/org/apache/hadoop/hive/ql/tools/LineageInfo.java
  ql/src/test/queries/clientpositive/groupby_multi_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_mutli_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q
  ql/src/test/results/clientpositive/groupby_multi_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_mutli_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_multi_single_reducer3.q.out

To: JIRA, navis
Cc: njain
, This is touching up on way too many files. I think we should do this refactoring in another jira., navis has commented on the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:3537 done.
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:3548 ok.
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java:3569 done.
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q:8 ah, got it.

REVISION DETAIL
  https://reviews.facebook.net/D7713

To: JIRA, navis
Cc: njain
, navis updated the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

  Addressed comments and rebased to trunk

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D7713

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D7713?vs=27243&id=28815#toc

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
  ql/src/test/queries/clientpositive/groupby_multi_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_mutli_insert_common_distinct.q
  ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q
  ql/src/test/results/clientpositive/groupby_multi_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_mutli_insert_common_distinct.q.out
  ql/src/test/results/clientpositive/groupby_multi_single_reducer3.q.out

To: JIRA, navis
Cc: njain
, njain has commented on the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

  I will take a look

REVISION DETAIL
  https://reviews.facebook.net/D7713

To: JIRA, navis
Cc: njain
, njain has accepted the revision "HIVE-3849 [jira] Columns are not extracted for multi-groupby single reducer case somtimes".

REVISION DETAIL
  https://reviews.facebook.net/D7713

BRANCH
  DPAL-1948

ARCANIST PROJECT
  hive

To: JIRA, njain, navis
Cc: njain
, Committed. Thanks Navis, Integrated in Hive-trunk-hadoop2 #138 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/138/])
    HIVE-3849 Aliased column in where clause for multi-groupby single reducer cannot
be resolved (Navis via namit) (Revision 1451259)

     Result = FAILURE
namit : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1451259
Files : 
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/TypeCheckProcFactory.java
* /hive/trunk/ql/src/test/queries/clientpositive/groupby_multi_insert_common_distinct.q
* /hive/trunk/ql/src/test/queries/clientpositive/groupby_multi_single_reducer3.q
* /hive/trunk/ql/src/test/queries/clientpositive/groupby_mutli_insert_common_distinct.q
* /hive/trunk/ql/src/test/results/clientpositive/groupby_multi_insert_common_distinct.q.out
* /hive/trunk/ql/src/test/results/clientpositive/groupby_multi_single_reducer3.q.out
* /hive/trunk/ql/src/test/results/clientpositive/groupby_mutli_insert_common_distinct.q.out
]