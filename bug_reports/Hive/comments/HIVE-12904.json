[[~sseth] any insight?, I removed the obviously unnecessary synchronized methods, and removed the callbacks in FST from the scope of the lock, just for kicks (it looks to me like it should be valid). [~sseth] can you review?, [~sershe] - Looked at this briefly. The synchronization on TaskWrapper is primarily for visibility. I don't think it can be removed like this - moving to AtomicBooleans would help. Looking more., What visibility? boolean read or write are both atomic. Synchronized doesn't do anything unless there's some really unobvious logic that is supposed to serialize all operations that read this field externally with all the operations on this object (not that it would change much, the same thing on the other object will just happen later. Or deadlock), There's no guarantees on booleans written to and read from different threads., Updated patch to use atomic booleans. This also adds a missing re-order to the queue. There's a small window after insertion into the queue and registration for callbacks during which the queue may not be re-ordered. Ideally, the callback registration should happen before addition to the queue - that bit I'd take up separately since there's an explicit comment in the code mentioning otherwise. [~sershe] - please take a look. , Synchronizing on "this" is a bad pattern, if someone decides to synchronize on this object externally it will cause perf issues. Otherwise +1, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12783723/HIVE-12904.2.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 10011 tests executed
*Failed tests:*
{noformat}
TestHWISessionManager - did not produce a TEST-*.xml file
TestMiniTezCliDriver-vector_distinct_2.q-load_dyn_part2.q-join1.q-and-12-more - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6708/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6708/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-6708/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12783723 - PreCommit-HIVE-TRUNK-Build, Updated patch with synchronized(this) changed to a ReentrantLock, and a debug log line. Will commit once jenkins gets back., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12784079/HIVE-12904.3.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 3 failed/errored test(s), 10029 tests executed
*Failed tests:*
{noformat}
TestHWISessionManager - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6728/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/6728/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-6728/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12784079 - PreCommit-HIVE-TRUNK-Build, +1, Tested several runs on a multi node cluster with concurrency 16 and 32, without any problems. Committing shortly.]