[[~szehon] Could you please review the patch? Looks like the patch is relying on the initial count being 1. In my local run of the unit tests, the initial count for OPEN_CONNECTIONS was ZERO, where as on the jenkins machine, the initial count appears to be 2. 

The test shouldnt care as much what the initial count was, we only want to ensure that the count moves up or down when new clients connect/disconnect. Let me know if this makes sense. Thanks, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12819700/HIVE-14313.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 10342 tests executed
*Failed tests:*
{noformat}
TestMsgBusConnection - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/616/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/616/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-616/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12819700 - PreCommit-HIVE-MASTER-Build, This fix seems to have addressed the testConnections failure from the earlier builds. The other failures are not related to the fix. , +1, sorry for the delay.

Curious did you happen to know initial count is not consistent?  I hadnt had a chance to look at that., the old build logs are gone .. so its hard to know when this started failing.

I was just comparing the message from the test failure from local runs to the pre-commits runs. In my local run I got
org.junit.ComparisonFailure: expected:<[1]> but was:<[0]>

I havent taken a deep look into the cause either but it just made sense that the metrics test did not rely on the initial count. , OK ideally it would be consistent but it seems like some test issue.  Committed to master to fix the test, thanks for contribution.]