[In particular, we are having difficulty managing vector scratch columns in VectorizationContext and invoking vector expressions outside of that class seems problematic., FYI [~teddy.choi] [~gopalv], [~mmccline], Thanks for your findings.

if((length(name) > 10), CAST( name AS BINARY), null) (type: binary)

Here we set “((length(name)) >10)” as conditional expr1,”CAST(name) AS BINARY” as else expr2.
 *  HIVE-17139 calculate the conditional expr1 firstly and then calculate the satisfied else expr2 and skip non-satisfied expr2. Here the else expr2 is the BytesColumnVector and the initial value of the vector array is null. So if we skip the expr2, the final value of vector is still null.
 * For VectorUDFAdaptor class, it gets the expression result of batch in row mode in setResult method. For the skipped expr2, the value of vector is null. So the VectorUDFAdaptor #setResult method causes the NPE.
 * [~mmccline] If the genericUDF is GenericUDFIf, whether we should only get the satisfied expression value in setResult method to avoid the unnecessary operation. I will upload the patch later. Thanks., [~mmccline] Here is my update in VectorUDFAdaptor#setResult method, which only get the satisfied value of else expression and skip the non-satisfied expression if the genericUDF is GenericUDFIF. And the qtest in my local env is passed. Please help me review. Thanks.
{code:java}
if ((GenericUDFIf.class.getName()).equals(genericUDF.getUdfName()) && cf != null) {
deferredChildren[0] = argDescs[0].getDeferredJavaObject(i, b, 0, writers);
try{
Object condition = deferredChildren[0].get();
if ( condition != null && ((BooleanObjectInspector) childrenOIs[0]).get(condition)){
deferredChildren[1] = argDescs[1].getDeferredJavaObject(i, b, 1, writers);
} else {
deferredChildren[2] = argDescs[2].getDeferredJavaObject(i, b, 2, writers);
}
} catch (HiveException e){
e.printStackTrace();
}
} else {
// get arguments
for (int j = 0; j < argDescs.length; j++) {
deferredChildren[j] = argDescs[j].getDeferredJavaObject(i, b, j, writers);
}
}
{code}
 , Given how many of our big queries are failing I'd like to revert now and then go back to the drawing board so I can spend some time reviewing at what you are up to with the whole change and make sure we add more comprehensive Java unit tests and Q file tests., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
|| || || || {color:brown} Prechecks {color} ||
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  0m  0s{color} | {color:blue} Findbugs executables are not available. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  1s{color} | {color:green} The patch does not contain any @author tags. {color} |
|| || || || {color:brown} master Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  1m 33s{color} | {color:blue} Maven dependency ordering for branch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  5m 51s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  6m 37s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  2m 39s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  6m 59s{color} | {color:green} master passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 22s{color} | {color:blue} Maven dependency ordering for patch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m 58s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  5m 50s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  5m 50s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  0m 39s{color} | {color:red} ql: The patch generated 4 new + 39 unchanged - 10 fixed = 43 total (was 49) {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  1m 42s{color} | {color:red} root: The patch generated 4 new + 39 unchanged - 10 fixed = 43 total (was 49) {color} |
| {color:red}-1{color} | {color:red} whitespace {color} | {color:red}  0m  0s{color} | {color:red} The patch 2 line(s) with tabs. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  6m  7s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:red}-1{color} | {color:red} asflicense {color} | {color:red}  0m 11s{color} | {color:red} The patch generated 6 ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 45m 56s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Optional Tests |  asflicense  javac  javadoc  findbugs  checkstyle  compile  |
| uname | Linux hiveptest-server-upstream 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /data/hiveptest/working/yetus/dev-support/hive-personality.sh |
| git revision | master / 905d84e |
| Default Java | 1.8.0_111 |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-8860/yetus/diff-checkstyle-ql.txt |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-8860/yetus/diff-checkstyle-root.txt |
| whitespace | http://104.198.109.242/logs//PreCommit-HIVE-Build-8860/yetus/whitespace-tabs.txt |
| asflicense | http://104.198.109.242/logs//PreCommit-HIVE-Build-8860/yetus/patch-asflicense-problems.txt |
| modules | C: ql . itests U: . |
| Console output | http://104.198.109.242/logs//PreCommit-HIVE-Build-8860/yetus.txt |
| Powered by | Apache Yetus    http://yetus.apache.org |


This message was automatically generated.

, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12907759/HIVE-18524.01.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 28 failed/errored test(s), 11810 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestAccumuloCliDriver.testCliDriver[accumulo_queries] (batchId=240)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_sortmerge_join_2] (batchId=49)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[mapjoin_hook] (batchId=13)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[ppd_join5] (batchId=36)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[row__id] (batchId=78)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_udf_adaptor_1] (batchId=89)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_move_tbl] (batchId=175)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[llap_smb] (batchId=152)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver (batchId=162)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[bucket_map_join_tez1] (batchId=172)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=167)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[llap_acid] (batchId=171)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[llap_acid_fast] (batchId=161)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[resourceplan] (batchId=164)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[sysdb] (batchId=161)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vectorization_input_format_excludes] (batchId=163)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[ppd_join5] (batchId=122)
org.apache.hadoop.hive.cli.TestSparkPerfCliDriver.testCliDriver[query39] (batchId=250)
org.apache.hadoop.hive.cli.TestTezPerfCliDriver.testCliDriver[query64] (batchId=248)
org.apache.hadoop.hive.cli.control.TestDanglingQOuts.checkDanglingQOut (batchId=221)
org.apache.hadoop.hive.metastore.TestReplChangeManager.testRecycleNonPartTable (batchId=223)
org.apache.hadoop.hive.ql.exec.TestOperators.testNoConditionalTaskSizeForLlap (batchId=282)
org.apache.hadoop.hive.ql.exec.vector.expressions.TestVectorConditionalExpressions.testDoubleColumnColumnIfExpr (batchId=283)
org.apache.hadoop.hive.ql.io.TestDruidRecordWriter.testWrite (batchId=256)
org.apache.hive.beeline.cli.TestHiveCli.testNoErrorDB (batchId=188)
org.apache.hive.jdbc.TestSSL.testConnectionMismatch (batchId=234)
org.apache.hive.jdbc.TestSSL.testConnectionWrongCertCN (batchId=234)
org.apache.hive.jdbc.TestSSL.testMetastoreConnectionWrongCertCN (batchId=234)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/8860/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/8860/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-8860/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.YetusPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 28 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12907759 - PreCommit-HIVE-Build, Failures for

testCliDriver's vector_udf_adaptor_1 and

org.apache.hadoop.hive.ql.exec.vector.expressions.TestVectorConditionalExpressions.testDoubleColumnColumnIfExpr seems related, | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
|| || || || {color:brown} Prechecks {color} ||
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  0m  0s{color} | {color:blue} Findbugs executables are not available. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
|| || || || {color:brown} master Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  1m 35s{color} | {color:blue} Maven dependency ordering for branch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  5m 39s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  5m 30s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  2m 22s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  6m 14s{color} | {color:green} master passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 21s{color} | {color:blue} Maven dependency ordering for patch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m 42s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  5m 42s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  5m 42s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  0m 36s{color} | {color:red} ql: The patch generated 4 new + 39 unchanged - 10 fixed = 43 total (was 49) {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  1m 44s{color} | {color:red} root: The patch generated 4 new + 39 unchanged - 10 fixed = 43 total (was 49) {color} |
| {color:red}-1{color} | {color:red} whitespace {color} | {color:red}  0m  0s{color} | {color:red} The patch 2 line(s) with tabs. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  6m 24s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:red}-1{color} | {color:red} asflicense {color} | {color:red}  0m 11s{color} | {color:red} The patch generated 6 ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 43m 25s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Optional Tests |  asflicense  javac  javadoc  findbugs  checkstyle  compile  |
| uname | Linux hiveptest-server-upstream 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /data/hiveptest/working/yetus/dev-support/hive-personality.sh |
| git revision | master / 905d84e |
| Default Java | 1.8.0_111 |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-8865/yetus/diff-checkstyle-ql.txt |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-8865/yetus/diff-checkstyle-root.txt |
| whitespace | http://104.198.109.242/logs//PreCommit-HIVE-Build-8865/yetus/whitespace-tabs.txt |
| asflicense | http://104.198.109.242/logs//PreCommit-HIVE-Build-8865/yetus/patch-asflicense-problems.txt |
| modules | C: ql . itests U: . |
| Console output | http://104.198.109.242/logs//PreCommit-HIVE-Build-8865/yetus.txt |
| Powered by | Apache Yetus    http://yetus.apache.org |


This message was automatically generated.

, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12907759/HIVE-18524.01.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 25 failed/errored test(s), 11824 tests executed
*Failed tests:*
{noformat}
TestMiniLlapCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=148)
	[mapreduce2.q,orc_llap_counters1.q,bucket6.q,insert_into1.q,empty_dir_in_table.q,orc_merge1.q,parquet_types_vectorization.q,orc_merge_diff_fs.q,llap_stats.q,llapdecider.q,load_hdfs_file_with_space_in_the_name.q,llap_nullscan.q,orc_ppd_basic.q,rcfile_merge4.q,orc_merge3.q]
org.apache.hadoop.hive.cli.TestAccumuloCliDriver.testCliDriver[accumulo_queries] (batchId=240)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[mapjoin_hook] (batchId=13)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[ppd_join5] (batchId=36)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[row__id] (batchId=78)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_udf_adaptor_1] (batchId=89)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_move_tbl] (batchId=175)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[llap_smb] (batchId=152)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[bucket_map_join_tez1] (batchId=172)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=167)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[llap_acid] (batchId=171)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[llap_acid_fast] (batchId=161)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[resourceplan] (batchId=164)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[sysdb] (batchId=161)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vectorization_input_format_excludes] (batchId=163)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[ppd_join5] (batchId=122)
org.apache.hadoop.hive.cli.control.TestDanglingQOuts.checkDanglingQOut (batchId=221)
org.apache.hadoop.hive.ql.exec.TestOperators.testNoConditionalTaskSizeForLlap (batchId=282)
org.apache.hadoop.hive.ql.exec.vector.expressions.TestVectorConditionalExpressions.testDoubleColumnColumnIfExpr (batchId=283)
org.apache.hadoop.hive.ql.io.TestDruidRecordWriter.testWrite (batchId=256)
org.apache.hadoop.hive.ql.parse.TestUpdateDeleteSemanticAnalyzer.testUpdateAllNonPartitionedWhere (batchId=275)
org.apache.hive.beeline.cli.TestHiveCli.testNoErrorDB (batchId=188)
org.apache.hive.jdbc.TestSSL.testConnectionMismatch (batchId=234)
org.apache.hive.jdbc.TestSSL.testConnectionWrongCertCN (batchId=234)
org.apache.hive.jdbc.TestSSL.testMetastoreConnectionWrongCertCN (batchId=234)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/8865/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/8865/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-8865/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.YetusPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 25 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12907759 - PreCommit-HIVE-Build, | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
|| || || || {color:brown} Prechecks {color} ||
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  0m  0s{color} | {color:blue} Findbugs executables are not available. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
|| || || || {color:brown} master Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  1m 27s{color} | {color:blue} Maven dependency ordering for branch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  5m 29s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  5m 16s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  2m 10s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  5m 52s{color} | {color:green} master passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 17s{color} | {color:blue} Maven dependency ordering for patch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m 29s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  5m 20s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  5m 20s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  0m 35s{color} | {color:red} ql: The patch generated 4 new + 39 unchanged - 10 fixed = 43 total (was 49) {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  1m 33s{color} | {color:red} root: The patch generated 4 new + 39 unchanged - 10 fixed = 43 total (was 49) {color} |
| {color:red}-1{color} | {color:red} whitespace {color} | {color:red}  0m  0s{color} | {color:red} The patch 2 line(s) with tabs. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  6m 22s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:red}-1{color} | {color:red} asflicense {color} | {color:red}  0m 12s{color} | {color:red} The patch generated 6 ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 41m 22s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Optional Tests |  asflicense  javac  javadoc  findbugs  checkstyle  compile  |
| uname | Linux hiveptest-server-upstream 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /data/hiveptest/working/yetus/dev-support/hive-personality.sh |
| git revision | master / 68e7a34 |
| Default Java | 1.8.0_111 |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-8893/yetus/diff-checkstyle-ql.txt |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-8893/yetus/diff-checkstyle-root.txt |
| whitespace | http://104.198.109.242/logs//PreCommit-HIVE-Build-8893/yetus/whitespace-tabs.txt |
| asflicense | http://104.198.109.242/logs//PreCommit-HIVE-Build-8893/yetus/patch-asflicense-problems.txt |
| modules | C: ql . itests U: . |
| Console output | http://104.198.109.242/logs//PreCommit-HIVE-Build-8893/yetus.txt |
| Powered by | Apache Yetus    http://yetus.apache.org |


This message was automatically generated.

, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12908019/HIVE-18524.02.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 22 failed/errored test(s), 12631 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestAccumuloCliDriver.testCliDriver[accumulo_queries] (batchId=240)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[ppd_join5] (batchId=36)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[row__id] (batchId=78)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_move_tbl] (batchId=175)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[bucket_map_join_tez1] (batchId=172)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=167)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[llap_acid] (batchId=171)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[llap_acid_fast] (batchId=161)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[mergejoin] (batchId=166)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[resourceplan] (batchId=164)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[sysdb] (batchId=161)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vectorization_input_format_excludes] (batchId=163)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[ppd_join5] (batchId=122)
org.apache.hadoop.hive.cli.control.TestDanglingQOuts.checkDanglingQOut (batchId=221)
org.apache.hadoop.hive.metastore.client.TestListPartitions.testListPartitionsByValuesNoTblName[Embedded] (batchId=207)
org.apache.hadoop.hive.metastore.client.TestTablesGetExists.testGetAllTablesCaseInsensitive[Embedded] (batchId=207)
org.apache.hadoop.hive.ql.exec.TestOperators.testNoConditionalTaskSizeForLlap (batchId=282)
org.apache.hadoop.hive.ql.io.TestDruidRecordWriter.testWrite (batchId=256)
org.apache.hive.beeline.cli.TestHiveCli.testNoErrorDB (batchId=188)
org.apache.hive.jdbc.TestSSL.testConnectionMismatch (batchId=234)
org.apache.hive.jdbc.TestSSL.testConnectionWrongCertCN (batchId=234)
org.apache.hive.jdbc.TestSSL.testMetastoreConnectionWrongCertCN (batchId=234)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/8893/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/8893/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-8893/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.YetusPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 22 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12908019 - PreCommit-HIVE-Build, 1 day test failures are unrelated., Committed to master., [~mmccline]: Can you help to review HIVE-17139? Thanks for your help!, # Before we add any more vectorization features like this one I'd like to see a better testing framework.  HIVE-18622 was a huge fix to many vector expressions that were handling NULLs incorrectly.  In particular, IfExprColumnNull and IfExprNullColumn had bugs.  By better framework, I like to see all the different UDFs generated with expressions for both row- and vector- and have data will NULLs generated and driven through those expressions and the results compared.  I think a framework like this would have found the bug that resulted in the revert.  And, also would have found many of the problems fixed by HIVE-18622.
 # Vector expressions need to be created in the VectorizationContext class and not as a special case in VectorUDFAdaptor.  VectorizationContext instantiates vector expressions so they have proper TypeInfo and can be displayed with EXPLAIN VECTORIZATION.
 # What I don't understand is why an IF expr with computed THEN and/or ELSE values isn't just another vector expression.  I may be missing something.  I certainly see it is more sophisticated in that you want to avoid executing any THEN expressions whose IF expr row value is false and similarly avoid executing any ELSE expressions whose IF expr is true.
 # Usually, rather than add special cases to existing vector expressions we use GenVectorCode to generate with templates new class variations.  We try to avoid complicated base classes that have lots of decision logic.  That was my impression when I read the code a while ago.  I could be wrong but even though it may seem redudant we generally have vectorization code variation just focus on the specific variation they are executing., Currently, we have:

vector.expressions:
{noformat}
IfExprColumnNull
IfExprNullColumn
IfExprNullNull
{noformat}

vector.expressions.gen classes for Long/Double:
{noformat}
IfExprLongColumnDoubleScalar
IfExprLongColumnLongColumn
IfExprLongColumnLongScalar
IfExprLongScalarDoubleColumn
IfExprLongScalarDoubleScalar
IfExprLongScalarLongColumn
IfExprLongScalarLongScalar
IfExprDoubleColumnDoubleColumn
IfExprDoubleColumnDoubleScalar
IfExprDoubleColumnLongScalar
IfExprDoubleScalarDoubleColumn
IfExprDoubleScalarDoubleScalar
IfExprDoubleScalarLongColumn
IfExprDoubleScalarLongScalar
{noformat}
(there are others for StringGroup, Timestamp, IntervalDayTime, etc)

Wherever there is a Column is the existing classes, we could generate additional Expr classes, too. E.g.
{noformat}
IfExprLongExprDoubleScalar
IfExprLongExprLongExpr
IfExprLongExprLongScalar
IfExprLongScalarDoubleExpr
IfExprLongScalarLongExpr
IfExprLongScalarLongScalar
IfExprDoubleExprDoubleExpr
IfExprDoubleExprDoubleScalar
IfExprDoubleExprLongScalar
IfExprDoubleScalarDoubleExpr
IfExprDoubleScalarLongExpr
{noformat}

And, for IfExprColumnNull, etc, we could add:
{noformat}
IfExprExprNull
IfExprNullExpr
{noformat}
(if we were keen on performance, we could even generate the type specific versions for the Null classes...), [~mmccline]：

HIVE-17139 mainly optimize vector- and row- expression.

For the vector- expression (for example IfExprDoubleColumnDoubleColumn.java),

If(expr1, expr2, expr3), When eveluate the children expression (expr1,expr2 and expr3), Firstly, we compute the expr1 and the result stored in batch.cols[arg1Column], where if the expr1 is true, the value of batch.cols[arg1Column] is 1, or is 0. Then we compute the expr2 if the batch.cols[arg1Column] is 1, or compute the expr3.  After we eveluate the children expression, the value of If expression is compute based on the result of expr1, if the expr1 is 1, the value is expr2, or the value is expr3. I think it will not be NPE like HIVE-18524. If I have wrong understanding, please tell me, thanks.

For the row- expression (for example VectorUDFAdaptor.java):

We eveluate the children expression same as the vector- expression above. After eveluated the children expression, the current implementation in VectorUDFAdaptor gets the i-th row batch.cols[arg1Column][i], batch.cols[arg2Column][i], batch.cols[arg3Column][i] and then wrap the result with GenericUDF.DeferredObject passing to GenericUDFIf.java . And eveluate the final value of If expression in GenericUDFIf.java base on the passed GenericUDF.DeferredObject. The exception of HIVE-18524 is in the wrapping result with GenericUDF.DeferredObject phase. For example, the value of If expression is BytesColumnVector, in the i-th row, if the expr1 is 1, we will skip compute expr3 during eveluating the children expression phase. So the batch.cols[arg3Column][i] is null. And it will throws NPE. And our solution is only wrap the satisfied value and skip the not-satisfied value. For example, if the batch.cols[arg1Column][i] is 1, we only wrap the batch.cols[arg2Column][i] and not wrap the batch.cols[arg3Column][i].

 And this optimization can gain 17% improvement in Q06 on TPCx-BB and +40% improvement in the complexity String operation. I think this optimization is necessary., [~mmccline]：

{quote}Before we add any more vectorization features like this one I'd like to see a better testing framework.  HIVE-18622 was a huge fix to many vector expressions that were handling NULLs incorrectly.  In particular, IfExprColumnNull and IfExprNullColumn had bugs.  By better framework, I like to see all the different UDFs generated with expressions for both row- and vector- and have data will NULLs generated and driven through those expressions and the results compared.  I think a framework like this would have found the bug that resulted in the revert.  And, also would have found many of the problems fixed by HIVE-18622.

{quote}Now, we have passed all the origin qtest and the new added qtest I can think of . If you have comprehensive test cases, Please tell me, thanks.

{quote}Vector expressions need to be created in the VectorizationContext class and not as a special case in VectorUDFAdaptor.  VectorizationContext instantiates vector expressions so they have proper TypeInfo and can be displayed with EXPLAIN VECTORIZATION.

{quote} I will try to move the creation of Vector expression code in VectorUDFAdaptor to VectorizationContext .

{quote}What I don't understand is why an IF expr with computed THEN and/or ELSE values isn't just another vector expression.  I may be missing something.  I certainly see it is more sophisticated in that you want to avoid executing any THEN expressions whose IF expr row value is false and similarly avoid executing any ELSE expressions whose IF expr is true.

{quote}Case When Else expression is translated to If expression in HIVE-16731. If I have wrong understanding your question, Please tell me, thanks.

{quote}Usually, rather than add special cases to existing vector expressions we use GenVectorCode to generate with templates new class variations.  We try to avoid complicated base classes that have lots of decision logic.  That was my impression when I read the code a while ago.  I could be wrong but even though it may seem redudant we generally have vectorization code variation just focus on the specific variation they are executing.

{quote}The special case only focus on the row- expression (VectorUDFAdaptor.java) to solve the GenericUDFIf case and for the vector- expression, I think it can apply to all the generally case. If I have wrong understanding, Please tell me., [~mmccline]：

I have moved the creation of Vector expression code in VectorUDFAdaptor to VectorizationContext . The RB link is [https://reviews.apache.org/r/61019/diff/11#index_header.] If any questions, Please tell me, Thanks!, 1) I want to see the IF expr support for THEN/ELSE expressions general not just for a special case for VectorUDFAdaptor children.

2) Ok, so the test framework is on me.  I'm still concerned about quality here.  Historically our vectorization testing has been too minimal.

3) I don't want to see IfExprColumnNull and IfExprNullColumn and other classes made subclasses of IfExprConditionalFilter and made more complicated.  I'd rather see new classes IfExprExprExpr and perhaps IfExprExprNull and IfExprNullExpr each of which can be read straight through.

4) Why are any changes to VectorUDFAdaptor necessary at all? , [~mmccline]:

{quote}I want to see the IF expr support for THEN/ELSE expressions general not just for a special case for VectorUDFAdaptor children.

{quote}

I think the IF expr support for THEN/ELSE expressions has two cases:row mode and vector mode. Here, the specicial case for VectorUDFAdaptor is to handle the row mode. And For the vector mode is handled in the IfExprXX classes.

{quote}Ok, so the test framework is on me.  I'm still concerned about quality here.  Historically our vectorization testing has been too minimal.

{quote}

Thanks for your help.

{quote}I don't want to see IfExprColumnNull and IfExprNullColumn and other classes made subclasses of IfExprConditionalFilter and made more complicated.  I'd rather see new classes IfExprExprExpr and perhaps IfExprExprNull and IfExprNullExpr each of which can be read straight through.

{quote}

I will add three new classes  IfExprExprExpr , IfExprExprNull and IfExprNullExpr to handle different case later.

{quote}Why are any changes to VectorUDFAdaptor necessary at all?

{quote}

The change in VectorUDFApaptor is to handle If expression in row mode. In hive, some row mode expression(deciminal operation) does not support vector mode. And if the IF expression contain decimal operation, hive will make vectorized operator by VectorUDFAdaptor.

If any questions, Please tell me. Thanks for your help., [~mmccline]:

I have add new classes IfExprExprExprFilter , IfExprExprNullFilter and IfExprNullExprFilter to handle different If expression case. The review link is [https://reviews.apache.org/r/61019/diff/12#index_header.]  If any questions, Please tell me, Thanks!, -1.  I'm at a total loss to understand why it is necessary to inject this IF vector expression inside the VectorUDFAdaptor class.

I'm going to come up with an alternative design for IF statements that have expressions in the THEN or ELSE that have a vector expression that doesn't use the VectorUDFAdaptor., [~mmccline]:

For the row mode expression, whether can we not optimize the if expression in VectorUDFAdaptor or not currently? 

For the vector mode expression, I may have some wrong understanding about your suggestion before. After discuss with [~Ferd] offline, I think your suggestion make sense. But I have one question about  the current vector expression design. According to my understanding, the vector expression mainly has two cases: containing Null and not containing Null. For the containing NULL, the vector expression can be IfExprColumnNull, IfExprNullColumn and IfExprNullNull. For the not containing Null, the vector expression has two cases: generated classes by GenVectorCode(Long/Double) and not generated class(String/IntervalDayTime/TimeStamp). Here, why the String/IntervalDayTime/TimeStamp type classes is not generated by GenVectorCode?  And what is the difference between the Long/Double and String/IntervalDayTime/TimeStamp? If you have some ideas, Please tell me. Thanks., This jira is resolved and released with Hive 3.0 If you find an issue with it, please create a new jira.]