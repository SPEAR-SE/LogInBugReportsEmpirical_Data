[This patch fixes the problem and adds a test., Looks good - will commit if the tests pass, Committed. Thanks Zheng]