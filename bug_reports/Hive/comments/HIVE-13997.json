[The patch deletes all existing files in dest dir if we're told to overwrite the directory. And it adds a new test to cover this.
Please note it's not enough just to overwrite existing files - we need to delete all of them. As in the new test, the two count( * ) should give the same result.

 One interesting finding is that, when target file exists, whether {{FileSystem::rename}} succeeds is inconsistent among different implementations, or even platform-dependent. In my local test, the rename succeeds for {{TestCliDriver}} which runs on local FS, but it fails for tests that run on a mini DFS like {{TestMiniSparkOnYarnCliDriver}}., [~ashutoshc], would you take a look? Thanks!, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12809803/HIVE-13997.1.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10226 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_ppd_multi_insert
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_ppd_multi_insert
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/105/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/105/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-105/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12809803 - PreCommit-HIVE-MASTER-Build, {{ppd_multi_insert}} is related. I'll look into it., Won't https://github.com/apache/hive/blob/master/ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java#L3165 delete the directory already. This later calls moveFile() If it doesn't we should enhance logic in replaceFiles() to do the deletes, instead of in moveFile(), Hi [~ashutoshc], since we are inserting into directory, we don't need to load table and replaceFiles won't be called. The call path is {{MoveTask.execute -> moveFile -> moveFileInDfs -> Hive.moveFile}}. Besides, moveFile does take care of replacing files. I think it just has a bug when the src is a sub dir of the dest dir.
{{ppd_multi_insert}} fails because {{Hive.isSubDir}} decides whether src is sub dir of dest by just checking {{src.startsWith(dest)}}. This is incorrect because it returns true when src is "/a/bc" and dest is "/a/b".
I'll provide a patch to fix this., In that case I think it might be better to have this delete logic in moveFileInDfs() since moveFile() is also called by loadPartition()/loadTable() and introducing new calls to NameNode will hurt perf for those cases. Also, do we need recursive delete, won't deleting parent dir be sufficient?, V2 patch moved the delete logic to moveFileInDfs. If Hive.moveFile is intended to take care of replacing the files, I still prefer to leave the logic there. It might hurt performance, but correctness is more important. Anyway let's see how test goes.
To clear the dest dir, we need to delete all the sub dirs under it which don't contain the src dir. That's why we need recursive delete., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12813407/HIVE-13997.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 6 failed/errored test(s), 10270 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_schema_evol_orc_nonvec_mapwork_part
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_schemeAuthority
org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler.org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/269/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/269/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-269/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12813407 - PreCommit-HIVE-MASTER-Build, +1, Try again., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12813580/HIVE-13997.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10257 tests executed
*Failed tests:*
{noformat}
TestMiniTezCliDriver-vectorization_16.q-vector_decimal_round.q-orc_merge6.q-and-12-more - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/271/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/271/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-271/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12813580 - PreCommit-HIVE-MASTER-Build, Pushed to master & branch-2.1 Thanks, Rui!, Thanks for the review Ashutosh :), hive insert overwrite directory only overwrite direct path of generated file not the directory.

-rwxrwxrwx 3 myvm users 1163 2016-11-24 03:11 /mytest/warehouse/mytable/000000_0
-rwxrwxrwx 3 myvm users 0 2016-11-24 03:09 /mytest/warehouse/mytable/000000_1
-rwxrwxrwx 3 myvm users 0 2016-11-24 03:09 /mytest/warehouse/mytable/000000_2
-rwxrwxrwx 3 myvm users 0 2016-11-24 03:09 /mytest/warehouse/mytable/000000_3

Expected insert overwrite command to overwrite the whole directory but its only updating 000000_0 and not touching other files in the path.

Im using hive-1.1.0-cdh5.5.1. Has this issue been fixed in this version?

Thanks, [~ajithshetty28], I guess that depends on whether they cherry picked the patch here into hive-1.1.0-cdh5.5.1. You need to confirm it with Cloudera.]