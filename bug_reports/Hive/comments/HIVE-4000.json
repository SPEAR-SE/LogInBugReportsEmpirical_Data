[omalley requested code review of "HIVE-4000 [jira] Hive client goes into infinite loop at 100% cpu".

Reviewers: JIRA

HIVE-4000 fix race condition in HashMap on Hive client

The Hive client starts multiple threads to track the progress of the MapReduce jobs. Unfortunately those threads access several static HashMaps that are not protected by locks. When the HashMaps are modified, they sometimes cause race conditions that lead to the client threads getting stuck in infinite loops.

TEST PLAN
  Test in the cluster with the query that was demonstrating the problem.

REVISION DETAIL
  https://reviews.facebook.net/D8493

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/QueryPlan.java
  ql/src/java/org/apache/hadoop/hive/ql/history/HiveHistory.java
  serde/src/java/org/apache/hadoop/hive/serde2/typeinfo/TypeInfoUtils.java

MANAGE HERALD RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/20739/

To: JIRA, omalley
, Replace the sets/maps with concurrent versions that protect against concurrent access from multiple threads., brock has commented on the revision "HIVE-4000 [jira] Hive client goes into infinite loop at 100% cpu".

  Looks good to me.

REVISION DETAIL
  https://reviews.facebook.net/D8493

To: JIRA, omalley
Cc: brock
, ashutoshc has accepted the revision "HIVE-4000 [jira] Hive client goes into infinite loop at 100% cpu".

  +1 Running tests.

REVISION DETAIL
  https://reviews.facebook.net/D8493

BRANCH
  hive-4000

ARCANIST PROJECT
  hive

To: JIRA, ashutoshc, omalley
Cc: brock
, Many tests are resulting in NPE because we switched to ConcurrentHashMaps which don't allow null keys (as oppose to HashMaps). Stacktrace:
{noformat}
] java.lang.NullPointerException
    [junit]     at java.util.concurrent.ConcurrentHashMap.containsKey(ConcurrentHashMap.java:782)
    [junit]     at java.util.Collections$SetFromMap.contains(Collections.java:3574)
    [junit]     at org.apache.hadoop.hive.ql.QueryPlan.extractCounters(QueryPlan.java:364)
    [junit]     at org.apache.hadoop.hive.ql.QueryPlan.getQueryPlan(QueryPlan.java:444)
    [junit]     at org.apache.hadoop.hive.ql.QueryPlan.toString(QueryPlan.java:617)
    [junit]     at org.apache.hadoop.hive.ql.history.HiveHistory.logPlanProgress(HiveHistory.java:503)
    [junit]     at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:147)
    [junit]     at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:57)
    [junit]     at org.apache.hadoop.hive.ql.Driver.launchTask(Driver.java:1343)
    [junit]     at org.apache.hadoop.hive.ql.Driver.execute(Driver.java:1129)
    [junit]     at org.apache.hadoop.hive.ql.Driver.run(Driver.java:940)
    [junit]     at org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:259)
    [junit]     at org.apache.hadoop.hive.cli.CliDriver.processCmd(CliDriver.java:216)
    [junit]     at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:413)
    [junit]     at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:348)
    [junit]     at org.apache.hadoop.hive.ql.QTestUtil.executeClient(QTestUtil.java:774)
    [junit]     at org.apache.hadoop.hive.cli.TestCliDriver.runTest(TestCliDriver.java:5759)
    [junit]     at org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_database_drop(TestCliDriver.java:1923)
{noformat}

Seems like we can fix this by modifying QueryPlan.java:364 to:
{code}
 if (task.getId() != null && started.contains(task.getId()) && done.contains(task.getId())) {
        continue;
      }
{code}, Also, Owen can you add a sample query and scenario where this problem will show up., The kind of query that is creating the problem looks like:

{code}
from Tbl
insert ...
insert ...
{code}

The customer sees the problem with 50 or more inserts., omalley updated the revision "HIVE-4000 [jira] Hive client goes into infinite loop at 100% cpu".

  Fixed a couple of spots where the id was null and caused problems for
  the hashmap.

Reviewers: ashutoshc, JIRA

REVISION DETAIL
  https://reviews.facebook.net/D8493

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D8493?vs=27561&id=27903#toc

BRANCH
  hive-4000

ARCANIST PROJECT
  hive

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/QueryPlan.java
  ql/src/java/org/apache/hadoop/hive/ql/history/HiveHistory.java
  serde/src/java/org/apache/hadoop/hive/serde2/typeinfo/TypeInfoUtils.java

To: JIRA, ashutoshc, omalley
Cc: brock
, +1, Committed to trunk. Thanks, Owen!, Integrated in hive-trunk-hadoop1 #87 (See [https://builds.apache.org/job/hive-trunk-hadoop1/87/])
    HIVE-4000 Hive client goes into infinite loop at 100% cpu (Owen Omalley via Ashutosh Chauhan) (Revision 1447122)

     Result = ABORTED
hashutosh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1447122
Files : 
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/QueryPlan.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/history/HiveHistory.java
* /hive/trunk/serde/src/java/org/apache/hadoop/hive/serde2/typeinfo/TypeInfoUtils.java
, Integrated in Hive-trunk-hadoop2 #126 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/126/])
    HIVE-4000 Hive client goes into infinite loop at 100% cpu (Owen Omalley via Ashutosh Chauhan) (Revision 1447122)

     Result = FAILURE
hashutosh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1447122
Files : 
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/QueryPlan.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/history/HiveHistory.java
* /hive/trunk/serde/src/java/org/apache/hadoop/hive/serde2/typeinfo/TypeInfoUtils.java
, Integrated in Hive-trunk-h0.21 #1974 (See [https://builds.apache.org/job/Hive-trunk-h0.21/1974/])
    HIVE-4000 Hive client goes into infinite loop at 100% cpu (Owen Omalley via Ashutosh Chauhan) (Revision 1447122)

     Result = SUCCESS
hashutosh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1447122
Files : 
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/QueryPlan.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/history/HiveHistory.java
* /hive/trunk/serde/src/java/org/apache/hadoop/hive/serde2/typeinfo/TypeInfoUtils.java
]