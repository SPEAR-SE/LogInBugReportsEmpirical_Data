[Attached patch-1: separated a new version of ImplicitConvertible() for union from comparison since for comparison, e.g., string should convert to double, while for union, double should convert to string. , 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12818248/HIVE-14251.1.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 10 failed/errored test(s), 10331 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_unionall_typeconversion
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
org.apache.hadoop.hive.metastore.TestMetaStoreMetrics.testConnections
org.apache.hive.spark.client.TestSparkClient.testJobSubmission
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/543/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/543/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-543/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12818248 - PreCommit-HIVE-MASTER-Build, Seems one file was not saved. Reattach patch-1 and trigger the build. , LGTM.

If i understand correctly, the only difference between isCommonTypeOf and implicitConvertible is this line
{code}
    // Allow implicit String to Double conversion
    if (fromPg == PrimitiveGrouping.STRING_GROUP && to == PrimitiveCategory.DOUBLE) {
      return true;
    }
{code}

Wondering if it's easy to re-use implicitConvertible instead of duplicating the code ? Maybe add a flag to the method
for String to Double conversion ? 
, Second to [~mohitsabharwal], in addition, it looks to me that the name implicitConvertible is more self-explanatory than isCommonTypeOf for this method., [~aihuaxu] Do you know why and under what situation the string could be considered to be implicitly converted to double? I believe it breaks your case because the date string could be converted to double. If we add a flag to disable this implicit conversion generally in getCommonClassForUnionAll, will it bring in possible backward type incompatibility in some queries with union all for type string and double?, Thanks for reviewing. 

Originally I thought of reusing, but later I decided not to and gave a new name to completely differentiate from implicitConvertible().

implicitConvertible() is used in the data comparison and isCommonTypeOf() is used in union all operator. In fact, they could have different behaviors, I guess, not only for string and double, but for any types from different groups, seems they may or may have opposite result. e.g., for void and string,  I'm not sure what should return for comparison; but for union, seems reasonable to return string. If it's numeric types, like int, double, then both should return double. 

Right now I only changed the union behavior of string and double and haven't touched the others. I feel we need to evaluate them as well but I will defer when we have the complains.   , Yeah. Actually implicitConvertible() is not completely accurate I feel. I just put the comment why I try to avoid reusing the same function. 

So for comparison of string and double, then we should compare them in double type. That's implicitConvertible() is trying to do, returning true for string => double conversion. 

I feel comparison and union do need separate functions though., When we are making such semantic changes we should make change which takes us closer to standard. So, it should help to read that to see what standard has to say here. 
I took this query and ran it against few databases:
* MySQL : same result as you are trying to achieve
* Postgres : exception : ERROR: UNION types date and integer cannot be matched Position: 53
* SQLServer: Different result set. It figured common type as date 2016-01-01 00:00:00.000 1900-01-06 00:00:00.000 1900-01-02 06:00:00.000

Couldn't try on oracle as I didnt had it handy. That would be good experiment too.
Clearly  its not consistent. My suggestion would be to read standard and try to emulate that as much as possible., Thanks for the suggestion. I went through the sql standard. Seems like the standard is treating union as another union join, but doesn't explicitly mention the behavior of mismatched type. Oracle requires the union types are in the same type group from the doc (I don't have one either to try out), but the doc is pretty clear that it won't do implicit type conversion across type groups (https://docs.oracle.com/cd/B19306_01/server.102/b14200/queries004.htm). 

 , 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12818862/HIVE-14251.1.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 17 failed/errored test(s), 10342 tests executed
*Failed tests:*
{noformat}
TestMsgBusConnection - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_groupby_sort_1_23
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_groupby_sort_skew_1_23
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union32
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_unionDistinct_1
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_unionDistinct_1
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_groupby_sort_1_23
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_groupby_sort_skew_1_23
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union32
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
org.apache.hadoop.hive.metastore.TestMetaStoreMetrics.testConnections
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/584/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/584/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-584/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 17 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12818862 - PreCommit-HIVE-MASTER-Build, [~ashutoshc] Do you have any opinion which approach we should go forward? Seems hive follows more Postgres. Should we throw exception for such case as Postgres and Oracle do? Of course, it will have compatibility issue and will affect some existing usages.
, I have found Postgres & Oracle to be lot more closer to standard then mysql, so yes I would follow their behavior. If that implies throwing exception here, that would be right course of action.
Current behavior is erroneous we need not to be backward compatible with our erroneous behavior : ) , Sounds good. , Patch-2: follow what Postgres does. For union operator, we disallow the implicit conversion across different type groups. If they are in the same type groups like numeric, date or string groups, then implicit conversion will be performed., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12819676/HIVE-14251.2.patch

{color:green}SUCCESS:{color} +1 due to 5 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 34 failed/errored test(s), 10342 tests executed
*Failed tests:*
{noformat}
TestMsgBusConnection - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_alter_partition_change_col
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_alter_table_cascade
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union33
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union36
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union_date_trim
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union_null
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union_remove_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union_remove_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union_remove_14
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_union_type_chk
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_unionall_join_nullconstant
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_unionDistinct_1
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_union_type_chk
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_groupby_sort_1_23
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_groupby_sort_skew_1_23
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union32
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union33
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union_date_trim
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union_null
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union_remove_12
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union_remove_13
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_union_remove_14
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
org.apache.hadoop.hive.llap.security.TestLlapSignerImpl.testSigning
org.apache.hadoop.hive.llap.tezplugins.TestLlapTaskSchedulerService.testDelayedLocalityNodeCommErrorImmediateAllocation
org.apache.hadoop.hive.metastore.TestMetaStoreMetrics.testConnections
org.apache.hive.spark.client.TestSparkClient.testJobSubmission
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/614/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/614/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-614/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 34 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12819676 - PreCommit-HIVE-MASTER-Build, Attached patch-3: update other affected unit tests. Removed one unit test since union_type_chk.q is dup of union36.q with the current change., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12820005/HIVE-14251.3.patch

{color:green}SUCCESS:{color} +1 due to 14 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 14 failed/errored test(s), 10305 tests executed
*Failed tests:*
{noformat}
TestHS2HttpServer - did not produce a TEST-*.xml file
TestHiveSQLException - did not produce a TEST-*.xml file
TestLdapAtnProviderWithMiniDS - did not produce a TEST-*.xml file
TestMiniTezCliDriver-insert_values_non_partitioned.q-update_after_multiple_inserts.q-tez_union_dynamic_partition.q-and-12-more - did not produce a TEST-*.xml file
TestMsgBusConnection - did not produce a TEST-*.xml file
TestServerOptionsProcessor - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_alter_partition_change_col
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
org.apache.hadoop.hive.metastore.TestMetaStoreMetrics.testConnections
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/645/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/645/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-645/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 14 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12820005 - PreCommit-HIVE-MASTER-Build, Patch-4: fix one unit test failure., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12820180/HIVE-14251.4.patch

{color:green}SUCCESS:{color} +1 due to 15 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 6 failed/errored test(s), 10368 tests executed
*Failed tests:*
{noformat}
TestMsgBusConnection - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_avro_nullable_union
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_avro_non_nullable_union
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/662/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/662/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-662/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12820180 - PreCommit-HIVE-MASTER-Build, Those tests are not related., [~ctang.ma], [~mohitsabharwal] and [~ashutoshc] Can you take another look at the patch? Tried to follow what Postgres and Oracle do and we will now force to use cast if the types are not in the same type group.  , LGTM, +1

Should this behavior change be documented in https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Union ?  , Rebase to the latest with the same change., Sure. Will update the wiki when the change is in., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12828291/HIVE-14251.5.patch

{color:green}SUCCESS:{color} +1 due to 15 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 10515 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_mapjoin]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[stats0]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.org.apache.hadoop.hive.cli.TestMiniLlapCliDriver
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[acid_bucket_pruning]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[union_null]
org.apache.hive.jdbc.TestJdbcWithMiniHS2.testAddJarConstructorUnCaching
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1165/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1165/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-1165/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12828291 - PreCommit-HIVE-MASTER-Build, Update the .q.out file for one test case union_null.q of spark., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12828310/HIVE-14251.6.patch

{color:green}SUCCESS:{color} +1 due to 15 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 6 failed/errored test(s), 10544 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_mapjoin]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[stats0]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[acid_bucket_pruning]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
org.apache.hive.jdbc.TestJdbcWithMiniHS2.testAddJarConstructorUnCaching
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1166/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1166/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-1166/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12828310 - PreCommit-HIVE-MASTER-Build, Those tests are not related., Pushed to master. Thanks Mohit for reviewing and Ashutosh for discussion., Doc note:  [~aihuaxu] documented this in the Union wikidoc.

* [Union -- Column Type Conversion | https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Union#LanguageManualUnion-ColumnTypeConversion]

Question:  Should this also be mentioned in the section on implicit conversions in the Data types doc?

* [Data Types -- Allowed Implicit Conversions  | https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Types#LanguageManualTypes-AllowedImplicitConversions], Does this affect branch-1? Having incorrect results should warrant a fix in all the branches (2.1, 2.0, 1.3?), Yes. It should affect all of them. I will backport to those branches., I'm moving this JIRA out of 2.1.1 release as it is not a blocker nor critical for a 2.1.1 RC version. Feel free to commit it to branch 2.1 if the patch is ready before the release.]