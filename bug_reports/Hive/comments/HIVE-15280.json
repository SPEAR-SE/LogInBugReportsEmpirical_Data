[

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12840361/HIVE-15280.1.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 3 failed/errored test(s), 10733 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=145)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2286/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2286/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2286/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12840361 - PreCommit-HIVE-Build, Should we add some unit tests for this?, [~stakiar] I added a new test case to the S3 insert_into.q query to validate the compressed filenames are correctly inserted.

I thought on adding this case on insert_compressed.q, but the {{dfs -ls}} command on .q.out for HDFS patches are fully masked, and if I change it to be partially masked, then lots of .q.out would need to be updated.

I also thought about adding simple unit tests with mocks, but mvFile and copyFiles are private methods, and another parent copyFiles is protected, and that just complicates unit tests. 

I think the insert_compressed.q did not fail on Hive 2.2 because it fixed something related to detecting compression on files without looking at the file extension. 

Anyway, I had an idea of making blobstore tests available on Hive QA by adding a proxy filesystem to it. Once I do that, we will see these tests running automatically, and validating the mvFile() case., I think the .q test case is not useful either because it shows the timestamp when the files were written. Forget about the 2nd patch., [~spena] in that case, it may be easier to just add unit tests for these methods. The unit tests could just be added for {{copyFiles(HiveConf conf, Path srcf, Path destf, FileSystem fs, boolean isSrcLocal, boolean isAcid, List<Path> newFiles)}} which already is package protected., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12840669/HIVE-15280.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 10733 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=59)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=133)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[columnstats_part_coltype] (batchId=148)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_3] (batchId=90)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2298/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2298/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2298/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12840669 - PreCommit-HIVE-Build, Yes, before HIVE-15199, filetype has '.' in it, HIVE-15199 use the FilenameUtils.getExtension which remove the char. Adding the extension separator back in the full file name is the fix. 
The fix looks good.  +1, Here's a new patch with unit tests added., +1

Just to clarify the {{Mockito.spy}} usage, the code is basically creating a LocalFileSystem object and then forcing the {{FileSystem.getURI()}} method basically returns {{hdfs://}} in which case {{needToCopy}} will return true?, Correct, that's why I did it that way. I did not know how to spy the Hive.needCopy() as it is a static method., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12840716/HIVE-15280.3.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 10742 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=59)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=133)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=91)
org.apache.hive.service.server.TestHS2HttpServer.testContextRootUrlRewrite (batchId=183)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2310/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2310/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2310/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12840716 - PreCommit-HIVE-Build]