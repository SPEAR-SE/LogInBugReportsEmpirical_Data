[Looks like this happens because Kryo's classloader set only once, during initialization. If Kryo is initialized during one statement without the UDF jar, then in the same session the jar is added and another statement is run using the UDF, the Kryo classloader will not have been updated with the jar containing the UDF., Initial patch with test., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12767929/HIVE-12206.1.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 9710 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.hwi.TestHWISessionManager.testHiveDriver
org.apache.hadoop.hive.ql.io.orc.TestJsonFileDump.testJsonDump
org.apache.hive.jdbc.TestJdbcWithMiniHS2.testAddJarDataNucleusUnCaching
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5802/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5802/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5802/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12767929 - PreCommit-HIVE-TRUNK-Build, Not sure why TestJdbcWithMiniHS2.testAddJarDataNucleusUnCaching is failing, it appears to pass for me on Mac as well as my Linux VM. Uploading same patch to run tests again., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12769423/HIVE-12206.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 9733 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_vectorized_parquet_types
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver_hbase_queries
org.apache.hadoop.hive.hwi.TestHWISessionManager.testHiveDriver
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5847/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5847/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5847/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12769423 - PreCommit-HIVE-TRUNK-Build, +1 fix looks good.
There is also contrib/src/java/org/apache/hadoop/hive/contrib/udf/example/UDFExampleAdd.java which could have been used for test case here., I had to use a different JAR from hive-contrib, because that one is included as a dependency by itests and thus does not get ClassNotFoundException., It also had to be a GenericUDF rather than the old-style UDF class, Ok. Thanks for looking into that., Committed to branch-1/master, It seems that the added q test case is failing, at least producible on my machine. 
http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5908/testReport, Hmm, the new test should actually have been added under the minitez.query.files section, rather than minillap.query.files., Created HIVE-12333 to fix this]