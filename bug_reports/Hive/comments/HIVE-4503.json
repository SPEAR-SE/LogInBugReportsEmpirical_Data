[This looks like a duplicate of HIVE-4500, HIVE-4500 explicitly close history file and other resources in hiveserver2's close session methods, but hiveserver still depends on GC to release history file and SessionState's tmpOutputFile. There is a clean method in ThriftHive interface introduced in HIVE-818 and we can use it to explicitly close a session in hiveserver. We can also try to clean up old resource each time we initize a HiveServerHandler in HiveServer.java:

{code}
@@ -134,10 +136,23 @@ public HiveServerHandler(HiveConf conf) throws MetaException {
|        isHiveQuery = false;
|        driver = null;
|        SessionState session = new SessionState(conf);
| +
| +      if (SessionState.get() != null) {
| +        SessionState oldSession = SessionState.get();
| +        tearDownSessionIO(oldSession);
| +      }
|        SessionState.start(session);
|        setupSessionIO(session);
|      }
|
| +    private void tearDownSessionIO(SessionState session) {
| +      HiveHistory hiveHist = session.getHiveHistory();
| +      if (null != hiveHist) {
| +        hiveHist.closeStream();
| +      }
| +      IOUtils.cleanup(LOG, session.out);
| +    }
| +
{code}
Please correct me if I miss something.
, Removed non-ascii character from Summary title.]