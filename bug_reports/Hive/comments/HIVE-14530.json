[[~liwenhe] [~jcamachorodriguez]

In my opinion, this issue is broken by https://issues.apache.org/jira/browse/HIVE-13639 

By default Cost-based optimization in Hive, which uses the Calcite framework is enabled. (set hive.cbo.enable=true). 

 [~jcamachorodriguez] introduced a new rule HiveUnionPullUpConstantsRule, which was added in relOptRules by CalcitePlanner.

Please take a look at review request: https://reviews.apache.org/r/46974/diff/1#2

If we set hive.cbo.enable=false, the issue is not reproduced. 

[~liwenhe] Please update component -> CBO.

[~jcamachorodriguez] Could you please take a look? 



, [~liwenhe], [~Spring], thanks for pointing this out. There was indeed a bug in the logic introduced in HIVE-13639 to infer constant values that can be pull up from the Union.

I have just uploaded the fix, and I added the queries in the description to the testsuite., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12825995/HIVE-14530.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 11 failed/errored test(s), 10467 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_mapjoin]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[correlationoptimizer8]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[join34]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[join35]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver[schemeAuthority]
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[join34]
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[join35]
org.apache.hadoop.hive.thrift.TestHadoopAuthBridge23.testDelegationTokenSharedStore
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1031/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1031/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-1031/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 11 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12825995 - PreCommit-HIVE-MASTER-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12825997/HIVE-14530.01.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 10467 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_mapjoin]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[correlationoptimizer8]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[join34]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[join35]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[join34]
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[join35]
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1032/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1032/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-1032/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12825997 - PreCommit-HIVE-MASTER-Build, [~jcamachorodriguez] Can you briefly describe the issue here?, HIVE-13639 extended the logic to pull up predicates (and thus constants) through Union operators.

Originally, we were extracting them as a single disjunction of all the predicates in each input. For instance, for a Union with _n_ inputs:
_[pred1 OR pred2 OR ... predn]_ 

Instead, we factorize and identify common elements:
_[pred1, ..., predx, residualpred1 OR residualpred2 OR ... residualpredn]_
where _pred1, ..., predx_ are common elements found in every Union input, while _residualpred1 OR residualpred2 OR ... residualpredn_ are preds found only in input _1, 2, ..., n_, respectively.

This helped us identifying more expressions to pull up, and reducing the complexity of doing so. However, there was a bug that was making us pull up expressions even if they had not been found in every union input. This patch fixes that issue., Thanks for explanation. +1, Pushed to master, branch-2.1. Thanks for the review [~ashutoshc]!]