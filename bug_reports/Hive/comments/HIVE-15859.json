[I noticed writing to the channel is protected by channelLock in {{Rpc::call}}. However there's no synchronization for writing in {{RpcDispatcher::handleCall}}. Not sure whether that can be a problem.
[~vanzin] would you mind share your thoughts on this? Thanks., {{RpcDispatcher::handleCall}} is on the read side, which is single-threaded in netty. So there's no need for synchronization there. The write side is multi-threaded so it needs to be thread-safe, maybe there's a problem there.

I'd take a look at this: https://github.com/cloudera/livy/pull/274

Maybe the same problem exists in Hive code., Hi [~vanzin], thanks for providing the Livy PR. That's exactly the same issue I meant in my last comment. I'm wondering, if the message order gets messed like the PR mentioned:
* Send call header
* Send reply header
* Send reply payload
* Send call payload

It means the receiver will receive two successive message headers. And it should happen before we hit the issue here. Not sure why it doesn't cause any trouble.
Anyway I think Hive needs the same fix, and we can test if it fixes this one., Patch v1 based on the Livy PR.
[~KaiXu], could you test if the patch fixes your problem? Thanks., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12852521/HIVE-15859.1.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10238 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[schema_evol_orc_acid_part_update] (batchId=151)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=223)
org.apache.hive.spark.client.rpc.TestRpc.testRpcDispatcher (batchId=274)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3536/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3536/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3536/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12852521 - PreCommit-HIVE-Build, Thanks [~lirui] for your work,  I found a similar issue and log on HIVE-15912, can you help to review? I will have a test after that., Fix test., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12852760/HIVE-15859.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 10219 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[cbo_rp_auto_join1] (batchId=3)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[join31] (batchId=81)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[multiMapJoin2] (batchId=152)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver (batchId=160)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=223)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[join31] (batchId=133)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3566/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3566/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3566/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12852760 - PreCommit-HIVE-Build, [~KaiXu], please confirm if the patch here fixes your problem reported here. Thanks., Thanks all for the efforts, I will try the patch., Another way to fix (and also mentioned in the Livy PR) is to combine the message header with the payload. I think can have some class like
{code}
class RpcMessage {
  MessageHeader header;
  Object payload;
}
{code}
so that we can send/receive the header and payload as a whole. It may be a more thorough way to avoid potential race conditions.
[~xuefuz], [~vanzin] what do you think about it?, It seems to me that option #2 can be on top of option #1 because we may want to let all messages go thru the event loop. If that's case, we can further implement option #2 as a followup. Thoughts?

In the meantime, I'm very eager to know if this has addressed [~KaiXu]'s problem., Hi [~xuefuz], netty's channel is thread safe. We can write to it concurrently in multiple threads. The problem is we divide each message into header and payload and write them to the channel separately. And thus the order can be messed up on receiver side. If we combine them into one message, I think we don't need to force all the writes thru event loop. I suppose we can try this way if the current approach doesn't solve the issue., I think I have managed to reproduce the issue by introducing some sleep between the message header and payload, and the issue happens consistently:
{code}
      synchronized (channelLock) {
        channel.write(new MessageHeader(id, Rpc.MessageType.CALL)).addListener(listener);
        Thread.sleep(5000);
        channel.writeAndFlush(msg).addListener(listener);
      }
{code}

Also answering my own question in the previous [comment|https://issues.apache.org/jira/browse/HIVE-15859?focusedCommentId=15865239&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15865239]. The two successive message headers do cause trouble. However, we didn't log the full stack trace of the error [here|https://github.com/apache/hive/blob/master/spark-client/src/main/java/org/apache/hive/spark/client/rpc/RpcDispatcher.java#L158]. I modified that and found the actual error is a {{java.lang.NoSuchMethodException}}. This makes sense because we don't have a handle method for message header (we're expecting a payload).

To conclude: the receiver receives two successive headers, hit the NoSuchMethodException, and then receives two successive payload and log the warning {{Expected RPC header, got XXX instead}}. This is inline with the hive log in the description.

I verified the patch here can solve the issue (with the extra sleep).
[~KaiXu] it'd be great if you can help verify it too. Thanks., Hi [~xuefuz] and [~lirui], I have tried to run 3 times with the patch, currently the issue not occurred any more, though it's random previously, but can frequently reproduce. So I think the patch solved the issue, Thanks for all your efforts!, Thanks [~KaiXu] for the clarifications. Update patch v3 to make sure we log the exception caught in the pipeline.
[~xuefuz], [~vanzin] could you please take a look? Thanks!, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12854804/HIVE-15859.3.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 1 failed/errored test(s), 10266 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=223)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3801/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3801/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3801/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12854804 - PreCommit-HIVE-Build, +1, Committed to master. Thanks Xuefu for the review., hi, [~lirui]. I encountered the same issue in hive 1. It would be great that community could back-port the patch to hive 1., Pushed to branch-1. Sorry about the delay., [~lirui], thanks for your support! ]