[

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12893923/HIVE-17595.0.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 56 failed/errored test(s), 11322 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[infer_bucket_sort_convert_join] (batchId=52)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[llap_acid_fast] (batchId=156)
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[repl_load_requires_admin] (batchId=91)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[subquery_multi] (batchId=110)
org.apache.hadoop.hive.cli.control.TestDanglingQOuts.checkDanglingQOut (batchId=205)
org.apache.hadoop.hive.ql.exec.TestUtilities.testGetTasksHaveNoRepeats (batchId=281)
org.apache.hadoop.hive.ql.parse.TestCopyUtils.testPrivilegedDistCpWithSameUserAsCurrentDoesNotTryToImpersonate (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testAlters (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testBasic (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testBasicWithCM (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testBootstrapLoadOnExistingDb (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testBootstrapWithConcurrentDropPartition (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testBootstrapWithConcurrentDropTable (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testBootstrapWithConcurrentRename (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testBootstrapWithDropPartitionedTable (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testCMConflict (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testConcatenatePartitionedTable (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testConcatenateTable (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testConstraints (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testDrops (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testDropsWithCM (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testDumpLimit (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testEventTypesForDynamicAddPartitionByInsert (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testExchangePartition (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIdempotentMoveTaskForInsertFiles (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIncrementalAdds (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIncrementalInsertDropPartitionedTable (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIncrementalInsertDropUnpartitionedTable (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIncrementalInsertToPartition (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIncrementalInserts (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIncrementalLoad (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIncrementalLoadFailAndRetry (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIncrementalLoadWithVariableLengthEventId (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIncrementalRepeatEventOnExistingObject (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testIncrementalRepeatEventOnMissingObject (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testInsertOverwriteOnPartitionedTableWithCM (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testInsertOverwriteOnUnpartitionedTableWithCM (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testInsertToMultiKeyPartition (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testRemoveStats (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testRenamePartitionWithCM (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testRenamePartitionedTableAcrossDatabases (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testRenameTableAcrossDatabases (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testRenameTableWithCM (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testStatus (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testTruncatePartitionedTable (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testTruncateTable (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testTruncateWithCM (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testViewsReplication (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.parallelExecutionOfReplicationBootStrapLoad (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testBootstrapFunctionReplication (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testCreateFunctionIncrementalReplication (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testDropFunctionIncrementalReplication (batchId=222)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testMultipleStagesOfReplicationLoadTask (batchId=222)
org.apache.hadoop.hive.ql.parse.authorization.plugin.sqlstd.TestOperation2Privilege.checkHiveOperationTypeMatch (batchId=270)
org.apache.hive.jdbc.TestJdbcWithLocalClusterSpark.testTempTable (batchId=232)
org.apache.hive.jdbc.TestTriggersTezSessionPoolManager.testTriggerHighShuffleBytes (batchId=229)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/7482/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/7482/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-7482/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 56 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12893923 - PreCommit-HIVE-Build, re uploading the patch not sure why the build was not scheduled for the previous one. 
, [~thejas] i am not able to get this patch to queue for build in apache, also looks like the builds there are not running, can you please help ?, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12894113/HIVE-17595.1.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 11323 tests executed
*Failed tests:*
{noformat}
TestHBaseCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=95)
	[hbase_ppd_key_range.q,hbasestats.q,hbase_custom_key2.q,hbase_viewjoins.q,hbase_pushdown.q]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[infer_bucket_sort_convert_join] (batchId=52)
org.apache.hadoop.hive.cli.TestHBaseCliDriver.org.apache.hadoop.hive.cli.TestHBaseCliDriver (batchId=94)
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver[hbase_custom_key3] (batchId=94)
org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver[hbase_null_first_col] (batchId=94)
org.apache.hadoop.hive.cli.TestNegativeMinimrCliDriver.testCliDriver[ct_noperm_loc] (batchId=93)
org.apache.hadoop.hive.cli.control.TestDanglingQOuts.checkDanglingQOut (batchId=205)
org.apache.hadoop.hive.ql.exec.TestUtilities.testGetTasksHaveNoRepeats (batchId=281)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testConstraints (batchId=222)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/7492/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/7492/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-7492/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12894113 - PreCommit-HIVE-Build, * org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[infer_bucket_sort_convert_join]: fixed
* org.apache.hadoop.hive.cli.TestHBaseCliDriver.org.apache.hadoop.hive.cli.TestHBaseCliDriver
* org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver[hbase_custom_key3] : success on local machine
* org.apache.hadoop.hive.cli.TestHBaseCliDriver.testCliDriver[hbase_null_first_col] : success on local machine
* org.apache.hadoop.hive.ql.exec.TestUtilities.testGetTasksHaveNoRepeats : fixed 

other failures are from previous build., reattaching the patch so a build can be triggered., [~thejas] /[~daijy] can you please help here, not sure why the patch is not being picked up by build system, i am assuming the build system is available at 
https://builds.apache.org/job/PreCommit-HIVE-Build/, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12894681/HIVE-17595.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 11341 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=62)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[unionDistinct_1] (batchId=145)
org.apache.hadoop.hive.cli.TestNegativeMinimrCliDriver.testCliDriver[ct_noperm_loc] (batchId=93)
org.apache.hadoop.hive.cli.control.TestDanglingQOuts.checkDanglingQOut (batchId=205)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testConstraints (batchId=222)
org.apache.hive.jdbc.TestJdbcWithLocalClusterSpark.testTempTable (batchId=232)
org.apache.hive.jdbc.TestTriggersTezSessionPoolManager.testTriggerHighShuffleBytes (batchId=229)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/7555/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/7555/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-7555/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12894681 - PreCommit-HIVE-Build, Couple of comments:
1. Can you take a note what problem did you see if updating database last.repl.id earlier? Is that some bootstrap tasks get skipped?
2. Name EfficientDAGTraversal, do we have a regular DAGTraversal? If not, probably just leave DAGTraversal is better; DependencyCollectionFunction, might be better AddDependencyToLeaves?
3. How about createEndReplLogTask? Shall we do it after all tasks as well?, * Added a note as to why this change is needed
* changed the class names 
* there is separate conditions that lead to execution of createEndReplLogTask, it is done after all the tasks are done as part of 
{code}
      boolean addAnotherLoadTask = iterator.hasNext() || loadTaskTracker.hasReplicationState()
          || constraintIterator.hasNext();
      createBuilderTask(scope.rootTasks, addAnotherLoadTask);
      if (!iterator.hasNext() && !constraintIterator.hasNext()) {
        loadTaskTracker.update(updateDatabaseLastReplID(maxTasks, context, scope));
        work.updateDbEventState(null);
      }
{code}, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12894948/HIVE-17595.3.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 11342 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=62)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[parquet_ppd_decimal] (batchId=9)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[llap_acid_fast] (batchId=156)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[sysdb] (batchId=155)
org.apache.hadoop.hive.cli.TestNegativeMinimrCliDriver.testCliDriver[ct_noperm_loc] (batchId=93)
org.apache.hadoop.hive.cli.control.TestDanglingQOuts.checkDanglingQOut (batchId=205)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testConstraints (batchId=222)
org.apache.hive.jdbc.TestTriggersTezSessionPoolManager.testTriggerHighShuffleBytes (batchId=229)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/7576/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/7576/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-7576/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12894948 - PreCommit-HIVE-Build, bq. there is separate conditions that lead to execution of createEndReplLogTask, it is done after all the tasks are done as part of ...
Seems createEndReplLogTask is dependent on root tasks, not leaves:
{code}
private Task<? extends Serializable> createEndReplLogTask(...) {
      ......
      dependency(scope.rootTasks, replLogTask);
      ......
}
{code}, figured out a bunch of places with duplicate code, as well as the implementation of AddDependencyToLeaves was corrected, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12895389/HIVE-17595.4.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 11349 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=62)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[sysdb] (batchId=156)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=102)
org.apache.hadoop.hive.cli.TestNegativeMinimrCliDriver.testCliDriver[ct_noperm_loc] (batchId=94)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[subquery_multi] (batchId=111)
org.apache.hadoop.hive.cli.control.TestDanglingQOuts.checkDanglingQOut (batchId=206)
org.apache.hadoop.hive.ql.parse.TestReplicationScenarios.testConstraints (batchId=223)
org.apache.hive.jdbc.TestTriggersTezSessionPoolManager.testTriggerHighShuffleBytes (batchId=230)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/7596/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/7596/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-7596/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12895389 - PreCommit-HIVE-Build, Need license header for new files. Otherwise +1., * org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2]  : passes on local machine

other tests are failing from older builds. [~daijy] can you please review!, adding license headers, Committed to master, Thanks for the review [~daijy], This jira is resolved and released with Hive 3.0 If you find an issue with it, please create a new jira.]