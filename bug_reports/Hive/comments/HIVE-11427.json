[TOK_TMP_FILE does not have a database before it, so Utilities.getDbTableName provide current working db as its db which is not right for CTAS.
Should use the database where the table to be created belongs to.
Attach patch for the fix., Need code review., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12798319/HIVE-11427.1.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 3 failed/errored test(s), 9974 tests executed
*Failed tests:*
{noformat}
TestJdbcWithMiniHS2 - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_auto_mult_tables
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7567/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7567/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-7567/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12798319 - PreCommit-HIVE-TRUNK-Build, The failures are not related.
[~spena], could you review the change? Thanks. I manually tested the fix in a cluster. , The patch looks good and simple.
Could you verify and/or add a test case when HDFS encryption is enabled? There are a few {{encryption_*.q}} files you can use to see examples about it.

I wonder what we should do if a user is attempting to create a table (non-encrypted) from an encrypted table. If the encrypted table has sensitive information, such as SSN, then they will be able to copy the data and stored without encryption in the target location?, [~spena], I attached the second patch with an encryption test., CTAS function like create a table then do insert with select statement from other tables. I think if the data can be returned to select statement, it will be inserted to the destination table. So user should make sure the destination table is encrypted too. , What if the destination table is not encrypted? Should we fail running the CTAS command?
I don't remember if we have that validation with INSERT ... SELECT. , I do not know. It should not be related to this jira, this jira just use the destination database's resource as the tmp storage and the tmp storage will be deleted after at the end of the CTAS. It does not affect how the final data is stored. 
And I think Insert --- select may not so strict, for example, how do we handle select with several tables joins, some encrypted, some not? We may create a different jira for the encryption issue. , You're right. At the end, the security issue was still there before.
So the code looks right.
+1

Let's wait for tests before doing the commit., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12798617/HIVE-11427.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 3 failed/errored test(s), 9968 tests executed
*Failed tests:*
{noformat}
TestMiniTezCliDriver-vector_distinct_2.q-load_dyn_part2.q-join1.q-and-12-more - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_partition_coltype_literals
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7614/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7614/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-7614/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12798617 - PreCommit-HIVE-TRUNK-Build, The failures are not related. Thanks [~spena] for reviewing the code., Committed to master and branch-1]