[Hi [~Liu765940375], does the issue happen for MR too? I.e. when hive.merge.mapfiles=true and hive.merge.mapredfiles=true.
And could you share your data to reproduce it?, [~lirui]: this also happened in MR., Hi [~lirui], I have added the DataGen mvn project file(Main.java, RowGenerator.java, pom.xml) and hive-site.xml in attach files. It is easy to generate data on hdfs by the code(Default textfile is 500M. Parquet file is about 200M, and it generates 10 partitions dynamically. One file in partition is about 10M, so you need at least 2 files in one partition to merge them)., I think the cause is we need to set neededNestedColumnPaths in {{GenMapRedUtils::createTemporaryTableScanOperator}}., [~lirui]: nestedColumnPaths is to solve the problem of HIVE-13873 which relates the struct type. In current case, there is no struct type and I can not set neededNestedColumnPaths in GenMapRedUtils::createTemporaryTableScanOperator.
{code}
CREATE EXTERNAL TABLE IF NOT EXISTS sale_record_temporary
( record_id DECIMAL(23,0)
, product_name STRING
, amount DECIMAL(6,0)
, prize DECIMAL(11,0)
, customer_name STRING
, doc_date TIMESTAMP
, due_date TIMESTAMP
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY '|'
STORED AS TEXTFILE LOCATION '/user/hive/warehouse/sale.db/sale_record_temporary'
{code}

I directly add a not null judgement before the code.
{code}
-          neededNestedColumnPaths.addAll(ts.getNeededNestedColumnPaths());
+          if (ts.getNeededNestedColumnPaths() != null) {
+            neededNestedColumnPaths.addAll(ts.getNeededNestedColumnPaths());
+          }
         }

{code}


[~Liu765940375]: can you verify whether HIVE-16958.patch can solve your problem?, +1, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12874823/HIVE-16958.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 13 failed/errored test(s), 10850 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[tez_smb_main] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=146)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=99)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=233)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query16] (batchId=233)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=233)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query94] (batchId=233)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testBootstrapFunctionReplication (batchId=217)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testCreateFunctionIncrementalReplication (batchId=217)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testCreateFunctionWithFunctionBinaryJarsOnHDFS (batchId=217)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=178)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=178)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=178)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/5807/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/5807/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-5807/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 13 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12874823 - PreCommit-HIVE-Build, [~ferd]: as [~lirui] finished review, can you help commit it to upstream?, Committed to the upstream. Thanks [~kellyzly] for the patch and [~lirui] for the review., Hive 3.0.0 has been released so closing this jira.]