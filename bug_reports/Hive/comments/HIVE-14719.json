[In {{ASTNode::setChild}}, if I clear the {{rootNode}} field from the subtree being replaced, it fixes the specific issue mentioned in the description. More generally, maybe we should clear {{rootNode}} whenever a node's parent or child changes.
Besides, I think we don't even properly maintain the parent/child fields. For example when a node is deleted, its parent is not set to null. Not sure if we do this deliberately.
[~ashutoshc] do you have any idea about it? I don't know much about the parsing stuff., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12827599/HIVE-14719.1.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 10544 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_mapjoin]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[dynpart_sort_optimization_acid]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[stats0]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[acid_bucket_pruning]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
org.apache.hive.jdbc.TestJdbcWithMiniHS2.testAddJarConstructorUnCaching
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1134/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1134/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-1134/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12827599 - PreCommit-HIVE-MASTER-Build, I don't understand how clearing out of rootNode fixes the issue. Once we set new child in AST, previous one won't be accessible. So, how does this clearing out of rootNode helps? 
Also, why does this issue doesn't happen with cbo on?, Thanks [~ashutoshc] for your input. I just did some more debug.
# Suppose originally we have Tree1:
{noformat}
                             WHERE1
                               |
                              AND1
                          /         \
                         =1         =2
                       /    \      /   \
                     DOT1  DOT2  DOT3  DOT4
{noformat}
# Then we replace DOT1 with DOT5, and DOT5's rootNode is null. Then we replace DOT3 with DOT6. In the process, DOT5's rootNode is re-evaluated as the root of Tree1. DOT6's rootNode is null. So far everything is fine.
# Then we create AND2 and add =1 and =2 as its children. So we have Tree2:
{noformat}
                              AND2
                          /         \
                         =1         =2
                       /    \      /   \
                     DOT5  DOT2  DOT6  DOT4
{noformat}
Note that now =1 and =2's  parent points to AND2. However, they are not deleted from Tree1, so that AND1 still considers them as its children.
# At last, we create a new node to replace AND1 (whole subtree) in Tree1.
# DOT5's rootNode still points to Tree1. Suppose Tree1 re-evaluated its AST string and then we call DOT5::toStringTree, we'll get wrong result.

My v1 patch just coincidentally fixed the issue in step 4 - it clears rootNode in the subtree of AND1, relying on that AND1 still holds =1 and =2 as its children.
If deleted node can be considered inaccessible, maybe we should clear rootNode info when adding a node to a tree?

As for CBO, it takes another code path to parse the query. I haven't looked at that yet., Thanks [~lirui] for detailed explanation. Your patch is in right direction. If we remove a node and use it elsewhere then we should clear its root node before removing it. Can you also add a test case in your patch?, Thank you [~ashutoshc] for your comments. Update patch to add test. It clears rootNode only for {{setChild}}. Ideally maybe we should also do it for {{deleteChild}}, {{replaceChildren}}, {{addChild}} etc. But I'm afraid that's bad for performance., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12827869/HIVE-14719.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 10547 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_mapjoin]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[dynpart_sort_optimization_acid]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[stats0]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[acid_bucket_pruning]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
org.apache.hive.jdbc.TestJdbcWithMiniHS2.testAddJarConstructorUnCaching
org.apache.hive.spark.client.TestSparkClient.testJobSubmission
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1146/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1146/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-1146/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12827869 - PreCommit-HIVE-MASTER-Build, Latest failures are not related., [~ashutoshc], could you take another look?, Guess [~ashutoshc] is busy with other tasks. [~jcamachorodriguez], [~hsubramaniyan] could you take a look at this? Thanks.]