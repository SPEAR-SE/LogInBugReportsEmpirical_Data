[Rebase., Matt, Can you post a pull request please?, Current patch is a Work-In-Progress so the performance can be checked that still has Q file wrong results.  I'll post a Review Board on a later patch when things are ready for review., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12841574/HIVE-15335.01.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 56 failed/errored test(s), 10891 tests executed
*Failed tests:*
{noformat}
TestHiveDecimalWritable - did not produce a TEST-*.xml file (likely timed out) (batchId=274)
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver (batchId=50)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[avro_decimal] (batchId=62)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[avro_decimal_native] (batchId=25)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[compute_stats_decimal] (batchId=8)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[decimal_2] (batchId=56)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[decimal_3] (batchId=24)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[decimal_4] (batchId=69)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[decimal_5] (batchId=59)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[decimal_6] (batchId=52)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[decimal_join2] (batchId=35)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[decimal_serde] (batchId=75)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[decimal_udf] (batchId=8)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_ppd_boolean] (batchId=32)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_ppd_char] (batchId=9)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[serde_regex] (batchId=34)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_round] (batchId=70)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_binary_join_groupby] (batchId=73)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_data_types] (batchId=69)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_3] (batchId=18)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_4] (batchId=27)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_5] (batchId=1)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_6] (batchId=12)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_round] (batchId=32)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_round_2] (batchId=21)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_reduce_groupby_decimal] (batchId=29)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[extrapolate_part_stats_partial_ndv] (batchId=149)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_date] (batchId=145)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_decimal] (batchId=137)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_timestamp] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_varchar] (batchId=149)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[schema_evol_text_nonvec_part_all_primitive] (batchId=146)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[schema_evol_text_vec_part_all_primitive] (batchId=148)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[schema_evol_text_vecrow_part_all_primitive] (batchId=148)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_adaptor_usage_mode] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_binary_join_groupby] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_data_types] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_decimal_3] (batchId=139)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_decimal_4] (batchId=142)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_decimal_5] (batchId=137)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_decimal_6] (batchId=138)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_decimal_round] (batchId=143)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_decimal_round_2] (batchId=140)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_decimal_udf] (batchId=152)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_reduce_groupby_decimal] (batchId=142)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[avro_decimal_native] (batchId=105)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_data_types] (batchId=126)
org.apache.hive.hcatalog.data.TestDefaultHCatRecord.testRYW (batchId=179)
org.apache.orc.TestVectorOrcFile.testRepeating (batchId=231)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2395/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2395/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2395/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 56 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12841574 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12841700/HIVE-15335.02.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 28 failed/errored test(s), 10881 tests executed
*Failed tests:*
{noformat}
TestHiveDecimalWritable - did not produce a TEST-*.xml file (likely timed out) (batchId=274)
TestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=128)
	[groupby6_map.q,groupby2_noskew_multi_distinct.q,load_dyn_part12.q,scriptfile1.q,join15.q,auto_join17.q,join_hive_626.q,tez_join_tests.q,auto_join21.q,join_view.q,join_cond_pushdown_4.q,vectorization_0.q,union_null.q,auto_join3.q,vectorization_decimal_date.q]
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver (batchId=50)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[avro_decimal] (batchId=62)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[avro_decimal_native] (batchId=25)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[compute_stats_decimal] (batchId=8)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_expressions] (batchId=47)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[extrapolate_part_stats_partial_ndv] (batchId=149)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_date] (batchId=145)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_decimal] (batchId=137)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_timestamp] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_varchar] (batchId=149)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_decimal_expressions] (batchId=146)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=92)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_5] (batchId=91)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[avro_decimal_native] (batchId=105)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_data_types] (batchId=126)
org.apache.hadoop.hive.common.type.TestHiveDecimal.testRandomCreateFromBigDecimalNoRoundFractionsOnly (batchId=236)
org.apache.hadoop.hive.ql.exec.vector.expressions.TestVectorTypeCasts.testCastDecimalToBoolean (batchId=259)
org.apache.hadoop.hive.ql.exec.vector.expressions.TestVectorTypeCasts.testCastDecimalToLong (batchId=259)
org.apache.hive.hcatalog.data.TestDefaultHCatRecord.testRYW (batchId=179)
org.apache.orc.TestVectorOrcFile.testRepeating (batchId=231)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2411/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2411/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2411/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 28 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12841700 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12841742/HIVE-15335.03.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 10 failed/errored test(s), 10897 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver (batchId=50)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=92)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_4] (batchId=92)
org.apache.hive.hcatalog.data.TestDefaultHCatRecord.testRYW (batchId=179)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2413/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2413/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2413/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12841742 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12841931/HIVE-15335.04.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 13 failed/errored test(s), 10849 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_sortmerge_join_2] (batchId=44)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_decimal] (batchId=138)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=92)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_4] (batchId=92)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_5] (batchId=91)
org.apache.hive.hcatalog.data.TestDefaultHCatRecord.testRYW (batchId=180)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2439/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2439/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2439/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 13 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12841931 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12841931/HIVE-15335.04.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 10 failed/errored test(s), 10849 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_sortmerge_join_2] (batchId=44)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_decimal] (batchId=138)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=150)
org.apache.hive.hcatalog.data.TestDefaultHCatRecord.testRYW (batchId=180)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2440/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2440/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2440/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12841931 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12842055/HIVE-15335.05.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 10 failed/errored test(s), 10856 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[dbtxnmgr_showlocks] (batchId=71)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_decimal] (batchId=138)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=150)
org.apache.hive.hcatalog.data.TestDefaultHCatRecord.testRYW (batchId=180)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2459/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2459/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2459/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12842055 - PreCommit-HIVE-Build, Build for #6 crashed., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12842497/HIVE-15335.07.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 12 failed/errored test(s), 10842 tests executed
*Failed tests:*
{noformat}
TestMiniLlapLocalCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=143)
	[vectorized_rcfile_columnar.q,vector_elt.q,explainuser_1.q,multi_insert.q,tez_dml.q,vector_bround.q,schema_evol_orc_acid_table.q,vector_when_case_null.q,orc_ppd_schema_evol_1b.q,vector_join30.q,vectorization_11.q,cte_3.q,update_tmp_table.q,vector_decimal_cast.q,groupby_grouping_id2.q,vector_decimal_round.q,tez_smb_empty.q,orc_merge6.q,vector_decimal_trailing.q,cte_5.q,tez_union.q,cbo_rp_subq_not_in.q,vector_decimal_2.q,columnStatsUpdateForStatsOptimizer_1.q,vector_outer_join3.q,schema_evol_text_vec_part_all_complex.q,tez_dynpart_hashjoin_2.q,auto_sortmerge_join_12.q,offset_limit.q,tez_union_multiinsert.q]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_3] (batchId=91)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vectorization_short_regress] (batchId=113)
org.apache.hive.hcatalog.data.TestDefaultHCatRecord.testRYW (batchId=180)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2514/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2514/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2514/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 12 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12842497 - PreCommit-HIVE-Build, Did a pass of everything except FastHiveDecimalImpl.java itself. Will look at that later this week, I haven't created a pull request before.  But, do you mean a pull request for the ORC github and just the changes that will affect orc and storage-api directories?, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12842981/HIVE-15335.08.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 13 failed/errored test(s), 10896 tests executed
*Failed tests:*
{noformat}
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_sortmerge_join_2] (batchId=44)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[columnstats_part_coltype] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_4] (batchId=93)
org.apache.hadoop.hive.ql.io.parquet.TestVectorizedColumnReader.decimalRead (batchId=251)
org.apache.hadoop.hive.ql.io.parquet.TestVectorizedDictionaryEncodingColumnReader.decimalRead (batchId=250)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2559/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2559/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2559/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 13 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12842981 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12843179/HIVE-15335.09.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 24 failed/errored test(s), 10899 tests executed
*Failed tests:*
{noformat}
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_sortmerge_join_2] (batchId=44)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_ppd_boolean] (batchId=32)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_ppd_char] (batchId=9)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_binary_join_groupby] (batchId=74)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_data_types] (batchId=69)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_reduce_groupby_decimal] (batchId=29)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[metadataonly1] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_date] (batchId=146)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_decimal] (batchId=139)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_timestamp] (batchId=152)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[orc_ppd_varchar] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_binary_join_groupby] (batchId=152)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_data_types] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_reduce_groupby_decimal] (batchId=143)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_data_types] (batchId=127)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2573/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2573/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2573/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 24 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12843179 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12843231/HIVE-15335.091.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 13 failed/errored test(s), 10899 tests executed
*Failed tests:*
{noformat}
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_sortmerge_join_2] (batchId=44)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[columnstats_part_coltype] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[metadataonly1] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2574/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2574/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2574/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 13 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12843231 - PreCommit-HIVE-Build, Patch 091 is a good test run (all test failures are old unrelated ones)., Please create a pull request., * This breaks API compatibility of DecimalColumnVector, which is public API. I suspect you'll need to create a new class (mabye FastDecimalColumnVector?) 
* TypeDescription.createBatch will need an option about which kind of batch create.
* The ORC reader and writer need to support both formats.
* You'll need to port this code to the ORC project as well., I haven't created a pull request before. But, do you mean a pull request for the ORC github and just the changes that will affect orc and storage-api directories?, I have great difficulty accepting that DecimalColumnVector is now a public API.  I haven't even begun to think of all the problems this will create.

I made quite a number of changes to HiveDecimal and HiveDecimalWritable.  Not just the internals but to the interfaces.  For example, current HiveDecimalWritable is very slow because it internally represents decimals as BigInteger binary bytes. It exposes the binary bytes through getInternalStorage().   I zapped that immediately.  The compatibility I designed for was serialization/deserialization of binary bits and text and decimal execution behavior -- not code compatibility.  Binary bit compatibility ensures ORC will be able to read/write the same information.  The TestHiveDecimal class verifies that the binary bit compatibility with SerializationUtils (ORC’s serialization), with BigInteger binary bit compatibility (LazyBinary, Avro, Parquet), and same behavior with OldHiveDecimal/OldHiveDecimalWritable (the original HiveDecimal/HiveDecimalWritable renamed).  I needed to be able to make major code changes (the core fast decimal implementation class is 9,000 lines) to get good performance with ORC serialization/deserialization of decimals and with all other decimal operations (except division/remainder).  Matching the semantics of Hive decimals and BigDecimal that execute quickly is quite challenging.

I need to be able to take a hammer to the code in the future to get good performance.  I've done some experimenting improving the performance of HiveChar/HiveVarchar and its writables.  Very little of the original code will survive -- just like with fast decimals., Jenkins was down., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12843373/HIVE-15335.093.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 10 failed/errored test(s), 10901 tests executed
*Failed tests:*
{noformat}
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[metadataonly1] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2589/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2589/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2589/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12843373 - PreCommit-HIVE-Build, Speeding up the decimal vectorization is insanely important. I'm really glad that you are working on the patch.

{quote}
I have great difficulty accepting that DecimalColumnVector is now a public API.
{quote}

It isn't hard to see:
* vectorized UDF will break
* ORC users that don't use row by row shims will break

Both are documented and public APIs.

I'm -1 to incompatible changes to the storage-api API. You need to add new methods/classes and deprecate the old ones and remove them at some point down the road. On the plus side, if you don't make incompatible changes to the lower levels, you don't need to make a single huge patch and can divide the jira into more managable patches.

The current DecimalColumnVector is so incredibly broken, that completely replacing the implementation is great. I haven't looked at the representation, yet. How did you encode the decimals in your FastDecimalColumnVector? I really hope it is an array of longs like Teddy was using., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12843574/HIVE-15335.094.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 12 failed/errored test(s), 10904 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=234)
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_sort_array] (batchId=59)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[metadataonly1] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2606/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2606/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2606/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 12 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12843574 - PreCommit-HIVE-Build, Done with RB up to iter #7. Phew! Left a few comments... thanks for the added code comments :)
Reviewing FastHiveDecimalImpl, I eventually went into an "eyeball the code" mode (esp. with e.g. multiplication/division), parsing it all in detail might take longer than writing it ;) So I hope it has good test coverage. If someone wants to read these in great detail you are welcome to...
, +1, I am assuming it is on by default so there's test coverage also from q files.
Remaining nits can be fixed on commit.
Also a lot of trailing white space that can  be fixed on commit., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12843671/HIVE-15335.096.patch

{color:green}SUCCESS:{color} +1 due to 11 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 15 failed/errored test(s), 10907 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=233)
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=250)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=39)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_sort_array] (batchId=59)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[metadataonly1] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[subquery_notin] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_4] (batchId=93)
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[subquery_nested_subquery] (batchId=84)
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[subquery_shared_alias] (batchId=84)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2621/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2621/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2621/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 15 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12843671 - PreCommit-HIVE-Build, A good test run (all failures are known and TestVectorizedColumnReaderBase doesn't produce an output because it has no tests)., Rename OldHiveDecimal (the old copy of HiveDecimal) to HiveDecimalV1.
Add back/rename a few methods including setScale(int scale) to make sure HiveDecimal has same public methods and same public fields as HiveDecimalV1.
Same for HiveDecimalWritable.  Old copy is now HiveDecimalWritableV1.
Add automatic verification that all public methods and public fields of HiveDecimal and HiveDecimalWritable are declared with annotations to be either V1 or V2.
Added comments., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12844003/HIVE-15335.097.patch

{color:green}SUCCESS:{color} +1 due to 16 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 15 failed/errored test(s), 10895 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=234)
TestHiveDecimalBase - did not produce a TEST-*.xml file (likely timed out) (batchId=168)
TestHiveDecimalBase - did not produce a TEST-*.xml file (likely timed out) (batchId=240)
TestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=98)
	[groupby_map_ppr.q,nullgroup4_multi_distinct.q,join_rc.q,union14.q,smb_mapjoin_12.q,vector_cast_constant.q,union_remove_4.q,auto_join11.q,load_dyn_part7.q,udaf_collect_set.q,vectorization_12.q,groupby_sort_skew_1.q,groupby_sort_skew_1_23.q,smb_mapjoin_25.q,skewjoinopt12.q]
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=39)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_sort_array] (batchId=59)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2646/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2646/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2646/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 15 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12844003 - PreCommit-HIVE-Build, Rename TestHiveDecimalBase to HiveDecimalTestBase so it doesn't produce no xml test result warnings., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12844022/HIVE-15335.098.patch

{color:green}SUCCESS:{color} +1 due to 16 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 11 failed/errored test(s), 10910 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=234)
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=39)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_sort_array] (batchId=59)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[columnstats_part_coltype] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2650/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2650/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2650/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 11 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12844022 - PreCommit-HIVE-Build, I think this will break bloom filters for decimal columns. Changing addString() to addBytes() will have different hashcode based on the default charset of the system. I can see from comments that decimal.toBytes() returns UTF-8 bytes. But the earlier addString() could return UTF-16 bytes or some other charset based on the system default. 

Also avro_decimal*.q test cases are returning different column stats for num_false. Not sure why is this changing the column stats output., Changed decimal.toBytes(..) to toString to get right checksum (thanks Prasanth)., The avro changes in the diff are essentially reverting the Q files back to their original state.  Once the patch is committed and rebased, the avro Q files no longer appear., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12844041/HIVE-15335.099.patch

{color:green}SUCCESS:{color} +1 due to 16 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 13 failed/errored test(s), 10895 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=234)
TestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=115)
	[groupby_map_ppr_multi_distinct.q,bucketmapjoin10.q,vectorization_13.q,mapjoin_mapjoin.q,union2.q,join41.q,groupby8_map.q,cbo_subq_not_in.q,identity_project_remove_skip.q,groupby8_map_skew.q,nullgroup2.q,mapjoin_subquery.q,bucket2.q,smb_mapjoin_1.q,union_remove_8.q]
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=39)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[udf_sort_array] (batchId=59)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2651/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2651/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2651/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 13 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12844041 - PreCommit-HIVE-Build, The HiveDecimal and HiveDecimalWritable support *all* the V1 public methods and fields.  V2 for both adds a bunch of new methods and a few new fields.  Some V2 methods provide faster ways to do things than V1.  For example, LazySimpleSerializeWrite uses a V2 scratch byte array method toFormatBytes to generate the display decimal into and then writes the scratch byte array.  The V1 logic created a throw away String, called getBytes which allocated another throw away object, and wrote the bytes.

TestHiveDecimal's primary test philosophy is to create the HiveDecimalV1 and HiveDecimal objects with the same input (e.g. a String, BigDecimal, etc), do the same operation on both and compare the V1 and V2 decimals.

HiveDecimalWritableV1 and HiveDecimalWritable support all V1 public methods, too.

One of the major performance improvements was doing operations like the new mutateAdd directly on the HiveDecimalWritable for sum instead of calling getHiveDecimal(), doing an add which creates another object, and then setting the HiveDecimalWritable with the result., This fully addresses Owen's -1 from  5 days ago.  HiveDecimal, HiveDecimalWritable, and DecimalColumnVector are fully backward compatible.

DecimalColumnVector has only internal changes and no external changes.  The vector is still an array of HiveDecimalWritable., Left some comments in RB
- bloom filter still seems broken
- are avro_decimal*.q.out diff expected?
- is there a way to include the annotation to HiveDecimal javadoc? This will help users know which API to use without looking at the code.  , the new changes look good to me, +1, [~prasanth_j] Thanks for your review!  24-hour commit clock started., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12844156/HIVE-15335.0991.patch

{color:green}SUCCESS:{color} +1 due to 16 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 12 failed/errored test(s), 10913 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=234)
TestVectorizedColumnReaderBase - did not produce a TEST-*.xml file (likely timed out) (batchId=251)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[dbtxnmgr_showlocks] (batchId=71)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[str_to_map] (batchId=58)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=135)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=151)
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[exchange_partition_neg_incomplete_partition] (batchId=84)
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[exim_00_unsupported_schema] (batchId=85)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query36] (batchId=222)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query70] (batchId=222)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query86] (batchId=222)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2665/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2665/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2665/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 12 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12844156 - PreCommit-HIVE-Build, The patch doesn't apply cleanly because the revert of HIVE-15112., To create a pull request, push your change to a clone of Hive's repository in a branch. When you go to Hive's github repository it will offer you the option to create a pull request of the branch you just pushed.

And yes, please port the patch to ORC and create a pull request over there too., Review comments:
* Thank you for addressing my API compatibility concerns.
* Do you have benchmark numbers for the new and old implementation? It should be faster, but it is worth looking at the numbers before making such a huge change to Hive.
* The test cases in storage-api have a lot of commented out printlns, those should either be removed or converted into LOG.debug.
* The tests in VersionTestBase should provide a message rather than just call fail().
* There is a commented out fail. That should be removed or uncommented.
* It would be great to have a fast path for decimals where the precision is less than or equal to 18, which fit into a long. Based on my casual observation more than 90% of Hive schemas with decimals fit. What would be the right approach to fit that in as a later patch?, Query benchmark on V1 showed very, very high cost in HiveDecimalWritable (serialization/deserialization, creation of HiveDecimal for getHiveDecimal), in ORC decimal deserialization (BigInteger).

The cost of V1 decimal add turns out not to be add but the cost of HiveDecimalWritable.getDecimal() and then serializing in back into BigInteger bytes for HiveDecimalWritable.set.  Everywhere code was doing a getHiveDecimal to pass it around between components.

Making HiveDecimalWritable a fast, first class citizen was major part of this change.  That included making HiveDecimalWritable the object of choice to pass around or operate on directly.  E.g. Vectorized SUM aggregation eliminated almost call calls HiveDecimalWritable.getHiveDecimal() for its summing.

One query benchmark on the new code showed 3X improvement and the add method cost was in the noise.  So storing decimals in 1 long instead of 3 (i.e. so called fast path) isn't the place to look.  Microbenchmarks on add cost miss the boat.  The fast path is using HiveDecimalWritable.mutableAdd and the fast V2 serialization/deserialization methods including the HiveDecimal.create family / HiveDecimalWritable.set family.  Another way of thinking about the fast path is not using BigInteger / BigDecimal., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12844322/HIVE-15335.0992.patch

{color:green}SUCCESS:{color} +1 due to 15 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 10850 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=234)
TestMiniLlapLocalCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=144)
	[vectorized_rcfile_columnar.q,vector_elt.q,explainuser_1.q,multi_insert.q,tez_dml.q,vector_bround.q,schema_evol_orc_acid_table.q,vector_when_case_null.q,orc_ppd_schema_evol_1b.q,vector_join30.q,vectorization_11.q,cte_3.q,update_tmp_table.q,vector_decimal_cast.q,groupby_grouping_id2.q,vector_decimal_round.q,tez_smb_empty.q,orc_merge6.q,vector_char_mapjoin1.q,vector_decimal_trailing.q,cte_5.q,tez_union.q,vector_decimal_2.q,columnStatsUpdateForStatsOptimizer_1.q,vector_outer_join3.q,schema_evol_text_vec_part_all_complex.q,tez_dynpart_hashjoin_2.q,auto_sortmerge_join_12.q,offset_limit.q,tez_union_multiinsert.q]
TestSparkCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=122)
	[groupby3_map.q,union11.q,union26.q,mapreduce1.q,mapjoin_addjar.q,bucket_map_join_spark1.q,udf_example_add.q,multi_insert_with_join.q,sample7.q,auto_join_nulls.q,ppd_outer_join4.q,load_dyn_part8.q,sample6.q,bucket_map_join_1.q,auto_sortmerge_join_9.q]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[dbtxnmgr_showlocks] (batchId=71)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_decimal_expressions] (batchId=48)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_decimal_expressions] (batchId=147)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=93)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2690/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2690/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2690/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12844322 - PreCommit-HIVE-Build, Fixup vector_decimal_expressions.q.out, HIVE-15335.0993.patch is final patch., Committed to master.

Thanks [~sershe], [~prasanth_j], [~owen.omalley] for your review comments.]