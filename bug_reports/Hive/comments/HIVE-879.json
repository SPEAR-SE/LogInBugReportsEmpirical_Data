[Looks good. Testing for trunk now.
The patch does not work for branch-0.4. Please generate a new one for branch-0.4., still running the tests, Committed to trunk. Thanks Namit!

Please provide a patch for branch-0.4, and add some description of the problem to this issue.]