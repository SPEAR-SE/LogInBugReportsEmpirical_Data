[[~sseth] [~thejas] [~gopalv] [~jdere]
Both fixes that we've discussed in the meeting.
The metadata cache is basically split into a separate memory limit with separate cache policy. This should "just work", I'll test it in the cluster later today. The limit is set as 10% of total cache memory., fyi [~pxiong] [~owen.omalley] wrt target versions, A small update to metrics., 90-10 split for data-metadata is probably small. This may lead to some more regression as queries will start reading file footers now. May be make the split configurable and deprecate it so that it can be removed in 3.0 when metadata moves offheap?, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12860926/HIVE-16318.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 6 failed/errored test(s), 10518 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[escape_comments] (batchId=231)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_sortmerge_join_2] (batchId=45)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[comments] (batchId=35)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=141)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[load_dyn_part5] (batchId=115)
org.apache.hive.hcatalog.api.TestHCatClient.testTransportFailure (batchId=172)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4420/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4420/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4420/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12860926 - PreCommit-HIVE-Build, Updated based on CR feedback. I think for realistic cases, 15% is enough; the only reason we saw it because dataset was huge so basically metadata took all the cache. 
Note that with this temporary approach, the memory is completely taken out of data cache... Actually, given that we don't alloc on-heap, we could set metadata cache to a fraction of data cache, w/o reducing the latter. Thoughts?, bq. Note that with this temporary approach, the memory is completely taken out of data cache... Actually, given that we don't alloc on-heap, we could set metadata cache to a fraction of data cache, w/o reducing the latter. Thoughts?
Makes sense to me.
Also, the metadata cache being a fraction of heapsize may make sizing the entire YARN container a little easier. I don't think we should change the executor memory though., Changes other than where fraction is chosen (heapsize vs cachesize) looks good to me. +1, The patch that takes the fraction off xmx and actually reserves it too cc [~prasanth_j] [~sseth],  cacheMetrics.setCacheCapacityTotal(totalMemorySize); call should also add metaMem, Mostly looks good. +1.

Strongly prefer it if the fraction of on heap cache was not affecting per executor memory.
LLAP_DAEMON_XMX_HEADROOM gives control over this value. Think overall configuration and sizing will be a little easier without having to think about 1 more parameter.

e.g. ContainerSize=132G. CacheSize=20G. Heap=100G. memPerExecutor=4G. numExecutors=25.
If the on-heap cache needs to be factored in (10%): change Xmx to a higher value - 110.
Executor size remains unchanged. ContainerSize and Heap increase by the amount that the on heap cache will use.

OTOH, with an automatic reduction.
Setting the heap to 110G, and a factor of 10%, 11G will be used for the cache. The executor size calculations become a little more complicated (4G executors still required).

Some of the calculations for executors - io.sort.mb, noconditionaltasksize, unordered buffers are absolute values - based on the initially specified container size (or per executor memory). Would be better to keep those as is. (There's explicit validations for some of these values to be within executor memory, which could cause errors)

Not automatically doing this means we're not accounting for cache usage, and another parameter would need to be changed. There is a knob available though. Setting it automatically reduces memory, but doesn't really fix the other parameters which have already been computed based on the available memory.

10G vs 11G when the value is set to 10% will not make that much of a difference. Without increasing the size though, executor memory can be reduced by quite a bit.

TL;DR - Simpler configuration via containerSize, Xmx OR heap reservation, instead of automatically subtracting from heap. Also not sure how accurate this measure is - considering Java objects.

, Nit: "metadataFraction < 0" -> "metadataFraction <= 0" ?, Taking out the extra headroom, +1. Thanks, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12860972/HIVE-16318.03.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10518 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[drop_with_concurrency] (batchId=231)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[escape_comments] (batchId=231)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[comments] (batchId=35)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=141)
org.apache.hive.hcatalog.api.TestHCatClient.testTransportFailure (batchId=172)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4424/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4424/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4424/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12860972 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12860976/HIVE-16318.04.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 3 failed/errored test(s), 10518 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[comments] (batchId=35)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=141)
org.apache.hive.hcatalog.api.TestHCatClient.testTransportFailure (batchId=172)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4427/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4427/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4427/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12860976 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12860976/HIVE-16318.04.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 3 failed/errored test(s), 10518 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[comments] (batchId=35)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=141)
org.apache.hive.hcatalog.api.TestHCatClient.testTransportFailure (batchId=172)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4432/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4432/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4432/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12860976 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12860976/HIVE-16318.04.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 2 failed/errored test(s), 10518 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[comments] (batchId=35)
org.apache.hive.hcatalog.api.TestHCatClient.testTransportFailure (batchId=172)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4433/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4433/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4433/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 2 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12860976 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12860976/HIVE-16318.04.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10518 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[drop_with_concurrency] (batchId=231)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[escape_comments] (batchId=231)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[comments] (batchId=35)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[columnstats_part_coltype] (batchId=153)
org.apache.hive.hcatalog.api.TestHCatClient.testTransportFailure (batchId=172)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4436/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4436/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4436/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12860976 - PreCommit-HIVE-Build, [~sershe], ready to commit?, Committed to million places. Thanks for the reviews!, Doc note:  This adds *hive.llap.io.metadata.fraction* and changes the default value of *hive.llap.io.allocator.alloc.min*, so they need to be documented in the wiki for release 2.2.0.

* [Configuration Properties -- LLAP I/O | https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties#ConfigurationProperties-LLAPI/O]
* [Configuration Properties -- LLAP I/O -- hive.llap.io.allocator.alloc.min | https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties#ConfigurationProperties-hive.llap.io.allocator.alloc.min]

By the way, a prior change of default value for *hive.llap.io.allocator.alloc.min* hasn't been documented yet -- see HIVE-13346.

Added a TODOC2.2.0 label.

Update 15/Sep/17:  HIVE-15665 removes the deprecated config *hive.llap.io.metadata.fraction* in release 3.0.0.]