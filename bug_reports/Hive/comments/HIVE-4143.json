[Stack trace of failed 3rd MR job:
{code}
Caused by: java.lang.RuntimeException: Reduce operator initialization failed
	at org.apache.hadoop.hive.ql.exec.ExecReducer.configure(ExecReducer.java:162)
	... 14 more
Caused by: java.lang.RuntimeException: cannot find field _wcol0 from [0:_col0, 1:_col1, 2:_col2]
	at org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorUtils.getStandardStructFieldRef(ObjectInspectorUtils.java:366)
	at org.apache.hadoop.hive.serde2.objectinspector.StandardStructObjectInspector.getStructFieldRef(StandardStructObjectInspector.java:143)
	at org.apache.hadoop.hive.ql.exec.ExprNodeColumnEvaluator.initialize(ExprNodeColumnEvaluator.java:57)
	at org.apache.hadoop.hive.ql.exec.Operator.initEvaluators(Operator.java:995)
	at org.apache.hadoop.hive.ql.exec.Operator.initEvaluatorsAndReturnStruct(Operator.java:1021)
	at org.apache.hadoop.hive.ql.exec.SelectOperator.initializeOp(SelectOperator.java:60)
	at org.apache.hadoop.hive.ql.exec.Operator.initialize(Operator.java:385)
	at org.apache.hadoop.hive.ql.exec.Operator.initialize(Operator.java:489)
	at org.apache.hadoop.hive.ql.exec.Operator.initializeChildren(Operator.java:417)
	at org.apache.hadoop.hive.ql.exec.Operator.initializeOp(Operator.java:402)
	at org.apache.hadoop.hive.ql.exec.PTFOperator.initializeOp(PTFOperator.java:102)
	at org.apache.hadoop.hive.ql.exec.Operator.initialize(Operator.java:385)
	at org.apache.hadoop.hive.ql.exec.Operator.initialize(Operator.java:489)
	at org.apache.hadoop.hive.ql.exec.Operator.initializeChildren(Operator.java:417)
	at org.apache.hadoop.hive.ql.exec.FilterOperator.initializeOp(FilterOperator.java:78)
	at org.apache.hadoop.hive.ql.exec.Operator.initialize(Operator.java:385)
	at org.apache.hadoop.hive.ql.exec.Operator.initialize(Operator.java:489)
	at org.apache.hadoop.hive.ql.exec.Operator.initializeChildren(Operator.java:417)
	at org.apache.hadoop.hive.ql.exec.ExtractOperator.initializeOp(ExtractOperator.java:40)
	at org.apache.hadoop.hive.ql.exec.Operator.initialize(Operator.java:385)
	at org.apache.hadoop.hive.ql.exec.ExecReducer.configure(ExecReducer.java:154)
{code}

If I remove last where clause {{where rnk <= 3}} query succeeds., A simpler query which demonstrates the problem is:
{noformat}
select ts, dec, rnk
from
  (select ts, dec, rank() over (partition by ts)  as rnk
          from (select other.ts, other.dec
             from over10k other join over10k on (other.b = over10k.b)
            ) item_sales 
  ) item_rank
where rnk <=  3;
{noformat}

Workaround is to {{set hive.ppd.remove.duplicatefilters=false;}} 
It seems that Hive is too agressive in pushing filters. In this particular case filter (rnk <= 3) gets pushed over PTFOperator and then this filter tries to reference column (rnk) which infact is generated by PTFOperator. We need to make this filter cannot be pushed over PTFOperator., Patch available at https://reviews.facebook.net/D9261, Committed to branch. Thanks Harish for the review.]