[To see the problem, you can apply the patch "HIVE-4572.replay.patch", and execute 
{code}
ant test -Dtestcase=TestCliDriver -Dqfile=RSKeyLostAfterCP.q
{\code}. 
Then you can search "In pruneReduceSinkOperator oldMap" and "In pruneReduceSinkOperator newMap" in "build/ql/tmp/hive.log" to see the problem., Add a patch. In org.apache.hadoop.hive.ql.optimizer.ColumnPrunerProcFactory.pruneReduceSinkOperator, RS key columns will not be removed columnExprMap. Need to test if this change works for HIVE-2206., Update a new patch. With this one, HIVE-2206 can work., To complete your example, I take it the new code will preserve the columns like:

After CP,
{code}
colExprMap of RS corresponding to x: {VALUE._col0=Column[key]};
colExprMap of RS corresponding to y: {VALUE._col0=Column[key]}.
{\code}

Is that correct?

+1 (non committer) looks good to me. Did you run tests on this?, [~hagleitn] Yes, it is correct. 

I have tested it on trunk. All tests pass. There were 7 failures and 3 errors when I ran the entire unit tests. But, all of these cases pass when I tested them individually. , yhuai requested code review of "HIVE-4572 [jira] ColumnPruner cannot preserve RS key columns corresponding to un-selected join keys in columnExprMap".

Reviewers: JIRA

Merge branch 'trunk' of https://github.com/apache/hive into HIVE-4572

For a RS of a join operator, if the join key corresponding to this RS does not appear in the SELECT clause, ColumnPruner will drop the entry of this column in colExprMap.

Example:

SELECT x.key FROM src1 x JOIN src y ON (x.key = y.key);

Before CP,

colExprMap of RS corresponding to x: {VALUE._col3=Column[INPUT__FILE__NAME], VALUE._col2=Column[BLOCK__OFFSET__INSIDE__FILE], VALUE._col1=Column[value], VALUE._col0=Column[key]};
colExprMap of RS corresponding to y: {VALUE._col3=Column[INPUT__FILE__NAME], VALUE._col2=Column[BLOCK__OFFSET__INSIDE__FILE], VALUE._col1=Column[value], VALUE._col0=Column[key]}.

After CP,

colExprMap of RS corresponding to x: {VALUE._col0=Column[key]};
colExprMap of RS corresponding to y: {}.

TEST PLAN
  EMPTY

REVISION DETAIL
  https://reviews.facebook.net/D10941

AFFECTED FILES
  jdbc/src/java/org/apache/hive/jdbc/HiveDriver.java
  jdbc/src/test/org/apache/hive/jdbc/TestJdbcDriver2.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
  ql/src/test/results/compiler/plan/join1.q.xml
  ql/src/test/results/compiler/plan/join3.q.xml

MANAGE HERALD RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/26163/

To: JIRA, yhuai
, yhuai updated the revision "HIVE-4572 [jira] ColumnPruner cannot preserve RS key columns corresponding to un-selected join keys in columnExprMap".

  The last diff is not correct. This one is the right one.

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D10941

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D10941?vs=34005&id=34017#toc

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
  ql/src/test/results/compiler/plan/join1.q.xml
  ql/src/test/results/compiler/plan/join3.q.xml

To: JIRA, yhuai
, +1. running test, Committed to trunk. Thanks Yin Huai!, Integrated in Hive-trunk-h0.21 #2121 (See [https://builds.apache.org/job/Hive-trunk-h0.21/2121/])
    HIVE-4572 ColumnPruner cannot preserve RS key columns corresponding to un-selected join keys in columnExprMap (Yin Huai via Navis) (Revision 1486722)

     Result = FAILURE
navis : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1486722
Files : 
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
* /hive/trunk/ql/src/test/results/compiler/plan/join1.q.xml
* /hive/trunk/ql/src/test/results/compiler/plan/join3.q.xml
, Integrated in Hive-trunk-hadoop2 #214 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/214/])
    HIVE-4572 ColumnPruner cannot preserve RS key columns corresponding to un-selected join keys in columnExprMap (Yin Huai via Navis) (Revision 1486722)

     Result = FAILURE
navis : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1486722
Files : 
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
* /hive/trunk/ql/src/test/results/compiler/plan/join1.q.xml
* /hive/trunk/ql/src/test/results/compiler/plan/join3.q.xml
, This issue has been fixed and released as part of 0.12 release. If you find further issues, please create a new jira and link it to this one.]