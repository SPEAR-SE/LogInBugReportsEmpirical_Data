[It looks like this is caused because TezCompiler invokes ConstantPropagate and this is removing some columns, but without a corresponding call to ColumnPruner to remove outputColumnNames from the join operator.

Talking to [~jpullokkaran] and [~hagleitn], the use of ConstantPropagate in TezCompiler is to remove extra (and unnecessary) "AND true" predicates generated during dynamic partition pruning. One solution is to eliminate just those expressions (referred to in ConstantPropagate as short-cutting), as opposed to doing full constant folding. I'll try to add an option to ConstantPropagate where we can specify that we only want to perform expression short-cutting rather than full constant folding., Attaching initial patch, RB at https://reviews.apache.org/r/35576/, 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12740176/HIVE-11028.1.patch

{color:red}ERROR:{color} -1 due to 3 failed/errored test(s), 9009 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_explainuser_2
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_join28
org.apache.hive.spark.client.TestSparkClient.testJobSubmission
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4291/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4291/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-4291/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12740176 - PreCommit-HIVE-TRUNK-Build, Looking at the failures:
  TestSparkCliDriver.testCliDriver_join28 looks like it has been intermittently failing in other precommit tests. Likely not related.
  TestSparkClient.testJobSubmission does not fail when I run it locally.
  TestMiniTezCliDriver.testCliDriver_explainuser_2: This failure is caused by the patch. It appears in the Optimizer, ConstantPropagate is run (twice) fairly early on in the list of transformations, but before PartitionPruner is run. It looks like after PartitionPruner is done there are new expressions that could be optimized by ConstantPropagate, and on Tez (prior to this patch) these were optimized out due to the extra invocation of ConstantPropagate that happens in TezCompiler. One fix is to simply run ConstantPropagate a 3rd time during Optimizer, after PartitionPruner, and fix this issue for all execution engines. This will prevent the failure in TestMiniTezCliDriver.testCliDriver_explainuser_2, though it might result in a lots of golden file updates for other tests that involve partition pruning (in the Tez test, it removes a predicate (11.0 = 11.0) which happens as a result of partition pruning)., Patch v2 - add a 3rd run of ConstantPropagate (full version) during Optimize.initialize(), to fix the diff in explainuser_2.q, 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12740285/HIVE-11028.2.patch

{color:red}ERROR:{color} -1 due to 21 failed/errored test(s), 9010 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_auto_join14
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_bucketsortoptimize_insert_7
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_filter_join_breaktask
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_fold_eq_with_case_when
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_fold_when
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_index_auto_unused
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_join14
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_join28
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_join32
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_join32_lessSize
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_join33
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_mapjoin_subquery
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_auto_join14
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_bucketsortoptimize_insert_7
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_filter_join_breaktask
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_join14
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_join28
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_join32
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_join32_lessSize
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_join33
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver_mapjoin_subquery
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4302/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4302/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-4302/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 21 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12740285 - PreCommit-HIVE-TRUNK-Build, There are actually quite a number of existing qfile explain plans that also contain this issue of extra predicates that could be cleaned up by an additional run of the constant propagation. On second thought, I will simply update the diff for explainuser_2.q, and open a new issue to address the additional optimations that are being missed by the current constant propagation., Created HIVE-11044 to address the issue of the predicates that are not currently being optimized by the existing constant propagation., +1, [~jdere] Test failures needs to be addressed otherwise looks good., Would like to add this to branch-1.2, 

{color:green}Overall{color}: +1 all checks pass

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12740446/HIVE-11028.3.patch

{color:green}SUCCESS:{color} +1 9011 tests passed

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4311/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/4311/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-4311/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12740446 - PreCommit-HIVE-TRUNK-Build, Committed to master/branch-1/branch1.2]