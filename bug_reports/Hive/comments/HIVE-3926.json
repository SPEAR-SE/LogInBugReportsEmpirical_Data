[I've found this patch overlaps partly with HIVE-3833., navis requested code review of "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".
Reviewers: JIRA

  DPAL-1969 PPD on virtual column of partitioned table is not working

  select * from src where BLOCK__OFFSET__INSIDE__FILE<100;

  is working, but

  select * from srcpart where BLOCK__OFFSET__INSIDE__FILE<100;

  throws SemanticException. Disabling PPD makes it work.

TEST PLAN
  EMPTY

REVISION DETAIL
  https://reviews.facebook.net/D8121

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/metadata/VirtualColumn.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/BucketMapJoinOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GlobalLimitOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GroupByOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/SortedMergeBucketMapJoinOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/listbucketingpruner/LBPartitionProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcCtx.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrOpProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartExprEvalUtils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/TableScanDesc.java
  ql/src/test/queries/clientpositive/ppd_vc.q
  ql/src/test/results/clientpositive/ppd_vc.q.out
  serde/src/java/org/apache/hadoop/hive/serde2/objectinspector/ObjectInspectorFactory.java

MANAGE HERALD DIFFERENTIAL RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/19569/

To: JIRA, navis
, navis updated the revision "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".

  Rebased to trunk

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D8121

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D8121?vs=26067&id=27717#toc

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/metadata/VirtualColumn.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/BucketMapJoinOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GlobalLimitOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GroupByOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/SortedMergeBucketMapJoinOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/listbucketingpruner/LBPartitionProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcCtx.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrOpProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartExprEvalUtils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/TableScanDesc.java
  ql/src/test/queries/clientpositive/ppd_vc.q
  ql/src/test/results/clientpositive/bucketmapjoin1.q.out
  ql/src/test/results/clientpositive/ppd_vc.q.out
  ql/src/test/results/clientpositive/stats11.q.out

To: JIRA, navis
, This issue also resolves single sourced multi scan with virtual columns. For example, the query
<code>
SELECT a.INPUT__FILE__NAME,a.key,a.value,b.INPUT__FILE__NAME,b.key,b.value FROM myinput1 a LEFT OUTER JOIN myinput1 b RIGHT OUTER JOIN myinput1 c ON a.value = b.value and b.value = c.value AND a.key > 40 AND a.value > 50 AND a.key = a.value AND b.key > 40 AND b.value > 50 AND b.key = b.value AND c.key > 40 AND c.value > 50 AND c.key = c.value;
<code>

is not working in trunk, throwing 
{code}
Caused by: java.lang.ClassCastException: org.apache.hadoop.hive.serde2.lazy.LazyStruct cannot be cast to [Ljava.lang.Object;
	at org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector.getStructFieldData(UnionStructObjectInspector.java:123)
	at org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector.getStructFieldData(UnionStructObjectInspector.java:131)
	at org.apache.hadoop.hive.ql.exec.ExprNodeColumnEvaluator.evaluate(ExprNodeColumnEvaluator.java:98)
	at org.apache.hadoop.hive.ql.exec.ReduceSinkOperator.processOp(ReduceSinkOperator.java:233)
	at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:522)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:850)
	at org.apache.hadoop.hive.ql.exec.TableScanOperator.processOp(TableScanOperator.java:90)
	at org.apache.hadoop.hive.ql.exec.Operator.process(Operator.java:522)
	at org.apache.hadoop.hive.ql.exec.Operator.forward(Operator.java:850)
	at org.apache.hadoop.hive.ql.exec.MapOperator.process(MapOperator.java:657)
{code}, navis updated the revision "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".

  Rebased to trunk

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D8121

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D8121?vs=27717&id=34797#toc

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/metadata/VirtualColumn.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractBucketJoinProc.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractSMBJoinProc.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/AvgPartitionSizeBasedBigTableSelectorForAutoSMJ.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GlobalLimitOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GroupByOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/TableSizeBasedBigTableSelectorForAutoSMJ.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/listbucketingpruner/LBPartitionProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcCtx.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrOpProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartExprEvalUtils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/TableScanDesc.java
  ql/src/test/queries/clientpositive/ppd_vc.q
  ql/src/test/results/clientpositive/ppd_vc.q.out

To: JIRA, navis
, navis updated the revision "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".

  Rebased to trunk

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D8121

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D8121?vs=34797&id=35703#toc

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/metadata/VirtualColumn.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractBucketJoinProc.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractSMBJoinProc.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/AvgPartitionSizeBasedBigTableSelectorForAutoSMJ.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GlobalLimitOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GroupByOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/TableSizeBasedBigTableSelectorForAutoSMJ.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/listbucketingpruner/LBPartitionProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcCtx.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrOpProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartExprEvalUtils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/TableScanDesc.java
  ql/src/test/queries/clientpositive/ppd_vc.q
  ql/src/test/results/clientpositive/ppd_vc.q.out

To: JIRA, navis
, hagleitn has commented on the revision "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".

  Some minor comments + request for more info.

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java:600 tableScanOperator was actually a clearer name, wasn't it?
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java:108 I think this is redundant. o instanceof MapInputPath is false if o == null
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java:134 can you please add a javadoc comment here?
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java:18 There are a lot of changes in MapOperator. I've scan through them and it seems most (all?) are just cleaning up the operator (which is great).

  Is that correct? If not can you please point out what the important changes are?

REVISION DETAIL
  https://reviews.facebook.net/D8121

To: JIRA, navis
Cc: hagleitn
, navis has commented on the revision "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java:600 It seemed I've changed this to avoid exceeding 100 character of line 620. I'll revert this.
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java:18 I should say that this patch was in patch-available state too long (I forgot what this was). But in the first look, this is much shorter than current and I like that. I'll add comment after reading this.
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java:108 There was this long long time ago. I'll remove that.
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java:134 Ok, sure.

REVISION DETAIL
  https://reviews.facebook.net/D8121

To: JIRA, navis
Cc: hagleitn
, navis has commented on the revision "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java:18 you are right, again. Nothing special but code cleansing (I think the patch is merged with other one by mistake). I can revert this for simplicity.

REVISION DETAIL
  https://reviews.facebook.net/D8121

To: JIRA, navis
Cc: hagleitn
, hagleitn has commented on the revision "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java:18 No, don't. I just wanted to understand. I think the new code is much cleaner. Just let me look at it closer tomorrow.

REVISION DETAIL
  https://reviews.facebook.net/D8121

To: JIRA, navis
Cc: hagleitn
, hagleitn has requested changes to the revision "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".

  Clean up in MapOperator looks good. If you could make the few small changes (documentation, variable name, redundant code) from the first review I think this is ready.

REVISION DETAIL
  https://reviews.facebook.net/D8121

BRANCH
  HIVE-3926

ARCANIST PROJECT
  hive

To: JIRA, hagleitn, navis
Cc: hagleitn
, Just a few small changes left. Otherwise looks great. You might also have to regenerate the ppd_vc.q.out. I got a diff when I ran it., navis updated the revision "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".

  Addressed comments

Reviewers: hagleitn, JIRA

REVISION DETAIL
  https://reviews.facebook.net/D8121

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D8121?vs=35703&id=36273#toc

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/metadata/VirtualColumn.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractBucketJoinProc.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractSMBJoinProc.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/AvgPartitionSizeBasedBigTableSelectorForAutoSMJ.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/BucketingSortingReduceSinkOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GlobalLimitOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/GroupByOptimizer.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/TableSizeBasedBigTableSelectorForAutoSMJ.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/listbucketingpruner/LBPartitionProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcCtx.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrOpProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartExprEvalUtils.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/TableScanDesc.java
  ql/src/test/queries/clientpositive/ppd_vc.q
  ql/src/test/results/clientpositive/ppd_vc.q.out

To: JIRA, hagleitn, navis
Cc: hagleitn
, 

{color:green}Overall{color}: +1 all checks pass

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12594320/HIVE-3926.D8121.5.patch

{color:green}SUCCESS:{color} +1 2653 tests passed

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/192/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/192/console

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.CleanupPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated., hagleitn has accepted the revision "HIVE-3926 [jira] PPD on virtual column of partitioned table is not working".

  LGTM

REVISION DETAIL
  https://reviews.facebook.net/D8121

BRANCH
  HIVE-3926

ARCANIST PROJECT
  hive

To: JIRA, hagleitn, navis
Cc: hagleitn
, +1 This looks good. Planning to commit tomorrow., [~navis] sorry patch doesn't apply cleanly anymore. I believe the conflict is with HIVE-4929. Can you please rebase?, Correction - I meant HIVE-4878., [~navis] I've taken the liberty to rebase for you if you like (patch .6). The only difference was in the PartitionPruner class where HIVE-4878 also added a new parameter. If that works for you I can commit that. Let me know., 

{color:green}Overall{color}: +1 all checks pass

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12594569/HIVE-3926.6.patch

{color:green}SUCCESS:{color} +1 2730 tests passed

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/214/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/214/console

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated., +1 will commit., Committed thanks Navis and Gunther., FAILURE: Integrated in Hive-trunk-hadoop2 #341 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/341/])
HIVE-3926 PPD on virtual column of partitioned table is not working (Navis Ryu and Gunther Hagleitner via egc) (ecapriolo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1511578)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/metadata/VirtualColumn.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractBucketJoinProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractSMBJoinProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AvgPartitionSizeBasedBigTableSelectorForAutoSMJ.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/BucketingSortingReduceSinkOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GlobalLimitOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GroupByOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/TableSizeBasedBigTableSelectorForAutoSMJ.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/listbucketingpruner/LBPartitionProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcCtx.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrOpProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartExprEvalUtils.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/TableScanDesc.java
* /hive/trunk/ql/src/test/queries/clientpositive/ppd_vc.q
* /hive/trunk/ql/src/test/results/clientpositive/ppd_vc.q.out
, FAILURE: Integrated in Hive-trunk-h0.21 #2252 (See [https://builds.apache.org/job/Hive-trunk-h0.21/2252/])
HIVE-3926 PPD on virtual column of partitioned table is not working (Navis Ryu and Gunther Hagleitner via egc) (ecapriolo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1511578)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/metadata/VirtualColumn.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractBucketJoinProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractSMBJoinProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AvgPartitionSizeBasedBigTableSelectorForAutoSMJ.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/BucketingSortingReduceSinkOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GlobalLimitOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GroupByOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/TableSizeBasedBigTableSelectorForAutoSMJ.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/listbucketingpruner/LBPartitionProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcCtx.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrOpProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartExprEvalUtils.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/TableScanDesc.java
* /hive/trunk/ql/src/test/queries/clientpositive/ppd_vc.q
* /hive/trunk/ql/src/test/results/clientpositive/ppd_vc.q.out
, FAILURE: Integrated in Hive-trunk-hadoop2 #344 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/344/])
HIVE-5026: HIVE-3926 is committed in the state of not rebased to trunk (Navis Ryu via Gunther Hagleitner) (gunther: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1511977)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
, Hi. Does this affect only map task, or also pruning before the job in metastore client? Non-partition columns are removed from metastore pruning, so I wonder if it makes sense to have this for metastore pruning., FAILURE: Integrated in Hive-trunk-h0.21 #2255 (See [https://builds.apache.org/job/Hive-trunk-h0.21/2255/])
HIVE-5026: HIVE-3926 is committed in the state of not rebased to trunk (Navis Ryu via Gunther Hagleitner) (gunther: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1511977)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
, [~navis] Could you answer Sergey's question? (Before it gets lost in Hudson noise)., ping? it affect HIVE-4985. Would running ppd_vc be sufficient to verify removal from metastore-specific pruning path?, I am not sure what is being asked. The virtual columns have file names and offsets into files, I am not seeing how this ties into the metastore., Virtual columns were added to the functions that, as far as I see, are only being called with the pruner expression that have been compacted to only contain partition columns. That is used to prune based on partition names when filter pushdown is not possible in metastore.
I am wondering if this could be dead code because virtual columns are also not present in that expression., FAILURE: Integrated in Hive-trunk-hadoop2-ptest #51 (See [https://builds.apache.org/job/Hive-trunk-hadoop2-ptest/51/])
HIVE-5026: HIVE-3926 is committed in the state of not rebased to trunk (Navis Ryu via Gunther Hagleitner) (gunther: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1511977)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
HIVE-3926 PPD on virtual column of partitioned table is not working (Navis Ryu and Gunther Hagleitner via egc) (ecapriolo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1511578)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/metadata/VirtualColumn.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractBucketJoinProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractSMBJoinProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AvgPartitionSizeBasedBigTableSelectorForAutoSMJ.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/BucketingSortingReduceSinkOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GlobalLimitOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GroupByOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/TableSizeBasedBigTableSelectorForAutoSMJ.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/listbucketingpruner/LBPartitionProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcCtx.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrOpProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartExprEvalUtils.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/TableScanDesc.java
* /hive/trunk/ql/src/test/queries/clientpositive/ppd_vc.q
* /hive/trunk/ql/src/test/results/clientpositive/ppd_vc.q.out
, SUCCESS: Integrated in Hive-trunk-hadoop1-ptest #122 (See [https://builds.apache.org/job/Hive-trunk-hadoop1-ptest/122/])
HIVE-5026: HIVE-3926 is committed in the state of not rebased to trunk (Navis Ryu via Gunther Hagleitner) (gunther: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1511977)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
HIVE-3926 PPD on virtual column of partitioned table is not working (Navis Ryu and Gunther Hagleitner via egc) (ecapriolo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1511578)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/Driver.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/MapOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/metadata/VirtualColumn.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractBucketJoinProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AbstractSMBJoinProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/AvgPartitionSizeBasedBigTableSelectorForAutoSMJ.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/BucketingSortingReduceSinkOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GenMapRedUtils.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GlobalLimitOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/GroupByOptimizer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/TableSizeBasedBigTableSelectorForAutoSMJ.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/listbucketingpruner/LBPartitionProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcCtx.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrExprProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/pcr/PcrOpProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartExprEvalUtils.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ppr/PartitionPruner.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/TableScanDesc.java
* /hive/trunk/ql/src/test/queries/clientpositive/ppd_vc.q
* /hive/trunk/ql/src/test/results/clientpositive/ppd_vc.q.out
, [~sershe] Compacting pruner predicate only removes nulls. It does not do removing non-partition column related expression. Without this, exception is thrown in the pruneBySequentialScan() method, like this,
{noformat}
Caused by: org.apache.hadoop.hive.ql.metadata.HiveException: java.lang.RuntimeException: cannot find field block__offset__inside__file from [org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector$MyField@12fb063, org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector$MyField@1e55d39, org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector$MyField@14b525c, org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector$MyField@c4c05]
	at org.apache.hadoop.hive.ql.optimizer.ppr.PartitionPruner.prune(PartitionPruner.java:231)
	at org.apache.hadoop.hive.ql.optimizer.pcr.PcrOpProcFactory$FilterPCR.process(PcrOpProcFactory.java:112)
	... 26 more
Caused by: java.lang.RuntimeException: cannot find field block__offset__inside__file from [org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector$MyField@12fb063, org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector$MyField@1e55d39, org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector$MyField@14b525c, org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector$MyField@c4c05]
	at org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorUtils.getStandardStructFieldRef(ObjectInspectorUtils.java:368)
	at org.apache.hadoop.hive.serde2.objectinspector.UnionStructObjectInspector.getStructFieldRef(UnionStructObjectInspector.java:100)
	at org.apache.hadoop.hive.ql.exec.ExprNodeColumnEvaluator.initialize(ExprNodeColumnEvaluator.java:55)
	at org.apache.hadoop.hive.ql.exec.ExprNodeGenericFuncEvaluator.initialize(ExprNodeGenericFuncEvaluator.java:121)
	at org.apache.hadoop.hive.ql.optimizer.ppr.PartExprEvalUtils.prepareExpr(PartExprEvalUtils.java:100)
	at org.apache.hadoop.hive.ql.optimizer.ppr.PartitionPruner.pruneBySequentialScan(PartitionPruner.java:330)
	at org.apache.hadoop.hive.ql.optimizer.ppr.PartitionPruner.prune(PartitionPruner.java:219)
	... 27 more
{noformat}, I think there should be a path which passes costly invocation of pruneBySequentialScan(). I'll book it as a following issue., It does filter non-partition columns in some cases, in HIVE-5047 there's a related problem.
, Let me double check... (I am making changes in HIVE-4985 and HIVE-4914, they are not quite ready yet though), I got around to this yesterday, the "null" values are actually put in the expr by PPRColumnExprProcessor in ExprProcFactory; it thus replaces non-partition columns, many functions, etc. compactExpr in Pruner then compacts the nulls.
The root problem is that ExprNodeColumnDesc doesn't distinguish partition and virtual columns, so partition columns also get there.
I will try to mitigate that in separate JIRA, however ExprNodeColumnDesc ctor w/isPartitionColOrVirtualCol arg is called in many places, so if they call cannot be easily replaced post-filtering can be done before expression gets to the pruner.
, This issue has been fixed and released as part of 0.12 release. If you find further issues, please create a new jira and link it to this one.]