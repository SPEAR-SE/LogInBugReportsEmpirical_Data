[*fix this bug.*
{code:java}
Index: src/main/java/org/apache/hadoop/hive/metastore/Warehouse.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- src/main/java/org/apache/hadoop/hive/metastore/Warehouse.java	(date 1515137061000)
+++ src/main/java/org/apache/hadoop/hive/metastore/Warehouse.java	(date 1515137079737)
@@ -43,6 +43,8 @@
 import org.apache.hadoop.fs.FileStatus;
 import org.apache.hadoop.fs.FileSystem;
 import org.apache.hadoop.fs.Path;
+import org.apache.hadoop.fs.permission.AclEntry;
+import org.apache.hadoop.fs.permission.AclStatus;
 import org.apache.hadoop.fs.permission.FsAction;
 import org.apache.hadoop.hive.common.FileUtils;
 import org.apache.hadoop.hive.common.HiveStatsUtils;
@@ -250,8 +252,10 @@
             return false;
         }
         final FileStatus stat;
+        final AclStatus aclStas;
         try {
             stat = getFs(path).getFileStatus(path);
+            aclStas = getFs(path).getAclStatus(path);
         } catch (FileNotFoundException fnfe){
             // File named by path doesn't exist; nothing to validate.
             return true;
@@ -266,23 +270,38 @@
         } catch (LoginException le) {
             throw new IOException(le);
         }
-        String user = ugi.getShortUserName();
+        String user = ugi.getShortUserName();   // kaikai
+        String[] groups = ugi.getGroupNames(); // groups 获取的是metastore的组用户信息。
         //check whether owner can delete
         if (stat.getOwner().equals(user) &&
                 stat.getPermission().getUserAction().implies(FsAction.WRITE)) {
             return true;
         }
+
         //check whether group of the user can delete
         if (stat.getPermission().getGroupAction().implies(FsAction.WRITE)) {
-            String[] groups = ugi.getGroupNames();
             if (ArrayUtils.contains(groups, stat.getGroup())) {
                 return true;
             }
         }
+
         //check whether others can delete (uncommon case!!)
         if (stat.getPermission().getOtherAction().implies(FsAction.WRITE)) {
             return true;
         }
+
+        // add extra
+        List<AclEntry> list = aclStas.getEntries();
+        for (AclEntry aclEntry : list){
+            if (aclEntry.getScope().toString() != "DEFAULT" && aclEntry.getPermission().implies(FsAction.WRITE) && aclEntry.getName() != "null"){
+                if (aclEntry.getType().toString() == "USER" && aclEntry.getName().equals(user)){
+                    LOG.info("acl user is" + aclEntry.getName() + ";" + "hive cli user is " + user);
+                    return true;
+                } else if (aclEntry.getType().toString() == "GROUP" && ArrayUtils.contains(groups, aclEntry.getName())){
+                    return true;
+                }
+            }
+        }
         return false;
     }
   /*

{code}
]