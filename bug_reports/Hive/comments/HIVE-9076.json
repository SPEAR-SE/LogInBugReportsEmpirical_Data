[What is the resultant file set after merging?
I would expect either
{code}
000000_0 (v12) (all v12 files merged together)
000000_1 (v11)
000000_1_copy_1 (v11)
000000_1_copy_2 (v11)
{code}
or
{code}
000000_0 (v11) (all v11 files merged together)
000000_0_copy_1 (v12) (this is actual 000000_0 file but renamed to 000000_0_copy_1 as merge output file has same name)
000000_0_copy_2 (v12) (this is actual 000000_0_copy_1 file but renamed to 000000_0_copy_2 as 000000_0_copy_1 exists)
000000_2 (v12)
{code}

Different order will also be possible as incompatFileSet iteration order might be different., [~navis] Log file should tell what files are renamed, moved and merged. Would it be possible to get the logs from OrcFileMergeOperator, AbstractFileMergeOperator and MergeFileMapper?, Result
{noformat}
hive (default)> dfs -ls ${hiveconf:hive.metastore.warehouse.dir}/orc_merge5b/;
Found 3 items
-rwxr-xr-x   1 navis supergroup       1203 2014-12-11 12:42 /user/hive/warehouse/orc_merge5b/000000_0
-rwxr-xr-x   1 navis supergroup        600 2014-12-11 12:33 /user/hive/warehouse/orc_merge5b/000000_1_copy1
-rwxr-xr-x   1 navis supergroup        600 2014-12-11 12:33 /user/hive/warehouse/orc_merge5b/000000_1_copy2
{noformat}

log
{noformat}
2014-12-11 12:42:14,843 INFO  exec.Task (SessionState.java:printInfo(825)) - Starting Job = job_1418171849140_0008, Tracking URL = http://localhost:8088/proxy/application_1418171849140_0008/
2014-12-11 12:42:14,843 INFO  exec.Task (SessionState.java:printInfo(825)) - Kill Command = /home/navis/hadoop-0.20/bin/hadoop job  -kill job_1418171849140_0008
2014-12-11 12:42:17,010 INFO  exec.Task (SessionState.java:printInfo(825)) - Hadoop job information for null: number of mappers: 0; number of reducers: 0
2014-12-11 12:42:17,064 WARN  mapreduce.Counters (AbstractCounters.java:getGroup(234)) - Group org.apache.hadoop.mapred.Task$Counter is deprecated. Use org.apache.hadoop.mapreduce.TaskCounter instead
2014-12-11 12:42:17,065 INFO  exec.Task (SessionState.java:printInfo(825)) - 2014-12-11 12:42:17,060 null map = 0%,  reduce = 0%
2014-12-11 12:42:21,200 WARN  mapreduce.Counters (AbstractCounters.java:getGroup(234)) - Group org.apache.hadoop.mapred.Task$Counter is deprecated. Use org.apache.hadoop.mapreduce.TaskCounter instead
2014-12-11 12:42:21,201 INFO  exec.Task (SessionState.java:printInfo(825)) - 2014-12-11 12:42:21,200 null map = 100%,  reduce = 0%
2014-12-11 12:42:21,206 WARN  mapreduce.Counters (AbstractCounters.java:getGroup(234)) - Group org.apache.hadoop.mapred.Task$Counter is deprecated. Use org.apache.hadoop.mapreduce.TaskCounter instead
2014-12-11 12:42:21,210 INFO  exec.Task (SessionState.java:printInfo(825)) - Ended Job = job_1418171849140_0008
2014-12-11 12:42:21,224 WARN  exec.Utilities (Utilities.java:removeTempOrDuplicateFiles(1977)) - Duplicate taskid file removed: hdfs://localhost:9000/tmp/hive/navis/80443669-b835-4a09-a73f-8b783d104f61/hive_2014-12-11_12-42-12_963_1945093075009681620-1/_tmp.-ext-10000/000000_1 with length 600. Existing file: hdfs://localhost:9000/tmp/hive/navis/80443669-b835-4a09-a73f-8b783d104f61/hive_2014-12-11_12-42-12_963_1945093075009681620-1/_tmp.-ext-10000/000000_0 with length 1203
2014-12-11 12:42:21,225 INFO  exec.AbstractFileMergeOperator (Utilities.java:mvFileToFinalPath(1805)) - Moving tmp dir: hdfs://localhost:9000/tmp/hive/navis/80443669-b835-4a09-a73f-8b783d104f61/hive_2014-12-11_12-42-12_963_1945093075009681620-1/_tmp.-ext-10000 to: hdfs://localhost:9000/tmp/hive/navis/80443669-b835-4a09-a73f-8b783d104f61/hive_2014-12-11_12-42-12_963_1945093075009681620-1/-ext-10000
2014-12-11 12:42:21,233 INFO  exec.AbstractFileMergeOperator (AbstractFileMergeOperator.java:jobCloseOp(247)) - jobCloseOp moved merged files to output dir: hdfs://localhost:9000/tmp/hive/navis/80443669-b835-4a09-a73f-8b783d104f61/hive_2014-12-11_12-42-12_963_1945093075009681620-1/-ext-10000
{noformat}, Thanks [~navis] for the logs and the patch! The patch mostly looks good except for the main() method in Utilities.java. +1 pending tests., [~navis] I am wondering how test cases doesn't show the missing file. Any idea? dfs -ls in test case still shows 4 files which is expected. , Test always makes file composition like below,
{noformat}
000000_0
000000_0_copy_1
000000_0_copy_2
000000_0_copy_3
000000_0_copy_4
000000_0_copy_5
{noformat}
The composition in description is caused by a bug which I've made (I'm in progress on HIVE-8814). But I think this should be fixed first., Preliminary test, 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12686775/HIVE-9076.2.patch.txt

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 6702 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_orc_merge_incompat1
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_truncate_column_merge
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_optimize_nullscan
org.apache.hadoop.hive.ql.exec.TestOperators.testFileSinkOperator
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2056/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2056/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-2056/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12686775 - PreCommit-HIVE-TRUNK-Build, Fixed test fails, 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12687375/HIVE-9076.3.patch.txt

{color:red}ERROR:{color} -1 due to 26 failed/errored test(s), 6706 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_infer_bucket_sort_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_lb_fs_stats
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_1
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_11
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_14
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_2
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_3
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_4
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_5
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_6
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_7
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_8
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_9
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_query_multiskew_1
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_query_multiskew_2
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_query_multiskew_3
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_smb_mapjoin9
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_truncate_column_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_vector_partition_diff_num_cols
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_optimize_nullscan
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_vector_partition_diff_num_cols
org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_list_bucket_dml_10
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_truncate_column_list_bucketing
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2090/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2090/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-2090/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 26 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12687375 - PreCommit-HIVE-TRUNK-Build, Fixed NPE, 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12687687/HIVE-9076.4.patch.txt

{color:red}ERROR:{color} -1 due to 1 failed/errored test(s), 6714 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_optimize_nullscan
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2109/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/2109/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-2109/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12687687 - PreCommit-HIVE-TRUNK-Build]