[https://reviews.facebook.net/D5565

It was hard. , I found a bug with semi join., navis updated the revision "HIVE-3381 [jira] Result of outer join is not valid".
Reviewers: JIRA

  Fixed and rebased on trunk


REVISION DETAIL
  https://reviews.facebook.net/D5565

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/JoinUtil.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/SMBMapJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/persistence/MapJoinObjectValue.java
  ql/src/test/results/clientpositive/auto_join21.q.out
  ql/src/test/results/clientpositive/auto_join29.q.out
  ql/src/test/results/clientpositive/auto_join7.q.out
  ql/src/test/results/clientpositive/auto_join_filters.q.out
  ql/src/test/results/clientpositive/join21.q.out
  ql/src/test/results/clientpositive/join7.q.out
  ql/src/test/results/clientpositive/join_1to1.q.out
  ql/src/test/results/clientpositive/join_filters.q.out
  ql/src/test/results/clientpositive/join_filters_overlap.q.out

To: JIRA, navis
, +1

@Navis: Can you test and commit this patch? Thanks., [~navis], can you hold off for a few days ? I also wanted to take a look at this., Namit,
Since this bug silently results in wrong results, I would like to have this fixed before 0.10 is released. Patch looks good to me. Will wait for your review., comments on phabricator, njain has commented on the revision "HIVE-3381 [jira] Result of outer join is not valid".

  Navis, I know I am asking pretty naive questions here, but I am not able to proceed.

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java:363 Can you add more comments everywhere ?
  I know that the old code also did not have many good comments, but it would be really
  useful.

  It is really difficult for me to be sure.
  I reviewed some test results, and they look fine.

  As you correctly said, this is hard. It would really help if you have a small example
  explained in comments in the code. It would really increase the maintainability of this
  code bigtime. Something like:

  for Query :::
  where the data is :::
  the aliasFilterTags will be::

  I know I am asking for too much, but this code is too risky to change.
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java:396 General comment: please add lots of comments for all the private functions.
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java:352 What is a skipvector ? Going to the comment below, can you explain with a query/data
  example. Same for offsets.


REVISION DETAIL
  https://reviews.facebook.net/D5565

To: JIRA, navis
Cc: njain
, navis has commented on the revision "HIVE-3381 [jira] Result of outer join is not valid".

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java:352 'skipVectors' has same meaning with 'inputNulls' in original source, which makes output value for the index(alias) to be filled with null. But doing this I always confused by it's name that it means value for the index(alias) is null, which can be true or false either. I'll change it to 'inputNulls' if you prefer.
  When inputNulls for some index is true, it gets metadata for the index and gets length for it and fills null for that length. 'offsets' is just pre-calculated values of such offsets.
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java:363 The problem is I'm also still not sure that this patch is right.
  I'll add more comments.
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java:396 ok.

REVISION DETAIL
  https://reviews.facebook.net/D5565

To: JIRA, navis
Cc: njain
, njain has commented on the revision "HIVE-3381 [jira] Result of outer join is not valid".

  Navis, I am not saying that the old code is good. On the contrary, it is really difficult to follow.
  There is serious lack of comments in that.
  But, we have to improve that - I really appreciate that you are fixing this very serious bug,
  but it would be really useful if you can add lots of comments so that it becomes much easier to
  maintain/enhance in future.

REVISION DETAIL
  https://reviews.facebook.net/D5565

To: JIRA, navis
Cc: njain
, navis updated the revision "HIVE-3381 [jira] Result of outer join is not valid".
Reviewers: JIRA

  1. Simplified code a little
  2. Added comments including example
  3. Rebased on trunk & passed all tests


REVISION DETAIL
  https://reviews.facebook.net/D5565

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/JoinUtil.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/SMBMapJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/persistence/MapJoinObjectValue.java
  ql/src/test/results/clientpositive/auto_join21.q.out
  ql/src/test/results/clientpositive/auto_join29.q.out
  ql/src/test/results/clientpositive/auto_join7.q.out
  ql/src/test/results/clientpositive/auto_join_filters.q.out
  ql/src/test/results/clientpositive/join21.q.out
  ql/src/test/results/clientpositive/join7.q.out
  ql/src/test/results/clientpositive/join_1to1.q.out
  ql/src/test/results/clientpositive/join_filters.q.out
  ql/src/test/results/clientpositive/join_filters_overlap.q.out

To: JIRA, navis
Cc: njain
, [~namit] Navis updated the patch after your comments. Can you take a re-look to see if your comments are addressed. Since this query results in silent failures, we ought to get it fixed soon., ping [~namitjain], Hi Navis,

Could you kindly refresh this patch as it does not apply cleanly anymore.

Thanks
Vikram., navis updated the revision "HIVE-3381 [jira] Result of outer join is not valid".

  Rebased to trunk. running test

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D5565

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D5565?vs=22947&id=30225#toc

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/JoinUtil.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/SMBMapJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/persistence/MapJoinObjectValue.java
  ql/src/test/results/clientpositive/auto_join21.q.out
  ql/src/test/results/clientpositive/auto_join29.q.out
  ql/src/test/results/clientpositive/auto_join7.q.out
  ql/src/test/results/clientpositive/auto_join_filters.q.out
  ql/src/test/results/clientpositive/join21.q.out
  ql/src/test/results/clientpositive/join7.q.out
  ql/src/test/results/clientpositive/join_1to1.q.out
  ql/src/test/results/clientpositive/join_filters.q.out
  ql/src/test/results/clientpositive/join_filters_overlap.q.out

To: JIRA, navis
Cc: njain
, navis updated the revision "HIVE-3381 [jira] Result of outer join is not valid".

  Fixed test results & passed all tests

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D5565

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D5565?vs=30225&id=30351#toc

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/JoinUtil.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/SMBMapJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/persistence/MapJoinObjectValue.java
  ql/src/test/results/clientpositive/auto_join21.q.out
  ql/src/test/results/clientpositive/auto_join29.q.out
  ql/src/test/results/clientpositive/auto_join7.q.out
  ql/src/test/results/clientpositive/auto_join_filters.q.out
  ql/src/test/results/clientpositive/join21.q.out
  ql/src/test/results/clientpositive/join7.q.out
  ql/src/test/results/clientpositive/join_1to1.q.out
  ql/src/test/results/clientpositive/join_filters.q.out
  ql/src/test/results/clientpositive/join_filters_overlap.q.out
  ql/src/test/results/clientpositive/mapjoin1.q.out

To: JIRA, navis
Cc: njain
, [~vikram.dixit] I guess you had some test case. Can you check if thats already covered in patch. If not, can you add that test case here? Also, would you like to verify .q.out changes of patch to make sure they look good to you?, After going through all of the .q.out changes in this patch, I see that those are the correct results. Great job [~navis]! Code is more readable and comments are great too.

+1 (non-binding)., I verified by running against mysql., These are some of my tests., [~navis] Can you refresh the patch? Not applying cleanly. I will test and commit it than. Also, it will be good to include vikram's tests while you are refreshing the patch., ashutoshc has accepted the revision "HIVE-3381 [jira] Result of outer join is not valid".

  +1 Running tests

REVISION DETAIL
  https://reviews.facebook.net/D5565

BRANCH
  DPAL-1739

ARCANIST PROJECT
  hive

To: JIRA, ashutoshc, navis
Cc: njain
, navis updated the revision "HIVE-3381 [jira] Result of outer join is not valid".

  Rebased to trunk (HIVE-3980) & added test (Thanks Vikram)

Reviewers: ashutoshc, JIRA

REVISION DETAIL
  https://reviews.facebook.net/D5565

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D5565?vs=30351&id=30495#toc

BRANCH
  DPAL-1739

ARCANIST PROJECT
  hive

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/JoinUtil.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/SMBMapJoinOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/exec/persistence/MapJoinObjectValue.java
  ql/src/test/queries/clientpositive/mapjoin_test_outer.q
  ql/src/test/results/clientpositive/auto_join21.q.out
  ql/src/test/results/clientpositive/auto_join29.q.out
  ql/src/test/results/clientpositive/auto_join7.q.out
  ql/src/test/results/clientpositive/auto_join_filters.q.out
  ql/src/test/results/clientpositive/join21.q.out
  ql/src/test/results/clientpositive/join7.q.out
  ql/src/test/results/clientpositive/join_1to1.q.out
  ql/src/test/results/clientpositive/join_filters.q.out
  ql/src/test/results/clientpositive/join_filters_overlap.q.out
  ql/src/test/results/clientpositive/mapjoin1.q.out
  ql/src/test/results/clientpositive/mapjoin_test_outer.q.out

To: JIRA, ashutoshc, navis
Cc: njain
, Committed to trunk. Thanks, Navis!, Finally! Thanks to all., Integrated in Hive-trunk-h0.21 #2033 (See [https://builds.apache.org/job/Hive-trunk-h0.21/2033/])
    HIVE-3381 : Result of outer join is not valid (Navis via Ashutosh Chauhan) (Revision 1461234)

     Result = ABORTED
hashutosh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1461234
Files : 
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/JoinUtil.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/SMBMapJoinOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/persistence/MapJoinObjectValue.java
* /hive/trunk/ql/src/test/queries/clientpositive/mapjoin_test_outer.q
* /hive/trunk/ql/src/test/results/clientpositive/auto_join21.q.out
* /hive/trunk/ql/src/test/results/clientpositive/auto_join29.q.out
* /hive/trunk/ql/src/test/results/clientpositive/auto_join7.q.out
* /hive/trunk/ql/src/test/results/clientpositive/auto_join_filters.q.out
* /hive/trunk/ql/src/test/results/clientpositive/join21.q.out
* /hive/trunk/ql/src/test/results/clientpositive/join7.q.out
* /hive/trunk/ql/src/test/results/clientpositive/join_1to1.q.out
* /hive/trunk/ql/src/test/results/clientpositive/join_filters.q.out
* /hive/trunk/ql/src/test/results/clientpositive/join_filters_overlap.q.out
* /hive/trunk/ql/src/test/results/clientpositive/mapjoin1.q.out
* /hive/trunk/ql/src/test/results/clientpositive/mapjoin_test_outer.q.out
, Integrated in Hive-trunk-hadoop2 #138 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/138/])
    HIVE-3381 : Result of outer join is not valid (Navis via Ashutosh Chauhan) (Revision 1461234)

     Result = FAILURE
hashutosh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1461234
Files : 
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/CommonJoinOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/HashTableSinkOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/JoinOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/JoinUtil.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/MapJoinOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/SMBMapJoinOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/persistence/MapJoinObjectValue.java
* /hive/trunk/ql/src/test/queries/clientpositive/mapjoin_test_outer.q
* /hive/trunk/ql/src/test/results/clientpositive/auto_join21.q.out
* /hive/trunk/ql/src/test/results/clientpositive/auto_join29.q.out
* /hive/trunk/ql/src/test/results/clientpositive/auto_join7.q.out
* /hive/trunk/ql/src/test/results/clientpositive/auto_join_filters.q.out
* /hive/trunk/ql/src/test/results/clientpositive/join21.q.out
* /hive/trunk/ql/src/test/results/clientpositive/join7.q.out
* /hive/trunk/ql/src/test/results/clientpositive/join_1to1.q.out
* /hive/trunk/ql/src/test/results/clientpositive/join_filters.q.out
* /hive/trunk/ql/src/test/results/clientpositive/join_filters_overlap.q.out
* /hive/trunk/ql/src/test/results/clientpositive/mapjoin1.q.out
* /hive/trunk/ql/src/test/results/clientpositive/mapjoin_test_outer.q.out
]