[

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12875345/HIVE-17008.0.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 10830 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[llap_smb] (batchId=143)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_basic] (batchId=140)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=145)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=232)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=232)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=177)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=177)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=177)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/5857/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/5857/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-5857/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12875345 - PreCommit-HIVE-Build, [~dan_impala_9180], the changes aren't clear to me, look like changes in indentation. Could you add a review board link ?

Also, could you add the NPE stracktrace you are seeing to the description ?

You also need a unit test here, perhaps in TestDbNotificationListener , Hi [~mohitsabharwal], here is a better diff of the patch: https://github.com/danburkert/hive/commit/ec115a584c4b2b715f339458afc2bcbf353d1e47?w=1.  Since filing this bug / uploading the patch I've found that the HMS can fire event listeners on almost any type of failed DDL operation: drop database, create table, partitions, functions, indices, etc.  The patch only fixes the drop database case, but the fix is pretty much the same.  It's not clear to me what the designed behavior is, though.  Are these just copy/pasted bugs, or is it by design that the HMS notifies listeners for failed DDL operations?, Thanks, [~dan_impala_9180]. There are two flavors of listeners in each DDL operation, one which runs in the same transaction as the DDL event (notify only upon success) and one which run outside the transaction (can notify failed DDL operations as well).  Where exactly is the NPE - I assume somewhere down the notifyEvent stack ?

+ [~spena], who has worked on this recently., I'm observing these events through the [notification log API|https://github.com/danburkert/hive/blob/master/metastore/if/hive_metastore.thrift#L1546-L1549].  Is it expected that {{ThriftHiveMetastore.get_next_notification}} returns events for failed DDL operations?  There isn't any way to discern whether or not the event failed just from the {{NotificationEvent}} struct.

> Where exactly is the NPE - I assume somewhere down the notifyEvent stack ?

The NPE is thrown inside the notification event listener, because {{db}} can be null on [this line|https://github.com/apache/hive/blob/master/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java?utf8=%E2%9C%93#L1139]., {{ListenerEvent}} has the success flag, so listener implementation can choose to ignore failed events. But {{DbNotificationListener}} and {{HMSMetricsListener}} are ignoring the status flag.  The old {{NotificationListener}} though is looking at the flag and only logging successful events.

This does look like something we should make consistent, not just address the NPE. [~sushanth], [~thejas], [~akolb], do you have any thoughts ?, There should be no events when the operation failed. This is a bug in the notification processing., Looking at the code, the actual operation is for some reason considered successfull which means that there should be an event and it shouldn't throw NPE.

Here is the relevant check: https://github.com/apache/hive/blob/master/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java?utf8=✓#L1119, My comment yesterday evening was a bit brief because I was low on time, but here's the exact sequence of events that leads to the NPE which originally prompted this issue.  As we've discussed it's just one of many inter-related issues in the class, but I wanted to make it clear what's happening in this specific case:

1. Application calls {{ThriftHiveMetastore.drop_database}} with a non-existent database name via the HMS thrift API¹.
2. In {{HiveMetaStore.drop_database_core}}, the {{db}} local variable is [initialized to {{null}}|https://github.com/apache/hive/blob/555f001146c4fc471e29e18899a0e02a4043cca5/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java#L1023].
3. In {{HiveMetaStore.drop_database_core}}, the [lookup of the non-existent database fails|https://github.com/apache/hive/blob/555f001146c4fc471e29e18899a0e02a4043cca5/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java#L1029], leaving {{db}} set to {{null}} and unwinding to the {{finally}} block.
4. In {{HiveMetaSotre.drop_database_core}} {{finally}} block, a new [{{DropDatabaseEvent}} is created|https://github.com/apache/hive/blob/555f001146c4fc471e29e18899a0e02a4043cca5/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java#L1139-L1143] with the {{null}} database, and listeners are notified with this event.
5. Somewhere (I haven't traced this bit), the notification log event listener is dereferencing the null database.

¹ Although I haven't reproduced it, it should be possible to reproduce this bug through the Java {{HiveMetastoreClient}} API as well, but it would require concurrent DDL operations.  The {{HiveMetastoreClient}} [checks that the database exists|https://github.com/apache/hive/blob/master/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStoreClient.java#L851-L858] before attempting to drop it; this is a benign TOCTOU which makes it difficult to reproduce using that API (again, it should still possible with the right interleavings of concurrent DDL ops).  A light skimming through that class reveals that the client is very aggressive about validating state exists before issuing DDL operations.  Just my opinion, but that's a big code smell; the client should rely on the server to validate arguments., Canceling patch, since it's clear that it is intended behavior to notify listeners on failed DDL ops., [~dan@danburkert.com] Are you working on the fix for this issue? If not, we should hand it to someone who does., [~akolb] I'm playing around with a fix [here|https://github.com/danburkert/hive/commit/e8b2527ae0fbdff1df2a3b102cba1e0c3cd89e4b?w=1], but it doesn't appear to work quite correctly.  It's fine with me if someone else wants to jump on this an assign it to themselves; I think it should be a high priority bug., New patch attached.  Here's a [whitespace-ignored diff|https://github.com/danburkert/hive/commit/b9ff26eccc3733d00f1702c8178cf5b942078485?w=1].  I got to the bottom of the issue I alluded to earlier: the ctor args for {{DropTableEvent}} were mis-ordered in {{HiveMetaStore}}, I've included the fix in this patch., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12879261/HIVE-17008.2.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 11013 tests executed
*Failed tests:*
{noformat}
TestPerfCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[materialized_view_create_rewrite] (batchId=240)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[llap_smb] (batchId=144)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_vectorized_dynamic_partition_pruning] (batchId=168)
org.apache.hadoop.hive.metastore.TestHiveMetaStoreStatsMerge.testStatsMerge (batchId=206)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=179)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=179)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=179)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6170/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6170/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6170/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12879261 - PreCommit-HIVE-Build, Hi all, I'd like to pass this off to someone with more experience getting Hive patches merged., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12880801/HIVE-17008.3.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 12 failed/errored test(s), 10993 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[insert_overwrite_local_directory_1] (batchId=240)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[llap_uncompressed] (batchId=56)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[orc_merge_incompat2] (batchId=80)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[columnstats_part_coltype] (batchId=159)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_dynamic_partition_pruning_mapjoin_only] (batchId=170)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_vectorized_dynamic_partition_pruning] (batchId=169)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=100)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3] (batchId=99)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=235)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=180)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=180)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=180)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6295/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6295/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6295/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 12 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12880801 - PreCommit-HIVE-Build, HIVE-17008.3.patch looks good to me.
+1 pending tests, Pushed to master.
Thanks [~danburkert] and [~zsombor.klara] for the patch!, Re-opening and assigning to myself, to get this into branch-2, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12895551/HIVE-17008.2-branch-2.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 11 failed/errored test(s), 10659 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[explaindenpendencydiffengs] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[llap_smb] (batchId=142)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_basic] (batchId=139)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[table_nonprintable] (batchId=140)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[join_acid_non_acid] (batchId=158)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=153)
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testCliDriver[merge_negative_5] (batchId=88)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[explaindenpendencydiffengs] (batchId=115)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vectorized_ptf] (batchId=125)
org.apache.hive.hcatalog.api.TestHCatClient.testTransportFailure (batchId=176)
org.apache.hive.jdbc.TestJdbcDriver2.testYarnATSGuid (batchId=222)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/7624/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/7624/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-7624/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 11 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12895551 - PreCommit-HIVE-Build, Merged into branch-2.3, Hive 3.0.0 has been released so closing this jira.]