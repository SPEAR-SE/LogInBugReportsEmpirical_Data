[Need to sort out the includes and propagate them to when async data is cached; make sure cleanup on error makes sense; and clean up the code., The patch v1. Haven't run in the cluster yet, Looks like ORC is still blocking. Will take a look tomorrow., Updated the async caching to not lock up the IO thread and instead do everything on that thread., [~gopalv] [~prasanth_j] ping? :), 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12849638/HIVE-15672.02.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 11003 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=140)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_varchar_simple] (batchId=153)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3] (batchId=93)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=223)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=223)
org.apache.hadoop.hive.llap.registry.impl.TestSlotZnode.testConcurrencyAndFallback (batchId=165)
org.apache.hive.jdbc.TestJdbcDriver2.testSelectExecAsync2 (batchId=215)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3223/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3223/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3223/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12849638 - PreCommit-HIVE-Build, A small update to change the queue to non-blocking; signalling that the blocking queue is not empty showed up in profile. I think it's ok to poll with fallback on ORC thread, since it's not blocking the query., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12850104/HIVE-15672.03.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 11010 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_varchar_simple] (batchId=153)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=223)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3275/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3275/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3275/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12850104 - PreCommit-HIVE-Build, A probable fix for inconsistent results returned if eviction happens sometimes, found by [~gopalv], 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12850366/HIVE-15672.04.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 11017 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=223)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=223)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3296/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3296/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3296/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12850366 - PreCommit-HIVE-Build, Will have to look at it again. Don't have the full context of the text cache yet., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12850751/HIVE-15672.05.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 11027 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=140)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_varchar_simple] (batchId=153)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=223)
org.apache.hadoop.hive.llap.daemon.impl.TestTaskExecutorService.testWaitQueuePreemption (batchId=282)
org.apache.hive.service.server.TestHS2HttpServer.testContextRootUrlRewrite (batchId=186)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3348/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3348/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3348/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12850751 - PreCommit-HIVE-Build, +1, Rebasing the patch after ORC merge, also fixing some issues introduced during that. , 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12851260/HIVE-15672.06.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 3 failed/errored test(s), 10203 tests executed
*Failed tests:*
{noformat}
TestCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=8)
	[columnstats_tbllvl.q,authorization_load.q,udf_md5.q,insert_into_with_schema.q,groupby_sort_6.q,convert_enum_to_string.q,decimal_udf.q,vector_cast_constant.q,encryption_insert_partition_static.q,annotate_stats_filter.q,sort_merge_join_desc_8.q,udf_format_number.q,input8.q,orc_merge_incompat3.q,constGby.q,groupby_sort_test_1.q,sort_merge_join_desc_1.q,authorization_update.q,authorization_cli_createtab_noauthzapi.q,ba_table3.q,tez_insert_overwrite_local_directory_1.q,nested_complex.q,exim_09_part_spec_nonoverlap.q,druid_basic1.q,auto_join11.q,equal_ns.q,null_cast.q,groupby_sort_skew_1_23.q,skewjoinopt12.q,compute_stats_decimal.q]
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3407/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3407/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3407/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12851260 - PreCommit-HIVE-Build, The CliDriver failure is due to a build issue:
{noformat}
ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:2.19.1:test (default-test) on project hive-it-qfile: Unable to generate classpath: org.apache.maven.artifact.resolver.ArtifactResolutionException: Unable to get dependency information for org.apache.maven.surefire:surefire-junit4:jar:2.19.1: Failed to retrieve POM for org.apache.maven.surefire:surefire-junit4:jar:2.19.1: Could not transfer artifact org.apache.maven.surefire:surefire-junit4:pom:2.19.1 from/to central (https://repo.maven.apache.org/maven2): handshake alert:  unrecognized_name{noformat}, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12851442/HIVE-15672.07.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 10131 tests executed
*Failed tests:*
{noformat}
TestCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=20)
	[timestamp_comparison.q,rename_column.q,union5.q,insert_into1.q,drop_udf.q,alter3.q,cast_qualified_types.q,vectorization_4.q,disable_file_format_check.q,vector_left_outer_join.q,decimal_1_1.q,alter_index.q,correlationoptimizer7.q,annotate_stats_table.q,skewjoinopt9.q,llap_partitioned.q,skewjoinopt3.q,skewjoinopt19.q,ba_table_union.q,index_compact.q,vector_date_1.q,join_merge_multi_expressions.q,partition_multilevels.q,sort_merge_join_desc_2.q,varchar_udf1.q,alter_varchar2.q,orc_dictionary_threshold.q,semijoin.q,input_testxpath3.q,rcfile_bigdata.q]
TestCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=23)
	[part_inherit_tbl_props_with_star.q,avro_add_column.q,ba_table_udfs.q,orc_diff_part_cols2.q,ivyDownload.q,null_column.q,quote1.q,empty_dir_in_table.q,vectorization_part_project.q,skewjoinopt4.q,alter_partition_change_col.q,truncate_column_buckets.q,infer_bucket_sort_list_bucket.q,show_conf.q,authorization_create_table_owner_privs.q,bucketsortoptimize_insert_4.q,interval_udf.q,join_grp_diff_keys.q,custom_input_output_format.q,vectorized_bucketmapjoin1.q,skewjoinopt5.q,udaf_ngrams.q,vector_count_distinct.q,input_part9.q,drop_partitions_filter.q,char_varchar_udf.q,list_bucket_dml_13.q,union33.q,authorization_grant_option_role.q,union_lateralview.q]
TestCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=6)
	[ptf_general_queries.q,correlationoptimizer9.q,cross_join_merge.q,parquet_decimal.q,join1.q,bucket_if_with_path_filter.q,join32_lessSize.q,combine2.q,orc_predicate_pushdown.q,escape3.q,cbo_rp_outer_join_ppr.q,windowing_range_multiorder.q,cte_mat_4.q,udf_weekofyear.q,masking_disablecbo_4.q,char_pad_convert.q,groupby9.q,udaf_covar_samp.q,lock1.q,parquet_columnar.q,skewjoinopt18.q,colstats_all_nulls.q,union_remove_18.q,groupby_duplicate_key.q,pointlookup3.q,orc_remove_cols.q,udf_classloader.q,subq2.q,ctas.q,setop_subq.q]
TestCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=7)
	[orc_ppd_decimal.q,groupby_map_ppr.q,input_part1.q,udf_when.q,union14.q,add_part_exist.q,orc_min_max.q,subquery_unqual_corr_expr.q,print_header.q,groupby_sort_1.q,masking_8.q,smb_mapjoin_25.q,alter_change_db_location.q,update_all_non_partitioned.q,partition_wise_fileformat6.q,udf_minute.q,udf_sha1.q,parquet_ppd_partition.q,order2.q,alter_table_serde.q,drop_view.q,union_remove_4.q,delimiter.q,udaf_collect_set.q,combine3.q,authorization_view_4.q,show_describe_func_quotes.q,encryption_load_data_to_encrypted_tables.q,partition_wise_fileformat11.q,bucketsortoptimize_insert_6.q]
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=140)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=223)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=223)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3419/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3419/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3419/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12851442 - PreCommit-HIVE-Build, Small update based on RB, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12851520/HIVE-15672.08.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10241 tests executed
*Failed tests:*
{noformat}
TestDerbyConnector - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestEncryptedHDFSCliDriver.testCliDriver[encryption_join_with_different_encryption_keys] (batchId=159)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=223)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=223)
org.apache.hive.hcatalog.pig.TestTextFileHCatStorer.testWriteDate2 (batchId=173)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3427/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3427/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3427/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12851520 - PreCommit-HIVE-Build, [~owen.omalley] ping?, Committed to master. Thanks for the reviews!, Doc note:  This adds *hive.llap.io.encode.vector.serde.async.enabled* to HiveConf.java, so it needs to be documented in the wiki for release 2.2.0.

* [Configuration Properties -- LLAP I/O | https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties#ConfigurationProperties-LLAPI/O]

Added a TODOC2.2 label.]