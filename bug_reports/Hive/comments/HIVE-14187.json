[[~mohitsabharwal] Thanks for the patch. However, this will still not completely fix the issue as the the JDOPersistenceManager is cached in thread locals and threads in a threadpool can die randomly causing the objects to get accumulated. This was fixed in HIVE-7353, HIVE-9831 for HS2. Maybe we can take a similar approach here?, Thanks [~vgumashta]. I took a quick look at HIVE-7353 and had a question. Regarding the comment "the threadpools keep a certain number of threads live and kill excess threads after a configurable keepAliveTime expires ... ideally this is where we'd plug in code to close the JDOPersistanceManager" -- this applies only to those threads where JDOPersistanceManager#close was not already called, correct ? 

In the remote metastore case, deleteContext() will get executed when the underling transport gets closed for that thread (in WorkerProcess Runnable run() method). 
https://github.com/apache/thrift/blob/master/lib/java/src/org/apache/thrift/server/TThreadPoolServer.java#L300
In this patch, we call cleanupRawStore inside deleteContext() (which calls JDOPersistanceManager#close)
(If the client explicitly already called IMetaStoreClient#close on that connection, then the deleteContext() triggered cleanup will be a no-op.) 

I haven't looked at ThreadPoolExecutor code, but docs say "even core threads are initially created and started only when new tasks arrive", 
i.e. threads won't get pre-created (only to be killed later after keepalive timeout), but will get created when request arrives (which means
there will be a transport associated with it, which will trigger deleteContext() upon connection break). IOW, thread goes back to the pool
only after the deleteContext is called. And subsequently may get killed after keepalive timeout.

So, unless someone manually kills the thread, it seems to me that deleteContext() covers the cleanup. (deleteContext() call is in the finally
block so that covers errors/exceptions). What do you think ? 
, [~vgumashta], do you have more input on the patch ? thanks. 

 , Re-attaching patch, looks like didn't get triggered due to ptest issues., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12817473/HIVE-14187.patch

{color:red}ERROR:{color} -1 due to build exiting with an error

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/491/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/491/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-491/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Tests exited with: NonZeroExitCodeException
Command 'bash /data/hive-ptest/working/scratch/source-prep.sh' failed with exit status 1 and output '+ [[ -n /usr/java/jdk1.8.0_25 ]]
+ export JAVA_HOME=/usr/java/jdk1.8.0_25
+ JAVA_HOME=/usr/java/jdk1.8.0_25
+ export PATH=/usr/java/jdk1.8.0_25/bin/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
+ PATH=/usr/java/jdk1.8.0_25/bin/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
+ export 'ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m '
+ ANT_OPTS='-Xmx1g -XX:MaxPermSize=256m '
+ export 'M2_OPTS=-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128'
+ M2_OPTS='-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128'
+ cd /data/hive-ptest/working/
+ tee /data/hive-ptest/logs/PreCommit-HIVE-MASTER-Build-491/source-prep.txt
+ [[ false == \t\r\u\e ]]
+ mkdir -p maven ivy
+ [[ git = \s\v\n ]]
+ [[ git = \g\i\t ]]
+ [[ -z master ]]
+ [[ -d apache-github-source-source ]]
+ [[ ! -d apache-github-source-source/.git ]]
+ [[ ! -d apache-github-source-source ]]
+ cd apache-github-source-source
+ git fetch origin
From https://github.com/apache/hive
   deeddf4..82e1551  master     -> origin/master
   a349f56..1072c3a  branch-2.1 -> origin/branch-2.1
+ git reset --hard HEAD
HEAD is now at deeddf4 HIVE-14139: NPE dropping permanent function (Rui reviewed by Sergey Shelukhin)
+ git clean -f -d
+ git checkout master
Already on 'master'
Your branch is behind 'origin/master' by 1 commit, and can be fast-forwarded.
  (use "git pull" to update your local branch)
+ git reset --hard origin/master
HEAD is now at 82e1551 HIVE-14158: Support masking and filtering of rows/columns: deal with derived column names (Pengcheng Xiong, reviewed by Ashutosh Chauhan) (addendum)
+ git merge --ff-only origin/master
Already up-to-date.
+ git gc
+ patchCommandPath=/data/hive-ptest/working/scratch/smart-apply-patch.sh
+ patchFilePath=/data/hive-ptest/working/scratch/build.patch
+ [[ -f /data/hive-ptest/working/scratch/build.patch ]]
+ chmod +x /data/hive-ptest/working/scratch/smart-apply-patch.sh
+ /data/hive-ptest/working/scratch/smart-apply-patch.sh /data/hive-ptest/working/scratch/build.patch
The patch does not appear to apply with p0, p1, or p2
+ exit 1
'
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12817473 - PreCommit-HIVE-MASTER-Build, [~mohitsabharwal] Thanks for the details. Makes sense, I'm +1 on the patch (might need rebase for QA run)., Thanks for review [~vgumashta].  Attaching patch after rebase., Attaching patch after correct rebase this time., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12817853/HIVE-14187.2.patch

{color:green}SUCCESS:{color} +1 due to 4 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 11 failed/errored test(s), 10324 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_acid_globallimit
org.apache.hadoop.hive.cli.TestMinimrCliDriver.org.apache.hadoop.hive.cli.TestMinimrCliDriver
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testCheckPermissions
org.apache.hadoop.hive.llap.daemon.impl.TestLlapTokenChecker.testGetToken
org.apache.hadoop.hive.metastore.TestMetaStoreMetrics.testConnections
org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler.org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/514/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/514/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-514/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 11 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12817853 - PreCommit-HIVE-MASTER-Build, Confirmed that test failures are unrelated.  TestMetaStoreMetrics#testConnections appeared related, but is failing locally for me without this patch as well., Thanks,
+1, thanks [~mohitsabharwal] I committed this to 2.2]