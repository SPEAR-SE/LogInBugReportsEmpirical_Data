[kevinwilfong requested code review of "HIVE-2758 [jira] Metastore is caching too aggressively".
Reviewers: JIRA

  https://issues.apache.org/jira/browse/HIVE-2758

  In order to prevent inconsistencies between Hive clients and Hive metastores due to over-aggressive caching, I turned off level 2 caching in datanucleus.  I tried adjusting it to weak caching first, but that did not fix the issue.  I think level 1 caching is the most caching we can have without seeing these issues.

  The metastore is caching values, like table names and locations too aggressively, leading to inconsistencies across Hive clients and metastore Thrift servers.

  For example, open two Hive clients, in each call
  DESCRIBE FORMATTED table_foo;

  Then in one of those clients, execute
  ALTER TABLE table_foo RENAME TO table_bar;

  Then in both clients call
  DESCRIBE FORMATTED table_bar;

  In the client that executed the alter command, the location is correct, however, in the other Hive client, it will still show the original location of table_foo.

  A similar experiment can be done using metastore Thrift servers, substituting get_table for DESCRIBE FORMATTED and alter_table for ALTER TABLE ... RENAME TO.

  On the Thrift server you can see that the one which did not execute the alter command, not only returns the wrong location, despite calling get_table('table_bar') it will return a table that still has the name table_foo.

TEST PLAN
  EMPTY

REVISION DETAIL
  https://reviews.facebook.net/D1491

AFFECTED FILES
  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java

MANAGE HERALD DIFFERENTIAL RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/3105/

Tip: use the X-Herald-Rules header to filter Herald messages in your client.
, cwsteinbach has requested changes to the revision "HIVE-2758 [jira] Metastore is caching too aggressively".

INLINE COMMENTS
  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java:276 It would be good to have test coverage for this. Can you please add a testcase?

REVISION DETAIL
  https://reviews.facebook.net/D1491
, kevinwilfong updated the revision "HIVE-2758 [jira] Metastore is caching too aggressively".
Reviewers: JIRA, njain, heyongqiang, cwsteinbach

  Added a unit test to the metastore tests.  It creates a table using the current HiveMetaStoreClient, then simulates another client renaming the table by changing the value in the db.  It then attempts to get the table again using the new name and verifying the name of the table is correct.  This test is used for both the metastore Thrift server and an embedded metastore.

  Using the current configuration, it fails with the exception
  "Client returned table with different name after rename. expected:<[]concurrenttbl> but was:<[rename_]concurrenttbl>"
  Indicating that the client can retrieve the table with the new name, but when it checks the name stored in the Table object, it is still the old name.
  Using the update in this patch, however, it succeeds.

REVISION DETAIL
  https://reviews.facebook.net/D1491

AFFECTED FILES
  metastore/src/test/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java
  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java
, cwsteinbach has accepted the revision "HIVE-2758 [jira] Metastore is caching too aggressively".

  +1. Kevin, can you handle testing and committing this change?

REVISION DETAIL
  https://reviews.facebook.net/D1491
, kevinwilfong has commented on the revision "HIVE-2758 [jira] Metastore is caching too aggressively".

  Thanks, Carl.  I got it.

REVISION DETAIL
  https://reviews.facebook.net/D1491
, Integrated in Hive-trunk-h0.21 #1238 (See [https://builds.apache.org/job/Hive-trunk-h0.21/1238/])
    HIVE-2758 Metastore is caching too aggressively (Kevin Wilfong reviewed by Carl Steinbach)

kevinwilfong : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1239232
Files : 
* /hive/trunk/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java
* /hive/trunk/metastore/src/test/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java
, This issue is closed now. It was released with the fix in 0.9.0. If there is a problem, please open a new jira and link this one with that., Integrated in Hive-trunk-hadoop2 #54 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/54/])
    HIVE-2758 Metastore is caching too aggressively (Kevin Wilfong reviewed by Carl Steinbach) (Revision 1239232)

     Result = ABORTED
kevinwilfong : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1239232
Files : 
* /hive/trunk/common/src/java/org/apache/hadoop/hive/conf/HiveConf.java
* /hive/trunk/metastore/src/test/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java
]