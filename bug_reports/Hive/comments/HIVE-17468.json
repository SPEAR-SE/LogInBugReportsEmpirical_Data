[[~bslim], for this fix wouldn't it be enough to exclude those coming from {{calcite-druid}}? Those three jackson dependencies that we exclude, we are including them into the uber jar via shading/renaming. As far as I remember, otherwise they might create conflicts with those used by Hive., [~jcamachorodriguez] not sure am following your thought, if we exclude all the druid stuff then what is left is not what we want is going to be either hive jackson ones or from other transitive dependency. 
My take on this is that the lib that are needed and brought by druid it will be shaded anyway so no druid-jackson will be on the class path.
Please let me know if that make sens ?, {quote}
if we exclude all the druid stuff then what is left is not what we want is going to be either hive jackson ones or from other transitive dependency. 
{quote}

[~bslim], before we pulled the calcite-druid package, were we packing then the hive jackson dependencies into the uber jar? How was that ever working?, It was pulling random stuff from transitive dependencies 
bq. slim bouguerra, before we pulled the calcite-druid package, were we packing then the hive jackson dependencies into the uber jar? How was that ever working, Hmm.. wouldn't this in turn break the calcite dependency, especially since it's using the newer version?, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12885683/HIVE-17468.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 11028 tests executed
*Failed tests:*
{noformat}
TestAccumuloCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=230)
TestDummy - did not produce a TEST-*.xml file (likely timed out) (batchId=230)
TestTxnCommandsBase - did not produce a TEST-*.xml file (likely timed out) (batchId=280)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=61)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=100)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=234)
org.apache.hadoop.hive.druid.TestHiveDruidQueryBasedInputFormat.testTimeZone (batchId=247)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6704/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6704/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6704/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12885683 - PreCommit-HIVE-Build, [~sershe] thanks good catch ! not sure why calcite is packaged within the uber jar. [~jcamachorodriguez] do we need the calcite dependency within the Uber jar ? thought it is on the hive server class path anyway right ? , [~jcamachorodriguez] looking at the code more am not sure why do we need the calcite and avatica dependencies ? , [~bslim], about the avatica dependency, I am not sure, I think it is not needed. About calcite, a quick check shows that it is used by the record writer, which is executed by the clients writing the records in Druid and thus might not have Calcite in their classpath. That must be the reason why it is included in the uber jar (you can double check if there are other classes that are not executed at HS2 side that need it, I did not check further)., [~jcamachorodriguez] i can see any ref to calcite in the druid record writer. Removing all the calcite the code still compile and run tests.
, [~bslim], yes, the problem will be in a distributed environment, e.g., in Tez, when you have to send the jar around, right? In your local machine or if you run in a single node mode, Calcite will be indeed available.

https://github.com/apache/hive/blob/master/druid-handler/src/java/org/apache/hadoop/hive/druid/io/DruidRecordWriter.java#L44, [~jcamachorodriguez] 
1 looking at the deps i see calcite-druid is a dependency for hive exec anyway thus it is always on the classpath if am not wrong https://github.com/b-slim/hive/blob/453c8ed4ed17d215e367fbdd22fb082d1b0f48e4/ql/pom.xml#L397.
2 that usage you pointed is actually very minimal (a constant) thus we can either remove it or and use the dependency from hive exec that is on the tez class path as well.
, About 1), hive-exec bundle does not include calcite (https://github.com/b-slim/hive/blob/453c8ed4ed17d215e367fbdd22fb082d1b0f48e4/ql/pom.xml#L858), thus it seems it will not be necessarily available in the client classpath at execution time.

About 2), that is OK, I think it is the way to go so we can get rid of the dependency. We just need to make sure there is no any other calcite dependency needed at execution time.
, [~jcamachorodriguez] thanks please check the new patch i added a test to make sure both constants match., actually my bad still see that Localtime is a calcite thingy, let me see if we can substitute this with java primitive., [~jcamachorodriguez] fixed., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12885868/HIVE-17468.4.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 11031 tests executed
*Failed tests:*
{noformat}
TestAccumuloCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=230)
TestDummy - did not produce a TEST-*.xml file (likely timed out) (batchId=230)
TestTxnCommandsBase - did not produce a TEST-*.xml file (likely timed out) (batchId=280)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=61)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[unionDistinct_1] (batchId=143)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=234)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=234)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6719/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6719/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6719/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12885868 - PreCommit-HIVE-Build, +1, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12885868/HIVE-17468.4.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 11031 tests executed
*Failed tests:*
{noformat}
TestAccumuloCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=230)
TestDummy - did not produce a TEST-*.xml file (likely timed out) (batchId=230)
TestTxnCommandsBase - did not produce a TEST-*.xml file (likely timed out) (batchId=280)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=61)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=234)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6720/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6720/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6720/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12885868 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12885868/HIVE-17468.4.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 11031 tests executed
*Failed tests:*
{noformat}
TestAccumuloCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=230)
TestDummy - did not produce a TEST-*.xml file (likely timed out) (batchId=230)
TestTxnCommandsBase - did not produce a TEST-*.xml file (likely timed out) (batchId=280)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[insert_values_orig_table_use_metadata] (batchId=61)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6722/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6722/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6722/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12885868 - PreCommit-HIVE-Build, Pushed to master, thanks [~bslim], This jira is resolved and released with Hive 3.0 If you find an issue with it, please create a new jira.]