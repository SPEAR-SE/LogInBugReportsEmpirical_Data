[navis requested code review of "HIVE-3518 [jira] QTestUtil side-effects".
Reviewers: JIRA

  DPAL-1907 QTestUtil side-effects

  It seems that QTestUtil has side-effects. This test (metadata_export_drop.q) causes failure of other tests on cleanup stage:

  Exception: java.lang.IllegalArgumentException: java.net.URISyntaxException: Relative path in absolute URI: file:../build/ql/test/data/exports/HIVE-3427/src.2012-09-28-11-38-17
  org.apache.hadoop.hive.ql.metadata.HiveException: java.lang.IllegalArgumentException: java.net.URISyntaxException: Relative path in absolute URI: file:../build/ql/test/data/exports/HIVE-3427/src.2012-09-28-11-38-17
  at org.apache.hadoop.hive.ql.metadata.Hive.dropTable(Hive.java:845)
  at org.apache.hadoop.hive.ql.metadata.Hive.dropTable(Hive.java:821)
  at org.apache.hadoop.hive.ql.QTestUtil.cleanUp(QTestUtil.java:445)
  at org.apache.hadoop.hive.ql.QTestUtil.shutdown(QTestUtil.java:300)
  at org.apache.hadoop.hive.cli.TestCliDriver.tearDown(TestCliDriver.java:87)
  at junit.framework.TestCase.runBare(TestCase.java:140)
  at junit.framework.TestResult$1.protect(TestResult.java:110)
  at junit.framework.TestResult.runProtected(TestResult.java:128)
  at junit.framework.TestResult.run(TestResult.java:113)
  at junit.framework.TestCase.run(TestCase.java:124)
  at junit.framework.TestSuite.runTest(TestSuite.java:232)
  at junit.framework.TestSuite.run(TestSuite.java:227)
  at org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run(JUnit3TestReference.java:130)
  at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)
  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)
  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)
  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)
  at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)
  Caused by: java.lang.IllegalArgumentException: java.net.URISyntaxException: Relative path in absolute URI: file:../build/ql/test/data/exports/HIVE-3427/src.2012-09-28-11-38-17
  at org.apache.hadoop.fs.Path.initialize(Path.java:140)
  at org.apache.hadoop.fs.Path.<init>(Path.java:132)
  at org.apache.hadoop.fs.ProxyFileSystem.swizzleParamPath(ProxyFileSystem.java:56)
  at org.apache.hadoop.fs.ProxyFileSystem.mkdirs(ProxyFileSystem.java:214)
  at org.apache.hadoop.fs.FilterFileSystem.mkdirs(FilterFileSystem.java:183)
  at org.apache.hadoop.fs.FileSystem.mkdirs(FileSystem.java:1120)
  at org.apache.hadoop.hive.ql.parse.MetaDataExportListener.export_meta_data(MetaDataExportListener.java:81)
  at org.apache.hadoop.hive.ql.parse.MetaDataExportListener.onEvent(MetaDataExportListener.java:106)
  at org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.drop_table_core(HiveMetaStore.java:1024)
  at org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.drop_table(HiveMetaStore.java:1185)
  at org.apache.hadoop.hive.metastore.HiveMetaStoreClient.dropTable(HiveMetaStoreClient.java:566)
  at org.apache.hadoop.hive.ql.metadata.Hive.dropTable(Hive.java:839)
  ... 17 more
  Caused by: java.net.URISyntaxException: Relative path in absolute URI: file:../build/ql/test/data/exports/HIVE-3427/src.2012-09-28-11-38-17
  at java.net.URI.checkPath(URI.java:1787)
  at java.net.URI.<init>(URI.java:735)
  at org.apache.hadoop.fs.Path.initialize(Path.java:137)
  ... 28 more

  Flushing 'hive.metastore.pre.event.listeners' into empty string solves the issue. During debugging I figured out this property wan't cleaned for other tests after it was set in metadata_export_drop.q.

  How to reproduce:

  ant test -Dtestcase=TestCliDriver -Dqfile=metadata_export_drop.q,<some test>.q

  where <some test>.q means any test which contains CREATE statement. For example, sample10.q

TEST PLAN
  EMPTY

REVISION DETAIL
  https://reviews.facebook.net/D5865

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/processors/ResetProcessor.java
  ql/src/test/org/apache/hadoop/hive/ql/QTestUtil.java

MANAGE HERALD DIFFERENTIAL RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/13893/

To: JIRA, navis
, QTestUtil creates new HiveConf per test for removing side effects but it's not propagated to entities like SessionState or MetaStoreClient. The patch is fixing it and not yet tested. After that I'll mark this patch-available., navis updated the revision "HIVE-3518 [jira] QTestUtil side-effects".
Reviewers: JIRA

  Resetting conf made other issues, so just sure new conf propagated to meta store.


REVISION DETAIL
  https://reviews.facebook.net/D5865

AFFECTED FILES
  ql/src/test/org/apache/hadoop/hive/ql/QTestUtil.java

To: JIRA, navis
, +1, njain has accepted the revision "HIVE-3518 [jira] QTestUtil side-effects".

REVISION DETAIL
  https://reviews.facebook.net/D5865

BRANCH
  DPAL-1907

To: JIRA, njain, navis
, Committed. Thanks Navis, Integrated in Hive-trunk-h0.21 #1735 (See [https://builds.apache.org/job/Hive-trunk-h0.21/1735/])
    HIVE-3518 QTestUtil side-effects
(Navis via namit) (Revision 1397843)

     Result = FAILURE
namit : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1397843
Files : 
* /hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/QTestUtil.java
, Integrated in Hive-trunk-hadoop2 #54 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/54/])
    HIVE-3518 QTestUtil side-effects
(Navis via namit) (Revision 1397843)

     Result = ABORTED
namit : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1397843
Files : 
* /hive/trunk/ql/src/test/org/apache/hadoop/hive/ql/QTestUtil.java
, This issue is fixed and released as part of 0.10.0 release. If you find an issue which seems to be related to this one, please create a new jira and link this one with new jira.]