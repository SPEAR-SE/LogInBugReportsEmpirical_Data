[This patch fixes the problem.
, Patches for 0.4 and 0.5., template file changes look fine. but I'm sure about the changes to SessionState.start(session). This function now returns the old session and previously it returns the new session. It is called in other places as well. Can you make sure that this change of semantics doesn't break our design and other use cases? If what we need here is to be able to get the current session and close it, we can do it without changing the semantics of SessionState.start(session). , Adopted Ning's suggestions., +1. Will commit after tests. , committed to branch 0.4, 0.5 and trunk. Thanks Zheng!]