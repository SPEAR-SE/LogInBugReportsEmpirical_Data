[

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12860357/HIVE-16291.1.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 1 failed/errored test(s), 10512 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[comments] (batchId=35)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4340/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4340/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4340/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12860357 - PreCommit-HIVE-Build, [~Yibing] Seems it's not an issue any more in the latest version. The issue has been fixed by HIVE-10755., [~Yibing] Can you try the latest version to see if it still has the issue?, OK. Seems it's still an issue depending on the union order. Upstream will fail with the following query

{{select count(*) from (select tst_unin.p_tdate from tst_unin where tst_unin.col1=20160302 union all select tst_unin.p_tdate from tst_unin) t1;}}, The patch looks good to me. +1., conf.setBoolean(READ_ALL_COLUMNS, false); is done unconditionally on last line in that method. So, I am not sure this change is needed.
cc: [~prasanth_j] [~sershe] since this impacts all columnar readers, not just parquet., [~ashutoshc] The problem is not to set READ_ALL_COLUMNS to false, but when ids is empty and the old = "0", the newConfStr will become ",0". 

    if (old != null && !old.isEmpty()) {
      newConfStr = newConfStr + StringUtils.COMMA_STR + old;
    }

So when id is empty, we just need to set READ_ALL_COLUMNS to false.


, Probably change to something like this to be clear?

{noformat}
String newConfStr = id;
if (id.isEmpty()) {
   newConfStr = old;
} else {
  if (old != null && !old.isEmpty() ) { 
     newConfStr = newConfStr + StringUtils.COMMA_STR + old; 
  }
}
{noformat}, [~Yibing] Your logic is correct, but seems it's a little confusion. Maybe we can change to something like this:

So if id is empty, then newConf is old, otherwise, if old is not empty, concat id with old.

{noformat}
newConfStr = id;
if (StringUtils.isBlank(id)) {
  newCnfStr = old;
} else if (StringUtils.isNotBlank(old)) {
   newConfStr = id + StringUtils.COMMA_STR + old;
}
{noformat}
, [~aihuaxu]
Sorry for the delay! I was totally stuck in other problems and didn't get a chance to check this.
I submitted my patch trying to minimize the scope of my changes (touch as less line as possible). Yes, I agree that the logic is a bit confusing. Your suggestions look great! I have a slightly modified version as below. How do you think?

{code}
    String newConfStr = null;
    for (String s : Arrays.asList(id, old)) {
      if (org.apache.commons.lang.StringUtils.isNotBlank(s)) {
        newConfStr = newConfStr == null ? s : newConfStr + StringUtils.COMMA_STR + s;
      }
    }

{code}, [~aihuaxu]
Actually, I have just realized that we can change it into below line:
{code}
String newConfStr = HiveStringUtils.joinIgnoringEmpty(new String[] {id, old}, StringUtils.COMMA);
{code}, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12862228/HIVE-16291.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 10580 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[drop_with_concurrency] (batchId=235)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[escape_comments] (batchId=235)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=143)
org.apache.hive.jdbc.TestJdbcDriver2.testResultSetMetaData (batchId=221)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4585/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4585/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4585/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12862228 - PreCommit-HIVE-Build, That's much cleaner. +1. , +1 Thanks for simplifying code for improved readability., Pushed to master. Thanks Yibing for the work., Hive 3.0.0 has been released so closing this jira.]