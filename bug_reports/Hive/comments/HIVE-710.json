[This patch fixes the problem.

I also changed the test a bit to try both negative/positive float/double. Negative integers are already tested.
, why not use ~ to flip bits?, Incorporated Prasad's comment., +1 running tests.., Merged into revision 799148. Thanks Zheng.]