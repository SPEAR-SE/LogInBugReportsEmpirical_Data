[I added an exception to the end-to-end test. Without the patch, the test times out. With the patch, the error looks like this:
{noformat}
ests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 36.07 sec <<< FAILURE! - in org.apache.hive.jdbc.TestJdbcWithMiniLlap
testLlapInputFormatEndToEnd(org.apache.hive.jdbc.TestJdbcWithMiniLlap)  Time elapsed: 5.089 sec  <<< ERROR!
java.io.IOException: Received reader event error: Received an error for task ID attempt_8772768970312654090_0001_0_00_000000_0: Error while running task ( failure ) : attempt_8772768970312654090_0001_0_00_000000_0:java.lang.RuntimeException: java.lang.Exception: boom!
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:211)
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.run(TezProcessor.java:168)
	at org.apache.tez.runtime.LogicalIOProcessorRuntimeTask.run(LogicalIOProcessorRuntimeTask.java:355)
	at org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:72)
	at org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:60)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:422)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1656)
	at org.apache.tez.runtime.task.TaskRunner2Callable.callInternal(TaskRunner2Callable.java:60)
	at org.apache.tez.runtime.task.TaskRunner2Callable.callInternal(TaskRunner2Callable.java:36)
	at org.apache.tez.common.CallableWithNdc.call(CallableWithNdc.java:36)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.Exception: boom!
	at org.apache.hadoop.hive.ql.exec.tez.MapRecordProcessor.getMRInput(MapRecordProcessor.java:497)
	at org.apache.hadoop.hive.ql.exec.tez.MapRecordProcessor.init(MapRecordProcessor.java:171)
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:184)
	... 14 more

	at org.apache.hadoop.hive.llap.LlapBaseRecordReader.next(LlapBaseRecordReader.java:163)
	at org.apache.hadoop.hive.llap.LlapBaseRecordReader.next(LlapBaseRecordReader.java:47)
	at org.apache.hadoop.hive.llap.LlapRowRecordReader.next(LlapRowRecordReader.java:107)
	at org.apache.hadoop.hive.llap.LlapRowRecordReader.next(LlapRowRecordReader.java:56)
	at org.apache.hive.jdbc.TestJdbcWithMiniLlap.getLlapIFRowCount(TestJdbcWithMiniLlap.java:201)
	at org.apache.hive.jdbc.TestJdbcWithMiniLlap.testLlapInputFormatEndToEnd(TestJdbcWithMiniLlap.java:223)
{noformat}, [~jdere] [~sseth] can you take a look?, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12813121/HIVE-14091.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10265 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_13
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver_index_bitmap3
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/256/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/256/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-256/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12813121 - PreCommit-HIVE-MASTER-Build, The main change here is to close the socket in case of an exception, correct? and hope that this causes the InputStream read to return immediately - since the interrupt does not work. Afaik - this is best effort - and there's a comment in the patch which indicates the same.
This will cause any reads on the InputStream to fail - likely with a ClosedChannelException (or equivalent). Do we need to handle this in a specific manner in the reader code - at least to indicate the kind of error so that debugging is easier.

Mostly unrelated to this jira.
{code}
case ERROR:
              throw new IOException("Received reader event error: " + event.getMessage());
            default:
              throw new IOException("Got reader event type " + event.getEventType() + ", expected error event");
{code}
This gets rid of the original exception. Would be worth propagating the exception further up, or at least logging it.

I don't think the addition of taskFailed on the Responder is required. This will be invoked in any case when the Umbilical heartbeat implementation invokes responder.heartbeat. (adding the method implies the error being sent twice to the responder)

Should the socket also be cleaned up during ReaderBase.close()



, It's handled via IOException. 
taskFailed is apparently needed. There isn't a call to the heartbeat with error that I can see; if I remove taskFailed, it never propagates properly.
InputStream cleans up the socket (added a comment), ping [~jdere]. Can you take a look wrt the addition of taskFailed? When running the end to end test, the error is not propagated without it. Sid says it should come via heartbeat. 
Is heartbeat not coming test specific? , I think [~sseth] is right about responder.heartbeat propagating the error to the reader, I think the socket close mechanism from this patch is enough to propagate the error, I tried removing the taskFailed calls and the reader is able to report the error., Do you want to update the patch? Was the entire process failure path removed or just taskFailed? Is the error still propagated? Note the c/p above. How do the test fail with the call removed?, Removed the taskFailed part of the patch. responder.heartbeat() was already propagating the error, it looks like the issue was that the interrupt call wasn't actually interrupting the socket read call. Adding the socket close logic as you did in the patch allows the socket read operation to terminate, at which point the error handling logic can then read the propagated error event and raise the exception., Can you post the callstack from the test with these changes? Does the error propagate properly? I thought there was some problem with event also. Otherwise lgtm, Here's the stack trace from my test:
{noformat}
testLlapInputFormatEndToEnd(org.apache.hive.jdbc.TestJdbcWithMiniLlap)  Time elapsed: 5.487 sec  <<< ERROR!
java.io.IOException: Received reader event error: Error while running task ( failure ) : attempt_631695341189882464_0001_0_00_000000_0:java.lang.RuntimeException: java.lang.Exception: BOOM!!!
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:211)
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.run(TezProcessor.java:168)
	at org.apache.tez.runtime.LogicalIOProcessorRuntimeTask.run(LogicalIOProcessorRuntimeTask.java:355)
	at org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:72)
	at org.apache.tez.runtime.task.TaskRunner2Callable$1.run(TaskRunner2Callable.java:60)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:415)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1656)
	at org.apache.tez.runtime.task.TaskRunner2Callable.callInternal(TaskRunner2Callable.java:60)
	at org.apache.tez.runtime.task.TaskRunner2Callable.callInternal(TaskRunner2Callable.java:36)
	at org.apache.tez.common.CallableWithNdc.call(CallableWithNdc.java:36)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:744)
Caused by: java.lang.Exception: BOOM!!!
	at org.apache.hadoop.hive.ql.exec.tez.MapRecordProcessor.getMRInput(MapRecordProcessor.java:507)
	at org.apache.hadoop.hive.ql.exec.tez.MapRecordProcessor.init(MapRecordProcessor.java:171)
	at org.apache.hadoop.hive.ql.exec.tez.TezProcessor.initializeAndRunProcessor(TezProcessor.java:184)
	... 14 more

	at java.net.SocketInputStream.socketRead0(Native Method)
	at java.net.SocketInputStream.read(SocketInputStream.java:152)
	at java.net.SocketInputStream.read(SocketInputStream.java:122)
	at java.net.SocketInputStream.read(SocketInputStream.java:210)
	at java.io.DataInputStream.readByte(DataInputStream.java:265)
	at org.apache.hadoop.io.WritableUtils.readVLong(WritableUtils.java:308)
	at org.apache.hadoop.io.WritableUtils.readVInt(WritableUtils.java:329)
	at org.apache.hadoop.io.Text.readFields(Text.java:290)
	at org.apache.hadoop.hive.llap.LlapBaseRecordReader.next(LlapBaseRecordReader.java:132)
	at org.apache.hadoop.hive.llap.LlapBaseRecordReader.next(LlapBaseRecordReader.java:46)
	at org.apache.hadoop.hive.llap.LlapRowRecordReader.next(LlapRowRecordReader.java:107)
	at org.apache.hadoop.hive.llap.LlapRowRecordReader.next(LlapRowRecordReader.java:56)
	at org.apache.hive.jdbc.TestJdbcWithMiniLlap.getLlapIFRowCount(TestJdbcWithMiniLlap.java:201)
	at org.apache.hive.jdbc.TestJdbcWithMiniLlap.testLlapInputFormatEndToEnd(TestJdbcWithMiniLlap.java:223)
{noformat}, +1, Or rather I don't know what's the deal with reviewing here. I will just commit it after test run  :), 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12814968/HIVE-14091.02.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10286 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_list_bucket_dml_12
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_list_bucket
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_subquery_multiinsert
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_all
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver_vector_complex_join
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/320/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/320/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-320/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12814968 - PreCommit-HIVE-MASTER-Build, Committed to master]