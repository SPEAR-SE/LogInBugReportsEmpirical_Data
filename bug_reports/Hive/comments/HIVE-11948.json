[[~alangates] could you take a look please?, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12771209/HIVE-11948.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 9777 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_udaf_corr
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hadoop.hive.hwi.TestHWISessionManager.testHiveDriver
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5964/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5964/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5964/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12771209 - PreCommit-HIVE-TRUNK-Build, failure is not related, this needs a change around TxnManager.lock(), 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12771497/HIVE-11948.4.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 9778 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestHBaseNegativeCliDriver.testCliDriver_generatehfiles_require_family_path
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hadoop.hive.hwi.TestHWISessionManager.testHiveDriver
org.apache.hadoop.hive.metastore.txn.TestTxnHandler.showLocks
org.apache.hive.hcatalog.streaming.TestStreaming.testHearbeat
org.apache.hive.jdbc.TestJdbcWithMiniHS2.testAddJarDataNucleusUnCaching
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5981/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5981/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5981/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12771497 - PreCommit-HIVE-TRUNK-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12771505/HIVE-11948.5.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 9778 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_index_bitmap_auto
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hadoop.hive.hwi.TestHWISessionManager.testHiveDriver
org.apache.hive.hcatalog.streaming.TestStreaming.testHearbeat
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5982/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5982/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5982/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12771505 - PreCommit-HIVE-TRUNK-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12771582/HIVE-11948.6.patch

{color:green}SUCCESS:{color} +1 due to 3 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 9778 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hadoop.hive.hwi.TestHWISessionManager.testHiveDriver
org.apache.hive.hcatalog.streaming.TestStreaming.testHearbeat
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5986/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5986/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5986/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12771582 - PreCommit-HIVE-TRUNK-Build, one last minor tweak, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12771654/HIVE-11948.7.patch

{color:green}SUCCESS:{color} +1 due to 3 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 9778 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_cbo_rp_annotate_stats_groupby
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hadoop.hive.hwi.TestHWISessionManager.testHiveDriver
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5993/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/5993/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-5993/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12771654 - PreCommit-HIVE-TRUNK-Build, test failures not related, In TxnHandler, around line 495:
bq. Why doesn't this get a txnid as parameter?  The caller should either know the txnid or know there isn't one.  Either way getTxnIdFromLockId() will not be needed.  This would be a Thrift change.
We should file a JIRA for that.  Same goes for comment at line 501.  We might just want to file an umbrella JIRA saying "take care of TODOs in TxnHandler and CompactionTxnHandler" and then we can file JIRAs for individual ones.

TxnHandler, line 522:
{code}
     if (txnid > 0) {
        heartbeatTxn(dbConn, txnid);
     }
    else {
        heartbeatLock(dbConn, extLockId);
    }
{code}

Previously the code was:
{code}
 heartbeatLock(dbConn, extLockId);		
 ...
 if (txnid > 0)  heartbeatTxn(dbConn, txnid);
{code}
You've changed the logic so that locks will only be heartbeat if there is no transaction.  I don't think that's what you want.

TxnHander unlock(), around line 581, you moved the check that a lock is associated with a txn below the failure detection.  Are you depending on the db constraints to catch that the lock entry can't be deleted because a txn it is associated with still exists?  If so, that should be commented.  If not, this is a logical error as we want to make sure never to unlock a lock associated with a txn.

TxnHandler.getRequiredIsolationLevel(), line 2270
{code}
if(dbProduct == null) {
  Connection tmp = getDbConn(Connection.TRANSACTION_READ_COMMITTED);
  determineDatabaseProduct(tmp);
  closeDbConn(tmp);
}
{code}
We should modify determineDatabaseProduct to accept null for the connection and create its own rather than repeating this logic anytime we don't have a connection.

, There is  a RB link for this patch, it may be easier to add comments there.

I'll take care of separate bugs.

The change in TxnHandler.checkLock() regarding heratbeat is intentional.  When there is a txn, only the txn needs to have heartbeat timestamp updated since that is the only timestamp checked for aborting an expired txn.  There is no way/reason to expire a single lock in a txn.  This simplifies both heartbeat and expiration operations (at least when there is a txn).


TxnHander unlock(), around line 581.  The statement to remove the lock is "delete from HIVE_LOCKS where hl_lock_ext_id = " + extLockId + " AND hl_txnid = 0";
The "hl_txnid=0" ensures that this lock doesn't belong to a transaction.  So the unlock() operation runs in  a single SQL statement under most circumstances, but if the above SQL "misses", then there is some additional operations performed to produce a meaningful (best effort) message.  Previously this operation required 3 SQL statements in all cases.

TxnHandler.getRequiredIsolationLevel(), line 2270.  Since "dbProduct" is only set once per MS start I don't think this causes any more connections to be taken out...





, bq. There is a RB link for this patch, it may be easier to add comments there.
I know, I just don't like review board.  It's harder to keep track of comments and feedback because they're not in the JIRA.  I look forward to moving to pull requests someday so feedback and changes can be tracked in one place conveniently.

bq. The change in TxnHandler.checkLock() regarding heratbeat is intentional...
Makes sense.

bq. TxnHander unlock(), around line 581...
My mistake, I was thinking that commit() called unlock(), but looking at the code I see it does the unlocking itself, so only worrying about locks that are not associated with a txn here makes sense.

bq. Since "dbProduct" is only set once per MS start I don't think this causes any more connections to be taken out...
That's not what I was saying.  I was saying for programmer convenience it would make sense to change this to be:
{code}
determineDatabaseProduct(null);
{code}
and change determineDataProduct to be:
{code}
  protected DatabaseProduct determineDatabaseProduct(Connection conn) throws MetaException {
    if (dbProduct == null) {
      if (conn == null) {
        // get connection...
      }
      try {
      ...
{code}
This is purely convenience and not necessary.

+1 for the patch., committed to branch-1 https://github.com/apache/hive/commit/a80841b73431de470cd0e53fcee3d04ca85ef7f5

master https://github.com/apache/hive/commit/da947fab4391642f60d46471cc007dc71b840cbd

thanks [~alangates] for the review, this introduced HIVE-12585]