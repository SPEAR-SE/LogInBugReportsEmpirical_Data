[+[~csun], Hi [~leon_wzm@163.com], thanks for reporting this issue. Could you provide a sample dataset that we can use to reproduce the issue? Thanks., I will give you a simple dataset to show the bug.

hive> desc logs1;
OK
iik                 	int                 	                    
created_at          	string              	                    
Time taken: 0.145 seconds, Fetched: 2 row(s)


hive> select * from logs1;
OK
1	js
5	9wj
1	js
5	9wj
56	io
1	js
5	9wj
1	js
5	9wj
Time taken: 0.687 seconds, Fetched: 9 row(s)


hive> select  count(*) from 
    > (select  iik from logs1 group by iik) a   join  
    > (select iik  from logs1 LATERAL VIEW json_tuple(created_at,'ss') v1 as ss) b on a.iik=b.iik;
Query ID = root_20151210201756_e56dadee-69c9-4d4e-838d-98173eab25ec
Total jobs = 2
Launching Job 1 out of 2
In order to change the average load for a reducer (in bytes):
  set hive.exec.reducers.bytes.per.reducer=<number>
In order to limit the maximum number of reducers:
  set hive.exec.reducers.max=<number>
In order to set a constant number of reducers:
  set mapreduce.job.reduces=<number>
Starting Spark Job = 031c6e38-d2d3-4b19-baa7-de1553cd7277
Status: Failed
FAILED: Execution Error, return code 3 from org.apache.hadoop.hive.ql.exec.spark.SparkTask

After I change hive.auto.convert.join from true to false. The result is OK.
, The problem is that the MapJoin operator is a descendant of a Lateral View Forward operator. In this case, the former is visited twice, and therefore the associated MapWork is also linked twice., This query actually executes successfully in Hive 2.1.0-SNAPSHOT. This is because the check for parent/children connection in SparkPlan is disabled in another commit. However, the duplicated MapWork still present in the query plan, which might cause problem in some other situations. This patch fixes it., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12784193/HIVE-12629.1-spark.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 9867 tests executed
*Failed tests:*
{noformat}
TestHWISessionManager - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_spark_lateral_view_mapjoin
org.apache.hadoop.hive.cli.TestNegativeCliDriver.testNegativeCliDriver_authorization_uri_import
org.apache.hadoop.hive.metastore.TestHiveMetaStorePartitionSpecs.testGetPartitionSpecs_WithAndWithoutPartitionGrouping
org.apache.hive.jdbc.TestSSL.testSSLVersion
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-SPARK-Build/1039/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-SPARK-Build/1039/console
Test logs: http://ec2-50-18-27-0.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-SPARK-Build-1039/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12784193 - PreCommit-HIVE-SPARK-Build]