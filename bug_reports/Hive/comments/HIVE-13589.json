[A workaround of using a wrapper shell script by [~nsabharwal] is mentioned here - https://community.hortonworks.com/questions/3147/beeline-sample-with-u-f-n-p.html, Hi [~thejas], current patch works with the case specifying '- p' without an argument to make beeline prompt for password.  However it  only support the case with "- p" following by the specified option  which are added in the Beeline.java [L290-L391]. If not, Apache common CLI will consider the option as the value of "- p".  We can limit user to put the "- p" by the end of command line. Do you have better suggestions?, Thanks [~Jk_Self] for the patch. There is one comment below.

{noformat}
     try {
+      ConsoleReader reader = getConsoleReader(inputStream);
       if (isBeeLine) {
         int code = initArgs(args);
         if (code != 0) {
@@ -852,7 +853,7 @@ public int begin(String[] args, InputStream inputStream) throws IOException {
       } catch (Exception e) {
         // ignore
       }
-      ConsoleReader reader = getConsoleReader(inputStream);
+
       return execute(reader, false);
     } finally {
         close();
{noformat}
If you get reader in front, it will fail to get beeline options since it's parsed after reader getter. , Thanks [~Ferd] comment. I fixed it and uploaded the patch., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12824995/HIVE-13589.2.patch

{color:red}ERROR:{color} -1 due to build exiting with an error

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/965/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/965/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-965/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Tests exited with: NonZeroExitCodeException
Command 'bash /data/hive-ptest/working/scratch/source-prep.sh' failed with exit status 1 and output '+ [[ -n /usr/java/jdk1.8.0_25 ]]
+ export JAVA_HOME=/usr/java/jdk1.8.0_25
+ JAVA_HOME=/usr/java/jdk1.8.0_25
+ export PATH=/usr/java/jdk1.8.0_25/bin/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
+ PATH=/usr/java/jdk1.8.0_25/bin/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
+ export 'ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m '
+ ANT_OPTS='-Xmx1g -XX:MaxPermSize=256m '
+ export 'M2_OPTS=-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128'
+ M2_OPTS='-Xmx1g -XX:MaxPermSize=256m -Dhttp.proxyHost=localhost -Dhttp.proxyPort=3128'
+ cd /data/hive-ptest/working/
+ tee /data/hive-ptest/logs/PreCommit-HIVE-MASTER-Build-965/source-prep.txt
+ [[ false == \t\r\u\e ]]
+ mkdir -p maven ivy
+ [[ git = \s\v\n ]]
+ [[ git = \g\i\t ]]
+ [[ -z master ]]
+ [[ -d apache-github-source-source ]]
+ [[ ! -d apache-github-source-source/.git ]]
+ [[ ! -d apache-github-source-source ]]
+ cd apache-github-source-source
+ git fetch origin
+ git reset --hard HEAD
HEAD is now at 4777289 HIVE-14511: Improve MSCK for partitioned table to deal with special cases (Pengcheng Xiong, reviewed by Ashutosh Chauhan)
+ git clean -f -d
+ git checkout master
Already on 'master'
Your branch is up-to-date with 'origin/master'.
+ git reset --hard origin/master
HEAD is now at 4777289 HIVE-14511: Improve MSCK for partitioned table to deal with special cases (Pengcheng Xiong, reviewed by Ashutosh Chauhan)
+ git merge --ff-only origin/master
Already up-to-date.
+ git gc
+ patchCommandPath=/data/hive-ptest/working/scratch/smart-apply-patch.sh
+ patchFilePath=/data/hive-ptest/working/scratch/build.patch
+ [[ -f /data/hive-ptest/working/scratch/build.patch ]]
+ chmod +x /data/hive-ptest/working/scratch/smart-apply-patch.sh
+ /data/hive-ptest/working/scratch/smart-apply-patch.sh /data/hive-ptest/working/scratch/build.patch
The patch does not appear to apply with p0, p1, or p2
+ exit 1
'
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12824995 - PreCommit-HIVE-MASTER-Build, LGTM +1 pending to the test, I think we should not put a limitation that -p should be the last argument. This would be a bad user-experience. If the main reason for this issue is to avoid showing the password in the command history, the ideal behavior should be that user does not provide a password while connecting and beeline should prompt for one when it finds that there is no password provided.

The issue is due to the code block below. When the password is null, it sets it to empty string due to which beeline does not prompt for the password when it is not provided. I think we should fix this behavior which would provide a way for the user to achieve the same without limiting the usability of the -p argument.

{noformat}
private String constructCmd(String url, String user, String pass, String driver, boolean stripPasswd) {
    String com = "!connect "
        + url + " "
        + (user == null || user.length() == 0 ? "''" : user) + " ";
    if (stripPasswd) {
      com += PASSWD_MASK + " ";
    } else {
      com += (pass == null || pass.length() == 0 ? "''" : pass) + " ";
    }
    com += (driver == null ? "" : driver);
    return com;
  }
{noformat}, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12825188/HIVE-13589.3.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 10393 tests executed
*Failed tests:*
{noformat}
TestBeeLineWithArgs - did not produce a TEST-*.xml file
TestHiveCli - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_mapjoin]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[ctas]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[acid_bucket_pruning]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
org.apache.hive.service.cli.operation.TestOperationLoggingLayout.testSwitchLogLayout
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/973/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/973/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-973/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12825188 - PreCommit-HIVE-MASTER-Build, Thanks [~vihangk1] for your input. [~Jk_Self], any thoughts about [~vihangk1]'s comments?, Hi [~vihangk1], [~Ferd], current patch can prompt for the password when the password is null or empty string. Howerver,if the case with "-p" option does not follow the specified option which are added in the Beeline.java [L290-L391], the Apache Common CLI will consider the option as the value of "-p" argument. For example, "hive --service beeline -u jdbc:hive2://localhost:10000  -n root -p --force=true -e 'show tables;'", because the "--force" option is not added in the Beeline.java, the Apache Common CLI set "--force=true" to the "-p" option. So when it execute the code which you mentioned above, the password is not null and will not prompt for password. Avoiding the bad user-experience, do you think we need to add all the options in the Beeline.java? , [~Jk_Self], we should not move those options to Beeline which will break backwards compatibility. Anyway to make this option required and if user doesn't enter a password, we pass in an empty value. When comes the empty, we prompt user to enter their password., [~vihangk1], I take a look at the BeeLine code. Now "- p" has been associated with a password. If we make it optional, it will parse the string next to "- p" to see whether it exists a password. In this way, it's possible to treat "--XXXX" as a password since -XXXX doesn't exist in Beeline options. One way I can think of is that we could add a new option which has no password. And prompt user to enter the password. Any thoughputs?, [~Ferd] I agree that we should not change the behavior of -p argument since it will break backwards compatibility. Adding another option to achieve the same purpose seems to be a overkill. Beeline should be smart enough to prompt for the password if there is no password given at the command line.

eg:
1. beeline -u "jdbc:hive2://localhost:10000" -n username
> beeline should prompt for the password.

2. beeline -u "jdbc:hive2://localhost:10000" -n username -p <password is expected because -p is provided>

If we can achieve (1) above within beeline, I think that should be sufficient to solve this issue without any work-arounds mentioned by [~thejas] in the first comment.,  [~vihangk1] Good idea. Let's make it in this way. [~Jk_Self] thank you for your update. LGTM +1, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12825389/HIVE-13589.4.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 10 failed/errored test(s), 10394 tests executed
*Failed tests:*
{noformat}
TestBeeLineWithArgs - did not produce a TEST-*.xml file
TestHiveCli - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_mapjoin]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[ctas]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[acid_bucket_pruning]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
org.apache.hive.jdbc.TestJdbcWithMiniHS2.testAddJarConstructorUnCaching
org.apache.hive.service.cli.operation.TestOperationLoggingLayout.testSwitchLogLayout
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/988/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/988/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-988/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12825389 - PreCommit-HIVE-MASTER-Build, Thanks [~Ke Jia] for the patch. Couple of comments below:

1. I think there is a method called 
{noformat}
public ConsoleReader getConsoleReader(InputStream inputStream) throws IOException
{noformat}

in BeeLine.java. I would suggest using this method to initialize the console reader in the begin method before beeline initializes using the args.
{noformat}
try {
      if (isBeeLine) {
        int code = initArgs(args);
        if (code != 0) {
          return code;
        }
...
{noformat}

2. Will this work if if the password is really an empty string (non-null but empty)?, Hi [~vihangk1]
{noformat}
2. Will this work if if the password is really an empty string (non-null but empty)?
{noformat}
Now option "- p" required a parameter which means empty string will not be allowed as a password to pass in. The only way to login with an empty string is by prompting. , Hi [~vihangk1], I update the patch according to your suggestion. Thank you., Hi [~vihangk1], [~Ferd], I upload the HIVE-13589.6.patch. I test it in beeline and hive cli mode respectively.  And it can work well. Pending to the test., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12825617/HIVE-13589.6.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 10396 tests executed
*Failed tests:*
{noformat}
TestBeeLineWithArgs - did not produce a TEST-*.xml file
TestHiveCli - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.org.apache.hadoop.hive.cli.TestCliDriver
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_mapjoin]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[ctas]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[acid_bucket_pruning]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1010/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1010/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-1010/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12825617 - PreCommit-HIVE-MASTER-Build, Hi [~vihangk1] do you have any further comments?, +1 LGTM. Thanks for the change., Committed to the master. Thanks [~Jk_Self] for the patch and [~vihangk1] for your review., Does this need to be documented in the wiki?, Hi [~leftylev], there's no new option added in this patch so no need to document. Thanks！, That's good to know, thanks Ferdinand., Revert in 63fdb51 since it breaks TestHiveCLI test and backwards compatibility mentioned in HIVE-14717, Hi [~Ke Jia] I think I have some ideas to work around the issue which we discussed in HIVE-14717. Since I have already spend some time on this issue and I think I have a patch which is almost ready, is it okay if I work on this JIRA? Please let me know. Thanks!, Hi [~vihangk1], Thanks for your comments.  About this issue, I have some ideas and now am working on the patch. May I continue my work for this JIRA? The main idea is that we can add the "-- force" or some other "--" options in Beeline.java, which are defined in https://cwiki.apache.org/confluence/display/Hive/HiveServer2+Clients#HiveServer2Clients-BeelineCommands. You can share your thoughts once my patch is ready. Thanks again for your reviews and inputs.
, Hi [~vihangk1], [~Ferd], I uploaded the latest patch. Please help me review it. Thanks, I think taking care of options at multiple places in Beeline (using CommandLine and BeelineOpts) should be changed in the future because it causes confusion and more likely to introduce bugs. I guess we should just have one way to handle the options in the future.

For this change, though I think you don't need to add the beeline options in Options in Beeline.java. All you need is to track whether -p is given or not. This can be done easily in the processOption method of the BeeLineParser. That way you don't need to add multiple Options in BeeLine.java. This approach is also less prone to errors since with your approach every time there is a new beelineOpts added, developer will have to add it in Options too which is not used in the end.

So my suggestion would be to make password an optional argument option using setOptionalArg method in Option class. And then track a boolean in the processOption method to see if -p was found in the arguments or not. Now with both these flags you have all the information you need to make password optional without adding all the other BeelineOpts in the Options (Beeline), [~Ke Jia] you can definitely continue working on this patch if you want. I have published my patch privately on https://reviews.apache.org/r/51821 which you can use as a reference if you want. It has a alternative implementation for this issue along with the test cases. Thanks a lot!, [~vihangk1], Thanks for your comments and suggestion. I updated the patch and uploaded it. Please help me review, Thanks., Trigger the Jenkins job, Hi [~Jk_Self], thank you for your updates. Can you please create a review board for your patch?, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12828379/HIVE-13589.8.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 11 failed/errored test(s), 10507 tests executed
*Failed tests:*
{noformat}
TestBeeLineWithArgs - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[acid_mapjoin]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[stats0]
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[vector_join_part_col_char]
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[acid_bucket_pruning]
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3]
org.apache.hive.beeline.TestBeelinePasswordOption.testPromptPasswordOptionLast
org.apache.hive.beeline.TestBeelinePasswordOption.testPromptPasswordOptionMiddle
org.apache.hive.beeline.TestBeelinePasswordOption.testPromptPasswordOptionStart
org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler.org.apache.hive.hcatalog.hbase.TestPigHBaseStorageHandler
org.apache.hive.jdbc.TestJdbcWithMiniHS2.testAddJarConstructorUnCaching
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1180/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-MASTER-Build/1180/console
Test logs: http://ec2-204-236-174-241.us-west-1.compute.amazonaws.com/logs/PreCommit-HIVE-MASTER-Build-1180/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 11 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12828379 - PreCommit-HIVE-MASTER-Build, Hi [~Ke Jia] You will have to modify the constructCmd too like seen in my review. I think that is the reason why TestBeeLineWithArgs  test is failing with your latest patch. The connect(String cmd) method in Commands.java will not work with space separated arguments when the password is null. That is reason why we need to change to implementation of constructCmd method to use ';' separated url.

It seems that most of the changes and test cases in the latest patch are same as changes from my review. Since that patch is already complete with test cases and we already have a review for it, why not just use that patch instead of reinventing the wheel. [~Ke Jia] and [~Ferd] you can review the patch and I can incorporate any suggestions which you may have. Please let me know if that is okay., [~vihangk1], is it ok if you work on this JIRA? , @Ke Jia .. I will take it up. Thanks for your consideration., Attaching the updated patch which makes password with optional argument like discussed. Adding the review url too, Adding rb url, Hey [~Ferd] .. Can you please review? I incorporated your review comments which you had given earlier in my patch shared with you and Ke Jia. Thanks!, I left some comments on review board. Also please attach your patch to trigger the precommit. Thanks!, Thanks [~Ferd] for the review. I had attached patch (HIVE-13589.9.patch) but for some reason the pre-commit didn't trigger. I will incorporate your suggestions and attach it again. Thanks!, Attaching the patch which addresses review comments. [~Ferd] Can you please take a look? Sorry was not able to work on this patch for long time but it is ready for review again. I have updated it on the review board too. Thanks a lot!, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12834474/HIVE-13589.10.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10574 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_basic] (batchId=132)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[current_date_timestamp] (batchId=144)
org.apache.hive.beeline.TestBeelineArgParsing.testAddLocalJarWithoutAddDriverClazz[0] (batchId=164)
org.apache.hive.beeline.TestBeelineArgParsing.testAddLocalJar[0] (batchId=164)
org.apache.hive.beeline.TestBeelineArgParsing.testAddLocalJar[1] (batchId=164)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/1701/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/1701/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-1701/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12834474 - PreCommit-HIVE-Build, Thank you for the update. Leave a few more comments on RB. , Attaching the updated patch with review comments addressed. Thanks for the review [~Ferd], LGTM +1 pending to the test, For some reason HiveQA job is not picking up the patch since last two days. Will re-attach it to see if it helps., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12834984/HIVE-13589.12.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 4 failed/errored test(s), 10602 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.thrift.TestHadoopAuthBridge23.testDelegationTokenSharedStore (batchId=216)
org.apache.hive.beeline.TestBeelineArgParsing.testAddLocalJarWithoutAddDriverClazz[0] (batchId=164)
org.apache.hive.beeline.TestBeelineArgParsing.testAddLocalJar[0] (batchId=164)
org.apache.hive.beeline.TestBeelineArgParsing.testAddLocalJar[1] (batchId=164)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/1771/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/1771/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-1771/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 4 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12834984 - PreCommit-HIVE-Build, Failed cases are not related. Committed to the master. Thanks [~vihangk1] and [~Jk_Self] for the contributions and reviews., Should the description of the -p option be updated in the wiki to say that it can be specified without an argument in 2.2.0 and later versions?

* [HiveServer2 Clients -- Beeline Command Options | https://cwiki.apache.org/confluence/display/Hive/HiveServer2+Clients#HiveServer2Clients-BeelineCommandOptions], [~leftylev], I think so. [~vihangk1], can you update the WIKI? Thank you., Thanks [~leftylev] for the reminder. I have updated the wiki. Can you please check and suggest any edits if needed? Thanks.]