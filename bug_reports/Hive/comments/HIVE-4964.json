[hbutani requested code review of "HIVE-4964 [jira] Cleanup PTF code: remove code dealing with non standard sql behavior we had original introduced".

Reviewers: JIRA, ashutoshc

fix lint issues

There are still pieces of code that deal with:

	supporting select expressions with Windowing
	supporting a filter with windowing

Need to do this before introducing  Perf. improvements.

TEST PLAN
  EMPTY

REVISION DETAIL
  https://reviews.facebook.net/D11985

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/exec/PTFOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/PTFTranslator.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/WindowingSpec.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDeserializer.java
  ql/src/java/org/apache/hadoop/hive/ql/udf/ptf/WindowingTableFunction.java

MANAGE HERALD RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/28635/

To: JIRA, ashutoshc, hbutani
, With a quick look.

1) Your not using the correct formatting rules for the project. We can not accept code that does not match the coding conventions

{code}
+    while (pItr.hasNext())
+    {
+      Object oRow = pItr.next();
+      forward(oRow, outputObjInspector);
+    }
{code}

2) The implementing class should not be on the left side of the equals. Use List not ArrayList when possible. 
{code}
 ArrayList<ObjectInspector> fieldOIs = new ArrayList<ObjectInspector>();
{code}, hbutani updated the revision "HIVE-4964 [jira] Cleanup PTF code: remove code dealing with non standard sql behavior we had original introduced".

    - fix formatting issues
    - fix lint issues

Reviewers: JIRA, ashutoshc

REVISION DETAIL
  https://reviews.facebook.net/D11985

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D11985?vs=36957&id=37053#toc

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/exec/PTFOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/PTFTranslator.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/WindowingSpec.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDeserializer.java
  ql/src/java/org/apache/hadoop/hive/ql/udf/ptf/WindowingTableFunction.java

To: JIRA, ashutoshc, hbutani
, Yes the formatting issues are long overdue. These are carryover from when we initially wrote a lot of this code; was using a different set of formatting rules. Cannot get eclipse to auto fix based on Hive's rules; so manually fixing them(as much as possible). So please bear with us..., With eclipse I have had luck using this as my code-style settings. typically you can highlight some code or the entire file, right click and then ask eclipse to reformat.
https://github.com/zznate/intravert-ug/blob/master/src/main/resources/eclipseUima_code_style_prefs.xml, [~rhbutani] Are we removing some functionality in this patch or is it just dead code removal ? If we are removing some functionality can you outline what are you proposing to drop?, No just dead code removal. This code was handling:
- the 'having clause' based filters we originally supported with windowing; 
- and also the use of 'lead/lag' udfs outside of UDAFs.

We decided to remove support for these, if i recall, because:
- associating having with windowing would be confusing to users.
- lead/lag udf invocations when multiple partitioning are involved are ambiguous. In some cases it is not clear what order to evaluate the window expressions.

We have already removed these features from the Semantic Analyzer. So they are not exposed to the user.
This is a cleanup step of the Translator/PTFOperator that still had code to handle these cases., ashutoshc has accepted the revision "HIVE-4964 [jira] Cleanup PTF code: remove code dealing with non standard sql behavior we had original introduced".

  +1 I love patches with red diffs : )

REVISION DETAIL
  https://reviews.facebook.net/D11985

BRANCH
  HIVE-4964

ARCANIST PROJECT
  hive

To: JIRA, ashutoshc, hbutani
, Patch is not applying cleanly. Can you please rebase on current trunk., This one depends on HIVE-4963. Can you review that.
Sorry should have been explicit about this dependency. Did add a 'requires' link to HIVE-4963., I think we are getting ahead of ourselves here. HIVE-4963 could be classified as a feature, but there are still big cleanups in the PTF work. There is lots of dead code, and lots of redundant code, we should clean all those items up first. There is  bits in there with xml encoded and other things that need to be moved. , This was not meant to be a jira for cleanup of the PTF code.
I wanted to get this in, as a precursor for HIVE-4965.

The XmlEncoder stuff in PTFUtils is a good point.  Can you share the list of things that you have identified for cleanup. Will do this and other cleanup as a separate Jira. You ok with this?, [~rhbutani] Patch is not applying cleanly. Can you rebase it on the trunk?, One more cleanup: Please remove 'while (true)' + 'break' constructs unless they are needed. The do not read well and introducing break logic is generally not suggested.


{quote}
while (true) {
 if (iDef instanceof PartitionedTableFunctionDef) {
{quote}



Instead try:
{quote}
Item found == null;
while (found==null){
}
{quote}
or even better
{quote}
 for (item: list){
   if (matchesCriteria(item) ){
     return item;
   }
 }
{quote}, Also when possible avoid stack

{quote}
 Stack<PartitionedTableFunctionDef> fnDefs = new Stack<PartitionedTableFunctionDef>();
{quote}
instead use
{quote}
Deque d = new ArrayDeque()
{quote}

Stack is synchronized and has overhead. (i know some things in hive use stack already so this is sometimes unavoidable., hbutani requested code review of "HIVE-4964 [jira] Cleanup PTF code: remove code dealing with non standard sql behavior we had original introduced".

Reviewers: JIRA, ashutoshc

merge with trunk

There are still pieces of code that deal with:

	supporting select expressions with Windowing
	supporting a filter with windowing

Need to do this before introducing  Perf. improvements.

TEST PLAN
  EMPTY

REVISION DETAIL
  https://reviews.facebook.net/D12585

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/exec/PTFOperator.java
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/PTFTranslator.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/WindowingSpec.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java
  ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDeserializer.java
  ql/src/java/org/apache/hadoop/hive/ql/udf/ptf/WindowingTableFunction.java

MANAGE HERALD RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/30237/

To: JIRA, ashutoshc, hbutani
, ashutoshc has accepted the revision "HIVE-4964 [jira] Cleanup PTF code: remove code dealing with non standard sql behavior we had original introduced".

  +1

REVISION DETAIL
  https://reviews.facebook.net/D12585

BRANCH
  HIVE-4964-2

ARCANIST PROJECT
  hive

To: JIRA, ashutoshc, hbutani
, Committed to trunk. Thanks, Harish!, FAILURE: Integrated in Hive-trunk-hadoop2-ptest #76 (See [https://builds.apache.org/job/Hive-trunk-hadoop2-ptest/76/])
HIVE-4964 : Cleanup PTF code: remove code dealing with non standard sql behavior we had original introduced (Harish Butani via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1518680)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/PTFOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/PTFTranslator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/WindowingSpec.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDeserializer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/udf/ptf/WindowingTableFunction.java
, FAILURE: Integrated in Hive-trunk-hadoop1-ptest #144 (See [https://builds.apache.org/job/Hive-trunk-hadoop1-ptest/144/])
HIVE-4964 : Cleanup PTF code: remove code dealing with non standard sql behavior we had original introduced (Harish Butani via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1518680)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/PTFOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/PTFTranslator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/WindowingSpec.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDeserializer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/udf/ptf/WindowingTableFunction.java
, FAILURE: Integrated in Hive-trunk-h0.21 #2297 (See [https://builds.apache.org/job/Hive-trunk-h0.21/2297/])
HIVE-4964 : Cleanup PTF code: remove code dealing with non standard sql behavior we had original introduced (Harish Butani via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1518680)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/PTFOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/PTFTranslator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/WindowingSpec.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDeserializer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/udf/ptf/WindowingTableFunction.java
, ABORTED: Integrated in Hive-trunk-hadoop2 #389 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/389/])
HIVE-4964 : Cleanup PTF code: remove code dealing with non standard sql behavior we had original introduced (Harish Butani via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1518680)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/exec/PTFOperator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/ColumnPrunerProcFactory.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/PTFTranslator.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/WindowingSpec.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDesc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/plan/PTFDeserializer.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/udf/ptf/WindowingTableFunction.java
, This issue has been fixed and released as part of 0.12 release. If you find further issues, please create a new jira and link it to this one.]