[Furthermore, if {{hive.exec.post.hooks}} is set to {{org.apache.hadoop.hive.ql.hooks.LineageLogger}}, a different exception is thrown, but this time it is thrown in the Query Planning Phase. The full stack trace is below:

*Exception 2:*

{code}
Error: Error while compiling statement: FAILED: IndexOutOfBoundsException Index: 3, Size: 3 (state=42000,code=40000)
org.apache.hive.service.cli.HiveSQLException: Error while compiling statement: FAILED: IndexOutOfBoundsException Index: 3, Size: 3
	at org.apache.hive.jdbc.Utils.verifySuccess(Utils.java:239)
	at org.apache.hive.jdbc.Utils.verifySuccessWithInfo(Utils.java:225)
	at org.apache.hive.jdbc.HiveStatement.execute(HiveStatement.java:244)
	at org.apache.hive.beeline.Commands.executeInternal(Commands.java:934)
	at org.apache.hive.beeline.Commands.execute(Commands.java:1120)
	at org.apache.hive.beeline.Commands.sql(Commands.java:1017)
	at org.apache.hive.beeline.BeeLine.dispatch(BeeLine.java:1095)
	at org.apache.hive.beeline.BeeLine.execute(BeeLine.java:927)
	at org.apache.hive.beeline.BeeLine.begin(BeeLine.java:855)
	at org.apache.hive.beeline.BeeLine.mainWithInputRedirection(BeeLine.java:488)
	at org.apache.hive.beeline.BeeLine.main(BeeLine.java:471)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.hadoop.util.RunJar.run(RunJar.java:221)
	at org.apache.hadoop.util.RunJar.main(RunJar.java:136)
Caused by: org.apache.hive.service.cli.HiveSQLException: Error while compiling statement: FAILED: IndexOutOfBoundsException Index: 3, Size: 3
	at org.apache.hive.service.cli.operation.Operation.toSQLException(Operation.java:388)
	at org.apache.hive.service.cli.operation.SQLOperation.prepare(SQLOperation.java:145)
	at org.apache.hive.service.cli.operation.SQLOperation.runInternal(SQLOperation.java:215)
	at org.apache.hive.service.cli.operation.Operation.run(Operation.java:326)
	at org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementInternal(HiveSessionImpl.java:424)
	at org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementAsync(HiveSessionImpl.java:401)
	at org.apache.hive.service.cli.CLIService.executeStatementAsync(CLIService.java:258)
	at org.apache.hive.service.cli.thrift.ThriftCLIService.ExecuteStatement(ThriftCLIService.java:503)
	at org.apache.hive.service.cli.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1313)
	at org.apache.hive.service.cli.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1298)
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39)
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39)
	at org.apache.hadoop.hive.thrift.HadoopThriftAuthBridge$Server$TUGIAssumingProcessor.process(HadoopThriftAuthBridge.java:718)
	at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:286)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at java.util.ArrayList.rangeCheck(ArrayList.java:635)
	at java.util.ArrayList.get(ArrayList.java:411)
	at org.apache.hadoop.hive.ql.optimizer.lineage.OpProcFactory$ReduceSinkLineage.process(OpProcFactory.java:607)
	at org.apache.hadoop.hive.ql.lib.DefaultRuleDispatcher.dispatch(DefaultRuleDispatcher.java:90)
	at org.apache.hadoop.hive.ql.lib.DefaultGraphWalker.dispatchAndReturn(DefaultGraphWalker.java:94)
	at org.apache.hadoop.hive.ql.lib.DefaultGraphWalker.dispatch(DefaultGraphWalker.java:78)
	at org.apache.hadoop.hive.ql.lib.LevelOrderWalker.walk(LevelOrderWalker.java:143)
	at org.apache.hadoop.hive.ql.lib.LevelOrderWalker.walk(LevelOrderWalker.java:149)
	at org.apache.hadoop.hive.ql.lib.LevelOrderWalker.walk(LevelOrderWalker.java:149)
	at org.apache.hadoop.hive.ql.lib.LevelOrderWalker.startWalking(LevelOrderWalker.java:122)
	at org.apache.hadoop.hive.ql.optimizer.lineage.Generator.transform(Generator.java:102)
	at org.apache.hadoop.hive.ql.optimizer.Optimizer.optimize(Optimizer.java:198)
	at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:10054)
	at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:9868)
	at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:223)
	at org.apache.hadoop.hive.ql.Driver.compile(Driver.java:446)
	at org.apache.hadoop.hive.ql.Driver.compile(Driver.java:312)
	at org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:1201)
	at org.apache.hadoop.hive.ql.Driver.compileAndRespond(Driver.java:1188)
	at org.apache.hive.service.cli.operation.SQLOperation.prepare(SQLOperation.java:143)
	... 15 more
{code}, After a lot of investigation into these two errors, they seem to be slightly related.

The TL;DR is that I think there is a bug in the class {{ReduceSinkOperator}}, but I am not 100% sure.

I started debugging Exception 1 first. It seems that {{GenericUDFOPEqualOrGreaterThan}} tries to compare a {{Text}} object with value {{value_1_3}} to a {{DateWritable}} object with value {{2015-06-22}}. This happens inside the reduce method, and causes the code to throw a {{ClassCastException}} and fail.

I compared the query plans for Query 1 vs. Query 3 (the output of {{EXPLAIN ...}}). Both plans require a single Map-Reduce job. The major difference is that the Query 3 runs a Filter Operator in both the Map Task and the Reduce Task, while Query 1 only runs a Filter Operator in the Map Task. I suspect the Filter Operator in the Reduce Task of Query 3 is having some type of issue.

Here is the output of the {{EXPLAIN}} query:

{code}
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+
|                                                                                   Explain                                                                                   |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+
| STAGE DEPENDENCIES:                                                                                                                                                         |
|   Stage-2 is a root stage                                                                                                                                                   |
|   Stage-0 depends on stages: Stage-2                                                                                                                                        |
|   Stage-3 depends on stages: Stage-0                                                                                                                                        |
|   Stage-1 depends on stages: Stage-2                                                                                                                                        |
|   Stage-4 depends on stages: Stage-1                                                                                                                                        |
|                                                                                                                                                                             |
| STAGE PLANS:                                                                                                                                                                |
|   Stage: Stage-2                                                                                                                                                            |
|     Map Reduce                                                                                                                                                              |
|       Map Operator Tree:                                                                                                                                                    |
|           TableScan                                                                                                                                                         |
|             alias: multi_table_insert_source                                                                                                                                |
|             Statistics: Num rows: 5 Data size: 250 Basic stats: COMPLETE Column stats: NONE                                                                                 |
|             Filter Operator                                                                                                                                                 |
|               predicate: ((date_column >= 2013-06-21) or (date_column >= 2015-06-22)) (type: boolean)                                                                       |
|               Statistics: Num rows: 2 Data size: 100 Basic stats: COMPLETE Column stats: NONE                                                                               |
|               Select Operator                                                                                                                                               |
|                 expressions: column_1 (type: string), column_2 (type: string), column_3 (type: string), date_column (type: date)                                            |
|                 outputColumnNames: column_1, column_2, column_3, date_column                                                                                                |
|                 Statistics: Num rows: 2 Data size: 100 Basic stats: COMPLETE Column stats: NONE                                                                             |
|                 Reduce Output Operator                                                                                                                                      |
|                   key expressions: column_1 (type: string), column_2 (type: string), column_3 (type: string), date_column (type: date)                                      |
|                   sort order: ++++                                                                                                                                          |
|                   Map-reduce partition columns: column_1 (type: string), column_2 (type: string)                                                                            |
|                   Statistics: Num rows: 2 Data size: 100 Basic stats: COMPLETE Column stats: NONE                                                                           |
|       Reduce Operator Tree:                                                                                                                                                 |
|         Forward                                                                                                                                                             |
|           Statistics: Num rows: 2 Data size: 100 Basic stats: COMPLETE Column stats: NONE                                                                                   |
|           Filter Operator                                                                                                                                                   |
|             predicate: (KEY._col2:1._col0 >= 2015-06-22) (type: boolean)                                                                                                    |
|             Statistics: Num rows: 1 Data size: 50 Basic stats: COMPLETE Column stats: NONE                                                                                  |
|             Group By Operator                                                                                                                                               |
|               aggregations: count(), count(DISTINCT KEY._col2:0._col0), count(DISTINCT KEY._col2:1._col0, KEY._col2:1._col1)                                                |
|               keys: KEY._col0 (type: string), KEY._col1 (type: string)                                                                                                      |
|               mode: complete                                                                                                                                                |
|               outputColumnNames: _col0, _col1, _col2, _col3, _col4                                                                                                          |
|               Statistics: Num rows: 1 Data size: 50 Basic stats: COMPLETE Column stats: NONE                                                                                |
|               Select Operator                                                                                                                                               |
|                 expressions: _col0 (type: string), _col1 (type: string), UDFToInteger(_col2) (type: int), UDFToInteger(_col3) (type: int), UDFToInteger(_col4) (type: int)  |
|                 outputColumnNames: _col0, _col1, _col2, _col3, _col4                                                                                                        |
|                 Statistics: Num rows: 1 Data size: 50 Basic stats: COMPLETE Column stats: NONE                                                                              |
|                 File Output Operator                                                                                                                                        |
|                   compressed: false                                                                                                                                         |
|                   Statistics: Num rows: 1 Data size: 50 Basic stats: COMPLETE Column stats: NONE                                                                            |
|                   table:                                                                                                                                                    |
|                       input format: org.apache.hadoop.mapred.TextInputFormat                                                                                                |
|                       output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat                                                                             |
|                       serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe                                                                                             |
|                       name: multi_table_insert_bug.multi_table_insert_test                                                                                                  |
|           Filter Operator                                                                                                                                                   |
|             predicate: (KEY._col2:1._col0 >= 2013-06-21) (type: boolean)                                                                                                    |
|             Statistics: Num rows: 1 Data size: 50 Basic stats: COMPLETE Column stats: NONE                                                                                  |
|             Group By Operator                                                                                                                                               |
|               aggregations: count(), count(DISTINCT KEY._col2:0._col0), count(DISTINCT KEY._col2:1._col0, KEY._col2:1._col1)                                                |
|               keys: KEY._col0 (type: string), KEY._col1 (type: string)                                                                                                      |
|               mode: complete                                                                                                                                                |
|               outputColumnNames: _col0, _col1, _col2, _col3, _col4                                                                                                          |
|               Statistics: Num rows: 1 Data size: 50 Basic stats: COMPLETE Column stats: NONE                                                                                |
|               Select Operator                                                                                                                                               |
|                 expressions: _col0 (type: string), _col1 (type: string), UDFToInteger(_col2) (type: int), UDFToInteger(_col3) (type: int), UDFToInteger(_col4) (type: int)  |
|                 outputColumnNames: _col0, _col1, _col2, _col3, _col4                                                                                                        |
|                 Statistics: Num rows: 1 Data size: 50 Basic stats: COMPLETE Column stats: NONE                                                                              |
|                 File Output Operator                                                                                                                                        |
|                   compressed: false                                                                                                                                         |
|                   Statistics: Num rows: 1 Data size: 50 Basic stats: COMPLETE Column stats: NONE                                                                            |
|                   table:                                                                                                                                                    |
|                       input format: org.apache.hadoop.mapred.TextInputFormat                                                                                                |
|                       output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat                                                                             |
|                       serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe                                                                                             |
|                       name: multi_table_insert_bug.multi_table_insert_test                                                                                                  |
|                                                                                                                                                                             |
|   Stage: Stage-0                                                                                                                                                            |
|     Move Operator                                                                                                                                                           |
|       tables:                                                                                                                                                               |
|           partition:                                                                                                                                                        |
|             partition_column 365                                                                                                                                            |
|           replace: true                                                                                                                                                     |
|           table:                                                                                                                                                            |
|               input format: org.apache.hadoop.mapred.TextInputFormat                                                                                                        |
|               output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat                                                                                     |
|               serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe                                                                                                     |
|               name: multi_table_insert_bug.multi_table_insert_test                                                                                                          |
|                                                                                                                                                                             |
|   Stage: Stage-3                                                                                                                                                            |
|     Stats-Aggr Operator                                                                                                                                                     |
|                                                                                                                                                                             |
|   Stage: Stage-1                                                                                                                                                            |
|     Move Operator                                                                                                                                                           |
|       tables:                                                                                                                                                               |
|           partition:                                                                                                                                                        |
|             partition_column 1096                                                                                                                                           |
|           replace: true                                                                                                                                                     |
|           table:                                                                                                                                                            |
|               input format: org.apache.hadoop.mapred.TextInputFormat                                                                                                        |
|               output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat                                                                                     |
|               serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe                                                                                                     |
|               name: multi_table_insert_bug.multi_table_insert_test                                                                                                          |
|                                                                                                                                                                             |
|   Stage: Stage-4                                                                                                                                                            |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+
|                                                                                   Explain                                                                                   |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+
|     Stats-Aggr Operator                                                                                                                                                     |
|                                                                                                                                                                             |
+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--+
{code}

The {{ReduceSinkOperator}} class is emitting the record:

*Record 1:*

{code}
{"key":{"_col0":"value_1_1","_col1":"value_1_2","_col2":{0:{"_col0":"value_1_3"}}},"value":null}
{code}

Which does not contain the {{date_column}} column, causing the {{FilterOperator}} in the {{ExecReducer}} to fail.

Once I determined that {{ReduceSinkOperator}} is emitting this record, I did my best to trace through the logic of {{ReduceSinkOperator}} to figure out why it is emitting Record 1. The {{ReduceSinkOperator}} seems to emit a single record for each {{DISTINCT}} keyword in the query, but the record will only have a subset of its original columns. For each {{DISTINCT}} clause it will emit the columns in the {{DISTINCT}} clause itself, as well as the columns in the {{GROUP BY}}. For example, for {{COUNT(DISTINCT column_3)}} it will emit {{column_1}}, {{column_2}}, and {{column_3}}, but not the {{date_column}}. *I'm not sure the {{ReduceSinkOperator}} takes into account the situation where a {{FilterOperator}} can occur on the reduce-side of a Hive query, over a column not in the {{DISTINCT}} or {{GROUP BY}} clause.*

Exception 2 seems to be related to Exception 1. Exception 2 is thrown in the class {{OpProcFactory.ReduceSinkLineage.process(...)}} method. This method does some type of processing on the {{ReduceSinkOperator}} class (the same class mentioned above when analyzing Exception 1), so my guess is that they are related., I would like to work on fixing this, but I'm looking for some advice / help on how to debug this further, and what the correct approach for the fix would be., [~sershe], [~amareshwari] I noticed you both had made some additions to the {{ReduceSinkOperator}} class in HIVE-5657 and HIVE-474, respectively. Do you have any insight into the bug reported here?, Ping, anyone have any idea on this?]