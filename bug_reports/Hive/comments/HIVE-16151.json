[The patch. [~mmccline] can you take a look?, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12856910/HIVE-16151.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:green}SUCCESS:{color} +1 due to 10335 tests passed

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4042/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4042/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4042/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12856910 - PreCommit-HIVE-Build, RB at https://reviews.apache.org/r/57485/
cc [~gopalv], [~gopalv] can you review this at some point? thanks
[~mmccline] mentioned that you may not like this approach ;), ping? [~gopalv], [~gopalv] ping?, [~sershe]: Added to my build, will review , This came up as a ~4% performance loss in an extra null check, but does allow for larger hash tables.

LGTM - +1., 4% of what? if it's 4% of the query, it sounds like a lot., Yes, 4% of the query - this patch added 34-28s to a 636 second baseline.

findKeyRefToRead() is 46% of all cpu samples - with 20% of the cpu cycles around a single null-check., Need to look at that null check and where it happens, it could be avoidable. 4% seems too much as this is kind of obscure.
We could even just allocate all the memory at once as before, but in small chunks, eliminating it. Since with a good hash function, we expect every sub-array to be used anyway., Updated to eliminate the null check on read path., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12862414/HIVE-16151.01.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 3 failed/errored test(s), 10579 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[drop_with_concurrency] (batchId=235)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[escape_comments] (batchId=235)
org.apache.hive.jdbc.TestJdbcDriver2.testResultSetMetaData (batchId=221)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4606/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4606/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4606/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 3 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12862414 - PreCommit-HIVE-Build, [~gopalv] can you take a look at the updated patch? Thanks, [~gopalv] ping?]