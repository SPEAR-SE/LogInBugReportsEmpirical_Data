[

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12873122/HIVE-16357.01.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 11 failed/errored test(s), 10831 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_basic] (batchId=140)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=232)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query16] (batchId=232)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=232)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query94] (batchId=232)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testBootstrapFunctionReplication (batchId=216)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testCreateFunctionIncrementalReplication (batchId=216)
org.apache.hadoop.hive.ql.parse.TestReplicationScenariosAcrossInstances.testCreateFunctionWithFunctionBinaryJarsOnHDFS (batchId=216)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=177)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=177)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=177)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/5650/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/5650/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-5650/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 11 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12873122 - PreCommit-HIVE-Build, Failing tests have been failing for 5-39 runs., Hi [~zsombor.klara],

Thanks for the patch!
One nit: boolean successs - too much 's' :)

2 more interesting question:
- Do we need to send out a notification about an unsuccessful event with empty list of tables?
- The same change might be applied to the other events as well...

[~zsombor.klara], [~mohitsabharwal]: What do you think?

Thanks,
Peter
, Fixed the typo.
About your questions [~pvary]:
- a) valid question, but I don't know the answer to it. We send notifications for every event type irrespective of the failure/success status, I didn't want to change this.
- b) I can't find any other event that would match this error, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12877298/HIVE-16357.02.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 10891 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[parquet_ppd_decimal] (batchId=9)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[llap_smb] (batchId=143)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=232)
org.apache.hive.beeline.TestBeeLineWithArgs.testQueryProgressParallel (batchId=220)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=177)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=177)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=177)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6036/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6036/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6036/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12877298 - PreCommit-HIVE-Build, I think [~pvary] brings up a valid question. Why do we fire events even if the operation failed? [~spena] any ideas?

It seems {{NotificationListener}} always checks the status of a given event before firing a notification for it., I'm not sure why either. I don't think we should trigger events with failed operations, but the code was already there. Perhaps we could fix this and trigger the events only when it succeeds ?, I modified the DbNotificationListener to process only successful events. (And moved the reporting of table creation out of the finally block).
If there are no test failures then I guess the change is OK.
For the record the NotificationListener already worked like this, so only successful events were accepted., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12879600/HIVE-16357.03.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 11018 tests executed
*Failed tests:*
{noformat}
TestPerfCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=235)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[materialized_view_create_rewrite] (batchId=240)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=142)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_vectorized_dynamic_partition_pruning] (batchId=168)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=179)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=179)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=179)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6196/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6196/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6196/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12879600 - PreCommit-HIVE-Build, Removed changes from the MetaStore class and made notifications more resilient. An exception from one listener should not affect the rest of the listeners., Thanks for the patch [~zsombor.klara]!
I like this solution. +1 pending tests.

Peter, [~zsombor.klara] I don't understand why triggering events with failed operations cause this error. Seems the fix you did will not fix the original problem.

This patch fixes an issue that shouldn't cause issues on HMS. Btw, for a future fix, I would think is better to check the status on the HiveMetaStore side itself and do not trigger the event instead of doing it on the DbNotificationListener. Even if this avoids triggering failed events, developers will still get confused about why notifyEvent() is called on the HiveMetaStore with failed transactions?

, [~spena]: The original issue is the following with the original code:
- When the table creation is failed
- DBNotificationListener will be triggered with incomplete data
- DBNotificationListener will throw a new exception which will mask the original from the user, making it harder to find the root problem

The patch fixes it by adding the check inside the DBNotificationListener, thus avoiding throwing the second exception. Also the patch makes sure that if there is any further exceptions thrown by the DBNotificationListener, or any other Listener configured by the user, they are catched, logged and not propagated further.

The rationale behind this solution is the following:
- Listeners can be configured by the user, so they can have different usages. For example one listener might only collect failed table creation events. In this case the listeners should be notified on every event, and the listener should decide which event to handle, and which event to omit.
- DBNotificationListener on the other hand is not interested in the failed events, so it should skip these events.
- Also we thought, that listeners are configured by the users, so their code can be unstable, buggy. With this in mind, it would be good be sure that they do not affect each other. So if there is an error in one listener then the other listeners should still be notified.

We might not be aware of every usage patterns of the Listeners, or might overcomplicate this Listener architecture. What do you think [~spena]? Is it worth to be prepared to these use-cases?

Thanks,
Peter, [~pvary] Why is the DbNotificationListener called when a table failed? I see this event is called inside the try block, and if a table fails and an exception is thrown, then this shouldn't be called, right? What am I missing? Btw, DbNotificationListener is a transactional listener, so it is only called inside the try block (no in the finally).

See this line
https://github.com/apache/hive/blob/master/metastore/src/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java#L1547, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12879795/HIVE-16357.04.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 8 failed/errored test(s), 11040 tests executed
*Failed tests:*
{noformat}
TestPerfCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=236)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[create_merge_compressed] (batchId=241)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[partition_wise_fileformat5] (batchId=3)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_vectorized_dynamic_partition_pruning] (batchId=168)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3] (batchId=99)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=179)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=179)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=179)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6215/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6215/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6215/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 8 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12879795 - PreCommit-HIVE-Build, [~spena] is right in that the transactional listener should not be called after a failed table creation.
I still have two issues with the current code:
- transactional and non transactional listeners are not typed. There is nothing preventing me from configuring the DbNotificationListener as a non transactional one. This is exactly the error I did when testing my patch.
- error reporting is still brittle as the non transactional listener is throwing checked exception which are not handled in the finally block so may end up overwriting the actual exception.

However since I cannot reproduce the issue (I honestly don't remember how I encountered it) and since it seems so rare that no one else ran into it, I will close the issue as cannot reproduce. I don't think the issue is severe enough to warrant any more attention., Hive 3.0.0 has been released so closing this jira.]