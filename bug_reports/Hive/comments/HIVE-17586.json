[

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12888949/HIVE-17586.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 11055 tests executed
*Failed tests:*
{noformat}
TestAccumuloCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=231)
TestDummy - did not produce a TEST-*.xml file (likely timed out) (batchId=231)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[empty_join] (batchId=76)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=156)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_explainuser_1] (batchId=170)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=235)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=235)
org.apache.hadoop.hive.cli.TestSparkNegativeCliDriver.org.apache.hadoop.hive.cli.TestSparkNegativeCliDriver (batchId=242)
org.apache.hive.service.cli.session.TestSessionManagerMetrics.testThreadPoolMetrics (batchId=197)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6979/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6979/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6979/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12888949 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12888994/HIVE-17586.1.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 11061 tests executed
*Failed tests:*
{noformat}
TestAccumuloCliDriver - did not produce a TEST-*.xml file (likely timed out) (batchId=231)
TestDummy - did not produce a TEST-*.xml file (likely timed out) (batchId=231)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_join_stats2] (batchId=83)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[union_fast_stats] (batchId=156)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_explainuser_1] (batchId=170)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=235)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=235)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6984/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6984/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6984/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12888994 - PreCommit-HIVE-Build, Above test failures don't seem related to patch., Hi [~xuefuz], we're setting {{allowCoreThreadTimeOut(true)}} to the [thread pool|https://github.com/apache/hive/blob/master/service/src/java/org/apache/hive/service/cli/session/SessionManager.java#L186], which means the core threads will be terminated when they're idle for some time. Do you think that will solve the problem here?, Actually no according to java doc at https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ThreadPoolExecutor.html:

{quote}
If the pool currently has more than corePoolSize threads, excess threads will be terminated if they have been idle for more than the keepAliveTime (see getKeepAliveTime(java.util.concurrent.TimeUnit)).
{quote}
 
Because we use fixed pool size, there are no "excess threads" to idle out., [~xuefuz], the {{allowCoreThreadTimeOut}} controls whether we allow core threads to time out like "excess threads":
{code}
     * Sets the policy governing whether core threads may time out and
     * terminate if no tasks arrive within the keep-alive time, being
     * replaced if needed when new tasks arrive. When false, core
     * threads are never terminated due to lack of incoming
     * tasks. When true, the same keep-alive policy applying to
     * non-core threads applies also to core threads.
{code}
So I think although the pool has a fixed size (core size == max size), the threads can idle out. What do you think?, [~lirui] Thanks for sharing your findings. I think variable pool size and allowing core threads to idle out are two different aspects of thread pooling. They don't contradicting with each other. Plus, the patch doesn't change any behavior, but just making the threadpool be more genera.

On the other hand, it does bring an interesting point about the ojbect/memory leaks that I observed in our production cluster. i guess I will go back to investigate a little bit more.]