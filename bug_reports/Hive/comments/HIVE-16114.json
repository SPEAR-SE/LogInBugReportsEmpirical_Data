[the corresponding HiveServer2 stack:
2017-03-02T10:50:31,986 ERROR [HiveServer2-Background-Pool: Thread-982] exec.Task: Failed to execute tez graph.
java.lang.NullPointerException
   at org.apache.hadoop.hive.ql.exec.tez.TezSessionPoolManager.canWorkWithSameSession(TezSessionPoolManager.java:430)
   at org.apache.hadoop.hive.ql.exec.tez.TezSessionPoolManager.getSession(TezSessionPoolManager.java:451)
   at org.apache.hadoop.hive.ql.exec.tez.TezSessionPoolManager.getSession(TezSessionPoolManager.java:396)
   at org.apache.hadoop.hive.ql.exec.tez.TezTask.execute(TezTask.java:134)
   at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:197)
   at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:100)
   at org.apache.hadoop.hive.ql.Driver.launchTask(Driver.java:2073)
   at org.apache.hadoop.hive.ql.Driver.execute(Driver.java:1744)
   at org.apache.hadoop.hive.ql.Driver.runInternal(Driver.java:1453)
   at org.apache.hadoop.hive.ql.Driver.run(Driver.java:1171)
   at org.apache.hadoop.hive.ql.Driver.run(Driver.java:1166)
   at org.apache.hive.service.cli.operation.SQLOperation.runQuery(SQLOperation.java:242)
   at org.apache.hive.service.cli.operation.SQLOperation.access$800(SQLOperation.java:91)
   at org.apache.hive.service.cli.operation.SQLOperation$BackgroundWork$1.run(SQLOperation.java:334)
   at java.security.AccessController.doPrivileged(Native Method)
   at javax.security.auth.Subject.doAs(Subject.java:422)
   at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1660)
   at org.apache.hive.service.cli.operation.SQLOperation$BackgroundWork.run(SQLOperation.java:347)
   at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
   at java.util.concurrent.FutureTask.run(FutureTask.java:266)
   at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
   at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
   at java.lang.Thread.run(Thread.java:745), the blame code snippet:
 <code>
  if (doAsEnabled != session.getConf().getBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ENABLE_DOAS))
 </code>
it seems that the session got from threadlocal has not been opened yet or has been closed, So the session.getConf() is probably null. , [~sershe]  can you take a look? thanks, The patch makes sense to me... I wonder though how a closed session state ends up there. Can you add a warning if the session is closed? Might be worth checking and adding it even in TezTask, near the "Need to remove this static hack" comment :), Thanks [~sershe]. Add some comments in TezTask as needed. , 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12856595/HIVE-16114.1.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 10328 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[schema_evol_text_vec_table] (batchId=147)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=140)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=224)
org.apache.hadoop.hive.cli.TestSparkCliDriver.testCliDriver[vector_between_in] (batchId=119)
org.apache.hadoop.hive.ql.exec.tez.TestTezSessionPool.testGetNonDefaultSession (batchId=264)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/3998/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/3998/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-3998/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12856595 - PreCommit-HIVE-Build, testGetNonDefaultSession failure may be related, fixed the test failures shown above and passed tests my laptop.  when an application finishes abnormally,  the hs2 may try to close the corresponding nondefault ```TezSessionState```, the ```conf``` in TezSessionState assigns to null as a result,  when the same user submits a job again, there is a chance that makes such thing happen.
, +1, thanks for the patch! Will commit later today if noone objects. cc [~sseth], 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12856770/HIVE-16114.2.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 1 failed/errored test(s), 10333 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[schema_evol_text_vec_table] (batchId=147)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4024/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4024/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4024/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12856770 - PreCommit-HIVE-Build, Committed to master. Thanks for the patch!]