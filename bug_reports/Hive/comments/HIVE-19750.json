[[~gopalv], could you review please
cc [~sankarh], [~ekoifman],

I just have one comment. "Need to normalize (change to lower case) the db and table name when insert to NEXT_WRITE_ID. Not sure if we get it in lower case from Table object".

Also, one question,

- What will happen to non-ACID tables which were previously converted to ACID in 3.0.0 and then upgraded to 3.1.0? It will have original files but the write_id starts with 1.

 

 , [~sankarh]
I don't we have to lower case because they are read from Meta store objects which already supposed to have them normalized.

It doesn't affect 3.0 tables.  Current scheme for conversion puts all 'original' files in writeid 0.
This patch gives us flexibility moving forward to have other write IDs for originals, all of which are 'committed'., Thanks for the explanation [~ekoifman]!

+1, pending tests, | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
|| || || || {color:brown} master Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 31s{color} | {color:blue} Maven dependency ordering for branch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m 19s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m 36s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  1m  2s{color} | {color:green} master passed {color} |
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  3m 36s{color} | {color:blue} ql in master has 2278 extant Findbugs warnings. {color} |
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  2m 41s{color} | {color:blue} standalone-metastore in master has 214 extant Findbugs warnings. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 40s{color} | {color:green} master passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m  8s{color} | {color:blue} Maven dependency ordering for patch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  2m  0s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m 36s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  1m 36s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  0m 43s{color} | {color:red} ql: The patch generated 2 new + 1016 unchanged - 3 fixed = 1018 total (was 1019) {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  0m 19s{color} | {color:red} standalone-metastore: The patch generated 3 new + 566 unchanged - 0 fixed = 569 total (was 566) {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:red}-1{color} | {color:red} findbugs {color} | {color:red}  2m 59s{color} | {color:red} standalone-metastore generated 1 new + 214 unchanged - 0 fixed = 215 total (was 214) {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 40s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 12s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 31m 28s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| FindBugs | module:standalone-metastore |
|  |  org.apache.hadoop.hive.metastore.txn.TxnHandler.seedWriteIdOnAcidConversion(InitializeTableWriteIdsRequest) passes a nonconstant String to an execute or addBatch method on an SQL statement  At TxnHandler.java:to an execute or addBatch method on an SQL statement  At TxnHandler.java:[line 1516] |
\\
\\
|| Subsystem || Report/Notes ||
| Optional Tests |  asflicense  javac  javadoc  findbugs  checkstyle  compile  |
| uname | Linux hiveptest-server-upstream 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /data/hiveptest/working/yetus_PreCommit-HIVE-Build-11481/dev-support/hive-personality.sh |
| git revision | master / 8cb99d6 |
| Default Java | 1.8.0_111 |
| findbugs | v3.0.0 |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-11481/yetus/diff-checkstyle-ql.txt |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-11481/yetus/diff-checkstyle-standalone-metastore.txt |
| findbugs | http://104.198.109.242/logs//PreCommit-HIVE-Build-11481/yetus/new-findbugs-standalone-metastore.html |
| modules | C: ql standalone-metastore U: . |
| Console output | http://104.198.109.242/logs//PreCommit-HIVE-Build-11481/yetus.txt |
| Powered by | Apache Yetus    http://yetus.apache.org |


This message was automatically generated.

, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12926236/HIVE-19750.02.patch

{color:green}SUCCESS:{color} +1 due to 4 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 14448 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[acid_vectorization_original] (batchId=173)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[acid_vectorization_original_tez] (batchId=105)
org.apache.hadoop.hive.ql.TestTxnCommands.testNonAcidToAcidConversion01 (batchId=302)
org.apache.hadoop.hive.ql.TestTxnCommandsWithSplitUpdateAndVectorization.testNonAcidToAcidConversion01 (batchId=286)
org.apache.hive.hcatalog.pig.TestHCatLoaderComplexSchema.testMapNullKey[3] (batchId=196)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/11481/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/11481/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-11481/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.YetusPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12926236 - PreCommit-HIVE-Build, This is very odd. Test bot reports a failure:
{noformat}
Regression
org.apache.hadoop.hive.ql.TestTxnCommandsWithSplitUpdateAndVectorization.testNonAcidToAcidConversion01

Failing for the past 1 build (Since Failed#11481 )
Took 13 sec.
Error Message
{"writeid":0,"bucketid":536936448,"rowid":0} 1 2 file:/home/hiveptest/35.232.255.26-hiveptest-0/apache-github-source-source/ql/target/tmp/org.apache.hadoop.hive.ql.TestTxnCommands-1528061700968/warehouse/nonacidorctbl/base_10000001/bucket_00001
Stacktrace
java.lang.AssertionError: {"writeid":0,"bucketid":536936448,"rowid":0}	1	2	file:/home/hiveptest/35.232.255.26-hiveptest-0/apache-github-source-source/ql/target/tmp/org.apache.hadoop.hive.ql.TestTxnCommands-1528061700968/warehouse/nonacidorctbl/base_10000001/bucket_00001
	at org.junit.Assert.fail(Assert.java:88)
	at org.junit.Assert.assertTrue(Assert.java:41)
	at org.apache.hadoop.hive.ql.TestTxnCommands.testNonAcidToAcidConversion01(TestTxnCommands.java:915)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
{noformat}
but {{TestTxnCommandsWithSplitUpdateAndVectorization.testNonAcidToAcidConversion01}} does not exist.
 {{TestTxnCommandsWithSplitUpdateAndVectorization extends TestTxnCommands2}} not {{TestTxnCommands}}

 

 

{{org.apache.hadoop.hive.ql.TestTxnCommands.testNonAcidToAcidConversion01}} does exist but the 2 failure messages are identical except for the host name in the file path....


former: https://builds.apache.org/job/PreCommit-HIVE-Build/11481/testReport/org.apache.hadoop.hive.ql/TestTxnCommandsWithSplitUpdateAndVectorization/testNonAcidToAcidConversion01/

latter: https://builds.apache.org/job/PreCommit-HIVE-Build/11481/testReport/org.apache.hadoop.hive.ql/TestTxnCommands/testNonAcidToAcidConversion01/
, fix some test output in patch 3, | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
|| || || || {color:brown} master Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 32s{color} | {color:blue} Maven dependency ordering for branch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m  8s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m 29s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 57s{color} | {color:green} master passed {color} |
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  3m 23s{color} | {color:blue} ql in master has 2280 extant Findbugs warnings. {color} |
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  2m 36s{color} | {color:blue} standalone-metastore in master has 214 extant Findbugs warnings. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 35s{color} | {color:green} master passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m  8s{color} | {color:blue} Maven dependency ordering for patch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  1m 57s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m 28s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  1m 28s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  0m 42s{color} | {color:red} ql: The patch generated 2 new + 1016 unchanged - 3 fixed = 1018 total (was 1019) {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  0m 19s{color} | {color:red} standalone-metastore: The patch generated 3 new + 566 unchanged - 0 fixed = 569 total (was 566) {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:red}-1{color} | {color:red} findbugs {color} | {color:red}  2m 39s{color} | {color:red} standalone-metastore generated 1 new + 214 unchanged - 0 fixed = 215 total (was 214) {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 37s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:red}-1{color} | {color:red} asflicense {color} | {color:red}  0m 11s{color} | {color:red} The patch generated 2 ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 29m 59s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| FindBugs | module:standalone-metastore |
|  |  org.apache.hadoop.hive.metastore.txn.TxnHandler.seedWriteIdOnAcidConversion(InitializeTableWriteIdsRequest) passes a nonconstant String to an execute or addBatch method on an SQL statement  At TxnHandler.java:to an execute or addBatch method on an SQL statement  At TxnHandler.java:[line 1516] |
\\
\\
|| Subsystem || Report/Notes ||
| Optional Tests |  asflicense  javac  javadoc  findbugs  checkstyle  compile  |
| uname | Linux hiveptest-server-upstream 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /data/hiveptest/working/yetus_PreCommit-HIVE-Build-11539/dev-support/hive-personality.sh |
| git revision | master / 0992d82 |
| Default Java | 1.8.0_111 |
| findbugs | v3.0.0 |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-11539/yetus/diff-checkstyle-ql.txt |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-11539/yetus/diff-checkstyle-standalone-metastore.txt |
| findbugs | http://104.198.109.242/logs//PreCommit-HIVE-Build-11539/yetus/new-findbugs-standalone-metastore.html |
| asflicense | http://104.198.109.242/logs//PreCommit-HIVE-Build-11539/yetus/patch-asflicense-problems.txt |
| modules | C: ql standalone-metastore U: . |
| Console output | http://104.198.109.242/logs//PreCommit-HIVE-Build-11539/yetus.txt |
| Powered by | Apache Yetus    http://yetus.apache.org |


This message was automatically generated.

, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12926304/HIVE-19750.03.patch

{color:green}SUCCESS:{color} +1 due to 4 test(s) being added or modified.

{color:green}SUCCESS:{color} +1 due to 14467 tests passed

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/11539/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/11539/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-11539/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.YetusPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12926304 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12926304/HIVE-19750.03.patch

{color:red}ERROR:{color} -1 due to build exiting with an error

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/11547/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/11547/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-11547/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Tests exited with: Exception: Patch URL https://issues.apache.org/jira/secure/attachment/12926304/HIVE-19750.03.patch was found in seen patch url's cache and a test was probably run already on it. Aborting...
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12926304 - PreCommit-HIVE-Build, patch 3 pushed to master

thanks Sankar for the review, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12926783/HIVE-19750.01-branch-3.patch

{color:red}ERROR:{color} -1 due to build exiting with an error

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/11623/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/11623/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-11623/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Tests exited with: NonZeroExitCodeException
Command 'bash /data/hiveptest/working/scratch/source-prep.sh' failed with exit status 1 and output '+ date '+%Y-%m-%d %T.%3N'
2018-06-08 18:00:20.895
+ [[ -n /usr/lib/jvm/java-8-openjdk-amd64 ]]
+ export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
+ JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
+ export PATH=/usr/lib/jvm/java-8-openjdk-amd64/bin/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
+ PATH=/usr/lib/jvm/java-8-openjdk-amd64/bin/:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
+ export 'ANT_OPTS=-Xmx1g -XX:MaxPermSize=256m '
+ ANT_OPTS='-Xmx1g -XX:MaxPermSize=256m '
+ export 'MAVEN_OPTS=-Xmx1g '
+ MAVEN_OPTS='-Xmx1g '
+ cd /data/hiveptest/working/
+ tee /data/hiveptest/logs/PreCommit-HIVE-Build-11623/source-prep.txt
+ [[ false == \t\r\u\e ]]
+ mkdir -p maven ivy
+ [[ git = \s\v\n ]]
+ [[ git = \g\i\t ]]
+ [[ -z branch-3 ]]
+ [[ -d apache-github-source-source ]]
+ [[ ! -d apache-github-source-source/.git ]]
+ [[ ! -d apache-github-source-source ]]
+ date '+%Y-%m-%d %T.%3N'
2018-06-08 18:00:20.897
+ cd apache-github-source-source
+ git fetch origin
From https://github.com/apache/hive
   13960aa..a0c465d  master     -> origin/master
   cf492a8..f6c8c12  branch-3   -> origin/branch-3
   acfd209..1c6d946  branch-3.0 -> origin/branch-3.0
+ git reset --hard HEAD
HEAD is now at 13960aa HIVE-18079 : Statistics: Allow HyperLogLog to be merged to the lowest-common-denominator bit-size (Gopal V via Prasanth J)
+ git clean -f -d
+ git checkout branch-3
Switched to branch 'branch-3'
Your branch is behind 'origin/branch-3' by 8 commits, and can be fast-forwarded.
  (use "git pull" to update your local branch)
+ git reset --hard origin/branch-3
HEAD is now at f6c8c12 HIVE-19817: Hive streaming API + dynamic partitioning + json/regex writer does not work (Prasanth Jayachandran reviewed by Ashutosh Chauhan)
+ git merge --ff-only origin/branch-3
Already up-to-date.
+ date '+%Y-%m-%d %T.%3N'
2018-06-08 18:00:23.190
+ rm -rf ../yetus_PreCommit-HIVE-Build-11623
+ mkdir ../yetus_PreCommit-HIVE-Build-11623
+ git gc
+ cp -R . ../yetus_PreCommit-HIVE-Build-11623
+ mkdir /data/hiveptest/logs/PreCommit-HIVE-Build-11623/yetus
+ patchCommandPath=/data/hiveptest/working/scratch/smart-apply-patch.sh
+ patchFilePath=/data/hiveptest/working/scratch/build.patch
+ [[ -f /data/hiveptest/working/scratch/build.patch ]]
+ chmod +x /data/hiveptest/working/scratch/smart-apply-patch.sh
+ /data/hiveptest/working/scratch/smart-apply-patch.sh /data/hiveptest/working/scratch/build.patch
Going to apply patch with: git apply -p0
+ [[ maven == \m\a\v\e\n ]]
+ rm -rf /data/hiveptest/working/maven/org/apache/hive
+ mvn -B clean install -DskipTests -T 4 -q -Dmaven.repo.local=/data/hiveptest/working/maven
protoc-jar: executing: [/tmp/protoc7367033663309093566.exe, --version]
libprotoc 2.5.0
protoc-jar: executing: [/tmp/protoc7367033663309093566.exe, -I/data/hiveptest/working/apache-github-source-source/standalone-metastore/src/main/protobuf/org/apache/hadoop/hive/metastore, --java_out=/data/hiveptest/working/apache-github-source-source/standalone-metastore/target/generated-sources, /data/hiveptest/working/apache-github-source-source/standalone-metastore/src/main/protobuf/org/apache/hadoop/hive/metastore/metastore.proto]
ANTLR Parser Generator  Version 3.5.2
Output file /data/hiveptest/working/apache-github-source-source/standalone-metastore/target/generated-sources/org/apache/hadoop/hive/metastore/parser/FilterParser.java does not exist: must build /data/hiveptest/working/apache-github-source-source/standalone-metastore/src/main/java/org/apache/hadoop/hive/metastore/parser/Filter.g
org/apache/hadoop/hive/metastore/parser/Filter.g
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-remote-resources-plugin:1.5:process (process-resource-bundles) on project hive-shims: Execution process-resource-bundles of goal org.apache.maven.plugins:maven-remote-resources-plugin:1.5:process failed. ConcurrentModificationException -> [Help 1]
[ERROR] 
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR] 
[ERROR] For more information about the errors and possible solutions, please read the following articles:
[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/PluginExecutionException
[ERROR] 
[ERROR] After correcting the problems, you can resume the build with the command
[ERROR]   mvn <goals> -rf :hive-shims
+ result=1
+ '[' 1 -ne 0 ']'
+ rm -rf yetus_PreCommit-HIVE-Build-11623
+ exit 1
'
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12926783 - PreCommit-HIVE-Build, Pushed to branch-3., This is released in Hive 3.1.0.]