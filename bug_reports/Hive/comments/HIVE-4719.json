[navis requested code review of "HIVE-4719 [jira] EmbeddedLockManager should be shared to all clients".

Reviewers: JIRA

HIVE-4719 EmbeddedLockManager should be shared to all clients

Currently, EmbeddedLockManager is created per Driver instance, so locking has no meaning.

TEST PLAN
  EMPTY

REVISION DETAIL
  https://reviews.facebook.net/D11229

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockManager.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/SharedLockManager.java

MANAGE HERALD RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/26721/

To: JIRA, navis
, brock has commented on the revision "HIVE-4719 [jira] EmbeddedLockManager should be shared to all clients".

  Hi Navis,

  Nice patch! What about moving the lock manager creation to a separate class, say "LockManagerFactory"?  I think that might be useful for a couple reasons:

  1) Driver is already complex it'd be nice to remove some of the complexity, if possible.
  2) I could be wrong, but it looks like with the current patch, there is a race condition where two HS2 clients could create a SharedLockManager at the same time?
  3) If using a factory method I think the additional interface of SharedLockManager wouldn't be required.

  What do you think about this proposal?

  Cheers!
  Brock

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java:201 I think the exception should be passed into the second argument of the constructor so we don't lose the stack trace.

REVISION DETAIL
  https://reviews.facebook.net/D11229

To: JIRA, navis
Cc: brock
, navis updated the revision "HIVE-4719 [jira] EmbeddedLockManager should be shared to all clients".

  Addressed comments

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D11229

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D11229?vs=34593&id=35109#toc

AFFECTED FILES
  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java
  ql/src/java/org/apache/hadoop/hive/ql/Context.java
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/DefaultLockFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockManager.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/LockManagerFactory.java

To: JIRA, navis
Cc: brock
, brock has commented on the revision "HIVE-4719 [jira] EmbeddedLockManager should be shared to all clients".

  Hi Navis,

  Thank you very much for the patch!  Once again, I am newish to this code so my comments might not be applicable.  However, I do have a question below in the case when a lockFactory and lockManager cannot be created.  I did note some very minor nits as well.

  Cheers!
  Brock

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java:143 It seems that if newInstance throws an exception than the member variable lockFactory will be null. When lockFactory is null createLockManager will return null. Then the member variable of Context, hiveLockMgr, will be null. In this case isLockRequired will always return false. I think that is a concern when locking is required?
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java:153 When lockFactory.create() throws an exception, createLockManager will return null. Then the member variable of Context, hiveLockMgr, will be null. In this case isLockRequired will always return false. I think that is a concern when locking is required?
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/DefaultLockFactory.java:40 nit: missing @Override
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/DefaultLockFactory.java:31 nit: missing @Override
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockFactory.java:44 nit: missing @Override
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockFactory.java:48 nit: missing @Override
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockFactory.java:58 nit: missing @Override

REVISION DETAIL
  https://reviews.facebook.net/D11229

To: JIRA, navis
Cc: brock
, navis has commented on the revision "HIVE-4719 [jira] EmbeddedLockManager should be shared to all clients".

  I think codes related to locks and hooks could be separated to another classes. But it would be better to concentrate on this specific issue.

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java:143 Yes, I considered throwing exception. But in the original implementation, if client failed to instantiate a lock manager, hive had just logs it and continued. I cannot sure which one is better.
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java:153 Same with above.
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/DefaultLockFactory.java:40 I'm in a little old way of thinking that implementation of interface is not override. But I'll add that.

REVISION DETAIL
  https://reviews.facebook.net/D11229

To: JIRA, navis
Cc: brock
, brock has commented on the revision "HIVE-4719 [jira] EmbeddedLockManager should be shared to all clients".

  Navis,

  The patch looks good to me. I think the issue where creation of the factory/manager can be taken forward in a follow JIRA since it's not related to the patch itself!

  Cheers!
  Brock

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java:143 Ahh interesting!  I don't think Hive should continue on if it cannot create a lock manager but is configured to use concurrency. However, I think we can handle this on a follow on JIRA.

REVISION DETAIL
  https://reviews.facebook.net/D11229

To: JIRA, navis
Cc: brock
, navis updated the revision "HIVE-4719 [jira] EmbeddedLockManager should be shared to all clients".

  addressed comments

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D11229

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D11229?vs=35109&id=35187#toc

AFFECTED FILES
  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java
  ql/src/java/org/apache/hadoop/hive/ql/Context.java
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/DefaultLockFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockManager.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/LockManagerFactory.java

To: JIRA, navis
Cc: brock
, Following tests failed:
* testCliDriver_lock1
* testCliDriver_lock2
* testCliDriver_lock3
* testCliDriver_lock4
* testNegativeCliDriver_insert_into1
* testNegativeCliDriver_insert_into2
* testNegativeCliDriver_insert_into3
* testNegativeCliDriver_insert_into4
* testNegativeCliDriver_lockneg1
* testNegativeCliDriver_lockneg2
* testNegativeCliDriver_lockneg3
* testNegativeCliDriver_lockneg4
* testNegativeCliDriver_lockneg5, navis updated the revision "HIVE-4719 [jira] EmbeddedLockManager should be shared to all clients".

  Fixed error (Sorry for immatured patch). Running test.

Reviewers: JIRA

REVISION DETAIL
  https://reviews.facebook.net/D11229

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D11229?vs=35187&id=35511#toc

AFFECTED FILES
  common/src/java/org/apache/hadoop/hive/conf/HiveConf.java
  ql/src/java/org/apache/hadoop/hive/ql/Context.java
  ql/src/java/org/apache/hadoop/hive/ql/Driver.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/DefaultLockManagerFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockFactory.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/EmbeddedLockManager.java
  ql/src/java/org/apache/hadoop/hive/ql/lockmgr/LockManagerFactory.java

To: JIRA, navis
Cc: brock
, ashutoshc has accepted the revision "HIVE-4719 [jira] EmbeddedLockManager should be shared to all clients".

  +1
  As Brock pointed out current semantics of just logging the exception in case of failure to acquire lock (even when Hive is configured to support concurrency) is not a correct one. We should take this up on follow on.

REVISION DETAIL
  https://reviews.facebook.net/D11229

BRANCH
  HIVE-4719

ARCANIST PROJECT
  hive

To: JIRA, ashutoshc, navis
Cc: brock
, Unfortunately patch went stale. Sorry about that [~navis] Can you rebase it?, There is some issues that should be fixed before commit. I'm on this., 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12643699/HIVE-4719.5.patch.txt

{color:red}ERROR:{color} -1 due to 9 failed/errored test(s), 5497 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_partscan_1_23
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_bucket_map_join_tez2
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_dynpart_sort_optimization
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_insert1
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_load_dyn_part1
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_tez_dml
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_tez_union
org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_root_dir_external_table
org.apache.hadoop.hive.ql.lockmgr.TestEmbeddedLockManager.testLocking
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-Build/142/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-Build/142/console

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 9 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12643699, 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12643911/HIVE-4719.6.patch.txt

{color:red}ERROR:{color} -1 due to 5 failed/errored test(s), 5505 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_orc_ends_with_nulls
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_stats_partscan_1_23
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_insert1
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver_tez_dml
org.apache.hadoop.hive.cli.TestMinimrCliDriver.testCliDriver_root_dir_external_table
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-Build/156/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-Build/156/console

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 5 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12643911, [~navis] Can you create RB entry for this ?]