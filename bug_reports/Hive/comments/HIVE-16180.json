[Attaching snapshots from the analysis.
1) Native memory spike happened at around 11:00:00PM (configured offheap cache size is 48GB). At this point memory used by direct byte buffer spiked to 51.7GB. !Native-mem-spike.png!
2) At around same time Full GC triggered and reclaimed 15GB of memory (12GB heap + 3 GB offheap) !FullGC-15GB-cleanup.png! !Full-gc-native-mem-cleanup.png!, +1 pending tests... should this also not be done when zero-copy reader is enabled?, [~sershe] can you please take a look?, Also it's not really a leak, it's just a delayed cleanup/, Yes. Orc side changes for ZCR might also be required. I haven't looked into it yet. Will do in a follow up. , Well.. if Full GC is not triggered. This can really be problematic. Worst case, no Full GC (very less heap occupancy) and lots of off heap BB allocations can take down the system. Null'fying it, we will lose reference and opportunity for cleanup. , What I mean for ZCR is that we should not call this when zcr is on, because we (may?) give buffers for ZCR reader/get them from it., Agreed. Assuming ZCR already takes care of it. , Added checks to not clean when ZCR is enabled. , 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12857456/HIVE-16180.2.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 1 failed/errored test(s), 10339 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[columnstats_part_coltype] (batchId=153)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4086/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4086/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4086/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12857456 - PreCommit-HIVE-Build, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12857456/HIVE-16180.2.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 1 failed/errored test(s), 10339 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[vector_if_expr] (batchId=141)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4088/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4088/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4088/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12857456 - PreCommit-HIVE-Build, +1 assuming test is unrelated, This needs some more changes. In some cases, this is trying to clean a ByteBuffer slice (view of the original ByteBuffer) which throws NPE in reflection get, which disables the cleaner for rest of the buffers. Will post new patch with fix. , this patch goes thru (and improves upon) the existing release-to-zcr mechanism. Also useZeroCopy flag is not needed, dataReader tracks that. Need to take care of one more spot (marked with TODO#), Tests at https://builds.apache.org/job/PreCommit-HIVE-Build/4234/testReport/ (HiveQA still fails to post). Failures need to be looked at, Simplifying the release logic - we can just remember the buffers in the beginning. Could be simplified even more by removing all the early release., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12859687/HIVE-16180.04.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 1 failed/errored test(s), 10480 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[comments] (batchId=35)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/4260/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/4260/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-4260/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12859687 - PreCommit-HIVE-Build, Failure is unrelated. [~prasanth_j]  can you take a look?, lgtm, +1, Committed to master. Thanks for the review!]