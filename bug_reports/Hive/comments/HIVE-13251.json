[[~jarcec] FYI. Seems we need to handle such backward compatibility although the file format/schema is incorrect to avro since some customers generated such files and see such issues after upgrading. , [~xuefuz] I'm wondering why we try to get schema info from the file rather than from the record in HIVE-5823 for decimal? , OK. Seems we are trying to read based on file schema and then convert based on record schema since record schema may not match the file., Attached the patch-1: when we read the file achema, we will try to read and convert the string to int for decimal scale, but we disallow setting precision and scale to string when hive creates the avro file. Added the positive and negative unit tests. , [~jarcec], [~ychena],[~ctang.ma] and [~szehon] can you take a look at the change?, It makes sense to me to support for those users for the previous version at little cost, +1, I'm no longer involved very actively in the project [~aihuaxu], so whatever the community decides :), Reattach the same patch since seems the job was killed somehow., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12793197/HIVE-13251.1.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 6 failed/errored test(s), 9819 tests executed
*Failed tests:*
{noformat}
TestSparkCliDriver-groupby3_map.q-sample2.q-auto_join14.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-groupby_map_ppr_multi_distinct.q-table_access_keys_stats.q-groupby4_noskew.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-join_rc.q-insert1.q-vectorized_rcfile_columnar.q-and-12-more - did not produce a TEST-*.xml file
TestSparkCliDriver-ppd_join4.q-join9.q-ppd_join3.q-and-12-more - did not produce a TEST-*.xml file
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_avro_decimal_old
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver_ivyDownload
{noformat}

Test results: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7258/testReport
Console output: http://ec2-174-129-184-35.compute-1.amazonaws.com/jenkins/job/PreCommit-HIVE-TRUNK-Build/7258/console
Test logs: http://ec2-174-129-184-35.compute-1.amazonaws.com/logs/PreCommit-HIVE-TRUNK-Build-7258/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 6 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12793197 - PreCommit-HIVE-TRUNK-Build, dec_old.avro is binary. Seems we had issue to apply patch for such file as I found from other jira in HIVE-5823.

I will do the same. I have verified the avro_decimal_old.q passed locally.

Commit instructions:
1. add attachment dec.avro to data/files folder
2. apply attached patch.
3. commit


, Pushed to master. Thanks to Szehon for reviewing.]