[I have difficulty to summarize this problem in a concise and precise way... Will update the summary once I find a good one., New summary has been updated, yhuai requested code review of "HIVE-4968 [jira] When deduplicate multiple SelectOperators, we should update RowResolver accordinly".

Reviewers: JIRA

Merge remote-tracking branch 'origin/trunk' into HIVE-4968

SELECT tmp3.key, tmp3.value, tmp3.count
FROM (SELECT tmp1.key as key, tmp1.value as value, tmp2.count as count
      FROM (SELECT key, value
            FROM src) tmp1
      JOIN (SELECT count(*) as count
            FROM src) tmp2
      ) tmp3;

The plan is executable.

SELECT tmp3.key, tmp3.value, tmp3.count
FROM (SELECT tmp1.key as key, tmp1.value as value, tmp2.count as count
      FROM (SELECT *
            FROM src) tmp1
      JOIN (SELECT count(*) as count
            FROM src) tmp2
      ) tmp3;

The plan is executable.

SELECT tmp4.key, tmp4.value, tmp4.count
FROM (SELECT tmp2.key as key, tmp2.value as value, tmp3.count as count
      FROM (SELECT *
            FROM (SELECT key, value
                  FROM src) tmp1 ) tmp2
      JOIN (SELECT count(*) as count
            FROM src) tmp3
      ) tmp4;

The plan is not executable.

The plan related to the MapJoin is

 Stage: Stage-5
    Map Reduce Local Work
      Alias -> Map Local Tables:
        tmp4:tmp2:tmp1:src
          Fetch Operator
            limit: -1
      Alias -> Map Local Operator Tree:
        tmp4:tmp2:tmp1:src
          TableScan
            alias: src
            Select Operator
              expressions:
                    expr: key
                    type: string
                    expr: value
                    type: string
              outputColumnNames: _col0, _col1
              HashTable Sink Operator
                condition expressions:
                  0
                  1 {_col0}
                handleSkewJoin: false
                keys:
                  0 []
                  1 []
                Position of Big Table: 1

  Stage: Stage-4
    Map Reduce
      Alias -> Map Operator Tree:
        $INTNAME
            Map Join Operator
              condition map:
                   Inner Join 0 to 1
              condition expressions:
                0
                1 {_col0}
              handleSkewJoin: false
              keys:
                0 []
                1 []
              outputColumnNames: _col2
              Position of Big Table: 1
              Select Operator
                expressions:
                      expr: _col0
                      type: string
                      expr: _col1
                      type: string
                      expr: _col2
                      type: bigint
                outputColumnNames: _col0, _col1, _col2
                File Output Operator
                  compressed: false
                  GlobalTableId: 0
                  table:
                      input format: org.apache.hadoop.mapred.TextInputFormat
                      output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
      Local Work:
        Map Reduce Local Work

The outputColumnNames of MapJoin is '_col2'. But it should be '_col0, _col1, _col2'

TEST PLAN
  EMPTY

REVISION DETAIL
  https://reviews.facebook.net/D11901

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/NonBlockingOpDeDupProc.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
  ql/src/test/queries/clientpositive/nonblock_op_deduplicate.q
  ql/src/test/results/clientpositive/nonblock_op_deduplicate.q.out

MANAGE HERALD RULES
  https://reviews.facebook.net/herald/view/differential/

WHY DID I GET THIS EMAIL?
  https://reviews.facebook.net/herald/transcript/28407/

To: JIRA, yhuai
, ashutoshc has accepted the revision "HIVE-4968 [jira] When deduplicate multiple SelectOperators, we should update RowResolver accordinly".

  Looks good. Some minor comments.

INLINE COMMENTS
  ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java:399 You are not using this method. Lets not add this.
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/NonBlockingOpDeDupProc.java:104 Can you add a comment saying something like we need to set row resolver of parent from the child which is in parse context to preserve column mappings.
  Feel free to improve on the wording here.

REVISION DETAIL
  https://reviews.facebook.net/D11901

BRANCH
  HIVE-4968

ARCANIST PROJECT
  hive

To: JIRA, ashutoshc, yhuai
, yhuai updated the revision "HIVE-4968 [jira] When deduplicate multiple SelectOperators, we should update RowResolver accordinly".

  addressed Ashutosh's comments

Reviewers: ashutoshc, JIRA

REVISION DETAIL
  https://reviews.facebook.net/D11901

CHANGE SINCE LAST DIFF
  https://reviews.facebook.net/D11901?vs=36669&id=36693#toc

BRANCH
  HIVE-4968

ARCANIST PROJECT
  hive

AFFECTED FILES
  ql/src/java/org/apache/hadoop/hive/ql/optimizer/NonBlockingOpDeDupProc.java
  ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
  ql/src/test/queries/clientpositive/nonblock_op_deduplicate.q
  ql/src/test/results/clientpositive/nonblock_op_deduplicate.q.out

To: JIRA, ashutoshc, yhuai
, addressed Ashutosh's comments, 

{color:green}Overall{color}: +1 all checks pass

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12595301/HIVE-4968.D11901.2.patch

{color:green}SUCCESS:{color} +1 2749 tests passed

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/268/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/268/console

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated., 

{color:red}Overall{color}: -1 at least one tests failed

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12595301/HIVE-4968.D11901.2.patch

{color:red}ERROR:{color} -1 due to 1 failed/errored test(s), 2749 tests executed
*Failed tests:*
{noformat}
org.apache.hcatalog.mapreduce.TestHCatHiveCompatibility.testPartedRead
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/270/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/270/console

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests failed with: TestsFailedException: 1 tests failed
{noformat}

This message is automatically generated., Committed to trunk. Thanks, Yin!, FAILURE: Integrated in Hive-trunk-hadoop2-ptest #41 (See [https://builds.apache.org/job/Hive-trunk-hadoop2-ptest/41/])
HIVE-4968 : When deduplicating multiple SelectOperators, we should update RowResolver accordinly (Yin Huai via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1509543)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/NonBlockingOpDeDupProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
* /hive/trunk/ql/src/test/queries/clientpositive/nonblock_op_deduplicate.q
* /hive/trunk/ql/src/test/results/clientpositive/nonblock_op_deduplicate.q.out
, SUCCESS: Integrated in Hive-trunk-hadoop1-ptest #113 (See [https://builds.apache.org/job/Hive-trunk-hadoop1-ptest/113/])
HIVE-4968 : When deduplicating multiple SelectOperators, we should update RowResolver accordinly (Yin Huai via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1509543)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/NonBlockingOpDeDupProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
* /hive/trunk/ql/src/test/queries/clientpositive/nonblock_op_deduplicate.q
* /hive/trunk/ql/src/test/results/clientpositive/nonblock_op_deduplicate.q.out
, ABORTED: Integrated in Hive-trunk-hadoop2 #322 (See [https://builds.apache.org/job/Hive-trunk-hadoop2/322/])
HIVE-4968 : When deduplicating multiple SelectOperators, we should update RowResolver accordinly (Yin Huai via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1509543)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/NonBlockingOpDeDupProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
* /hive/trunk/ql/src/test/queries/clientpositive/nonblock_op_deduplicate.q
* /hive/trunk/ql/src/test/results/clientpositive/nonblock_op_deduplicate.q.out
, SUCCESS: Integrated in Hive-trunk-h0.21 #2240 (See [https://builds.apache.org/job/Hive-trunk-h0.21/2240/])
HIVE-4968 : When deduplicating multiple SelectOperators, we should update RowResolver accordinly (Yin Huai via Ashutosh Chauhan) (hashutosh: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1509543)
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/optimizer/NonBlockingOpDeDupProc.java
* /hive/trunk/ql/src/java/org/apache/hadoop/hive/ql/parse/ParseContext.java
* /hive/trunk/ql/src/test/queries/clientpositive/nonblock_op_deduplicate.q
* /hive/trunk/ql/src/test/results/clientpositive/nonblock_op_deduplicate.q.out
, This issue has been fixed and released as part of 0.12 release. If you find further issues, please create a new jira and link it to this one.]