[GitHub user pudidic opened a pull request:

    https://github.com/apache/hive/pull/360

    HIVE-19723: Arrow serde: "Unsupported data type: Timestamp(NANOSECOND, null)"

    Spark's Arrow support only provides Timestamp at MICROSECOND granularity. Spark 2.3.0 won't accept NANOSECOND. Switch it back to MICROSECOND.
    The unit test org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow will just need to change the assertion to test microsecond. And we'll need to add this to documentation on supported datatypes.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/pudidic/hive HIVE-19723

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/hive/pull/360.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #360
    
----
commit 53e4224e05b2b6d96b19451716c41ae1eae7df68
Author: Teddy Choi <pudidic@...>
Date:   2018-05-28T06:56:07Z

    HIVE-19723: Arrow serde: "Unsupported data type: Timestamp(NANOSECOND, null)"

----
, Other than copying some of the random timestamp test logic in TestTimestampWritable that exercises things more, your change +1 LGTM tests pending., Patch #2 added a randomized test. Thanks [~mmccline] for feedback!, | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
|| || || || {color:brown} master Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m 54s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 56s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 39s{color} | {color:green} master passed {color} |
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  3m 33s{color} | {color:blue} ql in master has 2333 extant Findbugs warnings. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 49s{color} | {color:green} master passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  1m 16s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 53s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 54s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  0m 38s{color} | {color:red} ql: The patch generated 58 new + 552 unchanged - 46 fixed = 610 total (was 598) {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  3m 57s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 54s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 12s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 21m 12s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Optional Tests |  asflicense  javac  javadoc  findbugs  checkstyle  compile  |
| uname | Linux hiveptest-server-upstream 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /data/hiveptest/working/yetus_PreCommit-HIVE-Build-11384/dev-support/hive-personality.sh |
| git revision | master / 77ffe96 |
| Default Java | 1.8.0_111 |
| findbugs | v3.0.0 |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-11384/yetus/diff-checkstyle-ql.txt |
| modules | C: ql U: ql |
| Console output | http://104.198.109.242/logs//PreCommit-HIVE-Build-11384/yetus.txt |
| Powered by | Apache Yetus    http://yetus.apache.org |


This message was automatically generated.

, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12925888/HIVE-19732.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 1 failed/errored test(s), 14419 tests executed
*Failed tests:*
{noformat}
org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow.testDataTypes (batchId=242)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/11384/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/11384/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-11384/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.YetusPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 1 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12925888 - PreCommit-HIVE-Build, Committed to master and branch-3., [~teddy.choi], [~mmccline], {{TestJdbcWithMiniLlapArrow.testDataTypes}} is failing making our test runs fail.

https://issues.apache.org/jira/browse/HIVE-19760

Can you fix or revert asap? Thanks, I have reverted it for the time being, please resubmit and get a clean run before pushing it.

Cc [~vgarg], Reverted from branch-3 as well. [~teddy.choi] Can you run test on branch-3 as well, [~teddy.choi]

Hive's Arrow serializer appears to truncate down to MILLISECONDS, but the Jira description calls for MICROSECONDS.

This is motivated by {{org.apache.spark.sql.execution.arrow.ArrowUtils.scala}}
{code:java}
case ts: ArrowType.Timestamp if ts.getUnit == TimeUnit.MICROSECOND => TimestampType{code}

My understanding is that since the primary use-case for {{ArrowUtils}} is Python integration, some of the conversions are currently somewhat particular for Python. Perhaps Python/Pandas only supports MICROSECOND timestamps. 

FYI: [~hyukjin.kwon] [~bryanc]

, > My understanding is that since the primary use-case for ArrowUtils is Python integration, some of the conversions are currently somewhat particular for Python. Perhaps Python/Pandas only supports MICROSECOND timestamps. 

Python, with pandas and pyarrow, supports timestamps down to nanoseconds.  The reason for for using microseconds in Spark {{ArrowUtils}} is to match Sparks internal representation, which is in microseconds.  This way avoids any further conversions once read into the Spark JVM., I'm sorry. I'll fix it as soon as possible., [~ewohlstadter], [~bryanc]. I changed patch #3 to serialize into microsecond. It will deserialize millisecond, microsecond, and nanosecond. Also changed TestJdbcWithMiniLlapArrow to test in microsecond, not in nanosecond. Thanks for feedbacks., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
|| || || || {color:brown} master Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 38s{color} | {color:blue} Maven dependency ordering for branch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m 30s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m 30s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 53s{color} | {color:green} master passed {color} |
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  0m 33s{color} | {color:blue} itests/hive-unit in master has 2 extant Findbugs warnings. {color} |
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  3m 30s{color} | {color:blue} ql in master has 2284 extant Findbugs warnings. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m  8s{color} | {color:green} master passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m  7s{color} | {color:blue} Maven dependency ordering for patch {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  1m 45s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m 28s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  1m 28s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  0m 38s{color} | {color:red} ql: The patch generated 94 new + 656 unchanged - 48 fixed = 750 total (was 704) {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  1s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  4m  6s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m  9s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 10s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 24m 53s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Optional Tests |  asflicense  javac  javadoc  findbugs  checkstyle  compile  |
| uname | Linux hiveptest-server-upstream 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /data/hiveptest/working/yetus_PreCommit-HIVE-Build-11576/dev-support/hive-personality.sh |
| git revision | master / aae62d8 |
| Default Java | 1.8.0_111 |
| findbugs | v3.0.0 |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-11576/yetus/diff-checkstyle-ql.txt |
| modules | C: itests/hive-unit ql U: . |
| Console output | http://104.198.109.242/logs//PreCommit-HIVE-Build-11576/yetus.txt |
| Powered by | Apache Yetus    http://yetus.apache.org |


This message was automatically generated.

, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12926827/HIVE-19723.4.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:green}SUCCESS:{color} +1 due to 14477 tests passed

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/11576/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/11576/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-11576/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.YetusPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12926827 - PreCommit-HIVE-Build, Github user pudidic closed the pull request at:

    https://github.com/apache/hive/pull/360
, GitHub user pudidic opened a pull request:

    https://github.com/apache/hive/pull/369

    HIVE-19723: Arrow serde: "Unsupported data type: Timestamp(NANOSECOND, null)"

    This pull request added a randomized unit test, supports microsecond for Spark integration, and changed TestJdbcWithMiniLlapArrow to test microsecond.
    The previous pull request was hard to merge, due to some reverted conflicts on Apache master branch.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/pudidic/hive HIVE-19723

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/hive/pull/369.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #369
    
----
commit 1600141292aef67105a2df0435bd0bab52b1e4e3
Author: Teddy Choi <pudidic@...>
Date:   2018-06-07T16:14:08Z

    HIVE-19723: Arrow serde: "Unsupported data type: Timestamp(NANOSECOND, null)"

----
, Pushed to master and branch-3. Thanks, Teddy!, [~teddy.choi]

Serializer needs to create a {{TimeStampMicroTZVector}} instead of {{TimeStampMicroVector}}. 

See: {{org.apache.spark.sql.vectorized.ArrowColumnVector.ArrowColumnVector(ValueVector vector)}}

Can you create a new JIRA for that?, Github user pudidic closed the pull request at:

    https://github.com/apache/hive/pull/369
, [~ewohlstadter], I created HIVE-19853., This is released in Hive 3.1.0.]