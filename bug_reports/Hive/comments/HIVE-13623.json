[Hi, I've just seen this issue too on tez 0.7.0.  

Query works fine on mr engine and fine in presto but tez is producing incorrect results.   I'm using a CTE

{code:sql}
select  tableaCTE.intCol1, tableaCTE.strCol2
from (
  select distinct intCol1, strCol2
  from tablea ) tableaCTE
    left outer join tableb on (
             tableaCTE.strCol2=tableb.strCol2 AND
            tableaCTE.intCol1=tableb.intCol1
           )
where tableb.intCol1 IS NULL
{code}

I've tried rewriting the query to use a WITH clause for the CTE and it made no difference.

*however* if I save my data to a temp table first, the query does return correct results, so I'd be inclined to think that this is a runtime interpretation of the CTE being handled incorrectly.

When I set the execution engine to mapreduce, it works fine and returns expected results, and this same query returns expected results in presto as well.    It appears to be a tez related issue.

I know this is marked as trivial, but I'll argue that if hiveQL is returning incorrect results on this pattern it shouldn't be interpreted as trivial.

Below is my actual explain plan for my real query:
{code}
Explain
Plan not optimized by CBO.

Vertex dependency in root stage
Reducer 2 <- Map 1 (SIMPLE_EDGE), Map 4 (CUSTOM_SIMPLE_EDGE)
Reducer 3 <- Reducer 2 (SIMPLE_EDGE)

Stage-0
   Fetch Operator
      limit:-1
      Stage-1
         Reducer 3
         File Output Operator [FS_28]
            compressed:true
            Statistics:Num rows: 5032426 Data size: 523372372 Basic stats: COMPLETE Column stats: NONE
            table:{"serde:":"org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe","input format:":"org.apache.hadoop.mapred.TextInputFormat","output format:":"org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat"}
            Select Operator [OP_27]
            |  outputColumnNames:["_col0","_col1","_col2","_col3","_col4"]
            |  Statistics:Num rows: 5032426 Data size: 523372372 Basic stats: COMPLETE Column stats: NONE
            |<-Reducer 2 [SIMPLE_EDGE]
               Reduce Output Operator [RS_26]
                  key expressions:_col0 (type: int), _col1 (type: string)
                  sort order:++
                  Statistics:Num rows: 5032426 Data size: 523372372 Basic stats: COMPLETE Column stats: NONE
                  value expressions:_col2 (type: int), _col3 (type: string), _col4 (type: boolean)
                  Select Operator [OP_25]
                     outputColumnNames:["_col0","_col1","_col2","_col3","_col4"]
                     Statistics:Num rows: 5032426 Data size: 523372372 Basic stats: COMPLETE Column stats: NONE
                     Filter Operator [FIL_24]
                        predicate:_col4 is null (type: boolean)
                        Statistics:Num rows: 5032426 Data size: 523372372 Basic stats: COMPLETE Column stats: NONE
                        Map Join Operator [MAPJOIN_23]
                        |  condition map:[{"":"Left Outer Join0 to 1"}]
                        |  keys:{"Reducer 2":"_col0 (type: int), _col1 (type: string)","Map 4":"dim_language_id (type: int), localized_level_name (type: string)"}
                        |  outputColumnNames:["_col0","_col1","_col4","_col5","_col6"]
                        |  Statistics:Num rows: 10064852 Data size: 1046744745 Basic stats: COMPLETE Column stats: NONE
                        |<-Map 4 [CUSTOM_SIMPLE_EDGE]
                        |  Reduce Output Operator [RS_20]
                        |     key expressions:dim_language_id (type: int), localized_level_name (type: string)
                        |     Map-reduce partition columns:dim_language_id (type: int), localized_level_name (type: string)
                        |     sort order:++
                        |     Statistics:Num rows: 7741 Data size: 1068258 Basic stats: COMPLETE Column stats: NONE
                        |     value expressions:dim_level_nl_id (type: int)
                        |     TableScan [TS_6]
                        |        alias:da
                        |        Statistics:Num rows: 7741 Data size: 1068258 Basic stats: COMPLETE Column stats: NONE
                        |<-Select Operator [OP_22]
                              outputColumnNames:["_col0","_col1"]
                              Statistics:Num rows: 9149866 Data size: 951586112 Basic stats: COMPLETE Column stats: NONE
                              Group By Operator [OP_21]
                              |  keys:KEY._col0 (type: int), KEY._col1 (type: string), KEY._col2 (type: int)
                              |  outputColumnNames:["_col0","_col1","_col2"]
                              |  Statistics:Num rows: 9149866 Data size: 951586112 Basic stats: COMPLETE Column stats: NONE
                              |<-Map 1 [SIMPLE_EDGE]
                                 Reduce Output Operator [RS_3]
                                    key expressions:_col0 (type: int), _col1 (type: string), _col2 (type: int)
                                    Map-reduce partition columns:_col0 (type: int), _col1 (type: string), _col2 (type: int)
                                    sort order:+++
                                    Statistics:Num rows: 18299732 Data size: 1903172224 Basic stats: COMPLETE Column stats: NONE
                                    Group By Operator [GBY_2]
                                       keys:dim_language_id (type: int), level (type: string), 1 (type: int)
                                       outputColumnNames:["_col0","_col1","_col2"]
                                       Statistics:Num rows: 18299732 Data size: 1903172224 Basic stats: COMPLETE Column stats: NONE
                                       Select Operator [SEL_1]
                                          outputColumnNames:["dim_language_id","level"]
                                          Statistics:Num rows: 18299732 Data size: 1903172224 Basic stats: COMPLETE Column stats: NONE
                                          TableScan [TS_0]
                                             alias:trapteam_fact_event_timeline
                                             Statistics:Num rows: 18299732 Data size: 1903172224 Basic stats: COMPLETE Column stats: NONE
{code}

I suspect this issue is related to HIVE-14027 as well, I have no issue with Hive-2.1.1 and Tez-0.8.4

{code}
with a as (
select 1 as c1
union all
select 2 as c1
union all
select 3 as c1
),
b as (
select 1 as c1
)
select * 
  from ( select a.c1 as ac1, b.c1 as bc1 
         from a left outer join b 
         on a.c1 = b.c1 
       ) c
  where c.bc1 is null;
{code}

Results is on TEZ

{code}
Status: Running (Executing on YARN cluster with App id application_1490371429102_0009)

----------------------------------------------------------------------------------------------
        VERTICES      MODE        STATUS  TOTAL  COMPLETED  RUNNING  PENDING  FAILED  KILLED  
----------------------------------------------------------------------------------------------
Map 1 .......... container     SUCCEEDED      1          1        0        0       0       0  
Map 3 .......... container     SUCCEEDED      1          1        0        0       0       0  
Map 4 .......... container     SUCCEEDED      1          1        0        0       0       0  
Map 5 .......... container     SUCCEEDED      1          1        0        0       0       0  
----------------------------------------------------------------------------------------------
VERTICES: 04/04  [==========================>>] 100%  ELAPSED TIME: 11.23 s    
----------------------------------------------------------------------------------------------

OK
2017-03-27 18:28:33,715 INFO  [c7d93c00-eb42-4731-bccb-a8fd56995bd9 main] mapred.FileInputFormat: Total input paths to process : 2
3	NULL
2	NULL
Time taken: 18.484 seconds, Fetched: 2 row(s)
{code}

Query plan on Hive-2.1.1 on Tez-0.8.4

{code}
    > explain with a as (
    > select 1 as c1
    > union all
    > select 2 as c1
    > union all
    > select 3 as c1
    > ),
    > b as (
    > select 1 as c1
    > )
    > select * 
    >   from ( select a.c1 as ac1, b.c1 as bc1 
    >          from a left outer join b 
    >          on a.c1 = b.c1 
    >        ) c
    >   where c.bc1 is null;
OK
STAGE DEPENDENCIES:
  Stage-1 is a root stage
  Stage-0 depends on stages: Stage-1

STAGE PLANS:
  Stage: Stage-1
    Tez
      DagId: mapr_20170327182950_39a484d6-3b9b-4021-a262-ba2d8722cf35:4
      Edges:
        Map 1 <- Map 5 (BROADCAST_EDGE), Union 2 (CONTAINS)
        Map 3 <- Map 5 (BROADCAST_EDGE), Union 2 (CONTAINS)
        Map 4 <- Map 5 (BROADCAST_EDGE), Union 2 (CONTAINS)
      DagName: 
      Vertices:
        Map 1 
            Map Operator Tree:
                TableScan
                  alias: _dummy_table
                  Row Limit Per Split: 1
                  Statistics: Num rows: 1 Data size: 1 Basic stats: COMPLETE Column stats: COMPLETE
                  Select Operator
                    expressions: 1 (type: int)
                    outputColumnNames: _col0
                    Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE
                    Map Join Operator
                      condition map:
                           Left Outer Join0 to 1
                      keys:
                        0 _col0 (type: int)
                        1 1 (type: int)
                      outputColumnNames: _col0, _col1
                      input vertices:
                        1 Map 5
                      Statistics: Num rows: 3 Data size: 24 Basic stats: COMPLETE Column stats: COMPLETE
                      HybridGraceHashJoin: true
                      Filter Operator
                        predicate: _col1 is null (type: boolean)
                        Statistics: Num rows: 1 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE
                        Select Operator
                          expressions: _col0 (type: int), null (type: int)
                          outputColumnNames: _col0, _col1
                          Statistics: Num rows: 1 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE
                          File Output Operator
                            compressed: false
                            Statistics: Num rows: 1 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE
                            table:
                                input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                                output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                                serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
        Map 3 
            Map Operator Tree:
                TableScan
                  alias: _dummy_table
                  Row Limit Per Split: 1
                  Statistics: Num rows: 1 Data size: 1 Basic stats: COMPLETE Column stats: COMPLETE
                  Select Operator
                    expressions: 2 (type: int)
                    outputColumnNames: _col0
                    Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE
                    Map Join Operator
                      condition map:
                           Left Outer Join0 to 1
                      keys:
                        0 _col0 (type: int)
                        1 1 (type: int)
                      outputColumnNames: _col0, _col1
                      input vertices:
                        1 Map 5
                      Statistics: Num rows: 3 Data size: 24 Basic stats: COMPLETE Column stats: COMPLETE
                      HybridGraceHashJoin: true
                      Filter Operator
                        predicate: _col1 is null (type: boolean)
                        Statistics: Num rows: 1 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE
                        Select Operator
                          expressions: _col0 (type: int), null (type: int)
                          outputColumnNames: _col0, _col1
                          Statistics: Num rows: 1 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE
                          File Output Operator
                            compressed: false
                            Statistics: Num rows: 1 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE
                            table:
                                input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                                output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                                serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
        Map 4 
            Map Operator Tree:
                TableScan
                  alias: _dummy_table
                  Row Limit Per Split: 1
                  Statistics: Num rows: 1 Data size: 1 Basic stats: COMPLETE Column stats: COMPLETE
                  Select Operator
                    expressions: 3 (type: int)
                    outputColumnNames: _col0
                    Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE
                    Map Join Operator
                      condition map:
                           Left Outer Join0 to 1
                      keys:
                        0 _col0 (type: int)
                        1 1 (type: int)
                      outputColumnNames: _col0, _col1
                      input vertices:
                        1 Map 5
                      Statistics: Num rows: 3 Data size: 24 Basic stats: COMPLETE Column stats: COMPLETE
                      HybridGraceHashJoin: true
                      Filter Operator
                        predicate: _col1 is null (type: boolean)
                        Statistics: Num rows: 1 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE
                        Select Operator
                          expressions: _col0 (type: int), null (type: int)
                          outputColumnNames: _col0, _col1
                          Statistics: Num rows: 1 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE
                          File Output Operator
                            compressed: false
                            Statistics: Num rows: 1 Data size: 8 Basic stats: COMPLETE Column stats: COMPLETE
                            table:
                                input format: org.apache.hadoop.mapred.SequenceFileInputFormat
                                output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat
                                serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe
        Map 5 
            Map Operator Tree:
                TableScan
                  alias: _dummy_table
                  Row Limit Per Split: 1
                  Statistics: Num rows: 1 Data size: 1 Basic stats: COMPLETE Column stats: COMPLETE
                  Select Operator
                    expressions: 1 (type: int)
                    outputColumnNames: _col0
                    Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE
                    Reduce Output Operator
                      key expressions: 1 (type: int)
                      sort order: +
                      Map-reduce partition columns: 1 (type: int)
                      Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE
                      value expressions: _col0 (type: int)
                    Reduce Output Operator
                      key expressions: 1 (type: int)
                      sort order: +
                      Map-reduce partition columns: 1 (type: int)
                      Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE
                      value expressions: _col0 (type: int)
                    Reduce Output Operator
                      key expressions: 1 (type: int)
                      sort order: +
                      Map-reduce partition columns: 1 (type: int)
                      Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE
                      value expressions: _col0 (type: int)
        Union 2 
            Vertex: Union 2

  Stage: Stage-0
    Fetch Operator
      limit: -1
      Processor Tree:
        ListSink

Time taken: 0.223 seconds, Fetched: 156 row(s)
{code}, This bug might be a dup of HIVE-14027]