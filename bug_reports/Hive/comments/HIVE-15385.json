[[~spena] does my explanation of the situation make sense? Any comments on whether or not failure to inherit permissions should cause query failures or not?, There are also a few places throughout {{Hive.java}} where exceptions thrown by {{setFullFileStatus}} are swallowed, but there also a bunch of places where exceptions are propagated to the caller., HIVE-7015 changed the logic so that failures to inherit permissions don't fail queries., Attaching pre-lim patch that changes the behavior of {{setFullFileStatus}} so it simply logs exceptions instead of throwing them. This is more consistent with the original behavior, and prevents introducing a backwards incompatible change to Hive.

The patch is still a WIP, but contains the major changes. If this approach looks good, there are some more tests I plan to add, some more documentation, and a little more refactoring.

In the future, maybe we can have a config that controls if failure to inherit permissions should cause queries to fail., 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12842306/HIVE-15385.1.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 10 failed/errored test(s), 10788 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[auto_sortmerge_join_2] (batchId=44)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[orc_ppd_schema_evol_3a] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=150)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainanalyze_2] (batchId=92)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2492/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2492/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2492/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 10 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12842306 - PreCommit-HIVE-Build, Attaching new patch:

* Added some more tests
* Added some more javadocs
* The {{setFullFileStatus}} method will now internally swallow any exception and log a warning
* Removed code where {{setFullFileStatus}} was called inside a try-catch block since its no longer possible for the method to throw an exception, [~spena] can you review? RB link: https://reviews.apache.org/r/54541/, What are the reasons of a inherit permission failure? 

Why do we want to continue the query if we cannot set the correct permissions? [~szehon] You wrote the permission wiki page, any info why this case?

The solution on the RB is good and simple for how we want to fix it. But, I don't know if HdfsUtils.setFullFileStatus() may be used by other code parts where we really want to get a failure in case a permission cannot be set. 

I noticed the method throws an IOException when recursion is used too. Do we want to remove that exception?, I think HIVE-7015 has some info for why failure to set permissions shouldn't result in failures. Here is the failure that I am hitting:

HDFS permission inheritance follows the BSD rule: when a new file is created, it inherits the group of the parent directory. There are situations in Hive when trying to inherit the group of the parent can fail, failure to set the group can occur in the following situation:

1: {{user1}} uploads a file into HDFS directory {{/test1/}} where {{/test1/}} has group {{user1}}
2: The {{/user/hive/warehouse}} directory was created by the {{hive}} user and has group {{hive}}
3: {{user1}} runs a query that loads data from {{/test1/}} and writes it to {{/user/hive/warehouse/}}
4: The problem is that when the data is moved from {{/test1/}} to {{/user/hive/warehouse/}}, it retains its original group {{user1}}
5: Hive then tries to set the group to {{hive}} in order to preserve permission inheritance, but this fails because the query is running as {{user1}}, but {{user1}} is not part of the {{hive}} group and is not allowed to change the group of a file to {{hive}}

I think the {{chgrp}} logic is similar to other standard POSIX systems.

I think there can be other situations too, but I'm not an expert in this area so I would have to play around with it some more.

I've confirmed that everywhere this method is used inherit perms is true, except for one place: {{DDLTask.truncateTable}} (which looks like it should be checking if inherit perms is true).

Most of the invocations of {{setFullFileStatus}} are wrapped by a try-catch block which just logs the exception. There are only a few place where they are propagated up to the caller, these were all introduced by HIVE-12988, HIVE-13716, and HIVE-13933 - seemingly by accident.
, Thanks [~stakiar] for the explanation. I spent some time investigating the history of this permission issue, and as you mentioned, the places where the IOException is not ignored could have been by accident.

Based on the history that permissions should not throw an exception and make the query to fail, I agree on just send a warning to the log inside the setFullFileStatus() instead of throwing an exception. This is confusing for people that want to use such method.

+1

I don't think tests failures are related, but could you re-attach the patch to see if the others stop failing?, I deleted the HiveQA comment and allow retriggering the Jenkins job., Thanks Sergio.

I believe [~ashutoshc] was working on  HIVE-12988, HIVE-13716, and HIVE-13933 - any chance you could comment on this JIRA. To summarize, Hive documentation claims that when {{hive.warehouse.subdir.inherit.perms}} is {{true}}, any failure to inherit permissions will not cause queries to fail, only a warning will be logged. It looks like the aforementioned JIRAs changed that by not catching exceptions thrown by {{HdfsUtils.setFullFileStatus}}, just wondering if that was intentional or not., yeah.. that was not conscious choice to alter behavior. Sounds good to restore documented behavior. Thanks for fixing this up. +1   , Thanks Ashutosh!, 

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12842388/HIVE-15385.2.patch

{color:green}SUCCESS:{color} +1 due to 1 test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 10798 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample2] (batchId=5)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample4] (batchId=15)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample6] (batchId=61)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample7] (batchId=60)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[sample9] (batchId=38)
org.apache.hadoop.hive.cli.TestMiniLlapCliDriver.testCliDriver[transform_ppr2] (batchId=134)
org.apache.hadoop.hive.cli.TestMiniLlapLocalCliDriver.testCliDriver[stats_based_fetch_decision] (batchId=150)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/2525/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/2525/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-2525/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12842388 - PreCommit-HIVE-Build, The test failures seem unrelated, and they are failing in other QA runs., Thanks [~stakiar]. I committed this to master., Sorry for late reply, glad it's figured out, thanks guys for taking care of it.]