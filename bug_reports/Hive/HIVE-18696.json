{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "fields": {
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "aggregatetimeestimate": null,
        "aggregatetimeoriginalestimate": null,
        "aggregatetimespent": null,
        "assignee": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Marta Kuczora",
            "key": "kuczoram",
            "name": "kuczoram",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=kuczoram",
            "timeZone": "Etc/UTC"
        },
        "components": [{
            "description": "Tracks issue dealing with metastore.",
            "id": "12312584",
            "name": "Metastore",
            "self": "https://issues.apache.org/jira/rest/api/2/component/12312584"
        }],
        "created": "2018-02-13T10:19:36.000+0000",
        "creator": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Marta Kuczora",
            "key": "kuczoram",
            "name": "kuczoram",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=kuczoram",
            "timeZone": "Etc/UTC"
        },
        "customfield_10010": null,
        "customfield_12310191": null,
        "customfield_12310192": null,
        "customfield_12310220": "2018-02-20T17:43:17.296+0000",
        "customfield_12310222": "1_*:*_1_*:*_629212409_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_4221457616",
        "customfield_12310230": null,
        "customfield_12310250": null,
        "customfield_12310290": null,
        "customfield_12310291": null,
        "customfield_12310300": null,
        "customfield_12310310": "6.0",
        "customfield_12310320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12310920": "9223372036854775807",
        "customfield_12310921": null,
        "customfield_12311020": null,
        "customfield_12311024": null,
        "customfield_12311120": null,
        "customfield_12311820": "0|i3q47r:",
        "customfield_12312022": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "customfield_12312026": null,
        "customfield_12312220": null,
        "customfield_12312320": null,
        "customfield_12312321": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312324": null,
        "customfield_12312325": null,
        "customfield_12312326": null,
        "customfield_12312327": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312330": null,
        "customfield_12312331": null,
        "customfield_12312332": null,
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12312335": null,
        "customfield_12312336": null,
        "customfield_12312337": null,
        "customfield_12312338": null,
        "customfield_12312339": null,
        "customfield_12312340": null,
        "customfield_12312341": null,
        "customfield_12312520": null,
        "customfield_12312521": "Tue Apr 10 13:44:06 UTC 2018",
        "customfield_12312720": null,
        "customfield_12312823": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "customfield_12312923": null,
        "customfield_12313422": "false",
        "customfield_12313520": null,
        "description": "When trying to add multiple partitions, but one of them cannot be created successfully, none of the partitions are created, but the folders might not be cleaned up properly. See the test case \"testAddPartitionsOneInvalid\" in the TestAddPartitions test.\r\n\r\nThis is the problematic code in the HiveMetaStore.add_partitions_core method:\r\n{code:java}\r\n        for (final Partition part : parts) {\r\n          if (!part.getTableName().equals(tblName) || !part.getDbName().equals(dbName)) {\r\n            throw new MetaException(\"Partition does not belong to target table \"\r\n                + dbName + \".\" + tblName + \": \" + part);\r\n          }\r\n\r\n          boolean shouldAdd = startAddPartition(ms, part, ifNotExists);\r\n          if (!shouldAdd) {\r\n            existingParts.add(part);\r\n            LOG.info(\"Not adding partition \" + part + \" as it already exists\");\r\n            continue;\r\n          }\r\n\r\n          final UserGroupInformation ugi;\r\n          try {\r\n            ugi = UserGroupInformation.getCurrentUser();\r\n          } catch (IOException e) {\r\n            throw new RuntimeException(e);\r\n          }\r\n\r\n          partFutures.add(threadPool.submit(new Callable<Partition>() {\r\n            @Override\r\n            public Partition call() throws Exception {\r\n              ugi.doAs(new PrivilegedExceptionAction<Object>() {\r\n                @Override\r\n                public Object run() throws Exception {\r\n                  try {\r\n                    boolean madeDir = createLocationForAddedPartition(table, part);\r\n                    if (addedPartitions.put(new PartValEqWrapper(part), madeDir) != null) {\r\n                      // Technically, for ifNotExists case, we could insert one and discard the other\r\n                      // because the first one now \"exists\", but it seems better to report the problem\r\n                      // upstream as such a command doesn't make sense.\r\n                      throw new MetaException(\"Duplicate partitions in the list: \" + part);\r\n                    }\r\n                    initializeAddedPartition(table, part, madeDir);\r\n                  } catch (MetaException e) {\r\n                    throw new IOException(e.getMessage(), e);\r\n                  }\r\n                  return null;\r\n                }\r\n              });\r\n              return part;\r\n            }\r\n          }));\r\n        }\r\n{code}\r\nWhen going through the partitions, let's say for the first two partitions the threads are successfully submitted to create the folders. But an exception occurs for the third partition in the code before submitting the thread. (It can happen if the partition has different table or db name as the others or it has invalid value.)\r\n In this case the execution will jump to the finally part where the folders in the \"addedPartitions\" map will be cleaned up. However it can happen that the threads for the first two partitions are not finished with the folder creation yet, so the map can be empty or it can contain only one of the partitions.\r\n\r\nThis issue also happens in the HiveMetastore.add_partitions_pspec_core method, as this code part is the same as in theÂ add_partitions_core method.",
        "duedate": null,
        "environment": null,
        "fixVersions": [{
            "archived": false,
            "id": "12343343",
            "name": "4.0.0",
            "released": false,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12343343"
        }],
        "issuelinks": [],
        "issuetype": {
            "avatarId": 21133,
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "id": "1",
            "name": "Bug",
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "subtask": false
        },
        "labels": [],
        "lastViewed": null,
        "priority": {
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "id": "3",
            "name": "Major",
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
        },
        "progress": {
            "progress": 0,
            "total": 0
        },
        "project": {
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935",
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935"
            },
            "id": "12310843",
            "key": "HIVE",
            "name": "Hive",
            "projectCategory": {
                "description": "Scalable Distributed Computing",
                "id": "10292",
                "name": "Hadoop",
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10292"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/project/12310843"
        },
        "reporter": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Marta Kuczora",
            "key": "kuczoram",
            "name": "kuczoram",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=kuczoram",
            "timeZone": "Etc/UTC"
        },
        "resolution": {
            "description": "A fix for this issue is checked into the tree and tested.",
            "id": "1",
            "name": "Fixed",
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1"
        },
        "resolutiondate": "2018-04-10T13:44:06.000+0000",
        "status": {
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "id": "5",
            "name": "Resolved",
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "statusCategory": {
                "colorName": "green",
                "id": 3,
                "key": "done",
                "name": "Done",
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
            }
        },
        "subtasks": [],
        "summary": "The partition folders might not get cleaned up properly in the HiveMetaStore.add_partitions_core method if an exception occurs",
        "timeestimate": null,
        "timeoriginalestimate": null,
        "timespent": null,
        "updated": "2018-05-22T21:12:17.000+0000",
        "versions": [],
        "votes": {
            "hasVoted": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HIVE-18696/votes",
            "votes": 0
        },
        "watches": {
            "isWatching": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HIVE-18696/watchers",
            "watchCount": 2
        },
        "workratio": -1
    },
    "id": "13138127",
    "key": "HIVE-18696",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13138127"
}