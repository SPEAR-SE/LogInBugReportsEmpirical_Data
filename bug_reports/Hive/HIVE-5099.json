{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "fields": {
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "aggregatetimeestimate": null,
        "aggregatetimeoriginalestimate": null,
        "aggregatetimespent": null,
        "assignee": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Daniel Dai",
            "key": "daijy",
            "name": "daijy",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=daijy",
            "timeZone": "America/Los_Angeles"
        },
        "components": [
            {
                "description": "Tracks issue dealing with metastore.",
                "id": "12312584",
                "name": "Metastore",
                "self": "https://issues.apache.org/jira/rest/api/2/component/12312584"
            },
            {
                "description": "Issues related to running Hive on Windows (not including Cygwin, MSYS, etc)",
                "id": "12318904",
                "name": "Windows",
                "self": "https://issues.apache.org/jira/rest/api/2/component/12318904"
            }
        ],
        "created": "2013-08-15T01:00:07.000+0000",
        "creator": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Daniel Dai",
            "key": "daijy",
            "name": "daijy",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=daijy",
            "timeZone": "America/Los_Angeles"
        },
        "customfield_10010": null,
        "customfield_12310191": null,
        "customfield_12310192": null,
        "customfield_12310220": "2014-02-24T23:46:56.684+0000",
        "customfield_12310222": "10002_*:*_1_*:*_508104805_*|*_1_*:*_1_*:*_17591049989_*|*_5_*:*_1_*:*_0",
        "customfield_12310230": null,
        "customfield_12310250": null,
        "customfield_12310290": null,
        "customfield_12310291": null,
        "customfield_12310300": null,
        "customfield_12310310": "3.0",
        "customfield_12310320": null,
        "customfield_12310420": "343781",
        "customfield_12310920": "344083",
        "customfield_12310921": null,
        "customfield_12311020": null,
        "customfield_12311024": null,
        "customfield_12311120": null,
        "customfield_12311820": "0|i1nab3:",
        "customfield_12312022": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "customfield_12312026": null,
        "customfield_12312220": null,
        "customfield_12312320": null,
        "customfield_12312321": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312324": null,
        "customfield_12312325": null,
        "customfield_12312326": null,
        "customfield_12312327": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312330": null,
        "customfield_12312331": null,
        "customfield_12312332": null,
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12312335": null,
        "customfield_12312336": null,
        "customfield_12312337": null,
        "customfield_12312338": null,
        "customfield_12312339": null,
        "customfield_12312340": null,
        "customfield_12312341": null,
        "customfield_12312520": null,
        "customfield_12312521": "Wed Mar 12 12:32:42 UTC 2014",
        "customfield_12312720": null,
        "customfield_12312823": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "customfield_12312923": null,
        "customfield_12313422": "false",
        "customfield_12313520": null,
        "description": "For certain metastore operation combination, metastore operation hangs and metastore server eventually fail due to OOM. This happens when metastore is backed by SQL Server. Here is a testcase to reproduce:\n{code}\nCREATE TABLE tbl_repro_oom1 (a STRING, b INT) PARTITIONED BY (c STRING, d STRING);\nCREATE TABLE tbl_repro_oom_2 (a STRING ) PARTITIONED BY (e STRING);\nALTER TABLE tbl_repro_oom1 ADD PARTITION (c='France', d=4);\nALTER TABLE tbl_repro_oom1 ADD PARTITION (c='Russia', d=3);\nALTER TABLE tbl_repro_oom_2 ADD PARTITION (e='Russia');\nALTER TABLE tbl_repro_oom1 DROP PARTITION (c >= 'India'); --failure\n{code}\n\nThe code cause the issue is in ExpressionTree.java:\n{code}\nvalString = \"partitionName.substring(partitionName.indexOf(\\\"\" + keyEqual + \"\\\")+\" + keyEqualLength + \").substring(0, partitionName.substring(partitionName.indexOf(\\\"\" + keyEqual + \"\\\")+\" + keyEqualLength + \").indexOf(\\\"/\\\"))\";\n{code}\n\nThe snapshot of table partition before the \"drop partition\" statement is:\n{code}\nPART_ID  CREATE_TIME    LAST_ACCESS_TIME      PART_NAME                SD_ID   TBL_ID \n93\t1376526718\t0\t             c=France/d=4\t127\t33\n94\t1376526718\t0\t             c=Russia/d=3\t128\t33\n95\t1376526718\t0\t             e=Russia\t        129\t34\n{code}\n\nDatanucleus query try to find the value of a particular key by locating \"$key=\" as the start, \"/\" as the end. For example, value of c in \"c=France/d=4\" by locating \"c=\" as the start, \"/\" following as the end. However, this query fail if we try to find value \"e\" in \"e=Russia\" since there is no tailing \"/\". \n\nOther database works since the query plan first filter out the partition not belonging to tbl_repro_oom1. Whether this error surface or not depends on the query optimizer.\n\nWhen this exception happens, metastore keep trying and throw exception. The memory image of metastore contains a large number of exception objects:\n{code}\ncom.microsoft.sqlserver.jdbc.SQLServerException: Invalid length parameter passed to the LEFT or SUBSTRING function.\n\tat com.microsoft.sqlserver.jdbc.SQLServerException.makeFromDatabaseError(SQLServerException.java:197)\n\tat com.microsoft.sqlserver.jdbc.SQLServerResultSet$FetchBuffer.nextRow(SQLServerResultSet.java:4762)\n\tat com.microsoft.sqlserver.jdbc.SQLServerResultSet.fetchBufferNext(SQLServerResultSet.java:1682)\n\tat com.microsoft.sqlserver.jdbc.SQLServerResultSet.next(SQLServerResultSet.java:955)\n\tat org.apache.commons.dbcp.DelegatingResultSet.next(DelegatingResultSet.java:207)\n\tat org.apache.commons.dbcp.DelegatingResultSet.next(DelegatingResultSet.java:207)\n\tat org.datanucleus.store.rdbms.query.ForwardQueryResult.<init>(ForwardQueryResult.java:90)\n\tat org.datanucleus.store.rdbms.query.JDOQLQuery.performExecute(JDOQLQuery.java:686)\n\tat org.datanucleus.store.query.Query.executeQuery(Query.java:1791)\n\tat org.datanucleus.store.query.Query.executeWithMap(Query.java:1694)\n\tat org.datanucleus.api.jdo.JDOQuery.executeWithMap(JDOQuery.java:334)\n\tat org.apache.hadoop.hive.metastore.ObjectStore.listMPartitionsByFilter(ObjectStore.java:1715)\n\tat org.apache.hadoop.hive.metastore.ObjectStore.getPartitionsByFilter(ObjectStore.java:1590)\n\tat sun.reflect.GeneratedMethodAccessor5.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:601)\n\tat org.apache.hadoop.hive.metastore.RetryingRawStore.invoke(RetryingRawStore.java:111)\n\tat $Proxy4.getPartitionsByFilter(Unknown Source)\n\tat org.apache.hadoop.hive.metastore.HiveMetaStore$HMSHandler.get_partitions_by_filter(HiveMetaStore.java:2163)\n\tat sun.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:601)\n\tat org.apache.hadoop.hive.metastore.RetryingHMSHandler.invoke(RetryingHMSHandler.java:105)\n\tat $Proxy5.get_partitions_by_filter(Unknown Source)\n\tat org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Processor$get_partitions_by_filter.getResult(ThriftHiveMetastore.java:5449)\n\tat org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$Processor$get_partitions_by_filter.getResult(ThriftHiveMetastore.java:5437)\n\tat org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)\n\tat org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)\n\tat org.apache.hadoop.hive.metastore.TSetIpAddressProcessor.process(TSetIpAddressProcessor.java:48)\n\tat org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:176)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n\tat java.lang.Thread.run(Thread.java:722)\n)\n{code}\n\nThis eventually cause the OOM of metastore server. \n\nThis Jira only try to fix the SQL exception, which prevent OOM from happening in the above scenario. We might also need to look at how to prevent metastore OOM when an error happen, but that is out of the scope of this Jira.",
        "duedate": null,
        "environment": null,
        "fixVersions": [{
            "archived": false,
            "description": "released",
            "id": "12324986",
            "name": "0.13.0",
            "releaseDate": "2014-04-21",
            "released": true,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12324986"
        }],
        "issuelinks": [
            {
                "id": "12384311",
                "inwardIssue": {
                    "fields": {
                        "issuetype": {
                            "avatarId": 21133,
                            "description": "A problem which impairs or prevents the functions of the product.",
                            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
                            "id": "1",
                            "name": "Bug",
                            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
                            "subtask": false
                        },
                        "priority": {
                            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
                            "id": "3",
                            "name": "Major",
                            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
                        },
                        "status": {
                            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
                            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
                            "id": "5",
                            "name": "Resolved",
                            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
                            "statusCategory": {
                                "colorName": "green",
                                "id": 3,
                                "key": "done",
                                "name": "Done",
                                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
                            }
                        },
                        "summary": "datanucleus does not work with MS SQLServer in Hive metastore"
                    },
                    "id": "12667054",
                    "key": "HIVE-5218",
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/12667054"
                },
                "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12384311",
                "type": {
                    "id": "12310000",
                    "inward": "is duplicated by",
                    "name": "Duplicate",
                    "outward": "duplicates",
                    "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"
                }
            },
            {
                "id": "12375388",
                "outwardIssue": {
                    "fields": {
                        "issuetype": {
                            "avatarId": 21133,
                            "description": "A problem which impairs or prevents the functions of the product.",
                            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
                            "id": "1",
                            "name": "Bug",
                            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
                            "subtask": false
                        },
                        "priority": {
                            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
                            "id": "3",
                            "name": "Major",
                            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
                        },
                        "status": {
                            "description": "The issue is open and ready for the assignee to start work on it.",
                            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png",
                            "id": "1",
                            "name": "Open",
                            "self": "https://issues.apache.org/jira/rest/api/2/status/1",
                            "statusCategory": {
                                "colorName": "blue-gray",
                                "id": 2,
                                "key": "new",
                                "name": "To Do",
                                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2"
                            }
                        },
                        "summary": "metastore server OOM when exception happen"
                    },
                    "id": "12669107",
                    "key": "HIVE-5303",
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/12669107"
                },
                "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12375388",
                "type": {
                    "id": "12310010",
                    "inward": "is part of",
                    "name": "Incorporates",
                    "outward": "incorporates",
                    "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"
                }
            },
            {
                "id": "12383508",
                "inwardIssue": {
                    "fields": {
                        "issuetype": {
                            "avatarId": 21133,
                            "description": "A problem which impairs or prevents the functions of the product.",
                            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
                            "id": "1",
                            "name": "Bug",
                            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
                            "subtask": false
                        },
                        "priority": {
                            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
                            "id": "3",
                            "name": "Major",
                            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
                        },
                        "status": {
                            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
                            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
                            "id": "5",
                            "name": "Resolved",
                            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
                            "statusCategory": {
                                "colorName": "green",
                                "id": 3,
                                "key": "done",
                                "name": "Done",
                                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
                            }
                        },
                        "summary": "datanucleus does not work with MS SQLServer in Hive metastore"
                    },
                    "id": "12667054",
                    "key": "HIVE-5218",
                    "self": "https://issues.apache.org/jira/rest/api/2/issue/12667054"
                },
                "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12383508",
                "type": {
                    "id": "10030",
                    "inward": "is related to",
                    "name": "Reference",
                    "outward": "relates to",
                    "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"
                }
            }
        ],
        "issuetype": {
            "avatarId": 21133,
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "id": "1",
            "name": "Bug",
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "subtask": false
        },
        "labels": [],
        "lastViewed": null,
        "priority": {
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "id": "3",
            "name": "Major",
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
        },
        "progress": {
            "progress": 0,
            "total": 0
        },
        "project": {
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310843&avatarId=11935",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310843&avatarId=11935",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310843&avatarId=11935",
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310843&avatarId=11935"
            },
            "id": "12310843",
            "key": "HIVE",
            "name": "Hive",
            "projectCategory": {
                "description": "Scalable Distributed Computing",
                "id": "10292",
                "name": "Hadoop",
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10292"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/project/12310843"
        },
        "reporter": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Daniel Dai",
            "key": "daijy",
            "name": "daijy",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=daijy",
            "timeZone": "America/Los_Angeles"
        },
        "resolution": {
            "description": "A fix for this issue is checked into the tree and tested.",
            "id": "1",
            "name": "Fixed",
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1"
        },
        "resolutiondate": "2014-03-12T12:32:42.000+0000",
        "status": {
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "id": "5",
            "name": "Resolved",
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "statusCategory": {
                "colorName": "green",
                "id": 3,
                "key": "done",
                "name": "Done",
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
            }
        },
        "subtasks": [],
        "summary": "Some partition publish operation cause OOM in metastore backed by SQL Server",
        "timeestimate": null,
        "timeoriginalestimate": null,
        "timespent": null,
        "updated": "2014-03-12T12:32:42.000+0000",
        "versions": [],
        "votes": {
            "hasVoted": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HIVE-5099/votes",
            "votes": 0
        },
        "watches": {
            "isWatching": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HIVE-5099/watchers",
            "watchCount": 4
        },
        "workratio": -1
    },
    "id": "12663780",
    "key": "HIVE-5099",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/12663780"
}