{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "fields": {
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "aggregatetimeestimate": null,
        "aggregatetimeoriginalestimate": null,
        "aggregatetimespent": null,
        "assignee": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=34050"
            },
            "displayName": "Adam Antal",
            "key": "adam.antal",
            "name": "adam.antal",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=adam.antal",
            "timeZone": "Etc/UTC"
        },
        "components": [{
            "description": "S3A filesystem client and other S3 connectivity issues",
            "id": "12311814",
            "name": "fs/s3",
            "self": "https://issues.apache.org/jira/rest/api/2/component/12311814"
        }],
        "created": "2018-10-04T12:38:55.000+0000",
        "creator": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034"
            },
            "displayName": "Gabor Bota",
            "key": "gabor.bota",
            "name": "gabor.bota",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota",
            "timeZone": "Europe/Budapest"
        },
        "customfield_10010": null,
        "customfield_12310191": null,
        "customfield_12310192": null,
        "customfield_12310220": "2018-10-04T14:26:27.071+0000",
        "customfield_12310222": "1_*:*_2_*:*_4596413569_*|*_3_*:*_2_*:*_2672900031_*|*_5_*:*_1_*:*_0",
        "customfield_12310230": null,
        "customfield_12310250": null,
        "customfield_12310290": null,
        "customfield_12310291": null,
        "customfield_12310300": null,
        "customfield_12310310": "6.0",
        "customfield_12310320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12310920": "9223372036854775807",
        "customfield_12310921": null,
        "customfield_12311020": null,
        "customfield_12311024": null,
        "customfield_12311120": null,
        "customfield_12311820": "0|i3ytuv:",
        "customfield_12312022": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "customfield_12312026": null,
        "customfield_12312220": null,
        "customfield_12312320": null,
        "customfield_12312321": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312324": null,
        "customfield_12312325": null,
        "customfield_12312326": null,
        "customfield_12312327": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312330": null,
        "customfield_12312331": null,
        "customfield_12312332": null,
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12312335": null,
        "customfield_12312336": null,
        "customfield_12312337": null,
        "customfield_12312338": null,
        "customfield_12312339": null,
        "customfield_12312340": null,
        "customfield_12312341": null,
        "customfield_12312520": null,
        "customfield_12312521": "Fri Jan 04 13:45:19 UTC 2019",
        "customfield_12312720": null,
        "customfield_12312823": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "customfield_12312923": null,
        "customfield_12313422": "false",
        "customfield_12313520": null,
        "description": "Running the integration tests for hadoop-aws {{mvn -Dscale verify}} against Amazon AWS S3 (eu-west-1, us-west-1, with no s3guard) we see a lot of these failures:\r\n\r\n{noformat}\r\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 4.408 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.staging.integration.ITDirectoryCommitMRJob\r\n[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.staging.integration.ITDirectoryCommitMRJob)  Time elapsed: 0.027 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n\r\n[ERROR] Tests run: 2, Failures: 0, Errors: 2, Skipped: 0, Time elapsed: 4.345 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJob\r\n[ERROR] testStagingDirectory(org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJob)  Time elapsed: 0.021 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n\r\n[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJob)  Time elapsed: 0.022 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n\r\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 4.489 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJobBadDest\r\n[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJobBadDest)  Time elapsed: 0.023 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n\r\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 4.695 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.magic.ITMagicCommitMRJob\r\n[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.magic.ITMagicCommitMRJob)  Time elapsed: 0.039 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n\r\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0.015 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory\r\n[ERROR] testEverything(org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory)  Time elapsed: 0.014 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n{noformat}\r\n\r\nThe big issue is that the tests are running in a serial manner - no test is running on top of the other - so we should not see that the tests are failing like this. The issue could be in how we handle org.apache.hadoop.fs.FileSystem#CACHE - the tests should use the same S3AFileSystem so if A test uses a FileSystem and closes it in teardown then B test will get the same FileSystem object from the cache and try to use it, but it is closed.\r\n\r\nWe see this a lot in our downstream testing too. It's not possible to tell that the failed regression test result is an implementation issue in the runtime code or a test implementation problem. \r\nI've checked when and what closes the S3AFileSystem with a sightly modified version of S3AFileSystem which logs the closers of the fs if an error should occur. I'll attach this modified java file for reference. See the next example of the result when it's running:\r\n\r\n{noformat}\r\n2018-10-04 00:52:25,596 [Thread-4201] ERROR s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:checkIfClosed(74)) - Use after close(): \r\njava.lang.RuntimeException: Using closed FS!.\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.checkIfClosed(S3ACloseEnforcedFileSystem.java:73)\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.mkdirs(S3ACloseEnforcedFileSystem.java:474)\r\n\tat org.apache.hadoop.fs.contract.AbstractFSContractTestBase.mkdirs(AbstractFSContractTestBase.java:338)\r\n\tat org.apache.hadoop.fs.contract.AbstractFSContractTestBase.setup(AbstractFSContractTestBase.java:193)\r\n\tat org.apache.hadoop.fs.s3a.ITestS3AClosedFS.setup(ITestS3AClosedFS.java:40)\r\n\tat sun.reflect.GeneratedMethodAccessor22.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\r\n\tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:24)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)\r\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)\r\n2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(61)) - FS was closed 6 times by:\r\n2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #1 ---------------\r\n2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)\r\n\tat org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)\r\n\tat org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)\r\n\tat org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)\r\n\tat org.apache.hadoop.fs.s3a.commit.AbstractCommitITest.teardown(AbstractCommitITest.java:206)\r\n\tat org.apache.hadoop.fs.s3a.auth.ITestAssumedRoleCommitOperations.teardown(ITestAssumedRoleCommitOperations.java:90)\r\n\tat sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)\r\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)\r\n\r\n2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #2 ---------------\r\n2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)\r\n\tat org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)\r\n\tat org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)\r\n\tat org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)\r\n\tat sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)\r\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)\r\n\r\n2018-10-04 00:52:25,597 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #3 ---------------\r\n2018-10-04 00:52:25,598 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)\r\n\tat org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)\r\n\tat org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)\r\n\tat org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)\r\n\tat sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)\r\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)\r\n(...)\r\n{noformat}\r\n\r\nFrom the logs it seems that the closers are the teardown methods of the abstract test classes, so the same FileSystem object gets reused between tests.\r\n\r\n\r\nTo run a test with the modified fs the following should be in the config:\r\n{noformat}\r\n<property>\r\n  <name>fs.s3a.impl<\/name>\r\n  <value>org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem<\/value>\r\n  <description>The implementation class of the S3A Filesystem<\/description>\r\n<\/property>\r\n{noformat}\r\n\r\nI file this jira to solve this issue, and start a conversation if needed.",
        "duedate": null,
        "environment": null,
        "fixVersions": [],
        "issuelinks": [],
        "issuetype": {
            "avatarId": 21133,
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "id": "1",
            "name": "Bug",
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "subtask": false
        },
        "labels": [],
        "lastViewed": null,
        "priority": {
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/critical.svg",
            "id": "2",
            "name": "Critical",
            "self": "https://issues.apache.org/jira/rest/api/2/priority/2"
        },
        "progress": {
            "progress": 0,
            "total": 0
        },
        "project": {
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095",
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095"
            },
            "id": "12310240",
            "key": "HADOOP",
            "name": "Hadoop Common",
            "projectCategory": {
                "description": "Scalable Distributed Computing",
                "id": "10292",
                "name": "Hadoop",
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10292"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/project/12310240"
        },
        "reporter": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034"
            },
            "displayName": "Gabor Bota",
            "key": "gabor.bota",
            "name": "gabor.bota",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota",
            "timeZone": "Europe/Budapest"
        },
        "resolution": {
            "description": "A fix for this issue is checked into the tree and tested.",
            "id": "1",
            "name": "Fixed",
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1"
        },
        "resolutiondate": "2018-12-27T15:54:08.000+0000",
        "status": {
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "id": "5",
            "name": "Resolved",
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "statusCategory": {
                "colorName": "green",
                "id": 3,
                "key": "done",
                "name": "Done",
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
            }
        },
        "subtasks": [],
        "summary": "S3A integration test failures: FileSystem is closed! - without parallel test run",
        "timeestimate": null,
        "timeoriginalestimate": null,
        "timespent": null,
        "updated": "2019-01-04T13:45:19.000+0000",
        "versions": [{
            "archived": false,
            "description": "3.1.1 release",
            "id": "12342984",
            "name": "3.1.1",
            "releaseDate": "2018-08-07",
            "released": true,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12342984"
        }],
        "votes": {
            "hasVoted": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15819/votes",
            "votes": 0
        },
        "watches": {
            "isWatching": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15819/watchers",
            "watchCount": 8
        },
        "workratio": -1
    },
    "id": "13189417",
    "key": "HADOOP-15819",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13189417"
}