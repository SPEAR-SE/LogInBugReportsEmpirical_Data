{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13166311","self":"https://issues.apache.org/jira/rest/api/2/issue/13166311","key":"HADOOP-15543","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-06-15T10:13:01.310+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 19 09:43:33 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15543/watchers","watchCount":6,"isWatching":false},"created":"2018-06-15T09:38:24.089+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341432","id":"12341432","description":"3.1.0 release","name":"3.1.0","archived":false,"released":true,"releaseDate":"2018-04-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-06-19T09:43:33.100+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"When reading a bzip2-compressed SequenceFile, Hadoop jobs fail with: \r\n{noformat}\r\nIndexOutOfBoundsException: offs(477658) + len(477659) > dest.length(678046)\r\n{noformat}\r\n\r\nThe SequenceFile (669 MB) has been written with the properties\r\n - mapreduce.output.fileoutputformat.compress.codec=org.apache.hadoop.io.compress.BZip2Codec\r\n- mapreduce.output.fileoutputformat.compress.type=BLOCK\r\n\r\nusing the native bzip2 library on Hadoop CDH 5.14.2 (Ubuntu 16.04, libbz2-1.0 1.0.6-8).\r\n\r\nThe error was seen on two development systems (local mode, no native bzip2 lib configured/installed) and, so far, is reproducible with Hadoop 3.1.0 and CDH 5.14.2.\r\n\r\nThe following Hadoop releases are not affected:  2.7.4, 3.02, CDH 5.14.0. The SequenceFile is read successfully when these Hadoop packages are used.\r\n\r\nIf required I can share the SequenceFile. It's a Nutch CrawlDb (contains [CrawlDatum|https://github.com/apache/nutch/blob/master/src/java/org/apache/nutch/crawl/CrawlDatum.java] objects.\r\n\r\nFull-stack as seen with 3.1.0:\r\n{noformat}\r\n2018-06-15 10:34:43,198 INFO  mapreduce.Job -  map 93% reduce 0%\r\n2018-06-15 10:34:43,532 WARN  mapred.LocalJobRunner - job_local543410164_0001\r\njava.lang.Exception: java.lang.IndexOutOfBoundsException: offs(477658) + len(477659) > dest.length(678046).\r\n        at org.apache.hadoop.mapred.LocalJobRunner$Job.runTasks(LocalJobRunner.java:492)\r\n        at org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:552)\r\nCaused by: java.lang.IndexOutOfBoundsException: offs(477658) + len(477659) > dest.length(678046).\r\n        at org.apache.hadoop.io.compress.bzip2.CBZip2InputStream.read(CBZip2InputStream.java:398)\r\n        at org.apache.hadoop.io.compress.BZip2Codec$BZip2CompressionInputStream.read(BZip2Codec.java:496)\r\n        at java.io.DataInputStream.readFully(DataInputStream.java:195)\r\n        at java.io.DataInputStream.readFully(DataInputStream.java:169)\r\n        at org.apache.hadoop.io.WritableUtils.readString(WritableUtils.java:125)\r\n        at org.apache.hadoop.io.WritableUtils.readStringArray(WritableUtils.java:169)\r\n        at org.apache.nutch.protocol.ProtocolStatus.readFields(ProtocolStatus.java:177)\r\n        at org.apache.hadoop.io.MapWritable.readFields(MapWritable.java:188)\r\n        at org.apache.nutch.crawl.CrawlDatum.readFields(CrawlDatum.java:332)\r\n        at org.apache.hadoop.io.serializer.WritableSerialization$WritableDeserializer.deserialize(WritableSerialization.java:71)\r\n        at org.apache.hadoop.io.serializer.WritableSerialization$WritableDeserializer.deserialize(WritableSerialization.java:42)\r\n        at org.apache.hadoop.io.SequenceFile$Reader.deserializeValue(SequenceFile.java:2374)\r\n        at org.apache.hadoop.io.SequenceFile$Reader.getCurrentValue(SequenceFile.java:2358)\r\n        at org.apache.hadoop.mapreduce.lib.input.SequenceFileRecordReader.nextKeyValue(SequenceFileRecordReader.java:78)\r\n        at org.apache.hadoop.mapred.MapTask$NewTrackingRecordReader.nextKeyValue(MapTask.java:568)\r\n        at org.apache.hadoop.mapreduce.task.MapContextImpl.nextKeyValue(MapContextImpl.java:80)\r\n        at org.apache.hadoop.mapreduce.lib.map.WrappedMapper$Context.nextKeyValue(WrappedMapper.java:91)\r\n        at org.apache.hadoop.mapreduce.Mapper.run(Mapper.java:145)\r\n        at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:799)\r\n        at org.apache.hadoop.mapred.MapTask.run(MapTask.java:347)\r\n        at org.apache.hadoop.mapred.LocalJobRunner$Job$MapTaskRunnable.run(LocalJobRunner.java:271)\r\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n        at java.lang.Thread.run(Thread.java:748)\r\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"IndexOutOfBoundsException when reading bzip2-compressed SequenceFile","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wastl-nagel","name":"wastl-nagel","key":"wastl-nagel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wastl-nagel&avatarId=35572","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wastl-nagel&avatarId=35572","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wastl-nagel&avatarId=35572","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wastl-nagel&avatarId=35572"},"displayName":"Sebastian Nagel","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wastl-nagel","name":"wastl-nagel","key":"wastl-nagel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wastl-nagel&avatarId=35572","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wastl-nagel&avatarId=35572","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wastl-nagel&avatarId=35572","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wastl-nagel&avatarId=35572"},"displayName":"Sebastian Nagel","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13166311/comment/16513637","id":"16513637","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"It'd probably be good to stick that up somewhere? home.apache.org? so we can have a look at it. \r\n\r\nwhat happens if you try and use the OS unzip tools?\r\n\r\nI think we need to work out if this is something wrong with the reader code, or the writer has generated something bad. Then find out who knows the native code well enough to fix.\r\n\r\nFWIW, I don't see any changes in the native bzip code since 2015 (HADOOP-10027).\r\n\r\nLooking at the java code, the only 3.1 change in the area is HADOOP-6852 and the BZip2Codec. Going to tag that as the cause unless we can see otherwise.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2018-06-15T10:13:01.310+0000","updated":"2018-06-15T10:13:01.310+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13166311/comment/16513659","id":"16513659","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wastl-nagel","name":"wastl-nagel","key":"wastl-nagel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wastl-nagel&avatarId=35572","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wastl-nagel&avatarId=35572","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wastl-nagel&avatarId=35572","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wastl-nagel&avatarId=35572"},"displayName":"Sebastian Nagel","active":true,"timeZone":"Europe/Berlin"},"body":"Hi [~stevel@apache.org], how can I read a SequenceFile with the tool bzip2? It starts with the SequenceFile header {{SEQ}} and the key and value classes. Of course, it might be that the file is wrong. Would be worst case because this would mean I have to rewrite some amount of data. Hope it's the reader: line 496 in BZip2Codec is suspicious:\r\n{{result = this.input.read(b, off, off + 1);}} Why to read offset+1 bytes. Does not make sense for odd offsets such as 477658. HADOOP-6852 was also one of the upstream changes which went into CDH 5.14.2. I'll send you a link to download the large sequence file. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wastl-nagel","name":"wastl-nagel","key":"wastl-nagel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wastl-nagel&avatarId=35572","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wastl-nagel&avatarId=35572","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wastl-nagel&avatarId=35572","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wastl-nagel&avatarId=35572"},"displayName":"Sebastian Nagel","active":true,"timeZone":"Europe/Berlin"},"created":"2018-06-15T10:57:48.056+0000","updated":"2018-06-15T10:57:48.056+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13166311/comment/16513724","id":"16513724","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"[~wastl-nagel]  thanks for the URL. Others: ping us if you want that data\r\n\r\nbq. how can I read a SequenceFile with the tool bzip2\r\n\r\naah, good point. you win.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2018-06-15T11:58:22.314+0000","updated":"2018-06-15T11:58:22.314+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13166311/comment/16516881","id":"16516881","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"[~zvenczel], I think this would be an interesting bzip issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-06-19T09:43:33.100+0000","updated":"2018-06-19T09:43:33.100+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15543/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3uwlr:"}}