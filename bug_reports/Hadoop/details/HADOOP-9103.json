{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12551704","self":"https://issues.apache.org/jira/rest/api/2/issue/12551704","key":"HADOOP-9103","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323273","id":"12323273","description":"2.0.3-alpha release","name":"2.0.3-alpha","archived":false,"released":true,"releaseDate":"2013-02-14"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-04-20T15:51:24.731+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Dec 06 14:05:56 UTC 2012","customfield_12310420":"236511","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_19563473064_*|*_1_*:*_1_*:*_3701382_*|*_5_*:*_2_*:*_24036986_*|*_4_*:*_1_*:*_266812037","customfield_12312321":null,"resolutiondate":"2012-12-05T21:14:28.560+0000","workratio":0,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-9103/watchers","watchCount":10,"isWatching":false},"created":"2012-04-20T01:07:25.144+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":"messy code,SecondaryNameNode,FSImage ","customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":43200,"aggregatetimeoriginalestimate":43200,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313866","id":"12313866","description":"","name":"0.20.1","archived":false,"released":true,"releaseDate":"2009-09-01"}],"issuelinks":[{"id":"12368511","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12368511","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12646011","key":"HADOOP-9544","self":"https://issues.apache.org/jira/rest/api/2/issue/12646011","fields":{"summary":"backport UTF8 encoding fixes to branch-1","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12361108","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12361108","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"outwardIssue":{"id":"12618994","key":"HDFS-4282","self":"https://issues.apache.org/jira/rest/api/2/issue/12618994","fields":{"summary":"TestEditLog.testFuzzSequences FAILED in all pre-commit test","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-09-03T23:11:05.759+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310687","id":"12310687","name":"io","description":""}],"timeoriginalestimate":43200,"description":"this the log information  of the  exception  from the SecondaryNameNode: \n2012-03-28 00:48:42,553 ERROR org.apache.hadoop.hdfs.server.namenode.SecondaryNameNode: java.io.IOException: Found lease for\n non-existent file /user/boss/pgv/fission/task16/split/_temporary/_attempt_201203271849_0016_r_000174_0/????@???????????????\n??????????tor.qzone.qq.com/keypart-00174\n        at org.apache.hadoop.hdfs.server.namenode.FSImage.loadFilesUnderConstruction(FSImage.java:1211)\n        at org.apache.hadoop.hdfs.server.namenode.FSImage.loadFSImage(FSImage.java:959)\n        at org.apache.hadoop.hdfs.server.namenode.SecondaryNameNode$CheckpointStorage.doMerge(SecondaryNameNode.java:589)\n        at org.apache.hadoop.hdfs.server.namenode.SecondaryNameNode$CheckpointStorage.access$000(SecondaryNameNode.java:473)\n        at org.apache.hadoop.hdfs.server.namenode.SecondaryNameNode.doMerge(SecondaryNameNode.java:350)\n        at org.apache.hadoop.hdfs.server.namenode.SecondaryNameNode.doCheckpoint(SecondaryNameNode.java:314)\n        at org.apache.hadoop.hdfs.server.namenode.SecondaryNameNode.run(SecondaryNameNode.java:225)\n        at java.lang.Thread.run(Thread.java:619)\n\nthis is the log information  about the file from namenode:\n2012-03-28 00:32:26,528 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem.audit: ugi=boss,boss\tip=/10.131.16.34\tcmd=create\tsrc=/user/boss/pgv/fission/task16/split/_temporary/_attempt_201203271849_0016_r_000174_0/  @?            tor.qzone.qq.com/keypart-00174\tdst=null\tperm=boss:boss:rw-r--r--\n2012-03-28 00:37:42,387 INFO org.apache.hadoop.hdfs.StateChange: BLOCK* NameSystem.allocateBlock: /user/boss/pgv/fission/task16/split/_temporary/_attempt_201203271849_0016_r_000174_0/  @?            tor.qzone.qq.com/keypart-00174. blk_2751836614265659170_184668759\n2012-03-28 00:37:42,696 INFO org.apache.hadoop.hdfs.StateChange: DIR* NameSystem.completeFile: file /user/boss/pgv/fission/task16/split/_temporary/_attempt_201203271849_0016_r_000174_0/  @?            tor.qzone.qq.com/keypart-00174 is closed by DFSClient_attempt_201203271849_0016_r_000174_0\n2012-03-28 00:37:50,315 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem.audit: ugi=boss,boss\tip=/10.131.16.34\tcmd=rename\tsrc=/user/boss/pgv/fission/task16/split/_temporary/_attempt_201203271849_0016_r_000174_0/  @?            tor.qzone.qq.com/keypart-00174\tdst=/user/boss/pgv/fission/task16/split/  @?            tor.qzone.qq.com/keypart-00174\tperm=boss:boss:rw-r--r--\n\n\nafter check the code that save FSImage,I found there are a problem that maybe a bug of HDFS Code,I past below:\n-------------this is the saveFSImage method  in  FSImage.java, I make some mark at the problem code------------\n\n/**\n   * Save the contents of the FS image to the file.\n   */\n  void saveFSImage(File newFile) throws IOException {\n    FSNamesystem fsNamesys = FSNamesystem.getFSNamesystem();\n    FSDirectory fsDir = fsNamesys.dir;\n    long startTime = FSNamesystem.now();\n    //\n    // Write out data\n    //\n    DataOutputStream out = new DataOutputStream(\n                                                new BufferedOutputStream(\n                                                                         new FileOutputStream(newFile)));\n    try {\n      .........\n    \n      // save the rest of the nodes\n      saveImage(strbuf, 0, fsDir.rootDir, out);------------------problem\n      fsNamesys.saveFilesUnderConstruction(out);------------------problem  detail is below\n      strbuf = null;\n    } finally {\n      out.close();\n    }\n\n    LOG.info(\"Image file of size \" + newFile.length() + \" saved in \" \n        + (FSNamesystem.now() - startTime)/1000 + \" seconds.\");\n  }\n\n /**\n   * Save file tree image starting from the given root.\n   * This is a recursive procedure, which first saves all children of\n   * a current directory and then moves inside the sub-directories.\n   */\n  private static void saveImage(ByteBuffer parentPrefix,\n                                int prefixLength,\n                                INodeDirectory current,\n                                DataOutputStream out) throws IOException {\n    int newPrefixLength = prefixLength;\n    if (current.getChildrenRaw() == null)\n      return;\n    for(INode child : current.getChildren()) {\n      // print all children first\n      parentPrefix.position(prefixLength);\n      parentPrefix.put(PATH_SEPARATOR).put(child.getLocalNameBytes());------------------problem\n      saveINode2Image(parentPrefix, child, out);\n    }\n   ..........\n  }\n\n\n // Helper function that writes an INodeUnderConstruction\n  // into the input stream\n  //\n  static void writeINodeUnderConstruction(DataOutputStream out,\n                                           INodeFileUnderConstruction cons,\n                                           String path) \n                                           throws IOException {\n    writeString(path, out);------------------problem\n    ..........\n  }\n  \n  static private final UTF8 U_STR = new UTF8();\n  static void writeString(String str, DataOutputStream out) throws IOException {\n    U_STR.set(str);\n    U_STR.write(out);------------------problem \n  }\n\n  /**\n   * Converts a string to a byte array using UTF8 encoding.\n   */\n  static byte[] string2Bytes(String str) {\n    try {\n      return str.getBytes(\"UTF8\");------------------problem \n    } catch(UnsupportedEncodingException e) {\n      assert false : \"UTF8 encoding is not supported \";\n    }\n    return null;\n  }\n------------------------------------------below is the explain------------------------\nin  saveImage method:  child.getLocalNameBytes(),the  bytes use the method of str.getBytes(\"UTF8\");\n\nbut in writeINodeUnderConstruction, the bytes user the method of Class  UTF8 to get the bytes.\n\nI make a test use our messy code file name , found the the two bytes arrsy are not equal. so I both use the class UTF8,then the problem desappare.\n\nI think this is a bug of HDFS or UTF8.","customfield_10010":null,"timetracking":{"originalEstimate":"12h","remainingEstimate":"12h","originalEstimateSeconds":43200,"remainingEstimateSeconds":43200},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12523457","id":"12523457","filename":"FSImage.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-20T06:38:40.776+0000","size":3029,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12523457/FSImage.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12555431","id":"12555431","filename":"hadoop-9103.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-11-29T23:25:09.234+0000","size":6280,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12555431/hadoop-9103.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12555414","id":"12555414","filename":"hadoop-9103.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-11-29T22:08:44.341+0000","size":6277,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12555414/hadoop-9103.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12555322","id":"12555322","filename":"hadoop-9103.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-11-29T06:28:22.214+0000","size":5763,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12555322/hadoop-9103.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12523756","id":"12523756","filename":"ProblemString.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-23T05:44:57.251+0000","size":81,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12523756/ProblemString.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12523758","id":"12523758","filename":"TestUTF8AndStringGetBytes.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-23T05:48:35.098+0000","size":755,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12523758/TestUTF8AndStringGetBytes.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12523755","id":"12523755","filename":"TestUTF8AndStringGetBytes.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-23T05:44:56.841+0000","size":743,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12523755/TestUTF8AndStringGetBytes.java"}],"aggregatetimeestimate":43200,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"114168","customfield_12312823":null,"summary":"UTF8 class does not properly decode Unicode characters outside the basic multilingual plane","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":43200,"percent":0},"customfield_12311024":null,"environment":"SUSE LINUX","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":43200,"percent":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13258048","id":"13258048","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"body":"I  only change the writeString method  to make it  the same with INode  stringToBytes method,and then the problem disappears.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-20T06:38:41.808+0000","updated":"2012-04-20T06:38:41.808+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13258331","id":"13258331","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Rather than change the code to not use UTF8, I think we should figure out why the UTF8 writeString function is writing the wrong data. Is \"乱码\" the string that causes the problem? I tried to reproduce using this string, but it works fine here.\n\n(I did \"hadoop fs -put /etc/issue '乱码'\", then successfully restarted and catted the file)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-04-20T15:51:24.731+0000","updated":"2012-04-20T15:51:24.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13259396","id":"13259396","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"body":"dear  todd:\n   \"乱码\" is not the string that causes the problem,it is chinese I don't how do describe, I has place the string that causes the  problem and the test code  in attachments . wish for your reply,  best wishes!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-23T05:45:15.387+0000","updated":"2012-04-23T05:45:15.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13259400","id":"13259400","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"body":"I am try to figure out the problem of UTF8 ~_~","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-23T05:50:17.243+0000","updated":"2012-04-23T05:50:17.243+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13259527","id":"13259527","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12523758/TestUTF8AndStringGetBytes.java\n  against trunk revision .\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/2312//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-23T11:05:45.527+0000","updated":"2012-04-23T11:05:45.527+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506105","id":"13506105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"I ran TestUTF8AndStringGetBytes.java with the provided ProblemString.txt and got this output:\n{code}\n49\n49\n30\n30\n{code}\n\nThis seems expected, however-- the {{String#getBytes}} method returns UTF-8 with the non-BMP code points encoded using UTF-8.  {{hadoop.io.UTF8}} returns UTF-8 with the non-BMP code points encoded as supplementary pairs.\n\nI don't see what any of this has to do with the FSImage or block leases-- since we always encode/decode using {{hadoop.io.UTF8}}, and never anything else, there should be no problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-11-29T01:05:36.104+0000","updated":"2012-11-29T01:05:36.104+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506193","id":"13506193","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"We had a customer run into a similar issue today, and I figured out the problem -- UTF8.readChars() only handles UTF8 sequences up to 3 bytes. After some spelunking, Colin, Andy, and I came to the following conclusions with regard to characters outside the basic multi-lingual plane. Given the unicode character \uD83D\uDC31 (CAT-FACE U+1F431 http://www.fileformat.info/info/unicode/char/1f431/index.htm):\n\n- DFSUtil.string2Bytes calls through to Java's encoding, which yields the following 4-byte sequence: f09f90b1\n- UTF8.writeString does our own encoding, which yields the following 6-byte sequence: eda0bdedb0b1\n- If you read back the 6-byte sequence using new String(bytes, \"UTF-8\"), it properly decodes back into the cat-face\n- If you read back the 6-byte sequence using UTF8.readChars, it also gets back the cat-face\n- If you read back the 4-byte (proper UTF8) sequence using UTF8.readChars, you get back some nonsense (\"ߐѰ\")\n\nIt turns out that UTF8.java doesn't actually encode in UTF8 - but rather it encodes in \"CESU-8\" (thanks Colin for finding this!). Both Java and UTF8.java can properly decode that back into the correct String. However, if you encode a non-BMP character using Java (into proper UTF8 instead of CESU-8), then UTF8.java can't properly decode it.\n\nThe issue is that the code in UTF8.readChars doesn't handle any UTF8 sequences longer than 3 bytes. By extending the code to handle longer byte sequences, we were able to fix the issue.\n\nI'll upload a patch with a unit test either later tonight or tomorrow.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-11-29T03:56:48.425+0000","updated":"2012-11-29T03:56:48.425+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506232","id":"13506232","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"body":"Todd thank you for your reply,you are so kind.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yixiaohuamaxfly","name":"yixiaohuamaxfly","key":"yixiaohuamaxfly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yixiaohua","active":true,"timeZone":"Etc/UTC"},"created":"2012-11-29T05:38:13.938+0000","updated":"2012-11-29T05:38:13.938+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506254","id":"13506254","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Attached patch should fix this issue. I also amended the javadoc for UTF8 to indicate that it encodes CESU-8","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-11-29T06:28:22.216+0000","updated":"2012-11-29T06:28:22.216+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506325","id":"13506325","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"I said:\n\nbq. since we always encode/decode using hadoop.io.UTF8, and never anything else, there should be no problem...\n\nI take this back; looks like we don't always encode/decode using {{hadoop.io.UTF8}}.  D'oh!\n\nbq. Attached patch should fix this issue.\n\nNice.  Should we test for rejecting 5-byte and 6-byte sequences, since I notice you added some code to do that?\n\nI'm also a little scared by the idea that we have differently-encoded byte[] running around for the same file name strings.  We have to be very careful about this.  Unfortunately, we can't change the decoder to emit real UTF-8 (rather than CESU-8) without making a backwards-incompatible change, since as INode.java reminds us, \n\n{code}\n   *  The name in HdfsFileStatus should keep the same encoding as this.\n   *  if this encoding is changed, implicitly getFileInfo and listStatus in\n   *  clientProtocol are changed; The decoding at the client\n   *  side should change accordingly.\n{code}\n\nI also wonder if this means that we need to hunt down all the places not using CESU-8.  Otherwise older clients are just not going to work with astral plane code points, even after this fix... However, we could do that in a separate JIRA, not here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-11-29T08:39:55.266+0000","updated":"2012-11-29T08:39:55.266+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506727","id":"13506727","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. Nice. Should we test for rejecting 5-byte and 6-byte sequences, since I notice you added some code to do that?\n\nI added a test for an invalid sequence. I didn't think it was necessary to add a separate test for a 5-byte sequence, since it would trigger the same \"invalid\" code path. Got an example hex sequence you think we should test against?\n\nbq. I'm also a little scared by the idea that we have differently-encoded byte[] running around for the same file name strings. We have to be very careful about this. \nbq. ...However, we could do that in a separate JIRA, not here\nAgreed. Let's open a separate HDFS JIRA and use this for the Common-side fix. This patch alone was enough to successfully restart a NN which had an open file with a 4-byte codepoint.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-11-29T19:52:19.891+0000","updated":"2012-11-29T19:52:19.891+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506855","id":"13506855","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. Got an example hex sequence you think we should test against?\n\nHere is a 5-byte sequence that used to be valid UTF-8, before the 4-byte max rule was put into place:\n\n{{0xF8 0x88 0x80 0x80 0x80}}\n\nSource: http://www.cl.cam.ac.uk/~mgk25/ucs/examples/UTF-8-test.txt","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-11-29T21:52:19.522+0000","updated":"2012-11-29T21:52:19.522+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506865","id":"13506865","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Attached patch includes the test sequence Colin provided above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-11-29T22:08:44.343+0000","updated":"2012-11-29T22:08:44.343+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506894","id":"13506894","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adi2","name":"adi2","key":"adi2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andy Isaacson","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. +   * This is a regression est for HDFS-3307.\n\ntest, not est.  Since this jira has moved to HADOOP-9103, update the reference.\n\n{code}\n+ * Note that this decodes UTF-8 but actually encodes CESU-8, a variant of\n+ * UTF-8: see http://en.wikipedia.org/wiki/CESU-8\n{code}\nRather than adding a comment saying \"this code is buggy\", how about we fix the bug?  Outputting proper 4-byte UTF8 sequences for a given UTF-16 surrogate pair is a much better solution than the current behavior.\n\nSo as far as it goes the patch looks good.  I'll look into the surrogate pair stuff.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adi2","name":"adi2","key":"adi2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andy Isaacson","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-11-29T22:35:01.783+0000","updated":"2012-11-29T22:35:01.783+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506912","id":"13506912","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. Rather than adding a comment saying \"this code is buggy\", how about we fix the bug? Outputting proper 4-byte UTF8 sequences for a given UTF-16 surrogate pair is a much better solution than the current behavior.\n\nThat would be an incompatible change.  Consider what happens when the server hands back 4-byte UTF-8 sequences to existing DFSClients.  Boom, they fall over.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-11-29T22:58:29.903+0000","updated":"2012-11-29T22:58:29.903+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506932","id":"13506932","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Fixed typo in the test javadoc","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-11-29T23:25:09.236+0000","updated":"2012-11-29T23:25:09.236+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13506933","id":"13506933","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. Rather than adding a comment saying \"this code is buggy\", how about we fix the bug? Outputting proper 4-byte UTF8 sequences for a given UTF-16 surrogate pair is a much better solution than the current behavior.\n\nIt's not \"buggy\" it's just \"different\" (reminds me of something my elementary school teachers used to say). But on a serious note, yea, what Colin said above -- it could break existing clients of the code who are using the old code to _decode_, and were relying on the fact that we are able to round-trip non-BMP characters through UTF8.java.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-11-29T23:26:22.502+0000","updated":"2012-11-29T23:26:22.502+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13507039","id":"13507039","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adi2","name":"adi2","key":"adi2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andy Isaacson","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. It's not \"buggy\" it's just \"different\" \n\nIt's buggy if we ever end up writing a CESU-8 bytestream where someone else expects UTF-8.  For example, {{dfs -ls}} writing CESU-8 to stdout wouldn't work properly, because other programs such as {{xterm}} or {{putty}} don't implement the CESU-8 decoding rules.  (This example doesn't happen currently, because the CESU-8 filename is deserialized into a String, where it's interpreted as a surrogate pair, which is then written, and the correct surrogate pair -> UTF-8 encoding happens on the output side.)  Hopefully we haven't overlooked any such existing bugs and nobody accidentally uses UTF8.java in the future.  (At least it's marked @Deprecated.)\n\nAgreed that as long as UTF8.java is the thing that reads the bytestream, we can continue to implement CESU-8 and it can remain partially backwards compatible with previous versions of UTF8.java.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adi2","name":"adi2","key":"adi2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andy Isaacson","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-11-30T02:07:27.827+0000","updated":"2012-11-30T02:07:27.827+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13509404","id":"13509404","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. Hopefully we haven't overlooked any such existing bugs and nobody accidentally uses UTF8.java in the future. (At least it's marked @Deprecated.)\n\nRight. That's my thinking.\n\nbq. Agreed that as long as UTF8.java is the thing that reads the bytestream, we can continue to implement CESU-8 and it can remain partially backwards compatible with previous versions of UTF8.java.\n\nJava String can also properly decode the CESU-8, so we can move forward by getting rid of usage of UTF8.readString ASAP, and then some day later kill all the paths that use the write path (once we're sure the read path is dead).\n\nCould a committer please review this? Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-12-04T01:11:52.995+0000","updated":"2012-12-04T01:11:52.995+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13510119","id":"13510119","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"body":"+1, the patch looks good to me.\n\nThanks a lot for looking into this tricky issue, Todd, Colin, and Andy.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-12-04T23:32:23.204+0000","updated":"2012-12-04T23:32:23.204+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13510773","id":"13510773","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Committed to trunk and branch-2. Thanks for reporting this, yixiaohua, and thanks everyone for the reviews.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-12-05T21:14:28.587+0000","updated":"2012-12-05T21:14:28.587+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13510904","id":"13510904","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hadoop-trunk-Commit #3088 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3088/])\n    HADOOP-9103. UTF8 class does not properly decode Unicode characters outside the basic multilingual plane. Contributed by Todd Lipcon. (Revision 1417649)\n\n     Result = SUCCESS\ntodd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1417649\nFiles : \n* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt\n* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/io/UTF8.java\n* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/io/TestUTF8.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-05T23:28:37.484+0000","updated":"2012-12-05T23:28:37.484+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13511322","id":"13511322","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hadoop-Hdfs-trunk #1246 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1246/])\n    HADOOP-9103. UTF8 class does not properly decode Unicode characters outside the basic multilingual plane. Contributed by Todd Lipcon. (Revision 1417649)\n\n     Result = FAILURE\ntodd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1417649\nFiles : \n* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt\n* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/io/UTF8.java\n* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/io/TestUTF8.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-06T13:10:37.848+0000","updated":"2012-12-06T13:10:37.848+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551704/comment/13511391","id":"13511391","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hadoop-Mapreduce-trunk #1277 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1277/])\n    HADOOP-9103. UTF8 class does not properly decode Unicode characters outside the basic multilingual plane. Contributed by Todd Lipcon. (Revision 1417649)\n\n     Result = SUCCESS\ntodd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1417649\nFiles : \n* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt\n* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/io/UTF8.java\n* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/io/TestUTF8.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-06T14:05:56.950+0000","updated":"2012-12-06T14:05:56.950+0000"}],"maxResults":24,"total":24,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-9103/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0jwbz:"}}