{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12404702","self":"https://issues.apache.org/jira/rest/api/2/issue/12404702","key":"HADOOP-4211","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2008-09-22T17:10:30.841+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Oct 16 06:24:32 UTC 2008","customfield_12310420":"126388","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2338400717_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_3084952609","customfield_12312321":null,"resolutiondate":"2008-10-16T06:24:32.929+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-4211/watchers","watchCount":4,"isWatching":false},"created":"2008-09-19T04:51:12.212+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313211","id":"12313211","description":"","name":"0.19.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[{"id":"12321787","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12321787","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"inwardIssue":{"id":"12403519","key":"HADOOP-4053","self":"https://issues.apache.org/jira/rest/api/2/issue/12403519","fields":{"summary":"Schedulers need to know when a job has completed","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-07-08T16:40:33.177+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"Capacity Scheduler does not divide queue resources  properly among users, when job are submitted one after other. E.g. user limit =25. Say User1's job is running. Then user2 submits a job. Then user1's job uses 75% and user2's job 25%=user limit.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"104484","customfield_12312823":null,"summary":"Capacity Scheduler does not divide queue resources properly among users, when jobs are submitted one after other.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=karams","name":"karams","key":"karams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karam Singh","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=karams","name":"karams","key":"karams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karam Singh","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Mapred Cluster capacity with 204 Maps and 204 Reduces. User limit =25% and only one queue.\n\n","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404702/comment/12632510","id":"12632510","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=karams","name":"karams","key":"karams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karam Singh","active":true,"timeZone":"Asia/Kolkata"},"body":"Assumption: User are submitting the jobs one after another and not at the same time.\n\nHere is test scenario:\nUser1 submits job J1 with 612 maps and 408 reduces.\nWhen J1 starts running it uses all resources i.e 204 maps and 204 reducers, user2 submits job J2 with 204 maps and 204 reduces.\nJ2 will be queued until  running maps of  J1 starts getting completed.\n\nThe Observation is -:\nWhen both J1 and J2 are running -:\nJ1 is running 153 maps equal to 75% of resources\nJ2 is running 51 maps equal to 25% of resources.\n\nSimilarly User3 submit J3 then:\nJ1 runs 102 maps equal to 50% of resources\nJ2 runs 51 maps equal to 25% of resources\nJ3 runs 51 maps equal to 25% of resources\n\nAccording to documentation -: When there two users running jobs then resources will be shared 50% by both users.\nAnd Similarly When there are three users running jobs then resources will be shared 33% by users.\n\nNote -: If all users submit jobs at the same time, the resources are shared equally 50% (each for 2 user jobs) and 33% (each for 3 user jobs). \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=karams","name":"karams","key":"karams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karam Singh","active":true,"timeZone":"Asia/Kolkata"},"created":"2008-09-19T04:52:14.250+0000","updated":"2008-09-19T04:52:14.250+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404702/comment/12633385","id":"12633385","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=owen.omalley","name":"owen.omalley","key":"owen.omalley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=29697","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=29697","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=29697","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=29697"},"displayName":"Owen O'Malley","active":true,"timeZone":"America/Los_Angeles"},"body":"There isn't preemption between users in the same queue. Did you observe J1 getting more map slots after J2 was submitted, but before J2 reached 50%? And similarly for the second case?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=owen.omalley","name":"owen.omalley","key":"owen.omalley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=29697","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=29697","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=29697","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=29697"},"displayName":"Owen O'Malley","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-09-22T17:10:30.841+0000","updated":"2008-09-22T17:10:30.841+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404702/comment/12634403","id":"12634403","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"body":"The scenario in which this problem occurs is slightly different from what is described. The actual scenario is as follows:\n- Suppose we have n slots in the system, and 25% is the minimum user limit.\n- When we submit 3 jobs as 3 different users one after the other, in steady state, each user gets n/3 slots.\n- Let these 3 jobs complete.\n- Now, submit 2 more jobs as 2 different users.\n- The expectation is that the users get n/2 slots in steady state. However, the first user gets 2n/3 slots and the other user gets n/3 slots.\n\nThe reason for this behavior is directly related to HADOOP-4053. Currently, there is no notification to the schedulers that a job has completed. \n\nIn the {{CapacityTaskScheduler}}, the limit is computed as follows:\n{code}\nlimit = Math.max((int)(Math.ceil((double)currentCapacity/\n          (double)qsi.numJobsByUser.size())), \n          (int)(Math.ceil((double)(qsi.ulMin*currentCapacity)/100.0)));\n{code}\n\nA user is added to the map {{numJobsByUser}} when a job is added. The intent was that the user is removed from this map upon job completion. However, since this event is not yet raised, the number of users is not correctly updated. As a result, the limit is still computed as n/3, instead of n/2. And currently, if all users have hit the limit, then the first user with running jobs is given any remaining slots, explaining the behavior observed.\n\nIn summary, if HADOOP-4053 is fixed, this issue will automatically get fixed. In fact, I applied the patch currently available on HADOOP-4053 and verified the behavior is correct now. That is, the limit is recomputed correctly.\n\nI discussed this with Karam, and we agree that the observations are correct. I'll mark HADOOP-4053 a blocker for this bug. When that gets committed, Karam can try out again and close this bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"created":"2008-09-25T08:01:37.076+0000","updated":"2008-09-25T08:01:37.076+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404702/comment/12637146","id":"12637146","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"body":"Yes, part of this behavior is explained by HADOOP-4053. If none of the first three jobs is removed, and two additional jobs are submitted by two different users, then we have 5 users in the system, and each user gets 25% of the resources. When a slot is free, it is given to Job 4 (since Jobs 1, 2, and 3 don't have any tasks to run as they have completed). Slots are given to job4 till that job/user consumes n/4 slots. Then they're given to job5, up until n/4 slots are consumed by job5 too. With the fix for HADOOP-4053, the limits for job4 and job5 will be n/2, which is right. If either job4 or job5 does not have enough tasks to run at limit, additional slots are given to jobs that do have a need, even though they may be running at limit. \n\nI agree with you - you should re-evaluate this behavior once HADOOP-4053 is fixed. A lot depends on when jobs are marked complete and removed from the scheduler, as that determines the current user limit. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-06T17:31:21.308+0000","updated":"2008-10-06T17:31:21.308+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404702/comment/12640077","id":"12640077","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=karams","name":"karams","key":"karams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karam Singh","active":true,"timeZone":"Asia/Kolkata"},"body":"Checked and verified that after applying patch from HADOOP-4053 the queue resources are divided properly among users, when jobs are submitted one after other. \n\nTo verify third, did their following -:\nSubmitted 4 jobs one after the other (user-limit =25%) with different users. Slots are divided among job equally. \nAfter first 4 jobs finished submitted 2 new jobs with different users one after the other, slots were divided among both jobs (50% each).\n\n Repeated similar type of test about 10 times, and the behavior was same\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=karams","name":"karams","key":"karams","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karam Singh","active":true,"timeZone":"Asia/Kolkata"},"created":"2008-10-16T06:21:40.535+0000","updated":"2008-10-16T06:21:40.535+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12404702/comment/12640078","id":"12640078","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"body":"Based on Karam's testing, which confirms the diagnosis, I am marking this bug a duplicate of HADOOP-4053.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"created":"2008-10-16T06:24:32.923+0000","updated":"2008-10-16T06:24:32.923+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-4211/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0i8kv:"}}