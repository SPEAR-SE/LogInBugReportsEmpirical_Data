{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13106472","self":"https://issues.apache.org/jira/rest/api/2/issue/13106472","key":"HADOOP-14919","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334219","id":"12334219","description":"2.9.0 release","name":"2.9.0","archived":false,"released":true,"releaseDate":"2017-11-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341091","id":"12341091","name":"2.8.3","archived":false,"released":true,"releaseDate":"2017-12-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341256","id":"12341256","description":"2.7.5 release","name":"2.7.5","archived":false,"released":true,"releaseDate":"2017-12-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341431","id":"12341431","description":"3.0.0 GA release","name":"3.0.0","archived":false,"released":true,"releaseDate":"2017-12-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-10-04T20:26:09.682+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Feb 01 20:46:52 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_193702070_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_2305282738","customfield_12312321":null,"resolutiondate":"2017-10-31T14:38:44.633+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-14919/watchers","watchCount":15,"isWatching":false},"created":"2017-10-02T16:28:59.917+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329058","id":"12329058","description":"2.8.0 release","name":"2.8.0","archived":false,"released":true,"releaseDate":"2017-03-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334005","id":"12334005","description":"2.7.3 release","name":"2.7.3","archived":false,"released":true,"releaseDate":"2016-08-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335733","id":"12335733","description":"3.0.0-alpha1 release","name":"3.0.0-alpha1","archived":false,"released":true,"releaseDate":"2016-09-03"}],"issuelinks":[{"id":"12516531","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12516531","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"inwardIssue":{"id":"12941604","key":"HADOOP-13270","self":"https://issues.apache.org/jira/rest/api/2/issue/12941604","fields":{"summary":"BZip2CompressionInputStream finds the same compression marker twice in corner case, causing duplicate data blocks","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-02-01T20:46:52.464+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"BZip2 can drop records when reading data in splits. This problem was already discussed before in HADOOP-11445 and HADOOP-13270. But we still have a problem in corner case, causing lost data blocks.\n \nI attached a unit test for this issue. You can reproduce the problem if you run the unit test.\n \nFirst, this issue happens when position of newly created stream is equal to start of split. Hadoop has some test cases for this (blockEndingInCR.txt.bz2 file for TestLineRecordReader#testBzip2SplitStartAtBlockMarker, etc). However, the issue I am reporting does not happen when we run these tests because this issue happens only when the start of split byte block includes both block marker and compressed data.\n \nBZip2 block marker - 0x314159265359 (001100010100000101011001001001100101001101011001)\n \nblockEndingInCR.txt.bz2 (Start of Split - 136504):\n{code:java}\n$ xxd -l 6 -g 1 -b -seek 136498 ./hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core/target/test-classes/blockEndingInCR.txt.bz2\n0021532: 00110001 01000001 01011001 00100110 01010011 01011001  1AY&SY\n{code}\n\n \nTest bz2 File (Start of Split - 203426)\n{code:java}\n$ xxd -l 7 -g 1 -b -seek 203419 250000.bz2\n0031a9b: 11100110 00101000 00101011 00100100 11001010 01101011  .(+$.k\n0031aa1: 00101111                                               /\n{code}\n\n \nLet's say a job splits this test bz2 file into two splits at the start of split (position 203426).\nThe former split does not read records which start position 203426 because BZip2 says the position of these dropped records is 203427. The latter split does not read the records because BZip2CompressionInputStream read the block from position 320955.\nDue to this behavior, records between 203427 and 320955 are lost.\n\nAlso, if we reverted the changes in HADOOP-13270, we will not see this issue. We will see HADOOP-13270 issue though.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334219","id":"12334219","description":"2.9.0 release","name":"2.9.0","archived":false,"released":true,"releaseDate":"2017-11-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341091","id":"12341091","name":"2.8.3","archived":false,"released":true,"releaseDate":"2017-12-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341256","id":"12341256","description":"2.7.5 release","name":"2.7.5","archived":false,"released":true,"releaseDate":"2017-12-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341431","id":"12341431","description":"3.0.0 GA release","name":"3.0.0","archived":false,"released":true,"releaseDate":"2017-12-13"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12889981","id":"12889981","filename":"250000.bz2","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-02T16:31:04.735+0000","size":320955,"mimeType":"application/x-bzip2","content":"https://issues.apache.org/jira/secure/attachment/12889981/250000.bz2"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12890447","id":"12890447","filename":"HADOOP-14919.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-04T22:11:52.187+0000","size":11265,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12890447/HADOOP-14919.001.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12889980","id":"12889980","filename":"HADOOP-14919-test.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-02T16:29:54.948+0000","size":3570,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12889980/HADOOP-14919-test.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"BZip2 drops records when reading data in splits","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16188397","id":"16188397","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"body":"Add patch for the unit test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-02T16:30:14.130+0000","updated":"2017-10-02T16:30:14.130+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16188403","id":"16188403","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"body":"Adding the test bz2 file (The bz2 file that the attached unit test generates)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-02T16:32:11.384+0000","updated":"2017-10-02T16:32:11.384+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16191986","id":"16191986","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Upgrading the priority since this involves silent data loss.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-04T20:26:09.682+0000","updated":"2017-10-04T20:26:09.682+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16192154","id":"16192154","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"A lot of the troubles with split handling in this codec are related to these issues:\n1) It seeks _backwards_ from the split start looking for a possible bzip2 block header and sometimes miscomputes where that should start.\n2) It is reporting stream positions that can skip data that has not been processed yet (as in this case).\n\nSo here's my pitch at fixing this for the Nth time:\n- No seeking backwards.  Any block whose start marker appears before the split is not the responsibility of this split's reader.  Split processing should never require reading data just before the split offset, as that data is entirely the responsibility of the previous split's reader.\n- Stream position reports the byte where the block start marker begins rather than the byte after it ends.  That way we're always consistent about who is responsible for \"consuming\" a block start header and never report byte positions that may have skipped some data bits.\n\nThis is probably going to break _something_ given how many attempts there have been at fixing this, so I greatly appreciate any and all eyes willing to take a look.  Alternative proposals are also welcome.\n\nAttaching a patch that implements the approach described above.  Thanks to [~tanakahda] for the unit test.  I extended it to test all the split positions around the block start marker for this test case. Speaking of tests, Jenkins won't run all the related tests, so I also manually ran the TestLineRecordReader tests in hadoop-mapreduce-client-core and they passed.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-04T22:16:47.719+0000","updated":"2017-10-04T22:16:47.719+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16192365","id":"16192365","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\n\\\\\n\\\\\n|| Vote || Subsystem || Runtime || Comment ||\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 16s{color} | {color:blue} Docker mode activated. {color} |\n|| || || || {color:brown} Prechecks {color} ||\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\n| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |\n|| || || || {color:brown} trunk Compile Tests {color} ||\n| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 15s{color} | {color:blue} Maven dependency ordering for branch {color} |\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 13m 29s{color} | {color:green} trunk passed {color} |\n| {color:green}+1{color} | {color:green} compile {color} | {color:green} 15m 58s{color} | {color:green} trunk passed {color} |\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  2m 15s{color} | {color:green} trunk passed {color} |\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 37s{color} | {color:green} trunk passed {color} |\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 15m 49s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m 26s{color} | {color:green} trunk passed {color} |\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 15s{color} | {color:green} trunk passed {color} |\n|| || || || {color:brown} Patch Compile Tests {color} ||\n| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 21s{color} | {color:blue} Maven dependency ordering for patch {color} |\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  1m 13s{color} | {color:green} the patch passed {color} |\n| {color:green}+1{color} | {color:green} compile {color} | {color:green} 13m  6s{color} | {color:green} the patch passed {color} |\n| {color:green}+1{color} | {color:green} javac {color} | {color:green} 13m  6s{color} | {color:green} the patch passed {color} |\n| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  2m 19s{color} | {color:orange} root: The patch generated 2 new + 118 unchanged - 9 fixed = 120 total (was 127) {color} |\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 54s{color} | {color:green} the patch passed {color} |\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 11m 57s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m 37s{color} | {color:green} the patch passed {color} |\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 40s{color} | {color:green} the patch passed {color} |\n|| || || || {color:brown} Other Tests {color} ||\n| {color:red}-1{color} | {color:red} unit {color} | {color:red}  9m 22s{color} | {color:red} hadoop-common in the patch failed. {color} |\n| {color:green}+1{color} | {color:green} unit {color} | {color:green}101m 37s{color} | {color:green} hadoop-mapreduce-client-jobclient in the patch passed. {color} |\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 45s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\n| {color:black}{color} | {color:black} {color} | {color:black}216m 49s{color} | {color:black} {color} |\n\\\\\n\\\\\n|| Reason || Tests ||\n| Failed junit tests | hadoop.security.TestKDiag |\n\\\\\n\\\\\n|| Subsystem || Report/Notes ||\n| Docker |  Image:yetus/hadoop:71bbb86 |\n| JIRA Issue | HADOOP-14919 |\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12890447/HADOOP-14919.001.patch |\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\n| uname | Linux 081a67763b93 3.13.0-117-generic #164-Ubuntu SMP Fri Apr 7 11:05:26 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |\n| Build tool | maven |\n| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |\n| git revision | trunk / cae1c73 |\n| Default Java | 1.8.0_144 |\n| findbugs | v3.1.0-RC1 |\n| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/13454/artifact/patchprocess/diff-checkstyle-root.txt |\n| unit | https://builds.apache.org/job/PreCommit-HADOOP-Build/13454/artifact/patchprocess/patch-unit-hadoop-common-project_hadoop-common.txt |\n|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/13454/testReport/ |\n| modules | C: hadoop-common-project/hadoop-common hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-jobclient U: . |\n| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/13454/console |\n| Powered by | Apache Yetus 0.6.0-SNAPSHOT   http://yetus.apache.org |\n\n\nThis message was automatically generated.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-05T01:57:39.447+0000","updated":"2017-10-05T01:57:39.447+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16193075","id":"16193075","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"body":"Thank you for the patch. I tested the patch and confirmed that the patch can fix the issues we saw in our production environment.\nAs far as I tested, I did not see any regressions or new issues.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-05T15:49:25.566+0000","updated":"2017-10-05T15:49:25.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16193088","id":"16193088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Thanks for taking the patch for a test drive!  Glad to hear it fixes the problem and doesn't seem to regress anything so far.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-05T16:01:17.095+0000","updated":"2017-10-05T16:01:17.095+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16199444","id":"16199444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=subru","name":"subru","key":"subru","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=subru&avatarId=21709","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=subru&avatarId=21709","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=subru&avatarId=21709","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=subru&avatarId=21709"},"displayName":"Subru Krishnan","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~jlowe] for fixing this and [~tanakahda] for validating the fix. I assume since it has been tested, it'll be committed in time for 2.9?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=subru","name":"subru","key":"subru","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=subru&avatarId=21709","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=subru&avatarId=21709","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=subru&avatarId=21709","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=subru&avatarId=21709"},"displayName":"Subru Krishnan","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-10T22:06:18.292+0000","updated":"2017-10-10T22:06:18.292+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16199457","id":"16199457","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"If it can get a thorough review from someone then yes. ;-)  Still looking for a committer who knows a thing or two about splittable codecs and the pitfalls therein to find time to give this a review.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-10T22:11:13.213+0000","updated":"2017-10-10T22:11:13.213+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16217177","id":"16217177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"[~lewuathe] [~ajisakaa] this is a bug related to the changes in HADOOP-13270.  Would you have time to take a look?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-24T16:22:18.259+0000","updated":"2017-10-24T16:22:18.259+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16218188","id":"16218188","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ajisakaa","name":"ajisakaa","key":"ajisakaa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ajisakaa&avatarId=17238","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ajisakaa&avatarId=17238","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ajisakaa&avatarId=17238","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ajisakaa&avatarId=17238"},"displayName":"Akira Ajisaka","active":true,"timeZone":"Asia/Tokyo"},"body":"LGTM, +1. I ran all the bzip2-related tests locally and all the tests passed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ajisakaa","name":"ajisakaa","key":"ajisakaa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ajisakaa&avatarId=17238","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ajisakaa&avatarId=17238","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ajisakaa&avatarId=17238","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ajisakaa&avatarId=17238"},"displayName":"Akira Ajisaka","active":true,"timeZone":"Asia/Tokyo"},"created":"2017-10-25T07:01:21.275+0000","updated":"2017-10-25T07:01:21.275+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16221294","id":"16221294","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chris.douglas","name":"chris.douglas","key":"chris.douglas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Douglas","active":true,"timeZone":"America/Los_Angeles"},"body":"+1 for removing the seek backward. The text reader also had bugs from that. Ironically, they were discovered/fixed as part of adding splittable codecs.\r\n\r\nLooking at the code, would this support concatenated bzip files? The reader handling the previous block will detect the end of its stream, and a split following it should find the block delimiter after the header of the next file. However, if the text splits are around the concat point, the {{BZh9}} bytes may not be unaccounted for. The codec skips these at the beginning of the file and updates {{reportedBytesReadFromCompressedStream}}, but I didn't see handling for this within the stream. Similarly, if splits are arranged like this:\r\n{noformat}\r\nfile.txt.bz2: [BZh93141592659xxxxxxxx3141592659xxxxxxxx0x177245385090BZh93141592659ooooooo3141592659xxxxxxxx...]\r\n               ^split0                                                               ^split1\r\n{noformat}\r\n\r\nWould split0 pick up the {{ooooooo}} bytes?\r\n\r\nIt doesn't look like the unit tests cover a combination of multi-byte delimiters and splittable codecs. I don't know how thoroughly we can test that, without getting too deep into bzip2...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chris.douglas","name":"chris.douglas","key":"chris.douglas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Douglas","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-26T21:48:25.347+0000","updated":"2017-10-26T21:48:25.347+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16222840","id":"16222840","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=subru","name":"subru","key":"subru","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=subru&avatarId=21709","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=subru&avatarId=21709","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=subru&avatarId=21709","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=subru&avatarId=21709"},"displayName":"Subru Krishnan","active":true,"timeZone":"America/Los_Angeles"},"body":"[~jlowe], is this on track for 2.9.0? I see that [~ajisakaa]'s signed off and [~chris.douglas] also has reviewed it and has couple of outstanding questions. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=subru","name":"subru","key":"subru","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=subru&avatarId=21709","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=subru&avatarId=21709","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=subru&avatarId=21709","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=subru&avatarId=21709"},"displayName":"Subru Krishnan","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-27T21:15:12.763+0000","updated":"2017-10-27T21:15:12.763+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16222899","id":"16222899","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chris.douglas","name":"chris.douglas","key":"chris.douglas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Douglas","active":true,"timeZone":"America/Los_Angeles"},"body":"FWIW, I'd be +1 on the patch as-is","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chris.douglas","name":"chris.douglas","key":"chris.douglas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Douglas","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-27T21:49:16.872+0000","updated":"2017-10-27T21:49:16.872+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16222936","id":"16222936","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Thanks for the reviews, Akira and Chris!\r\n\r\nbq. is this on track for 2.9.0?\r\n\r\nI'd like to dig into the potential issues Chris brought up, and I was hoping to carve out some time early next week to do so.  So if we have time I'd rather wait, but I'm also OK if this goes in and the investigation is done in a followup JIRA.\r\n\r\nConcatenated bzip2 files may already be problematic according to HADOOP-6852 but I haven't had a chance to verify yet.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-27T22:08:51.479+0000","updated":"2017-10-27T22:08:51.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16223051","id":"16223051","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=subru","name":"subru","key":"subru","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=subru&avatarId=21709","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=subru&avatarId=21709","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=subru&avatarId=21709","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=subru&avatarId=21709"},"displayName":"Subru Krishnan","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~jlowe] for the clarification. We can wait if it's early next week. If it gets delayed or you hit complications, we can fall back to committing this and having a followup JIRA.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=subru","name":"subru","key":"subru","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=subru&avatarId=21709","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=subru&avatarId=21709","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=subru&avatarId=21709","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=subru&avatarId=21709"},"displayName":"Subru Krishnan","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-27T23:33:11.731+0000","updated":"2017-10-27T23:33:11.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16225517","id":"16225517","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Had some more time to look into this today.  HADOOP-6852 is legit.  Concatenated bz2 files don't work at all in Hadoop:\r\n{noformat}\r\n$ echo hey | bzip2 -c > foo.bz2\r\n$ echo there | bzip2 -c >> foo.bz2\r\n$ bzcat foo.bz2\r\nhey\r\nthere\r\n$ hadoop fs -put foo.bz2\r\n$ hadoop fs -text foo.bz2     \r\n2017-10-30 13:18:08,083 INFO  [main] compress.CodecPool (CodecPool.java:getDecompressor(184)) - Got brand-new decompressor [.bz2]\r\nhey\r\ntext: bad block header\r\n{noformat}\r\n\r\nI don't think it would be very difficult to add support for concatenation.  IIUC all it needs to do is account for the possibility that 'BZh9' could appear before the block marker.  We should _not_ updated the reported position when skipping just the 'BZh9' bytes and only when we move from block mark to block mark.  The existing behavior of skipping at the file offset 0 is benign, but I don't think we want/need to update reported position when skipping these extra bytes mid-stream.\r\n\r\nbq. The reader handling the previous block will detect the end of its stream, and a split following it should find the block delimiter after the header of the next file. However, if the text splits are around the concat point, the BZh9 bytes may not be unaccounted for.\r\n\r\nAssuming we add the ability to silently skip 'BZh9' we should still be OK.  The compression input stream will only report the position moving when the next block starts to be read.  Whether we have 'BZh9' bytes or not doesn't change that.  We either read the whole block header and marker or none of it.  The upper layer reader will continue reading until the reported position changes, so the upper layer semantics don't change based on the presence of the extra header bytes.  Therefore I argue we're either OK or already screwed whether there's an extra header there or not.\r\n\r\nbq. Would split0 pick up the ooooooo bytes?\r\n\r\nI had a little trouble following the example and knowing what was a record delimiter.  In general the split reader is responsible for reading until a record ends in the next split because the next reader will always toss away the first record.  \"Ends in the next split\" means the entire delimiter appears in the next split, since the next split reader will toss all bytes up to and including the first record delimiter found.  There's some complicated logic in LineRecordReader and SplitLineReader to account for buffering occurring at both the codec and line reader levels along with the games codecs can play with reported byte position in the stream.\r\n\r\nbq. It doesn't look like the unit tests cover a combination of multi-byte delimiters and splittable codecs.\r\n\r\nSee TestLineRecordReader#testBzipWithMultibyteDelimiter and compressedMultibyteDelimiter.txt.bz2.  I doubt it is exhaustive of all the corner cases, but there is at least one test there.\r\n\r\nAt this point I think we're good to go with committing this and addressing concatenated bz2 in HADOOP-6852.  As such I'll commit this tomorrow if there are no objections.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-30T18:39:27.084+0000","updated":"2017-10-30T18:39:27.084+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16225643","id":"16225643","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chris.douglas","name":"chris.douglas","key":"chris.douglas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Douglas","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. We should not updated the reported position when skipping just the 'BZh9' bytes and only when we move from block mark to block mark. The existing behavior of skipping at the file offset 0 is benign, but I don't think we want/need to update reported position when skipping these extra bytes mid-stream.\r\n+1 I saw this was skipped from the codec, and wanted to be sure (if concatenation is supported) that your fix worked in that case. But as you say, it's moot if it doesn't support concatenated bz2 files.\r\n\r\nbq. I had a little trouble following the example and knowing what was a record delimiter\r\nSorry. If split0 stopped at the end of stream and split1 skipped to the next delimiter, then the {{oooooo}} bytes would be skipped.\r\n\r\nbq.  See TestLineRecordReader#testBzipWithMultibyteDelimiter\r\nThanks, I'd missed that.\r\n\r\n+1 for committing this. Thanks for the detailed fix and followup, Jason.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chris.douglas","name":"chris.douglas","key":"chris.douglas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Douglas","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-30T19:53:54.615+0000","updated":"2017-10-30T19:53:54.615+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16226893","id":"16226893","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Thanks to [~chris.douglas], [~ajisakaa], and [~tanakahda] for reviews!  I committed this to trunk, branch-3.0, branch-2, branch-2.8, and branch-2.7.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-31T14:38:44.690+0000","updated":"2017-10-31T14:38:44.690+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16226929","id":"16226929","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #13166 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/13166/])\nHADOOP-14919. BZip2 drops records when reading data in splits. (jlowe: rev 2fae63aa60c43b62bd908a9499562fe528603185)\n* (edit) hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/io/compress/BZip2Codec.java\n* (edit) hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/io/compress/bzip2/CBZip2InputStream.java\n* (edit) hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-jobclient/src/test/java/org/apache/hadoop/mapred/TestTextInputFormat.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T14:51:51.768+0000","updated":"2017-10-31T14:51:51.768+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13106472/comment/16349239","id":"16349239","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"body":"Hello,\r\n\r\nRegarding this issue, I found another corner case of BZip2 codec/input stream behavior. CreatedHADOOP-15206 .\r\n\r\nI'd like someone in this thread look atHADOOP-15206 too. Thank you.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanakahda","name":"tanakahda","key":"tanakahda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aki Tanaka","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-02-01T20:46:52.464+0000","updated":"2018-02-01T20:46:52.464+0000"}],"maxResults":21,"total":21,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-14919/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3kscn:"}}