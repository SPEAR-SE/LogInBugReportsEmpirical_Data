{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13183472","self":"https://issues.apache.org/jira/rest/api/2/issue/13183472","key":"HADOOP-15725","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-09-06T19:44:58.991+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Sep 07 17:01:19 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15725/watchers","watchCount":5,"isWatching":false},"created":"2018-09-06T18:15:48.419+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["Security"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-09-07T17:01:19.171+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"For now, we able to add any file to FileSystem deleteOnExit list. It leads to security problems. Some user (Intruder) can get file system instance which was created by another user (Owner) and mark any files to delete even if \"Intruder\" doesn't have any access to this files. Later when \"Owner\" invoke close method (or JVM is shut down since we have ShutdownHook which able to close all file systems) marked files will be deleted successfully since deleting was do behalf of \"Owner\" (or behalf of a user who ran a program).\r\n\r\nI attached the patchÂ [^deleteOnExitReproduce] which reproduces this possibility and also I able to reproduce it on a cluster with both Local and Distributed file systems:\r\n{code:java}\r\npublic class Main {\r\n\r\npublic static void main(String[] args) throws Exception {\r\n\r\nfinal FileSystem fs;\r\n Configuration conf = new Configuration();\r\n conf.set(\"fs.default.name\", \"hdfs://node:9000\");\r\n conf.set(\"fs.hdfs.impl\",\r\n org.apache.hadoop.hdfs.DistributedFileSystem.class.getName()\r\n );\r\n fs = FileSystem.get(conf);\r\n System.out.println(fs);\r\n\r\nPath f = new Path(\"/user/root/testfile\");\r\n System.out.println(f);\r\n\r\nUserGroupInformation hive = UserGroupInformation.createRemoteUser(\"hive\");\r\n\r\nhive.doAs((PrivilegedExceptionAction<Boolean>) () -> fs.deleteOnExit(f));\r\n\r\nfs.close();\r\n }\r\n{code}\r\nResult:\r\n{noformat}\r\nroot@node:/# hadoop fs -put testfile /user/root\r\nroot@node:/# hadoop fs -chmod 700 /user/root/testfile\r\nroot@node:/# hadoop fs -ls /user/root\r\nFound 1 items\r\n-rw------- 1 root supergroup 0 2018-09-06 18:07 /user/root/testfile\r\nroot@node:/# java -jar testDeleteOther.jar \r\nlog4j:WARN No appenders could be found for logger (org.apache.hadoop.conf.Configuration.deprecation).\r\nlog4j:WARN Please initialize the log4j system properly.\r\nlog4j:WARN See http://logging.apache.org/log4j/1.2/faq.html#noconfig for more info.\r\nDFS[DFSClient[clientName=DFSClient_NONMAPREDUCE_309539034_1, ugi=root (auth:SIMPLE)]]\r\n/user/root/testfile\r\n[]\r\nroot@node:/# hadoop fs -ls /user/root\r\nroot@node:/# \r\n{noformat}\r\nWe should add a check user permissions before mark a file to delete. \r\n Could someone evaluate this? And if no one objects I would like to start working on this.\r\n Thanks a lot for any comments.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12938686","id":"12938686","filename":"deleteOnExitReproduce","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oshevchenko","name":"oshevchenko","key":"oshevchenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=oshevchenko&avatarId=36674","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=oshevchenko&avatarId=36674","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=oshevchenko&avatarId=36674","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=oshevchenko&avatarId=36674"},"displayName":"Oleksandr Shevchenko","active":true,"timeZone":"Europe/Kiev"},"created":"2018-09-06T18:13:42.236+0000","size":2643,"mimeType":"text/html","content":"https://issues.apache.org/jira/secure/attachment/12938686/deleteOnExitReproduce"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"FileSystem.deleteOnExit should check user permissions","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oshevchenko","name":"oshevchenko","key":"oshevchenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=oshevchenko&avatarId=36674","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=oshevchenko&avatarId=36674","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=oshevchenko&avatarId=36674","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=oshevchenko&avatarId=36674"},"displayName":"Oleksandr Shevchenko","active":true,"timeZone":"Europe/Kiev"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oshevchenko","name":"oshevchenko","key":"oshevchenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=oshevchenko&avatarId=36674","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=oshevchenko&avatarId=36674","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=oshevchenko&avatarId=36674","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=oshevchenko&avatarId=36674"},"displayName":"Oleksandr Shevchenko","active":true,"timeZone":"Europe/Kiev"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13183472/comment/16606317","id":"16606317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eyang","name":"eyang","key":"eyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Yang","active":true,"timeZone":"America/Los_Angeles"},"body":"I believe this is a non-Kerberos setup issue.  In non-Kerberos cluster, UserGroupInformation.isSecurityEnabled()==false, and it will by pass all security check in Hadoop code base.  Therefore, if you use UserGroupInformation.createRemoteUser(), there is no security enforcing impersonation check and allow the operation to be carried out as root user.  Try this on a Kerberos setup, and see if you get the same result.  Same operation shouldn't work on Kerberos enabled cluster.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eyang","name":"eyang","key":"eyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Yang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-09-06T19:44:58.991+0000","updated":"2018-09-06T19:44:58.991+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13183472/comment/16606889","id":"16606889","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oshevchenko","name":"oshevchenko","key":"oshevchenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=oshevchenko&avatarId=36674","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=oshevchenko&avatarId=36674","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=oshevchenko&avatarId=36674","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=oshevchenko&avatarId=36674"},"displayName":"Oleksandr Shevchenko","active":true,"timeZone":"Europe/Kiev"},"body":"Thank you [~eyang] for your comment.\r\nThe same behavior on a kerberos cluster:\r\n{noformat}\r\nbash-4.1# hadoop fs -put testfile /tmp/\r\nbash-4.1# hadoop fs -chmod 700 /tmp/testfile\r\nbash-4.1# hadoop fs -ls /tmp\r\nFound 2 items\r\ndrwxrwx--- - root root 0 2018-09-07 06:16 /tmp/hadoop-yarn\r\n-rwx------ 1 root root 0 2018-09-07 09:16 /tmp/testfile\r\nbash-4.1# java -jar testDeleteOther.jar\r\nDFS[DFSClient[clientName=DFSClient_NONMAPREDUCE_2134263987_1, ugi=root@EXAMPLE.COM (auth:KERBEROS)]]\r\n/tmp/testfile\r\nhive (auth:KERBEROS)\r\nbash-4.1# hadoop fs -ls /tmp\r\nFound 1 items\r\ndrwxrwx--- - root root 0 2018-09-07 06:16 /tmp/hadoop-yarn\r\nbash-4.1#\r\n\r\n{noformat}\r\n{code:java}\r\nfinal FileSystem fs;\r\nConfiguration conf = new Configuration();\r\nconf.set(\"hadoop.security.authentication\", \"kerberos\");\r\nconf.set(\"dfs.namenode.kerberos.principal.pattern\", \"*\");\r\nconf.set(\"hadoop.rpc.protection\", \"privacy\");\r\nconf.set(\"fs.default.name\", \"hdfs://hadoop.docker.com:9000\");\r\nconf.set(\"fs.hdfs.impl\",\r\norg.apache.hadoop.hdfs.DistributedFileSystem.class.getName()\r\n);\r\nUserGroupInformation.setConfiguration(conf);\r\nfs = FileSystem.get(conf);\r\nSystem.out.println(fs);\r\n\r\nPath f = new Path(\"/tmp/testfile\");\r\nSystem.out.println(f);\r\n\r\nUserGroupInformation hive = UserGroupInformation.createRemoteUser(\"hive\", SaslRpcServer.AuthMethod.KERBEROS);\r\nSystem.out.println(hive);\r\n\r\nhive.doAs((PrivilegedExceptionAction<Boolean>) () -> fs.deleteOnExit(f));\r\n\r\nfs.close();\r\n\r\n\r\n{code}\r\nDo you think this is correct behavior for non-Kerberos cluster? I believe this is not acceptable for insecure cluster too since we do not honor file permissions. Please, correct me if I missed something.\r\nAppreciate your help.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oshevchenko","name":"oshevchenko","key":"oshevchenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=oshevchenko&avatarId=36674","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=oshevchenko&avatarId=36674","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=oshevchenko&avatarId=36674","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=oshevchenko&avatarId=36674"},"displayName":"Oleksandr Shevchenko","active":true,"timeZone":"Europe/Kiev"},"created":"2018-09-07T09:29:09.927+0000","updated":"2018-09-07T09:48:09.770+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13183472/comment/16607365","id":"16607365","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eyang","name":"eyang","key":"eyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Yang","active":true,"timeZone":"America/Los_Angeles"},"body":"[~oshevchenko] Thank you for the example, and I confirmed that if the program is running as root user, and HDFS is also running as root user.  The delete call will carry out.  If the java code is running as a different user than hdfs super user, then the file doesn't get deleted.  It does look like a bug that using super user to impersonate a less privileged user to perform operation, and the operation still carry out with super user privilege is a concerning problem and needs to be addressed.  Both secure and insecure cluster seems to have the same bug that super user impersonate a lesser privileged user doesn't prevent invocation of super user power.  \r\n\r\nYou are correct that this is not acceptable for insecure cluster as well.  Before this bug is fixed, the rule of thumb is to prevent running program with hdfs super user.  It is too mighty powerful.  At least, kerberos enabled cluster, user must have login to KDC with hdfs super user to exploit this bug.  It is not easily carry out by unauthorized user.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eyang","name":"eyang","key":"eyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Yang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-09-07T17:01:19.171+0000","updated":"2018-09-07T17:01:19.171+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15725/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3xtdb:"}}