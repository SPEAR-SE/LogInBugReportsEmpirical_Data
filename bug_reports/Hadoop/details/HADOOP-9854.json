{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12662755","self":"https://issues.apache.org/jira/rest/api/2/issue/12662755","key":"HADOOP-9854","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2013-09-17T22:42:54.527+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Sep 23 20:17:05 UTC 2013","customfield_12310420":"342757","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-9854/watchers","watchCount":10,"isWatching":false},"created":"2013-08-09T00:26:58.547+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324426","id":"12324426","description":"maintenance release on branch-2.0-alpha","name":"2.0.5-alpha","archived":false,"released":true,"releaseDate":"2013-06-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-03-01T06:22:32.196+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310711","id":"12310711","name":"conf","description":"Hadoop configuration mechanism."},{"self":"https://issues.apache.org/jira/rest/api/2/component/12311160","id":"12311160","name":"documentation"}],"timeoriginalestimate":null,"description":"Currently deprecated keys are registered at various times. Some are registered  when the Configuration class itself is initialized, but the vast majority are registered when the JobConf class is initialized.\n\nTherefore, it is entirely possible (and does happen) that Configuration.set() is called for a key before its deprecation mapping is registered, thus leaving the internal state of Configuration in an inconsistent state.\n\nWe actually had this problem occur in real life, causing the set value not to be recognized.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"343061","customfield_12312823":null,"summary":"Configuration.set() may be called before all the deprecated keys are registered, causing inconsistent state","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjlee0","name":"sjlee0","key":"sjlee0","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sjlee0&avatarId=16831","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sjlee0&avatarId=16831","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sjlee0&avatarId=16831","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sjlee0&avatarId=16831"},"displayName":"Sangjin Lee","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjlee0","name":"sjlee0","key":"sjlee0","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sjlee0&avatarId=16831","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sjlee0&avatarId=16831","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sjlee0&avatarId=16831","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sjlee0&avatarId=16831"},"displayName":"Sangjin Lee","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12662755/comment/13734257","id":"13734257","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjlee0","name":"sjlee0","key":"sjlee0","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sjlee0&avatarId=16831","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sjlee0&avatarId=16831","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sjlee0&avatarId=16831","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sjlee0&avatarId=16831"},"displayName":"Sangjin Lee","active":true,"timeZone":"America/Los_Angeles"},"body":"One easy way to recreate this problem is as follows. Do\n\n{code}\nhadoop jar some_jar -D mapred.reduce.tasks=100 ...\n{code}\n\nwhere my class uses ToolRunner to do its task:\n\n{code}\npublic static void main(String[] args) {\n  ToolRunner.run(new Configuration(), new MyClass(), args);\n}\n{code}\n\nToolRunner will start using GenericOptionsParser to parse the -D overrides, and it will call Configuration.set() to set the overrides. However, in this case the JobConf class is still not initialized. Therefore, the \"mapred.reduce.tasks\" key is not registered as deprecated. As a result, the Configuration will have \"mapred.reduce.tasks\" set to 100, but \"mapreduce.job.reduces\" (the new key) still set to 1 (the default).\n\nThe configuration will be left in this inconsistent state until the JobConf class is initialized and a get() call for either of these keys is made.\n\nIn our particular scenario, a map was created out of this Configuration using Configuration.iterator(), and eventually caused it to lose the overridden value.\n\nI think this inconsistent state has many ways to cause havoc, and I believe this is a major bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjlee0","name":"sjlee0","key":"sjlee0","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sjlee0&avatarId=16831","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sjlee0&avatarId=16831","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sjlee0&avatarId=16831","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sjlee0&avatarId=16831"},"displayName":"Sangjin Lee","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-09T00:36:48.757+0000","updated":"2013-08-09T00:36:48.757+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12662755/comment/13770104","id":"13770104","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jrottinghuis","name":"jrottinghuis","key":"jrottinghuis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joep Rottinghuis","active":true,"timeZone":"America/Los_Angeles"},"body":"Marking as blocker. W/o this Cascading was not able to properly replace deprecated keys with new ones in the config causing jobs to fail.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jrottinghuis","name":"jrottinghuis","key":"jrottinghuis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joep Rottinghuis","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-09-17T22:42:54.527+0000","updated":"2013-09-17T22:42:54.527+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12662755/comment/13771150","id":"13771150","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"[~sjlee0] Do you know what caused this issue with Cascading? Is it using new keys? Or, are you putting new keys (mapreduce.job.reduces) in your configs?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-09-18T19:42:27.946+0000","updated":"2013-09-18T19:42:27.946+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12662755/comment/13771187","id":"13771187","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"I'm wondering if the fix is simply to use the appropriate configuration object for the tool in question.  Since the tool requires supporting MapReduce configs, have it use JobConf which is MapReduce-aware instead of Configuration which is not.  For example:\n\n{code}\npublic static void main(String[] args) {\n  ToolRunner.run(new JobConf(), new MyClass(), args);\n}\n{code}\n\nOtherwise I don't see how we can determine that the particular Configuration object is really going to later be a JobConf object and load the deprecated keys ahead of time. Even if we tried to fix it up after the fact we could encounter situations where the config has conflicting values for keys.  For example, two different chunks of code use different keys for the same concept and we end up with something like -Dmapred.reduce.tasks=20 and -Dmapreduce.job.reduces=100.  If these keys were set before the Configuration morphed into a JobConf, we wouldn't know which was the correct setting that should survive once JobConf arrives and tries to rectify the situation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2013-09-18T20:16:45.367+0000","updated":"2013-09-18T20:16:45.367+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12662755/comment/13775613","id":"13775613","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjlee0","name":"sjlee0","key":"sjlee0","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sjlee0&avatarId=16831","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sjlee0&avatarId=16831","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sjlee0&avatarId=16831","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sjlee0&avatarId=16831"},"displayName":"Sangjin Lee","active":true,"timeZone":"America/Los_Angeles"},"body":"[~acmurthy], the sequence of events is a little involved. The specific combination is scalding and cascading. The problem starts when the user sets an old key. Let's say the user set the old key to 100 (where the default is 1).\n\nScalding runs the task with the ToolRunner but uses Configuration. In its tool, scalding converts the configuration items from the Configuration into a Map<String,String> and passes it to cascading. In cascading, using a Map as opposed to a Configuration or JobConf is a standard mode of operation. When scalding creates the Map, it uses Configuration.iterator() to get the values out of the Configuration. So up until this point, the deprecated keys from JobConf have not been registered (because JobConf was not initialized), and thus the Map now contains inconsistent values for any map-reduce-related config params. At this point, the Map has 100 under the old key, and 1 under the new key.\n\nOnce cascading receives this Map, it eventually constructs a JobConf instance using the Map. This triggers all the deprecated keys for JobConf to be registered. And when values from Map are set onto JobConf via set(), the new value from the Map wins (which is still the default value, not the user-overridden value), thus wiping out the user override. The JobConf instance now has 1 for both the new and the old keys.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjlee0","name":"sjlee0","key":"sjlee0","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sjlee0&avatarId=16831","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sjlee0&avatarId=16831","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sjlee0&avatarId=16831","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sjlee0&avatarId=16831"},"displayName":"Sangjin Lee","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-09-23T20:09:55.132+0000","updated":"2013-09-23T20:09:55.132+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12662755/comment/13775618","id":"13775618","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjlee0","name":"sjlee0","key":"sjlee0","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sjlee0&avatarId=16831","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sjlee0&avatarId=16831","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sjlee0&avatarId=16831","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sjlee0&avatarId=16831"},"displayName":"Sangjin Lee","active":true,"timeZone":"America/Los_Angeles"},"body":"[~jlowe] Actually that's precisely what we ended up doing with scalding to address this issue: https://github.com/twitter/scalding/commit/c8d963496cbe3e327359a893ee737cd42367a4a4\n\nAnd I also cannot think of a clean solution that can prevent this type of problems, or I would have suggested a patch.\n\nBut I feel some discomfort in this in the sense that there is nothing that stops people from setting map-reduce specific properties using Configuration, and yet there is this window of opportunity between when Configuration is initialized and JobConf is initialized where such an action of setting a property will leave the internal state of Configuration in an inconsistent state.\n\nSince we fixed this on the scalding side, we're proceeding OK now. However, it would be great if we could at least clarify this somewhere (javadoc or wiki or?) that if you're going to use map-reduce properties you must use JobConf instead of vanilla Configuration when setting the properties.\n\nThoughts?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjlee0","name":"sjlee0","key":"sjlee0","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sjlee0&avatarId=16831","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sjlee0&avatarId=16831","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sjlee0&avatarId=16831","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sjlee0&avatarId=16831"},"displayName":"Sangjin Lee","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-09-23T20:17:05.635+0000","updated":"2013-09-23T20:17:05.635+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-9854/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1n3zz:"}}