{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13026272","self":"https://issues.apache.org/jira/rest/api/2/issue/13026272","key":"HADOOP-13870","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/10004","id":"10004","description":"Not A Bug","name":"Not A Bug"},"customfield_12312322":null,"customfield_12310220":"2017-01-19T06:59:14.909+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jan 19 07:00:24 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_18686421880_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-07-11T14:29:41.213+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-13870/watchers","watchCount":5,"isWatching":false},"created":"2016-12-07T07:49:19.380+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-07-11T14:29:41.254+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310689","id":"12310689","name":"fs","description":"Generic FileSystem code"}],"timeoriginalestimate":null,"description":"This may be an incorrect assumption on my part, but it was my belief that overriding the create method on a FilterFileSystem was sufficient to intercept all calls that would write data through the FileSystem. This is apparently not true because calling copyFromLocalFile on the FilterFileSystem eventually invokes the create method on the wrapped FileSystem. I would expect open -> create -> copy(opened, created) to be functionally equivalent to copyFromLocal when using the same input and output paths, but this is not the case.\n\n{code:java}\nimport java.io.IOException;\nimport java.net.URI;\nimport java.nio.charset.StandardCharsets;\nimport org.apache.commons.io.IOUtils;\nimport org.apache.hadoop.conf.Configuration;\nimport org.apache.hadoop.fs.FSDataInputStream;\nimport org.apache.hadoop.fs.FSDataOutputStream;\nimport org.apache.hadoop.fs.FileSystem;\nimport org.apache.hadoop.fs.FilterFileSystem;\nimport org.apache.hadoop.fs.Path;\nimport org.apache.hadoop.fs.permission.FsPermission;\nimport org.apache.hadoop.util.Progressable;\nimport org.junit.Before;\nimport org.junit.Test;\n\npublic final class CopyFromLocalFileTest {\n\n    private static final Path DATA_PATH = new Path(\"file:///tmp/test_in\");\n    private static final Path OUT_PATH = new Path(\"file:///tmp/test_out\");\n\n    private FileSystem localFs;\n    private FileSystem wrappedFs;\n\n    @Before\n    public void before() throws IOException {\n        localFs = FileSystem.get(URI.create(\"file:///\"), new Configuration());\n        wrappedFs = new FailingFileSystem(localFs);\n\n        FSDataOutputStream tmpFile = localFs.create(DATA_PATH);\n        byte[] bytes = \"data\".getBytes(StandardCharsets.UTF_8);\n        tmpFile.write(bytes);\n        tmpFile.close();\n    }\n\n    @Test\n    public void test_correct() throws IOException {\n        FSDataInputStream in = wrappedFs.open(DATA_PATH);\n        FSDataOutputStream out = wrappedFs.create(OUT_PATH); // this call fails\n        IOUtils.copy(in, out);\n    }\n\n    @Test\n    public void test_incorrect() throws IOException {\n        wrappedFs.copyFromLocalFile(DATA_PATH, OUT_PATH); // this call does not fail\n    }\n\n    private static final class FailingFileSystem extends FilterFileSystem {\n\n        public FailingFileSystem(FileSystem fs) {\n            super(fs);\n        }\n\n        @Override\n        public FSDataOutputStream create(Path f, FsPermission permission, boolean overwrite, int bufferSize,\n                short replication, long blockSize, Progressable progress) throws IOException {\n            throw new IOException(\"fail\");\n        }\n\n    }\n}\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Incorrect behavior of copyFromLocalFile on implementations of FilterFileSystem","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jellis","name":"jellis","key":"jellis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Ellis","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jellis","name":"jellis","key":"jellis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Ellis","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13026272/comment/15829422","id":"15829422","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manju_hadoop","name":"manju_hadoop","key":"manju_hadoop","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjunath Anand","active":true,"timeZone":"Asia/Kolkata"},"body":"Sorry for looking late into this.\n\nThis is not an issue and it works as expected. The reason why test_incorrect doesnt fail is that the copyFromLocalFile call done internally calls the create method of ChecksumFileSystem which overrides the create method implemented in the FilterFileSystem.\n\nWhereas the wrappedFs.create(OUT_PATH) in the test_correct fails because its a direct call made to FilterFileSystem and not to the LocalFileSystem which extends the ChecksumFileSystem. \n\nIf the FailingFileSystem is made to extend the LocalFileSystem instead of FilterFileSystem then you will see both methods failing.\n\nThe below stacktrace says it all:-\n\n{code}\n\njava.lang.Thread.State: RUNNABLE\n\t  at org.apache.hadoop.fs.ChecksumFileSystem.create(ChecksumFileSystem.java:464)\n\t  at org.apache.hadoop.fs.ChecksumFileSystem.create(ChecksumFileSystem.java:443)\n\t  at org.apache.hadoop.fs.FileSystem.create(FileSystem.java:1073)\n\t  at org.apache.hadoop.fs.FileSystem.create(FileSystem.java:1053)\n\t  at org.apache.hadoop.fs.FileSystem.create(FileSystem.java:942)\n\t  at org.apache.hadoop.fs.FileUtil.copy(FileUtil.java:391)\n\t  at org.apache.hadoop.fs.FileUtil.copy(FileUtil.java:364)\n\t  at org.apache.hadoop.fs.FileUtil.copy(FileUtil.java:314)\n\t  at org.apache.hadoop.fs.LocalFileSystem.copyFromLocalFile(LocalFileSystem.java:82)\n\t  at org.apache.hadoop.fs.FilterFileSystem.copyFromLocalFile(FilterFileSystem.java:332)\n\t  at org.apache.hadoop.fs.FileSystem.copyFromLocalFile(FileSystem.java:2241)\n\t  at org.apache.hadoop.util.CopyFromLocalFileTest.test_incorrect(CopyFromLocalFileTest.java:48)\n\njava.lang.Thread.State: RUNNABLE\n\t  at org.apache.hadoop.util.CopyFromLocalFileTest$FailingFileSystem.create(CopyFromLocalFileTest.java:60)\n\t  at org.apache.hadoop.fs.FileSystem.create(FileSystem.java:1073)\n\t  at org.apache.hadoop.fs.FileSystem.create(FileSystem.java:1053)\n\t  at org.apache.hadoop.fs.FileSystem.create(FileSystem.java:942)\n\t  at org.apache.hadoop.fs.FileSystem.create(FileSystem.java:930)\n\t  at org.apache.hadoop.util.CopyFromLocalFileTest.test_correct(CopyFromLocalFileTest.java:42)\n\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manju_hadoop","name":"manju_hadoop","key":"manju_hadoop","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjunath Anand","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-01-19T06:59:14.909+0000","updated":"2017-01-19T06:59:14.909+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13026272/comment/15829424","id":"15829424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manju_hadoop","name":"manju_hadoop","key":"manju_hadoop","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjunath Anand","active":true,"timeZone":"Asia/Kolkata"},"body":"Can anyone please grant me contributor access so that I can mark this as \"Not An Issue\" .","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manju_hadoop","name":"manju_hadoop","key":"manju_hadoop","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manjunath Anand","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-01-19T07:00:24.578+0000","updated":"2017-01-19T07:00:24.578+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-13870/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i37a2n:"}}