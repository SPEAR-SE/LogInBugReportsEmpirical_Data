{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12376650","self":"https://issues.apache.org/jira/rest/api/2/issue/12376650","key":"HADOOP-1765","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312565","id":"12312565","description":"","name":"0.15.0","archived":false,"released":true,"releaseDate":"2007-10-19"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2007-08-23T18:47:07.854+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Aug 24 06:21:18 UTC 2007","customfield_12310420":"125392","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_110363692_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_1091928632","customfield_12312321":null,"resolutiondate":"2007-08-24T06:21:18.290+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-1765/watchers","watchCount":0,"isWatching":false},"created":"2007-08-22T23:41:54.598+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12317306","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12317306","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"inwardIssue":{"id":"12375814","key":"HADOOP-1708","self":"https://issues.apache.org/jira/rest/api/2/issue/12375814","fields":{"summary":"make files visible in the namespace as soon as they are created","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-07-08T16:41:46.713+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"On occasion I get an IOE trying to close a MapFile I've just opened and filled.  Below is the content of the namenode log.  The first thing in it after startup messages is the IOE followed by other messages about '...current leaseholder is trying to recreate file'.  It repeats for ever.  This is TRUNK r567876.\n\nI filed this issue at Raghu's suggestion.  Here's what he said on the list:\n\n.bq Yes, the earler message was also from Namenode log. Before that line there should have been a message that adds a block to this file in the same log. I think you should file a Jira for this. It probably related to HADOOP-999. Raghu. \n\n{code}\n2007-08-22 21:38:49,071 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/208.76.44.139:50010\n2007-08-22 21:43:50,216 INFO org.apache.hadoop.fs.FSNamesystem: Roll Edit Log from 208.76.44.139\n2007-08-22 21:45:21,459 INFO org.apache.hadoop.ipc.Server: IPC Server handler 1 on 9000, call complete(/bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,,8918388410463499185/repo/mapfiles/-1/data, DFSClient_1857293290) from 208.76.44.139:52301: error: java.io.IOException: Unknown file: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,,8918388410463499185/repo/mapfiles/-1/data\njava.io.IOException: Unknown file: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,,8918388410463499185/repo/mapfiles/-1/data\n    at org.apache.hadoop.dfs.FSDirectory.addBlocks(FSDirectory.java:561)\n    at org.apache.hadoop.dfs.FSNamesystem.completeFileInternal(FSNamesystem.java:1002)\n    at org.apache.hadoop.dfs.FSNamesystem.completeFile(FSNamesystem.java:952)\n    at org.apache.hadoop.dfs.NameNode.complete(NameNode.java:348)\n    at sun.reflect.GeneratedMethodAccessor10.invoke(Unknown Source)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    at java.lang.reflect.Method.invoke(Method.java:597)\n    at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:340)\n    at org.apache.hadoop.ipc.Server$Handler.run(Server.java:566)\n2007-08-22 21:45:24,394 WARN org.apache.hadoop.dfs.StateChange: DIR* NameSystem.startFile: failed to create file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,,8918388410463499185/repo/mapfiles/-1/data for DFSClient_1857293290 on client 208.76.44.139 because current leaseholder is trying to recreate file.\n2007-08-22 21:45:24,394 INFO org.apache.hadoop.ipc.Server: IPC Server handler 1 on 9000, call create(/bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,,8918388410463499185/repo/mapfiles/-1/data, DFSClient_1857293290, true, 3, 67108864) from 208.76.44.139:52312: error: org.apache.hadoop.dfs.AlreadyBeingCreatedException: failed to create file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,,8918388410463499185/repo/mapfiles/-1/data for DFSClient_1857293290 on client 208.76.44.139 because current leaseholder is trying to recreate file.\norg.apache.hadoop.dfs.AlreadyBeingCreatedException: failed to create file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,,8918388410463499185/repo/mapfiles/-1/data for DFSClient_1857293290 on client 208.76.44.139 because current leaseholder is trying to recreate file.\n    at org.apache.hadoop.dfs.FSNamesystem.startFile(FSNamesystem.java:740)\n    at org.apache.hadoop.dfs.NameNode.create(NameNode.java:307)\n    at sun.reflect.GeneratedMethodAccessor7.invoke(Unknown Source)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    at java.lang.reflect.Method.invoke(Method.java:597)\n    at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:340)\n    at org.apache.hadoop.ipc.Server$Handler.run(Server.java:566)\n{code}\n\nLet me try and replicate with DEBUG level enabled.  Also, I think I know how to easily replicate.   Need to do some tests.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12364373","id":"12364373","filename":"namenode-excerpt.log.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-23T00:01:00.201+0000","size":25538,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12364373/namenode-excerpt.log.gz"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"106040","customfield_12312823":null,"summary":"IOException on close: Unknown file","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376650/comment/12521973","id":"12521973","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"body":"This is namenode log excerpt at DEBUG level.  To find the problematic file, search for the string 8020883803428152097 (or for the IOException).\n\nThe creation scenario that seems to be bringing on the failure is as follows:\n\n{code}\nCreate file named X\nFill it\nClose it.\nRename it as file named Y\nCreate new file named X\nFill it\nTry to close it <-- IOException\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-23T00:01:01.980+0000","updated":"2007-08-23T00:01:01.980+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376650/comment/12521976","id":"12521976","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"body":"The following does not provoke the exception:\n{code}\n    Configuration c = new Configuration();\n    FileSystem fs = FileSystem.get(c);\n    Text t = new Text(\"x\");\n    Path src = new Path(\"/tmp/x\");\n    Path tgt = new Path(\"/tmp/y\");\n    fs.mkdirs(src);\n    MapFile.Writer writer =\n      new MapFile.Writer(c, fs, src.toString(), Text.class, Text.class);\n    writer.append(t, t);\n    writer.close();\n    if (!fs.rename(src, tgt)) {\n      throw new IOException(\"Rename failed\");\n    }\n    writer =\n      new MapFile.Writer(c, fs, src.toString(), Text.class, Text.class);\n    writer.append(t, t);\n    writer.close();\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-23T00:14:58.045+0000","updated":"2007-08-23T00:14:58.045+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376650/comment/12521984","id":"12521984","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"body":"On retest, it does not look like reuse of a filename following a rename has anything to do with the failure.  The attached debug log includes an IOE w/o an intermediate rename.\n\nWorkarounds or suggestions appreciated (I get this doing large uploads into hbase).  Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-23T00:36:21.632+0000","updated":"2007-08-23T00:36:21.632+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376650/comment/12521985","id":"12521985","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"body":"Here are all logs related to failing file pulled from attached DEBUG log:\n\n{code}\n2007-08-22 23:48:59,515 DEBUG org.apache.hadoop.dfs.StateChange: *DIR* NameNode.create: file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data for DFSClient_-2109891694 at 208.76.44.140\n2007-08-22 23:48:59,515 DEBUG org.apache.hadoop.dfs.StateChange: DIR* NameSystem.startFile: file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data for DFSClient_-2109891694 at 208.76.44.1402007-08-22 23:48:59,515 DEBUG org.apache.hadoop.dfs.StateChange: DIR* NameSystem.startFile: add /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data to pendingCreates for DFSClient_-2109891694\n2007-08-22 23:48:59,515 DEBUG org.apache.hadoop.dfs.StateChange: DIR* FSDirectory.addFile: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data with 0 blocks is added to the file system\n2007-08-22 23:49:00,811 DEBUG org.apache.hadoop.dfs.StateChange: *BLOCK* NameNode.addBlock: file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data for DFSClient_-2109891694\n2007-08-22 23:49:00,811 DEBUG org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.getAdditionalBlock: file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data for DFSClient_-2109891694\n2007-08-22 23:49:00,812 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.allocateBlock: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data. blk_-7962476260520498222 is created and added to pendingCreates and pendingCreateBlocks\n2007-08-22 23:49:03,352 DEBUG org.apache.hadoop.dfs.StateChange: *DIR* NameNode.complete: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data for DFSClient_-21098916942007-08-22 23:49:03,352 DEBUG org.apache.hadoop.dfs.StateChange: DIR* NameSystem.completeFile: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data for DFSClient_-2109891694\n2007-08-22 23:49:03,354 INFO org.apache.hadoop.ipc.Server: IPC Server handler 5 on 9000, call complete(/bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data, DFSClient_-2109891694) from 208.76.44.140:56731: error: java.io.IOException: Unknown file: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,F2pGuwUpH4RWZY5e1ZqKjF==,8020883803428152097/repo/mapfiles/-1/data\n{code}\n\nLooks like a block is added to a file known by the filesystem, then another, but then on 'complete', IOE.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-23T00:45:15.936+0000","updated":"2007-08-23T00:45:15.936+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376650/comment/12522223","id":"12522223","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the detailed report. This looks something we need to investigate and fix soon. I am not sure of a workaround yet.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-23T18:47:07.854+0000","updated":"2007-08-23T18:47:07.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376650/comment/12522227","id":"12522227","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Raghu.  I upped priority from minor to major since this issue results in data loss.  What strikes me as odd is that the FSDirectory.addFile log happens at the end of the addBlocks method.  At the head of this method it does the lookup of the associated node and succeeds.  When the same addBlocks method is called out of the completeFile as part of the close, it fails to find the node.\n\nHere is another example of the failure done with an update to TRUNK -- turns out the above log maybe a week or more old -- and a newly formatted filesystem:\n{code}\n2007-08-23 16:16:22,647 DEBUG org.apache.hadoop.dfs.StateChange: *DIR* NameNode.create: file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data for DFSClient_1851346025 at 208.76.44.142\n2007-08-23 16:16:22,648 DEBUG org.apache.hadoop.dfs.StateChange: DIR* NameSystem.startFile: file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data for DFSClient_1851346025 at 208.76.44.142\n2007-08-23 16:16:22,648 DEBUG org.apache.hadoop.dfs.StateChange: DIR* NameSystem.startFile: add /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data to pendingCreates for DFSClient_1851346025\n2007-08-23 16:16:22,653 DEBUG org.apache.hadoop.dfs.StateChange: DIR* FSDirectory.addFile: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data with 0 blocks is added to the file system\n2007-08-23 16:16:24,254 DEBUG org.apache.hadoop.dfs.StateChange: *BLOCK* NameNode.addBlock: file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data for DFSClient_1851346025\n2007-08-23 16:16:24,255 DEBUG org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.getAdditionalBlock: file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data for DFSClient_1851346025\n2007-08-23 16:16:24,255 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.allocateBlock: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data. blk_-7923302926655854738 is created and added to pendingCreates and pendingCreateBlocks\n2007-08-23 16:16:29,002 DEBUG org.apache.hadoop.dfs.StateChange: *DIR* NameNode.complete: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data for DFSClient_1851346025\n2007-08-23 16:16:29,984 DEBUG org.apache.hadoop.dfs.StateChange: DIR* NameSystem.completeFile: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data for DFSClient_1851346025\n2007-08-23 16:16:29,986 INFO org.apache.hadoop.ipc.Server: IPC Server handler 1 on 9000, call complete(/bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data, DFSClient_1851346025) from 208.76.44.142:36252: error: java.io.IOException: Unknown file: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data\njava.io.IOException: Unknown file: /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data2007-08-23 16:16:37,428 DEBUG org.apache.hadoop.dfs.StateChange: *DIR* NameNode.create: file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data for DFSClient_1851346025 at 208.76.44.142\n2007-08-23 16:16:37,428 DEBUG org.apache.hadoop.dfs.StateChange: DIR* NameSystem.startFile: file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data for DFSClient_1851346025 at 208.76.44.1422007-08-23 16:16:37,428 WARN org.apache.hadoop.dfs.StateChange: DIR* NameSystem.startFile: failed to create file /bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/hregion_hbaserepository,UwSTZDqGkjRNQIYAPaNXRV==,5123329232858704969/repo/mapfiles/-1/data for DFSClient_1851346025 on client 208.76.44.142 because current leaseholder is trying to recreate file.\n{code}\n\nOnly lines related to the failing file are listed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-23T19:04:47.058+0000","updated":"2007-08-23T19:04:47.058+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376650/comment/12522234","id":"12522234","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"body":"> What strikes me as odd is that the FSDirectory.addFile log happens at the end of the addBlocks method.\n> At the head of this method it does the lookup of the associated node and succeeds. When the same addBlocks \n> method is called out of the completeFile as part of the close, it fails to find the node.\n\naddBlocks() is called only once inside completeFile(). addBlock() (no 's') does not look up the file in global directory. \nIt just looks up the name in 'pendingCreates'.\n\nI wish jira could could limit of width of regular formatted text instead of extending it as far as lines under { noformat } go..","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-23T19:21:42.917+0000","updated":"2007-08-23T19:21:42.917+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376650/comment/12522249","id":"12522249","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"body":"Probably related to HADOOP-1708.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-23T19:54:03.905+0000","updated":"2007-08-23T19:54:03.905+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376650/comment/12522288","id":"12522288","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"body":"In the log file you have attached, {{/bfd/hadoop-stack-data/tmp/hbase/compaction.tmp/}}\n is deleted after a file under it is created but before the file closed. \nBefore HADOOP-1708, close() would just recreate the required parent directories.\nThis explains the exception. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-23T22:14:14.284+0000","updated":"2007-08-23T22:14:14.284+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376650/comment/12522388","id":"12522388","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the observation Raghu.  I addressed the fact that another thread could remove the parent directory.  This gets me over the fact that close sometimes failed (It took some time verifying this).  I'll resolve this issue since the real action is happening over in HADOOP-1708 (and you've added a pointer here from HADOOP-1708 as an illustration of issues w/ currently applied patch).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stack","name":"stack","key":"stack","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"stack","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-24T06:21:18.224+0000","updated":"2007-08-24T06:21:18.224+0000"}],"maxResults":10,"total":10,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-1765/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ii6n:"}}