{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12974913","self":"https://issues.apache.org/jira/rest/api/2/issue/12974913","key":"HADOOP-13230","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-06-01T21:30:15.556+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jul 24 21:23:54 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-13230/watchers","watchCount":10,"isWatching":false},"created":"2016-06-01T19:37:06.865+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334219","id":"12334219","description":"2.9.0 release","name":"2.9.0","archived":false,"released":true,"releaseDate":"2017-11-17"}],"issuelinks":[{"id":"12511493","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12511493","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13054174","key":"IMPALA-3558","self":"https://issues.apache.org/jira/rest/api/2/issue/13054174","fields":{"summary":"DROP TABLE PURGE on S3A table may not delete externally written files","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12499796","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12499796","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13060181","key":"HADOOP-14255","self":"https://issues.apache.org/jira/rest/api/2/issue/13060181","fields":{"summary":"S3A to delete unnecessary fake directory objects in mkdirs()","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-07-24T21:23:54.481+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311814","id":"12311814","name":"fs/s3","description":"S3A filesystem client and other S3 connectivity issues"}],"timeoriginalestimate":null,"description":"Users of s3a may not realize that, in some cases, it does not interoperate well with other s3 tools, such as the AWS CLI.  (See HIVE-13778, IMPALA-3558).\n\nSpecifically, if a user:\n\n- Creates an empty directory with hadoop fs -mkdir s3a://bucket/path\n- Copies data into that directory via another tool, i.e. aws cli.\n- Tries to access the data in that directory with any Hadoop software.\n\nThen the last step fails because the fake empty directory blob that s3a wrote in the first step, causes s3a (listStatus() etc.) to continue to treat that directory as empty, even though the second step was supposed to populate the directory with data.\n\nI wanted to document this fact for users. We may mark this as not-fix, \"by design\".. May also be interesting to brainstorm solutions and/or a config option to change the behavior if folks care.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"s3a's use of fake empty directory blobs does not interoperate with other s3 tools","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabbri","name":"fabbri","key":"fabbri","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fabbri&avatarId=24131","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fabbri&avatarId=24131","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fabbri&avatarId=24131","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fabbri&avatarId=24131"},"displayName":"Aaron Fabbri","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabbri","name":"fabbri","key":"fabbri","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fabbri&avatarId=24131","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fabbri&avatarId=24131","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fabbri&avatarId=24131","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fabbri&avatarId=24131"},"displayName":"Aaron Fabbri","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":"https://issues.cloudera.org/browse/IMPALA-3558","environment":null,"customfield_12313520":null,"customfield_12311020":"https://issues.cloudera.org/browse/IMPALA-3558","duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12974913/comment/15311154","id":"15311154","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"# Have you tested this against branch-2 yet? HADOOP-11694 covers changes there\n# This should be testable: you'll need to bypass the s3a code after a mkdir and PUT up a file; listing the dir probably won't find the path.\n\nI don't see us changing the policy of creating those empty paths, it's how we emulate empty dirs, and there is a core assumption in the Hadoop FS APIs, after a call to fs.mkdirs(path), then exists(path). Holds\n\n\nBut, \n\n* HADOOP-13208 proposes making listFiles(recursive) do a bulk list call; that would bypass the directory walk. We'll take a patch there, with tests,\n* We sort of do that in rename already. Does playing with that make any difference? Maybe rename() is copying the empty/ dir entries too, even though there are children, so propagating the problem. Again, we'll take a patch there.\n\nFinally, there is always the possibility of bypassing that HEAD for the empty dir and going straight to a listing. \n# That listing will need to recognise the diff between an empty dir entry and the children\n# you have to consider that the cost of list operation is >> than a HEAD, due to the need to parse the XML response. That means it may get bounced for cost reasons. On the other hand, if you can can show that overall, on a populated directory path, things come out lower (and we are now counting individual operations for you to add those measurements to your tests), then they will get in.\n\nNote that any patches against S3 will need to be tested by you before anyone will look at them:\n\nhttps://wiki.apache.org/hadoop/HowToContribute#Submitting_patches_against_object_stores_such_as_Amazon_S3.2C_OpenStack_Swift_and_Microsoft_Azure\n\nThat's a policy which we ourselves have to abide by.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2016-06-01T21:30:15.556+0000","updated":"2016-06-01T21:30:15.556+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12974913/comment/15312025","id":"15312025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"-actually, a {{touch}} into the dest dir should be sufficient to trigger a cleanup, at least until some optimisations go in.\n\nWhat may be viable here is actually to add some specific cleanup entry point/command to hadoop-aws, which cleans a bucket out of spurious false empty directories. After something starts mixing s3a and raw aws cli calls, this could be used to purge fake directories up the tree","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2016-06-02T09:35:09.075+0000","updated":"2016-06-02T09:35:09.075+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12974913/comment/15312509","id":"15312509","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cnauroth","name":"cnauroth","key":"cnauroth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cnauroth&avatarId=11432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cnauroth&avatarId=11432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cnauroth&avatarId=11432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cnauroth&avatarId=11432"},"displayName":"Chris Nauroth","active":true,"timeZone":"America/Los_Angeles"},"body":"I think something has been lost in the conversation on this issue so far: the original bug reports involved an unexpected interaction with delete, not listStatus.  If you click through to the linked Hive and Cloudera JIRAs, then you'll see the sequence of events is more like:\n\n# mkdir\n# Use AWS CLI to load files into the directory externally.\n# delete directory\n# Now, the data loaded externally via AWS CLI is still there despite the delete.\n\nThis is because the logic of {{S3AFileSystem#delete}} detects the empty fake directory and issues only a single object delete for that fake directory:\n\n{code}\n      if (status.isEmptyDirectory()) {\n        LOG.debug(\"Deleting fake empty directory {}\", key);\n        s3.deleteObject(bucket, key);\n        instrumentation.directoryDeleted();\n        statistics.incrementWriteOps(1);\n{code}\n\nI expect the logic of {{listStatus}} is actually fine, though I haven't tested integration with AWS CLI yet.  I don't see any special case logic for empty fake directories in {{listStatus}}.  From what I can tell, it will always try the S3 listing, so files won't go missing.\n\nBased on that, perhaps what we need here is a code change in {{delete}} to scan a listing and delete all children even if the base object looks like a fake empty directory.  This is extra S3 calls, so there is a potential performance impact.  In the common case where it really is a fake empty directory and no files were loaded externally, it's one extra listing call, and the results will be empty, so hopefully that's not too much of a hit on the XML parsing.  If we want to be conservative, then we could introduce a boolean configuration property like {{fs.s3a.external.bucket.access}}.  It could default to {{false}}, and users who want to opt in to external integration can flip it to {{true}}.  When it's {{false}}, we have opportunities for optimization, such as sticking with the existing {{delete}} logic of trusting the fake empty directory object and skipping the full scan.\n\nI have looked only at delete, not a comprehensive review of all APIs, so maybe there are similar problems with external integration lurking there.  If we find additional similar situations, where there is a trade-off between enabling external integration and getting optimal performance, then the same {{fs.s3a.external.bucket.access}} property might be applicable there too.\n\nWhat are your thoughts on this approach?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cnauroth","name":"cnauroth","key":"cnauroth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cnauroth&avatarId=11432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cnauroth&avatarId=11432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cnauroth&avatarId=11432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cnauroth&avatarId=11432"},"displayName":"Chris Nauroth","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-06-02T15:45:36.711+0000","updated":"2016-06-02T15:45:36.711+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12974913/comment/15312608","id":"15312608","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"I know this surfaced in a delete, but suspected it would surface elsewhere; anything which bailed out early on an empty directory.\n\nwe'd effectively skip that special case for empty directories ...it'd need to list all child entries, just as a normal delete would do...it'd also have to delete the fake dir.\n\nThis would be more expensive than before, as for a \"real\" empty dir, there'll be one extra list call, then the existing delete operation issued.\n\nI don't see it adding any costs to non-empty directories though.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2016-06-02T16:34:36.937+0000","updated":"2016-06-02T16:34:36.937+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12974913/comment/16554808","id":"16554808","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steveatbat","name":"steveatbat","key":"steveatbat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Jacobs","active":true,"timeZone":"America/Denver"},"body":"Could this be implemented replacing the HEAD request for the fakedir entry with a listObjects call? That would be the same number of api calls in the 'empty fakeDir' case, but no more work in the populated directory case.\r\n\r\n \r\n\r\nRecently I ran into this issue using PRESTO to insert into hive partitions. Presto does not use the S3a driver, and does not delete the fakedir objects. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steveatbat","name":"steveatbat","key":"steveatbat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Jacobs","active":true,"timeZone":"America/Denver"},"created":"2018-07-24T21:23:54.481+0000","updated":"2018-07-24T21:23:54.481+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-13230/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2yuhz:"}}