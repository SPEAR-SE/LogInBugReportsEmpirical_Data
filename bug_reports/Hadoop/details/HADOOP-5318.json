{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12415446","self":"https://issues.apache.org/jira/rest/api/2/issue/12415446","key":"HADOOP-5318","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2009-02-24T14:13:43.315+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Sep 09 07:14:00 UTC 2009","customfield_12310420":"19173","customfield_12312320":null,"customfield_12310222":"10002_*:*_2_*:*_4199572571_*|*_1_*:*_3_*:*_12831113319_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-09-09T07:14:00.610+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-5318/watchers","watchCount":19,"isWatching":false},"created":"2009-02-24T04:29:14.720+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"9.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313211","id":"12313211","description":"","name":"0.19.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[{"id":"12376116","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12376116","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12671233","key":"HDFS-5276","self":"https://issues.apache.org/jira/rest/api/2/issue/12671233","fields":{"summary":"FileSystem.Statistics got performance issue on multi-thread read/write.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12325911","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12325911","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12431203","key":"HADOOP-6166","self":"https://issues.apache.org/jira/rest/api/2/issue/12431203","fields":{"summary":"Improve PureJavaCrc32","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12325880","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12325880","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12421657","key":"HADOOP-6148","self":"https://issues.apache.org/jira/rest/api/2/issue/12421657","fields":{"summary":"Implement a pure Java CRC32 calculator","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-09-30T07:49:21.785+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"The AtomicLong operations in counting file system statistics can cause high levels of contention with multiple threads. This test demonstrates having multiple threads writing to different sequence files:\n\n{code:java}\nimport java.io.IOException;\n\nimport org.apache.hadoop.conf.Configuration;\nimport org.apache.hadoop.fs.FileSystem;\nimport org.apache.hadoop.fs.Path;\nimport org.apache.hadoop.io.ByteWritable;\nimport org.apache.hadoop.io.SequenceFile;\nimport org.apache.hadoop.io.SequenceFile.Writer;\nimport org.apache.hadoop.io.SequenceFile.CompressionType;\n\n\npublic class Test {\n\tpublic static void main(String[] args) throws IOException {\n\t\tfinal Configuration c = new Configuration();\n\t\tfinal FileSystem fs = FileSystem.get(c);\n\t\t\n\t\tfinal int NUM = 1000*1000;\n\t\tfor (int i = 0; i < Integer.valueOf(args[0]); i ++) {\n\t\t\tfinal int ii = i;\n\t\t\tnew Thread(new Runnable() {\n\t\t\t\t@Override\n\t\t\t\tpublic void run() {\n\t\t\t\t\t\n\t\t\t\t\ttry {\n\t\t\t\t\t\tWriter f = SequenceFile.createWriter(fs, c, new Path(\"/test/\" + ii ), ByteWritable.class, ByteWritable.class, CompressionType.NONE);\n\t\t\t\t\t\tByteWritable v = new ByteWritable();\n\t\t\t\t\t\t\n\t\t\t\t\t\tlong time = System.currentTimeMillis();\n\t\t\t\t\t\tfor (int i = 0; i < NUM; i ++)\n\t\t\t\t\t\t\tf.append(v, v);\n\t\t\t\t\t\tf.close();\n\t\t\t\t\t\tlong end = System.currentTimeMillis();\n\t\t\t\t\t\t\n\t\t\t\t\t\tSystem.out.printf(\"%d opartions in %d msec. %f/second\\n\", NUM, end - time, (float)(1000 * NUM)/(end - time));\n\t\t\t\t\t\t\n\t\t\t\t\t} catch (Exception e) {\n\t\t\t\t\t\t// TODO Auto-generated catch block\n\t\t\t\t\t\te.printStackTrace();\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}).start();\n\t\t}\n\t}\n}\n{code}\n\nThe results of this benchmark are\n{code}\n==== 1 threads ====\n1000000 opartions in 1431 msec. 698812.000000/second\n==== 2 threads ====\n1000000 opartions in 3001 msec. 333222.250000/second\n1000000 opartions in 2985 msec. 335008.375000/second\n==== 3 threads ====\n1000000 opartions in 4923 msec. 203128.171875/second\n1000000 opartions in 4924 msec. 203086.921875/second\n1000000 opartions in 4981 msec. 200762.906250/second\n==== 4 threads ====\n1000000 opartions in 6716 msec. 148898.156250/second\n1000000 opartions in 7048 msec. 141884.218750/second\n1000000 opartions in 7342 msec. 136202.671875/second\n1000000 opartions in 7344 msec. 136165.578125/second\n==== 5 threads ====\n1000000 opartions in 10366 msec. 96469.226563/second\n1000000 opartions in 11085 msec. 90212.000000/second\n1000000 opartions in 11121 msec. 89919.968750/second\n1000000 opartions in 11464 msec. 87229.585938/second\n1000000 opartions in 11538 msec. 86670.132813/second\n==== 6 threads ====\n1000000 opartions in 16513 msec. 60558.347656/second\n1000000 opartions in 17704 msec. 56484.410156/second\n1000000 opartions in 18219 msec. 54887.753906/second\n1000000 opartions in 18550 msec. 53908.355469/second\n1000000 opartions in 18605 msec. 53748.992188/second\n1000000 opartions in 18663 msec. 53581.953125/second\n==== 7 threads ====\n1000000 opartions in 22207 msec. 45030.847656/second\n1000000 opartions in 23275 msec. 42964.554688/second\n1000000 opartions in 23484 msec. 42582.183594/second\n1000000 opartions in 24378 msec. 41020.593750/second\n1000000 opartions in 24425 msec. 40941.656250/second\n1000000 opartions in 24533 msec. 40761.421875/second\n1000000 opartions in 24645 msec. 40576.183594/second\n==== 8 threads ====\n1000000 opartions in 26375 msec. 37914.691406/second\n1000000 opartions in 26420 msec. 37850.113281/second\n1000000 opartions in 26532 msec. 37690.335938/second\n1000000 opartions in 26670 msec. 37495.312500/second\n1000000 opartions in 29772 msec. 33588.605469/second\n1000000 opartions in 29859 msec. 33490.738281/second\n1000000 opartions in 30098 msec. 33224.800781/second\n1000000 opartions in 30082 msec. 33242.468750/second\n{code}\n\nHowever, if I comment out the file system statistics increments, the benchmark improves to:\n\n{code}\n==== 1 threads ====\n1000000 opartions in 1194 msec. 837520.937500/second\n==== 2 threads ====\n1000000 opartions in 1433 msec. 697836.687500/second\n1000000 opartions in 1433 msec. 697836.687500/second\n==== 3 threads ====\n1000000 opartions in 1643 msec. 608642.750000/second\n1000000 opartions in 1643 msec. 608642.750000/second\n1000000 opartions in 1639 msec. 610128.125000/second\n==== 4 threads ====\n1000000 opartions in 1886 msec. 530222.687500/second\n1000000 opartions in 1886 msec. 530222.687500/second\n1000000 opartions in 1886 msec. 530222.687500/second\n1000000 opartions in 1899 msec. 526592.937500/second\n==== 5 threads ====\n1000000 opartions in 2065 msec. 484261.500000/second\n1000000 opartions in 2066 msec. 484027.093750/second\n1000000 opartions in 2067 msec. 483792.937500/second\n1000000 opartions in 2066 msec. 484027.093750/second\n1000000 opartions in 2066 msec. 484027.093750/second\n==== 6 threads ====\n1000000 opartions in 2151 msec. 464900.031250/second\n1000000 opartions in 2111 msec. 473709.156250/second\n1000000 opartions in 2153 msec. 464468.187500/second\n1000000 opartions in 2114 msec. 473036.906250/second\n1000000 opartions in 2113 msec. 473260.781250/second\n1000000 opartions in 2112 msec. 473484.843750/second\n==== 7 threads ====\n1000000 opartions in 2368 msec. 422297.312500/second\n1000000 opartions in 2334 msec. 428449.000000/second\n1000000 opartions in 2332 msec. 428816.468750/second\n1000000 opartions in 2330 msec. 429184.562500/second\n1000000 opartions in 2332 msec. 428816.468750/second\n1000000 opartions in 2375 msec. 421052.625000/second\n1000000 opartions in 2394 msec. 417710.937500/second\n==== 8 threads ====\n1000000 opartions in 2517 msec. 397298.375000/second\n1000000 opartions in 2538 msec. 394011.031250/second\n1000000 opartions in 2538 msec. 394011.031250/second\n1000000 opartions in 2538 msec. 394011.031250/second\n1000000 opartions in 2539 msec. 393855.843750/second\n1000000 opartions in 2614 msec. 382555.468750/second\n1000000 opartions in 2666 msec. 375093.781250/second\n1000000 opartions in 2701 msec. 370233.250000/second\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12400874","id":"12400874","filename":"buf.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-24T19:34:48.205+0000","size":5508,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12400874/buf.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12400867","id":"12400867","filename":"buffer-output.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-24T18:09:00.292+0000","size":876,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12400867/buffer-output.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12414463","id":"12414463","filename":"hadoop-5318.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-07-24T19:43:52.338+0000","size":2081,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12414463/hadoop-5318.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12405569","id":"12405569","filename":"hadoop-5318.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-15T20:30:11.715+0000","size":1936,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12405569/hadoop-5318.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12405372","id":"12405372","filename":"hadoop-5318.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-14T01:44:06.521+0000","size":1936,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12405372/hadoop-5318.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12414238","id":"12414238","filename":"Rplot001.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-07-22T19:30:22.825+0000","size":29812,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12414238/Rplot001.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12414239","id":"12414239","filename":"TestWriteConcurrency.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-07-22T19:30:22.861+0000","size":2582,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12414239/TestWriteConcurrency.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12410559","id":"12410559","filename":"TestWriteConcurrency.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-06-14T03:49:17.215+0000","size":2295,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12410559/TestWriteConcurrency.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12405373","id":"12405373","filename":"TestWriteConcurrency.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-14T01:44:06.541+0000","size":1810,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12405373/TestWriteConcurrency.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"103776","customfield_12312823":null,"summary":"Poor IO Performance due to AtomicLong operations","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"2x quad core xeon linux 64 bit","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12676287","id":"12676287","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_l","name":"steve_l","key":"steve_l","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Loughran","active":true,"timeZone":"Etc/UTC"},"body":"is this 64-bit java on 64-bit OS? If so, surprising -atomic long operations should be atomic at the x86 opcode level, with minimal contention","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steve_l","name":"steve_l","key":"steve_l","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Loughran","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-24T14:13:43.315+0000","updated":"2009-02-24T14:13:43.315+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12676342","id":"12676342","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"body":"Yes it is. Looking at the JDK source, they do CAS rather than an xadd instruction:\n\n    public final long getAndAdd(long delta) {\n        while (true) {\n            long current = get();\n            long next = current + delta;\n            if (compareAndSet(current, next))\n                return current;\n        }\n    }\n\nSo there can easily be contention if this is executed frequently.\n\nI think the best path here may be to make sure that buffering is pulled up a few layers of abstraction.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-24T17:28:50.056+0000","updated":"2009-02-24T17:28:50.056+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12676343","id":"12676343","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanduxbury","name":"bryanduxbury","key":"bryanduxbury","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Duxbury","active":true,"timeZone":"America/Los_Angeles"},"body":"I've noticed the FSStats stuff taking large amounts of CPU time in profiles of our mappers and reducers. I'm not sure why it sucks up so much cpu, but I'd definitely like to see a way to negate this effect.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanduxbury","name":"bryanduxbury","key":"bryanduxbury","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Duxbury","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-02-24T17:32:40.869+0000","updated":"2009-02-24T17:32:40.869+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12676349","id":"12676349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"body":"A quick hack to make the output path buffered -- it'd be nice to see if this helps some real world applications. The input side of this is a bit trickier, still working on it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-24T18:09:00.387+0000","updated":"2009-02-24T18:09:00.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12676374","id":"12676374","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"body":"Updated version of the patch. Handles the read and write path. Haven't benchmarked reads yet, but on writes we get the following improvements (1 byte key/values):\n\n||1 threads          || 4 threads || 8 threads ||\n| 21%                | 449%      | 1041% |","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-24T19:34:48.299+0000","updated":"2009-02-24T19:34:48.299+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12676756","id":"12676756","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cutting","name":"cutting","key":"cutting","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Cutting","active":true,"timeZone":"America/Los_Angeles"},"body":"Inserting a 256k output buffer in every FSDataOutputStream is probably not good.  Each FileSystem implementation internally buffers already.  Adding a big new buffer in front increases the memory used and also means that data is in memory longer before it is checksummed.  I also suspect even a 100b buffer would be enough, since, at the top-level, much i/o is byte-by-byte.  But adding a new small buffer would increase the times data is copied, which we should also avoid.\n\nSo I'd suggest that, rather than adding a buffer, PositionCache can just be lazy about reporting statistics.  We can add code like:\n\n{code}\nprivate static final int REPORT_INTERVAL = 1024;\nprivate int unreported;\n\nprivate void incrementBytesWritten(int bytesWritten) {\n  unreported += bytesWritten;\n  if (unreported > REPORT_INTERVAL)\n    reportBytesWritten();\n}\n\nprivate reportBytesWritten() {\n   statistics.incrementBytesWritten(unreported);\n   unreported = 0;\n}\n{code}\n\nThen call incrementBytesWritten() in the write() methods and add a call to reportBytesWritten() to close().\n\nDoes that make sense?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cutting","name":"cutting","key":"cutting","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Cutting","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-02-25T20:08:06.820+0000","updated":"2009-02-25T20:08:06.820+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12676780","id":"12676780","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"body":"When I benchmarked, I saw a performance gain from not going into the CRC routines, etc for each byte reported. Also, I did see some level of gains for using a larger IO buffer (though I haven't tested that fully).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-25T21:00:04.920+0000","updated":"2009-02-25T21:00:04.920+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12697982","id":"12697982","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"{quote}\nThen call incrementBytesWritten() in the write() methods and add a call to reportBytesWritten() to close().\n\nDoes that make sense?\n{quote}\n\n+1 - I like that approach rather than adding a buffer. If the buffer increases performance for CRC, etc, that should be a separate JIRA.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-10T21:19:38.583+0000","updated":"2009-04-10T21:19:38.583+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12698000","id":"12698000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"> So I'd suggest that, rather than adding a buffer, PositionCache can just be lazy about reporting statistics.\n\n+1. I agree.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-10T22:14:50.824+0000","updated":"2009-04-10T22:14:50.824+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12698614","id":"12698614","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Implemented the lazy reporting of bytes as Doug suggested.\n\nI didn't see any particular speedup, but I'm working on my dual-core laptop at the moment ;-) If someone could give this a try on a real box, might be worth it. Also will attach a test program","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-14T01:43:02.854+0000","updated":"2009-04-14T01:43:02.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12699062","id":"12699062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12405373/TestWriteConcurrency.java\n  against trunk revision 765025.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no tests are needed for this patch.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/196/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-15T05:25:19.198+0000","updated":"2009-04-15T05:25:19.198+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12699067","id":"12699067","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Looks like the Hadoop QA bot attempted to apply the .java file as a patch... not sure how to convince it to apply the patch file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-15T05:41:52.875+0000","updated":"2009-04-15T05:41:52.875+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12699192","id":"12699192","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"The hadoopqa patch proceses always picks the last attached file. In this case, this was the java file. Please re-attach the latest and greatest patch to this JIRA and then cancel and submit patch once again. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-15T13:39:06.798+0000","updated":"2009-04-15T13:39:06.798+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12699360","id":"12699360","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"reattaching patch for QA","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-15T20:30:11.753+0000","updated":"2009-04-15T20:30:11.753+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12699363","id":"12699363","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Dhruba: I don't appear to have permissions to twiddle the \"Patch Available\" state on this issue. Hopefully someone else can retrigger QA","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-15T20:33:41.659+0000","updated":"2009-04-15T20:33:41.659+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12699372","id":"12699372","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"Todd: I added you as \"contributors\". Please see if you are able to Cancel and then Submit the patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-15T20:45:25.926+0000","updated":"2009-04-15T20:45:25.926+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12699375","id":"12699375","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Yep, that worked. Thanks Dhruba","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-04-15T20:48:22.462+0000","updated":"2009-04-15T20:48:22.462+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12707000","id":"12707000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12405569/hadoop-5318.txt\n  against trunk revision 772482.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no tests are needed for this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 Eclipse classpath. The patch retains Eclipse classpath integrity.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/295/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/295/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/295/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/295/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-07T17:12:09.795+0000","updated":"2009-05-07T17:12:09.795+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12711740","id":"12711740","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"The test failure reported by Hudson is on the capacity scheduler contrib (unrelated)\n\nGiven that this is a performance-related patch, I'd like to hear back from Ben that the patch to be committed shows similar performance gains to the original patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-05-21T18:18:40.671+0000","updated":"2009-05-21T18:18:40.671+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12712491","id":"12712491","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"body":"When I tested stuff out, I got a boost from doing buffering that can't be replicated with just the grouping of atomic increments -- however, if we're just going to go with the simple version, this patch is as good as it gets.\n\nA similar patch is needed for input streams.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmaurer","name":"bmaurer","key":"bmaurer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben Maurer","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-24T03:39:24.678+0000","updated":"2009-05-24T03:39:24.678+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12715140","id":"12715140","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Ben: sorry, I wasn't clear from your last comment - did you try out the newest patch from this issue, or just commenting on what you saw on the original patch?\n\nIf you don't have a chance to try it, I can fire it up on an 8 core box somewhere and see what I get..","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-06-01T16:13:52.043+0000","updated":"2009-06-01T16:13:52.043+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12719220","id":"12719220","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"I just tried this patch on an EC2 c1.xlarge instance (8 cores) and couldn't reproduce the expected performance improvements. I updated the test program a bit to run 10 trials and run System.gc in between each (since the first couple trials seem to speed up due to JITting). I was writing into /dev/shm so actual IO performance shouldn't be a factor - just the contention on the statistics lock. I also changed the test program output format to be suitable for loading into R for analysis. Here's the t-test which fails to show a significant improvement (taking 20:80 to chop off the first 2 runs where JIT happened):\n\n{noformat}\n> d.0k <- read.table(file=\"0k.tsv\",header=T)\n> d.1k <- read.table(file=\"1k.tsv\",header=T)\n> t.test((d.1k$rate - d.0k$rate)[20:80])\n\n        One Sample t-test\n\ndata:  (d.1k$rate - d.0k$rate)[20:80] \nt = -0.6754, df = 60, p-value = 0.502\nalternative hypothesis: true mean is not equal to 0 \n95 percent confidence interval:\n -68205.16  33772.57 \nsample estimates:\nmean of x \n-17216.30 \n{noformat}\n\nThe p-value = 0.502 is pretty unconvincing.\n\nAny thoughts from the various parties who are seeing this contention in practice?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-06-14T03:47:28.770+0000","updated":"2009-06-14T03:47:28.770+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12719221","id":"12719221","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here's the updated test code that does more trials, gcs, etc","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-06-14T03:49:17.271+0000","updated":"2009-06-14T03:49:17.271+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12719222","id":"12719222","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Just tried two more situations with the test code. The first was to comment out all of the increments in PositionCache, and again saw no improvement. I also tried Ben's patch \"buf.patch\" as well with the same test code. The performance increase is quite pronounced:\n\n{noformat}\n> d.benm <- read.table(file=\"benm-patch.tsv\", header=T)\n> t.test(d.benm$rate - d.0k$rate)\n\n        One Sample t-test\n\ndata:  d.benm$rate - d.0k$rate \nt = 32.835, df = 79, p-value < 2.2e-16\nalternative hypothesis: true mean is not equal to 0 \n95 percent confidence interval:\n 2925074 3302593 \nsample estimates:\nmean of x \n  3113833 \n{noformat}\n\nSo, this JIRA should focus on figuring out how we can get that same benefit while addressing Doug's concerns above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-06-14T04:00:42.827+0000","updated":"2009-06-14T04:00:42.827+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12719238","id":"12719238","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"It seems like the real culprit here is HADOOP-5598. Switching to the pure java CRC32 makes the benchmark scale nearly linearly to 8 threads.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-06-14T08:28:02.314+0000","updated":"2009-06-14T08:28:02.314+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12734266","id":"12734266","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Attaching a benchmark and the resulting box plots. This benchmark writes 1M pairs of <ByteWritable, ByteWritable> into a SequenceFile with varying number of threads. The three series are:\n\ngreen: Before HADOOP-6148's improvement of CRC32\nred: With HADOOP-6148's CRC committed (as it is in trunk)\nblue: With HADOOP-6148's CRC plus hadoop-5318.txt from this JIRA\n\nThe results clearly show that the CRC implementation made the majority of the difference. Adding this patch seems to result in a very slight improvement. Here's the R script I used to generate the plot:\n\n{code}\nd.before.crc32 <- read.table(file=\"results_before_crc32.tsv\", header=F)\nd.before <- read.table(file=\"results_before.tsv\", header=F)\nd.after <- read.table(file=\"results_after.tsv\", header=F)\n\nlims <- c(1000000, 6400000)\nlog <- \"\" /* change to \"y\" to get log scale */\n\nboxplot(V2 ~ V1, d.before.crc32, col=\"green\", ylim=lims, at=(1:8)-0.4, log=log, boxwex=0.2)\nboxplot(V2 ~ V1, d.before, col=\"red\", ylim=lims, at=(1:8)-0.2,boxwex=0.2, log=log, add=T)\nboxplot(V2 ~ V1, d.after, col=\"blue\", ylim=lims, at=1:8+0.2,boxwex=0.2, log=log,  add=T)\nlegend(legend=c(\"before CRC32\", \"crc, no 5318\", \"5318+crc\"), fill=c(\"green\", \"red\", \"blue\"), x=\"topright\",col=\"black\")\n{code}\n\nRan the benchmarks on:\n\nJava(TM) SE Runtime Environment (build 1.6.0_14-b08)\nJava HotSpot(TM) 64-Bit Server VM (build 14.0-b16, mixed mode)\n\nMachine is a Nehalem box, dual quad core with hyperthreading (/proc/cpuinfo shows 16 CPUs: Intel(R) Xeon(R) CPU           X5570  @ 2.93GHz)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-07-22T19:30:22.866+0000","updated":"2009-07-22T19:30:22.866+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12734299","id":"12734299","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scott_carey","name":"scott_carey","key":"scott_carey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Carey","active":true,"timeZone":"America/Los_Angeles"},"body":"Since the CRC code reaches to near peak throughput (90%) at about 128 or 256  byte chunks, a small buffer may be beneficial.  Copying extra data is cheap for this size (2 to 4 cache lines -- the copy is in L1 cache), and extra delay before the CRC is also not very risky since its in L1 cache very briefly, not sitting off CPU in RAM.  On the other hand, if all clients are buffering by at least this size, it is irrelevant.  Writing tiny chunks however will impact throughput as the CRC per-call overhead adds up.\n\nSee HADOOP-6148 for CRC32 benchmark numbers.  Key breakpoints are about 128 to 256 byte chunk size for ~90% peak throughput, and 2k to 4k chunks where peak throughput is reached. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scott_carey","name":"scott_carey","key":"scott_carey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Carey","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-07-22T20:26:48.143+0000","updated":"2009-07-22T20:26:48.143+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12734321","id":"12734321","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Scott: I think if we add buffering it should be at the \"client\" level - eg in SequenceFileOutputStream or anywhere else that very small records will be written at a high rate. Doing so in the FSDataOutputStream seems heavy-handed, since we don't know what size the writes will usually be, and I'd imagine the usual is much larger than this pathological test case we used for the benchmark.\n\nI'm also not sure I see your point about the L1 cache - in between the small writes there may be arbitrary amounts of computation (eg in the mapper function) that would evict the buffer from cache.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-07-22T21:07:57.315+0000","updated":"2009-07-22T21:07:57.315+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12734340","id":"12734340","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scott_carey","name":"scott_carey","key":"scott_carey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Carey","active":true,"timeZone":"America/Los_Angeles"},"body":"This performance issue is largely (but not completely) fixed by HADOOP-6148, so I'm linking it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scott_carey","name":"scott_carey","key":"scott_carey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Carey","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-07-22T21:37:16.623+0000","updated":"2009-07-22T21:37:16.623+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12734688","id":"12734688","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"body":"HADOOP-6166 may help this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-07-23T18:31:05.538+0000","updated":"2009-07-23T18:31:05.538+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12735138","id":"12735138","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Given that we got the majority of speedup out of the CRC changes, I think we should resolve this ticket as wontfix. I just ran the same benchmark of trunk vs patched on my dual core laptop and the performance was essentially the same. On the Nehalem box it looked like there might have been a few percent speedup, but it seems not-worth-it for the added complexity.\n\nIf anyone disagrees (or has a benchmark to back up this patch), please speak up. I'll upload an updated patch against trunk so people can give it a try.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-07-24T19:43:29.867+0000","updated":"2009-07-24T19:43:29.867+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12735139","id":"12735139","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Patch against trunk common","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-07-24T19:43:52.383+0000","updated":"2009-07-24T19:43:52.383+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12415446/comment/12752957","id":"12752957","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Resolving as \"won't fix\" since the problem seems to have been solved by the recent CRC32 improvements.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2009-09-09T07:14:00.553+0000","updated":"2009-09-09T07:14:00.553+0000"}],"maxResults":33,"total":33,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-5318/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0i47j:"}}