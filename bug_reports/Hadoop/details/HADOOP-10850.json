{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12727654","self":"https://issues.apache.org/jira/rest/api/2/issue/12727654","key":"HADOOP-10850","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-07-29T16:29:42.656+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 30 04:44:51 UTC 2015","customfield_12310420":"405759","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-10850/watchers","watchCount":11,"isWatching":false},"created":"2014-07-16T13:25:14.053+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326695","id":"12326695","description":"2.4.1 bug-fix release","name":"2.4.1","archived":false,"released":true,"releaseDate":"2014-06-30"}],"issuelinks":[{"id":"12456886","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12456886","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12937984","key":"HADOOP-12787","self":"https://issues.apache.org/jira/rest/api/2/issue/12937984","fields":{"summary":"KMS SPNEGO sequence does not work with WEBHDFS","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-20T18:17:13.243+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312526","id":"12312526","name":"security"}],"timeoriginalestimate":null,"description":"As mentioned in HADOOP-10453, the JDK automatically does a SPNEGO handshake when opening a connection with a URL within a Kerberos login context, there is no need to do the SPNEGO handshake in the {{KerberosAuthenticator}}, simply extract the auth token (hadoop-auth cookie) and do the fallback if necessary.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12342324","id":"12342324","description":"3.2 release","name":"3.2.0","archived":false,"released":false}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12658520","id":"12658520","filename":"HADOOP-10850.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2014-07-29T23:18:18.142+0000","size":22460,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12658520/HADOOP-10850.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12658521","id":"12658521","filename":"testFailures.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2014-07-29T23:18:18.147+0000","size":235167,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12658521/testFailures.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12658666","id":"12658666","filename":"testorder.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2014-07-30T16:26:14.971+0000","size":4178,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12658666/testorder.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"405781","customfield_12312823":null,"summary":"KerberosAuthenticator should not do the SPNEGO handshake","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14066711","id":"14066711","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"body":"I've spent a good few hours looking into this.\n\nMaking {{KerberosAuthenticator}} to use JDK SPNEGO is straight forward, simply removing code. Still we want to continue using the {{AuthenticatedURL}} because it sets the hadoop-auth cookie which avoids triggering SPENGO every time (and failing with doing a PUT/POST with a payload).\n\nBut there is problem, (IMO) a nasty bug in the JDK SPNEGO implementation that makes it unusable in a reliable way.\n\nThe (Sun) JDK {{sun.net.www.protocol.http.HttpURLConnection}} class uses the {{NegotiateAuthentication}} class to keep track of hostnames that support SPNEGO. \n\nThe {{NegotiateAuthentication}} class uses a static {{HashMap<String, Boolean> supported}} where it keeps if a hostname supports SPNEGO or not.\n\nThe first time the JDK gets a {{WWW-Authenticate: NEGOTIATE}} for hostname it will try to obtain the Kerberos service ticket for {{HTTP/<hostname>}}.\n\nIf the service ticket is obtained, then the entry in the {{supported}} map will be {{(<hostname>,TRUE)}}, if the service ticket is not obtained the entry will be {{(<hostname>, FALSE)}}.\n\nThe {{supported}} map is never purged, this means a given hostname will be blacklisted for the lifetime of the JVM (the singleton is kept in the bootstrap classloader, so it affects the whole JVM).\n\nThe problem is that the service ticket may not be obtained for different reasons:\n\n* JVM client is not within  Kerberos login context\n* KDC is not available at the time of the call\n* {{HTTP/<hostname>}} principal does not exist at the time of the call\n\nAll these reasons can be 'transient'. If they ever happen before a successful attempt, the hostname is blacklisted for the lifetime of the JVM.\n\nWhen running testcases, depending on the order testcases run, they pass or the fail.\n\nIt is also reasonable to say these 'transient' errors can happen in production in a long running service (NN, Oozie).\n\nThe good thing is, and that is why {{AuthenticatedURL}}/{{KerberosAuthenticator}} works fine, is that the {{HttpURLConnection}} checks if the user code is doing SPNEGO handling and lets the user code handle it. And because {{KerberosAuthenticator}} does not blacklists hostnames, things work and recover if necessary.\n\nBased on these finding, I would close this JIRA and HADOO-10453 as invalid.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2014-07-18T18:39:02.900+0000","updated":"2014-07-28T16:03:05.720+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14076334","id":"14076334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"body":"[~daryn], [~atm], others, ping!\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2014-07-28T16:03:14.037+0000","updated":"2014-07-28T16:03:14.037+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14077932","id":"14077932","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Interesting.  Let me look into the jdk code too.  We had to remove AuthenticatedURL because it was causing all kinds of problems like replay attacks, retries when spnego failed for a completely valid reason, and fallbacks to the pseudo authenticator causing the same thing.\n\nSpeaking wrt to webhdfs, POST/PUT isn't a problem because the client explicitly does a \"two-step write\".  The redirect that actually does the POST/PUT to DN uses a token.  Kerberos isn't valid because the DN's DFSClient must have a token.  Webhdfs also specifically requests a token on the first call, and always uses it after that to avoid repeated spnego negotiations.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2014-07-29T16:29:42.656+0000","updated":"2014-07-29T16:29:42.656+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14077992","id":"14077992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"As best I can tell, the determining factor for whether spnego is not supported is if \"Negotiator.getNegotiator(hci)\" returns null.  I don't think a false blacklisting can occur.  A host is:\n# Whitelisted if an instance is instantiated\n# Blacklisted if class \"sun.net.www.protocol.http.spnego.NegotiatorImpl\" is not available, or a reflection error occurs instantiating an instance.\n# No-op for any non-reflection related exceptions.  Next attempt will try again until null or no exception.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2014-07-29T17:11:30.006+0000","updated":"2014-07-29T17:11:30.006+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14078017","id":"14078017","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"body":"I've was running the testcases with a KA leveraging JDK SPNEGO and testcases were failing when running all together and succeeding when running one at the time. Debugging I've run into the host being blacklisted. This happens because the NegotiatorImpl is being instantiated (in a negative testcase) without a kerberos context and that throws an exception that makes the host to be blacklisted (for the life of the JVM), then other tests (positive ones) fail.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2014-07-29T17:20:57.689+0000","updated":"2014-07-29T17:20:57.689+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14078295","id":"14078295","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Either {{Class.forName(\"xxx.NegotiatorImpl\")}} must throw {{ClassNotFoundException}}, or {{NegotiatorImpl.newInstance}} must throw {{ReflectiveOperationException}} in order to blacklist.  Which JDK version exhibited the behavior you are describing?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2014-07-29T20:22:40.692+0000","updated":"2014-07-29T20:22:40.692+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14078312","id":"14078312","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"body":"{{NegotiatorImpl}} constructor throws the exception calling its {{init()}} method if you are not within a Keberos login context:\n\n{code}\n    private void init(final String hostname, String scheme) throws GSSException {\n        // \"1.2.840.113554.1.2.2\" Kerberos\n        // \"1.3.6.1.5.5.2\" SPNEGO\n        final Oid oid;\n        \n        if (scheme.equalsIgnoreCase(\"Kerberos\")) {\n            // we can only use Kerberos mech when the scheme is kerberos\n            oid = GSSUtil.GSS_KRB5_MECH_OID;\n        } else {\n            String pref = (String)java.security.AccessController.doPrivileged( \n                    new java.security.PrivilegedAction() {\n                        public Object run() {\n                            return System.getProperty(\n                                \"http.auth.preference\",\n                                \"spnego\");\n                        }\n                    });\n            if (pref.equalsIgnoreCase(\"kerberos\")) {\n                oid = GSSUtil.GSS_KRB5_MECH_OID;\n            } else {\n                // currently there is no 3rd mech we can use\n                oid = GSSUtil.GSS_SPNEGO_MECH_OID;\n            }\n        }\n        \n        GSSManagerImpl manager = new GSSManagerImpl(\n                GSSUtil.CALLER_HTTP_NEGOTIATE);\n\n        String peerName = \"HTTP/\" + hostname;\n\n        GSSName serverName = manager.createName(peerName, null);\n        context = manager.createContext(serverName,\n                                        oid,\n                                        null,\n                                        GSSContext.DEFAULT_LIFETIME);\n        \n\tcontext.requestCredDeleg(true);\n        oneToken = context.initSecContext(new byte[0], 0, 0);\n    }\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2014-07-29T20:38:09.281+0000","updated":"2014-07-29T20:38:09.281+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14078501","id":"14078501","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"I think you are looking too deep.  Here's slightly condensed code for how the white/black list is populated.  Negotiator.getNegotiator must return null to blacklist.\n\nNegotiateAuthentication:\n{code}\n        Negotiator neg = Negotiator.getNegotiator(hci);\n        if (neg != null) {\n            supported.put(hostname, true);\n            cache.put(hostname, neg);\n            return true;\n        } else {\n            supported.put(hostname, false);\n            return false;\n        }\n{code}\n\nHere's the relevant part of Negotiator.getNegotiator.  Null (blacklist) is only returned for ClassNotFoundException or ReflectiveOperationException.  Otherwise an instance is returned (whitelist), or a different exception is thrown (no action).  The snippet of code you posted is invoked via the ctor called by c.newInstance.  Any exception will rip up the stack w/o updating the white/black list.\n{code}\n        try {\n            clazz = Class.forName(\"sun.net.www.protocol.http.spnego.NegotiatorImpl\", true, null);\n            c = clazz.getConstructor(HttpCallerInfo.class);\n        } catch (ClassNotFoundException cnfe) {\n            return null;\n        } catch (ReflectiveOperationException roe) {\n            throw new AssertionError(roe);\n        }\n\n        try {\n            return (Negotiator) (c.newInstance(hci));\n        } catch (ReflectiveOperationException roe) {\n            return null;\n        }\n{code}\n\nI don't doubt you saw an issue, but are you sure it's due to blacklisting?  If yes, did the test maybe tinker with class loaders?  Otherwise it would require a ReflectiveOperationException originating in the GSS code.\n\nMore likely you saw manifestations of bugs in {{AuthenticatedURL}} that caused me to remove it from webhdfs.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2014-07-29T22:23:41.168+0000","updated":"2014-07-29T22:23:41.168+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14078582","id":"14078582","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"body":"100% positive was due to blacklisting, I was debugging JDK classes. \n\nRun {{TestKerberosAuthenticator}}, if you run test by test, things work fine. If you run all tests together, depending on the order they run, they fail. See attached testFailures.png file (from my IDE run).\n\nAttached you have the patch I was using.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2014-07-29T23:18:18.154+0000","updated":"2014-07-29T23:18:18.154+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14079331","id":"14079331","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"The tests pass for me.  Which JDK are you using?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2014-07-30T14:52:31.059+0000","updated":"2014-07-30T14:52:31.059+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14079455","id":"14079455","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"body":"[~daryn], I believe the tests are passing for you because the order they are running. If the {{testNotAuthenticated()}} runs before the {{testAuthenticated()}}, then localhost will be blacklisted as not supported, if the run in the opposite order, then things work because localhost is not blacklisted.\n\nI'm attaching a patch with a new test {{TestX}} (based on the {{TestKerberosAuthenticator}} test) which demonstrates this, it has 2 methods: {{testOrderOk()}} and {{testOrderFailing()}}. these method simply invoke in diff order the original 2 testcases. \n\n*Using hadoop-auth client SPNEGO*:\n\nApply the {{testorder.patch}} patch on trunk and run  2 diff mvn test invocations, one running {{TestX#testOrderOk}} and the other running {{TestX#testOrderFailing}}:\n\n{code}\n$ mvn test -Dtest=TestX#testOrderOk\n\n$ mvn test -Dtest=TestX#testOrderFailing\n{code}\n \nBoth testcases run OK.\n\n*Using JDK client SPNEGO*:\n\nApply both, the {{testorder.patch}} and the HADOOP-10850.patch, patches on trunk and run  2 diff mvn test invocations, one running {{TestX#testOrderOk}} and the other running {{TestX#testOrderFailing}}:\n\n{code}\n$ mvn test -Dtest=TestX#testOrderOk\n\n$ mvn test -Dtest=TestX#testOrderFailing\n{code}\n \nNow one test fails.\n\nThis is using both Sun JDK6 and JDK7:\n\njava version \"1.7.0_51\"\nJava(TM) SE Runtime Environment (build 1.7.0_51-b13)\nJava HotSpot(TM) 64-Bit Server VM (build 24.51-b03, mixed mode)\n\njava version \"1.6.0_65\"\nJava(TM) SE Runtime Environment (build 1.6.0_65-b14-462-11M4609)\nJava HotSpot(TM) 64-Bit Server VM (build 20.65-b04-462, mixed mode)\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2014-07-30T16:26:14.980+0000","updated":"2014-07-30T16:26:14.980+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14114011","id":"14114011","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"body":"[~daryn], have you had a chance to think about this? Does seems reasonable to you to close it as invalid?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2014-08-28T17:33:38.419+0000","updated":"2014-08-28T17:33:38.419+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12727654/comment/14607162","id":"14607162","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinodkv","name":"vinodkv","key":"vinodkv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinod Kumar Vavilapalli","active":true,"timeZone":"America/Los_Angeles"},"body":"Moving bugs out of previously closed releases into the next minor release 2.8.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinodkv","name":"vinodkv","key":"vinodkv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinod Kumar Vavilapalli","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-30T04:44:51.515+0000","updated":"2015-06-30T04:44:51.515+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-10850/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1xtrj:"}}