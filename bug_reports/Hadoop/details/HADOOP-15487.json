{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13160858","self":"https://issues.apache.org/jira/rest/api/2/issue/13160858","key":"HADOOP-15487","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-05-22T02:51:42.926+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Aug 14 17:55:07 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15487/watchers","watchCount":8,"isWatching":false},"created":"2018-05-22T00:04:02.508+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12534693","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12534693","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13153941","key":"HADOOP-15401","self":"https://issues.apache.org/jira/rest/api/2/issue/13153941","fields":{"summary":"ConcurrentModificationException on Subject.getPrivateCredentials in UGI constructor","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-08-16T18:45:30.403+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312526","id":"12312526","name":"security"}],"timeoriginalestimate":null,"description":"We found the following exception message in a NameNode log. It seems the ConcurrentModificationException caused Kerberos authentication error.\r\n\r\nIt appears to be a JDK bug, similar to HADOOP-13433 (Race in UGI.reloginFromKeytab) but the version of Hadoop (CDH5.13.3) already patched HADOOP-13433. (The stacktrace also differs) This cluster runs on JDK 1.8.0_152.\r\n\r\n{noformat}\r\n2018-05-19 04:00:00,182 WARN org.apache.hadoop.security.UserGroupInformation: PriviledgedActionException as:hdfs/node1@EXAMPLE.COM (auth:KERBEROS) cause:javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]\r\n2018-05-19 04:00:00,183 INFO org.apache.hadoop.ipc.Server: Socket Reader #1 for port 8020: readAndProcess from client 10.16.20.122 threw exception [java.util.ConcurrentModificationException]\r\njava.util.ConcurrentModificationException\r\n        at java.util.LinkedList$ListItr.checkForComodification(LinkedList.java:966)\r\n        at java.util.LinkedList$ListItr.next(LinkedList.java:888)\r\n        at javax.security.auth.Subject$SecureSet$1.next(Subject.java:1070)\r\n        at javax.security.auth.Subject$ClassSet$1.run(Subject.java:1401)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at javax.security.auth.Subject$ClassSet.populateSet(Subject.java:1399)\r\n        at javax.security.auth.Subject$ClassSet.<init>(Subject.java:1372)\r\n        at javax.security.auth.Subject.getPrivateCredentials(Subject.java:767)\r\n        at sun.security.jgss.krb5.SubjectComber.findAux(SubjectComber.java:127)\r\n        at sun.security.jgss.krb5.SubjectComber.findMany(SubjectComber.java:69)\r\n        at sun.security.jgss.krb5.ServiceCreds.getInstance(ServiceCreds.java:96)\r\n        at sun.security.jgss.krb5.Krb5Util.getServiceCreds(Krb5Util.java:203)\r\n        at sun.security.jgss.krb5.Krb5AcceptCredential$1.run(Krb5AcceptCredential.java:74)\r\n        at sun.security.jgss.krb5.Krb5AcceptCredential$1.run(Krb5AcceptCredential.java:72)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at sun.security.jgss.krb5.Krb5AcceptCredential.getInstance(Krb5AcceptCredential.java:71)\r\n        at sun.security.jgss.krb5.Krb5MechFactory.getCredentialElement(Krb5MechFactory.java:127)\r\n        at sun.security.jgss.GSSManagerImpl.getCredentialElement(GSSManagerImpl.java:193)\r\n        at sun.security.jgss.GSSCredentialImpl.add(GSSCredentialImpl.java:427)\r\n        at sun.security.jgss.GSSCredentialImpl.<init>(GSSCredentialImpl.java:62)\r\n        at sun.security.jgss.GSSManagerImpl.createCredential(GSSManagerImpl.java:154)\r\n        at com.sun.security.sasl.gsskerb.GssKrb5Server.<init>(GssKrb5Server.java:108)\r\n        at com.sun.security.sasl.gsskerb.FactoryImpl.createSaslServer(FactoryImpl.java:85)\r\n        at org.apache.hadoop.security.SaslRpcServer$FastSaslServerFactory.createSaslServer(SaslRpcServer.java:398)\r\n        at org.apache.hadoop.security.SaslRpcServer$1.run(SaslRpcServer.java:164)\r\n        at org.apache.hadoop.security.SaslRpcServer$1.run(SaslRpcServer.java:161)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at javax.security.auth.Subject.doAs(Subject.java:422)\r\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1920)\r\n        at org.apache.hadoop.security.SaslRpcServer.create(SaslRpcServer.java:160)\r\n        at org.apache.hadoop.ipc.Server$Connection.createSaslServer(Server.java:1742)\r\n        at org.apache.hadoop.ipc.Server$Connection.processSaslMessage(Server.java:1522)\r\n        at org.apache.hadoop.ipc.Server$Connection.saslProcess(Server.java:1433)\r\n        at org.apache.hadoop.ipc.Server$Connection.saslReadAndProcess(Server.java:1396)\r\n        at org.apache.hadoop.ipc.Server$Connection.processRpcOutOfBandRequest(Server.java:2080)\r\n        at org.apache.hadoop.ipc.Server$Connection.processOneRpc(Server.java:1920)\r\n        at org.apache.hadoop.ipc.Server$Connection.readAndProcess(Server.java:1682)\r\n        at org.apache.hadoop.ipc.Server$Listener.doRead(Server.java:896)\r\n        at org.apache.hadoop.ipc.Server$Listener$Reader.doRunLoop(Server.java:752)\r\n        at org.apache.hadoop.ipc.Server$Listener$Reader.run(Server.java:723)\r\n{noformat}\r\n\r\nWe saw a few GSSException in the NN log, but only one threw the ConcurrentModificationException. This NN had a failover, which is caused by ZKFC having GSSException too. Suspect it's related issue.\r\n\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ConcurrentModificationException resulting in Kerberos authentication error.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"CDH 5.13.3. Kerberized, Hadoop-HA, jdk1.8.0_152","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160858/comment/16483232","id":"16483232","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"BTW I think this is the same as HADOOP-15401. [~xiaochen] [~daryn]\r\n\r\nbq. Searched impala code but don't find any faulty usage.\r\nThis exception is inside NameNode. So clearly must be in Hadoop code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-22T00:04:34.303+0000","updated":"2018-05-22T00:07:00.297+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160858/comment/16483240","id":"16483240","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"In fact, it seems HADOOP-13433 is actually the only Hadoop code that modifies Subject's PrivateCredentials...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-22T00:16:16.272+0000","updated":"2018-05-22T00:16:16.272+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160858/comment/16483427","id":"16483427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~jojochuang] for creating the jira and tagging me.\r\n\r\nThis appears to be the exact symptom I saw in HADOOP-15401. While this confirms that this is an issue in another version, unfortunately it's the symptom of someone else removing via the iterator without synchronizing, and we don't know _where_ this faulty removal happens.\r\n\r\nIn other words, this is the same symptom of HADOOP-15401 where we're being the victim, but the (likely same) culprit remains unclear...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-22T02:51:42.926+0000","updated":"2018-05-22T02:51:42.926+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160858/comment/16483980","id":"16483980","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"{quote}This exception is inside NameNode. So clearly must be in Hadoop code.\r\n{quote}\r\nNot necessarily, at least if you mean core Hadoop.  Are plugins involved?  An external permission enforcer?  An inode attributes provider?  Custom audit logger?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-05-22T13:51:45.107+0000","updated":"2018-05-22T13:51:45.107+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160858/comment/16484469","id":"16484469","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"[~daryn]\r\nbq. Not necessarily, at least if you mean core Hadoop.  Are plugins involved?  An external permission enforcer?  An inode attributes provider?  Custom audit logger?\r\nThat's a good point. Looking at the configuration, it doesn't look like it's got these plugins. I've suspected HADOOP-13433 manipulated the private credentials, but didn't spot the warnings \"The first kerberos ticket is not TGT(the server\" or any other warnings in fixKerberosTicketOrder() method.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-22T19:50:21.549+0000","updated":"2018-05-22T19:50:21.549+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160858/comment/16489733","id":"16489733","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"FYI here comes another that looks eerily similar:\r\n\r\nThis one is from a NameNode on a different cluster, CDH5.13.2, jdk1.8.0_74.\r\n{noformat}\r\n2018-05-20 14:01:35,314 INFO org.apache.hadoop.ipc.Server: Socket Reader #1 for port 8020: readAndProcess from client 192.168.30.37 threw exception [java.lang.IllegalStateException: This ticket is no longer valid]\r\njava.lang.IllegalStateException: This ticket is no longer valid\r\n        at javax.security.auth.kerberos.KerberosTicket.toString(KerberosTicket.java:638)\r\n        at java.lang.String.valueOf(String.java:2994)\r\n        at java.lang.StringBuilder.append(StringBuilder.java:131)\r\n        at sun.security.jgss.krb5.SubjectComber.findAux(SubjectComber.java:171)\r\n        at sun.security.jgss.krb5.SubjectComber.find(SubjectComber.java:61)\r\n        at sun.security.jgss.krb5.ServiceCreds.getInstance(ServiceCreds.java:127)\r\n        at sun.security.jgss.krb5.Krb5Util.getServiceCreds(Krb5Util.java:203)\r\n        at sun.security.jgss.krb5.Krb5AcceptCredential$1.run(Krb5AcceptCredential.java:74)\r\n        at sun.security.jgss.krb5.Krb5AcceptCredential$1.run(Krb5AcceptCredential.java:72)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at sun.security.jgss.krb5.Krb5AcceptCredential.getInstance(Krb5AcceptCredential.java:71)\r\n        at sun.security.jgss.krb5.Krb5MechFactory.getCredentialElement(Krb5MechFactory.java:127)\r\n        at sun.security.jgss.GSSManagerImpl.getCredentialElement(GSSManagerImpl.java:193)\r\n        at sun.security.jgss.GSSCredentialImpl.add(GSSCredentialImpl.java:427)\r\n        at sun.security.jgss.GSSCredentialImpl.<init>(GSSCredentialImpl.java:62)\r\n        at sun.security.jgss.GSSManagerImpl.createCredential(GSSManagerImpl.java:154)\r\n        at com.sun.security.sasl.gsskerb.GssKrb5Server.<init>(GssKrb5Server.java:108)\r\n        at com.sun.security.sasl.gsskerb.FactoryImpl.createSaslServer(FactoryImpl.java:85)\r\n        at org.apache.hadoop.security.SaslRpcServer$FastSaslServerFactory.createSaslServer(SaslRpcServer.java:398)\r\n        at org.apache.hadoop.security.SaslRpcServer$1.run(SaslRpcServer.java:164)\r\n        at org.apache.hadoop.security.SaslRpcServer$1.run(SaslRpcServer.java:161)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at javax.security.auth.Subject.doAs(Subject.java:422)\r\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1920)\r\n        at org.apache.hadoop.security.SaslRpcServer.create(SaslRpcServer.java:160)\r\n        at org.apache.hadoop.ipc.Server$Connection.createSaslServer(Server.java:1742)\r\n        at org.apache.hadoop.ipc.Server$Connection.processSaslMessage(Server.java:1522)\r\n        at org.apache.hadoop.ipc.Server$Connection.saslProcess(Server.java:1433)\r\n        at org.apache.hadoop.ipc.Server$Connection.saslReadAndProcess(Server.java:1396)\r\n        at org.apache.hadoop.ipc.Server$Connection.processRpcOutOfBandRequest(Server.java:2080)\r\n        at org.apache.hadoop.ipc.Server$Connection.processOneRpc(Server.java:1920)\r\n        at org.apache.hadoop.ipc.Server$Connection.readAndProcess(Server.java:1682)\r\n        at org.apache.hadoop.ipc.Server$Listener.doRead(Server.java:896)\r\n        at org.apache.hadoop.ipc.Server$Listener$Reader.doRunLoop(Server.java:752)\r\n        at org.apache.hadoop.ipc.Server$Listener$Reader.run(Server.java:723)\r\n2018-05-20 14:01:35,385 INFO SecurityLogger.org.apache.hadoop.ipc.Server: Auth successful for user@EXAMPLE.COM (auth:KERBEROS)\r\n2018-05-20 14:01:35,411 INFO SecurityLogger.org.apache.hadoop.security.authorize.ServiceAuthorizationManager: Authorization successful for user@EXAMPLE.COM (auth:KERBEROS) for protocol=interface org\r\n.apache.hadoop.hdfs.protocol.ClientProtocol\r\n2018-05-20 14:01:35,545 WARN org.apache.hadoop.security.UserGroupInformation: PriviledgedActionException as:hdfs/nn1.example.com@EXAMPLE.COM (auth:KERBEROS) cause:javax.security.sasl.SaslExcept\r\nion: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]\r\n2018-05-20 14:01:35,545 WARN org.apache.hadoop.security.UserGroupInformation: PriviledgedActionException as:hdfs/nn1.example.com@EXAMPLE.COM (auth:KERBEROS) cause:javax.security.sasl.SaslExcept\r\nion: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]\r\n2018-05-20 14:01:35,545 WARN org.apache.hadoop.security.UserGroupInformation: PriviledgedActionException as:hdfs/nn1.example.com@EXAMPLE.COM (auth:KERBEROS) cause:javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]\r\n2018-05-20 14:01:35,561 WARN org.apache.hadoop.security.UserGroupInformation: Not attempting to re-login since the last re-login was attempted less than 60 seconds before. Last Login=1526850095545\r\n2018-05-20 14:01:35,562 WARN org.apache.hadoop.security.UserGroupInformation: Not attempting to re-login since the last re-login was attempted less than 60 seconds before. Last Login=1526850095545\r\n{noformat}\r\n\r\nMaybe UGI.reloginFromKeytab() and SaslRpcServer$FastSaslServerFactory.createSaslServer() have race conditions?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-24T20:23:49.326+0000","updated":"2018-05-24T20:23:49.326+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160858/comment/16500348","id":"16500348","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"The second exception is an unrelated jdk bug fixed in 8u161.  [JDK-8170278: ticket renewal won't happen with debugging turned on|https://bugs.openjdk.java.net/browse/JDK-8170278].  The gssapi is smart recognizes and handles expired tickets from a keytab.  The problem is {{KerberosTicket#toString}} throws the ISE if it's expired. Easy workaround is don't enable debug logging.\r\n\r\nThe original issue is distinct.  If there truly are no custom plugins, it may be related to curator/zookeeper/AuthenticatedURL.  What is the specific apache release?  Did the server recover?\r\n\r\nWe may need to consider using a distinct subject/ugi for rpc servers to prevent other code munging our JASS, but there are a few possible grues lurking there.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-06-04T15:05:31.815+0000","updated":"2018-06-04T15:05:31.815+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160858/comment/16514346","id":"16514346","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"The original exception was seen on a CDH5.13.3 (Apache Hadoop 2.6.0 + many, many pathces). Server recovered for this specific exception.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-15T20:54:54.728+0000","updated":"2018-06-15T20:54:54.728+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160858/comment/16514352","id":"16514352","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"FYI I saw yet another Kerberos exception. It may or may not be related. This one was seen on a JN on CDH6.0.0-beta (Apache Hadoop 3.0.0) cluster on JDK 8u121\r\n\r\n2018-06-07 11:19:41,111 INFO org.apache.hadoop.ipc.Server: IPC Server handler 2 on 8485 caught an exception\r\njava.lang.NullPointerException\r\n        at com.sun.security.sasl.gsskerb.GssKrb5Base.wrap(GssKrb5Base.java:103)\r\n        at org.apache.hadoop.ipc.Server.wrapWithSasl(Server.java:2560)\r\n        at org.apache.hadoop.ipc.Server.access$2400(Server.java:136)\r\n        at org.apache.hadoop.ipc.Server$Responder.doRespond(Server.java:1178)\r\n        at org.apache.hadoop.ipc.Server$Connection.sendResponse(Server.java:2132)\r\n        at org.apache.hadoop.ipc.Server$Connection.access$400(Server.java:1251)\r\n        at org.apache.hadoop.ipc.Server$Call.sendResponse(Server.java:642)\r\n        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2268)\r\n\r\nAccording to this post https://community.cloudera.com/t5/Storage-Random-Access-HDFS/Name-nodes-crash-due-to-journal-timeouts/m-p/47107\r\n{quote}\r\nThe NPE in GssKrb5Base seems to be just a sign that the connection was closed. I suspect this is just a consequence of the NN shutting down without closing a connection.\r\n{quote}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-15T20:58:33.973+0000","updated":"2018-06-15T20:58:33.973+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160858/comment/16580170","id":"16580170","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Is this still a valid issue?  If it is:\r\n\r\nbq. We saw a few GSSException in the NN log, but only one threw the ConcurrentModificationException.\r\n\r\nWhat were the pre-cursor exceptions and related log messages, ie. (re)login/logout messages.\r\n\r\nbq. This NN had a failover, which is caused by ZKFC having GSSException too. Suspect it's related issue.\r\n\r\nI suspect curator/ZK is logging out the UGI's subject instead of the one it created.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-08-14T17:55:07.578+0000","updated":"2018-08-14T17:55:07.578+0000"}],"maxResults":10,"total":10,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15487/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3tz3b:"}}