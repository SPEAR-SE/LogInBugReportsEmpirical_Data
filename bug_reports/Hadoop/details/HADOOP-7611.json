{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12521376","self":"https://issues.apache.org/jira/rest/api/2/issue/12521376","key":"HADOOP-7611","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2011-09-06T14:20:32.943+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jan 15 03:58:40 UTC 2015","customfield_12310420":"19147","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-7611/watchers","watchCount":7,"isWatching":false},"created":"2011-09-05T17:44:48.850+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314203","id":"12314203","description":"","name":"0.20.2","archived":false,"released":true,"releaseDate":"2010-02-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-01-15T03:58:40.725+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310687","id":"12310687","name":"io","description":""}],"timeoriginalestimate":null,"description":"When using SequenceFile.Sorter to sort or merge sequence files that exist in HDFS, it attempts to create temp files in a directory structure specified by mapred.local.dir but on HDFS, not in the local file system. The problem code is in MergeQueue.merge(). Starting at line 2953:\n{code}\n            Path outputFile =  lDirAlloc.getLocalPathForWrite(\n                                                tmpFilename.toString(),\n                                                approxOutputSize, conf);\n            LOG.debug(\"writing intermediate results to \" + outputFile);\n            Writer writer = cloneFileAttributes(\n                                                fs.makeQualified(segmentsToMerge.get(0).segmentPathName), \n                                                fs.makeQualified(outputFile), null);\n{code}\nThe outputFile here is a local path without a scheme, e.g. \"/mnt/mnt1/mapred/local\", specified by the mapred.local.dir property. If we are sorting files on HDFS, the fs object is a DistributedFileSystem. The call to fs.makeQualified(outputFile) appends the fs object's scheme to the local temp path returned by lDirAlloc, e.g. hdfs://mnt/mnt1/mapred/local. This directory is then created (if the proper permissions are available) on HDFS. If the HDFS permissions are not available, the sort/merge fails even though the directories exist locally.\n\nThe code should instead always use the local file system if retrieving a path from the mapred.local.dir property. The unit tests do not test this condition, they only test using the local file system for sort and merge.\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"102421","customfield_12312823":null,"summary":"SequenceFile.Sorter creates local temp files on HDFS","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanck","name":"bryanck","key":"bryanck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Keller","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanck","name":"bryanck","key":"bryanck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Keller","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"CentOS 5.6 64-bit, Oracle JDK 1.6.0_26 64-bit","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521376/comment/13098027","id":"13098027","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srivas","name":"srivas","key":"srivas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"M. C. Srivas","active":true,"timeZone":"Etc/UTC"},"body":"On MapR, this is the intended affect ... the shuffle files should be placed in the DFS and not on local drives. So if you are planning to make changes, please do so in a HDFS-only manner.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srivas","name":"srivas","key":"srivas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"M. C. Srivas","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-06T14:20:32.943+0000","updated":"2011-09-06T14:20:32.943+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521376/comment/13098070","id":"13098070","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanck","name":"bryanck","key":"bryanck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Keller","active":true,"timeZone":"Etc/UTC"},"body":"I believe the intent was to have the intermediate files on the same file system as the result. Simply removing the prepending of the mapped.local.dir path works, as the intermediate file names are already being generated to avoid conflicts. I have modified SequenceFile to this effect and the sort/merge works properly without creating unintended directories on HDFS. Here is one of the changes (there are a couple other minor changes to support this).\n{code}\n//            Path outputFile =  lDirAlloc.getLocalPathForWrite(\n//                                                tmpFilename.toString(),\n//                                                approxOutputSize, conf);\n//            LOG.debug(\"writing intermediate results to \" + outputFile);\n//\n//            Writer writer = cloneFileAttributes(\n//                    fs.makeQualified(segmentsToMerge.get(0).segmentPathName),\n//                    fs.makeQualified(outputFile), null);\n            LOG.debug(\"writing intermediate results to \" + tmpFilename);\n\n            Writer writer = cloneFileAttributes(\n                    fs.makeQualified(segmentsToMerge.get(0).segmentPathName),\n                    fs.makeQualified(tmpFilename), null);\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bryanck","name":"bryanck","key":"bryanck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Keller","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-06T15:07:23.640+0000","updated":"2011-09-06T15:07:23.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521376/comment/14235433","id":"14235433","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akshayrai09","name":"akshayrai09","key":"akshayrai09","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akshay Rai","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi everyone,\n\nThis bug is still alive. Are there any updates on fixing it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akshayrai09","name":"akshayrai09","key":"akshayrai09","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akshay Rai","active":true,"timeZone":"Asia/Kolkata"},"created":"2014-12-05T12:27:38.038+0000","updated":"2014-12-05T12:27:38.038+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521376/comment/14235906","id":"14235906","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozawa","name":"ozawa","key":"ozawa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ozawa&avatarId=21740","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ozawa&avatarId=21740","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ozawa&avatarId=21740","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ozawa&avatarId=21740"},"displayName":"Tsuyoshi Ozawa","active":true,"timeZone":"America/Los_Angeles"},"body":"Let me check this. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozawa","name":"ozawa","key":"ozawa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ozawa&avatarId=21740","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ozawa&avatarId=21740","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ozawa&avatarId=21740","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ozawa&avatarId=21740"},"displayName":"Tsuyoshi Ozawa","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-12-05T18:59:03.365+0000","updated":"2014-12-05T18:59:03.365+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521376/comment/14235990","id":"14235990","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozawa","name":"ozawa","key":"ozawa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ozawa&avatarId=21740","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ozawa&avatarId=21740","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ozawa&avatarId=21740","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ozawa&avatarId=21740"},"displayName":"Tsuyoshi Ozawa","active":true,"timeZone":"America/Los_Angeles"},"body":"[~akshayrai09], hmm, I think the situation is a bit complex since SequenceFile#sort is using tmpDir as outputDir. It means current code assume outputDir is same to tmpDir. I think we need to refactor SequenceFile drastically to fix this problem...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozawa","name":"ozawa","key":"ozawa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ozawa&avatarId=21740","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ozawa&avatarId=21740","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ozawa&avatarId=21740","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ozawa&avatarId=21740"},"displayName":"Tsuyoshi Ozawa","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-12-05T19:47:51.750+0000","updated":"2014-12-05T19:47:51.750+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521376/comment/14263802","id":"14263802","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akshayrai09","name":"akshayrai09","key":"akshayrai09","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akshay Rai","active":true,"timeZone":"Asia/Kolkata"},"body":"[~ozawa], sorry for the late reply. I am not clear with the point you raised. From what I can gather, the output directory is different from the directory where the temporary/intermediate files are stored. The temporary files are stored in a location specified by \"mapred.local.dir\" or \"io.seqfile.local.dir\" and the output is stored in the location specified by the user(outFile, parameter to the sort method). \n\nHowever, the problem here is that the code creates the temporary files in hdfs if it has the required permissions and the reason as explained in the description.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akshayrai09","name":"akshayrai09","key":"akshayrai09","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akshay Rai","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-01-04T09:06:16.562+0000","updated":"2015-01-04T09:06:16.562+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521376/comment/14275591","id":"14275591","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akshayrai09","name":"akshayrai09","key":"akshayrai09","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akshay Rai","active":true,"timeZone":"Asia/Kolkata"},"body":"[~ozawa], any thoughts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akshayrai09","name":"akshayrai09","key":"akshayrai09","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akshay Rai","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-01-13T17:45:11.237+0000","updated":"2015-01-13T17:45:11.237+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521376/comment/14278214","id":"14278214","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozawa","name":"ozawa","key":"ozawa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ozawa&avatarId=21740","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ozawa&avatarId=21740","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ozawa&avatarId=21740","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ozawa&avatarId=21740"},"displayName":"Tsuyoshi Ozawa","active":true,"timeZone":"America/Los_Angeles"},"body":"[~akshayrai09] Yes, I think I can understand the problem itself. We should fix this problem.\n\n{quote}\n I am not clear with the point you raised. From what I can gather, the output directory is different from the directory where the temporary/intermediate files are stored.\n{quote}\n\nI mentioned about the internal design of SequenceFile.Sorter. We need a big refactoring of the code to fix this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozawa","name":"ozawa","key":"ozawa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ozawa&avatarId=21740","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ozawa&avatarId=21740","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ozawa&avatarId=21740","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ozawa&avatarId=21740"},"displayName":"Tsuyoshi Ozawa","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-01-15T03:58:40.725+0000","updated":"2015-01-15T03:58:40.725+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-7611/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0hvuf:"}}