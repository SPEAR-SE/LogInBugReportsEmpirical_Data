{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12955974","self":"https://issues.apache.org/jira/rest/api/2/issue/12955974","key":"HADOOP-13002","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-10-11T23:14:33.731+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Oct 11 23:14:33 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-13002/watchers","watchCount":4,"isWatching":false},"created":"2016-04-04T23:10:51.752+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326263","id":"12326263","description":"2.5.0 release","name":"2.5.0","archived":false,"released":true,"releaseDate":"2014-08-11"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12327179","id":"12327179","description":"2.6.0 release","name":"2.6.0","archived":false,"released":true,"releaseDate":"2014-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12327583","id":"12327583","description":"2.7.0 release","name":"2.7.0","archived":false,"released":true,"releaseDate":"2015-04-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335733","id":"12335733","description":"3.0.0-alpha1 release","name":"3.0.0-alpha1","archived":false,"released":true,"releaseDate":"2016-09-03"}],"issuelinks":[{"id":"12462741","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12462741","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12703353","key":"HADOOP-10459","self":"https://issues.apache.org/jira/rest/api/2/issue/12703353","fields":{"summary":"distcp V2 doesn't preserve root dir's attributes when -p is specified","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gsteelman","name":"gsteelman","key":"gsteelman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Steelman","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-10-11T23:14:33.731+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12319644","id":"12319644","name":"tools/distcp","description":"Distcp"}],"timeoriginalestimate":null,"description":"In Hadoop 2.5 the behavior of distcp changed when called through code iff the target directory did not exist and update wasn't used and atomic wasn't used.\nHADOOP-10459 introduced a change to preserve the root directory attributes. It introduced a derivative property in the options as well as in the configuration whether the target path exists. See https://github.com/apache/hadoop/commit/c5b59477775c797944db4992e8a70289ba2895ed\nHowever, this property is set only when distcp is used through the command line as a ToolRunner in Distcp.run(String[] argv).\nThe result is that when the target directory doesn't exist (and neither -update nor -atomic options are used) SimplyCopyListing incorrectly assumes that the target directory does exist because the attribute defaults to true. Copying directory a/b/c to xyz results in the creation of a xyx/c directory with the content of c in it, rather than the content of c getting copied into directory xyz directly.  ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12332809","id":"12332809","description":"2.7.2 release","name":"2.7.2","archived":false,"released":true,"releaseDate":"2016-01-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334234","id":"12334234","description":"2.6.4 release","name":"2.6.4","archived":false,"released":true,"releaseDate":"2016-02-11"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"distcp behaves differently through code compared to toolrunner invocation from command-line","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jrottinghuis","name":"jrottinghuis","key":"jrottinghuis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joep Rottinghuis","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jrottinghuis","name":"jrottinghuis","key":"jrottinghuis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joep Rottinghuis","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12955974/comment/15225238","id":"15225238","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jrottinghuis","name":"jrottinghuis","key":"jrottinghuis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joep Rottinghuis","active":true,"timeZone":"America/Los_Angeles"},"body":"The problem is that a new derived property is added to DistCpOptionSwitch \n\nThen in Distcp we have\n{code}\n  public int run(String[] argv) {\n   ...\n    try {\n      inputOptions = (OptionsParser.parse(argv));\n      setTargetPathExists();\n      LOG.info(\"Input Options: \" + inputOptions);\n{code}\nThis doesn't get executed when calling distcp from a java program, because in that case a deparate DistCpOptionSwitch gets created and DistCp is executed like so:\n{code}\n  Path targetPath = ...\n  DistCpOptions options = new DistCpOptions(sourcePaths, targetPath);\n  \n  // Set desired options\n  options.preserve(DistCpOptions.FileAttribute.BLOCKSIZE);\n  options.preserve(DistCpOptions.FileAttribute.CHECKSUMTYPE);\n  options.preserve(DistCpOptions.FileAttribute.REPLICATION);\n  options.preserve(DistCpOptions.FileAttribute.TIMES);\n  options.preserve(DistCpOptions.FileAttribute.USER);\n  options.preserve(DistCpOptions.FileAttribute.GROUP);\n  options.preserve(DistCpOptions.FileAttribute.PERMISSION);\n  options.setBlocking(true);\n  // -atomic defaults to false\n  options.﻿﻿setAtomicCommit(false);\n  // -update defaults to false\n  options.﻿setSyncFolder(false);\n  \n  Configuration conf = ...\n  Job job = null;\n  DistCp distCp = new DistCp(conf, options);\n  job = distCp.execute();\n{code}\n\nin DistcpOptions targetPathExists defaults to true, the comment even suggests this:\n{code}\n  // targetPathExist is a derived field, it's initialized in the\n  // beginning of distcp.\n  private boolean targetPathExists = true;\n{code}\nThe key problem is that it is initialized only from the run method, not in the execute method.\n\nWith the path not existing, but DistCp assuming it does exist when executed from code, the following special handling fails to compute correctly in SimpleCopyListing.computeSourceRootPath\n{code}\n      boolean specialHandling =\n          (options.getSourcePaths().size() == 1 && !targetPathExists)\n              || options.shouldSyncFolder() || options.shouldOverwrite();\n{code}\nAs a result the parent directory is prepended to the files in the generated sequence file which results in the extra xyz/c directory in the target.\n\nThe least amount of code change would be to move the initialization in DistCP from run to execute, however that has three disadvantages:\n1) We'd also have to move the logging statement, otherwise an incorrectly initialized variable is logged. That means that the invocation from Java suddenly does additional logging.\n2) Having a derived method that could be explicitly set (to incorrect value) and then later overwritten during execution is weird.\n3) With hindsight we should have never introduced a setter for the derived property. It allows the option and the associated property in the config to get out of sync. Moving the external setting doesn't fix this.\n\nI think the proper solution would be to remove the setTargetPathExists method from DistCp and to move it to DistCpOptions and to invoke it from both constructors (but not the copy constructor).\nNow that the setTargetPathExists method was added in 2.5 we cannot remove it w/o breaking backwards compatibility, but I think we should mark it as deprecated. We could also consider making it a no-op given that the constructor already calculates it. Possibly we can make it ignore the argument and re-calculate the exists value. I don't see the value in letting people set an incorrect value (of path existing when it doesn't and visa versa).\n\nHowever, the setting of the conf property has to remain in the distcp.execute method, because the DistCpOptions class isn't a Configurable and will therefore not have access to getConf(). Passing the conf into the constructor of DistCpOptions would change its signature which we cannot do.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jrottinghuis","name":"jrottinghuis","key":"jrottinghuis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joep Rottinghuis","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-04-04T23:12:19.179+0000","updated":"2016-04-04T23:12:19.179+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12955974/comment/15225240","id":"15225240","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jrottinghuis","name":"jrottinghuis","key":"jrottinghuis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joep Rottinghuis","active":true,"timeZone":"America/Los_Angeles"},"body":"[~atm] and [~yzhangal] do you think this ^^ is a reasonable approach?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jrottinghuis","name":"jrottinghuis","key":"jrottinghuis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joep Rottinghuis","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-04-04T23:13:23.984+0000","updated":"2016-04-04T23:13:23.984+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12955974/comment/16201157","id":"16201157","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"body":"This will be useful for hive. Currently because of this bug we need to invoke distcp via tool runner, instead of via api.\r\ncc: [~jnp]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashutoshc","name":"ashutoshc","key":"ashutoshc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ashutosh Chauhan","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-11T23:14:33.731+0000","updated":"2017-10-11T23:14:33.731+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-13002/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2vmrb:"}}