{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13113206","self":"https://issues.apache.org/jira/rest/api/2/issue/13113206","key":"HADOOP-14996","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-10-31T11:07:05.822+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Nov 03 23:50:50 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-14996/watchers","watchCount":3,"isWatching":false},"created":"2017-10-31T01:04:50.494+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmarquardt","name":"tmarquardt","key":"tmarquardt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tmarquardt&avatarId=32243","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tmarquardt&avatarId=32243","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tmarquardt&avatarId=32243","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tmarquardt&avatarId=32243"},"displayName":"Thomas Marquardt","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-20T18:23:40.494+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12328416","id":"12328416","name":"fs/azure","description":"Azure WASB filesystem client"}],"timeoriginalestimate":null,"description":"Looks like there is a functional bug or concurrency bug in the PageBlobInputStream implemenation of ReadFully.\r\n\r\n1) Use 1 mapper to copy results in success:\r\nhadoop distcp -m 1 wasb://hbt-lifetime@salsbx01sparkdata.blob.core.windows.net/hive_tablesÂ  wasb://hbt-lifetime-bkp@supporttestl2.blob.core.windows.net/hdi_backup\r\n\r\n2) Turn on DEBUG log by setting mapreduce.map.log.level=DEBUG in ambari. Then run with more than 1 mapper:\r\n\r\nSaw debug log like this:\r\n{code}\r\n2017-10-27 06:18:53,545 DEBUG [main] org.apache.hadoop.fs.azure.NativeAzureFileSystem: Seek to position 136251. Bytes skipped 136210\r\n2017-10-27 06:18:53,549 DEBUG [main] org.apache.hadoop.fs.azure.AzureNativeFileSystemStore: Closing page blob output stream.\r\n2017-10-27 06:18:53,549 DEBUG [main] org.apache.hadoop.fs.azure.AzureNativeFileSystemStore: java.util.concurrent.ThreadPoolExecutor@73dce0e6[Terminated, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]\r\n2017-10-27 06:18:53,549 DEBUG [main] org.apache.hadoop.security.UserGroupInformation: PrivilegedActionException as:mssupport (auth:SIMPLE) cause:java.io.EOFException\r\n2017-10-27 06:18:53,553 WARN [main] org.apache.hadoop.mapred.YarnChild: Exception running child : java.io.EOFException\r\nat java.io.DataInputStream.readFully(DataInputStream.java:197)\r\nat java.io.DataInputStream.readFully(DataInputStream.java:169)\r\nat org.apache.hadoop.io.SequenceFile$Reader.sync(SequenceFile.java:2693)\r\nat org.apache.hadoop.mapreduce.lib.input.SequenceFileRecordReader.initialize(SequenceFileRecordReader.java:58)\r\nat org.apache.hadoop.mapred.MapTask$NewTrackingRecordReader.initialize(MapTask.java:548)\r\nat org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:786)\r\nat org.apache.hadoop.mapred.MapTask.run(MapTask.java:341)\r\nat org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:170)\r\nat java.security.AccessController.doPrivileged(Native Method)\r\nat javax.security.auth.Subject.doAs(Subject.java:422)\r\nat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1866)\r\nat org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:164)\r\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341706","id":"12341706","description":"2.10.0 Release","name":"2.10.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342324","id":"12342324","description":"3.2 release","name":"3.2.0","archived":false,"released":false}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"wasb: ReadFully occasionally fails when using page blobs","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmarquardt","name":"tmarquardt","key":"tmarquardt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tmarquardt&avatarId=32243","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tmarquardt&avatarId=32243","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tmarquardt&avatarId=32243","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tmarquardt&avatarId=32243"},"displayName":"Thomas Marquardt","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmarquardt","name":"tmarquardt","key":"tmarquardt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tmarquardt&avatarId=32243","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tmarquardt&avatarId=32243","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tmarquardt&avatarId=32243","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tmarquardt&avatarId=32243"},"displayName":"Thomas Marquardt","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113206/comment/16226618","id":"16226618","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"In theory, input streams aren't thread safe (that's at the java.io.InputStream spec level), so nothing should be using them in parallel.\r\n\r\nBut some apps are known to treat them as thread safe, because HDFS DFSInputStream did offer stronger guarantees and apps (HBase) coded against it. {{SequenceFile$Reader}} doesn't make that assumption, not AFAIK. The input stream it is reading is one created a few lines earlier in the {{initialize()}} clause...it's now lining up to talk to the start of the data\r\n\r\n{code}\r\n    if (fileSplit.getStart() > in.getPosition()) {\r\n      in.sync(fileSplit.getStart());                  // sync to start\r\n    }\r\n{code}\r\n\r\nWhere it skips 4 bytes and tries to read a 16 byte header\r\n{code}\r\n        seek(position+4);\r\n        in.readFully(syncCheck);   // HERE\r\n{code}\r\n\r\nIf it's failing in multi threaded IO, I wouldn't put the blame on readFully. It's throwing an EOFException if there aren't enough bytes to fill up the buffer. Which implies either the offset the stream has synced to  is > the end of the blob, or the start of the readFully was within the stream len, but the total length wasn't.  Possible causes for these: partitioning is wrong, or the measured blob len coming back from getFileStatus is < that of the actual len.\r\n\r\nI wouldn't directly point the blame at the page blob code here, unless there's something up with how it is doing its seeks. But if its not that code: why isn't it surfacing elsewhere?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2017-10-31T11:07:05.822+0000","updated":"2017-10-31T11:07:05.822+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113206/comment/16226639","id":"16226639","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"Looking at this some more. InputStream.readFully() will raise an EOFException if InputStream.read() returned -1.  I'd look at the codepath there, in case some transient failure is causing -1 to be returned, which is then raising the new EOFException","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2017-10-31T11:22:02.132+0000","updated":"2017-10-31T11:22:02.132+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113206/comment/16238610","id":"16238610","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=subru","name":"subru","key":"subru","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=subru&avatarId=21709","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=subru&avatarId=21709","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=subru&avatarId=21709","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=subru&avatarId=21709"},"displayName":"Subru Krishnan","active":true,"timeZone":"America/Los_Angeles"},"body":"Moving out to 2.10.0 as 2.9.0 release is ongoing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=subru","name":"subru","key":"subru","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=subru&avatarId=21709","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=subru&avatarId=21709","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=subru&avatarId=21709","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=subru&avatarId=21709"},"displayName":"Subru Krishnan","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-03T23:50:50.360+0000","updated":"2017-11-03T23:50:50.360+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-14996/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3lwbj:"}}