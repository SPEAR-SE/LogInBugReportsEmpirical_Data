{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12411605","self":"https://issues.apache.org/jira/rest/api/2/issue/12411605","key":"HADOOP-4977","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313438","id":"12313438","description":"","name":"0.20.0","archived":false,"released":true,"releaseDate":"2009-04-22"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-01-05T01:43:07.249+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jan 15 02:58:26 UTC 2009","customfield_12310420":"126854","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_489868343_*|*_1_*:*_1_*:*_560123373_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-01-15T02:58:26.716+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-4977/watchers","watchCount":4,"isWatching":false},"created":"2009-01-02T23:18:35.316+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313211","id":"12313211","description":"","name":"0.19.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-07-08T16:40:29.686+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"I was running the latest trunk with the capacity scheduler and saw the JobTracker lock up with the following deadlock reported in jstack:\n\nFound one Java-level deadlock:\n=============================\n\"18107298@qtp0-4\":\n  waiting to lock monitor 0x08085b40 (object 0x56605100, a org.apache.hadoop.mapred.JobTracker),\n  which is held by \"IPC Server handler 4 on 54311\"\n\"IPC Server handler 4 on 54311\":\n  waiting to lock monitor 0x0808594c (object 0x5660e518, a org.apache.hadoop.mapred.CapacityTaskScheduler$MapSchedulingMgr),\n  which is held by \"reclaimCapacity\"\n\"reclaimCapacity\":\n  waiting to lock monitor 0x08085b40 (object 0x56605100, a org.apache.hadoop.mapred.JobTracker),\n  which is held by \"IPC Server handler 4 on 54311\"\n\nJava stack information for the threads listed above:\n===================================================\n\"18107298@qtp0-4\":\n\tat org.apache.hadoop.mapred.JobTracker.getClusterStatus(JobTracker.java:2695)\n\t- waiting to lock <0x56605100> (a org.apache.hadoop.mapred.JobTracker)\n\tat org.apache.hadoop.mapred.jobtracker_jsp._jspService(jobtracker_jsp.java:93)\n\tat org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:97)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:820)\n\tat org.mortbay.jetty.servlet.ServletHolder.handle(ServletHolder.java:502)\n\tat org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:363)\n\tat org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)\n\tat org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)\n\tat org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:766)\n\tat org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:417)\n\tat org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:230)\n\tat org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\n\tat org.mortbay.jetty.Server.handle(Server.java:324)\n\tat org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:534)\n\tat org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:864)\n\tat org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:533)\n\tat org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:207)\n\tat org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:403)\n\tat org.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:409)\n\tat org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:522)\n\"IPC Server handler 4 on 54311\":\n\tat org.apache.hadoop.mapred.CapacityTaskScheduler$TaskSchedulingMgr.updateQSIObjects(CapacityTaskScheduler.java:564)\n\t- waiting to lock <0x5660e518> (a org.apache.hadoop.mapred.CapacityTaskScheduler$MapSchedulingMgr)\n\tat org.apache.hadoop.mapred.CapacityTaskScheduler$TaskSchedulingMgr.assignTasks(CapacityTaskScheduler.java:855)\n\tat org.apache.hadoop.mapred.CapacityTaskScheduler$TaskSchedulingMgr.access$1000(CapacityTaskScheduler.java:294)\n\tat org.apache.hadoop.mapred.CapacityTaskScheduler.assignTasks(CapacityTaskScheduler.java:1336)\n\t- locked <0x5660dd20> (a org.apache.hadoop.mapred.CapacityTaskScheduler)\n\tat org.apache.hadoop.mapred.JobTracker.heartbeat(JobTracker.java:2288)\n\t- locked <0x56605100> (a org.apache.hadoop.mapred.JobTracker)\n\tat sun.reflect.GeneratedMethodAccessor16.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:508)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:959)\n\nUnfortunately I didn't manage to select all of the output by mistake, so some is missing, but it appears that reclaimCapacity locks the MapSchedulingMgr and then tries to lock the JobTracker, whereas the updateQSIObjects called in assignTasks holds a lock on the JobTracker (the JobTracker grabs this lock when it calls assignTasks) and then tries to lock the MapSchedulingMgr. The other thread listed there is a Jetty thread for the web interface and isn't part of the circular locking. The solution to this would be to lock the JobTracker in reclaimCapacity before locking anything else.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12397492","id":"12397492","filename":"4977.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-09T08:39:18.444+0000","size":19542,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12397492/4977.1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12397503","id":"12397503","filename":"4977.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-09T10:53:25.730+0000","size":20680,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12397503/4977.2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12397686","id":"12397686","filename":"4977.3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-12T13:25:59.506+0000","size":20758,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12397686/4977.3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12397935","id":"12397935","filename":"4977.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"created":"2009-01-15T01:49:11.906+0000","size":21962,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12397935/4977.4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12397853","id":"12397853","filename":"4977.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-14T03:38:57.892+0000","size":22454,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12397853/4977.4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12397042","id":"12397042","filename":"jstack.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-01-02T23:23:59.629+0000","size":5095,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12397042/jstack.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"74482","customfield_12312823":null,"summary":"Deadlock between reclaimCapacity and assignTasks","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12660420","id":"12660420","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"body":"I managed to reproduce this, here's the full jstack output.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matei","name":"matei","key":"matei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matei Zaharia","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-01-02T23:23:59.664+0000","updated":"2009-01-02T23:23:59.664+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12660657","id":"12660657","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"body":"Marking this as a blocker...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acmurthy","name":"acmurthy","key":"acmurthy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun C Murthy","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-01-05T01:43:07.249+0000","updated":"2009-01-05T01:43:07.249+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12661094","id":"12661094","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinodkv","name":"vinodkv","key":"vinodkv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinod Kumar Vavilapalli","active":true,"timeZone":"America/Los_Angeles"},"body":"\nFound this while running tests for HADOOP-4830. Thought it might help.\n\n{code}\n    [junit] Found one Java-level deadlock:\n    [junit] =============================\n    [junit] \"IPC Server handler 9 on 51089\":\n    [junit]   waiting to lock monitor 0x08120f38 (object 0xe5346a40, a org.apache.hadoop.mapred.JobTracker),\n    [junit]   which is held by \"IPC Server handler 7 on 51089\"\n    [junit] \"IPC Server handler 7 on 51089\":\n    [junit]   waiting to lock monitor 0x08120ce0 (object 0xe5346d28, a org.apache.hadoop.mapred.CapacityTaskScheduler$MapSchedulingMgr),\n    [junit]   which is held by \"reclaimCapacity\"\n    [junit] \"reclaimCapacity\":\n    [junit]   waiting to lock monitor 0x08120f38 (object 0xe5346a40, a org.apache.hadoop.mapred.JobTracker),\n    [junit]   which is held by \"IPC Server handler 7 on 51089\"\n    [junit] \n    [junit] Java stack information for the threads listed above:\n    [junit] ===================================================\n    [junit] \"IPC Server handler 9 on 51089\":\n    [junit]     at org.apache.hadoop.mapred.JobTracker.getJobStatus(JobTracker.java:2783)\n    [junit]     - waiting to lock <0xe5346a40> (a org.apache.hadoop.mapred.JobTracker)\n    [junit]     at sun.reflect.GeneratedMethodAccessor5.invoke(Unknown Source)\n    [junit]     at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    [junit]     at java.lang.reflect.Method.invoke(Method.java:597)\n    [junit]     at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:508)\n    [junit]     at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:959)\n    [junit]     at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:955)\n    [junit]     at java.security.AccessController.doPrivileged(Native Method)\n    [junit]     at javax.security.auth.Subject.doAs(Subject.java:396)\n    [junit]     at org.apache.hadoop.ipc.Server$Handler.run(Server.java:953)\n    [junit] \"IPC Server handler 7 on 51089\":\n    [junit]     at org.apache.hadoop.mapred.CapacityTaskScheduler$TaskSchedulingMgr.updateQSIObjects(CapacityTaskScheduler.java:564)\n    [junit]     - waiting to lock <0xe5346d28> (a org.apache.hadoop.mapred.CapacityTaskScheduler$MapSchedulingMgr)\n    [junit]     at org.apache.hadoop.mapred.CapacityTaskScheduler$TaskSchedulingMgr.assignTasks(CapacityTaskScheduler.java:855)\n    [junit]     at org.apache.hadoop.mapred.CapacityTaskScheduler$TaskSchedulingMgr.access$1000(CapacityTaskScheduler.java:294)\n    [junit]     at org.apache.hadoop.mapred.CapacityTaskScheduler.assignTasks(CapacityTaskScheduler.java:1336)\n    [junit]     - locked <0xe5346cd8> (a org.apache.hadoop.mapred.CapacityTaskScheduler)\n    [junit]     at org.apache.hadoop.mapred.JobTracker.heartbeat(JobTracker.java:2288)\n    [junit]     - locked <0xe5346a40> (a org.apache.hadoop.mapred.JobTracker)\n    [junit]     at sun.reflect.GeneratedMethodAccessor2.invoke(Unknown Source)\n    [junit]     at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n    [junit]     at java.lang.reflect.Method.invoke(Method.java:597)\n    [junit]     at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:508)\n    [junit]     at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:959)\n    [junit]     at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:955)\n    [junit]     at java.security.AccessController.doPrivileged(Native Method)\n    [junit]     at javax.security.auth.Subject.doAs(Subject.java:396)\n    [junit]     at org.apache.hadoop.ipc.Server$Handler.run(Server.java:953)\n    [junit] \"reclaimCapacity\":\n    [junit]     at org.apache.hadoop.mapred.JobTracker.getClusterStatus(JobTracker.java:2695)\n    [junit]     - waiting to lock <0xe5346a40> (a org.apache.hadoop.mapred.JobTracker)\n    [junit]     at org.apache.hadoop.mapred.CapacityTaskScheduler$MapSchedulingMgr.getClusterCapacity(CapacityTaskScheduler.java:939)\n    [junit]     at org.apache.hadoop.mapred.CapacityTaskScheduler$TaskSchedulingMgr.updateQSIObjects(CapacityTaskScheduler.java:564)\n    [junit]     - locked <0xe5346d28> (a org.apache.hadoop.mapred.CapacityTaskScheduler$MapSchedulingMgr)\n    [junit]     at org.apache.hadoop.mapred.CapacityTaskScheduler$TaskSchedulingMgr.reclaimCapacity(CapacityTaskScheduler.java:405)\n    [junit]     - locked <0xe5346d28> (a org.apache.hadoop.mapred.CapacityTaskScheduler$MapSchedulingMgr)\n    [junit]     at org.apache.hadoop.mapred.CapacityTaskScheduler$TaskSchedulingMgr.access$700(CapacityTaskScheduler.java:294)\n    [junit]     at org.apache.hadoop.mapred.CapacityTaskScheduler.reclaimCapacity(CapacityTaskScheduler.java:1278)\n    [junit]     at org.apache.hadoop.mapred.CapacityTaskScheduler$ReclaimCapacity.run(CapacityTaskScheduler.java:1084)\n    [junit]     at java.lang.Thread.run(Thread.java:619)\n    [junit] \n    [junit] Found 1 deadlock.\n\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinodkv","name":"vinodkv","key":"vinodkv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinod Kumar Vavilapalli","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-01-06T09:57:25.276+0000","updated":"2009-01-06T09:57:25.276+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12661478","id":"12661478","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"body":"Identified 2 scenarios where the deadlock can happen :-\n1) {{ReclaimCapacity}} thread calls {{TaskSchedulingMgr.reclaimCapacity()}} which internally calls {{updateQSIObjects()}} which internally calls {{TaskTrackerManager.getClusterStatus()}} which is a _synchronized_ call.\n2) {{ReclaimCapacity}} thread calls {{TaskSchedulingMgr.reclaimCapacity()}} which internally calls {{TaskTrackerManager.getNextHeartbeatInterval()}} which internally calls {{TaskTrackerManager.getClusterStatus()}} which is a _synchronized_ call.\n\nNote that this can happen any time whenever a thread (from capacity scheduler) makes back call to {{TaskTrackerManager}} which tries to take a lock on the {{TaskTrackerManager}} while the {{TaskTrackerManager}} itself invokes {{TaskScheduler}}'s api after locking itself. The whole deadlock issue can be summarized as follows\n\n||Who||Via||Locks?||Needs to lock?||Via||\n|JobTracker|JobTracker.heartbeat()|JobTracker(itself)|TaskSchedulingMgr|CapacityTaskScheduler.assignTasks() calls TaskSchedulingMg.assignTasks() which calls updateQSIObjects() which is a _synchronized_ call|\n|CapacityScheduler.ReclaimCapacityThread|TaskSchedulingMgr.reclaimCapacity()|TaskSchedulingMgr|JobTracker|TaskSchedulingMgr.reclaimCapacity() calls TaskSchedulingMgr.updateQSIObjects() which calls JobTracker.getClusterStatus() which is a _synchronized_ call and TaskSchedulingMgr.reclaimCapacity() which calls JobTracker.getNextHeartbeatInterval() which is a _synchronized_ call|\n\nSpoke to Hemanth and Vivek on this and we all agree that various cluster parameters (cluster-status, heartbeat-interval) should be obtained/cached before invoking {{reclaimCapacity()}} and this should be a common rule while adding new threads.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-07T07:50:55.324+0000","updated":"2009-01-07T07:50:55.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12661865","id":"12661865","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"body":"I think we should get this addressed very soon, now that HADOOP-4980 is committed. Also, because I committed HADOOP-4830, folks might hit this often while running tests. One Hudson build failed due to this, as reported on the core-dev mailing list.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"created":"2009-01-08T07:13:31.991+0000","updated":"2009-01-08T07:13:31.991+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12662278","id":"12662278","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"body":"Attaching patch (4977.1.patch). As Amar points out, the problem is that JT loks itself, then calls the scheduler's assignTasks, which tries getting a lock for one of the scheduler's objects. In the meantime, a separate thread in the scheduler locks thsi objects, then calls a TaskTrackerManager method. TaskTrackerManager is implemented by the JT. Hence the deadlock. \n\nThe fix is for threads in the scheduler to call TaskTrackerManager first, before locking anything in the Scheduler. \n\nI've made the following changes: \n* I've moved updateQSIObjects() from TaskSchedulingMgr to CapacitYScheduler. We may as well update both the map and reduce tasks in one go, rather than do them separately and walk the list of jobs in a queue twice. \n* updateQSI was called in three places: assignTasks (when processing a heartbeat), the reclaimCapacity thread, and in test cases. In all these calls, we get the cluster information from TaskTrackerManager first, then update the QSI objects. \n* I renamed one of the methods from updateQSIInfo to updateQSIInfoForTests to better suggest what it does. Hence the minor changes in TestCapacityScheduler.java. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-09T08:39:18.468+0000","updated":"2009-01-09T08:39:18.468+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12662318","id":"12662318","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"body":"Attaching new patch (4977.2.patch). Amar pointed out one more instance where reclaimCapacity() was calling TaskTrackerManager - to get the heartbeat interval. That has been fixed. reclaimCapacity() no longer calls any method in TaskTrackerManager. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-09T10:53:26.062+0000","updated":"2009-01-09T10:53:26.062+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12662943","id":"12662943","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"body":"Few comments:\n- {{updateQSIObjects()}} and {{updateQSIObjects(...)}} might make it confusing as to which api to use. There seems to be no documentation to clarify which to call when. So I feel we can have only one api named {{updateQSIObjects()}} which first takes a snapshot of the required parameters from {{TaskTrackerManager}} and then syncs on the remaining main code.\n- there is a extra line which says \"for debugging\"","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-12T11:38:28.031+0000","updated":"2009-01-12T11:38:28.031+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12662949","id":"12662949","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"body":"Valid points, Amar. I did some extra refactoring at the end and didn't realize the confusing calls. I do want to keep the update of the QSI objects separate from the fetching of the cluster status, as both these can come under different synchronization calls, if required. So each of the three callers: assignTasks(), reclaimCapacity, and the test cases, get the cluster stats on their own and then call updateQSIObjects(). See attached patch (4977.3.patch). \n\nThe method printQSIs() is useful for printing debug information. We don't call it right now (we did, earlier), but I wanted to keep it around as it can prove quite useful. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-12T13:25:59.536+0000","updated":"2009-01-12T13:25:59.536+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12663242","id":"12663242","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"body":"Looks good. +1. We need to manually test this patch for deadlocks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amar_kamat","name":"amar_kamat","key":"amar_kamat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amar Kamat","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-13T06:22:58.305+0000","updated":"2009-01-13T06:22:58.305+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12663612","id":"12663612","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"body":"Attaching another patch (4977.4.patch) with some minor cleanup - I removed a couple of methods that were no longer needed. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-14T03:38:57.934+0000","updated":"2009-01-14T03:38:57.934+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12663979","id":"12663979","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"body":"Attached a patch on which I've run dos2unix. Vivek, in future, can you please make sure the patch files do not have the windows EOL characters - maybe some setting in the editor can change this.\n\nAlso, in future, please attach test-patch results when you are uploading a patch. Here are the results for this one:\n\n     [exec] +1 overall.\n     [exec]\n     [exec]     +1 @author.  The patch does not contain any @author tags.\n     [exec]\n     [exec]     +1 tests included.  The patch appears to include 3 new or modified tests.\n     [exec]\n     [exec]     +1 javadoc.  The javadoc tool did not generate any warning messages.\n     [exec]\n     [exec]     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n     [exec]\n     [exec]     +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n     [exec]\n     [exec]     +1 Eclipse classpath. The patch retains Eclipse classpath integrity.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"created":"2009-01-15T01:51:42.901+0000","updated":"2009-01-15T01:51:42.901+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12411605/comment/12663986","id":"12663986","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"body":"I committed this patch to trunk and Hadoop 0.20. Thanks, Vivek !","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yhemanth","name":"yhemanth","key":"yhemanth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hemanth Yamijala","active":true,"timeZone":"Asia/Kolkata"},"created":"2009-01-15T02:58:26.681+0000","updated":"2009-01-15T02:58:26.681+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-4977/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0d4cv:"}}