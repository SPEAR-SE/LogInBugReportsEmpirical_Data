{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12839136","self":"https://issues.apache.org/jira/rest/api/2/issue/12839136","key":"HADOOP-12106","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jul 22 12:15:42 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2845913398_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-07-22T12:14:49.222+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-12106/watchers","watchCount":2,"isWatching":false},"created":"2015-06-19T13:42:55.852+0000","customfield_12310192":"The issue was in the IBM JVM which did not integrate a fix that was integrated into OpenJDK.","customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12327179","id":"12327179","description":"2.6.0 release","name":"2.6.0","archived":false,"released":true,"releaseDate":"2014-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12327583","id":"12327583","description":"2.7.0 release","name":"2.7.0","archived":false,"released":true,"releaseDate":"2015-04-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-07-22T12:15:42.720+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312526","id":"12312526","name":"security"}],"timeoriginalestimate":null,"description":"On AIX (IBM JVM available only), many sub-tests of :\n   org.apache.hadoop.crypto.TestCryptoStreamsForLocalFS\nfail:\n Tests run: 13, Failures: 5, Errors: 1, Skipped: \n  - testCryptoIV\n  - testSeek\n  - testSkip\n  - testAvailable\n  - testPositionedRead\n\nWhen testing SAME exact code on Ubuntu/i386 :\n  - with OpenJDK, all tests are OK\n  - with IBM JVM, tests randomly fail.\n\nThe issue may be in the IBM JVM, or in some Hadoop code that not perfectly handles differences due to different IBM JVM.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12740649","id":"12740649","filename":"mvn.Test.TestCryptoStreamsForLocalFS.res20.AIX.Errors","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-19T13:56:34.117+0000","size":10180,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12740649/mvn.Test.TestCryptoStreamsForLocalFS.res20.AIX.Errors"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12740650","id":"12740650","filename":"mvn.Test.TestCryptoStreamsForLocalFS.res20.Ubuntu-i386.IBMJVM.Errors","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-19T13:56:34.122+0000","size":8624,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12740650/mvn.Test.TestCryptoStreamsForLocalFS.res20.Ubuntu-i386.IBMJVM.Errors"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12740648","id":"12740648","filename":"mvn.Test.TestCryptoStreamsForLocalFS.res22.OpenJDK.Errors","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-19T13:56:34.111+0000","size":1309,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12740648/mvn.Test.TestCryptoStreamsForLocalFS.res22.OpenJDK.Errors"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"JceAesCtrCryptoCodec.java may have an issue with Cypher.update(ByteBuffer, ByteBuffer)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Hadoop 2.60 and 2.7+\n - AIX/PowerPC/IBMJVM\n - Ubuntu/i386/IBMJVM","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14593436","id":"14593436","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"These 3 files show the different behavior between:\n - 20.AIX.Errors                              : AIX (IBM JVM)\n - 20.Ubuntu-i386.IBMJVM.Errors  : Ubuntu / i386 / IBM JVM\n - 22.OpenJDK.Errors                     : Ubuntu / i386 / OpenJDK","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-19T13:56:34.129+0000","updated":"2015-06-19T13:56:34.129+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14593443","id":"14593443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"Class ./hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/crypto/CryptoOutputStream.java :\n\npublic void write(byte[] b, int off, int len) throws IOException {\n..........\n        encrypt();\n      }\n    }\n  }\n\nprivate void encrypt() throws IOException {\n .......\n\n    if (encryptor.isContextReset()) {\n      /*\n       * This code is generally not executed since the encryptor usually\n       * maintains encryption context (e.g. the counter) internally. However,\n       * some implementations can't maintain context so a re-init is necessary\n       * after each encryption call.\n       */\n      updateEncryptor();\n    }\n  }\n\nAfter adding many traces in the code, I've found that, on Ubuntu / i386 / OpenJDK, the updateEncryptor() method is never called from encrypt.\nOn AIX, I can see that encryptor.isContextReset() returns true and that updateEncryptor() is called.\n\nWhen I comment this      updateEncryptor();  line and rerun tests on AIX, the number of error fall from :\n     Failures: 5, Errors: 1,\nto:\n    Failures: 3, Errors: 1,\n\nSo, it looks to me that IBM JVM is a special case that is not correctly handled by Hadoop code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-19T14:04:11.902+0000","updated":"2015-06-19T14:04:11.902+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14593448","id":"14593448","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"What does the test code and how the issue appears:\n\nThe code creates a OutputStream (a file) where it writes bytes.\nThen, the test reads the file and must read an expected number of bytes.\n\nFile is:\n  hadoop-common-project/hadoop-common/target/test/data/work-dir/localfs/test-file\n\nThe issue appears as:\n@ readAll: 1 n= 8192 total= 3145728\n@ readAll: N off+total= 3153920 len-total= 23586\n@ readAll: 1 n= 8192 total= 3153920\n@ readAll: N off+total= 3162112 len-total= 15394\n@ readAll: 1 n= 8192 total= 3162112\n@ readAll: N off+total= 3170304 len-total= 7202\n@ readAll: 1 n= 7200 total= 3170304\n@ readAll: N off+total= 3177504 len-total= 2\n@ readAll: 1 n= -1 total= 3177504\n@ readAll: 2 n= -1 total= 3177504\n@ readAll: 0 b[len-100] 57\n@ readAll: 0 b[len-20] -64\n@ readAll: 0 b[len-10] 63\n@ readAll: 0 b[len-3] 35\n@ readAll: 0 b[len-2] 0\n@ readAll: 0 b[len-1] 0\n@ readCheck: n= 3177504 dataLen= 3177506\n\nIn that case, TWO bytes are missing in the file. Sometimes, it is 10, or 11, or anything else.\n\n\nTraces of CryptoOutputStream show:\n@ setUp: 2 dataLen = 3177506\n@ testCryptoIV: iv1.length= 16 iv.length= 16\n@ testCryptoIV: iv1= [B@3ec722c2 iv= [B@c12308c4 Long.MAX_VALUE= 9223372036854775807\n@ writeData: 0 out= org.apache.hadoop.crypto.CryptoOutputStream@fc8d9acd data.len= 5341184 dataLen= 3177506\n@ writeData: 0 data[len-100]= 57\n@ writeData: 0 data[len-20]= -64\n@ writeData: 0 data[len-10]= 63\n@ writeData: 0 data[len-5]= -69\n@ writeData: 0 data[len-4]= -118\n@ writeData: 0 data[len-3]= 35\n@ writeData: 0 data[len-2]= 123\n@ writeData: 0 data[len-1]= -46\n@ CryptoOutputStream.write: 0 off= 0 len= 3177506\n@ CryptoOutputStream.write: 1 len= 3177506 remaining= 8192\n@ CryptoOutputStream.write: N off= 8192 len= 3169314\n@ CryptoOutputStream.encrypt: 0 padding= 0 inBuffer.position()= 8192\n@ CryptoOutputStream.encrypt: 1 len=outBuffer.remaining()= 8192\n@ CryptoOutputStream.encrypt: 2 len= 8192 streamOffset= 8192\n...\n@ CryptoOutputStream.write: 1 len= 23586 remaining= 8192\n@ CryptoOutputStream.write: N off= 3162112 len= 15394\n@ CryptoOutputStream.encrypt: 0 padding= 0 inBuffer.position()= 8192\n@ CryptoOutputStream.encrypt: 1 len=outBuffer.remaining()= 8192\n@ CryptoOutputStream.encrypt: 2 len= 8192 streamOffset= 3162112\n@ CryptoOutputStream.write: 1 len= 15394 remaining= 8192\n@ CryptoOutputStream.write: N off= 3170304 len= 7202\n@ CryptoOutputStream.encrypt: 0 padding= 0 inBuffer.position()= 8192\n@ CryptoOutputStream.encrypt: 1 len=outBuffer.remaining()= 8192\n@ CryptoOutputStream.encrypt: 2 len= 8192 streamOffset= 3170304\n\n@ CryptoOutputStream.write: 1 len= 7202 remaining= 8192\n\n@ CryptoOutputStream.write: END len= 0 remaining= 8192\n\n@ CryptoOutputStream.encrypt: 3 before updateEncryptor() padding= 0\n@ CryptoOutputStream.encrypt: 3  after updateEncryptor() padding= 0\n\n@ getInputStream: 0 bufferSize= 8192 codec= org.apache.hadoop.crypto.JceAesCtrCryptoCodec@ed2e6f3a bufferSize= 8192\n\n\nTracing the size of the file from the Java code shows:\n-rw-r--r--    1 reixt    system      3166208 Jun 19 13:05 /home/reixt/HADOOP-2.6.0/hadoop-IBMSOE-branch-2.6.0-power/hadoop-common-project/hadoop-common/target/test/data/\nwork-dir/localfs/test-file\n-rw-r--r--    1 reixt    system      3166208 Jun 19 13:05 /home/reixt/HADOOP-2.6.0/hadoop-IBMSOE-branch-2.6.0-power/hadoop-common-project/hadoop-common/target/test/data/\nwork-dir/localfs/test-file\n-rw-r--r--    1 reixt    system      3166208 Jun 19 13:05 /home/reixt/HADOOP-2.6.0/hadoop-IBMSOE-branch-2.6.0-power/hadoop-common-project/hadoop-common/target/test/data/\nwork-dir/localfs/test-file\n-rw-r--r--    1 reixt    system      3166208 Jun 19 13:05 /home/reixt/HADOOP-2.6.0/hadoop-IBMSOE-branch-2.6.0-power/hadoop-common-project/hadoop-common/target/test/data/\nwork-dir/localfs/test-file\n-rw-r--r--    1 reixt    system      3174400 Jun 19 13:05 /home/reixt/HADOOP-2.6.0/hadoop-IBMSOE-branch-2.6.0-power/hadoop-common-project/hadoop-common/target/test/data/\nwork-dir/localfs/test-file\n-rw-r--r--    1 reixt    system      3177504 Jun 19 13:05 /home/reixt/HADOOP-2.6.0/hadoop-IBMSOE-branch-2.6.0-power/hadoop-common-project/hadoop-common/target/test/data/\nwork-dir/localfs/test-file\n\nFinal value is not the expected one: 3177506. Rather 3177504 with 2 missing bytes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-19T14:13:21.652+0000","updated":"2015-06-19T14:13:21.652+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14593455","id":"14593455","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"I would recommend you to run these tests on Linux/x86_64 with IBM JVM 1.7 .\nTake care that these tests are failing randomly on Linux/x86_64 with IBM JVM, though they fail constantly on AIX.\n\nmvn test -Dtest=org.apache.hadoop.crypto.TestCryptoStreamsForLocalFS -l mvn.Test.TestCryptoStreamsForLocalFS.res -fn -X\n\nYou can get the IBM JVM from here:\n           http://www.ibm.com/developerworks/java/jdk/aix/service.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-19T14:19:58.433+0000","updated":"2015-06-19T14:19:58.433+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14597584","id":"14597584","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"Since the issue deals more with IBM JVM than with AIX, I've changed the title of the defect.\nIt would be useful to test Hadoop with IBM JVM too, at least for these \"crypto\" tests.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-23T12:34:50.634+0000","updated":"2015-06-23T12:34:50.634+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14602588","id":"14602588","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"I think that the issue is there, when data is built:\n\n./hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/crypto/JceAesCtrCryptoCodec.java\n\n\n  private void process(ByteBuffer inBuffer, ByteBuffer outBuffer)\n        throws IOException {\n...\n >> HERE >>>       int n = cipher.update(inBuffer, outBuffer);\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: 0\" + \" n= \" + n + \" inputSize= \" + inputSize );\n        if (n < inputSize) {\n          /**\n           * Typically code will not get here. Cipher#update will consume all\n           * input data and put result in outBuffer.\n           * Cipher#doFinal will reset the crypto context.\n           */\n          contextReset = true;\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: 0\" + \" Typically code will not get here\" + \" contextReset= \" + contextReset);\n          cipher.doFinal(inBuffer, outBuffer);\n        }\n\nOn AIX, I get traces like:\n@ CryptoOutputStream.write: 1 len= 5283 remaining= 8192\n@ CryptoOutputStream.write: END len= 0 remaining= 8192\n@ CryptoOutputStream.encrypt: 0 padding= 0 inBuffer.position()= 5283\n@ CryptoOutputStream.encrypt: 01 encryptor.encrypt\n@ JceAesCtrCryptoCodec.encrypt: 0\n@ JceAesCtrCryptoCodec.process: 0 n= 5280 inputSize= 5283\n@ JceAesCtrCryptoCodec.process: 0 Typically code will not get here contextReset= true\n\nThough on Ubuntu/x86_64/OpenJDK, I get:\n@ CryptoOutputStream.write: END len= 0 remaining= 8192\n@ CryptoOutputStream.encrypt: 0 padding= 0 inBuffer.position()= 4149\n@ CryptoOutputStream.encrypt: 01 encryptor.encrypt\n@ JceAesCtrCryptoCodec.encrypt: 0\n@ JceAesCtrCryptoCodec.process: 0 n= 4149 inputSize= 4149\n\n\nAt the end of  CryptoOutputStream.write() , the line:\n              int n = cipher.update(inBuffer, outBuffer);\nreturns: n < inputSize on AIX/IBMJVM though with Linux/OpenJDK we have : n == inputSize .\n\nIt looks that cipher belongs to: javax.crypto.Cipher .\n\n\n\nMore traces :\n\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: BEFORE cipher.update\" + \" inBuffer= \" + inBuffer.toString() + \" outBuffer= \" + outBuffer.toString());\n        int n = cipher.update(inBuffer, outBuffer);\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: 0\" + \" n= \" + n + \" inputSize= \" + inputSize );\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: AFTER cipher.update\" + \" inBuffer= \" + inBuffer.toString() + \" outBuffer= \" + outBuffer.toString());\n\n\nAIX/IBM JVM:\n@ JceAesCtrCryptoCodec.process: BEFORE cipher.update\n        inBuffer  = java.nio.DirectByteBuffer[pos=0 lim=2634 cap=8192]\n        outBuffer= java.nio.DirectByteBuffer[pos=0 lim=8192 cap =8192]\n@ JceAesCtrCryptoCodec.process: 0 n= 2624 inputSize= 2634\n@ JceAesCtrCryptoCodec.process: AFTER  cipher.update\n        inBuffer  = java.nio.DirectByteBuffer[pos=2634 lim=2634 cap=8192]\n        outBuffer= java.nio.DirectByteBuffer[pos=2624 lim=8192 cap=8192]\n\n2624 instead of 2634 !!!\n\n\nOpenJDK:\n@ JceAesCtrCryptoCodec.process: BEFORE cipher.update\n        inBuffer  = java.nio.DirectByteBuffer[pos=0 lim=7623 cap=8192]\n        outBuffer= java.nio.DirectByteBuffer[pos=0 lim=8192 cap=8192]\n@ JceAesCtrCryptoCodec.process: 0 n= 7623 inputSize= 7623\n@ JceAesCtrCryptoCodec.process: AFTER  cipher.update\n        inBuffer  = java.nio.DirectByteBuffer[pos=7623 lim=7623 cap=8192]\n        outBuffer= java.nio.DirectByteBuffer[pos=7623 lim=8192 cap=8192]\n\n\nYes, cipher.update(inBuffer, outBuffer) does not work fine with IBM JVM.\n\nHowever, I do not know the expected behavior of Cypher.update() .\nMaybe not returning  n==inputSize  is a correct - but rare - behavior, and Hadoop code is not handling correctly this rare case since it has never been tested with IBM JVM ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-26T08:57:27.689+0000","updated":"2015-06-26T08:57:27.689+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14602880","id":"14602880","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"Adding some more traces arount doFinal() :\n\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: 1\" + \" Typically code will not get here\" + \" contextReset= \" + contextReset);\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: BEFORE cipher.doFinal\" + \" inBuffer= \" + inBuffer.toString() + \" outBuffer= \" +  outBuffer.toString());\n          int m = cipher.doFinal(inBuffer, outBuffer);\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: 0\" + \" m= \" + m );\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: AFTER cipher.doFinal\" + \" inBuffer= \" + inBuffer.toString() + \" outBuffer= \" +  outBuffer.toString());\n\n\n I've got:\n\n@ CryptoOutputStream.encrypt:\n  inBuffer  = java.nio.DirectByteBuffer[pos=0 lim=3235 cap=8192]\n  outBuffer= java.nio.DirectByteBuffer[pos=0 lim=8192 cap=8192]\n@ JceAesCtrCryptoCodec.encrypt: 0\n@ JceAesCtrCryptoCodec.process: BEFORE cipher.update\n  inBuffer  = java.nio.DirectByteBuffer[pos=0 lim=3235 cap=8192]\n  outBuffer= java.nio.DirectByteBuffer[pos=0 lim=8192 cap=8192]\n\n@ JceAesCtrCryptoCodec.process: 0 n= 3232 inputSize= 3235\n\n@ JceAesCtrCryptoCodec.process: AFTER  cipher.update\n  inBuffer  = java.nio.DirectByteBuffer[pos=3235 lim=3235 cap=8192]\n  outBuffer= java.nio.DirectByteBuffer[pos=3232 lim=8192 cap=8192]\n\n@ JceAesCtrCryptoCodec.process: 1 Typically code will not get here\n               contextReset= true\n@ JceAesCtrCryptoCodec.process: BEFORE cipher.doFinal\n  inBuffer  = java.nio.DirectByteBuffer[pos=3235 lim=3235 cap=8192]\n  outBuffer= java.nio.DirectByteBuffer[pos=3232 lim=8192 cap=8192]\n\n@ JceAesCtrCryptoCodec.process: 0 m= 0\n\n@ JceAesCtrCryptoCodec.process: AFTER  cipher.doFinal\n  inBuffer  = java.nio.DirectByteBuffer[pos=3235 lim=3235 cap=8192]\n  outBuffer= java.nio.DirectByteBuffer[pos=3232 lim=8192 cap=8192]\n\n\ndoFinal() did NOTHING\n\nMaybe because inBuffer : [pos=3235 == lim=3235 ?!?!!\n  Nothing to do ?\n\nCipher.doFinal()) documentation says:\n\"All input.remaining() bytes starting at input.position() are processed.\n ... Upon return, the input buffer's position will be equal to its\nlimit; its limit will not have changed. The output buffer's position\nwill have advanced by n, where n is the value returned by this method;\nthe output buffer's limit will not have changed. \"","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-26T13:35:40.701+0000","updated":"2015-06-26T13:35:40.701+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14602881","id":"14602881","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"Adding : inBuffer.position(n);  where n comes from last cipher.update()\ndid fix something:\n\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: BEFORE cipher.doFinal\" + \" inBuffer= \" + inBuffer.toString() + \" outBuffer= \" +  outBuffer.toString());\n        inBuffer.position(n);\n          int m = cipher.doFinal(inBuffer, outBuffer);\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: 0\" + \" m= \" + m );\nSystem.out.println(\"@ JceAesCtrCryptoCodec.process: AFTER cipher.doFinal\" + \" inBuffer= \" + inBuffer.toString() + \" outBuffer= \" +  outBuffer.toString());\n\nTraces from Maven are:\nError: java.lang.AssertionError: expected:<3206307> but was:<3206304>\nwas moved in: java.lang.AssertionError: expected:<18> but was:<-1>\n\nTraces from Java code are:\n@ JceAesCtrCryptoCodec.process: 1 Typically code will not get here          contextReset= true\n@ JceAesCtrCryptoCodec.process: BEFORE cipher.doFinal\n  inBuffer  = java.nio.DirectByteBuffer[pos=6956 lim=6956 cap=8192]\n  outBuffer= java.nio.DirectByteBuffer[pos=6944 lim=8192 cap=8192]\n@ JceAesCtrCryptoCodec.process: 0 m= 24\n@ JceAesCtrCryptoCodec.process: AFTER  cipher.doFinal\n  inBuffer  = java.nio.DirectByteBuffer[pos=6956 lim=6956 cap=8192]\n  outBuffer= java.nio.DirectByteBuffer[pos=6968 lim=8192 cap=8192]\n\nand check is now OK :\n@ readCheck: n= 3177254 dataLen= 3177254","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-26T13:36:31.793+0000","updated":"2015-06-26T13:36:31.793+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14605373","id":"14605373","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"I have opened a defect against IBM JVM. Their answer, for now, is that they see NO issue there within their code.\nI need someone from Hadoop to help me about this complex issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-29T10:06:01.786+0000","updated":"2015-06-29T10:06:01.786+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14605374","id":"14605374","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"Component: I've said: \"secutity\". However, \"encryption\" would be better I think, but it is not proposed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-29T10:08:44.124+0000","updated":"2015-06-29T10:08:44.124+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12839136/comment/14636789","id":"14636789","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"body":"Issue was in the IBM JVM. Some rare and subtle case that was fixed in OpenJDK and not in IBM JVM.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=trex58","name":"trex58","key":"trex58","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tony Reix","active":true,"timeZone":"Etc/UTC"},"created":"2015-07-22T12:15:42.720+0000","updated":"2015-07-22T12:15:42.720+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-12106/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2g9lr:"}}