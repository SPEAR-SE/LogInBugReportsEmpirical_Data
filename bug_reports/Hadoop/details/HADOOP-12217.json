{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12844236","self":"https://issues.apache.org/jira/rest/api/2/issue/12844236","key":"HADOOP-12217","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-07-10T19:51:59.511+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jul 13 00:59:31 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-12217/watchers","watchCount":3,"isWatching":false},"created":"2015-07-10T17:46:48.245+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["easyfix"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312972","id":"12312972","description":"","name":"0.18.0","archived":false,"released":true,"releaseDate":"2008-08-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313357","id":"12313357","description":"","name":"0.18.1","archived":false,"released":true,"releaseDate":"2008-09-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313424","id":"12313424","description":"","name":"0.18.2","archived":false,"released":true,"releaseDate":"2008-11-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313494","id":"12313494","description":"","name":"0.18.3","archived":false,"released":true,"releaseDate":"2009-01-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313211","id":"12313211","description":"","name":"0.19.0","archived":false,"released":true,"releaseDate":"2008-11-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313473","id":"12313473","description":"","name":"0.19.1","archived":false,"released":true,"releaseDate":"2009-02-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313438","id":"12313438","description":"","name":"0.20.0","archived":false,"released":true,"releaseDate":"2009-04-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313866","id":"12313866","description":"","name":"0.20.1","archived":false,"released":true,"releaseDate":"2009-09-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314203","id":"12314203","description":"","name":"0.20.2","archived":false,"released":true,"releaseDate":"2010-02-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316064","id":"12316064","description":"Security for hadoop-0.20","name":"0.20.203.0","archived":false,"released":true,"releaseDate":"2011-05-11"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316317","id":"12316317","description":"","name":"0.20.204.0","archived":false,"released":true,"releaseDate":"2011-09-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316390","id":"12316390","description":"Merge append/sync support with security","name":"0.20.205.0","archived":false,"released":true,"releaseDate":"2011-10-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12318244","id":"12318244","description":"1.0.0 release","name":"1.0.0","archived":false,"released":true,"releaseDate":"2011-12-27"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12319501","id":"12319501","description":"maintenance release on branch-1.0","name":"1.0.1","archived":false,"released":true,"releaseDate":"2012-02-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12320152","id":"12320152","description":"maintenance release on branch-1.0","name":"1.0.2","archived":false,"released":true,"releaseDate":"2012-04-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12320248","id":"12320248","description":"maintenance release on branch-1.0","name":"1.0.3","archived":false,"released":true,"releaseDate":"2012-05-07"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323324","id":"12323324","description":"maintenance release on branch-1.0","name":"1.0.4","archived":false,"released":true,"releaseDate":"2012-10-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316501","id":"12316501","description":"1.1.0 release","name":"1.1.0","archived":false,"released":true,"releaseDate":"2012-10-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321658","id":"12321658","description":"maintenance release on branch-1.1","name":"1.1.1","archived":false,"released":true,"releaseDate":"2012-11-27"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321659","id":"12321659","description":"1.2.0 release","name":"1.2.0","archived":false,"released":true,"releaseDate":"2013-05-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313563","id":"12313563","description":"","name":"0.21.0","archived":false,"released":true,"releaseDate":"2010-08-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314296","id":"12314296","description":"","name":"0.22.0","archived":false,"released":true,"releaseDate":"2011-12-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315569","id":"12315569","description":"","name":"0.23.0","archived":false,"released":true,"releaseDate":"2011-11-11"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12318884","id":"12318884","description":"0.23.1 - Performance release ","name":"0.23.1","archived":false,"released":true,"releaseDate":"2012-02-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12320059","id":"12320059","description":"0.23.3","name":"0.23.3","archived":false,"released":true,"releaseDate":"2012-09-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12320352","id":"12320352","description":"hadoop-2.0.0-alpha release","name":"2.0.0-alpha","archived":false,"released":true,"releaseDate":"2012-05-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12322467","id":"12322467","description":"2.0.1-alpha release","name":"2.0.1-alpha","archived":false,"released":true,"releaseDate":"2012-07-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12322473","id":"12322473","description":"2.0.2-alpha release","name":"2.0.2-alpha","archived":false,"released":true,"releaseDate":"2012-10-09"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323265","id":"12323265","description":"0.23.4","name":"0.23.4","archived":false,"released":true,"releaseDate":"2012-10-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323273","id":"12323273","description":"2.0.3-alpha release","name":"2.0.3-alpha","archived":false,"released":true,"releaseDate":"2013-02-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323314","id":"12323314","description":"0.23.5 release","name":"0.23.5","archived":false,"released":true,"releaseDate":"2012-11-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323504","id":"12323504","description":"0.23.6 release","name":"0.23.6","archived":false,"released":true,"releaseDate":"2013-02-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323596","id":"12323596","description":"maintenance release on branch-1.1","name":"1.1.2","archived":false,"released":true,"releaseDate":"2013-02-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323956","id":"12323956","description":"0.23.7 release","name":"0.23.7","archived":false,"released":true,"releaseDate":"2013-04-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324030","id":"12324030","description":"2.1.0-beta release","name":"2.1.0-beta","archived":false,"released":true,"releaseDate":"2013-08-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324135","id":"12324135","description":"2.0.4-alpha bug-fix release","name":"2.0.4-alpha","archived":false,"released":true,"releaseDate":"2013-04-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324142","id":"12324142","description":"0.23.8 release","name":"0.23.8","archived":false,"released":true,"releaseDate":"2013-06-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324147","id":"12324147","description":"maintenance release on branch-1.2","name":"1.2.1","archived":false,"released":true,"releaseDate":"2013-08-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324426","id":"12324426","description":"maintenance release on branch-2.0-alpha","name":"2.0.5-alpha","archived":false,"released":true,"releaseDate":"2013-06-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324562","id":"12324562","description":"0.23.9 release","name":"0.23.9","archived":false,"released":true,"releaseDate":"2013-07-08"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324664","id":"12324664","description":"0.23.10 release","name":"0.23.10","archived":false,"released":true,"releaseDate":"2013-12-09"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324665","id":"12324665","description":"0.23.11 release","name":"0.23.11","archived":false,"released":true,"releaseDate":"2014-06-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324807","id":"12324807","description":"2.1.1-beta bug-fix release","name":"2.1.1-beta","archived":false,"released":true,"releaseDate":"2013-09-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324810","id":"12324810","description":"2.0.6-alpha bug-fix release","name":"2.0.6-alpha","archived":false,"released":true,"releaseDate":"2013-08-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12325048","id":"12325048","description":"2.2.0 release","name":"2.2.0","archived":false,"released":true,"releaseDate":"2013-10-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12325254","id":"12325254","description":"2.3.0 release","name":"2.3.0","archived":false,"released":true,"releaseDate":"2014-02-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326144","id":"12326144","description":"2.4.0 release","name":"2.4.0","archived":false,"released":true,"releaseDate":"2014-04-07"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326263","id":"12326263","description":"2.5.0 release","name":"2.5.0","archived":false,"released":true,"releaseDate":"2014-08-11"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326695","id":"12326695","description":"2.4.1 bug-fix release","name":"2.4.1","archived":false,"released":true,"releaseDate":"2014-06-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12327745","id":"12327745","description":"2.5.1 release","name":"2.5.1","archived":false,"released":true,"releaseDate":"2014-09-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12328969","id":"12328969","description":"2.5.2 release","name":"2.5.2","archived":false,"released":true,"releaseDate":"2014-11-19"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12327179","id":"12327179","description":"2.6.0 release","name":"2.6.0","archived":false,"released":true,"releaseDate":"2014-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12327583","id":"12327583","description":"2.7.0 release","name":"2.7.0","archived":false,"released":true,"releaseDate":"2015-04-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12331977","id":"12331977","description":"2.7.1 release","name":"2.7.1","archived":false,"released":true,"releaseDate":"2015-07-06"}],"issuelinks":[{"id":"12433779","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12433779","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12853136","key":"HIVE-11502","self":"https://issues.apache.org/jira/rest/api/2/issue/12853136","fields":{"summary":"Map side aggregation is extremely slow","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-08-10T08:20:46.058+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310687","id":"12310687","name":"io","description":""}],"timeoriginalestimate":null,"description":"Because DoubleWritable.hashCode() is incorrect, using DoubleWritables as the keys in a HashMap results in abysmal performance, due to hash code collisions.\n\nI discovered this when testing the latest version of Hive and certain mapjoin queries were exceedingly slow.\n\nEvidently, Hive has its own wrapper/subclass around Hadoop's DoubleWritable that overrode used to override hashCode() with a correct implementation, but for some reason they recently removed that code, so it now uses the incorrect hashCode() method inherited from Hadoop's DoubleWritable.\n\nIt appears that this bug has been there since DoubleWritable was created(wow!) so I can understand if fixing it is impractical due to the possibility of breaking things down-stream, but I can't think of anything that *should* break, off the top of my head.\n\nSearching JIRA, I found several related tickets, which may be useful for some historical perspective: HADOOP-3061, HADOOP-3243, HIVE-511, HIVE-1629, HIVE-7041","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12744896","id":"12744896","filename":"HADOOP-12217.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"created":"2015-07-11T17:52:35.437+0000","size":688,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12744896/HADOOP-12217.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"hashCode in DoubleWritable returns same value for many numbers","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12844236/comment/14622817","id":"14622817","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"[~sscaffidi]: I think I hit this earlier and changing this broke the hive bucketing (which uses hash as is to decide filenames).\n\nYou should probably look into why you're not able to take advantage of HIVE-6924","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-07-10T19:51:59.511+0000","updated":"2015-07-10T19:51:59.511+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12844236/comment/14623484","id":"14623484","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"body":"Looks like the MapJoinKeyBytes class was removed as part of HIVE-9331 (git commit c8ba0f96, 2015-01-15). In my testing, I found Cloudera's distro of Hive 1.1 was using MapJoinKeyObject, which makes sense, but I've been looking through both their patched Hive code as well as master/trunk from upstream and I don't see anything significant they changed from upstream that's related to this.\n\n\nI'm still trying to suss out another part of the issue that led me to finding the bug I reported here: In my affected Hive queries, which join a STRING column (from the large table) with an INT column (from the small table that is used for the mapjoin hashtable), Hive is converting the STRING and the INT into DOUBLE for the purpose of the join, which, AFAICT, is a change in behavior since Hive 0.13. Because the values I'm joining on are all fairly small integers (about 160,000 values, ranging from 1 to 999,999), the bad hashCode implementation for DoubleWritable causes the HashMap Hive builds in the local task to degenerate into a linked-list that is both exceedingly slow to build as well as load in the subsequent map tasks. :(\n\nOn the other hand, the conversion to a DOUBLE to do the comparison makes sense given the table of implicit conversions in the documentation - it seems to me that the old behavior must have been incorrect and has since been \"fixed\" :) Unfortunately I have too many users with too many queries that depend on the performance of the old behavior - it's easier for me to patch Hadoop or Hive!\n\nOnce I figure out where/why Hive's behavior changed, I'll file a ticket there, too, if necessary, hopefully with useful patches :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"created":"2015-07-11T16:50:42.053+0000","updated":"2015-07-11T16:50:42.053+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12844236/comment/14623500","id":"14623500","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"body":"Oh! Also, using Murmur Hash here would not help, since the root of the problem is related to getting the hashCode of an object representing a number, which should (usually) involve simply using the number itself - typically a highly performant operation. For numeric types whose representation is larger than an int (32 bits), a typical solution is to simply \"or\" the number by itself, shifted by 32 bits, repeating until you have only 32 bits left, then return that value.\n\nLuckily this operation is not only extremely cheap to perform, it's already built-in to Java's Double class, and documented here for those who might need to know how it's done:\n  http://docs.oracle.com/javase/7/docs/api/java/lang/Double.html#hashCode%28%29\n\nAs the hashCode method in DoubleWritable currently does, for whole numbers between +/-MAX_INT (more or less), casting a double's bitwise representation to an int removes almost all of the significant (in the sense of significant to representing the desired numerical value) bits! The implementation at the link above does the right thing, and provides far better distribution for assigning buckets in a HashMap.\n\nI would personally want to find out why fixing hashCode() in Hadoop's DoubleWritable breaks bucketing in Hive - I have some suspicions as to how that might happen, but I would need more info about exactly what you found.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"created":"2015-07-11T17:44:43.725+0000","updated":"2015-07-11T17:44:43.725+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12844236/comment/14623503","id":"14623503","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"body":"This is the simplest fix that does not create a Double object to calculate a correct hashCode. I have not yet tested this in a production-level environment, though. I can add some tests to show effectiveness of the hashCode distribution if desired.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"created":"2015-07-11T17:51:29.599+0000","updated":"2015-07-11T17:51:29.599+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12844236/comment/14623504","id":"14623504","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"body":"This is the simplest fix that does not create a Double object to calculate a correct hashCode. I have not yet tested this in a production-level environment, though. I can add some tests to show the effectiveness of the hashCode distribution if desired.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sscaffidi","name":"sscaffidi","key":"sscaffidi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Steve Scaffidi","active":true,"timeZone":"America/New_York"},"created":"2015-07-11T17:52:35.442+0000","updated":"2015-07-11T17:52:35.442+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12844236/comment/14623523","id":"14623523","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"\\\\\n\\\\\n| (x) *{color:red}-1 overall{color}* |\n\\\\\n\\\\\n|| Vote || Subsystem || Runtime || Comment ||\n| {color:blue}0{color} | pre-patch |  16m 24s | Pre-patch trunk compilation is healthy. |\n| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |\n| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |\n| {color:green}+1{color} | javac |   7m 33s | There were no new javac warning messages. |\n| {color:green}+1{color} | javadoc |   9m 33s | There were no new javadoc warning messages. |\n| {color:green}+1{color} | release audit |   0m 23s | The applied patch does not increase the total number of release audit warnings. |\n| {color:green}+1{color} | checkstyle |   1m  6s | There were no new checkstyle issues. |\n| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |\n| {color:green}+1{color} | install |   1m 19s | mvn install still works. |\n| {color:green}+1{color} | eclipse:eclipse |   0m 34s | The patch built with eclipse:eclipse. |\n| {color:green}+1{color} | findbugs |   1m 53s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |\n| {color:green}+1{color} | common tests |  22m 22s | Tests passed in hadoop-common. |\n| | |  61m 10s | |\n\\\\\n\\\\\n|| Subsystem || Report/Notes ||\n| Patch URL | http://issues.apache.org/jira/secure/attachment/12744896/HADOOP-12217.1.patch |\n| Optional Tests | javadoc javac unit findbugs checkstyle |\n| git revision | trunk / 1df39c1 |\n| hadoop-common test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/7247/artifact/patchprocess/testrun_hadoop-common.txt |\n| Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/7247/testReport/ |\n| Java | 1.7.0_55 |\n| uname | Linux asf906.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |\n| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/7247/console |\n\n\nThis message was automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2015-07-11T19:01:58.241+0000","updated":"2015-07-11T19:01:58.241+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12844236/comment/14624087","id":"14624087","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"body":"bq. I would personally want to find out why fixing hashCode() in Hadoop's DoubleWritable breaks bucketing in Hive - I have some suspicions as to how that might happen, but I would need more info about exactly what you found.\n\nTouching the hashcode of any Writable breaks existing distributions in Hive - the hash is used to distribute data to satisfy the BUCKETED BY operations in DDLs.\n\nThe bucket map-joins and sorted-merge joins will give incorrect results after you do something like this, because data will end up in different buckets for the old and new data, when you upgrade hadoop.\n\nTake a look at what happened to Varchar for instance - HIVE-8488\n\nbq. Luckily this operation is not only extremely cheap to perform,\n\nThe new Optimized hashtable does *NOT* use the Writable::hashCode(), instead uses a post-serialization hashcode (i.e murmur hash of the byte[] formed out of the BinarySortableSerde). This is because allocating objects in the inner loop results in allocator churn and frequent GC  pauses - so it is cheaper to never allocate a Double/DoubleWritable, particularly when they're going to be an L1 cache miss (Writable -> Double -> double).\n\nThe use of murmur came in as part of the L1 cache optimized hashtable in hive 0.14 (though it was committed the same month that 0.13 came out), which allows us to pack about ~6x the number of k-v pairs in the same amount of memory (DoubleWritable is way bigger than 8 bytes).\n\nbq.  Once I figure out where/why Hive's behavior changed, I'll file a ticket there, too, if necessary, hopefully with useful patches \n\nPlease try the same queries in Tez mode and see whether you're hitting the same issues - I suspect the core performance issues in MRv2 mode have mostly no recourse, because they can't readjust during runtime (which is what the L1 cache optimized hash-join does).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gopalv","name":"gopalv","key":"gopalv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gopal V","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-07-13T00:59:31.960+0000","updated":"2015-07-13T00:59:31.960+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-12217/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2h44v:"}}