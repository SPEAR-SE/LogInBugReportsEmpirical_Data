{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13090459","self":"https://issues.apache.org/jira/rest/api/2/issue/13090459","key":"HADOOP-14691","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-07-27T20:11:22.769+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Aug 09 12:44:36 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":0,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-14691/watchers","watchCount":6,"isWatching":false},"created":"2017-07-27T09:05:25.998+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["close","filesystem","hadoop","multi"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":259200,"aggregatetimeoriginalestimate":259200,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334005","id":"12334005","description":"2.7.3 release","name":"2.7.3","archived":false,"released":true,"releaseDate":"2016-08-25"}],"issuelinks":[{"id":"12511442","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12511442","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12426715","key":"HADOOP-5943","self":"https://issues.apache.org/jira/rest/api/2/issue/12426715","fields":{"summary":"IOUtils#copyBytes methods should not close streams that are passed in as parameters","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-08-09T12:44:36.931+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12330961","id":"12330961","name":"common"}],"timeoriginalestimate":259200,"description":"1.\tBug description\nShell command “Hadoop fs -put” is a write operation. In this process, FSDataOutputStream is new created and closed lastly. Finally, the FSDataOutputStream.close() calls the close method in HDFS to end up the communication of this write process between the server and client.\nWith the command “Hadoop fs -put”, for each created FSDataOutputStream object, FSDataOutputStream.close() is called twice, which means the close method, in the underlying distributed file system, is called twice. This is the error, that’s because the communication process, for example socket, might be repeated shut down. Unfortunately, if there is no error protection for the socket, there might be error for the socket in the second close. \nFurther, we think a correct upper file system design should keep the one time close principle. It means that each creation of underlying distributed file system object should correspond with close only once. \nFor the command “Hadoop fs -put”, there are double close as follows:\na.\tThe first close process:\nat org.apache.hadoop.fs.FSDataOutputStream$PositionCache.close(FSDataOutputStream.java:72)\nat org.apache.hadoop.fs.FSDataOutputStream.close(FSDataOutputStream.java:106)\nat org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:61)\nat org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:119)\nat org.apache.hadoop.fs.shell.CommandWithDestination$TargetFileSystem.writeStreamToFile(CommandWithDestination.java:466)\nat org.apache.hadoop.fs.shell.CommandWithDestination.copyStreamToTarget(CommandWithDestination.java:391)\nat org.apache.hadoop.fs.shell.CommandWithDestination.copyFileToTarget(CommandWithDestination.java:328)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPath(CommandWithDestination.java:263)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPath(CommandWithDestination.java:248)\nat org.apache.hadoop.fs.shell.Command.processPaths(Command.java:317)\nat org.apache.hadoop.fs.shell.Command.processPathArgument(Command.java:289)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPathArgument(CommandWithDestination.java:243)\nat org.apache.hadoop.fs.shell.Command.processArgument(Command.java:271)\nat org.apache.hadoop.fs.shell.Command.processArguments(Command.java:255)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processArguments(CommandWithDestination.java:220)\nat org.apache.hadoop.fs.shell.CopyCommands$Put.processArguments(CopyCommands.java:267)\nat org.apache.hadoop.fs.shell.Command.processRawArguments(Command.java:201)\nat org.apache.hadoop.fs.shell.Command.run(Command.java:165)\nat org.apache.hadoop.fs.FsShell.run(FsShell.java:287)\nat org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:70)\nat org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:84)\nat org.apache.hadoop.fs.FsShell.main(FsShell.java:340)\n\nb.\tThe second close process:\nat org.apache.hadoop.fs.FSDataOutputStream$PositionCache.close(FSDataOutputStream.java:72)\nat org.apache.hadoop.fs.FSDataOutputStream.close(FSDataOutputStream.java:106)\nat org.apache.hadoop.io.IOUtils.cleanup(IOUtils.java:244)\nat org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:261)\nat org.apache.hadoop.fs.shell.CommandWithDestination$TargetFileSystem.writeStreamToFile(CommandWithDestination.java:468)\nat org.apache.hadoop.fs.shell.CommandWithDestination.copyStreamToTarget(CommandWithDestination.java:391)\nat org.apache.hadoop.fs.shell.CommandWithDestination.copyFileToTarget(CommandWithDestination.java:328)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPath(CommandWithDestination.java:263)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPath(CommandWithDestination.java:248)\nat org.apache.hadoop.fs.shell.Command.processPaths(Command.java:317)\nat org.apache.hadoop.fs.shell.Command.processPathArgument(Command.java:289)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPathArgument(CommandWithDestination.java:243)\nat org.apache.hadoop.fs.shell.Command.processArgument(Command.java:271)\nat org.apache.hadoop.fs.shell.Command.processArguments(Command.java:255)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processArguments(CommandWithDestination.java:220)\nat org.apache.hadoop.fs.shell.CopyCommands$Put.processArguments(CopyCommands.java:267)\nat org.apache.hadoop.fs.shell.Command.processRawArguments(Command.java:201)\nat org.apache.hadoop.fs.shell.Command.run(Command.java:165)\nat org.apache.hadoop.fs.FsShell.run(FsShell.java:287)\nat org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:70)\nat org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:84)\nat org.apache.hadoop.fs.FsShell.main(FsShell.java:340)\n\n2.\tCode analysis\nvoid writeStreamToFile(InputStream in, PathData target, boolean lazyPersist) throws IOException {\n    FSDataOutputStream out = null;\n\n    try {\n        out = this.create(target, lazyPersist);\n        IOUtils.copyBytes(in, out, this.getConf(), true);\n    } finally {\n        IOUtils.closeStream(out);\n    }\n\n}\n\npublic static void copyBytes(InputStream in, OutputStream out, int buffSize, boolean close) throws IOException {\n    try {\n        copyBytes(in, out, buffSize);\n        if(close) {\n            out.close();\n            out = null;\n            in.close();\n            in = null;\n        }\n    } finally {\n        if(close) {\n            closeStream(out);\n            closeStream(in);\n        }\n    }\n}\n\nThe problem is caused by these two methods. \nFSDataOutputStream out is defined in the method writeStreamToFile, and it is a input parameter of copyBytes. When an object is as an input parameter of a API, it equals to a new reference in this API. It points to the same address with the external API. In the API copyBytes(), the code “out = null” means that within this API, the reference object out points to the address null, but it doesn’t change the external reference object’s address value. As a result, “out = null” is only valid for “closeStream(out)” in copyBytes(), so for” IOUtils.closeStream(out)”  in writeStreamToFile (), out is not null in the normal process. That’s why there are double close calls.\n\n3.\tSolution\na.\tSuggest solution:\nFor the input object in an API, it is not suitable to set it as null within this API. It should to be set in its defined API. And for this problem, the parameter “Boolean close” seems unsuitable. The close operation should be written in the definition API of “FSDataOutputStream out”. \nThis problem is also occurred for “FSDataInputStream in” which is defined in copyFileToTarget().\nThis modification solution could solve this problem thoroughly. And it makes the design to be more suitable for the file system.\nHowever, with this modification solution, there are many related code for this process. Only the “public static void copyBytes(InputStream in, OutputStream out, int buffSize, boolean close)”, there are 16 calls of this method. Considering the call path through “copyFileToTarget()” to “copyBytes()” and related tests to submit the patch, it will be a huge work for us. We use the above workaround solution to test our idea.\n\nb.\tOur workaround solution:\nOur solution is to add a return value to record the close status of out and in. If it has been closed, it won’t be re-closed in the external API. \nThis solution could make sure the out and in are closed only once easily.\nThe details could refer to the patch. It shows the least modification for this “Hadoop fs -put” command with this solution.\n","customfield_10010":null,"timetracking":{"originalEstimate":"72h","remainingEstimate":"72h","originalEstimateSeconds":259200,"remainingEstimateSeconds":259200},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12880516","id":"12880516","filename":"CommandWithDestination.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-05T06:51:07.246+0000","size":2709,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12880516/CommandWithDestination.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12879143","id":"12879143","filename":"hadoop_common_unit_test_result_after_modification.docx","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-27T09:09:51.336+0000","size":27936,"mimeType":"application/vnd.openxmlformats-officedocument.wordprocessingml.document","content":"https://issues.apache.org/jira/secure/attachment/12879143/hadoop_common_unit_test_result_after_modification.docx"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12879142","id":"12879142","filename":"hadoop_common_unit_test_result_before_modification.docx","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-27T09:09:51.448+0000","size":27936,"mimeType":"application/vnd.openxmlformats-officedocument.wordprocessingml.document","content":"https://issues.apache.org/jira/secure/attachment/12879142/hadoop_common_unit_test_result_before_modification.docx"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12880515","id":"12880515","filename":"IOUtils.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-05T06:51:07.302+0000","size":2049,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12880515/IOUtils.patch"}],"aggregatetimeestimate":259200,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Shell command \"hadoop fs -put\" multiple close problem","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":259200,"percent":0},"customfield_12311024":null,"environment":"CentOS7.0\nJDK1.8.0_121\nhadoop2.7.3","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10430","value":"Patch","id":"10430"},{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10431","value":"Important","id":"10431"}],"progress":{"progress":0,"total":259200,"percent":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13090459/comment/16103829","id":"16103829","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~Eric88] thanks for the detailed report!\nIt seems what you discovered is similar to HDFS-10429. \n\nI have not yet reviewed the patch in depth, but it looks like your patch contains irrelevant stuff. Could you remove them and rebase against trunk? Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-07-27T20:11:22.769+0000","updated":"2017-07-27T20:11:34.945+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13090459/comment/16115303","id":"16115303","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"body":"Delete the unnecessary context in patch and re-patch based on each single file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-05T06:52:09.539+0000","updated":"2017-08-05T06:52:09.539+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13090459/comment/16115304","id":"16115304","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"body":"Hi Wei-Chiu Chuang,\nThanks for your comments very much!\nPlease help to review the new patches.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Eric88","name":"Eric88","key":"eric88","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Lei","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-05T06:55:25.054+0000","updated":"2017-08-05T06:55:25.054+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13090459/comment/16115306","id":"16115306","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jzhuge","name":"jzhuge","key":"jzhuge","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jzhuge&avatarId=31264","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jzhuge&avatarId=31264","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jzhuge&avatarId=31264","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jzhuge&avatarId=31264"},"displayName":"John Zhuge","active":true,"timeZone":"America/Los_Angeles"},"body":"[~Eric88] Thanks for reporting the issue and working on patch! I added you as a Hadoop Contributor and assigned the JIRA to you. Please read https://wiki.apache.org/hadoop/HowToContribute and name the patch properly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jzhuge","name":"jzhuge","key":"jzhuge","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jzhuge&avatarId=31264","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jzhuge&avatarId=31264","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jzhuge&avatarId=31264","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jzhuge&avatarId=31264"},"displayName":"John Zhuge","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-05T06:58:51.389+0000","updated":"2017-08-05T06:58:51.389+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13090459/comment/16115457","id":"16115457","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\n\\\\\n\\\\\n|| Vote || Subsystem || Runtime || Comment ||\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m  0s{color} | {color:blue} Docker mode activated. {color} |\n| {color:red}-1{color} | {color:red} patch {color} | {color:red}  0m  4s{color} | {color:red} HADOOP-14691 does not apply to trunk. Rebase required? Wrong Branch? See https://wiki.apache.org/hadoop/HowToContribute for help. {color} |\n\\\\\n\\\\\n|| Subsystem || Report/Notes ||\n| JIRA Issue | HADOOP-14691 |\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12880516/CommandWithDestination.patch |\n| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/12964/console |\n| Powered by | Apache Yetus 0.6.0-SNAPSHOT   http://yetus.apache.org |\n\n\nThis message was automatically generated.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-05T17:02:22.438+0000","updated":"2017-08-05T17:02:22.438+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13090459/comment/16118303","id":"16118303","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boky01","name":"boky01","key":"boky01","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boky01&avatarId=29244","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boky01&avatarId=29244","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boky01&avatarId=29244","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boky01&avatarId=29244"},"displayName":"Andras Bokor","active":true,"timeZone":"Europe/Budapest"},"body":"It's a very good catch but the solution seems makes the things more complicated and it is not backward-compatible since we change the signature of a method.\nInstead, I suggest fixing HADOOP-5943. Using try-with-resources at the same place where the resource is created seems a better practice and used widely in Java world.\nWe can introduce the new methods without closing ability and keep the old ones as deprecated to keep the compatibility. I am happy to send a patch for HADOOP-5943.\nThoughts?\n\nP.s.: I am removing the linked issue since it is not related to the exception in HDFS-10429.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boky01","name":"boky01","key":"boky01","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boky01&avatarId=29244","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boky01&avatarId=29244","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boky01&avatarId=29244","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boky01&avatarId=29244"},"displayName":"Andras Bokor","active":true,"timeZone":"Europe/Budapest"},"created":"2017-08-08T12:59:47.102+0000","updated":"2017-08-08T14:02:13.023+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13090459/comment/16119087","id":"16119087","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jzhuge","name":"jzhuge","key":"jzhuge","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jzhuge&avatarId=31264","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jzhuge&avatarId=31264","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jzhuge&avatarId=31264","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jzhuge&avatarId=31264"},"displayName":"John Zhuge","active":true,"timeZone":"America/Los_Angeles"},"body":"Can we just add {{out = null}} after {{out.close()}} to ensure no-op to close a closed stream?\n{code:java|title=FSDataOutputStream.PositionCache#close}\n    @Override\n    public void close() throws IOException {\n      // ensure close works even if a null reference was passed in\n      if (out != null) {\n        out.close();\n        out = null;      <<<<<==\n      }\n    }\n{code}\n\n{code:java|title=FSDataOutputStream#close}\n  public void close() throws IOException {\n    if (out != null) {             <<<<=\n      out.close(); // This invokes PositionCache.close()\n      out = null;                 <<<<==\n    }\n  }\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jzhuge","name":"jzhuge","key":"jzhuge","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jzhuge&avatarId=31264","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jzhuge&avatarId=31264","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jzhuge&avatarId=31264","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jzhuge&avatarId=31264"},"displayName":"John Zhuge","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-08T21:57:37.046+0000","updated":"2017-08-08T21:57:37.046+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13090459/comment/16119833","id":"16119833","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boky01","name":"boky01","key":"boky01","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boky01&avatarId=29244","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boky01&avatarId=29244","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boky01&avatarId=29244","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boky01&avatarId=29244"},"displayName":"Andras Bokor","active":true,"timeZone":"Europe/Budapest"},"body":"[~jzhuge],\n\nI think we should eliminate the multiple close calls instead of handling it.\n{code:title=CommandWithDestination#writeStreamToFile}\ntry {\n        out = create(target, lazyPersist, direct);\n        IOUtils.copyBytes(in, out, getConf(), true); // 1st close call\n      } finally {\n        IOUtils.closeStream(out); // second close call\n      }\n{code}\nI beleive the original author assumed that after calling {{IOUtils.copyBytes}} with true the out will be null so the second close call has no effect.\nOne possible solution is to call {{IOUtils.copyBytes}} with false and close the stream with try-catch-resource:\n{code}\nvoid writeStreamToFile(InputStream in, PathData target,\n        boolean lazyPersist, boolean direct)\n        throws IOException {\n      try (FSDataOutputStream out = create(target, lazyPersist, direct)) {\n        IOUtils.copyBytes(in, out, getConf(), false);\n      }\n    }\n{code}\nBut I agree with the reporter about {{IOUtils.copyBytes}} is misleading and should be changed.\nIf we want to fix this specific double call I suggest go with the code few lines above.\n\nBut I still suggest fixing HADOOP-5943 since there are more double call in the code which shows the current API is misleading.\nPlease check {{FileContext.Util#copy}} for example.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boky01","name":"boky01","key":"boky01","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boky01&avatarId=29244","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boky01&avatarId=29244","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boky01&avatarId=29244","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boky01&avatarId=29244"},"displayName":"Andras Bokor","active":true,"timeZone":"Europe/Budapest"},"created":"2017-08-09T12:44:36.931+0000","updated":"2017-08-09T12:44:36.931+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-14691/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3i2vz:"}}