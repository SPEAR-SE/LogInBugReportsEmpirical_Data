{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12924264","self":"https://issues.apache.org/jira/rest/api/2/issue/12924264","key":"HADOOP-12680","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Dec 25 08:12:33 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-12680/watchers","watchCount":4,"isWatching":false},"created":"2015-12-25T08:09:20.624+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12331977","id":"12331977","description":"2.7.1 release","name":"2.7.1","archived":false,"released":true,"releaseDate":"2015-07-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-12-25T08:12:33.079+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12316608","id":"12316608","name":"ha","description":"High Availability"}],"timeoriginalestimate":null,"description":"When I am upgrading my zookeeper cluster, and will change the ip address of zk nodes. And I found two namenodes of my hadoop cluster got loss of connection with zk. And when I revocer the zk cluster, the two namenodes are both transitioned to standby state and this makes cluster can't provide service. I found the reason may be is following:\n{code}\n/**\n     * If the elector gets disconnected from Zookeeper and does not know about\n     * the lock state, then it will notify the service via the enterNeutralMode\n     * interface. The service may choose to ignore this or stop doing state\n     * changing operations. Upon reconnection, the elector verifies the leader\n     * status and calls back on the becomeActive and becomeStandby app\n     * interfaces. <br/>\n     * Zookeeper disconnects can happen due to network issues or loss of\n     * Zookeeper quorum. Thus enterNeutralMode can be used to guard against\n     * split-brain issues. In such situations it might be prudent to call\n     * becomeStandby too. However, such state change operations might be\n     * expensive and enterNeutralMode can help guard against doing that for\n     * transient issues.\n     */\n    void enterNeutralMode();\n{code}\nMay be we should create a thread to monitor the stat of namenodes and don't let them all to be standby state.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Loss of zookeeper quorum lead all the namenode to be standby state","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12924264/comment/15071414","id":"15071414","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"body":"I show the some of zkfc log in this case:\n{code}\n2015-12-24 17:33:43,873 INFO org.apache.hadoop.ha.ActiveStandbyElector: Session expired. Entering neutral mode and rejoining...\n2015-12-24 17:33:43,873 INFO org.apache.hadoop.ha.ActiveStandbyElector: Trying to re-establish ZK session\n2015-12-24 17:33:43,875 INFO org.apache.zookeeper.ZooKeeper: Initiating client connection, connectString=10.13.8.24:2181,10.13.8.25:2181,10.13.8.26:2181,10.13.8.27:2181,10.13.7.33:2181 sessionTimeout=30000 watcher=org.apache.hadoop.ha.ActiveStandbyElector$WatcherWithClientRef@56d70b02\n2015-12-24 17:33:43,884 INFO org.apache.zookeeper.ClientCnxn: Opening socket connection to server 10.13.8.25/10.13.8.25:2181. Will not attempt to authenticate using SASL (unknown error)\n2015-12-24 17:33:43,884 WARN org.apache.zookeeper.ClientCnxn: Session 0x0 for server null, unexpected error, closing socket connection and attempting reconnect\njava.net.ConnectException: Connection refused\n        at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)\n        at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:739)\n        at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:361)\n        at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1081)\n2015-12-24 17:33:43,905 INFO org.apache.zookeeper.ClientCnxn: Unable to reconnect to ZooKeeper service, session 0x451703dcdf7d107 has expired, closing socket connection\n2015-12-24 17:33:43,985 INFO org.apache.zookeeper.ClientCnxn: Opening socket connection to server 10.13.7.33/10.13.7.33:2181. Will not attempt to authenticate using SASL (unknown error)\n2015-12-24 17:33:43,985 INFO org.apache.zookeeper.ClientCnxn: Socket connection established to 10.13.7.33/10.13.7.33:2181, initiating session\n2015-12-24 17:33:43,985 INFO org.apache.zookeeper.ClientCnxn: Unable to read additional data from server sessionid 0x0, likely server has closed socket, closing socket connection and attempting reconnect\n2015-12-24 17:33:44,712 INFO org.apache.zookeeper.ClientCnxn: Opening socket connection to server 10.13.8.24/10.13.8.24:2181. Will not attempt to authenticate using SASL (unknown error)\n2015-12-24 17:33:44,712 WARN org.apache.zookeeper.ClientCnxn: Session 0x0 for server null, unexpected error, closing socket connection and attempting reconnect\njava.net.ConnectException: Connection refused\n        at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)\n        at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:739)\n        at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:361)\n        at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1081)\n2015-12-24 17:33:45,806 INFO org.apache.zookeeper.ClientCnxn: Opening socket connection to server 10.13.8.26/10.13.8.26:2181. Will not attempt to authenticate using SASL (unknown error)\n2015-12-24 17:33:45,807 INFO org.apache.zookeeper.ClientCnxn: Socket connection established to 10.13.8.26/10.13.8.26:2181, initiating session\n2015-12-24 17:33:45,807 INFO org.apache.zookeeper.ClientCnxn: Unable to read additional data from server sessionid 0x0, likely server has closed socket, closing socket connection and attempting reconnect\n2015-12-24 17:33:46,549 INFO org.apache.zookeeper.ClientCnxn: Opening socket connection to server 10.13.8.27/10.13.8.27:2181. Will not attempt to authenticate using SASL (unknown error)\n2015-12-24 17:33:46,550 INFO org.apache.zookeeper.ClientCnxn: Socket connection established to 10.13.8.27/10.13.8.27:2181, initiating session\n2015-12-24 17:33:46,561 INFO org.apache.zookeeper.ClientCnxn: Session establishment complete on server 10.13.8.27/10.13.8.27:2181, sessionid = 0x451d35639b5002a, negotiated timeout = 30000\n2015-12-24 17:33:46,563 INFO org.apache.zookeeper.ClientCnxn: EventThread shut down\n2015-12-24 17:33:46,564 INFO org.apache.hadoop.ha.ActiveStandbyElector: Session connected.\n2015-12-24 17:33:46,573 INFO org.apache.hadoop.ha.ZKFailoverController: ZK Election indicated that NameNode at qihe2192/10.12.2.192:9000 should become standby\n2015-12-24 17:33:46,575 INFO org.apache.hadoop.ha.ZKFailoverController: Successfully transitioned NameNode at qihe2192/10.12.2.192:9000 to standby state\n2015-12-24 17:47:21,517 WARN org.apache.hadoop.ha.HealthMonitor: Transport-level exception trying to monitor health of NameNode at qihe2192/10.12.2.192:9000: java.io.IOException: Connection reset by peer Failed on local exception: java.io.IOException: Connection reset by peer; Host Details : local host is: \"qihe2192/10.12.2.192\"; destination host is: \"qihe2192\":9000;\n{code}\n{code}\n2015-12-24 17:33:44,860 INFO org.apache.zookeeper.ClientCnxn: Unable to reconnect to ZooKeeper service, session 0x551703eef8b00c2 has expired, closing socket connection\n2015-12-24 17:33:44,861 INFO org.apache.hadoop.ha.ActiveStandbyElector: Session expired. Entering neutral mode and rejoining...\n2015-12-24 17:33:44,861 INFO org.apache.hadoop.ha.ActiveStandbyElector: Trying to re-establish ZK session\n2015-12-24 17:33:44,862 INFO org.apache.zookeeper.ZooKeeper: Initiating client connection, connectString=10.13.8.24:2181,10.13.8.25:2181,10.13.8.26:2181,10.13.8.27:2181,10.13.7.33:2181 sessionTimeout=30000 watcher=org.apache.hadoop.ha.ActiveStandbyElector$WatcherWithClientRef@5eefe70b\n2015-12-24 17:33:44,863 INFO org.apache.zookeeper.ClientCnxn: Opening socket connection to server 10.13.8.27/10.13.8.27:2181. Will not attempt to authenticate using SASL (unknown error)\n2015-12-24 17:33:44,863 INFO org.apache.zookeeper.ClientCnxn: Socket connection established to 10.13.8.27/10.13.8.27:2181, initiating session\n2015-12-24 17:33:44,871 INFO org.apache.zookeeper.ClientCnxn: Session establishment complete on server 10.13.8.27/10.13.8.27:2181, sessionid = 0x451d35639b50012, negotiated timeout = 30000\n2015-12-24 17:33:44,873 INFO org.apache.zookeeper.ClientCnxn: EventThread shut down\n2015-12-24 17:33:44,874 INFO org.apache.hadoop.ha.ActiveStandbyElector: Session connected.\n2015-12-24 17:33:44,892 INFO org.apache.hadoop.ha.ZKFailoverController: ZK Election indicated that NameNode at qihe2182/10.12.2.182:9000 should become standby\n2015-12-24 17:33:44,928 INFO org.apache.hadoop.ha.ZKFailoverController: Successfully transitioned NameNode at qihe2182/10.12.2.182:9000 to standby state\n2015-12-24 17:47:20,883 WARN org.apache.hadoop.ha.HealthMonitor: Transport-level exception trying to monitor health of NameNode at qihe2182/10.12.2.182:9000: java.io.IOException: Connection reset by peer Failed on local exception: java.io.IOException: Connection reset by peer; Host Details : local host is: \"qihe2182/10.12.2.182\"; destination host is: \"qihe2182\":9000;\n2015-12-24 17:47:20,883 INFO org.apache.hadoop.ha.HealthMonitor: Entering state SERVICE_NOT_RESPONDING\n{code}\nIn {{2015-12-24 17:33}}, namenode are all transitioned to standby state.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"created":"2015-12-25T08:12:33.079+0000","updated":"2015-12-25T08:12:33.079+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-12680/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2qau7:"}}