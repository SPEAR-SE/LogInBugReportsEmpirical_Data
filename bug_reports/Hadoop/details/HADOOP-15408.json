{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13154812","self":"https://issues.apache.org/jira/rest/api/2/issue/13154812","key":"HADOOP-15408","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":"2018-04-24T16:26:15.455+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon May 07 21:14:07 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_55724187_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_1093557410","customfield_12312321":null,"resolutiondate":"2018-05-07T21:14:07.124+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15408/watchers","watchCount":11,"isWatching":false},"created":"2018-04-24T13:59:25.561+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12532509","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12532509","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"inwardIssue":{"id":"13073925","key":"HADOOP-14445","self":"https://issues.apache.org/jira/rest/api/2/issue/13073925","fields":{"summary":"Delegation tokens are not shared between KMS instances","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-07T21:14:16.196+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"Spark bundles hadoop related jars in their package.\r\n Spark expects backwards compatibility between minor versions.\r\n Their job failed after we deployed HADOOP-14445 in our test cluster.\r\n{noformat}\r\n2018-04-20 21:09:53,245 INFO [main] org.apache.hadoop.mapreduce.v2.app.MRAppMaster: Executing with tokens:\r\n2018-04-20 21:09:53,273 ERROR [main] org.apache.hadoop.mapreduce.v2.app.MRAppMaster: Error starting MRAppMaster\r\njava.util.ServiceConfigurationError: org.apache.hadoop.security.token.TokenIdentifier: Provider org.apache.hadoop.crypto.key.kms.KMSDelegationToken$\r\nKMSLegacyDelegationTokenIdentifier could not be instantiated\r\nat java.util.ServiceLoader.fail(ServiceLoader.java:232)\r\nat java.util.ServiceLoader.access$100(ServiceLoader.java:185)\r\nat java.util.ServiceLoader$LazyIterator.nextService(ServiceLoader.java:384)\r\nat java.util.ServiceLoader$LazyIterator.next(ServiceLoader.java:404)\r\nat java.util.ServiceLoader$1.next(ServiceLoader.java:480)\r\nat org.apache.hadoop.security.token.Token.getClassForIdentifier(Token.java:117)\r\nat org.apache.hadoop.security.token.Token.decodeIdentifier(Token.java:138)\r\nat org.apache.hadoop.security.token.Token.identifierToString(Token.java:393)\r\nat org.apache.hadoop.security.token.Token.toString(Token.java:413)\r\nat java.lang.String.valueOf(String.java:2994)\r\nat org.apache.commons.logging.impl.SLF4JLocationAwareLog.info(SLF4JLocationAwareLog.java:155)\r\nat org.apache.hadoop.mapreduce.v2.app.MRAppMaster.initAndStartAppMaster(MRAppMaster.java:1634)\r\nat org.apache.hadoop.mapreduce.v2.app.MRAppMaster.main(MRAppMaster.java:1583)\r\n\r\nCaused by: java.lang.NoSuchFieldError: TOKEN_LEGACY_KIND\r\nat org.apache.hadoop.crypto.key.kms.KMSDelegationToken$KMSLegacyDelegationTokenIdentifier.<init>(KMSDelegationToken.java:64)\r\nat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\nat sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\r\nat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\r\nat java.lang.reflect.Constructor.newInstance(Constructor.java:423)\r\nat java.lang.Class.newInstance(Class.java:442)\r\nat java.util.ServiceLoader$LazyIterator.nextService(ServiceLoader.java:380)\r\n... 10 more\r\n2018-04-20 21:09:53,278 INFO [main] org.apache.hadoop.util.ExitUtil: Exiting with status 1\r\n{noformat}\r\nTheir classpath looks like {{\\{...:hadoop-common-pre-HADOOP-14445.jar:.....:hadoop-common-with-HADOOP-14445.jar:....\\}}}\r\n\r\nThis is because the container loaded {{KMSDelegationToken}} class from an older jar and {{KMSLegacyDelegationTokenIdentifier}} from new jar and it fails when {{KMSLegacyDelegationTokenIdentifier}} wants to read {{TOKEN_LEGACY_KIND}} from {{KMSDelegationToken}} which doesn't exist before.\r\n Cc [~xiaochen]","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341706","id":"12341706","description":"2.10.0 Release","name":"2.10.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342178","id":"12342178","description":"2.8.4 Release","name":"2.8.4","archived":false,"released":true,"releaseDate":"2018-05-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342324","id":"12342324","description":"3.2 release","name":"3.2.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342984","id":"12342984","description":"3.1.1 release","name":"3.1.1","archived":false,"released":true,"releaseDate":"2018-08-07"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343006","id":"12343006","description":"2.9.2 release","name":"2.9.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343023","id":"12343023","description":"3.0.3 release","name":"3.0.3","archived":false,"released":true,"releaseDate":"2018-05-31"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12921471","id":"12921471","filename":"HADOOP-15408.trunk.poc.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-01T22:15:26.327+0000","size":23437,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12921471/HADOOP-15408.trunk.poc.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12920636","id":"12920636","filename":"HADOOP-15408-trunk.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-25T15:45:54.126+0000","size":4097,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12920636/HADOOP-15408-trunk.001.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12920492","id":"12920492","filename":"split.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-24T18:18:35.576+0000","size":3539,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12920492/split.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12920580","id":"12920580","filename":"split.prelim.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-25T05:27:57.792+0000","size":9368,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12920580/split.prelim.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"HADOOP-14445 broke Spark.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16450159","id":"16450159","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Rushabh, thanks for filing the jira.\r\n\r\nIt looks like the Java process has both versions of hadoop-common jar files, causing confusion. Is it a valid use case?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-24T16:26:15.455+0000","updated":"2018-04-24T16:26:15.455+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16450184","id":"16450184","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"Thanks [~jojochuang] for taking a look.\r\nbq. Is it a valid use case?\r\nI think yes.\r\nIf we can come up with a simple fix the IMO we should fix it.\r\nIn our cluster, there are many services (like oozie, hive) which can bundle an older versions of hadoop jar and they expect backwards compatibility between minor hadoop versions.\r\nWould like to hear more opinions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-24T16:39:47.365+0000","updated":"2018-04-24T16:40:14.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16450213","id":"16450213","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"ouch, didn't test it but feels like a scenario that we have to support....\r\n\r\nMaybe we can split the new class {{KMSDelegationToken}} into 2 separate classes, so there will be no dependency on each other. I didn't check how the class loader would work because it would see 'kms-dt' and be able to map to both the legacy identifier from the new jar, and the only identifier from the old jar. But I think if we do it this way either jar would work.... Thoughts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-24T16:59:06.476+0000","updated":"2018-04-24T16:59:06.476+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16450285","id":"16450285","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"body":"This fix also broke Ranger, for the same reason.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-24T17:46:43.851+0000","updated":"2018-04-24T17:46:43.851+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16450294","id":"16450294","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"{quote}This fix also broke Ranger, for the same reason.\r\n {quote}\r\nThanks Arpit for chiming in. Since there are multiple components affected by this change, it makes sense to fix in hadoop itself.\r\n\r\nbq. I didn't check how the class loader would work because it would see 'kms-dt' and be able to map to both the legacy identifier from the new jar, and the only identifier from the old jar.\r\nThanks [~xiaochen] for the comment.\r\nI don't completely grasp the idea. I would really appreciate if you can share sample pseudo code explaining the idea.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-24T17:53:13.614+0000","updated":"2018-04-24T17:53:13.614+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16450342","id":"16450342","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Sorry I have not debugged this, so could be missing something. Only from the description:\r\n{quote}\r\nThis is because the container loaded KMSDelegationToken class from an older jar and KMSLegacyDelegationTokenIdentifier from new jar and it fails when KMSLegacyDelegationTokenIdentifier wants to read TOKEN_LEGACY_KIND from KMSDelegationToken which doesn't exist before.\r\n{quote}\r\nWould something like  [^split.patch] work?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-24T18:19:00.306+0000","updated":"2018-04-24T18:19:00.306+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16450396","id":"16450396","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"We've always had a \"don't mix hadoop-* jars\" policy, though never one on \"what if you have >1 version on the same CP\" \r\nIgnoring strict policy \"because we said so\" rules, it'd be good for at least on those minor x.y.z releases for thing not to break.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2018-04-24T19:01:47.263+0000","updated":"2018-04-24T19:01:47.263+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16451504","id":"16451504","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"Thanks [~xiaochen] for the patch.\r\nHad an offline chat with [~daryn] on the proposed fix.\r\nBelow is the summary.\r\nIdentifier for both the tokens (i.e KMS_DELEGATION_TOKEN and kms-dt) are the same (byte-to-byte) so we don't need to have another class {{KMSLegacyDelegationTokenIdentifier}} for legacy token identifier.\r\n Kind in Identifier doesn't mean much.\r\n\r\nAfter removing {{KMSLegacyDelegationTokenIdentifier}} class and {{KMSLegacyDelegationTokenIdentifier}} from {{org.apache.hadoop.security.token.TokenIdentifier}}, 4 tests are failing in TestKMS because they are trying to decodeIdentifier with kind {{kms-dt}} and Serviceloader is not able to find any Identifier which corresponds to {{kms-dt}} kind.\r\n Since it is test-only code, we can change the test.\r\n Let me know if this makes sense.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-25T01:44:10.918+0000","updated":"2018-04-25T01:44:48.766+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16451674","id":"16451674","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~shahrs87], comments below and a request in the end.\r\nComments:\r\nbq. Identifier for both the tokens are the same\r\nCorrect, and that's exactly why we can do the trick at KMSCP to copy a new kind.\r\n\r\nbq. 4 tests are failing in TestKMS because they are trying to decodeIdentifier with kind kms-dt and Serviceloader is not able to find any Identifier which corresponds to kms-dt kind.\r\nThanks for testing. The patch was to express the idea - seems it won't compile on trunk. I have cleaned up compilation, and don't see any test failures. Attaching a new patch and we can run pre-commit to see. \r\n\r\nBack to the problem itself, which I think is another compatibility dimension as Steve mentioned, is that when old jars and new jars are both present, we should behave the same way as if only new jars or only old jars are present.\r\n\r\nThe specific issue, as you discovered in the description, is that service loader will load things in accumulation. This means {{org.apache.hadoop.crypto.key.kms.KMSDelegationToken$KMSDelegationTokenIdentifier}} from both jars, and {{org.apache.hadoop.crypto.key.kms.KMSDelegationToken$KMSLegacyDelegationTokenIdentifier}} from the new jar. I think this would trigger [service loader|https://docs.oracle.com/javase/6/docs/api/java/util/ServiceLoader.html] to ignore duplicates, so in the order you provided, we'll end up with token identifier from the old jar, and legacy token identifier from the new jar, which are both kms-dt. It seems then in the job, kms-dt mapped to the legacy token (new jar), which upon looking up the {{TOKEN_LEGACY_KIND}} field reached the old jar's {{KMSDelegationToken}} class. (I'm not totally sure but this seems to be the only explanation for the stacetrace)\r\n\r\nSo, in split.patch what I tried to do is to make sure:\r\n# {{org.apache.hadoop.security.token.TokenIdentifier}} have different classes between old jar and new jar\r\n# new jar's legacy token do not collide with old classes, and everything is self-contained (within {{KMSDelegationTokenLegacy.java}}).\r\n\r\nI think this should make service loader happy, and no matter kms-dt at run time maps to {{KMSDelegationTokenIdentifier}} in the old jar, or {{KMSLegacyDelegationTokenIdentifier}} in the new jar, the identifier can be initialized.\r\n\r\nRequest:\r\nSorry I won't have cycles this week to try reproduce and debug on a real spark case. Since you have a failing Spark job already, do you think you can test this with the failing spark use case, and verify whether this fixes the issue? Would be great if [~arpitagarwal] could try on the Ranger case as well.... Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-25T05:27:28.339+0000","updated":"2018-04-25T05:27:28.339+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16451796","id":"16451796","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 16s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 2 new or modified test files. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 19s{color} | {color:blue} Maven dependency ordering for branch {color} |\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 24m 54s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green} 27m 27s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 57s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 44s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 13m  1s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m 10s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 20s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 10s{color} | {color:blue} Maven dependency ordering for patch {color} |\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  1m  7s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green} 26m  5s{color} | {color:green} the patch passed {color} |\r\n| {color:red}-1{color} | {color:red} javac {color} | {color:red} 26m  5s{color} | {color:red} root generated 5 new + 1276 unchanged - 0 fixed = 1281 total (was 1276) {color} |\r\n| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 55s{color} | {color:orange} hadoop-common-project: The patch generated 1 new + 106 unchanged - 0 fixed = 107 total (was 106) {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 39s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m 23s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m 25s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 22s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:green}+1{color} | {color:green} unit {color} | {color:green}  8m 23s{color} | {color:green} hadoop-common in the patch passed. {color} |\r\n| {color:green}+1{color} | {color:green} unit {color} | {color:green}  3m 35s{color} | {color:green} hadoop-kms in the patch passed. {color} |\r\n| {color:red}-1{color} | {color:red} asflicense {color} | {color:red}  0m 37s{color} | {color:red} The patch generated 1 ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}128m  2s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:b78c94f |\r\n| JIRA Issue | HADOOP-15408 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12920580/split.prelim.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux f4f9acf4047c 3.13.0-139-generic #188-Ubuntu SMP Tue Jan 9 14:43:09 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / bb3c504 |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_162 |\r\n| findbugs | v3.1.0-RC1 |\r\n| javac | https://builds.apache.org/job/PreCommit-HADOOP-Build/14520/artifact/out/diff-compile-javac-root.txt |\r\n| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/14520/artifact/out/diff-checkstyle-hadoop-common-project.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/14520/testReport/ |\r\n| asflicense | https://builds.apache.org/job/PreCommit-HADOOP-Build/14520/artifact/out/patch-asflicense-problems.txt |\r\n| Max. process+thread count | 1506 (vs. ulimit of 10000) |\r\n| modules | C: hadoop-common-project/hadoop-common hadoop-common-project/hadoop-kms U: hadoop-common-project |\r\n| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/14520/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-25T07:38:50.969+0000","updated":"2018-04-25T07:38:50.969+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16452519","id":"16452519","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"bq. Thanks for testing. The patch was to express the idea - seems it won't compile on trunk.\r\nThanks [~xiaochen] for the patch. I should have been more clear. I didn't test with your patch (split.patch).\r\n{quote}\r\nIdentifier for both the tokens (i.e KMS_DELEGATION_TOKEN and kms-dt) are the same (byte-to-byte) so we don't need to have another class KMSLegacyDelegationTokenIdentifier for legacy token identifier.\r\n{quote}\r\nI have a different idea. I am uploading the patch (HADOOP-15408-001.patch) . Please don't think I am intruding.\r\nLets see if we agree on one approach.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-25T15:46:28.914+0000","updated":"2018-04-25T15:46:28.914+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16452538","id":"16452538","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. Please don't think I am intruding.\r\nnot at all. More than happy to see you working on it.\r\n\r\nbq. HADOOP-15408-001.patch\r\nCould you elaborate? It seems if we do it this way, the new jar alone won't be able to decode kms-dt?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-25T15:55:16.694+0000","updated":"2018-04-25T15:55:16.694+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16452551","id":"16452551","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"bq. the new jar alone won't be able to decode kms-dt?\r\nWe do we want to decode in the first place ?\r\nWe just want TokenRenewer to renew the token and the kind field in Token class will be able to find the right TokenRenewer (i.e KMSLegacyTokenRenewer).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-25T15:59:46.650+0000","updated":"2018-04-25T15:59:46.650+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16452594","id":"16452594","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"{noformat}\r\n2018-04-20 21:09:53,273 ERROR [main] org.apache.hadoop.mapreduce.v2.app.MRAppMaster: Error starting MRAppMaster\r\njava.util.ServiceConfigurationError: org.apache.hadoop.security.token.TokenIdentifier: Provider org.apache.hadoop.crypto.key.kms.KMSDelegationToken$\r\nKMSLegacyDelegationTokenIdentifier could not be instantiated\r\nat java.util.ServiceLoader.fail(ServiceLoader.java:232)\r\nat java.util.ServiceLoader.access$100(ServiceLoader.java:185)\r\nat java.util.ServiceLoader$LazyIterator.nextService(ServiceLoader.java:384)\r\nat java.util.ServiceLoader$LazyIterator.next(ServiceLoader.java:404)\r\nat java.util.ServiceLoader$1.next(ServiceLoader.java:480)\r\nat org.apache.hadoop.security.token.Token.getClassForIdentifier(Token.java:117)\r\nat org.apache.hadoop.security.token.Token.decodeIdentifier(Token.java:138)\r\nat org.apache.hadoop.security.token.Token.identifierToString(Token.java:393)\r\nat org.apache.hadoop.security.token.Token.toString(Token.java:413)\r\nat java.lang.String.valueOf(String.java:2994)\r\nat org.apache.commons.logging.impl.SLF4JLocationAwareLog.info(SLF4JLocationAwareLog.java:155)\r\nat org.apache.hadoop.mapreduce.v2.app.MRAppMaster.initAndStartAppMaster(MRAppMaster.java:1634)\r\nat org.apache.hadoop.mapreduce.v2.app.MRAppMaster.main(MRAppMaster.java:1583)\r\n{noformat}\r\nThis isn't about renewal, but the decoding of token identifier. And because the new jar will meet kms-dt (e.g. rolling upgrade), we need to fix it... I think renewer is not affected here","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-25T16:33:32.736+0000","updated":"2018-04-25T16:33:32.736+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16452744","id":"16452744","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"{quote}And because the new jar will meet kms-dt (e.g. rolling upgrade), we need to fix it.\r\n{quote}\r\nMy bad. Ignore my patch then.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-25T17:44:36.396+0000","updated":"2018-04-25T17:44:36.396+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16452800","id":"16452800","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (/) *{color:green}+1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 22s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 25s{color} | {color:blue} Maven dependency ordering for branch {color} |\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 26m 53s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green} 30m 30s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 57s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 42s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 12m 43s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m 10s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 20s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 11s{color} | {color:blue} Maven dependency ordering for patch {color} |\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  1m 17s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green} 28m 27s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green} 28m 27s{color} | {color:green} the patch passed {color} |\r\n| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  1m  0s{color} | {color:orange} hadoop-common-project: The patch generated 1 new + 93 unchanged - 0 fixed = 94 total (was 93) {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 46s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m 15s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m 36s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 22s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:green}+1{color} | {color:green} unit {color} | {color:green}  9m 24s{color} | {color:green} hadoop-common in the patch passed. {color} |\r\n| {color:green}+1{color} | {color:green} unit {color} | {color:green}  3m 45s{color} | {color:green} hadoop-kms in the patch passed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 48s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}137m  2s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:b78c94f |\r\n| JIRA Issue | HADOOP-15408 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12920636/HADOOP-15408-trunk.001.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux 2837a7f657f5 3.13.0-137-generic #186-Ubuntu SMP Mon Dec 4 19:09:19 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / 6266906 |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_162 |\r\n| findbugs | v3.1.0-RC1 |\r\n| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/14522/artifact/out/diff-checkstyle-hadoop-common-project.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/14522/testReport/ |\r\n| Max. process+thread count | 1356 (vs. ulimit of 10000) |\r\n| modules | C: hadoop-common-project/hadoop-common hadoop-common-project/hadoop-kms U: hadoop-common-project |\r\n| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/14522/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-25T18:06:49.851+0000","updated":"2018-04-25T18:06:49.851+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16452967","id":"16452967","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"No worries Rushabh. Would you be able to test whether the split approach helps on the failing spark job?\r\n\r\nFWIW I don't care about the ownership of jiras etc., so feel free to grab it and carry on. (As explained I don't have cycles this week to dive into this at real spark jobs, and would like to see this fixed asap, as I'm sure you and Arpit do as well)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-25T19:52:48.139+0000","updated":"2018-04-25T19:52:48.139+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16452992","id":"16452992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"bq.  Would you be able to test whether the split approach helps on the failing spark job?\r\nI am planning to put this patch in my internal build tonight and will request spark team to test it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-25T20:04:39.925+0000","updated":"2018-04-25T20:04:39.925+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16453233","id":"16453233","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks a lot!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-25T23:27:17.716+0000","updated":"2018-04-25T23:27:17.716+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16455478","id":"16455478","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"{quote}\r\njava.util.ServiceConfigurationError: org.apache.hadoop.security.token.TokenIdentifier: Provider org.apache.hadoop.crypto.key.kms.KMSDelegationToken$\r\nKMSLegacyDelegationTokenIdentifier could not be instantiated\r\n{quote}\r\nJust going back to old approach. Now if I see the stack trace again, how did the application know about {{KMSLegacyDelegationTokenIdentifier}}.\r\nIt seems like you forgot to remove {{org.apache.hadoop.crypto.key.kms.KMSDelegationToken$KMSLegacyDelegationTokenIdentifier}} from {{hadoop-common-project/hadoop-common/src/main/resources/META-INF/services/org.apache.hadoop.security.token.TokenIdentifier}}.\r\nI have put {{HADOOP-15408-trunk.001.patch}} internally and will update tomorrow.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-26T22:24:06.236+0000","updated":"2018-04-26T22:24:06.236+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16455487","id":"16455487","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for testing [~shahrs87].\r\n\r\nWith both jars present you can see KMSLegacyDelegationTokenIdentifier from the new jar right? But it seems to track to the KMSDelegationToken class of the old jar. In split.prelim.path that becomes {{KMSDelegationTokenLegacy$KMSLegacyDelegationTokenIdentifier}}, which is only in the new jar.\r\n\r\nWhat exception did you see with this case?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-26T22:28:56.727+0000","updated":"2018-04-26T22:28:56.727+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16455651","id":"16455651","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"body":"Looks like previous patch doesn't land on 2.9.1 branch so replace target version to 2.9.2. cc [~Sammi].","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-04-27T01:57:12.996+0000","updated":"2018-04-27T01:57:12.996+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16458731","id":"16458731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"{quote}What exception did you see with this case?\r\n{quote}\r\nI didn't see any exceptions with this case.\r\n{quote}Just going back to old approach.\r\n{quote}\r\nSorry I wasn't clear with my previous comment. Let me be more clear this time.\r\n We internally fixed this issue with {{HADOOP-15408-trunk.001.patch}} and the spark jobs ran successfully after this fix.\r\n\r\nGoing back to [this comment|https://issues.apache.org/jira/browse/HADOOP-15408?focusedCommentId=16452594&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16452594], I was asking that where did you see this stack trace ?\r\n I assume you applied {{HADOOP-15408-trunk.001.patch}} patch and you encountered some failure which showed that stack trace.\r\nLet me know if still I am not clear.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-30T16:32:15.074+0000","updated":"2018-04-30T16:32:15.074+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16458737","id":"16458737","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. I was asking that where did you see this stack trace ?\r\nThat was copied from the jira description, so I assumed that was the st you saw...\r\n\r\nSo to conclude, is my understanding correct? (listing below for easier pointing)\r\n# patch 1 fixed the spark issue\r\n# patch 1 does not work with kms-dt\r\n# split.patch does not fix the spark issue\r\n\r\nOn a separate note, we've also had an hbase internal test failure last friday. I'm looking into that...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-30T16:39:48.503+0000","updated":"2018-04-30T16:39:48.503+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16458803","id":"16458803","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"bq. so I assumed that was the st you saw...\r\nYes.\r\n\r\nbq. patch 1 fixed the spark issue\r\nYes.\r\nJust for clarification, patch 1 =  HADOOP-15408-trunk.001.patch\r\n\r\nbq. patch 1 does not work with kms-dt\r\nIt does work with kms-dt. Just for reference, internally we only use {{kms-dt}} since we have uri in the token service since the beginning of EZ.\r\n\r\nbq. split.patch does not fix the spark issue\r\nI haven't tested internally with {{split.prelim.patch}}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-30T17:42:33.776+0000","updated":"2018-04-30T17:42:33.776+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16458842","id":"16458842","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the explanation, that feels better. :)\r\n\r\nBut as patch 1 stands, the test shows exactly how kms-dt won't work with the token identifier, right?\r\nIn other words, even though the bytes are the same for both kinds, {{Token#decodeIdentifier()}} is broken by patch 1, because service loader cannot find a class to decode {{kms-dt}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-30T18:32:13.418+0000","updated":"2018-04-30T18:32:13.418+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16458911","id":"16458911","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"bq. In other words, even though the bytes are the same for both kinds, Token#decodeIdentifier() is broken by patch 1,\r\nTrying to understand why we want to decode TokenIdentifier ?\r\n\r\n{quote}\r\nIn other words, even though the bytes are the same for both kinds, Token#decodeIdentifier() is broken by patch 1, because service loader cannot find a class to decode kms-dt.\r\n{quote}\r\nI assume you are saying this because of the stack trace that I pasted in description.\r\nIt failed in our build because we had {{KMSLegacyDelegationTokenIdentifier}} in {{hadoop-common-project/hadoop-common/src/main/resources/META-INF/services/org.apache.hadoop.security.token.TokenIdentifier}} file and service loader was unable to find {{KMSLegacyDelegationTokenIdentifier}}.\r\nBut after removing {{KMSLegacyDelegationTokenIdentifier}} from {{hadoop-common-project/hadoop-common/src/main/resources/META-INF/services/org.apache.hadoop.security.token.TokenIdentifier}}, the job is able to run successfully.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-30T19:21:55.949+0000","updated":"2018-04-30T19:21:55.949+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16459107","id":"16459107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"I was saying this because in patch 1, TestKMS was changed to let the tests pass. Otherwise, in the test you will run into the equivalent of new jar seeing kms-dt, which can't decodeIdentifier. And...\r\n\r\nbq. Trying to understand why we want to decode TokenIdentifier ?\r\nBecause [it is a public API|https://github.com/apache/hadoop/blob/branch-3.0.0/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/token/Token.java#L169]...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-04-30T21:36:32.143+0000","updated":"2018-04-30T21:36:32.143+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16459485","id":"16459485","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"I find cycles to test this today, and was able to reproduce that 'TOKEN_LEGACY_KIND' NoSuchFieldError. Below is the command I used:\r\n{noformat}\r\nSPARK_CLASSPATH=~/hadoop-common-pre-HADOOP-14445.jar:$SPARK_CLASSPATH spark-submit --class  org.apache.spark.examples.HdfsTest --deploy-mode client --master yarn /opt/cloudera/parcels/CDH/lib/spark/lib/spark-examples.jar  DIR_TO_FILE_IN_EZ\r\n{noformat}\r\n\r\nAlso confirmed job is passing with split.prelim.patch. (Also after HADOOP-15431, anecdotally I used that issue's cluster).\r\n\r\n[~shahrs87], do you want to give that patch a try? I can clean up the patch if it works for you. Or I could help with reviews if you have other approaches or interested in revving it. Don't think patch 1 is the correct way as reasons stated above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-01T06:50:08.572+0000","updated":"2018-05-01T06:50:08.572+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16459706","id":"16459706","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"bq. Because it is a public API...\r\n\r\nIt is but it isn't.  Clients must always treat the identifier as an opaque blob of bytes.  The token wrapper with kind/service exists so identifiers don't have to be decodable.  Rushabh's patch completely conforms to the api in the javadoc.  There is no guarantee an identifier is decodable. The method is allowed to return null.\r\n\r\nBackground: Pre-1.x, {{decodeIdentifier}} didn't exist and tokens logged their identifiers as hex bytes.  For easier debugging I added {{decodeIdentifier}} to make a best-effort attempt to decode the identifier for logging (which I also added) in tasks via stringifying the token.\r\n\r\nDecoding is not guaranteed.  +1 on Rushabh's patch.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-05-01T14:12:27.870+0000","updated":"2018-05-01T14:12:27.870+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16459926","id":"16459926","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~daryn] for the comment and background.\r\n\r\nI want this fixed asap too, but I'm afraid with the current compat policy, we can't move away from it... I searched for {{decodeIdentifier }} across CDH and found 94 references. Although most of them look irrelavant / ok to kms tokens, I think the following would be problematic:\r\n# https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/deploy/security/HadoopFSDelegationTokenProvider.scala#L59\r\n# https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/deploy/SparkHadoopUtil.scala#L353\r\n\r\n#1 looks like would make spark's \"renew\" logic fail. #2 is minor logging so only surprise points.\r\n\r\nIMO we can try mark this method to be Private in the future following compat guidelines, but for this immediate issue we'd need a more compatible fix. Thoughts?\r\n\r\nI will cleanup my patch and upload later today for a code review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-01T17:50:33.550+0000","updated":"2018-05-01T17:50:33.550+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16459966","id":"16459966","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"bq. I want this fixed asap too, but I'm afraid with the current compat policy, we can't move away from it...\r\nSigh.  Technically it's not an incompatibility but maybe we will have to \"temporarily\" add a dummy identifier class.  Please file jiras against the components you've identified.  We can't cater to components violating the documented api.  This seems pretty clear:\r\n{code}\r\n  /**\r\n   * Get the token identifier object, or null if it could not be constructed\r\n   * (because the class could not be loaded, for example).\r\n   * @return the token identifier, or null\r\n   * @throws IOException \r\n   */\r\n{code}\r\n\r\nThis infuriates me because clients that depend on decoding the identifier have completely screwed us from changing the token format to something more flexible. :(. I knew the RM did it but that's easier to fix than a downstream project.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-05-01T18:13:53.162+0000","updated":"2018-05-01T18:13:53.162+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16459975","id":"16459975","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"bq. I want this fixed asap too,\r\nWe have fixed it internally by removing {{KMSLegacyTokenIdentifier}} class and requested one of our spark devs to verify whether their jobs are running successfully.\r\nI got a +1 from him. We believe we are running the latest version of spark which has that change.\r\nI have again requested him to add logging in that specific area and verifies that scala is not somehow filtering nulls.\r\nWill post the result later today.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-05-01T18:20:26.229+0000","updated":"2018-05-01T18:20:26.229+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16459983","id":"16459983","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. We believe we are running the latest version of spark which has that change.\r\nCould you let him try running a long-running job that requires token auth, and see if it can pass the first renew-interval?\r\nProbably need to change the renew-interval from 24 hours down to something like 10 minutes for a quicker test. This need to be set on BOTH the KMS server issuing the token, AND the spark job where the config is read from. (I know... that's how it works now)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-01T18:25:02.611+0000","updated":"2018-05-01T18:25:02.611+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16459988","id":"16459988","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. Please file jiras against the components you've identified\r\nWill do..\r\n\r\nbq. infuriates\r\nunderstand that feeling. :) That javadoc is crystal clear, but admittedly I didn't read it until you pointed out - I was only looking at the class annotations. With all the sympathy, I may have a way to let this work for now, will throw a patch for demonstrating purpose soon..","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-01T18:29:46.752+0000","updated":"2018-05-01T18:29:46.752+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16460227","id":"16460227","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Uploaded a poc.patch for discussion. Idea is simple: do not change the existing KMSDelegationToken class. Added a new class for service loader, so even if both jars present, there is no collision - only duplicates. This basically undoes part of HADOOP-14445, to change its {{token(kms-dt -> KMS_D_T), add legacyToken(kms-dt)}} to {{token(kms-dt unchanged), add standardToken(KMS_D_T)}}.\r\n\r\nTested to work with above spark command. It also has the benefit to be able to decode kms-dt. As Daryn explained that's not a must-do, but nice-to-hive for debugging purposes IMO.\r\n\r\nAny thoughts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-01T22:22:42.716+0000","updated":"2018-05-01T22:23:06.646+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16460431","id":"16460431","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 35s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 3 new or modified test files. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 25s{color} | {color:blue} Maven dependency ordering for branch {color} |\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 26m 18s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green} 27m 50s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  3m 12s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  2m 47s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 16m 35s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  4m 24s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  2m 16s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:blue}0{color} | {color:blue} mvndep {color} | {color:blue}  0m 19s{color} | {color:blue} Maven dependency ordering for patch {color} |\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  2m 19s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green} 27m 56s{color} | {color:green} the patch passed {color} |\r\n| {color:red}-1{color} | {color:red} javac {color} | {color:red} 27m 56s{color} | {color:red} root generated 5 new + 1469 unchanged - 0 fixed = 1474 total (was 1469) {color} |\r\n| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  3m 45s{color} | {color:orange} root: The patch generated 1 new + 112 unchanged - 0 fixed = 113 total (was 112) {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  2m 55s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m 20s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  4m 24s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  2m 16s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:green}+1{color} | {color:green} unit {color} | {color:green}  8m 49s{color} | {color:green} hadoop-common in the patch passed. {color} |\r\n| {color:green}+1{color} | {color:green} unit {color} | {color:green}  3m 37s{color} | {color:green} hadoop-kms in the patch passed. {color} |\r\n| {color:red}-1{color} | {color:red} unit {color} | {color:red} 98m 20s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 40s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}246m 39s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Reason || Tests ||\r\n| Failed junit tests | hadoop.hdfs.server.namenode.TestReencryptionWithKMS |\r\n|   | hadoop.hdfs.TestSafeModeWithStripedFileWithRandomECPolicy |\r\n|   | hadoop.hdfs.TestSafeMode |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:abb62dd |\r\n| JIRA Issue | HADOOP-15408 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12921471/HADOOP-15408.trunk.poc.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux d11655937625 3.13.0-137-generic #186-Ubuntu SMP Mon Dec 4 19:09:19 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / 8f42daf |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_162 |\r\n| findbugs | v3.1.0-RC1 |\r\n| javac | https://builds.apache.org/job/PreCommit-HADOOP-Build/14548/artifact/out/diff-compile-javac-root.txt |\r\n| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/14548/artifact/out/diff-checkstyle-root.txt |\r\n| unit | https://builds.apache.org/job/PreCommit-HADOOP-Build/14548/artifact/out/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/14548/testReport/ |\r\n| Max. process+thread count | 2716 (vs. ulimit of 10000) |\r\n| modules | C: hadoop-common-project/hadoop-common hadoop-common-project/hadoop-kms hadoop-hdfs-project/hadoop-hdfs U: . |\r\n| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/14548/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-05-02T02:27:10.048+0000","updated":"2018-05-02T02:27:10.048+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16461216","id":"16461216","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"{quote}\r\nhttps://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/deploy/security/HadoopFSDelegationTokenProvider.scala#L59\r\nhttps://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/deploy/SparkHadoopUtil.scala#L353\r\n{quote}\r\nIt turns out that in scala {{null.instanceof(Object)}} returns false.\r\nSo I think {{decodeIdentifier}} returning null should be fine.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-05-02T15:54:14.254+0000","updated":"2018-05-02T15:54:14.254+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16461298","id":"16461298","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Could you please clarify?\r\nFine as in \"won't NPE\" or fine as in \"tested spark can get the new token once the current one reaches 75% of its expiration time\"?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-02T16:52:24.916+0000","updated":"2018-05-02T16:52:24.916+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16462875","id":"16462875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"body":"bq. Fine as in \"won't NPE\"\r\nIt won't throw NPE.\r\n\r\nbq. \"tested spark can get the new token once the current one reaches 75% of its expiration time\"?\r\nIIUC spark is going through all the tokens in the credentials cache which will contain {{KMS_D_T}} and {{kms-dt}}.\r\nSpark is reading {{identifier.getIssueDate}} from the token and both tokens will have the same {{issueDate}} so we can safely _not implement_ {{KMSLegacyDelegationTokenIdentifier}}.\r\nAs long as spark doesn't throw NPE, I think we are good here.\r\nHope it makes sense.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shahrs87","name":"shahrs87","key":"shahrs87","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rushabh S Shah","active":true,"timeZone":"Etc/UTC"},"created":"2018-05-03T18:05:14.878+0000","updated":"2018-05-03T18:05:14.878+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13154812/comment/16466481","id":"16466481","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"With HADOOP-14445 reverted (see [discussion|https://issues.apache.org/jira/browse/HADOOP-14445?focusedCommentId=16464600&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16464600]), this is no longer an issue.\r\nThanks all for the report and investigation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-07T21:14:07.149+0000","updated":"2018-05-07T21:14:07.149+0000"}],"maxResults":41,"total":41,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15408/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3syen:"}}