{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12376616","self":"https://issues.apache.org/jira/rest/api/2/issue/12376616","key":"HADOOP-1758","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312565","id":"12312565","description":"","name":"0.15.0","archived":false,"released":true,"releaseDate":"2007-10-19"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2007-08-22T22:41:59.524+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Sep 05 21:56:42 UTC 2007","customfield_12310420":"80922","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_48140642_*|*_1_*:*_1_*:*_1175454610_*|*_6_*:*_1_*:*_0_*|*_5_*:*_1_*:*_5256942771","customfield_12312321":null,"resolutiondate":"2007-09-05T21:56:42.014+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-1758/watchers","watchCount":0,"isWatching":false},"created":"2007-08-22T18:03:26.762+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312348","id":"12312348","description":"","name":"0.13.0","archived":false,"released":true,"releaseDate":"2007-06-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-11-05T18:12:24.777+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310970","id":"12310970","name":"record","description":""}],"timeoriginalestimate":null,"description":"The following code appears in hadoop/src/c++/librecordio/csvarchive.cc :\n\n\nstatic void replaceAll(std::string s, const char *src, char c)\n{\n  std::string::size_type pos = 0;\n  while (pos != std::string::npos) {\n    pos = s.find(src);\n    if (pos != std::string::npos) {\n      s.replace(pos, strlen(src), 1, c);\n    }\n  }\n}\n\nThis is used in the context of replacing jute escapes in the code:\n\n\nvoid hadoop::ICsvArchive::deserialize(std::string& t, const char* tag)\n{\n  t = readUptoTerminator(stream);\n  if (t[0] != '\\'') {\n    throw new IOException(\"Errror deserializing string.\");\n  }\n  t.erase(0, 1); /// erase first character\n  replaceAll(t, \"%0D\", 0x0D);\n  replaceAll(t, \"%0A\", 0x0A);\n  replaceAll(t, \"%7D\", 0x7D);\n  replaceAll(t, \"%00\", 0x00);\n  replaceAll(t, \"%2C\", 0x2C);\n  replaceAll(t, \"%25\", 0x25);\n\n}\n\nSince this replaces the entire string for each instance of the escape sequence, practically anything would be better.  I would propose that within deserialize we allocate a char * [since each replacement is smaller than the original], scan for each %, and either do a general hex conversion in place or look for one of the six patterns, and after each replacement move down the unmodified text and scan for the % fom that starting point.\n\n-dk\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12364812","id":"12364812","filename":"1758_01.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2007-08-30T05:00:47.147+0000","size":2005,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12364812/1758_01.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"106045","customfield_12312823":null,"summary":"processing escapes in a jute record is quadratic","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dking","name":"dking","key":"dking","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dick King","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dking","name":"dking","key":"dking","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dick King","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376616/comment/12521950","id":"12521950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=milindb","name":"milindb","key":"milindb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Milind Bhandarkar","active":true,"timeZone":"America/Los_Angeles"},"body":"Dick,\n\nEricW provided this replacement for hadoop::ICsvArchive::deserialize, which he said worked great for him. Can you try it out ?\n\n{code}\nvoid hadoop::ICsvArchive::deserialize(std::string& t, const char* tag)\n{\n   char c;\n   if (1 != stream.read(&c, 1)) {\n     throw new IOException(\"Error in deserialization.\");\n   }\n   if (c != '\\'') {\n     throw new IOException(\"Errror deserializing string.\");\n   }\n   while (1) {\n     char c;\n     if (1 != stream.read(&c, 1)) {\n       throw new IOException(\"Error in deserialization.\");\n     }\n     if (c == ',' || c == '\\n' || c == '}') {\n       if (c != ',') {\n         stream.pushBack(c);\n       }\n       break;\n     }\n     else if (c == '%') {\n       char d[2];\n       if (2 != stream.read(&d, 2)) {\n         throw new IOException(\"Error in deserialization.\");\n       }\n       if (strncmp(d, \"0D\", 2) == 0) {\n         t.push_back(0x0D);\n       }\n       else if (strncmp(d, \"0A\", 2) == 0) {\n         t.push_back(0x0A);\n       }\n       else if (strncmp(d, \"7D\", 2) == 0) {\n         t.push_back(0x7D);\n       }\n       else if (strncmp(d, \"00\", 2) == 0) {\n         t.push_back(0x00);\n       }\n       else if (strncmp(d, \"2C\", 2) == 0) {\n         t.push_back(0x2C);\n       }\n       else if (strncmp(d, \"25\", 2) == 0) {\n         t.push_back(0x25);\n       }\n       else {\n         t.push_back(c);\n         t.push_back(d[1]);\n         t.push_back(d[2]);\n       }\n     }\n     else {\n       t.push_back(c);\n     }\n   }\n}\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=milindb","name":"milindb","key":"milindb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Milind Bhandarkar","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-22T22:41:59.524+0000","updated":"2007-08-22T22:41:59.524+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376616/comment/12522656","id":"12522656","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=owen.omalley","name":"owen.omalley","key":"owen.omalley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=29697","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=29697","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=29697","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=29697"},"displayName":"Owen O'Malley","active":true,"timeZone":"America/Los_Angeles"},"body":"Note that this code is not only slow, it doesn't work. The string is passed in by value and then modified. *oops*\n\nNote that since '%' is always escaped this can be done using sscanf to read the two digits and convert to a byte.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=owen.omalley","name":"owen.omalley","key":"owen.omalley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=owen.omalley&avatarId=29697","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=owen.omalley&avatarId=29697","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=owen.omalley&avatarId=29697","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=owen.omalley&avatarId=29697"},"displayName":"Owen O'Malley","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-24T21:35:02.857+0000","updated":"2007-08-24T21:35:02.857+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376616/comment/12523200","id":"12523200","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"body":"I propose sticking to Dick's suggestion: after reading the string, we replace all the characters in one shot. That's the way the Java version of RecordIO does it too, and it makes sense to maintain that symmetry. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2007-08-28T09:19:17.365+0000","updated":"2007-08-28T09:19:17.365+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376616/comment/12523762","id":"12523762","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"body":"Attached patch (1758_01.patch). while this fix is much more efficient than the current code, it is not the most efficient. We read data from a stream into a temporary string, then append to our string. A more efficient solution would be as EricW provided in an earlier comment. However, the solution in the patch is only slightly more inefficient, but is a lot simpler to read and understand, and it also mirrors the Java code. These are both important, IMO. If ever an extra string copy does indeed cause performance problems, we can change the code. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivekr","name":"vivekr","key":"vivekr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vivek Ratan","active":true,"timeZone":"Etc/UTC"},"created":"2007-08-30T05:00:49.954+0000","updated":"2007-08-30T05:00:49.954+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376616/comment/12524529","id":"12524529","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiitisme","name":"hiitisme","key":"hiitisme","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tanvi Kumar","active":true,"timeZone":"Etc/UTC"},"body":"\nQuoted from: \nhttp://www.nabble.com/-jira--Created%3A-%28HADOOP-1758%29-processing-escapes-in-a-jute-record-is-quadratic-tf4313169.html#a12400611\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hiitisme","name":"hiitisme","key":"hiitisme","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tanvi Kumar","active":true,"timeZone":"Etc/UTC"},"created":"2007-09-03T14:32:57.996+0000","updated":"2007-09-03T14:32:57.996+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376616/comment/12525046","id":"12525046","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1\n\nhttp://issues.apache.org/jira/secure/attachment/12364812/1758_01.patch applied and successfully tested against trunk revision r572826.\n\nTest results:   http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/688/testReport/\nConsole output: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/688/console","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2007-09-05T10:03:04.344+0000","updated":"2007-09-05T10:03:04.344+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12376616/comment/12525233","id":"12525233","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cutting","name":"cutting","key":"cutting","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Cutting","active":true,"timeZone":"America/Los_Angeles"},"body":"I just committed this.  Thanks, Vivek!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cutting","name":"cutting","key":"cutting","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Cutting","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-05T21:56:42.001+0000","updated":"2007-09-05T21:56:42.001+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-1758/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ii7r:"}}