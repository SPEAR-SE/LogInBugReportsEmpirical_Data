{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12696566","self":"https://issues.apache.org/jira/rest/api/2/issue/12696566","key":"HADOOP-10357","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-02-21T16:59:08.715+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Mar 27 15:01:12 UTC 2014","customfield_12310420":"375042","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-10357/watchers","watchCount":5,"isWatching":false},"created":"2014-02-21T15:53:29.928+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321659","id":"12321659","description":"1.2.0 release","name":"1.2.0","archived":false,"released":true,"releaseDate":"2013-05-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-27T15:01:12.470+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312526","id":"12312526","name":"security"}],"timeoriginalestimate":null,"description":"When using UGI.doAs in order to make a connection there appears to be a memory leak involving the UGI that is used for the doAs and the UGI held by TUGIAssumingTransport.\n\nWhen using this approach to establishing a JDBC connection in an environment that will serve many users and requests client side eventually runs out of memory.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12632680","id":"12632680","filename":"visualvm-hive.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-03-04T22:03:59.297+0000","size":180220,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12632680/visualvm-hive.png"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"375341","customfield_12312823":null,"summary":"Memory Leak in UserGroupInformation.doAs for JDBC Connection to Hive","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13908453","id":"13908453","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"body":"This has been verified with loginUserFromKeytabAndReturnUGI as well as with a patch for getUGIFromSubject from HADOOP-10342.\nUsing VisualVM we can identify UgiInstrumentation as a source of some of this leak - we end up with an instance for every connection established and subsequently closed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-02-21T15:56:34.960+0000","updated":"2014-02-21T15:56:34.960+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13908522","id":"13908522","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Please provide more detail.  A new UGI is expected to be created for each connection, and the UGI should be GC'ed after the connection/request is complete.  What is still holding a reference to the \"leaked\" UGIs?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2014-02-21T16:59:08.715+0000","updated":"2014-02-21T16:59:08.715+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13908571","id":"13908571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"body":"Hi Daryn - Yes, the UGI is created and disposed of per connection. I believe the trouble comes from the static UgiInstrumentation field within the UGI. Which is why we end up with at least 1 UgiInstrumentation instance per connection that was made and dropped. I guess it should be characterized as a UgiInstrumentation leak from within UGI? Anyway, I will be following up with a VisualVM screen capture showing that accumulation of UgiInstrumentation instances as well as a test program that can be used to reproduce it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-02-21T17:53:17.553+0000","updated":"2014-02-21T17:53:17.553+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13908577","id":"13908577","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"body":"Also, note that this is against the 1.2 codebase. \nThe UgiInstrumentation class is no longer in use in recent releases.\n\nI have not tried to reproduce the issue on the 2 line yet though.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-02-21T17:56:50.564+0000","updated":"2014-02-21T17:56:50.564+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13909111","id":"13909111","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"body":"The following class can be used to watch the memory footprint grow while it makes 200,000 connections and just closes them:\n\n{code}\npackage org.apache.hadoop.examples;\n\nimport java.security.PrivilegedExceptionAction;\nimport java.sql.*;\n\nimport org.apache.hadoop.security.UserGroupInformation;\n\n\npublic class HiveMemoryExample {\n\n\t//  JDBC credentials\n\tstatic final String JDBC_DRIVER = \"org.apache.hive.jdbc.HiveDriver\";\n\tstatic final String KEYTABDIR = \"/etc/security/keytabs/hive.service.keytab\";\n\tstatic final String HIVE_PRINCIPAL = \"hive/example.com@EXAMPLE.COM\";\n\tstatic final String JDBC_DB_URL = \"jdbc:hive2://127.0.0.1:10000/default;principal=\" + HIVE_PRINCIPAL;\n\tstatic final String USER = null; \n\tstatic final String PASS = null; \n\t\n\t\n\tstatic Connection getConnection() throws Exception{\n\t\tfinal UserGroupInformation ugi = UserGroupInformation.\n\t\t        loginUserFromKeytabAndReturnUGI(HIVE_PRINCIPAL, KEYTABDIR);\n\t\t\n\t\t\t\tConnection conn = (Connection) ugi.doAs(new PrivilegedExceptionAction<Object>() {\n\t\t\t\t\tpublic Object run() {    \t        \t  \n\t\t\t\t\t\tConnection con = null;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tClass.forName(JDBC_DRIVER);\n\t\t\t\t\t\t\tcon =  DriverManager.getConnection(JDBC_DB_URL,USER,PASS);\n\t\t\t\t\t\t} catch (SQLException e) {\n\t\t\t\t\t\t\te.printStackTrace();\n\t\t\t\t\t\t} catch (ClassNotFoundException e2) {\n\t\t\t\t\t\t\te2.printStackTrace();\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn con;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\treturn conn;\n\t}\n\t\n\tpublic static void main(String[] args) {\n\n\t\tUserGroupInformation.setConfiguration(new org.apache.hadoop.conf.Configuration());\n\t\t\n\t\tSystem.out.println(\"-- Test started ---\");\n\t\tRuntime rtime = Runtime.getRuntime();\n\n\t\t\n\t\tfor(int i=0; i<200000; i++) {\n\t\t\tConnection conn = null;\n\t\t\ttry {\n\t\t\t\tconn = getConnection();\t\t\n\t\t\t} catch (Exception e){\n\t\t\t\te.printStackTrace();\n\t\t\t} finally {\n\t\t\t\ttry {\n\t\t\t\t\tconn.close();\n\t\t\t\t} catch (SQLException e) {}\n\t\t\t}\n\t\t\t\n\t\t\t//Print used memory\n\t\t\tSystem.out.println(\"Iteration = \" + i + \" Used Memory:\" \n\t\t\t\t+ (rtime.totalMemory() - rtime.freeMemory())  + \" Bytes \" );\n\n\t\t\t\n\t\t}\n\n\t\tSystem.out.println(\"Test ended  \");\n\t}\n}\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-02-22T01:24:00.551+0000","updated":"2014-02-22T01:24:00.551+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13909115","id":"13909115","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"body":"For a simple maven project that you can pull and build: \nhttps://github.com/lmccay/ugihivememory\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-02-22T01:26:47.578+0000","updated":"2014-02-22T01:26:47.578+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13920035","id":"13920035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Haven't had time to look at 1.x code, but are you sure it's a real leak?  In the sample code although those temporary objects are going to look like a leak unless/until GC kicks in.  Trying calling {{System.gc()}} twice if you want to force a full sweep before printing stats.\n\nIf this parallels the \"real\" code, why is {{UGI.loginUserFromKeytabAndReturnUGI}} being invoked on every invocation?  You should create it and reuse it.  Also, if possible you want to wrap your loop with the doAs, instead of a frequent operation in the loop, because doAs isn't particularly cheap to enter/exit.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2014-03-04T21:21:39.782+0000","updated":"2014-03-04T21:21:39.782+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13920059","id":"13920059","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"body":"Hi Daryn - thanks for the comments. Yes, it is a real leak. Usecase background: this is a sccenario where - say a webapp - is authenticating every user through UGI and attempting a doAs for JDBC access to HS2.\n\nThe problem lies in the fact that we are holding on to an instance of UGI for the doAs that has a static metrics registry map inside. Inside of UGI initialize UgiInstrumentation instance is acquired through a create method that creates and registers the ugiInstrumentation in the static registry. This is all fine - except for the fact that there is a new UGI instance for every hive connection and each of those have initialize called  and a new ugiInstrumentation class is registered into the static registry. Therefore, we end up with UgiI's for every connection. The metrics themselves - consisting of char[]'s, byte[]'s, etc accumulate overtime and we eventually OOM.\n\nI just realized that I haven't posted the VisualVM screen capture yet. I will dig that up.\n\nWe need to make sure that the new metrics implementation that is in the 2 line isn't leaking yet.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-03-04T21:40:13.026+0000","updated":"2014-03-04T21:40:13.026+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13920097","id":"13920097","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"body":"Notice that the number of UgiInstrumentation instances in this screenshot is the same as the number of connections made and closed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-03-04T22:03:59.301+0000","updated":"2014-03-04T22:03:59.301+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13920892","id":"13920892","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"This intrigued me enough to download the 1.x source and take a quick look.  There is indeed a subtle bug but in practice it shouldn't be tickled.  Multiple initializations of the metrics (which creates the UgiInstrumentation) should be prevented by the isInitialized boolean.  This can only be bypassed by directly calling {{UGI.setConfiguration}} which the sample code is not doing.  Maybe the metrics system is cloning the object??\n\nAside, the screenshot shows 1004 instances which is not equal to 200k?  Unless you aborted early, this seems to indicate GC should eventually cleanup the instances.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2014-03-05T14:34:15.662+0000","updated":"2014-03-05T14:34:15.662+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13920927","id":"13920927","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"body":"It was aborted early actually.\nThe 1004 is the number of connections that were made at the time it was\nkilled.\n\nAlso, the ensureInitialized method isn't going to work for the static\nmetrics registry.\nI believe initialize is being called for each hive connection UGI instance.\n\nThe sample code does indeed call setConfiguration in the main().\n\nMaybe setConfiguration is also being called by the hive driver?\nThat would be the only explanation for the static conf check not working in\nensureInitialized.\nI haven't checked that.\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-03-05T14:59:47.716+0000","updated":"2014-03-05T14:59:47.716+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13920956","id":"13920956","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"body":"I see that HadoopThriftAuthBridge20S calls setConfiguration in:\n\n   @Override\n   public Client createClientWithConf(String authType) {\n     Configuration conf = new Configuration();\n     conf.set(HADOOP_SECURITY_AUTHENTICATION, authType);\n     UserGroupInformation.setConfiguration(conf);\n     return new Client();\n   }\n\nIf this class is in play that would explain the multiple calls to initialize.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-03-05T15:17:47.901+0000","updated":"2014-03-05T15:17:47.901+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13949406","id":"13949406","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"That's rather bad behavior.  It's universally changing the auth type which will affect all connections.  RPCv9 should be able to work due to negotiation, but earlier RPC versions like 1.x will likely fail if thrift enables security and the client attempts a kerberized connection to an insecure NN/JT/etc.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2014-03-27T14:45:36.991+0000","updated":"2014-03-27T14:45:36.991+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12696566/comment/13949424","id":"13949424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"body":"I assume that you are referring to the code in HadoopThriftAuthBridge20S - right?\nGiven the fact that it is the source of the leak as well - what should we change it to do instead?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lmccay","name":"lmccay","key":"lmccay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lmccay&avatarId=16811","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lmccay&avatarId=16811","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lmccay&avatarId=16811","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lmccay&avatarId=16811"},"displayName":"Larry McCay","active":true,"timeZone":"America/New_York"},"created":"2014-03-27T15:01:12.470+0000","updated":"2014-03-27T15:01:12.470+0000"}],"maxResults":14,"total":14,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-10357/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1smnr:"}}