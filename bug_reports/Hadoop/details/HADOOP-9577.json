{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12648285","self":"https://issues.apache.org/jira/rest/api/2/issue/12648285","key":"HADOOP-9577","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2013-05-18T16:58:41.129+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jan 16 13:39:00 UTC 2015","customfield_12310420":"328641","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_52563085447_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-01-16T13:39:00.514+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-9577/watchers","watchCount":12,"isWatching":false},"created":"2013-05-18T04:47:35.137+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12320248","id":"12320248","description":"maintenance release on branch-1.0","name":"1.0.3","archived":false,"released":true,"releaseDate":"2012-05-07"}],"issuelinks":[{"id":"12381919","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12381919","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12408300","key":"HADOOP-4637","self":"https://issues.apache.org/jira/rest/api/2/issue/12408300","fields":{"summary":"Unhandled failures starting jobs with S3 as backing store","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12369184","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12369184","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"outwardIssue":{"id":"12647860","key":"HADOOP-9565","self":"https://issues.apache.org/jira/rest/api/2/issue/12647860","fields":{"summary":"Add a Blobstore interface to add to blobstore FileSystems","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-01-16T13:39:00.578+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311814","id":"12311814","name":"fs/s3","description":"S3A filesystem client and other S3 connectivity issues"}],"timeoriginalestimate":null,"description":" The implementation of needsTaskCommit() assumes that the FileSystem used for writing temporary outputs is consistent.  That happens not to be the case when using the S3 native filesystem in the US Standard region.  It is actually quite common in larger jobs for the exists() call to return false even if the task attempt wrote output minutes earlier, which essentially cancels the commit operation with no error.  That's real life data loss right there, folks.\n\nThe saddest part is that the Hadoop APIs do not seem to provide any legitimate means for the various RecordWriters to communicate with the OutputCommitter.  In my projects I have created a static map of semaphores keyed by TaskAttemptID, which all my custom RecordWriters have to be aware of.  That's pretty lame.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"328984","customfield_12312823":null,"summary":"Actual data loss using s3n (against US Standard region)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=j_caplan","name":"j_caplan","key":"j_caplan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Caplan","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=j_caplan","name":"j_caplan","key":"j_caplan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Caplan","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12648285/comment/13661395","id":"13661395","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks for the report Joshua! What would you suggest as a general solution for this? Disable use of temporary output locations (i.e. no FOC) for S3 automatically since it can never be consistent (which is the real bother)?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"created":"2013-05-18T16:58:41.129+0000","updated":"2013-05-18T16:58:41.129+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12648285/comment/13661397","id":"13661397","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdeyhim","name":"pdeyhim","key":"pdeyhim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Parviz Deyhim","active":true,"timeZone":"America/Los_Angeles"},"body":"just as a clarification, US-Standard is eventually consistent. Other S3 regions/endpoints have read-your-write consistency: http://docs.aws.amazon.com/AmazonS3/latest/dev/LocationSelection.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdeyhim","name":"pdeyhim","key":"pdeyhim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Parviz Deyhim","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-18T17:03:33.422+0000","updated":"2013-05-18T17:03:33.422+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12648285/comment/13661428","id":"13661428","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"Parviz, US-East makes no consistency guarantees, the others say \"a PUT of a new blob is immediately visible -mu make no stronger guarantees about DELETE and PUT over existing data\". It's only slightly less risky.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2013-05-18T20:44:38.476+0000","updated":"2013-05-18T20:44:38.476+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12648285/comment/13661430","id":"13661430","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"Joshua,\n\nTthe problems of blob store consistency is something I became more aware of during HADOOP-8545; where delete's eventual consistency was visible between tests cases -some of the tests would get the data of the previous run. This was avoided by not reusing blob names, and using OpenStack Swift's {{X-NEWEST}} header, which so far has met its promise of \"returning the newest value\".\n\nEven so, the other issue with blobstores is that most don't meet Hadoop's expectations of atomicity of directory create, rename and delete; rename is used during the commits of MR jobs. We have expectations of a filesystem \"presents a consistent single-instance view of a hierarchical filesystem across the cluster\" that are very much broken by blobstores \"a set of blobs with variable consistency guarantees, onto which we have to mimic directories through bulk blob operations\".\n\nThis is why we're trying to spell out our expectations more clearly in HADOOP-9361, under which I'm thinking we need to add an explicit {{Blobstore}} interface to the blobstores to indicate -at least to MapReduce- that what implements the FileSystem isn't really, and that we need to commit differently. If you can help define and fix the behaviour -and verify it works- we'd love your participation. \n\nFor now, something we should think about spelling out in more detail is \"commit to HDFS then copy to S3\", and \"if you do output to a blobstore, make sure speculation is turned off\".\n\n Making sure that distCP works reliably with blobstores should be a first step in blobstore-aware work.\n\n\nNow\n# was this Apache Hadoop 1.0.3 or the Amazon variant? \n# was speculative execution enabled?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2013-05-18T20:57:27.342+0000","updated":"2013-05-18T20:57:27.342+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12648285/comment/13661590","id":"13661590","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=j_caplan","name":"j_caplan","key":"j_caplan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Caplan","active":true,"timeZone":"America/Los_Angeles"},"body":"To answer your questions:\n1. This was the Amazon variant of 1.0.3 with Multipart Uploading disabled, although looking at the Apache code even as far forward as the 2.0.x branches I don't see how the logic would be any different\n2. Speculative execution was certainly enabled.  I suppose if I could live without speculative execution for the jobs that write directly to S3, I could use the DirectFileOutputCommitter or some derivative to avoid this issue.\n\nYour comments about blobstores in general and Hadoop's assumptions about FileSystems are enlightening.  I definitely prefer the commit to HDFS and copy later strategy.\n\nMy reason for calling out this particular FileSystem side-effect assumption is that it seems like a gratuitous use for accomplishing the goal of deciding whether or not there's temporary output to commit.  My workaround has been for the writers to tell me (in an admittedly clunky way) that they produced output.  I can trust them more than I can trust the FileSystem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=j_caplan","name":"j_caplan","key":"j_caplan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Caplan","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-19T16:25:50.038+0000","updated":"2013-05-19T16:25:50.038+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12648285/comment/14280218","id":"14280218","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"I'm going to close this as something we don't currently plan to fix in the Hadoop core codebase, given that Netflix S3mper and EMR itself both offer a solution, namely support on Amazon Dynamo for a consistent metadata store.\n\nThe other way to get guaranteed create consistency is \"don't use US East\", which has no consistency guarantees â€”whereas everything else offers Create , but not Update or Delete","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2015-01-16T13:39:00.563+0000","updated":"2015-01-16T13:39:00.563+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-9577/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1kpa7:"}}