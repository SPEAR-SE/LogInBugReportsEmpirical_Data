{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13189417","self":"https://issues.apache.org/jira/rest/api/2/issue/13189417","key":"HADOOP-15819","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-10-04T14:26:27.071+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jan 04 13:45:19 UTC 2019","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_2_*:*_4596413569_*|*_3_*:*_2_*:*_2672900031_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2018-12-27T15:54:08.751+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15819/watchers","watchCount":8,"isWatching":false},"created":"2018-10-04T12:38:55.198+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12342984","id":"12342984","description":"3.1.1 release","name":"3.1.1","archived":false,"released":true,"releaseDate":"2018-08-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2019-01-04T13:45:19.685+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311814","id":"12311814","name":"fs/s3","description":"S3A filesystem client and other S3 connectivity issues"}],"timeoriginalestimate":null,"description":"Running the integration tests for hadoop-aws {{mvn -Dscale verify}} against Amazon AWS S3 (eu-west-1, us-west-1, with no s3guard) we see a lot of these failures:\r\n\r\n{noformat}\r\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 4.408 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.staging.integration.ITDirectoryCommitMRJob\r\n[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.staging.integration.ITDirectoryCommitMRJob)  Time elapsed: 0.027 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n\r\n[ERROR] Tests run: 2, Failures: 0, Errors: 2, Skipped: 0, Time elapsed: 4.345 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJob\r\n[ERROR] testStagingDirectory(org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJob)  Time elapsed: 0.021 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n\r\n[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJob)  Time elapsed: 0.022 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n\r\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 4.489 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJobBadDest\r\n[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.staging.integration.ITStagingCommitMRJobBadDest)  Time elapsed: 0.023 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n\r\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 4.695 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.magic.ITMagicCommitMRJob\r\n[ERROR] testMRJob(org.apache.hadoop.fs.s3a.commit.magic.ITMagicCommitMRJob)  Time elapsed: 0.039 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n\r\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0.015 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory\r\n[ERROR] testEverything(org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory)  Time elapsed: 0.014 s  <<< ERROR!\r\njava.io.IOException: s3a://cloudera-dev-gabor-ireland: FileSystem is closed!\r\n{noformat}\r\n\r\nThe big issue is that the tests are running in a serial manner - no test is running on top of the other - so we should not see that the tests are failing like this. The issue could be in how we handle org.apache.hadoop.fs.FileSystem#CACHE - the tests should use the same S3AFileSystem so if A test uses a FileSystem and closes it in teardown then B test will get the same FileSystem object from the cache and try to use it, but it is closed.\r\n\r\nWe see this a lot in our downstream testing too. It's not possible to tell that the failed regression test result is an implementation issue in the runtime code or a test implementation problem. \r\nI've checked when and what closes the S3AFileSystem with a sightly modified version of S3AFileSystem which logs the closers of the fs if an error should occur. I'll attach this modified java file for reference. See the next example of the result when it's running:\r\n\r\n{noformat}\r\n2018-10-04 00:52:25,596 [Thread-4201] ERROR s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:checkIfClosed(74)) - Use after close(): \r\njava.lang.RuntimeException: Using closed FS!.\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.checkIfClosed(S3ACloseEnforcedFileSystem.java:73)\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.mkdirs(S3ACloseEnforcedFileSystem.java:474)\r\n\tat org.apache.hadoop.fs.contract.AbstractFSContractTestBase.mkdirs(AbstractFSContractTestBase.java:338)\r\n\tat org.apache.hadoop.fs.contract.AbstractFSContractTestBase.setup(AbstractFSContractTestBase.java:193)\r\n\tat org.apache.hadoop.fs.s3a.ITestS3AClosedFS.setup(ITestS3AClosedFS.java:40)\r\n\tat sun.reflect.GeneratedMethodAccessor22.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\r\n\tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:24)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)\r\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)\r\n2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(61)) - FS was closed 6 times by:\r\n2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #1 ---------------\r\n2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)\r\n\tat org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)\r\n\tat org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)\r\n\tat org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)\r\n\tat org.apache.hadoop.fs.s3a.commit.AbstractCommitITest.teardown(AbstractCommitITest.java:206)\r\n\tat org.apache.hadoop.fs.s3a.auth.ITestAssumedRoleCommitOperations.teardown(ITestAssumedRoleCommitOperations.java:90)\r\n\tat sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)\r\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)\r\n\r\n2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #2 ---------------\r\n2018-10-04 00:52:25,596 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)\r\n\tat org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)\r\n\tat org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)\r\n\tat org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)\r\n\tat sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)\r\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)\r\n\r\n2018-10-04 00:52:25,597 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #3 ---------------\r\n2018-10-04 00:52:25,598 [Thread-4201] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)\r\n\tat org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)\r\n\tat org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)\r\n\tat org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)\r\n\tat sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)\r\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)\r\n(...)\r\n{noformat}\r\n\r\nFrom the logs it seems that the closers are the teardown methods of the abstract test classes, so the same FileSystem object gets reused between tests.\r\n\r\n\r\nTo run a test with the modified fs the following should be in the config:\r\n{noformat}\r\n<property>\r\n  <name>fs.s3a.impl</name>\r\n  <value>org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem</value>\r\n  <description>The implementation class of the S3A Filesystem</description>\r\n</property>\r\n{noformat}\r\n\r\nI file this jira to solve this issue, and start a conversation if needed.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12942381","id":"12942381","filename":"closed_fs_closers_example_5klines.log.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-10-04T12:43:00.411+0000","size":26306,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12942381/closed_fs_closers_example_5klines.log.zip"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12950054","id":"12950054","filename":"HADOOP-15819.000.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-11-29T18:33:59.003+0000","size":2429,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12950054/HADOOP-15819.000.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12950884","id":"12950884","filename":"HADOOP-15819.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-06T20:04:37.719+0000","size":1187,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12950884/HADOOP-15819.001.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12952049","id":"12952049","filename":"HADOOP-15819.002.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-17T15:56:39.457+0000","size":1779,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12952049/HADOOP-15819.002.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12950052","id":"12950052","filename":"S3ACloseEnforcedFileSystem.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-11-29T18:26:10.715+0000","size":22360,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12950052/S3ACloseEnforcedFileSystem.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12942380","id":"12942380","filename":"S3ACloseEnforcedFileSystem.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-10-04T12:40:10.246+0000","size":22270,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12942380/S3ACloseEnforcedFileSystem.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"S3A integration test failures: FileSystem is closed! - without parallel test run","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16638286","id":"16638286","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"I see. \r\nwe could find those FS.close() calls and only invoke them if the FS is known to be not-shared? e.g fs.getConf().get(\"whatever-that-shraed-property-is\") to guard the call","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2018-10-04T14:26:27.071+0000","updated":"2018-10-04T14:26:27.071+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16638306","id":"16638306","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"From that perspective, every test could use the same instance one after another - the only way to tell that the fs is not shared is when fs caching is forced off with {{S3ATestUtils.disableFilesystemCaching(configuration);}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-10-04T14:39:32.686+0000","updated":"2018-10-04T14:39:32.686+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16638351","id":"16638351","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"So that's {{fs.s3a.impl.disable.cache}} (S3ATestConstants#FS_S3A_IMPL_DISABLE_CACHE) set to false, and that's when we want to close the fs. Otherwise just keep it open?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-10-04T15:04:19.558+0000","updated":"2018-10-04T15:04:19.558+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16643742","id":"16643742","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"If I remove {{IOUtils.closeStream(getFileSystem());}} from org/apache/hadoop/fs/s3a/AbstractS3ATestBase.java:55, it fixes the issue.\r\nSo the teardown would be \r\n{code:java}\r\n  @Override\r\n  public void teardown() throws Exception {\r\n    super.teardown();\r\n  }\r\n{code}\r\ninstead of \r\n{code:java}\r\n  @Override\r\n  public void teardown() throws Exception {\r\n    super.teardown();\r\n    describe(\"closing file system\");\r\n    IOUtils.closeStream(getFileSystem());\r\n  }\r\n{code}\r\nso even we could skip the override. We could even do something like \r\n{code:java}\r\n  @Override\r\n  public void teardown() throws Exception {\r\n    super.teardown();\r\n    if(getConfiguration().getBoolean(FS_S3A_IMPL_DISABLE_CACHE, false)){\r\n      describe(\"closing file system\");\r\n      IOUtils.closeStream(getFileSystem());\r\n    }\r\n  }\r\n{code}\r\nbut I was still getting some {{FileSystem is closed!}} when I used that method for closing the fs.\r\n\r\nI wanted to get to the bottom of this, so checked how fs caching works in general. We have a static fs cache in org.apache.hadoop.fs.FileSystem, that we use for cache fs instances. If we don't have an fs instance for the schema provided (e.g s3a://) we create a new instance and store it in the static cache - \"If this is the first entry in the map and the JVM is not shutting down this registers a shutdown hook to close filesystems, and adds this FS to the toAutoClose if '{{fs.automatic.close}}' is set in the configuration (default: true).\", so I don't see why do we have to close it manually between each an every test.\r\nWhat's your opinion on this [~stevel@apache.org]?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-10-09T17:05:29.657+0000","updated":"2018-10-09T17:05:29.657+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16643749","id":"16643749","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"Also note: I was getting interesting errors when I removed the line, maybe related that we haven't closed the fs:\r\n{noformat}\r\nERROR] Tests run: 9, Failures: 0, Errors: 9, Skipped: 0, Time elapsed: 0.778 s <<< FAILURE! - in org.apache.hadoop\r\n.fs.contract.s3a.ITestS3AContractRootDir\r\n[ERROR] testRecursiveRootListing(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.085 s\r\n <<< ERROR!\r\njava.lang.IllegalArgumentException: Can not create a Path from an empty string\r\n\r\n[ERROR] testRmEmptyRootDirNonRecursive(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.\r\n082 s  <<< ERROR!\r\njava.lang.IllegalArgumentException: Can not create a Path from an empty string\r\n\r\n[ERROR] testRmRootRecursive(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.08 s  <<< E\r\nRROR!\r\njava.lang.IllegalArgumentException: Can not create a Path from an empty string\r\n\r\n[ERROR] testListEmptyRootDirectory(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.084\r\ns  <<< ERROR!\r\njava.lang.IllegalArgumentException: Can not create a Path from an empty string\r\n        at org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir.testListEmptyRootDirectory(ITestS3AContractRoo\r\ntDir.java:63)\r\n\r\n[ERROR] testCreateFileOverRoot(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.078 s  <\r\n<< ERROR!\r\njava.lang.IllegalArgumentException: Can not create a Path from an empty string\r\n\r\n[ERROR] testSimpleRootListing(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.079 s  <<\r\n< ERROR!\r\njava.lang.IllegalArgumentException: Can not create a Path from an empty string\r\n\r\n[ERROR] testMkDirDepth1(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.108 s  <<< ERRO\r\nR!\r\njava.lang.IllegalArgumentException: Can not create a Path from an empty string\r\n\r\n[ERROR] testRmEmptyRootDirRecursive(org.apache.hadoop.fs.contract.s3a.ITestS3AContractRootDir)  Time elapsed: 0.083\r\n s  <<< ERROR!\r\njava.lang.IllegalArgumentException: Can not create a Path from an empty string\r\n(......)\r\n{noformat}\r\nSo there should be another solution to this that won't break the tests but also won't cause the {{FileSystem is closed!}} issue. Running this test class separately all 9 tests are passing.\r\nCould we disable the caching just for these test and have them run on a new FS instance?\r\n\r\n(I get other issues as well when running the tests without closing the fs. I think there were many reasons the closing the fs, but I missed the history.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-10-09T17:09:13.207+0000","updated":"2018-10-09T17:37:53.693+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16643906","id":"16643906","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mackrorysd","name":"mackrorysd","key":"mackrorysd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mackrorysd&avatarId=18559","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mackrorysd&avatarId=18559","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mackrorysd&avatarId=18559","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mackrorysd&avatarId=18559"},"displayName":"Sean Mackrory","active":true,"timeZone":"America/Denver"},"body":"So I think it was mentioned in the other JIRA that each test should be in their own JVM, but if we're seeing FS's in one test that were already closed, and we get a stack trace that points to another test, then something isn't right. Not closing the fs in tests seems like a possible solution, but (a) we need to rule out the possibility that this is a bug in the actual product, and (b) closing the FS does multiple important things and duplicating that everywhere isn't just a Band-Aid, it's kind of a messy one.\r\n\r\nThe FS cache really feels inherently broken in the parallel tests case, which is why I initially liked the idea of disabling caching for the tests. If you rely on the FileSystem class to either give you an existing instance or create one for you, then we need to rely on it to decide when to close it. Otherwise people either break what other threads are doing or they don't close their FS instances. Both of those are horrible. Some kind of ref-counting, maybe? But modifying the design of the FS cache scares me, because it's been that way for a long time and is kind of important. Which raises the question: if I'm seeing this all the time recently but none of us saw it before a little while ago - what broke it? Because I don't think it was the FS caching. I wonder if git-bisect might be a useful way to get a lead here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mackrorysd","name":"mackrorysd","key":"mackrorysd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mackrorysd&avatarId=18559","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mackrorysd&avatarId=18559","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mackrorysd&avatarId=18559","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mackrorysd&avatarId=18559"},"displayName":"Sean Mackrory","active":true,"timeZone":"America/Denver"},"created":"2018-10-09T18:23:15.045+0000","updated":"2018-10-09T18:23:15.045+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16644730","id":"16644730","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"I think we should focus on solving this case first, so it would be better not to talk about parallel test cases.\r\nThe FS cache itself could be broken when running parallel tests, but I think it was never prepared to for parallel test run, and that change should be addressed in another issue since it's an entirely different topic. If we don't run parallel tests we still have this problem.\r\n\r\nThe issue I see right now is that we close the filesystem after each test and I was not able to find another class that does this. I think it's very specific to AbstractS3ATestBase (so S3A) and it's 33 implementations. {{org.apache.hadoop.fs.s3a.AbstractS3ATestBase#teardown}} is called after each test, because the superclass annotation is {{@After}} on the teardown.\r\n\r\nWith the current FS cache implementation, another test can get the same FS instance that the previous test closed. It can even happen if the tests running are from the *same class*.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-10-10T09:43:27.790+0000","updated":"2018-10-10T09:43:27.790+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16644940","id":"16644940","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"bq. The FS cache really feels inherently broken in the parallel tests case, which is why I initially liked the idea of disabling caching for the tests.\r\n\r\nparallel tests run in their own JVMs,  the main issue there is that you need to be confident that tests aren't writing to the same local/remote paths.\r\n\r\nAt the same time, I've seen old test instances get recycled, which makes me thing that the parallel runner fields work out to instantiated test runners as they complete individual test cases. So reuse does happen, it just happens a lot more in sequential runs.\r\n\r\nTests which want special configs of the FS can't handle recycled classes, hence the need for  nee filesystems & close after, but I don't see why other tests should be closing much.\r\n\r\n* HADOOP-13131 added the close, along with {{S3ATestUtils.createTestFilesystem()}}, which does create filesystems that need to be closed.\r\n* But I don't see that creation happening much, especially given {{S3AContract}}'s FS is just from a get().\r\n* Many tests call {{S3ATestUtils.disableFilesystemCaching(conf)}} before FileSystem.get, which guarantees unique instances\r\n\r\nWhich makes me think: yes, closing the FS in teardown is overkill except in the special case of \"creates a new filesystem() either explicilty or implicitly.\r\n\r\nAs [~mackrorysd] says: surprising this hasn't surfaced before. But to fix it means that it should be done properly.\r\n\r\n* IF tests were always closed and new ones created (i.e. no caching), test cases run way, way faster. \r\n* those tests which do need their own FS instance can close it in teardown, and set it up.\r\n* And those tests which absolutely must have FS.get() Return their specific filesystem must: (a) enable caching and (b) remove their FS from the cache in teardown (e.g. FileSystem.closeAll)\r\n\r\nThis is probably going to force a review of all the tests, maybe have some method in AbstractS3ATestBase\r\n\r\n{code}\r\nprotected boolean uniqueFilesystemInstance() { return false; }\r\n{code}\r\n\r\nthen \r\n# if true, in createConfiguration() call {{disableFilesystemCaching}}\r\n# if true in teardown: close the FS.\r\n\r\nNext:\r\n*  go through all uses of the {{disableFilesystemCaching}}, and in those tests have {{uniqueFilesystemInstance}} return true. \r\n* Look at uses of  {{S3ATestUtils.createTestFilesystem()}} & make sure they are closing this after\r\n\r\nThis is going to span all the tests. Joy\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2018-10-10T13:11:04.225+0000","updated":"2018-10-10T14:08:41.237+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16644973","id":"16644973","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"I have some bad news: I get these issues for tests where {{FS_S3A_IMPL_DISABLE_CACHE}} set to true, so the caching _should be_ disabled.\r\n\r\nWhat I did is I modified the {{org.apache.hadoop.fs.s3a.AbstractS3ATestBase#teardown}} to\r\n\r\n{code:java}\r\n  @Override\r\n  public void teardown() throws Exception {\r\n    super.teardown();\r\n    boolean fsCacheDisabled = getConfiguration()\r\n        .getBoolean(FS_S3A_IMPL_DISABLE_CACHE, false);\r\n    if(fsCacheDisabled){\r\n      describe(\"closing file system\");\r\n      LOG.warn(\"Closing fs. FS_S3A_IMPL_DISABLE_CACHE: \" + fsCacheDisabled);\r\n      IOUtils.closeStream(getFileSystem());\r\n    }\r\n  }\r\n{code}\r\n\r\nAnd there were still issues after this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-10-10T13:47:12.335+0000","updated":"2018-10-10T14:19:45.950+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16645064","id":"16645064","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"maybe ask the fs itself, e,g\r\n\r\n{code}\r\nif (fs!=null) {\r\nfs.getCacheDisabled = fs.getConfiguration.getBoolean()\r\n\r\n|\r\n{code}\r\nAnyway, I think the \"allow tests to explicitly declare when they want closing\" is better","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2018-10-10T14:42:17.362+0000","updated":"2018-10-10T14:42:17.362+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16700370","id":"16700370","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"fyi [~adam.antal] I've created an issue for the problems when file caching is disabled: HADOOP-15796","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-11-27T12:48:47.855+0000","updated":"2018-11-27T12:48:47.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16700823","id":"16700823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"I looked through the affected tests, and maybe this comprehensive list can help to escalate this.\r\n I used [~gabor.bota]'s patch and the S3ACloseEnforcedFileSystem in it.\r\n Only the AbstractS3ATestBase's subtests are affected, and can be grouped by the following (also grouped further by common superclass):\r\n # Failing tests due to \"Using closed FS!\" with enabled cache\r\n ** ITestS3AInconsistency\r\n ** ITestS3AMiscOperations\r\n ** ITestS3AMiniYarnCluster\r\n ** ITestS3AEmptyDirectory\r\n ** ITestS3GuardEmptyDirs\r\n ** ITestS3ADelayedFNF\r\n ** ITestS3ACopyFromLocalFile\r\n ** ITestS3GuardListConsistency\r\n ** ITestS3AMetrics\r\n ** S3AScaleTestBase\r\n *** AbstractITestS3AMetadataStoreScale\r\n **** ITestLocalMetadataStoreScale\r\n **** ITestDynamoDBMetadataStoreScale\r\n *** ITestS3ADeleteManyFiles\r\n **** ITestS3ADeleteFilesOneByOne\r\n *** ITestS3AInputStreamPerformance\r\n *** ITestS3AConcurrentOps\r\n *** ITestS3ADirectoryPerformance\r\n *** ITestS3ACreatePerformance\r\n ** ITestS3GuardCreate\r\n ** ITestS3GuardWriteBack\r\n ** AbstractS3GuardToolTestBase\r\n *** ITestS3GuardToolDynamoDB\r\n *** ITestS3GuardToolLocal\r\n ** ITestAssumeRole\r\n ** ITestS3GuardConcurrentOps\r\n ** ITestS3AFileOperationCost\r\n ** ITestS3ABlocksize\r\n ** ITestS3AClosedFS\r\n ** AbstractCommitITest\r\n *** ITestS3ACommitterFactory\r\n # Tests not failing and having explicitly disabled cache\r\n ** ITestS3AMultipartUtils\r\n ** ITestS3GuardTtl\r\n ** ITestS3AFailureHandling\r\n ** AbstractSTestS3AHugeFiles\r\n *** ITestS3AHugeFilesDiskBlocks\r\n **** ITestS3AHugeFilesSSECDiskBlocks\r\n *** ITestS3AHugeMagicCommits\r\n *** ITestS3AHugeFilesArrayBlocks\r\n *** ITestS3AHugeFilesByteBufferBlocks\r\n ** ITestS3ABlockOutputArray\r\n *** ITestS3ABlockOutputByteBuffer\r\n *** ITestS3ABlockOutputDisk\r\n ** AbstractCommitITest\r\n *** AbstractITCommitProtocol\r\n **** ITestStagingCommitProtocol\r\n ***** ITestDirectoryCommitProtocol\r\n ***** ITestPartitionedCommitProtocol\r\n **** ITestMagicCommitProtocol\r\n # Already ignored tests in the testsuite\r\n ** ITestS3AEncryptionAlgorithmValidation\r\n # Ignored tests by me due to another stuff\r\n ** ITestS3ATemporaryCredentials: Bug in test\r\n ** AbstractCommitITest: Bug: BouncyCastle not found exception\r\n *** AbstractITCommitMRJob\r\n **** ITStagingCommitMRJobBadDest\r\n **** ITMagicCommitMRJob\r\n **** ITDirectoryCommitMRJob\r\n **** ITStagingCommitMRJob\r\n **** ITPartitionCommitMRJob\r\n ** AbstractTestS3AEncryption: Auth tests were not set up\r\n\r\nApart from the ignored tests either by me or by default, the strange thing is that *tests have either failed or had explicitly disabled cache but not both*. In the list above you can see the list of tests, where the first category is where tests have failed but in the configuration the disabling cache option was not added (checked every level in the class hierarchy), and the second category where cache is explicitly disabled, but those tests have never failed during my examination.\r\n\r\nIt has taken some time looking through them, but I checked every one of the tests (still I might have made a mistake) and every config having (indirect) superclass AbstractS3ATestBase.\r\n\r\nWhat's more interesting is that if I manually add a plus {{S3ATestUtils.disableFilesystemCaching}} call to the {{createConfiguration}} method of AbstractS3ATestBase (so not to the xml) I get only a single exception instead of the dozens above: only in {{ITestS3ACommitterFactory}}.\r\nI also add the output of the single failed test in that case:\r\n\r\n{code:java}\r\n2018-11-27 18:55:08,036 [JUnit-testEverything] ERROR s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:checkIfClosed(74)) - Use after close(): \r\njava.lang.RuntimeException: Using closed FS!.\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.checkIfClosed(S3ACloseEnforcedFileSystem.java:73)\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.makeQualified(S3ACloseEnforcedFileSystem.java:115)\r\n\tat org.apache.hadoop.fs.s3a.commit.AbstractS3ACommitter.initOutput(AbstractS3ACommitter.java:149)\r\n\tat org.apache.hadoop.fs.s3a.commit.AbstractS3ACommitter.<init>(AbstractS3ACommitter.java:129)\r\n\tat org.apache.hadoop.fs.s3a.commit.magic.MagicS3GuardCommitter.<init>(MagicS3GuardCommitter.java:73)\r\n\tat org.apache.hadoop.fs.s3a.commit.magic.MagicS3GuardCommitterFactory.createTaskCommitter(MagicS3GuardCommitterFactory.java:44)\r\n\tat org.apache.hadoop.fs.s3a.commit.S3ACommitterFactory.createTaskCommitter(S3ACommitterFactory.java:81)\r\n\tat org.apache.hadoop.fs.s3a.commit.AbstractS3ACommitterFactory.createOutputCommitter(AbstractS3ACommitterFactory.java:48)\r\n\tat org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory.createCommitter(ITestS3ACommitterFactory.java:198)\r\n\tat org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory.assertFactoryCreatesExpectedCommitter(ITestS3ACommitterFactory.java:189)\r\n\tat org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory.testImplicitFileBinding(ITestS3ACommitterFactory.java:127)\r\n\tat org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory.testEverything(ITestS3ACommitterFactory.java:112)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\r\n\tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)\r\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:298)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:292)\r\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\n2018-11-27 18:55:08,036 [JUnit-testEverything] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(61)) - FS was closed 1 times by:\r\n2018-11-27 18:55:08,036 [JUnit-testEverything] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(64)) - ----------------- close() #1 ---------------\r\n2018-11-27 18:55:08,036 [JUnit-testEverything] WARN  s3a.S3ACloseEnforcedFileSystem (S3ACloseEnforcedFileSystem.java:logClosers(65)) - java.lang.RuntimeException: close() called here\r\n\tat org.apache.hadoop.fs.s3a.S3ACloseEnforcedFileSystem.close(S3ACloseEnforcedFileSystem.java:83)\r\n\tat org.apache.hadoop.io.IOUtils.cleanupWithLogger(IOUtils.java:280)\r\n\tat org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:298)\r\n\tat org.apache.hadoop.fs.s3a.AbstractS3ATestBase.teardown(AbstractS3ATestBase.java:55)\r\n\tat org.apache.hadoop.fs.s3a.commit.AbstractCommitITest.teardown(AbstractCommitITest.java:208)\r\n\tat org.apache.hadoop.fs.s3a.commit.AbstractITCommitProtocol.teardown(AbstractITCommitProtocol.java:180)\r\n\tat org.apache.hadoop.fs.s3a.commit.magic.ITestMagicCommitProtocol.teardown(ITestMagicCommitProtocol.java:213)\r\n\tat sun.reflect.GeneratedMethodAccessor23.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:33)\r\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:298)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:292)\r\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\n{code}\r\n\r\nPlease also note that I didn't encounter the error messages similar to HADOOP-15796.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-11-27T18:17:19.247+0000","updated":"2018-11-27T18:17:19.247+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16700891","id":"16700891","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"Also tests were run in eu-ireland (eu-west-1).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-11-27T19:18:20.815+0000","updated":"2018-11-27T19:18:20.815+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16703567","id":"16703567","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"I investigated a bit further, and when the caching is disabled in {{AbstractS3ATestBase:createConfiguration()}} and {{ITestS3ACommitterFactory:setup()}} methods, the \"Using closed FS!\" exception does not appear. \r\nNote that the committer uses another config object, so it needs to be added there too.\r\nStrictly speaking there's one failing test, which is {{ITestS3AClosedFS}}, but this is due to the addition of the {{S3ACloseEnforcedFileSystem}}, which raises an exception after closing the fs, but that is exactly what we investigate, so that exception is irrelevant.\r\nIf we decide later to explicitly disable the cache, I upload a patch which fixes the bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-11-29T17:54:06.176+0000","updated":"2018-11-29T17:54:06.176+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16703616","id":"16703616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"Also some minor remark on {{S3ACloseEnforcedFileSystem}}: the method {{processDeleteOnExit()}} should not call the {{checkIfClosed()}} method in {{S3ACloseEnforcedFileSystem}}, because the former is only called after the {{close()}} (the order of the calls is {{S3ACloseEnforcedFileSystem:close() -> S3AFileSystem:close() -> FileSystem:close() -> S3ACloseEnforcedFileSystem:processDeleteOnExit()}}) thus creating misleading errors during the normal close of the filesystem.\r\nI uploaded that for reference.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-11-29T18:20:26.382+0000","updated":"2018-11-29T18:26:47.946+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16703729","id":"16703729","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"Strangely I rerun the tests in trunk with no modification, and got only one error in {{ITestS3ACommitterFactory}} (same as above). \r\n\r\n{noformat}\r\n[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0.017 s <<< FAILURE! - in org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory\r\n[ERROR] testEverything(org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory)  Time elapsed: 0.016 s  <<< ERROR!\r\njava.io.IOException: s3a://adamantal-hdfs-s3-dev: FileSystem is closed!\r\n\tat org.apache.hadoop.fs.s3a.commit.ITestS3ACommitterFactory.setup(ITestS3ACommitterFactory.java:94)\r\n{noformat}\r\n\r\nProbably this is due to the fixes in HADOOP-15947, HADOOP-15798 or HADOOP-15370. Still there is one more error, but it can be resolved with either disabling caching, or by investigating why the closed S3AFS is returned from {{FileSystem.get()}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-11-29T20:05:59.511+0000","updated":"2018-11-29T20:05:59.511+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16711783","id":"16711783","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"Hi everyone!\r\n\r\nI uploaded patch v1 with the fix.\r\n Remarks/explanation:\r\n * After thorough investigation of the cache I came to the conclusion that it is work as expected - I did not find any abnormal behaviour. The closed S3AFS must got into the cache somehow, so I tried further logging, and it showed that it was through the {{FileSystem}}'s following function:\r\n{code:java}\r\n@VisibleForTesting\r\n   static void addFileSystemForTesting(URI uri, Configuration conf,\r\n       FileSystem fs) throws IOException {\r\n       CACHE.map.put(new Cache.Key(uri, conf), fs);\r\n   }\r\n{code}\r\n\r\n * It turned out that among the hadoop-aws integration tests there's only one usage of this function, and the stack trace is the following:\r\n{code:java}\r\nCACHE.map.put(new Cache.Key(uri, conf), fs) ->\r\n  FileSystem.addFileSystemForTesting(uri, conf, fs) ->\r\n    FileSystemTestHelper.addFileSystemForTesting(uri, conf, wrapperFS) ->\r\n      AbstractITCommitProtocol.bindFileSystem(FileSystem fs, Path path, Configuration conf) ->\r\n        AbstractITCommitProtocol.setup()\r\n{code}\r\n\r\n * (Note that there are other usage in the test suite, but for integration tests this is the only one).\r\n * This function directly injects the FS into the FSCache (which can be in the cache already, but with another key), but as I wrote it in my previous comment, the caching is explicitly disabled in {{AbstractITCommitProtocol}} since in {{AbstractITCommitProtocol.createConfiguration()}} we call {{disableFilesystemCaching(conf)}}.\r\n * So this FS is in the cache, but it is never returned by {{FileSystem.get()}} since the cache is disabled. Instead a new S3AFileSystem object is returned in each call.\r\n * During teardown the FS is closed, and it's got removed from the cache *but the only removed key-value pair is the injected one.* If there was other key-value pair that has the same FS as value, it is kept in the cache. So after this action one key with one closed FS value as pair could remain in the FSCache.\r\n * The tests are running in the JVM so the next test case which tries to access a FS with {{s3a}} scheme without disabled cache gets this closed FS, and runs into the known error.\r\n * Since the cache is disabled there's no need to explicitly use that {{bindFileSystem}} method. My easy fix is to remove it.\r\n * This function is rarely used in tests, that may explain why we got this error and why no one has ever encountered errors like this. To sum it up, the cache is working as intended, but the misuse was the root of the issue. Maybe we should consider deleting it since it cause unforeseen effects like this (note that this function has only one usage except hadoop-aws).\r\n\r\nPlease verify my observations and please also check that the fix is working indeed.\r\n I also note that {{ITestS3ACommitterFactory}} is still failing, there was another error which got hidden by the \"closed fs\" error.\r\n\r\nRegards,\r\n Adam","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-06T17:49:01.301+0000","updated":"2018-12-06T17:49:01.301+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16711917","id":"16711917","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"I'd also like to add that it worked for my disabled-cache version of trunk (so I disabled cache for {{AbstractITCommitProtocol}} previously) - it was added to the patch as well. It actually works without disabling cache (so only removing the bindFileSystem call).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-06T19:30:11.620+0000","updated":"2018-12-19T13:59:46.605+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16711957","id":"16711957","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"Thanks [~adam.antal], I'll test it tomorrow up and downstream.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-12-06T19:58:09.596+0000","updated":"2018-12-06T19:58:09.596+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16711966","id":"16711966","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"I'm sorry, uploaded bad patch (reuploaded the right one [^HADOOP-15819.001.patch] ).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-06T20:04:54.274+0000","updated":"2018-12-06T20:04:54.274+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16712683","id":"16712683","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"Thanks [~adam.antal], could you remove the bad one?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-12-07T11:15:34.609+0000","updated":"2018-12-07T11:15:34.609+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16713791","id":"16713791","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"I removed it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-08T22:02:28.450+0000","updated":"2018-12-08T22:02:28.450+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16721551","id":"16721551","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"Thanks for the patch [~adam.antal].\r\nNot just the call, but the whole method could be removed: org.apache.hadoop.fs.s3a.commit.AbstractITCommitProtocol#bindFileSystem, because there are no other call for that method.\r\n\r\nI think adding the fs to the cache with {{FileSystemTestHelper.addFileSystemForTesting}} from {{AbstractITCommitProtocol#bindFileSystem}} is not needed, because we will use the same FileSystem object throughout the tests from {{getFileSystem().}}\r\n\r\n[~mackrorysd] do could you add some thoughts if removing the bindFileSystem is a good fix for this issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2018-12-14T15:54:14.186+0000","updated":"2018-12-14T15:54:14.186+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16723105","id":"16723105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"Thanks, [~gabor.bota]. I uploaded patch [^HADOOP-15819.002.patch] (removed the unused method).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-17T15:56:43.724+0000","updated":"2018-12-17T15:56:43.724+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16724301","id":"16724301","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mackrorysd","name":"mackrorysd","key":"mackrorysd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mackrorysd&avatarId=18559","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mackrorysd&avatarId=18559","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mackrorysd&avatarId=18559","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mackrorysd&avatarId=18559"},"displayName":"Sean Mackrory","active":true,"timeZone":"America/Denver"},"body":"The only failure I see with this patch is the bouncycastle one. I don't have an objection to removing this - it's only for a slight perf improvement on tests. I'm curious to know why this is resulting an a distinct cache entry. Is the URL slightly different at this point than it is in FS.newInstance() or something?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mackrorysd","name":"mackrorysd","key":"mackrorysd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mackrorysd&avatarId=18559","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mackrorysd&avatarId=18559","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mackrorysd&avatarId=18559","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mackrorysd&avatarId=18559"},"displayName":"Sean Mackrory","active":true,"timeZone":"America/Denver"},"created":"2018-12-18T17:53:11.017+0000","updated":"2018-12-18T17:53:11.017+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16725168","id":"16725168","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"Not exactly, to be more clear though I enumerate the events when calling any subtest of {{AbstractITCommitProtocol}}:\r\n* During the very first moment of the startup {{setup()}} and {{init()}} functions are called. Concretely {{AbstractBondedFSContract}}  creates and stores a new {{FileSystem}} instance of the proper type.\r\n** Later, each time the getFileSystem() is called, it returns this \"cached\" instance (This is NOT the FSCache! just a private data member of {{AbstractBondedFSContract}}).\r\n** Note: since {{AbstractITCommitProtocol.createConfiguration()}} contains {{disableFilesystemCaching(conf)}}, the cache is disabled. Each time this Configuration object is used anywhere in the test, it returns a newly created instance by the static {{FileSystem.get()}} method.\r\n* During this startup in {{AbstractITCommitProtocol.setup()}} the line {{bindFileSystem(fileSystem, outDir, fileSystem.getConf());}} is executed as well. We call the internal {{getFileSystem()}}, which returns the already created and stored instance, and inject it directly into the FSCache.\r\n* The test runs using the stored instance and the non-cached instances of FileSystem.\r\n* During teardown we close the stored FileSystem object as usual, BUT since we didn't put this instance into the FSCache the regular way it got stuck in the cache. Although the {{close()}} contains this call: {{CACHE.remove(this.key, this);}}, the {{this.key}} (so the FileSystem's FileSystem.Cache private member) is not set. It would have been set, if it had been put to the cache in the regular way, but not by injection. More concretely {{Cache.getInternal}} sets this.key of the FileSystem object, which is surpassed when the FS instance is manually injected.\r\n* Later, in the same JVM another test is setting up using the {{s3a://}} scheme, this object gets retrieved from the cache (since it's not removed), but now it's closed, and boom.\r\n\r\nI'd rather not mess with manual injection, that's why I proposed to delete the binding.\r\n\r\nI wasn't 100% right with my previous comment (you can practically ignore that), but I think this is correct way how things work. Still I can make mistakes, so please review my thoughts on this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-19T16:40:11.731+0000","updated":"2018-12-19T16:40:11.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16725544","id":"16725544","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mackrorysd","name":"mackrorysd","key":"mackrorysd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mackrorysd&avatarId=18559","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mackrorysd&avatarId=18559","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mackrorysd&avatarId=18559","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mackrorysd&avatarId=18559"},"displayName":"Sean Mackrory","active":true,"timeZone":"America/Denver"},"body":"Ah - FS.key not being set is the piece I was missing. I suppose the truly correct solution here would be to make sure FS.key is set properly, but I don't know that the benefit to that is worth a whole lot of your time. I'll hold off for a day in case [~stevel@apache.org] who wrote this in the first place disagrees. Otherwise +1 and I'll commit soon.\r\n\r\nAs a side note, I noticed StagingTestBase has a call to the same function, but obviously isn't causing the same issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mackrorysd","name":"mackrorysd","key":"mackrorysd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mackrorysd&avatarId=18559","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mackrorysd&avatarId=18559","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mackrorysd&avatarId=18559","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mackrorysd&avatarId=18559"},"displayName":"Sean Mackrory","active":true,"timeZone":"America/Denver"},"created":"2018-12-20T03:05:06.383+0000","updated":"2018-12-20T03:05:06.383+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16725843","id":"16725843","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"Indeed. \r\nI also saw that it is used elsewhere, so I would not recommend modifying the function by manually setting the FS.key there. In my opinion if we manually inject the FS into the cache maybe we should manually remove it (for e.g. in the teardown of the test). Although I still don't see why injecting is necessary.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-20T13:41:54.193+0000","updated":"2018-12-20T13:41:54.193+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16726305","id":"16726305","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabbri","name":"fabbri","key":"fabbri","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fabbri&avatarId=24131","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fabbri&avatarId=24131","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fabbri&avatarId=24131","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fabbri&avatarId=24131"},"displayName":"Aaron Fabbri","active":true,"timeZone":"America/Los_Angeles"},"body":"Just catching up on this as I hit the bug again. Sounds like a great find [~adam.antal].","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabbri","name":"fabbri","key":"fabbri","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fabbri&avatarId=24131","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fabbri&avatarId=24131","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fabbri&avatarId=24131","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fabbri&avatarId=24131"},"displayName":"Aaron Fabbri","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-12-20T23:15:58.528+0000","updated":"2018-12-20T23:15:58.528+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16729682","id":"16729682","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mackrorysd","name":"mackrorysd","key":"mackrorysd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mackrorysd&avatarId=18559","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mackrorysd&avatarId=18559","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mackrorysd&avatarId=18559","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mackrorysd&avatarId=18559"},"displayName":"Sean Mackrory","active":true,"timeZone":"America/Denver"},"body":"Committed. Thank you for the excellent work here [~adam.antal].","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mackrorysd","name":"mackrorysd","key":"mackrorysd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mackrorysd&avatarId=18559","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mackrorysd&avatarId=18559","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mackrorysd&avatarId=18559","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mackrorysd&avatarId=18559"},"displayName":"Sean Mackrory","active":true,"timeZone":"America/Denver"},"created":"2018-12-27T15:53:57.984+0000","updated":"2018-12-27T15:53:57.984+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16729695","id":"16729695","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #15665 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/15665/])\nHADOOP-15819. FileSystem cache misused in S3A integration tests. (mackrorysd: rev d8f670ff28c1a9f49ef908a23850bcfddd4f46dc)\n* (edit) hadoop-tools/hadoop-aws/src/test/java/org/apache/hadoop/fs/s3a/commit/AbstractITCommitProtocol.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-27T16:10:16.964+0000","updated":"2018-12-27T16:10:16.964+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16729701","id":"16729701","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"body":"Thanks [~mackrorysd] for the commit. The credit goes to [~gabor.bota] who started the investigation, and also to [~stevel@apache.org] for the useful comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adam.antal","name":"adam.antal","key":"adam.antal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Adam Antal","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-27T16:17:32.496+0000","updated":"2018-12-27T16:17:32.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16731950","id":"16731950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"quick follow up here: do we need to add anything to the testing s3a doc for anyone writing new tests?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2019-01-02T11:12:25.255+0000","updated":"2019-01-02T11:12:25.255+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16732172","id":"16732172","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mackrorysd","name":"mackrorysd","key":"mackrorysd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mackrorysd&avatarId=18559","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mackrorysd&avatarId=18559","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mackrorysd&avatarId=18559","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mackrorysd&avatarId=18559"},"displayName":"Sean Mackrory","active":true,"timeZone":"America/Denver"},"body":"I wouldn't have thought so as I think you have to go our of your way to do something you don't usually do to hit this, but then I don't fully understand why this was added in the first place. I think the patch originally came from you - do you happen to remember why we started adding the FS instance to the cache here? And if so, is that something that might occur to a future test writer as well?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mackrorysd","name":"mackrorysd","key":"mackrorysd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mackrorysd&avatarId=18559","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mackrorysd&avatarId=18559","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mackrorysd&avatarId=18559","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mackrorysd&avatarId=18559"},"displayName":"Sean Mackrory","active":true,"timeZone":"America/Denver"},"created":"2019-01-02T15:54:07.863+0000","updated":"2019-01-02T15:54:07.863+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16733167","id":"16733167","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"We could extend the docs with something like \"Do not add FileSystem instances (with e.g org.apache.hadoop.fs.FileSystem#addFileSystemForTesting) to the cache that will be modified during the test runs. This can cause other tests to fail when using the same modified or closed FS instance. For more details see HADOOP-15819.\"\r\n\r\nShould I create a new jira for this and upload a patch?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2019-01-03T15:51:45.513+0000","updated":"2019-01-03T15:52:25.631+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16733557","id":"16733557","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"I think we should write something down about \"effective use of FS instances\", so yes, a new JIRA please\r\n\r\nI wonder what we should say\r\n\r\n# tests are fastest if they can recycle the existing FS instance from the same JVM\r\n# if you do that, you MUST NOT close them.\r\n# if you want a guarantee of 100% isolation, or an instance with unique config, create a new instance\r\n# which you MUST close in teardown to avoid leakage of thread pools &c.\r\n\r\n+ what you've proposed \"do not add...\", with the other point being \"only do this if you are trying to get unmodified code to pick up your custom instance, such as when playing with mocks\"\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2019-01-03T21:54:50.395+0000","updated":"2019-01-03T21:54:50.395+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13189417/comment/16734141","id":"16734141","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"body":"Created HADOOP-16027 to add this to docs.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gabor.bota","name":"gabor.bota","key":"gabor.bota","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gabor.bota&avatarId=33034","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gabor.bota&avatarId=33034","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gabor.bota&avatarId=33034","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gabor.bota&avatarId=33034"},"displayName":"Gabor Bota","active":true,"timeZone":"Europe/Budapest"},"created":"2019-01-04T13:45:19.685+0000","updated":"2019-01-04T13:45:19.685+0000"}],"maxResults":37,"total":37,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15819/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3ytuv:"}}