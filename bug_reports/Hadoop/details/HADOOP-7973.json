{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12538335","self":"https://issues.apache.org/jira/rest/api/2/issue/12538335","key":"HADOOP-7973","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2012-01-13T17:01:41.023+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Oct 17 22:06:46 UTC 2012","customfield_12310420":"223841","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_23834398895_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-10-15T13:20:16.619+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-7973/watchers","watchCount":23,"isWatching":false},"created":"2012-01-13T16:40:17.739+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12318244","id":"12318244","description":"1.0.0 release","name":"1.0.0","archived":false,"released":true,"releaseDate":"2011-12-27"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-10-17T22:06:46.017+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310689","id":"12310689","name":"fs","description":"Generic FileSystem code"}],"timeoriginalestimate":null,"description":"The way {{FileSystem#close}} works is very problematic.  Since the {{FileSystems}} are cached, any {{close}} by any caller will cause problems for every other reference to it.  Will add more detail in the comments.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316501","id":"12316501","description":"1.1.0 release","name":"1.1.0","archived":false,"released":true,"releaseDate":"2012-10-13"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12510501","id":"12510501","filename":"HADOOP-7973.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-13T17:20:52.710+0000","size":636,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12510501/HADOOP-7973.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12510917","id":"12510917","filename":"HADOOP-7973-2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-17T23:43:54.850+0000","size":4839,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12510917/HADOOP-7973-2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12511064","id":"12511064","filename":"HADOOP-7973-3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-18T23:58:13.194+0000","size":3415,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12511064/HADOOP-7973-3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12511162","id":"12511162","filename":"HADOOP-7973-4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-19T20:26:09.189+0000","size":8746,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12511162/HADOOP-7973-4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12511719","id":"12511719","filename":"HADOOP-7973-5.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-24T20:13:24.860+0000","size":20304,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12511719/HADOOP-7973-5.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"43928","customfield_12312823":null,"summary":"DistributedFileSystem close has severe consequences","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185669","id":"13185669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"\nWe are seeing two specific failure cases with the same cause:\n* A MR task that uses {{FsShell}}.  The shell opens a DFS, performs it's action, and the shell will close the DFS.  Now the MR input stream close to that same fileystem will fail.\n* User map task code that opens the default filesystem and subsequently closes it.  MR input stream close will fail.\n\nThe problem is being seen with oozie jobs, but is not unique to oozie.  If the MR tasks opens the input/output streams with a DFS lacking a port number, then it gets a different instance of the filesystem than user code which gets the default filesystem via {{fs.default.name}} which does include the port number.  Effectively, the issue is hidden, and arguably it's a bug that getting a filesystem with and without the default port returns different filesystem instances.\n\nThere are 3 approaches that can be taken:\n# {{FsShell#close}} will be a no-op\n# Closing a read stream will not generate an exception if the {{DFSClient}} is closed.\n# {{DistributedFileSystem#close}} becomes a no-op.  The finalizer will close the {{DFSClient}}.\n\n#1 & #2 are simply workarounds for specific use-cases.  The problem can still happen if user code or libraries get a filesystem and close it.\n\n#3 is a more comprehensive solution since a decision was made on an earlier jira to not add reference counting to cached filesystem objects.\n\nI'll post a patch for #3.  Please provide comments if there are superior solutions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-13T16:55:36.657+0000","updated":"2012-01-13T16:55:36.657+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185671","id":"13185671","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"body":"I think it is important to note that this appears to be a regression between 0.20.204 and 1.0.  With oozie on 0.20.204 there were no errors running FSShell using a java actions, but after upgrading to 1.0 it fails consistently with an exception caused by the FileSystem.close() call in FSShell.close().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"created":"2012-01-13T17:01:41.023+0000","updated":"2012-01-13T17:01:41.023+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185683","id":"13185683","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"It's unclear what all changes transpired, but somehow oozie MR tasks used a DFS uri w/o a port for in/out dirs, while the task code used the {{fs.default.name}} which does include the port.  The problem was masked due to two distinct filesystem instances.  If filesystem is fixed to return the same object for a uri with and w/o the default port, then the problem comes back again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-13T17:19:29.517+0000","updated":"2012-01-13T17:19:29.517+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185684","id":"13185684","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"No tests because I'm only posting for community comment at this point.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-13T17:20:52.909+0000","updated":"2012-01-13T17:20:52.909+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185706","id":"13185706","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"Daryn this happens only if use_ip is set to false right. This problem should not happen on default configuration?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-13T17:59:51.550+0000","updated":"2012-01-13T17:59:51.550+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185733","id":"13185733","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"Some comments:\nbq. a decision was made on an earlier jira to not add reference counting to cached filesystem objects\nReference counting will not work. One could get a file system instance and pass it to others and then close it. This kind of code might exist in the framework.\n\nbq. DistributedFileSystem#close becomes a no-op. The finalizer will close the DFSClient.\nWhat is the finalizer - java finalizer? or you mean garbage collection?\n\nFile system cache has been a problem that has been lurking for a while. App is expected to write the correct code - that is if the file system is closed, do not use it post that. However I am not sure if apps do handle this correctly.\n\nOther alternative solution is to disable cache. This is already configurable. See the following snippet in FileSystem.java\n{noformat}\n    String disableCacheName = String.format(\"fs.%s.impl.disable.cache\", scheme);\n    if (conf.getBoolean(disableCacheName, false)) {\n      return createFileSystem(uri, conf);\n    }\n{noformat}\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-13T18:23:10.150+0000","updated":"2012-01-13T18:23:10.150+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185744","id":"13185744","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. What is the finalizer - java finalizer? or you mean garbage collection?\nIgnore this comment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-13T18:49:18.947+0000","updated":"2012-01-13T18:49:18.947+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185769","id":"13185769","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"I don't think it's related to use_ip, but I'll double check.  Even if it is related, it's still a bug.  I think using a finalizer avoids the problem you describe where something gets a fs, passes it to others, then closes it.  Or will a finalizer introduce other problems?\n\nbq.  App is expected to write the correct code - that is if the file system is closed, do not use it post that. However I am not sure if apps do handle this correctly.\n\nLet's say I'm using DFS.  I use some other package that opens the same default DFS, does something, and then closes it.  Whatever I was doing before I called the external routine is now invalidated.  What if I was writing to an output stream?  How would apps be able to reasonably recover from their fs being unexpectedly closed when there's not really an error?  Or am I misunderstanding your intent?\n\nbq.  Other alternative solution is to disable cache\n\nIsn't this going to cause multiple sockets to the same namenode?  For code that doesn't explicitly call close (perhaps because of this bug), that results in leaked fds that tie up resources.  I vaguely seem to recall that disabling the cache for a job would cause the JT(?) to overwhelm the namenode with connections.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-13T19:16:26.845+0000","updated":"2012-01-13T19:16:26.845+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185779","id":"13185779","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. I don't think it's related to use_ip, but I'll double check.\nI suspect that is the case. Otherwise, we really should understand what started this problem.\n\nbq. Or will a finalizer introduce other problems?\nFinalizers have their own share of problems. Perhaps for file system it may not be severe.\n\nbq. I vaguely seem to recall that disabling the cache for a job would cause the JT to overwhelm the namenode with connections.\nI am not sure if JT creates that many file systems. Some one from mapreduce can comment on this.\n\nbq. DistributedFileSystem#close becomes a no-op. \nThis is a change in the public API.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-13T19:30:00.516+0000","updated":"2012-01-13T19:30:00.516+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185784","id":"13185784","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. Let's say I'm using DFS. I use some other package that opens the same default DFS, does something, and then closes it. Whatever I was doing before I called the external routine is now invalidated. What if I was writing to an output stream? How would apps be able to reasonably recover from their fs being unexpectedly closed when there's not really an error? Or am I misunderstanding your intent?\n\nThe only way to handle is, never call close from the app if you use distributed cache. That way you get the benefit of cache where it is required (such as long running clients that create many file system instances)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-13T19:31:43.346+0000","updated":"2012-01-13T19:31:43.346+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185802","id":"13185802","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"> distributed cache\nSorry I am distracted. I meant file system cache. Long running clients, using file system cache should not call close.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-13T19:57:32.138+0000","updated":"2012-01-13T19:57:32.138+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185825","id":"13185825","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"The problem appears to be a case of two wrongs make a right.  Fixing a bug in HDFS-2450 exposed another bug.  Unlike other filesystems, DFS used to strip the default port from its uris.  Ie.\n{{FileSystem.get(\"hdfs://host:port\").getUri()}} did not return \"hdfs://host:port\".  It returned \"hdfs://host\".\n\nThe result is that MR must be getting another filesystem based on {{getUri()}} of one filesystem.  When the port is stripped, two distinct filesystems are created.  It's a complete fluke that MR worked because of the former bug.\n\nSo is the finalizer approach a no-go, or do you have another solution in mind?  As you mentioned it's a public api, so is it better to \"fix\" the public api, or tell users don't use the public api?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-13T20:26:30.633+0000","updated":"2012-01-13T20:26:30.633+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185837","id":"13185837","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. Unlike other filesystems, DFS used to strip the default port from its uris. Ie.FileSystem.get(\"hdfs://host:port\").getUri() did not return \"hdfs://host:port\". It returned \"hdfs://host\".\nThat still should have resulted in this issue right? May be I do not understand this correctly.\n\nbq. two wrongs make a right\nEither by fluke or not, the system worked. This is the reason why I am very cautious about changes that could have unforeseen outcomes. Because all the interactions and corner cases are not understood.\n\nbq. so is it better to \"fix\" the public api, or tell users don't use the public api?\nUsers are already using those APIs and the API has certain behavior. Turning off that functionality is not backward compatible.\n\nI think of only one solution. See if long running clients are creating a lot of file systems. If not it should be safe to turn off cache. BTW I remember conversations with Dhruba where he had indicated they do not use file system cache.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-13T20:43:14.310+0000","updated":"2012-01-13T20:43:14.310+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185849","id":"13185849","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. Isn't this going to cause multiple sockets to the same namenode? For code that doesn't explicitly call close (perhaps because of this bug), that results in leaked fds that tie up resources. I vaguely seem to recall that disabling the cache for a job would cause the JT to overwhelm the namenode with connections.\n\nConnections are reused right? So this should not be an issue. I remember having some issue related to having file system cache growing huge and causing memory issues. That could still happen. Not sure how this bug was fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-13T21:03:44.159+0000","updated":"2012-01-13T21:03:44.159+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185866","id":"13185866","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"If we tell users don't call {{close()}} then I think that leaves them in an unfortunate predicament of conditionalizing all of the closes.  Ie. If the cache is on, then never call {{close()}}; if the cache is off, then you must call {{close()}} to prevent resources from leaking.  If true, that seems to be a compelling argument to make {{close()}} be smart.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-13T21:20:02.084+0000","updated":"2012-01-13T21:20:02.084+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185875","id":"13185875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jnp","name":"jnp","key":"jnp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jitendra Nath Pandey","active":true,"timeZone":"Etc/UTC"},"body":"{quote}\n  Connections are reused right? So this should not be an issue. I remember having some issue related to having file system cache growing huge and causing memory issues. \n{quote}\n  It is correct that connections are re-used and cache growing huge is also an issue that we have seen before. It was fixed by calling closeAllForUGI in TaskTracker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jnp","name":"jnp","key":"jnp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jitendra Nath Pandey","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-13T21:31:58.475+0000","updated":"2012-01-13T21:31:58.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13185953","id":"13185953","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"We'll experiment on a performance grid and see what happens with the cache off.  I'm concerned about whether GC will keep up with all the leaked {{FileSystem}} and {{DFSClient}} objects.\n\nJust food for thought:  It seems that {{FileSystem#close}} should be smart enough to only close the fs if it's not in the cache (can check via the {{key}} field), but be a no-op if it's in the cache.  A static {{FileSystem}} method for unconditionally closing a cached {{FileSystem}} could provide symmetry to the {{get}} method which populates the cache.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-13T22:58:04.838+0000","updated":"2012-01-13T22:58:04.838+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13186424","id":"13186424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"body":"(Coming in late, but just to add my thoughts…)\n\nI've seen this bite users as well but its more so cause they do not understand how to use the FS objects than anything else:\n\nbq. A MR task that uses FsShell. The shell opens a DFS, performs it's action, and the shell will close the DFS. Now the MR input stream close to that same fileystem will fail.\n\nIs FsShell a publicly supported API now?\n\nbq. User map task code that opens the default filesystem and subsequently closes it. MR input stream close will fail.\n\nUsers should not be closing the FS handle. Users shall open/close streams they use. Is that not the right thing to do?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-01-15T06:02:16.124+0000","updated":"2012-01-15T06:02:16.124+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13187756","id":"13187756","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nroberts","name":"nroberts","key":"nroberts","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nathan Roberts","active":true,"timeZone":"America/Chicago"},"body":"{quote}\nWe'll experiment on a performance grid and see what happens with the cache off. I'm concerned about whether GC will keep up with all the leaked FileSystem and DFSClient objects.\n{quote}\n\nSeems to me that turning off the cache is changing the semantics of FileSystem#close as much as some of the other proposed solutions. Rather than just temporarily avoiding this issue via a config change, can we come up with a more permanent solution that everyone will be happy with?  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nroberts","name":"nroberts","key":"nroberts","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nathan Roberts","active":true,"timeZone":"America/Chicago"},"created":"2012-01-17T15:37:32.086+0000","updated":"2012-01-17T15:37:32.086+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13187777","id":"13187777","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"body":"{quote}Is FsShell a publicly supported API now?{quote}\nFsShell is marked as @InterfaceAudiance.Private on trunk, so no it is not a publicly supported API.  However it is used directly by Pig, and possibly others.  The use that we are referring to is an oozie action like the following.\n\n{code}\n<action name=\"copy\">\n    <java>\n       <job-tracker>${jobTracker}</job-tracker>\n       <name-node>${nameNode}</name-node>\n       <configuration>\n            <property>\n                <name>mapred.job.queue.name</name>\n                <value>${queueName}</value>\n            </property>\n        </configuration>\n        <main-class>org.apache.hadoop.fs.FsShell</main-class>\n        <arg>-cp</arg>\n        <arg>${from}</arg>\n        <arg>${to}</arg>\n   </java>\n</action>\n{code}\n\nThis is more or less the same as calling {code}hadoop fs -cp $from $to{code} it is done this way because oozie does not support copy from the fs action, because oozie does not want significant amounts of data flowing to or from the node oozie is running on.  Yes this technically is a violation of our interface visibility guidelines, but only very slightly, because it is trying to act very much like {code}hadoop fs{code} which is a public interface.  I am OK with telling the customer to fix their usage of this long term, because this is not what they are supposed to do.  We have already told them this, but the practice is quite pervasive. \n\nIt worked before, it no longer works, and this is simply because our internal code, FsShell, is ignoring the guidelines that we tell everyone else to follow.  Don't call FileSystem.close.  Which kind of reminds me of that scene from \"The Emperor's new Groove\" [\"Why do we even have that lever\"|http://www.youtube.com/watch?v=AGdFiA0A_c0]  If this API is not supposed to be called, then why has it not been deprecated, and replaced with something that has cleaner semantics that users actually understand.\n\n{quote}I've seen this bite users as well but its more so cause they do not understand how to use the FS objects than anything else:{quote}\nThat seems to point to me that there is something wrong with the API if people who use our main interface have to have a deep understanding of how FileSystem caching works, and what is more that it can be disabled.  I believe that we may want to leave FileSystem.close in place but deprecate it, and provide a method that does the expected behavior of closing the FileSystem if it is not part of the cache, or nothing if it is part of the cache.  At the same time, we update FsShell to use this new API.\n\nI want to reiterate that I am not condoning the behavior that has exposed this issue.  But we have customers that are doing this, and I would really like to unblock them.  Especially if I can unblock them with a tiny change on our part instead of a massive change on their part.  Especially if doing so seems to fix an API that is causing problems. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"created":"2012-01-17T16:18:17.468+0000","updated":"2012-01-17T16:18:17.468+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13187969","id":"13187969","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"body":"To complicate things a bit more, keep in mind that if you do ask for FS instance using 2 different UGI instances for the same  user you end up with 2 different FS instances in the cache. This behavior -not to choke the NN- forced Oozie to do a second level cache of FS instances using the username.\n\nIn Oozie we've talked about moving all the Hadoop interactions to a a command pattern where FS and JC get created/closed before/after the command invocation. And disabling caches completely. This is a huge change in Oozie but I guess we'll eventually go for it. What I don't know what will be the impact on security infrastructure (Kerberos) if suddenly, instead of getting new FS on & off (the first time a user comes to the system), it will be for each app interaction done by Oozie on behalf of the user.\n\nOne possibility would be to make the cache to timeout on inactivity and the FS instance to reconnect if timedout.\n\nThis issue is becoming bigger as we have long running systems using Hadoop, instead command line calls.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2012-01-17T20:24:52.853+0000","updated":"2012-01-17T20:24:52.853+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13188025","id":"13188025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"bq. It is correct that connections are re-used and cache growing huge is also an issue that we have seen before. It was fixed by calling closeAllForUGI in TaskTracker.\n\nIf the cache is turned off, doesn't the {{FileSystem.closeAllForUGI}} improvement become irrelevant since it depends on the cache to locate the objects to close?  Ie.  Won't the {{FileSystem}}, {{DFSClient}}, and {{Connection}} float in limbo and bloat memory until the GC finalizes them?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-17T21:31:14.665+0000","updated":"2012-01-17T21:31:14.665+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13188129","id":"13188129","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"There's opposition to disabling the cache, so here's an alternate approach to the problem.  I'm again only posting untested code for community comment.\n\nBasically if the FS is cached, then it isn't closed until removed from the cache.  This allows the cache to remain enabled so {{FileSystem.closeAll}}, {{FileSystem.closeAllForUGI}}, etc continue to work as intended: boost performance and not let objects leak.  If caching is disabled, then the object is immediately closed.\n\nPlease critique.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-17T23:43:55.085+0000","updated":"2012-01-17T23:43:55.085+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13188187","id":"13188187","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"body":"Daryn, in your proposal, if the FS is cached, close() would be a NOP. How would you remove the FS from the cache?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tucu00","name":"tucu00","key":"tucu00","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alejandro Abdelnur","active":true,"timeZone":"Europe/Madrid"},"created":"2012-01-18T01:40:11.074+0000","updated":"2012-01-18T01:40:11.074+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13188546","id":"13188546","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"I thought about that myself.  If close removes a cached object from the cache, it's still hard to know exactly when to close it since other references may exist.  I have a much better idea in mind, will post example shortly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-18T16:53:19.581+0000","updated":"2012-01-18T16:53:19.581+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13188725","id":"13188725","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"I'm going to try another approach of making MR get unique filesystems w/o relying on the fluke caused by the hdfs bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-18T21:52:13.399+0000","updated":"2012-01-18T21:52:13.399+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13188818","id":"13188818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Idea is basically to allow MR to be backward-compatible by maintaining cached FS objects that are distinct from the FS objects used by user code.  That's exactly how it used to work due to the DFS port-stripping bug.\n\nI pulled in minimal changes from trunk to allow a unique id in the FS cache key.  I didn't pull in the new APIs, but rather smuggled a unique id in via a config setting. It's not the cleanest, but I'm open to alternatives.\n\nI've probably missed a few spots in the MR framework, but I'd like comments on the approach before I go further.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-18T23:58:13.322+0000","updated":"2012-01-18T23:58:13.322+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13189358","id":"13189358","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Add tests.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-19T20:26:09.283+0000","updated":"2012-01-19T20:26:09.283+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13189388","id":"13189388","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=devaraj","name":"devaraj","key":"devaraj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Devaraj Das","active":true,"timeZone":"Pacific/Pitcairn"},"body":"bq. #3 is a more comprehensive solution since a decision was made on an earlier jira to not add reference \n\nDaryn, which jira are you referring to here? I and Jitendra were discussing about Reference Counting and it seemed to work for this use-case.. Suresh had argued against reference-counting, but that argument holds even if the cache is disabled...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=devaraj","name":"devaraj","key":"devaraj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Devaraj Das","active":true,"timeZone":"Pacific/Pitcairn"},"created":"2012-01-19T21:25:53.728+0000","updated":"2012-01-19T21:25:53.728+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13189496","id":"13189496","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"I don't recall the jira but it was quite a few years old and very lively.  Last week I spoke to Suresh about ref counts and he did have some legitimate concerns.  After further reflection, fs.close also closes open streams and that behavior might be expected in some cases.  Unbalanced opens & closes would lead to situations where a close, that formerly caused all fs streams to close, would be deferred into the future (if ever).\n\nI'm fine with revisiting ref counts or a more comprehensive handling of close.  In this case, my suggestion would be on another jira targeted to trunk.  I've scaled back the \"fix\" to be as minimal as possible, and not alter any existing behaviors.  Yes, it's a bit of a hack, but I'm paranoid of breaking something on 205/1.x and this bug is slowing production deployment.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-19T23:40:06.330+0000","updated":"2012-01-19T23:40:06.330+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13189502","id":"13189502","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"It's probably HADOOP-4655.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2012-01-19T23:46:52.702+0000","updated":"2012-01-19T23:46:52.702+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13189648","id":"13189648","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jnp","name":"jnp","key":"jnp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jitendra Nath Pandey","active":true,"timeZone":"Etc/UTC"},"body":"bq. Unbalanced opens & closes would lead to situations where a close, that formerly caused all fs streams to close, would be deferred into the future (if ever).\n\nIt is a very common usage pattern that filesystem objects are not closed at all, therefore it should be ok to have less number of closes than opens, with reference count.\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jnp","name":"jnp","key":"jnp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jitendra Nath Pandey","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-20T06:39:14.043+0000","updated":"2012-01-20T06:39:14.043+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13189657","id":"13189657","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"body":"I [opposed ref counts previously|https://issues.apache.org/jira/browse/HADOOP-4655?focusedCommentId=12650342&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12650342] since it is indeed a \"get counts\".  It relies on the assumption that \"for each FileSystem.get(..) call, the must be exactly a close() call.\"  I think this is not easy to enforce.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-20T07:01:54.897+0000","updated":"2012-01-20T07:01:54.897+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13189830","id":"13189830","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"With unbalanced closes, the filesystem will essentially never be closed unless {{closeAll}} or {{closeAllForUGI}} is called.  Open files & their leases will remain open.  It's a more complicated change that will alter the behavior of 205 with possibly unforeseen consequences.  I'm attempting to only restore 204 behavior with this jira.\n\nI know the private conf value is a bit of a hack, but I see no other way to allow unique filesystems -- and in this case, a secondary cache just for MR framework -- without changing the public api of {{FileSystem}}.  Is this implementation unacceptable?  If so, are there simple alternatives other than ref counts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-20T14:36:59.324+0000","updated":"2012-01-20T14:36:59.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13190006","id":"13190006","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knoguchi","name":"knoguchi","key":"knoguchi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Koji Noguchi","active":true,"timeZone":"America/New_York"},"body":"bq. Add tests.\n\nLooking at HADOOP-7973-4.patch, does it reproduce the issue we are seeing?\nIn my environment, this test succeeds without your change.  I guess you would need minidfs cluster instead of running miniMR on top of local filesystem?\n\nAlso, for the actual change, is this sufficient to avoid the close failure?  I thought that FileSystem throwing the actual error is not from the MapTask directly but the one opened inside TextInputFormat->LineRecordReader\n\n{noformat}\n2012-01-13 00:08:09,268 WARN org.apache.hadoop.mapred.Child: Error running child\njava.io.IOException: Filesystem closed\n        at org.apache.hadoop.hdfs.DFSClient.checkOpen(DFSClient.java:241)\n        at org.apache.hadoop.hdfs.DFSClient.access$800(DFSClient.java:74)\n        at org.apache.hadoop.hdfs.DFSClient$DFSInputStream.close(DFSClient.java:1959)\n        at java.io.FilterInputStream.close(FilterInputStream.java:155)\n        at org.apache.hadoop.util.LineReader.close(LineReader.java:83)\n        at org.apache.hadoop.mapred.LineRecordReader.close(LineRecordReader.java:168)\n        at org.apache.hadoop.mapred.MapTask$TrackedRecordReader.close(MapTask.java:254)\n        at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:440)\n        at org.apache.hadoop.mapred.MapTask.run(MapTask.java:372)\n        at org.apache.hadoop.mapred.Child$4.run(Child.java:255)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at javax.security.auth.Subject.doAs(Subject.java:396)\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1082)\n        at org.apache.hadoop.mapred.Child.main(Child.java:249)\n{noformat}\n\nbq. If the MR tasks opens the input/output streams ...\n\nDoes this apply to output stream as well?  If it really does, then something needs to be changed on the reducer side as well? (I couldn't confirm this.)\n\nbq. I'm attempting to only restore 204 behavior with this jira.\n\nJust to make sure everyone is one the same page,\nthe close issue itself has been there even before 0.20.205/1.0.\n\nWith input/output paths without any 'hdfs://...' set, \"Filesystem closed\" exception above happens on any hadoop 0.20 versions.\n||version|| fs.default.name ||\n|before 0.20.205| hdfs://hostname.domain (without port) |  \n|on 0.20.205 | hdfs://hostname.domain:8020 (with port) | \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knoguchi","name":"knoguchi","key":"knoguchi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Koji Noguchi","active":true,"timeZone":"America/New_York"},"created":"2012-01-20T19:06:37.566+0000","updated":"2012-01-20T19:06:37.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13190080","id":"13190080","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"bq.  I guess you would need minidfs cluster instead of running miniMR on top of local filesystem?\n\nI wasn't aware the MR minicluster used local fs, I'll check that.  The beauty is if I've missed something, the tests will immediately fail.\n\nbq. Also, for the actual change, is this sufficient to avoid the close failure? I thought that FileSystem throwing the actual error is not from the MapTask directly but the one opened inside TextInputFormat->LineRecordReader\n\nThe recorder reader is opened by {{MapTask#getSplitDetails}} in the framework.  It will now use a distinct fs object separate from any in the user task code, just like it (accidentally) used to do.  This is the stream that we are seeing in exceptions.\n\nbq. Does this apply to output stream as well?  If it really does, then something needs to be changed on the reducer side as well?\n\nYes, the collector gets a unique fs.  The reducer writes the the raw local filesystem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-20T20:40:48.773+0000","updated":"2012-01-20T20:40:48.773+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13190107","id":"13190107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knoguchi","name":"knoguchi","key":"knoguchi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Koji Noguchi","active":true,"timeZone":"America/New_York"},"body":"bq. The beauty is if I've missed something, the tests will immediately fail.\n\nI'm not following.  Does your test fail without your change and succeeds with your change? \nIf it already does that, I need to take another look.  If it doesn't, please post a new test.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knoguchi","name":"knoguchi","key":"knoguchi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Koji Noguchi","active":true,"timeZone":"America/New_York"},"created":"2012-01-20T21:01:57.231+0000","updated":"2012-01-20T21:01:57.231+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13190125","id":"13190125","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Yes, I'm reworking the test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-20T21:21:03.828+0000","updated":"2012-01-20T21:21:03.828+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13192278","id":"13192278","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Found issue in mapreduce v2 api, will post a modified patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-24T17:02:57.205+0000","updated":"2012-01-24T17:02:57.205+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13192463","id":"13192463","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Modifications within mapred and mapreduce proved to be too difficult.  This is a twist on the original approach: {{close()}} becomes a no-op if a config key is set.  MR tasks are run with this flag set.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-01-24T20:13:25.008+0000","updated":"2012-01-24T20:13:25.008+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13475657","id":"13475657","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi Daryn,\n\nbq. Found issue in mapreduce v2 api, will post a modified patch.\n\nThe patch seems to be for 1.x branch. Is trunk unaffected by this behavior? Last I checked we still blow up if we do the FS.get.close chain inside a task.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-10-13T16:39:17.248+0000","updated":"2012-10-13T16:39:17.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13476131","id":"13476131","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"All branches have this behavior, but a fix has proved to be too contentious.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2012-10-15T13:20:16.631+0000","updated":"2012-10-15T13:20:16.631+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12538335/comment/13478444","id":"13478444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mattf","name":"mattf","key":"mattf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Foley","active":true,"timeZone":"America/Los_Angeles"},"body":"Closed upon release of 1.1.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mattf","name":"mattf","key":"mattf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Foley","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-17T22:06:46.015+0000","updated":"2012-10-17T22:06:46.015+0000"}],"maxResults":43,"total":43,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-7973/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i07vuv:"}}