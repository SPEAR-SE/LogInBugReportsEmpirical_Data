{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12767538","self":"https://issues.apache.org/jira/rest/api/2/issue/12767538","key":"HADOOP-11479","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2015-01-15T12:18:05.042+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jan 21 17:01:37 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_593314990_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-01-21T17:02:12.725+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-11479/watchers","watchCount":4,"isWatching":false},"created":"2015-01-14T20:13:37.779+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12327179","id":"12327179","description":"2.6.0 release","name":"2.6.0","archived":false,"released":true,"releaseDate":"2014-11-18"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-02-10T19:06:46.813+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"The problem occurs when KMS key level acl is created for the key before the encryption zone is created. The command tried to create the encryption zone using \"hdfs\" user's identity and not the real user's identity.\n\nSteps:\nIn a kerberised environment:\n1. Create key level ACL in KMS for a new key.\n2. Create encryption key now. (Goes through fine)\n3. Create encryption zone. (Fails)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12692521","id":"12692521","filename":"KMS-test-acl.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-15T12:59:39.828+0000","size":5657,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12692521/KMS-test-acl.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"hdfs crypto -createZone fails to impersonate the real user in a kerberised environment","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"CentOS","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12767538/comment/14278621","id":"14278621","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitliuyi","name":"hitliuyi","key":"hitliuyi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yi Liu","active":true,"timeZone":"Asia/Shanghai"},"body":"[~ranadip], can you paste the failure msg?  \nOnly super user is allowed to create an encryption zone. What key level ACL you have configured?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hitliuyi","name":"hitliuyi","key":"hitliuyi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yi Liu","active":true,"timeZone":"Asia/Shanghai"},"created":"2015-01-15T12:18:05.042+0000","updated":"2015-01-15T12:18:05.042+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12767538/comment/14278650","id":"14278650","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"body":"Test ACL config attached.\n\nIf hdfs is included in the sections key.acl.ranskey1.GENERATE_EEK and key.acl.ranskey1.READ, it works.\n\nWithout those changes, it just shows RemoteException on the shell with no error message:\n<quote>\n[ranadip@server ~]$ hdfs crypto -createZone -keyName ranskey1 -path /user/ranadip.dir/enc\nRemoteException:\n</quote>\n\nOn KMS log, it shows:\n<quote>\n2015-01-15 11:49:46,447 WARN org.apache.hadoop.security.UserGroupInformation: PriviledgedActionException as:hdfs/*masked*@*masked* (auth:KERBEROS) cause:org.apache.hadoop.security.authorize.AuthorizationException: User [hdfs] is not authorized to perform [READ] on key with ACL name [ranskey1]!!\n</quote>\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-15T13:07:38.580+0000","updated":"2015-01-15T13:07:38.580+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12767538/comment/14278652","id":"14278652","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"body":"Sorry, obviously the attempted markup with the quotes did not work :-(","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-15T13:11:11.891+0000","updated":"2015-01-15T13:11:11.891+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12767538/comment/14278653","id":"14278653","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"body":"Sorry, obviously the attempted markup with the quotes did not work :-(","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-15T13:11:13.090+0000","updated":"2015-01-15T13:11:13.090+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12767538/comment/14279284","id":"14279284","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clamb","name":"clamb","key":"clamb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Charles Lamb","active":true,"timeZone":"America/New_York"},"body":"[~ranadip],\n\nJust to confirm, you are running the hdfs crypto command as user 'ranadip' (assuming your cli prompt is showing user@host) and you are running your namenode as hdfs (as indicated by the KMS message \"User [hdfs] is not...\"). Assuming the NN is running as user hdfs, then user 'hdfs' is the hdfs superuser and it must have (as you have noted) GENERATE_EEK and READ access to ranskey1. As [~hitliuyi] said, the hdfs crypto -createZone command can only be run by the superuser.\n\nCharles\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clamb","name":"clamb","key":"clamb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Charles Lamb","active":true,"timeZone":"America/New_York"},"created":"2015-01-15T21:02:36.857+0000","updated":"2015-01-15T21:02:36.857+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12767538/comment/14280359","id":"14280359","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"body":"Hi Charles,\n\nYes, you are right on the user setup and namenode process is started by \"hdfs\". This is a kerberos enabled environment, so the real user is obtained from the Kerberos ticket. The Kerberos user, though not \"hdfs\" is a member of the hdfs supergroup. So, Hadoop should see the user as a superuser when executing this command. Moreover, the encryption zone is being created inside the Kerberos user's home directory where the user executing the command is in fact the owner of the EZ being created.\nHowever, providing key level access, specially READ access to an application user does ring some alarm bells. In effect, with this limitation that hdfs user needs those key accesses for all encryption zones, it means if the hdfs user credentials are compromised, the \"baddie\" can have access to the encrypted data as well (or am I missing something?) Should the process rather not use the real user (authenticated by Kerberos) from the UserGroupInformation  check key level authorisations with KMS?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranadip","name":"ranadip","key":"ranadip","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranadip","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-16T15:11:05.746+0000","updated":"2015-01-16T15:11:05.746+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12767538/comment/14280870","id":"14280870","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clamb","name":"clamb","key":"clamb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Charles Lamb","active":true,"timeZone":"America/New_York"},"body":"[~ranadip],\n\nI am pretty sure that the READ exception is being thrown when the NN is doing getMetadata. Here's the explanation:\n\nThere are KMS operation ACLs (hadoop.kms...) and KMS key ACLs (default.key.acl...). The KMS key ACLs are more coarse-grained (MANAGEMENT, GENERATE_EEK, DECRYPT_EEK, READ, ALL) than the KMS operation ACLs (which cover each public KMS method call individually).\n\nSo, by default, the HDFS user has READ permission on all keys (default.key.acl.READ=*). This gives that user access to the getKeyVersion, getKeyVersions, getMetadata, getKeysMetadata and getCurrentKey methods.\n\nBut, then, to lock down HDFS user access to key material, you also need to add the HDFS user to the blacklist for the following KMS operation ACLs:\n\nCREATE, DELETE, ROLLOVER, GET, GET_KEYS, SET_KEY_MATERIAL, DECRYPT_EEK\n\n(This is what setting the KMS Blacklist property in CM does: it is a shortcut to setting these seven KMS operation ACLs)\nThere is also a specific KMS operation ACL for GET_METADATA, but you don't want to set that in this case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clamb","name":"clamb","key":"clamb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Charles Lamb","active":true,"timeZone":"America/New_York"},"created":"2015-01-16T21:44:54.021+0000","updated":"2015-01-16T21:44:54.021+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12767538/comment/14285884","id":"14285884","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clamb","name":"clamb","key":"clamb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Charles Lamb","active":true,"timeZone":"America/New_York"},"body":"[~ranadip],\n\nI haven't heard back about whether the suggested KMS ACLs got you past this problem. I'm going to close this for now, but feel free to reopen it.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clamb","name":"clamb","key":"clamb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Charles Lamb","active":true,"timeZone":"America/New_York"},"created":"2015-01-21T17:01:37.586+0000","updated":"2015-01-21T17:01:37.586+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-11479/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i24dmn:"}}