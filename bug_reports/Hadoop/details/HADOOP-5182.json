{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12414172","self":"https://issues.apache.org/jira/rest/api/2/issue/12414172","key":"HADOOP-5182","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2009-05-07T07:21:11.024+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed May 13 05:55:50 UTC 2009","customfield_12310420":"126948","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_8306901581_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-05-13T05:55:50.807+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-5182/watchers","watchCount":6,"isWatching":false},"created":"2009-02-06T02:27:29.226+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313438","id":"12313438","description":"","name":"0.20.0","archived":false,"released":true,"releaseDate":"2009-04-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313563","id":"12313563","description":"","name":"0.21.0","archived":false,"released":true,"releaseDate":"2010-08-23"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-07-08T16:43:31.651+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"I was running some gridmix tests on a 10 node cluster on EC2 and ran into an issue with unmodified Hadoop trunk revision (SVN revision#  734915). After running gridmix multiple times, I noticed several mapreduce jobs stuck in the running state. They remained in that hung state for several days, while other gridmixes of that size finished in approximately 8 hours, and are still in that state actually.\n\nI saw that the slave nodes had a bunch of hung task processes running, for tasks that the JobTracker log said were completed. These were hanging because the SIGTERM handler was waiting on DFSClient to close existing streams, but this was never finishing because DFSOutputStream waits on an ackQueue from the datanodes that was apparently getting no acks. The tasks did finish their work, but the processes hung around.\n\nI'll attached a sample jstack trace - note how the SIGTERM handler is blocked on \"thread-5\", which is waiting for a monitor on the DFSOutputStream, but this stream's monitor is held by main, which is trying to flush the stream (last trace in the file).\n\nHas anyone seen this issue before?\n\nAnother thing I saw was cleanup tasks never running (they are stuck in the initializing state on the web UI and can't be seen as running processes on the nodes). Not sure if that is actually related.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12399612","id":"12399612","filename":"jstack_ackqueue_bug","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyk","name":"andyk","key":"andyk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyk&avatarId=16961","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyk&avatarId=16961","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyk&avatarId=16961","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyk&avatarId=16961"},"displayName":"Andy Konwinski","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-02-06T02:30:12.784+0000","size":5490,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12399612/jstack_ackqueue_bug"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"103859","customfield_12312823":null,"summary":"Task processes not exiting due to ackQueue bug in DFSClient","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyk","name":"andyk","key":"andyk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyk&avatarId=16961","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyk&avatarId=16961","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyk&avatarId=16961","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyk&avatarId=16961"},"displayName":"Andy Konwinski","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyk","name":"andyk","key":"andyk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyk&avatarId=16961","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyk&avatarId=16961","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyk&avatarId=16961","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyk&avatarId=16961"},"displayName":"Andy Konwinski","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"EC2 with Ubuntu Linux 2.6.16 AMI. Hadoop trunk revision 734915","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414172/comment/12670985","id":"12670985","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyk","name":"andyk","key":"andyk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyk&avatarId=16961","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyk&avatarId=16961","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyk&avatarId=16961","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyk&avatarId=16961"},"displayName":"Andy Konwinski","active":true,"timeZone":"America/Los_Angeles"},"body":"jstack output showing processes waiting on ackQueue lock","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyk","name":"andyk","key":"andyk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyk&avatarId=16961","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyk&avatarId=16961","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyk&avatarId=16961","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyk&avatarId=16961"},"displayName":"Andy Konwinski","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-02-06T02:30:12.830+0000","updated":"2009-02-06T02:30:12.830+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414172/comment/12706746","id":"12706746","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shixing","name":"shixing","key":"shixing","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ShiXing","active":true,"timeZone":"Asia/Shanghai"},"body":"From the Child java process's jstack info, the \"SIGTERM handler\" thread call the org.apache.hadoop.fs.FileSystem$ClientFinalizer, but it is blocked for the thread naming \"Thread-5\".\nAnd the \"Thread-5\" is blocked at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream.closeInternal called by the \"main\" thread.\nThe \"main\" thread locked the org.apache.hadoop.hdfs.DFSClient$DFSOutputStream at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream.flushInternal(), and the dataQueue hangs waiting some thread to notified.\n\nIn normal case, when close the DFSOutputStream, it calls the flushInternal(), and the dataQueue will be notified by the DataStreamer when DataStreamer get the first packet from dataQueue.\nThe DFSOutputStream will be unlocked.\n\nSometimes when the Child java process get the \"SIGTERM\", and it will call the ClientFinalizer to FileSystem.closeAll(); => CACHE.closeAll(); => DistributedFileSystem.close(); => clientRunning=false;\nThe DataStreamer thread will exit, because the clientRunning=false, And the DFSOutputStream now also goes in the closeInternal()=>flushInternal() and wait for notifying the dataQueue.\nBut now the DataStreamer has exited and now the closed flag is false(because the closed flag would be set true after flushInternal() in closeInternal()), so the flushInternal will be hang.\n\nIn deed we shoud judge clientRunning to the flushInternal() function.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shixing","name":"shixing","key":"shixing","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ShiXing","active":true,"timeZone":"Asia/Shanghai"},"created":"2009-05-07T07:21:11.024+0000","updated":"2009-05-07T07:21:11.024+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414172/comment/12706780","id":"12706780","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shixing","name":"shixing","key":"shixing","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ShiXing","active":true,"timeZone":"Asia/Shanghai"},"body":"https://issues.apache.org/jira/browse/HADOOP-3998\n\nthis bug has been fixed?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shixing","name":"shixing","key":"shixing","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ShiXing","active":true,"timeZone":"Asia/Shanghai"},"created":"2009-05-07T09:36:11.688+0000","updated":"2009-05-07T09:36:11.688+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12414172/comment/12708771","id":"12708771","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"I am closing this one because I think this is a duplicate of HADOOP-3998. Please re-open if you think otherwise.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2009-05-13T05:55:50.749+0000","updated":"2009-05-13T05:55:50.749+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-5182/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0i4pz:"}}