{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13174848","self":"https://issues.apache.org/jira/rest/api/2/issue/13174848","key":"HADOOP-15634","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":"2018-07-26T17:15:09.838+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jul 27 17:14:56 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_12482715_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2018-07-26T17:15:17.039+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15634/watchers","watchCount":3,"isWatching":false},"created":"2018-07-26T13:47:14.348+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341091","id":"12341091","name":"2.8.3","archived":false,"released":true,"releaseDate":"2017-12-12"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-07-27T17:14:56.596+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311814","id":"12311814","name":"fs/s3","description":"S3A filesystem client and other S3 connectivity issues"}],"timeoriginalestimate":null,"description":"Manually modified the yarn-site.xml from within the EMR, set the param yarn.nodemanager.local-dirs to point to s3, reloaded the services on Master and Core nodes. Disk seemed to stay intact but hdfs dfsadmin -report showed nonDFS usage and then finally it failed with below error.\r\n\r\nError: org.apache.hive.service.cli.HiveSQLException: Error while processing statement: FAILED: Execution Error, return code 2 from org.apache.hadoop.hive.ql.exec.tez.TezTask. Vertex failed, vertexName=Map 1, vertexId=vertex_1532581073633_0001_2_00, diagnostics=[Task failed, taskId=task_1532581073633_0001_2_00_000898, diagnostics=[TaskAttempt 0 failed, info=[Error: Error while running task ( failure ) : attempt_1532581073633_0001_2_00_000898_0:org.apache.hadoop.util.DiskChecker$DiskErrorException: Could not find any valid local directory for output/attempt_1532581073633_0001_2_00_000898_0_10013_1/file.out\r\n at org.apache.hadoop.fs.LocalDirAllocator$AllocatorPerContext.getLocalPathForWrite(LocalDirAllocator.java:441)\r\n at org.apache.hadoop.fs.LocalDirAllocator.getLocalPathForWrite(LocalDirAllocator.java:151)\r\n at org.apache.hadoop.fs.LocalDirAllocator.getLocalPathForWrite(LocalDirAllocator.java:132)\r\n at org.apache.tez.runtime.library.common.task.local.output.TezTaskOutputFiles.getSpillFileForWrite(TezTaskOutputFiles.java:207)\r\n at org.apache.tez.runtime.library.common.sort.impl.PipelinedSorter.spill(PipelinedSorter.java:545)\r\n\r\n...","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"LocalDirAllocator using up local nonDFS when set to S3","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kphanik38","name":"kphanik38","key":"kphanik38","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Phani Kondapalli","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kphanik38","name":"kphanik38","key":"kphanik38","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Phani Kondapalli","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"EMR-5.15, Hadoop-2.8.3, Hive-2.3.3, Tez-0.8.4, Beeline. \r\n\r\nTarget table is defined for ACID transactions with location on S3. \r\n\r\nInsert source table is on S3. ","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13174848/comment/16558627","id":"16558627","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"#. EMR team gets to field their problems, as they've forked the code\r\n# That said: yes. LocalDirAllocator uses local directories. They are used in many places in Hadoop, often in different config options for different bits of the code\r\n# S3 is not a filesystem. You can't write directly to it, so the s3 connectors all save data into blocks before upload. Where to? The local HDD via the LocalDirAllocator. S3 isnt going to work\r\n\r\nI'm afraid you will have to accept that when code wants a local FS directory it means it and that you have to provide enough local storage for running applications.\r\n\r\nThat said: if Tez isn't cleaning up, that's an issue to take up with the EMR and Tez teams. For the latter, re-open this JIRA, move it to the Tez project. But come up with some evidence that they don't clean up first.\r\n\r\nClosing as INVALID. Sorry\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2018-07-26T17:15:09.838+0000","updated":"2018-07-26T17:15:09.838+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13174848/comment/16558713","id":"16558713","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kphanik38","name":"kphanik38","key":"kphanik38","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Phani Kondapalli","active":true,"timeZone":"America/Chicago"},"body":"That makes sense, Steve. Will get in touch with AWS EMR support team.\r\n\r\nWas wondering... if it is a simple pull (from an S3 location) and write (to an S3 location), then why do we need local disk. Liked your explanation. I will have to rethink the architecture/design of my application.\r\n\r\nThanks for your time and quick response.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kphanik38","name":"kphanik38","key":"kphanik38","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Phani Kondapalli","active":true,"timeZone":"America/Chicago"},"created":"2018-07-26T18:16:32.299+0000","updated":"2018-07-26T18:16:32.299+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13174848/comment/16558954","id":"16558954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabbri","name":"fabbri","key":"fabbri","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fabbri&avatarId=24131","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fabbri&avatarId=24131","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fabbri&avatarId=24131","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fabbri&avatarId=24131"},"displayName":"Aaron Fabbri","active":true,"timeZone":"America/Los_Angeles"},"body":"{quote}why do we need local disk.\r\n{quote}\r\nFor future reference: check out the [documentation|https://hadoop.apache.org/docs/current3/hadoop-aws/tools/hadoop-aws/index.html] for S3A. See the section \"How S3A Writes to S3\". (The open source S3A connector also has support for in-memory buffering and the doc offers some numbers for calculating how much memory this would require--which is the main downside.) . As Steve said, this only applies to the Apache Hadoop code. EMR's S3 client is not open sourced.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabbri","name":"fabbri","key":"fabbri","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fabbri&avatarId=24131","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fabbri&avatarId=24131","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fabbri&avatarId=24131","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fabbri&avatarId=24131"},"displayName":"Aaron Fabbri","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-07-26T21:59:56.770+0000","updated":"2018-07-26T21:59:56.770+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13174848/comment/16560023","id":"16560023","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"body":"bq  if it is a simple pull (from an S3 location) and write (to an S3 location), then why do we need local disk\r\n\r\nThere's an S3 COPY command which can do in-store copy at ~6-10 MB/s. We don't expose that in the Hadoop FS APIs, though we use this operation for mimicing in-bucket renames\r\n\r\nOtherwise, a copy from s3a://src to s3a://dest downloads locally and uploads; the upload code is: \r\nhttps://github.com/apache/hadoop/blob/trunk/hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3ABlockOutputStream.java\r\n\r\nI belive AWS's s3 distcp does things direct, and perhaps CircusTrain from expedia does this too. If you are trying to use the open source distcp, there are opportunities to speedup using cloud storage as a destination, and between cloud stores of the same cloud infra. If you want to help, you are welcome to contribute!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stevel%40apache.org","name":"stevel@apache.org","key":"stevel@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=stevel%40apache.org&avatarId=16513","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=stevel%40apache.org&avatarId=16513","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=stevel%40apache.org&avatarId=16513","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=stevel%40apache.org&avatarId=16513"},"displayName":"Steve Loughran","active":true,"timeZone":"Europe/London"},"created":"2018-07-27T17:14:56.596+0000","updated":"2018-07-27T17:14:56.596+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-15634/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3wcpb:"}}