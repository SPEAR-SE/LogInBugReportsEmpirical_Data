{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12446495","self":"https://issues.apache.org/jira/rest/api/2/issue/12446495","key":"HADOOP-6508","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310240","id":"12310240","key":"HADOOP","name":"Hadoop Common","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315569","id":"12315569","description":"","name":"0.23.0","archived":false,"released":true,"releaseDate":"2011-11-11"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-05-23T19:00:44.889+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jun 23 19:07:28 UTC 2011","customfield_12310420":"70153","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_41785306031_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-05-23T19:01:25.519+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-6508/watchers","watchCount":7,"isWatching":false},"created":"2010-01-25T03:59:39.534+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313438","id":"12313438","description":"","name":"0.20.0","archived":false,"released":true,"releaseDate":"2009-04-22"}],"issuelinks":[{"id":"12339238","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12339238","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"inwardIssue":{"id":"12472296","key":"HADOOP-6919","self":"https://issues.apache.org/jira/rest/api/2/issue/12472296","fields":{"summary":"Metrics2: metrics framework","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vicaya","name":"vicaya","key":"vicaya","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Luke Lu","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-15T00:50:42.482+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12310971","id":"12310971","name":"metrics","description":""}],"timeoriginalestimate":null,"description":"In our clusters, when we use CompositeContext with two contexts, second context gets wrong values.\nThis problem is consistent on 500 (and above) node cluster.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12431524","id":"12431524","filename":"CompositeContext.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amareshwari","name":"amareshwari","key":"amareshwari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amareshwari Sriramadasu","active":true,"timeZone":"Asia/Kolkata"},"created":"2010-01-27T05:31:59.371+0000","size":127711,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12431524/CompositeContext.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12431527","id":"12431527","filename":"CompositeContext-solution.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amareshwari","name":"amareshwari","key":"amareshwari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amareshwari Sriramadasu","active":true,"timeZone":"Asia/Kolkata"},"created":"2010-01-27T06:09:19.438+0000","size":93182,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12431527/CompositeContext-solution.png"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"53805","customfield_12312823":null,"summary":"Incorrect values for metrics with CompositeContext","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amareshwari","name":"amareshwari","key":"amareshwari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amareshwari Sriramadasu","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amareshwari","name":"amareshwari","key":"amareshwari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amareshwari Sriramadasu","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446495/comment/12805349","id":"12805349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amareshwari","name":"amareshwari","key":"amareshwari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amareshwari Sriramadasu","active":true,"timeZone":"Asia/Kolkata"},"body":"Some simple experiments we have done:\n\n1.  We brought up 500 node cluster with CompositeContext containing Contexts C1 and C2. The metric for number of trackers is correct in C1( same number as in web UI) and is wrong in C2.\n2. We brought up 500 node cluster with CompositeContext containing Contexts C2 and C1 (Interchanged the order of contexts from the earlier). Then, the metric for number of trackers is correct in C2( same number as in web UI) and is wrong in C1.\n\nHere, the code path, \"in which the metric for number of trackers is incremented\", is JobTracker.addNewTracker() whenever a new tracker is added. Since first context's value matches with the one on web UI. There is no bug in JobTracker updating code. Also there is no bug in individual context implementations, because it is always second context showing wrong values.\nThus, this leaves there is bug in metrics framework i.e. CompositeContext.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amareshwari","name":"amareshwari","key":"amareshwari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amareshwari Sriramadasu","active":true,"timeZone":"Asia/Kolkata"},"created":"2010-01-27T04:31:35.097+0000","updated":"2010-01-27T04:31:35.097+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446495/comment/12805355","id":"12805355","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amareshwari","name":"amareshwari","key":"amareshwari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amareshwari Sriramadasu","active":true,"timeZone":"Asia/Kolkata"},"body":"Analyzing the following JobTrackerMetricsInst code  with CompositeContext as the MetricsContext:\n{code}\n    MetricsContext context = MetricsUtil.getContext(\"mapred\");\n    metricsRecord = MetricsUtil.createRecord(context, \"jobtracker\");\n    metricsRecord.setTag(\"sessionId\", sessionId);\n    context.registerUpdater(this);\n{code}\n\nDetails on each line of code:\n{code}\n    MetricsContext context = MetricsUtil.getContext(\"mapred\");\n{code}\nThis code creates a CompositeContext(CC), which creates all its sub-contexts and calls startsMonitoring on all the\nsubcontext. Thus there are as many threads(monitoring) as the number of sub-contexts. Here, each thread calls\ndoUpdates() followed by emitRecords() in the configured periods.\n\n{code}\n    metricsRecord = MetricsUtil.createRecord(context, \"jobtracker\");\n{code}\nThis code creates a MetricsRecord for CompositeContext, which is a Proxy which has a delegator for all the sub-records. This record invokes\nevery method call on all its sub-records.\n\n{code}\n    context.registerUpdater(this);\n{code}\nThis code registers JobTracker as the updater for all the sub-contexts.\n\nPutting above relation pictorially (see the attached png): JobTracker (JT) has CompositeContext(CC) and ProxyMetricsRecord (PR). CC starts\nContext1(C1) and Context2(C2) 's timer threads. C1 has MetricsRecord (R1) and C2 has MetricsRecord(R2). PR delagates\nall method calls on it to R1 and R2. C1and C2 register JobTracker as the updater.\n\nBoth C1 and C2 call JT.doUpdates at specified periods. The code flow for doUpdates from C1 or C2:\n  1. Set/Incr methods on ProxyRecord are delegated to both R1 and R2. On the JobTracker code these calls are\nsynchronized.\n  2. MetricsRecord.update() boils down to R1.update() and R2.update() irrespective of whether it is from C1 or C2. This\ncall is not synchronized on JT.\n\nMoreover, MetricsRecord javadoc clearly says: \n<em>Different threads should  *not* use the same MetricsRecord instance at the same time. </em>.  So, the problem here is that the ProxyRecord is shared between two threads without synchronization. There is possibility for race if the above updates are not synchronized. I think this could be the most likely cause for seeing incorrect values with CompositeContext.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amareshwari","name":"amareshwari","key":"amareshwari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amareshwari Sriramadasu","active":true,"timeZone":"Asia/Kolkata"},"created":"2010-01-27T05:30:41.849+0000","updated":"2010-01-27T05:30:41.849+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446495/comment/12805376","id":"12805376","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amareshwari","name":"amareshwari","key":"amareshwari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amareshwari Sriramadasu","active":true,"timeZone":"Asia/Kolkata"},"body":"One solution we thought of is to make CompositeContext a true middle man. CompositeContext registers JobTracker as the updater. Its sub-contexts register CompositeContext as the updater. CompositeContext's MetricRecord is any other record which is updated by JobTracker, and it updates its sub-contexts on the call to doUpdates(). Here, CompositeContext takes care of synchronization for different threads accessing its record. \n\nSee the attached png for the updated relation between JobTracker and CompositeContext. JobTracker (JT) has CompositeContext(CC) and CompositeRecord (CR). CC has a monitoring thread which calls doUpdates periodically, updates CR. CC also starts Context1(C1) and Context2(C2) 's timer threads. C1 has MetricsRecord (R1) and C2 has MetricsRecord(R2). CC updates R1 or R2 from the value of CR, if the doUpdates call is from C1 or C2, respectively. Here, CC registers JT as the updater, C1 and C2 register CC as the updater.\n\nThoughts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amareshwari","name":"amareshwari","key":"amareshwari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amareshwari Sriramadasu","active":true,"timeZone":"Asia/Kolkata"},"created":"2010-01-27T06:08:57.145+0000","updated":"2010-01-27T06:08:57.145+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446495/comment/13038138","id":"13038138","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vicaya","name":"vicaya","key":"vicaya","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Luke Lu","active":true,"timeZone":"America/Los_Angeles"},"body":"The metrics2 design ensures all the backends see the same metrics for a given snapshot. We tested and deployed the parallel backends with metrics2 in qa and production clusters for more than 8 months. No related issues are found so far.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vicaya","name":"vicaya","key":"vicaya","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Luke Lu","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-23T19:00:44.889+0000","updated":"2011-05-23T19:00:44.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446495/comment/13054040","id":"13054040","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aw","name":"aw","key":"aw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=aw&avatarId=23681","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=aw&avatarId=23681","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=aw&avatarId=23681","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=aw&avatarId=23681"},"displayName":"Allen Wittenauer","active":true,"timeZone":"America/Tijuana"},"body":"Should this really be resolved/fixed or is this JIRA in some other state?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aw","name":"aw","key":"aw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=aw&avatarId=23681","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=aw&avatarId=23681","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=aw&avatarId=23681","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=aw&avatarId=23681"},"displayName":"Allen Wittenauer","active":true,"timeZone":"America/Tijuana"},"created":"2011-06-23T19:07:28.924+0000","updated":"2011-06-23T19:07:28.924+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HADOOP-6508/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i09ktb:"}}