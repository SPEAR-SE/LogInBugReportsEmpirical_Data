[In the span of 11 seconds, there were 103,367 exceptions generated for only 10 unique nodes that had incorrect versions.
Here the repetitive log entries that ate up all the disk space.

{noformat}
2008-06-26 22:48:18,952 INFO org.apache.hadoop.ipc.Server: IPC Server handler 19 on 8020, call sendHeartbeat(A.B.C.D:50010, 2971509878784, 1731424256, 2150426691690, 0, 0) from A.B.C.D:43226: error: org.apache.hadoop.dfs.IncorrectVersionException: Unexpected version of data node. Reported: -11. Expecting = -13.
org.apache.hadoop.dfs.IncorrectVersionException: Unexpected version of data node. Reported: -11. Expecting = -13.
        at org.apache.hadoop.dfs.NameNode.verifyVersion(NameNode.java:682)
        at org.apache.hadoop.dfs.NameNode.verifyRequest(NameNode.java:669)
        at org.apache.hadoop.dfs.NameNode.sendHeartbeat(NameNode.java:557)
        at sun.reflect.GeneratedMethodAccessor8.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:446)
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:896)
2008-06-26 22:48:18,953 INFO org.apache.hadoop.ipc.Server: IPC Server handler 27 on 8020, call sendHeartbeat(A.B.C.E:50010, 2971509878784, 1993637888, 2151120783483, 0, 0) from A.B.C.E:56503: error: org.apache.hadoop.dfs.IncorrectVersionException: Unexpected version of data node. Reported: -11. Expecting = -13.
org.apache.hadoop.dfs.IncorrectVersionException: Unexpected version of data node. Reported: -11. Expecting = -13.
        at org.apache.hadoop.dfs.NameNode.verifyVersion(NameNode.java:682)
        at org.apache.hadoop.dfs.NameNode.verifyRequest(NameNode.java:669)
        at org.apache.hadoop.dfs.NameNode.sendHeartbeat(NameNode.java:557)
        at sun.reflect.GeneratedMethodAccessor8.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
        at java.lang.reflect.Method.invoke(Method.java:597)
        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:446)
        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:896)
{noformat}

, Thats pretty painful. We should include "IncorrectVersionException" as one of the fatal exceptions at the datanode.

See {{DataNode.java:offserService()}} :
{noformat}
      } catch(RemoteException re) {
        String reClass = re.getClassName();
        if (UnregisteredDatanodeException.class.getName().equals(reClass) ||
            DisallowedDatanodeException.class.getName().equals(reClass)) {
          LOG.warn("DataNode is shutting down: " + 
                   StringUtils.stringifyException(re));
          shutdown();
          return;
        }
{noformat}

, In addition, DN should update lastHeartBeat time even if sendHeartbeat() results in an exception.. this will avoid similar problems with future errors., Patch for 0.18, Patch for trunk. I tested this by changing layout version and trying to start a datanode connecting to namenode. It fails with IncorrectVersionException. , While patch is waiting on hudson, I ran the tests on my LINUX box. All tests pass, even test-patch. There is not testcase, did manual testing. , patch for 0.17.2, +1. Looks good., I just committed this. Thanks, Lohit, Integrated in Hadoop-trunk #581 (See [http://hudson.zones.apache.org/hudson/job/Hadoop-trunk/581/])]