[Attached is proposed patch. I removed entire lock/release method synchronization and replaced it with critical section synchronization for sets accesses - leaving channel lock/release calls outside of synchronized statement. , I just committed this.  Thanks, Igor!

The patch did not apply directly, due to other changes made to Hadoop since you contributed it.  So I had to apply parts of it manually.  Please check that it still looks correct.  Thanks!]