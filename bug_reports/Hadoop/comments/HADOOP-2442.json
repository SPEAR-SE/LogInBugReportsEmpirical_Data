[Tom White also has mentioned this bug in HADOOP-2426.  I guess his patch probably could fix it.

I suspect that TestLocalFileSystemPermission.testLocalFSsetOwner is bypassed in the Hadoop QA tests since this problem is not reported.  It could be the case if the QA account belongs to less than two groups., My bad. I was making multiple implementations of same functionality for HADOOP-2381 and did not run all the tests for the final patch. Hudson didn't catch it I guess because of the multiple groups requirement as Nicholas mentioned. I think extensive permission testing is going to be an issue on real FS. Even DFS has some special hooks, it might be temporary.

Patch attached., Modified TestLocalFileSystemPermission to run partial test when user belongs to only one group. This at least exercises most of the code path., +1
Codes look good., -1 overall.  Here are the results of testing the latest attachment 
http://issues.apache.org/jira/secure/attachment/12371819/HADOOP-2442.patch
against trunk revision r604999.

    @author +1.  The patch does not contain any @author tags.

    javadoc +1.  The javadoc tool did not generate any warning messages.

    javac +1.  The applied patch does not generate any new compiler warnings.

    findbugs +1.  The patch does not introduce any new Findbugs warnings.

    core tests -1.  The patch failed core unit tests.

    contrib tests +1.  The patch passed contrib unit tests.

Test results: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1376/testReport/
Findbugs warnings: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1376/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1376/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1376/console

This message is automatically generated., Sigh. This test was run on Hudson for the first time. I guess Solaris does does not have '{{chown :GROUP}}'. Will try changing it to '{{chgrp GROUP}}'., I could not easily get hold of a Solaris box. I think it will finally succeed this time., For Sun's man page, chown has :group but owner is not optional.
See http://docs.sun.com/app/docs/doc/817-3936/6mjgdbv2o?l=en&a=view&q=chown, -1 overall.  Here are the results of testing the latest attachment 
http://issues.apache.org/jira/secure/attachment/12371893/HADOOP-2442.patch
against trunk revision r605299.

    @author +1.  The patch does not contain any @author tags.

    javadoc +1.  The javadoc tool did not generate any warning messages.

    javac +1.  The applied patch does not generate any new compiler warnings.

    findbugs +1.  The patch does not introduce any new Findbugs warnings.

    core tests -1.  The patch failed core unit tests.

    contrib tests +1.  The patch passed contrib unit tests.

Test results: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1385/testReport/
Findbugs warnings: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1385/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1385/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1385/console

This message is automatically generated., Now its an issue with output of '{{ls -ld}}', this time I will submit patch after running Solaris., 
On Hudson, {{ls}} must have been [{{/usr/ucb/ls}}|http://docs.sun.com/app/docs/doc/816-3318/6m9jv8am1?a=view] rather than [{{/usr/bin/ls}}|http://docs.sun.com/app/docs/doc/816-3318/6m9jv8am0?a=view]. I verified {{/usr/bin/ls}} looks as expected on a Solaris box though didn't actually run the unit test. This patch forces {{/usr/bin/ls}} on Solaris., +1 overall.  Here are the results of testing the latest attachment 
http://issues.apache.org/jira/secure/attachment/12371899/HADOOP-2442.patch
against trunk revision r605299.

    @author +1.  The patch does not contain any @author tags.

    javadoc +1.  The javadoc tool did not generate any warning messages.

    javac +1.  The applied patch does not generate any new compiler warnings.

    findbugs +1.  The patch does not introduce any new Findbugs warnings.

    core tests +1.  The patch passed core unit tests.

    contrib tests +1.  The patch passed contrib unit tests.

Test results: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1386/testReport/
Findbugs warnings: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1386/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1386/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1386/console

This message is automatically generated., Raghu, why not use /bin/ls on all platforms (which works) instead of just ls.  This will also circumvent any aliasing of ls that folks may have setup in their shells., The solaris man pages specified full paths to ls variants and it did not include /bin/ls. Based  on recent experience with other commands if Solaris could break conventions, it will :). The machine I checked does have /bin/ls and works like /usr/bin/ls. We can change it.
, Also if it is /bin/ls, it should be 'bash -c "/bin/ls ... "' on windows and the file name should be escaped., Nigel, do you still think we should force /bin/ls? We could avoid extra process on Windows by using a env variable for Cygwin root.. I need to check if such variable exists.
, Yet another version of the patch that force /bin/ls on all platforms. Please see the comment in patch for ShellCommand.java. I don't mind using just 'ls' on Windows. Nigel, please choose an option.
, Actually, issue with 'ls' and 'chown' are are seperate problems from core fix needed for this Jira. Let me know if I should submit just bare patch that fixes the issue. The Solaris related fixes can go into some other issue. , The latest patch uses 'ls' on windows and '/bin/ls' everywhere else.
, Use to {{Path.WINDOWS}} as Konstantin suggested. We should probably move "WINDOWS" boolean to some common place., Try to trigger Hudson again.
, TestLocalFileSystemPermission.java
      if (groups == null) {
      System.out.println("Cannot run test: need at least one group.  groups="
                        + groups);
       return;
     }
change to 
if (groups == null || groups.size() < 1) {
.....
}

Otherwise it looks fine.
, Thanks Sanjay. Attached patch includes the fix., -1 overall.  Here are the results of testing the latest attachment 
http://issues.apache.org/jira/secure/attachment/12372370/HADOOP-2442.patch
against trunk revision r608052.

    @author +1.  The patch does not contain any @author tags.

    patch -1.  The patch command could not apply the patch.

Console output: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/1443/console

This message is automatically generated., Conflicts with HADOOP-2344., I just committed this.  Thanks Raghu!]