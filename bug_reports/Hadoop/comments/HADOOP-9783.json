[Patch attached. I made RLFS do positive rather than negative detection when determining whether to use the new and improved code path.

Also took the opportunity to clean up the OS detection code in {{Shell}}, since we were doing it twice., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12594609/hadoop-9783-1.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2860//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2860//console

This message is automatically generated., No tests because it's fixing OSX and a refactor. Tucu successfully tested this patch for me with his OSX YARN dev environment though., Let's have {{Shell.IS_MAC}} instead of {{Shell.MAC}}, and so forth.  We use the "IS" convention elsewhere., Hi Andrew, thanks for the prompt fix!

I verified it fixes the regression on OS X. I like Colin's suggestion of prepending IS_ to the OS flags in Shell. It will be a larger change since Shell.WINDOWS is used quite extensively in the codebase.

+1 otherwise., Thanks Colin and Arpit. I avoided the IS_ prefix initially because of the broad refactor it causes.

New v2 patch (attached) does this refactor, otherwise the same., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12594745/hadoop-9783-2.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 24 new or modified test files.

    {color:red}-1 javac{color:red}.  The patch appears to cause the build to fail.

Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2865//console

This message is automatically generated., Thanks Andrew.  It seems like this needs to be rebased, though.

+1 pending Jenkins., I missed refactoring outside of Common and HDFS. A little more ack, xargs, and sed magic led to this revised patch., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12594752/hadoop-9783-3.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 41 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-app hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-core hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-jobclient hadoop-tools/hadoop-streaming hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api hadoop-yarn-project/hadoop-yarn/hadoop-yarn-applications/hadoop-yarn-applications-distributedshell hadoop-yarn-project/hadoop-yarn/hadoop-yarn-applications/hadoop-yarn-applications-unmanaged-am-launcher hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-tests:

                  org.apache.hadoop.hdfs.TestDFSShell

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2866//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2866//console

This message is automatically generated., -1 Please file a separate jira for renaming Shell.WINDOWS.  It has nothing to do with the scope of fixing the broken OS detection (which has impacted my dev env) so I can barely see the relevant changes., Colin, Arpit, can we just stick with the v1 patch then?

I'm also working on the DFSShell test failure right now, not related to this change., That is fine. 

Daryn commented on HADOOP-9652 about a potential security issue with the original change so you might want to look into that too., It sounds like what Andrew wants to do is revert his HADOOP-9652 change and roll this into a new version of it., rolling this into HADOOP-9652]