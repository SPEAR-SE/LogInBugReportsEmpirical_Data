[> This is a lock hierarchy violation. This leads to deadlock. 

In the current codes, the heartbeats lock is released before calling blockReportProcessed(...).  So, there is no deadlock, HADOOP-3254 only has changed the organization of the codes.  More specially, I moved some codes from NameNode.java to FSNamesystem.java.  The execution ordering remains unchanged., There is no deadlock in the current code, but the global lock makes heartbeats inefficient.
The lock was introduced in HADOOP-1985 and HADOOP-3254 moved this code inside handleHeartbeat().
So we actually have this in 0.18 not just the trunk., It looks like the issue is going to be resolved by HADOOP-3620., I think this code will make heartbeat processing a *real real* bottleneck in large clusters. Every heartbeat requires acquiring the global FSNamesystem lock. From this viewpoint, it is a *regression* and used to show up very easily on a 1000 node cluster. , This was an invalid issue.]