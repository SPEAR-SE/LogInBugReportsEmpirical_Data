[FYI: I have not confirmed if this happens in any other branches.  , The alpha1 tarball looks okay, so I wonder what changed:

{noformat}
-> % ls share/hadoop/common 
hadoop-common-3.0.0-alpha1.jar        hadoop-nfs-3.0.0-alpha1.jar  lib      templates
hadoop-common-3.0.0-alpha1-tests.jar  jdiff                        sources
-> % ls share/hadoop/hdfs 
hadoop-hdfs-3.0.0-alpha1.jar                      jdiff
hadoop-hdfs-3.0.0-alpha1-tests.jar                lib
hadoop-hdfs-client-3.0.0-alpha1-tests.jar         sources
hadoop-hdfs-native-client-3.0.0-alpha1.jar        templates
hadoop-hdfs-native-client-3.0.0-alpha1-tests.jar  webapps
hadoop-hdfs-nfs-3.0.0-alpha1.jar
{noformat}

, I did a {{mvn clean package -Pdist -DskipTests -D tar}} and looked at the resulting tarball and it looks okay:

{noformat}
-> % ls share/hadoop/common 
hadoop-common-3.0.0-alpha2-SNAPSHOT.jar        jdiff      webapps
hadoop-common-3.0.0-alpha2-SNAPSHOT-tests.jar  lib
hadoop-nfs-3.0.0-alpha2-SNAPSHOT.jar           templates
-> % ls share/hadoop/hdfs  
hadoop-hdfs-3.0.0-alpha2-SNAPSHOT.jar
hadoop-hdfs-3.0.0-alpha2-SNAPSHOT-tests.jar
hadoop-hdfs-client-3.0.0-alpha2-SNAPSHOT-tests.jar
hadoop-hdfs-native-client-3.0.0-alpha2-SNAPSHOT.jar
hadoop-hdfs-native-client-3.0.0-alpha2-SNAPSHOT-tests.jar
hadoop-hdfs-nfs-3.0.0-alpha2-SNAPSHOT.jar
jdiff
lib
templates
webapps
{noformat}, I looked at this a little more, and I think I was able to reproduce the issue with {{mvn clean install -Pdist,src -Dtar -DskipTests}}. This makes me think it's something to do with the src profile., A little more progress debugging this, the {{src}} profile is causing the per-component assembly plugin invocation to run before the jars are created. I ran a {{dist}} and a {{dist,src}} build, and then grepped as follows: {{egrep "(maven-assembly-plugin|maven-jar-plugin)" dist.out | grep hadoop-common}}

dist:

{noformat}
[INFO] --- maven-jar-plugin:2.5:jar (prepare-jar) @ hadoop-common ---
[INFO] --- maven-jar-plugin:2.5:test-jar (prepare-test-jar) @ hadoop-common ---
[INFO] --- maven-assembly-plugin:2.4:single (dist) @ hadoop-common ---
[INFO] --- maven-jar-plugin:2.5:jar (default-jar) @ hadoop-common ---
{noformat}

dist,src:

{noformat}
[INFO] --- maven-assembly-plugin:2.4:single (dist) @ hadoop-common ---
[INFO] --- maven-jar-plugin:2.5:jar (prepare-jar) @ hadoop-common ---
[INFO] --- maven-jar-plugin:2.5:test-jar (prepare-test-jar) @ hadoop-common ---
[INFO] --- maven-jar-plugin:2.5:jar (default-jar) @ hadoop-common ---
{noformat}

Here's a patch that just changes the dist assembly plugin in "package" instead of "prepare-package", which fixes the ordering problem. I did a build and diffed the jars in alpha1 against trunk with this patch applied, and only found the changed lib dependencies and the new shaded client and aliyun JARs., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 11s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 12m 21s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m  8s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 11s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 10s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m  9s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m  7s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m  6s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m  6s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m  8s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m  6s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} xml {color} | {color:green}  0m  1s{color} | {color:green} The patch has no ill-formed XML file. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m  6s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  0m  6s{color} | {color:green} hadoop-project-dist in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 15s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 14m 42s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:a9ad5d6 |
| JIRA Issue | HADOOP-13896 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12845462/hadoop-13896.001.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  xml  |
| uname | Linux 08d0453b2eca 3.13.0-106-generic #153-Ubuntu SMP Tue Dec 6 15:44:32 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / a0a2761 |
| Default Java | 1.8.0_111 |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/11357/testReport/ |
| modules | C: hadoop-project-dist U: hadoop-project-dist |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/11357/console |
| Powered by | Apache Yetus 0.5.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, No tests since this is not something covered by unit tests. Review would be appreciated.

Side note, I had to rekick the build bot since the first time it failed with a weird error and didn't post a comment:

https://builds.apache.org/job/PreCommit-HADOOP-Build/11349/, *shrugs*

Seems to be working for me.  +1

At some point, we really need to rework how all of this is laid out. It's pretty terrible. :(  I'd love to use the same trick as we do for tools to only load what we need, but... yeah...., Yea, I honestly still don't understand the dist / assembly build. I think a lot of the grossness originates from the project split/unsplit, there really should be one place where all of this happens.

Thanks for the review, I'll commit this shortly., Committed to trunk, thanks again for the review Allen!, It was gonna be the next thing on my list.  But for a variety of reasons, I'm not going to spend any time on it., ABORTED: Integrated in Jenkins build Hadoop-trunk-Commit #11076 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/11076/])
HADOOP-13896. Invoke assembly plugin after building jars. (wang: rev 02766b6c224bc163a6fad37f146ade063e7fb422)
* (edit) hadoop-project-dist/pom.xml
]