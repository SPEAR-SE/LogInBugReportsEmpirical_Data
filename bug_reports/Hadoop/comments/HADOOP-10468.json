[The problem is that the configuration value is not picked up in the unit test. Investigation shows that the {{MetricsConfig}} class converts the prefix into lowercase string, internally the prefix is used to look up the configuration value. The mismatch of letter cases causes the system fails to pick up the configuration values., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12639122/HADOOP-10468.000.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-common-project/hadoop-common:

                  org.apache.hadoop.metrics2.impl.TestMetricsSystemImpl
                  org.apache.hadoop.metrics2.impl.TestGangliaMetrics

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/3753//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/3753//console

This message is automatically generated., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12639127/HADOOP-10468.001.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/3755//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/3755//console

This message is automatically generated., +1 for the patch., I've committed the patch to trunk and branch-2. Thanks [~arpitagarwal] for the review., SUCCESS: Integrated in Hadoop-trunk-Commit #5468 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/5468/])
HADOOP-10468. TestMetricsSystemImpl.testMultiThreadedPublish fails intermediately. Contributed by Haohui Mai. (wheat9: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1585659)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsConfig.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestGangliaMetrics.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java
, FAILURE: Integrated in Hadoop-Yarn-trunk #533 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/533/])
HADOOP-10468. TestMetricsSystemImpl.testMultiThreadedPublish fails intermediately. Contributed by Haohui Mai. (wheat9: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1585659)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsConfig.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestGangliaMetrics.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1751 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1751/])
HADOOP-10468. TestMetricsSystemImpl.testMultiThreadedPublish fails intermediately. Contributed by Haohui Mai. (wheat9: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1585659)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsConfig.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestGangliaMetrics.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1725 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1725/])
HADOOP-10468. TestMetricsSystemImpl.testMultiThreadedPublish fails intermediately. Contributed by Haohui Mai. (wheat9: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1585659)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsConfig.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestGangliaMetrics.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java
, Reopening this issue as it breaks all existing metrics2 property files.  Before this change the properties needed to be lower-cased but now they must be camel-cased (e.g.: namenode.* now must be NameNode.*).

The release note states that the metrics2 file became case-sensitive, but I don't believe that's the case.  MetricsConfig uses org.apache.commons.configuration.SubsetConfiguration which I think has always been case-sensitive.

I'm hoping there's a way we can fix the underlying issue without breaking existing metrics2 property files, because the way in which they break is silent.  The settings are simply ignored rather than an error being thrown for unrecognized/unhandled properties., bq. I'm hoping there's a way we can fix the underlying issue without breaking existing metrics2 property files
I agree with you, [~jlowe]. I'm trying to find the way., Attaching a patch to revert HADOOP-10468 and make 'Collector' to lower case.
{code}
-      .add("Test.sink.Collector." + MetricsConfig.QUEUE_CAPACITY_KEY,
+      .add("test.sink.collector." + MetricsConfig.QUEUE_CAPACITY_KEY,
{code}
{code}
-    ms.registerSink("Collector",
+    ms.registerSink("collector",
{code}
Using debugger, I confirmed the queue capacity of the sink was set to 10., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12654056/HADOOP-10468.2.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The following test timeouts occurred in hadoop-common-project/hadoop-common:

org.apache.hadoop.http.TestHttpServer

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/4208//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4208//console

This message is automatically generated., The test timeout is not related to the patch. It was reported at HADOOP-10289., [~jlowe], would you please review the latest patch?, Per [~jlowe], marking this to be a blocker for 2.5. [~wheat9], can you please help with this?, Thanks for the patch [~ajisakaa]!  It looks OK to me, although I hesitate to commit it since the original change by [~wheat9] was to not fix the test but change the behavior of the metrics system in an incompatible way.  I'm wondering if there's something subtle we're missing that would reappear if we reverted the original fix, so I'm hoping to hear from Haohui on what he thinks of the change.

My preference would be to just fix the test if that's sufficient since it retains the semantic behavior.  However if we really need to remove the lowercase call as in the original patch then I think we should also change the places where we register metrics to register them with lowercase strings.  That would retain compatibility with existing metrics properties configuration files., Looking at the code for a while to refresh my memory. Here is a quick recap:

# Metric2 implements hierarchical configuration with {{SubsetConfiguration}}. The configuration key has the format {{foo.bar.spam}}, where  each parts of the configuration is a hierarchy. For example, {{spam}} is a child of {{bar}}, and {{bar}} is a children of {{foo}. Metric2 turns some parts of the hierarchy keys in lowercase: (MetricsConfig:87)

{code}
  MetricsConfig(Configuration c, String prefix) {
    super(c, prefix.toLowerCase(Locale.US), ".");
  }
{code}

All keys of immediate children will be stored in lowercase strings (MetricConfig:151)

{code}
  Map<String, MetricsConfig> getInstanceConfigs(String type) {
    Map<String, MetricsConfig> map = Maps.newHashMap();
    MetricsConfig sub = subset(type);

    for (String key : sub.keys()) {
      Matcher matcher = INSTANCE_REGEX.matcher(key);
      if (matcher.matches()) {
        String instance = matcher.group(1);
        if (!map.containsKey(instance)) {
          map.put(instance, sub.subset(instance));
        }
      }
    }
    return map;
  }
{code}

# To look up the value in the hierarchical configuration, {{MetricConfig}} first finds the key in itself and then reconstructs the full key for its parent by concatenating the prefix, the delimiter and the key itself (SubsetConfiguration:88): 

{code}
    protected String getParentKey(String key)
    {
        if ("".equals(key) || key == null)
        {
            return prefix;
        }
        else
        {
            return delimiter == null ? prefix + key : prefix + delimiter + key;
        }
    }
{code}

In this test case, the reconstructed key is {{test.sink.collector.queue.capacity}} instead of {{test.sink.Collector.queue.capacity}}, which leads to the failure., bq. My preference would be to just fix the test if that's sufficient since it retains the semantic behavior. However if we really need to remove the lowercase call as in the original patch then I think we should also change the places where we register metrics to register them with lowercase strings. That would retain compatibility with existing metrics properties configuration files.

Fixing only the test looks okay to me. The current semantic of the metric configuration, however, seems pretty confusing. For example, the original test case in {{testMultiThreadedPublish()}} actually looks quite legit. I did a quick search and it does not seem that the behavior is documented, I suspect that many configurations are silently ignored as there are no messages on unrecognized values. Therefore, I think it might be worthwhile to fix the semantic in trunk. Thoughts?, Thanks for commenting, Haohui.  +1 to just fixing the test case in branch-2 for now.  Given it's been this way for 4 years I'm hesitant to change this, even in trunk, because other systems outside of Hadoop core could be using it and changing the case could break them in a similar way.  If we do change the semantics in trunk then I strongly suggest we go ahead and lowercase the registered names of existing entities, e.g.: {{DefaultMetricsSystem.initialize("namenode");}} instead of {{DefaultMetricsSystem.initialize("NameNode");}} to minimize the breakage to existing metrics2 config files.

So I propose we commit this to trunk, branch-2, and branch-2.5 and track the proposed change to trunk in a separate JIRA where we can discuss whether the backwards compatibility breakage is worth it.  Objections?
, The proposed solution looks good to me. We can file a separate jira to discuss the semantic and compatibility concerns., bq. So I propose we commit this to trunk, branch-2, and branch-2.5 and track the proposed change to trunk in a separate JIRA where we can discuss whether the backwards compatibility breakage is worth it. Objections?
I agree to the proposal. Thanks for the comments, [~jlowe] and [~wheat9]. 
, +1 for the latest patch, committing this.  I'll file a separate JIRA to discuss potential changes to metrics2 semantics., Thanks Akira for the contribution, and thanks to Haohui for additional review!  I committed the addendum patch to trunk, branch-2, and branch-2.5., FAILURE: Integrated in Hadoop-trunk-Commit #5885 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/5885/])
Addendum patch for HADOOP-10468 TestMetricsSystemImpl.testMultiThreadedPublish fails intermediately. Contributed by Akira AJISAKA (jlowe: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1610829)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsConfig.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestGangliaMetrics.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java
, FAILURE: Integrated in Hadoop-Yarn-trunk #614 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/614/])
Addendum patch for HADOOP-10468 TestMetricsSystemImpl.testMultiThreadedPublish fails intermediately. Contributed by Akira AJISAKA (jlowe: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1610829)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsConfig.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestGangliaMetrics.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1833 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1833/])
Addendum patch for HADOOP-10468 TestMetricsSystemImpl.testMultiThreadedPublish fails intermediately. Contributed by Akira AJISAKA (jlowe: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1610829)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsConfig.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestGangliaMetrics.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1806 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1806/])
Addendum patch for HADOOP-10468 TestMetricsSystemImpl.testMultiThreadedPublish fails intermediately. Contributed by Akira AJISAKA (jlowe: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1610829)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsConfig.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestGangliaMetrics.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestMetricsSystemImpl.java
]