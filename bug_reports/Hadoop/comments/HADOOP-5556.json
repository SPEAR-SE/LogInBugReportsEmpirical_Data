[This patch made the changes suggested above. It also optimizes SimulatedFSDataset#injectBlocks by avoid allocating a new block map., #Does CreateEditsLog have to create a default Configuration() instance, or could createEditsLog() be changed to take a Configuration as a parameter? 
# It might be useful to think -at some point in time- to move these MiniDFSCluster and  DataNodeCluster classes into a redistributable JAR, as they are handy to anyone trying to set up a test cluster in a single JVM -though we'd have to get rid of all emergency System.exit() calls first., Submitting updated patch . 
Changed path to work with pro split code ., HADOOP-5556.patch is for 0.21  , patch specific to pro split code. 
successfully ran ant test-core  , waiting for Hudson ., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12417111/HADOOP-5556.patch
  against trunk revision 804918.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 12 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/616/console

This message is automatically generated., Canceling patch . , -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12403474/DataNodeCluster.patch
  against trunk revision 804918.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 12 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/617/console

This message is automatically generated., Reopened as HDFS-555]