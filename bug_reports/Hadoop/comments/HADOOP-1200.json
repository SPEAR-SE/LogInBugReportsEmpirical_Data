[I've seen many occasions when one of the disks become read-only and TaskTracker stays up, heartbeats, but it doesn't make any progress which will hang the job.  
On the other hands, datanode cleverly stops itself leaving a log on the namenode.

2007-04-03 13:13:48,997 WARN org.apache.hadoop.dfs.NameNode: Report from __.__.__.__:____: can not create directory: /___/dfs/data/data/subdir0
2007-04-03 13:13:48,998 WARN org.apache.hadoop.dfs.NameNode: Report from __.__.__.__:____: directory is not writable: /___/dfs/data/data
2007-04-03 13:13:49,024 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /__.__.__.__/__.__.__.__:____



, Instead of a periodic thread, we can invoke checkDir when an IO error occurs., bq. Instead of a periodic thread, we can invoke checkDir when an IO error occurs.
(y) 

We can add a thread later if we still feel its useful., This patch checks if the disk is read-only whenever an IOException occurs., 
You have replaced '{{shutdown(); throw iex;}}' with '{{checkDiskError(iex); throw iex;}}' . {{checkDiskError(iex);}} does not shutdown if checkDirs() does not throw DiskErrorException. Is this functionality change intentional? 

I am not sure why there was {{ shutdown(); }} in the first place and so this change might be ok. 

Another functionality change is that  {{data.invalidate(toDelete)}}'s exception is ignored in {{processCommand()}}.  This change is probably not necessary since {{offerService()}} already handles the exception.



, > You have replaced 'shutdown(); throw iex;' with 'checkDiskError(iex); throw iex;'  does not shutdown if checkDirs() does not throw DiskErrorException. Is this functionality change intentional?
Yes, the idea is that we do not shutdown datanode if IOException is caused by any temporary error.

> Another functionality change is that data.invalidate(toDelete)'s exception is ignored in processCommand(). This change is probably not necessary since offerService() already handles the exception.
You are right. The new patch will rethrow the exception., The new patch incorporates Raghu's comment., +1

http://issues.apache.org/jira/secure/attachment/12356806/diskCheck1.patch applied and successfully tested against trunk revision r534975.

Test results:   http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/119/testReport/
Console output: http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Patch/119/console, I just committed this.  Thanks, Hairong!, Integrated in Hadoop-Nightly #82 (See http://lucene.zones.apache.org:8080/hudson/job/Hadoop-Nightly/82/)]