[Zero length file was created after command execution . 


[user@xyzhostname ~]$ hadoop fs -touchz test/new0LenFile2
09/03/05 23:31:21 WARN hdfs.DFSClient: Problem renewing lease for DFSClient_-661919204
java.io.IOException: Call to xxxxx-xxx.xxx.com/xxx.xxx.xxx.xxx:xxxx failed on local exception: java.nio.channels.ClosedByInterruptException
	at org.apache.hadoop.ipc.Client.wrapException(Client.java:765)
	at org.apache.hadoop.ipc.Client.call(Client.java:733)
	at org.apache.hadoop.ipc.RPC$Invoker.invoke(RPC.java:220)
	at $Proxy0.renewLease(Unknown Source)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:82)
	at org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:59)
	at $Proxy0.renewLease(Unknown Source)
	at org.apache.hadoop.hdfs.DFSClient$LeaseChecker.renew(DFSClient.java:1006)
	at org.apache.hadoop.hdfs.DFSClient$LeaseChecker.run(DFSClient.java:1018)
	at java.lang.Thread.run(Thread.java:619)
Caused by: java.nio.channels.ClosedByInterruptException
	at java.nio.channels.spi.AbstractInterruptibleChannel.end(AbstractInterruptibleChannel.java:184)
	at sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:263)
	at org.apache.hadoop.net.SocketInputStream$Reader.performIO(SocketInputStream.java:55)
	at org.apache.hadoop.net.SocketIOWithTimeout.doIO(SocketIOWithTimeout.java:142)
	at org.apache.hadoop.net.SocketInputStream.read(SocketInputStream.java:155)
	at org.apache.hadoop.net.SocketInputStream.read(SocketInputStream.java:128)
	at java.io.FilterInputStream.read(FilterInputStream.java:116)
	at org.apache.hadoop.ipc.Client$Connection$PingInputStream.read(Client.java:276)
	at java.io.BufferedInputStream.fill(BufferedInputStream.java:218)
	at java.io.BufferedInputStream.read(BufferedInputStream.java:237)
	at java.io.DataInputStream.readInt(DataInputStream.java:370)
	at org.apache.hadoop.ipc.Client$Connection.receiveResponse(Client.java:501)
	at org.apache.hadoop.ipc.Client$Connection.run(Client.java:446)


, Ravi, are you able to reproduce it?

Tried 0.20 and trunk.  I could not reproduce this problem.  -touchz worked fine., Nicholas, try running the same touchz command over and over again quickly.  I seem to get it 30% of the time., It looks that when a dfs client exits, it closes its connection to NameNode before it make sure that the lease renewal thread exits. , This patch makes sure that the lease renewal thread exit before it shuts down the RPC proxy to NameNode. , Hairong ,  tested with your patch . hadoop fs -touchz is fixed but it has introduced new bug .  Which causes  hadoop fs -ls  throwing NullPointerException    . 
This is reproducible .

Exception in thread "main" java.lang.NullPointerException
	at org.apache.hadoop.hdfs.DFSClient$LeaseChecker.join(DFSClient.java:957)
	at org.apache.hadoop.hdfs.DFSClient.close(DFSClient.java:211)
	at org.apache.hadoop.hdfs.DistributedFileSystem.close(DistributedFileSystem.java:277)
	at org.apache.hadoop.fs.FsShell.close(FsShell.java:1879)
	at org.apache.hadoop.fs.FsShell.main(FsShell.java:1893)
, Thanks Ravi for testing the patch. The new patch fixes the NPE problem., +1 leaseClose1.patch looks good, This patch has one more change. It makes sure that LeaseChecker will terminate after being interrupted., +1 . Checked leaseClose2.patch for both touchz and ls . , Resubmit the patch because it was not picked up by hudson yesterday., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12401986/leaseClose2.patch
  against trunk revision 752682.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs warnings.

    +1 Eclipse classpath. The patch retains Eclipse classpath integrity.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-minerva.apache.org/53/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-minerva.apache.org/53/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-minerva.apache.org/53/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-minerva.apache.org/53/console

This message is automatically generated., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12401986/leaseClose2.patch
  against trunk revision 752984.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs warnings.

    +1 Eclipse classpath. The patch retains Eclipse classpath integrity.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-minerva.apache.org/55/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-minerva.apache.org/55/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-minerva.apache.org/55/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-minerva.apache.org/55/console

This message is automatically generated., This patch fixed the junit test timeout problem., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12402182/leaseClose3.patch
  against trunk revision 753449.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs warnings.

    +1 Eclipse classpath. The patch retains Eclipse classpath integrity.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/87/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/87/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/87/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/87/console

This message is automatically generated., +1 new patch looks good., The failed test was reported at HADOOP-5391. It is not related to this jra., I've committed this.]