[Datanodes write to local file using a bufferedotputstream, With the patch, I see a performance improvement:
Aggregate cluster throughput with the patch is at 1.145G on 100 nodes, +1.

Yes, this will increase buffer copies. But we intend get rid of copies without changing effective write size for sockets for 0.17 (HADOOP-2154). I went through the same experience with HADOOP-1134, initially didn't have BufferedOutputStream and added it after the benchmarks.
, -1 overall.  Here are the results of testing the latest attachment 
http://issues.apache.org/jira/secure/attachment/12374587/perf.patch
against trunk revision 616796.

    @author +1.  The patch does not contain any @author tags.

    javadoc +1.  The javadoc tool did not generate any warning messages.

    javac +1.  The applied patch does not generate any new javac compiler warnings.

    release audit +1.  The applied patch does not generate any new release audit warnings.

    findbugs +1.  The patch does not introduce any new Findbugs warnings.

    core tests -1.  The patch failed core unit tests.

    contrib tests +1.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1725/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1725/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1725/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1725/console

This message is automatically generated., -1 overall.  Here are the results of testing the latest attachment 
http://issues.apache.org/jira/secure/attachment/12374587/perf.patch
against trunk revision 616796.

    @author +1.  The patch does not contain any @author tags.

    javadoc +1.  The javadoc tool did not generate any warning messages.

    javac +1.  The applied patch does not generate any new javac compiler warnings.

    release audit +1.  The applied patch does not generate any new release audit warnings.

    findbugs +1.  The patch does not introduce any new Findbugs warnings.

    core tests -1.  The patch failed core unit tests.

    contrib tests +1.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1727/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1727/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1727/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1727/console

This message is automatically generated., In both core test runs above, TestBalancer failed with this exception:

{quote}
    [junit] 2008-02-02 00:51:29,097 INFO  dfs.DataNode (DataNode.java:writeBlock(1169)) - writeBlock blk_-4006373334377701738 received exception java.io.IOException: setBlockPosition trying to set position to 3 which is not a multiple of bytesPerChecksum 10
    [junit] 2008-02-02 00:51:29,098 ERROR dfs.DataNode (DataNode.java:run(961)) - 127.0.0.1:49578:DataXceiver: java.io.IOException: setBlockPosition trying to set position to 3 which is not a multiple of bytesPerChecksum 10
    [junit] 	at org.apache.hadoop.dfs.DataNode$BlockReceiver.setBlockPosition(DataNode.java:2301)
    [junit] 	at org.apache.hadoop.dfs.DataNode$BlockReceiver.receivePacket(DataNode.java:2126)
    [junit] 	at org.apache.hadoop.dfs.DataNode$BlockReceiver.receiveBlock(DataNode.java:2230)
    [junit] 	at org.apache.hadoop.dfs.DataNode$DataXceiver.writeBlock(DataNode.java:1150)
    [junit] 	at org.apache.hadoop.dfs.DataNode$DataXceiver.run(DataNode.java:938)
    [junit] 	at java.lang.Thread.run(Thread.java:595)
{quote}

, Failure in unit tests TestBalancer , Since the datanode started using a bufferoutputstream, the verification that the offset of a packet in the block matches the current channel offset needed to be modified., -1 overall.  Here are the results of testing the latest attachment 
http://issues.apache.org/jira/secure/attachment/12374633/perf1.patch
against trunk revision 616796.

    @author +1.  The patch does not contain any @author tags.

    javadoc +1.  The javadoc tool did not generate any warning messages.

    javac +1.  The applied patch does not generate any new javac compiler warnings.

    release audit +1.  The applied patch does not generate any new release audit warnings.

    findbugs -1.  The patch appears to introduce 1 new Findbugs warnings.

    core tests +1.  The patch passed core unit tests.

    contrib tests +1.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1733/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1733/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1733/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1733/console

This message is automatically generated., Findbugs warnings, Fix findbugs warnings, -1 overall.  Here are the results of testing the latest attachment 
http://issues.apache.org/jira/secure/attachment/12374659/perf2.patch
against trunk revision 616796.

    @author +1.  The patch does not contain any @author tags.

    javadoc +1.  The javadoc tool did not generate any warning messages.

    javac +1.  The applied patch does not generate any new javac compiler warnings.

    release audit +1.  The applied patch does not generate any new release audit warnings.

    findbugs +1.  The patch does not introduce any new Findbugs warnings.

    core tests -1.  The patch failed core unit tests.

    contrib tests +1.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1735/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1735/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1735/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/1735/console

This message is automatically generated., I just committed this.  Thanks Dhruba!]