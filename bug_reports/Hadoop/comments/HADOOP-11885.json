[I see this line in the pom.xml:

{noformat}
                    <exec executable="sh" dir="${project.build.directory}" failonerror="true">
                      <arg line="./dist-layout-stitching.sh"/>
                    </exec>
{noformat}

sh is dash by default on ubuntu. I tried invoking it directly with dash, got the above errors. When I tried it with bash, it worked.

Fix might be as easy as changing "sh" to instead be "bash"., [~aw] I think you were the last person to touch this script, any thoughts?, Actually, I committed the last change but it wasn't my change... you'd know if it was mine. ;)

Ideally, assuming we want to keep this as a separate script and not something that maven does itself using maven facilities (I think [~busbey] mentioned assemblies), it should really get pushed into dev-support and then rewritten to use modern shell practices, etc, etc.  That way shellcheck could pick it up, etc., Oh, FWIW, it was decided a while back (like 0.x days) that the official shell was going to be bash. So I agree that forcing this to bash should be a quick and 'legal' fix., Thanks for commenting Allen. This attached patch changes "sh" to "bash" where my grep found it.

I'm also somewhat puzzled why dash doesn't end up with a non-zero error code when it's spitting all these parse errors. I played with -e and the run() wrapper to no avail. This is pretty scary to me since it means we are silently ignoring errors. If you have a sec, would appreciate a quick look from a more experienced shell scripter.

{noformat}
-> % mvn -f hadoop-dist/pom.xml package -Pdist
...or...
-> % dash target/dist-layout-stitching.sh
{noformat}

Sounds like we really need that dev-support refactor, or maven assembly., Nice catch..Shall I post patch ..?, \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  14m 28s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | javac |   7m 31s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 37s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 22s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | install |   1m 32s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | common tests |  23m 25s | Tests passed in hadoop-common. |
| {color:green}+1{color} | common tests |   1m 37s | Tests passed in hadoop-kms. |
| {color:green}+1{color} | dist tests |   0m 15s | Tests passed in hadoop-dist. |
| {color:green}+1{color} | mapreduce tests |  10m  7s | Tests passed in hadoop-mapreduce-client-nativetask. |
| {color:green}+1{color} | yarn tests |   5m 58s | Tests passed in hadoop-yarn-server-nodemanager. |
| {color:red}-1{color} | hdfs tests | 164m 30s | Tests failed in hadoop-hdfs. |
| {color:green}+1{color} | hdfs tests |   3m 32s | Tests passed in hadoop-hdfs-httpfs. |
| | | 243m 30s | |
\\
\\
|| Reason || Tests ||
| Failed unit tests | hadoop.hdfs.TestEncryptionZonesWithKMS |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12729014/hadoop-11885.001.patch |
| Optional Tests | javadoc javac unit |
| git revision | trunk / 439614b |
| hadoop-common test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6209/artifact/patchprocess/testrun_hadoop-common.txt |
| hadoop-kms test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6209/artifact/patchprocess/testrun_hadoop-kms.txt |
| hadoop-dist test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6209/artifact/patchprocess/testrun_hadoop-dist.txt |
| hadoop-mapreduce-client-nativetask test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6209/artifact/patchprocess/testrun_hadoop-mapreduce-client-nativetask.txt |
| hadoop-yarn-server-nodemanager test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6209/artifact/patchprocess/testrun_hadoop-yarn-server-nodemanager.txt |
| hadoop-hdfs test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6209/artifact/patchprocess/testrun_hadoop-hdfs.txt |
| hadoop-hdfs-httpfs test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6209/artifact/patchprocess/testrun_hadoop-hdfs-httpfs.txt |
| Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/6209/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf909.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/6209/console |


This message was automatically generated., better to make the shell exe name a property, then you can change it to sh. bash, whatever in one place, instead of doing another search & replace, bq.  hdfs tests 	164m 30s 	Tests failed in hadoop-hdfs. 

As expected, half the test time is in hdfs. We're going to have to increase the jenkins time out values again soon. :(, Did another sed to use a maven property. I did a full -Pdist build okay so I think life is okay, despite Jenkins thinking otherwise., \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  14m 27s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | javac |   7m 28s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 29s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 22s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | install |   1m 32s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | common tests |  23m 34s | Tests passed in hadoop-common. |
| {color:green}+1{color} | common tests |   1m 38s | Tests passed in hadoop-kms. |
| {color:green}+1{color} | dist tests |   0m 13s | Tests passed in hadoop-dist. |
| {color:green}+1{color} | mapreduce tests |  10m 13s | Tests passed in hadoop-mapreduce-client-nativetask. |
| {color:green}+1{color} | yarn tests |   5m 49s | Tests passed in hadoop-yarn-server-nodemanager. |
| {color:red}-1{color} | hdfs tests | 225m 32s | Tests failed in hadoop-hdfs. |
| {color:green}+1{color} | hdfs tests |   3m 37s | Tests passed in hadoop-hdfs-httpfs. |
| | | 304m 31s | |
\\
\\
|| Reason || Tests ||
| Failed unit tests | hadoop.hdfs.server.namenode.TestDeleteRace |
|   | hadoop.hdfs.TestClose |
|   | hadoop.hdfs.TestDFSClientRetries |
|   | hadoop.hdfs.TestQuota |
|   | hadoop.hdfs.TestMultiThreadedHflush |
|   | hadoop.hdfs.TestDFSOutputStream |
|   | hadoop.hdfs.server.namenode.TestSaveNamespace |
|   | hadoop.hdfs.server.datanode.TestBlockRecovery |
|   | hadoop.cli.TestHDFSCLI |
|   | hadoop.hdfs.TestFileLengthOnClusterRestart |
|   | hadoop.hdfs.TestCrcCorruption |
|   | hadoop.hdfs.server.datanode.fsdataset.impl.TestRbwSpaceReservation |
| Timed out tests | org.apache.hadoop.hdfs.server.namenode.TestNamenodeRetryCache |
|   | org.apache.hadoop.hdfs.TestClientProtocolForPipelineRecovery |
|   | org.apache.hadoop.hdfs.tools.offlineEditsViewer.TestOfflineEditsViewer |
|   | org.apache.hadoop.hdfs.TestDataTransferProtocol |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12729396/hadoop-11885.002.patch |
| Optional Tests | javadoc javac unit |
| git revision | trunk / aa22450 |
| hadoop-common test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6225/artifact/patchprocess/testrun_hadoop-common.txt |
| hadoop-kms test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6225/artifact/patchprocess/testrun_hadoop-kms.txt |
| hadoop-dist test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6225/artifact/patchprocess/testrun_hadoop-dist.txt |
| hadoop-mapreduce-client-nativetask test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6225/artifact/patchprocess/testrun_hadoop-mapreduce-client-nativetask.txt |
| hadoop-yarn-server-nodemanager test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6225/artifact/patchprocess/testrun_hadoop-yarn-server-nodemanager.txt |
| hadoop-hdfs test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6225/artifact/patchprocess/testrun_hadoop-hdfs.txt |
| hadoop-hdfs-httpfs test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6225/artifact/patchprocess/testrun_hadoop-hdfs-httpfs.txt |
| Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/6225/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf906.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/6225/console |


This message was automatically generated., I'm retriggering the build, some of the tests failed with "directory locked" (Jenkins issue) and the other look like flake timeouts. This is the most flakes I've seen in a while :(, There are a ton of HDFS unit tests running, bogging down the boxes. , \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  14m 35s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | javac |   7m 30s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 37s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 22s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 32s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | common tests |  22m 14s | Tests passed in hadoop-common. |
| {color:green}+1{color} | common tests |   1m 38s | Tests passed in hadoop-kms. |
| {color:green}+1{color} | dist tests |   0m 13s | Tests passed in hadoop-dist. |
| {color:green}+1{color} | mapreduce tests |  10m  5s | Tests passed in hadoop-mapreduce-client-nativetask. |
| {color:green}+1{color} | yarn tests |   5m 49s | Tests passed in hadoop-yarn-server-nodemanager. |
| {color:green}+1{color} | hdfs tests | 164m 29s | Tests passed in hadoop-hdfs. |
| {color:green}+1{color} | hdfs tests |   3m 34s | Tests passed in hadoop-hdfs-httpfs. |
| | | 242m 17s | |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12729396/hadoop-11885.002.patch |
| Optional Tests | javadoc javac unit |
| git revision | trunk / 98a6176 |
| hadoop-common test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6231/artifact/patchprocess/testrun_hadoop-common.txt |
| hadoop-kms test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6231/artifact/patchprocess/testrun_hadoop-kms.txt |
| hadoop-dist test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6231/artifact/patchprocess/testrun_hadoop-dist.txt |
| hadoop-mapreduce-client-nativetask test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6231/artifact/patchprocess/testrun_hadoop-mapreduce-client-nativetask.txt |
| hadoop-yarn-server-nodemanager test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6231/artifact/patchprocess/testrun_hadoop-yarn-server-nodemanager.txt |
| hadoop-hdfs test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6231/artifact/patchprocess/testrun_hadoop-hdfs.txt |
| hadoop-hdfs-httpfs test log | https://builds.apache.org/job/PreCommit-HADOOP-Build/6231/artifact/patchprocess/testrun_hadoop-hdfs-httpfs.txt |
| Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/6231/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf905.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/6231/console |


This message was automatically generated., Thanks, Andrew.  +1., Pushed to trunk and branch-2, thanks Colin and others for reviewing!, FAILURE: Integrated in Hadoop-trunk-Commit #7927 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/7927/])
HADOOP-11885. hadoop-dist dist-layout-stitching.sh does not work with dash. (wang) (andrew.wang: rev 7673d4f205b26a6a26cfc47d999ece96f3c42782)
* pom.xml
* hadoop-hdfs-project/hadoop-hdfs/pom.xml
* hadoop-hdfs-project/hadoop-hdfs-httpfs/pom.xml
* hadoop-yarn-project/pom.xml
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/pom.xml
* hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-nativetask/pom.xml
* hadoop-mapreduce-project/pom.xml
* hadoop-common-project/hadoop-kms/pom.xml
* hadoop-common-project/hadoop-common/pom.xml
* hadoop-project-dist/pom.xml
* hadoop-dist/pom.xml
* hadoop-common-project/hadoop-common/CHANGES.txt
, FAILURE: Integrated in Hadoop-Yarn-trunk #943 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/943/])
HADOOP-11885. hadoop-dist dist-layout-stitching.sh does not work with dash. (wang) (andrew.wang: rev 7673d4f205b26a6a26cfc47d999ece96f3c42782)
* hadoop-hdfs-project/hadoop-hdfs/pom.xml
* hadoop-common-project/hadoop-common/pom.xml
* hadoop-mapreduce-project/pom.xml
* hadoop-common-project/hadoop-common/CHANGES.txt
* hadoop-dist/pom.xml
* hadoop-yarn-project/pom.xml
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/pom.xml
* hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-nativetask/pom.xml
* hadoop-project-dist/pom.xml
* pom.xml
* hadoop-hdfs-project/hadoop-hdfs-httpfs/pom.xml
* hadoop-common-project/hadoop-kms/pom.xml
, SUCCESS: Integrated in Hadoop-Yarn-trunk-Java8 #213 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/213/])
HADOOP-11885. hadoop-dist dist-layout-stitching.sh does not work with dash. (wang) (andrew.wang: rev 7673d4f205b26a6a26cfc47d999ece96f3c42782)
* hadoop-hdfs-project/hadoop-hdfs/pom.xml
* hadoop-dist/pom.xml
* hadoop-hdfs-project/hadoop-hdfs-httpfs/pom.xml
* hadoop-project-dist/pom.xml
* pom.xml
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/pom.xml
* hadoop-yarn-project/pom.xml
* hadoop-common-project/hadoop-kms/pom.xml
* hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-nativetask/pom.xml
* hadoop-common-project/hadoop-common/pom.xml
* hadoop-common-project/hadoop-common/CHANGES.txt
* hadoop-mapreduce-project/pom.xml
, SUCCESS: Integrated in Hadoop-Hdfs-trunk #2141 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2141/])
HADOOP-11885. hadoop-dist dist-layout-stitching.sh does not work with dash. (wang) (andrew.wang: rev 7673d4f205b26a6a26cfc47d999ece96f3c42782)
* hadoop-dist/pom.xml
* hadoop-common-project/hadoop-kms/pom.xml
* pom.xml
* hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-nativetask/pom.xml
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/pom.xml
* hadoop-common-project/hadoop-common/CHANGES.txt
* hadoop-project-dist/pom.xml
* hadoop-hdfs-project/hadoop-hdfs/pom.xml
* hadoop-common-project/hadoop-common/pom.xml
* hadoop-hdfs-project/hadoop-hdfs-httpfs/pom.xml
* hadoop-yarn-project/pom.xml
* hadoop-mapreduce-project/pom.xml
, SUCCESS: Integrated in Hadoop-Hdfs-trunk-Java8 #202 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/202/])
HADOOP-11885. hadoop-dist dist-layout-stitching.sh does not work with dash. (wang) (andrew.wang: rev 7673d4f205b26a6a26cfc47d999ece96f3c42782)
* hadoop-common-project/hadoop-common/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/pom.xml
* hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-nativetask/pom.xml
* hadoop-hdfs-project/hadoop-hdfs-httpfs/pom.xml
* hadoop-project-dist/pom.xml
* hadoop-hdfs-project/hadoop-hdfs/pom.xml
* hadoop-yarn-project/pom.xml
* pom.xml
* hadoop-common-project/hadoop-kms/pom.xml
* hadoop-common-project/hadoop-common/pom.xml
* hadoop-mapreduce-project/pom.xml
* hadoop-dist/pom.xml
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk-Java8 #211 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/211/])
HADOOP-11885. hadoop-dist dist-layout-stitching.sh does not work with dash. (wang) (andrew.wang: rev 7673d4f205b26a6a26cfc47d999ece96f3c42782)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/pom.xml
* hadoop-hdfs-project/hadoop-hdfs-httpfs/pom.xml
* hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-nativetask/pom.xml
* pom.xml
* hadoop-project-dist/pom.xml
* hadoop-hdfs-project/hadoop-hdfs/pom.xml
* hadoop-common-project/hadoop-common/CHANGES.txt
* hadoop-yarn-project/pom.xml
* hadoop-mapreduce-project/pom.xml
* hadoop-dist/pom.xml
* hadoop-common-project/hadoop-kms/pom.xml
* hadoop-common-project/hadoop-common/pom.xml
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk #2159 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2159/])
HADOOP-11885. hadoop-dist dist-layout-stitching.sh does not work with dash. (wang) (andrew.wang: rev 7673d4f205b26a6a26cfc47d999ece96f3c42782)
* hadoop-hdfs-project/hadoop-hdfs-httpfs/pom.xml
* hadoop-common-project/hadoop-common/CHANGES.txt
* hadoop-mapreduce-project/hadoop-mapreduce-client/hadoop-mapreduce-client-nativetask/pom.xml
* hadoop-dist/pom.xml
* hadoop-project-dist/pom.xml
* pom.xml
* hadoop-common-project/hadoop-common/pom.xml
* hadoop-hdfs-project/hadoop-hdfs/pom.xml
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/pom.xml
* hadoop-mapreduce-project/pom.xml
* hadoop-yarn-project/pom.xml
* hadoop-common-project/hadoop-kms/pom.xml
]