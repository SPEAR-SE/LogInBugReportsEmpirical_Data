[Stacktrace of such a failure:

{noformat}

2009-06-11 07:14:30,798 ERROR org.apache.hadoop.dfs.NameNode.Secondary: 
Throwable Exception in doCheckpoint:
2009-06-11 07:14:30,798 ERROR org.apache.hadoop.dfs.NameNode.Secondary: 
java.lang.IllegalArgumentException: Illegal group reference
        at java.util.regex.Matcher.appendReplacement(Matcher.java:713)
        at java.util.regex.Matcher.replaceFirst(Matcher.java:861)
        at java.lang.String.replaceFirst(String.java:2147)
        at 
org.apache.hadoop.dfs.LeaseManager.changeLease(LeaseManager.java:288)
        at 
org.apache.hadoop.dfs.FSNamesystem.changeLease(FSNamesystem.java:4441)
        at org.apache.hadoop.dfs.FSEditLog.loadFSEdits(FSEditLog.java:563)
        at org.apache.hadoop.dfs.FSImage.loadFSEdits(FSImage.java:846)
        at 
org.apache.hadoop.dfs.SecondaryNameNode$CheckpointStorage.doMerge(SecondaryNameNode.java:567)
        at 
org.apache.hadoop.dfs.SecondaryNameNode$CheckpointStorage.access$000(SecondaryNameNode.java:464)
        at 
org.apache.hadoop.dfs.SecondaryNameNode.doMerge(SecondaryNameNode.java:341)
        at 
org.apache.hadoop.dfs.SecondaryNameNode.doCheckpoint(SecondaryNameNode.java:305)
        at 
org.apache.hadoop.dfs.SecondaryNameNode.run(SecondaryNameNode.java:216)
        at java.lang.Thread.run(Thread.java:619)

2009-06-11 07:14:30,842 INFO org.apache.hadoop.dfs.NameNode.Secondary: 
SHUTDOWN_MSG:
/************************************************************
SHUTDOWN_MSG: Shutting down SecondaryNameNode at host/ip
************************************************************/
{noformat}, 6017_20090611.patch: we should not use String.replaceFirst(..) at all., 6017_20090611b.patch: changed the unit test a little bit., +1. The patch looks good.

I am attaching the patch 0.18 branch. 

There are more changes required for TestRenameWhileOpen.java since the rename test that the new test is part of was disabled in 0.18. This patch enables parts of the test.
, {noformat}
     [exec] +1 overall.  
     [exec] 
     [exec]     +1 @author.  The patch does not contain any @author tags.
     [exec] 
     [exec]     +1 tests included.  The patch appears to include 3 new or modified tests.
     [exec] 
     [exec]     +1 javadoc.  The javadoc tool did not generate any warning messages.
     [exec] 
     [exec]     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.
     [exec] 
     [exec]     +1 findbugs.  The patch does not introduce any new Findbugs warnings.
     [exec] 
     [exec]     +1 Eclipse classpath. The patch retains Eclipse classpath integrity.
     [exec] 
     [exec]     +1 release audit.  The applied patch does not increase the total number of release audit warnings.
{noformat}, I ran unit tests on trunk with 6017_20090611b.patch.  The only failed test was TestReduceFetch, which seemed unrelated.  Then, I ran TestReduceFetch on a clean trunk.  It also failed in both my linux and windows machines., I filed HADOOP-6029 for TestReduceFetch., I am planning to commit these. Hudson is currently running Jun 11th patches., I just committed this. Thanks Nicholas., Patch for branch 0.20 is attached. The trunk patch does not apply because of path difference for hdfs tests.

This patch applies to 0.19 as well., Looking at the patch, this appears to only fix input/output validation.  How do we deal with our currently corrupted edits file?  This patch needs to fix that as well!, This fixes actual bug. The edits file is not corrupted. It is just that NameNode didn't handle filenames properly for certain edit log entries. With this patch, NN and secondary NN can handle the same edit log properly., Integrated in Hadoop-trunk #869 (See [http://hudson.zones.apache.org/hudson/job/Hadoop-trunk/869/])
    , Editorial pass over all release notes prior to publication of 0.21. Bug.]