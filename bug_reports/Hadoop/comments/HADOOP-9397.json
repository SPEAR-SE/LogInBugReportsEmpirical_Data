[Example output from {{mvn install -Pdist -Dtar}} after a previous build:

{noformat}
[INFO] --- maven-antrun-plugin:1.6:run (tar) @ hadoop-dist ---
[INFO] Executing tasks

main:
     [exec] $ tar cf hadoop-3.0.0-SNAPSHOT.tar hadoop-3.0.0-SNAPSHOT
     [exec] gzip: hadoop-3.0.0-SNAPSHOT.tar.gz already exists;	not overwritten
     [exec] $ gzip hadoop-3.0.0-SNAPSHOT.tar
     [exec] 
     [exec] Failed!
{noformat}, Looks like this was broken by HADOOP-8562.  We used to use {{tar czf}} to build the tarball, but now it uses {{tar cf}} followed by a separate {{gzip}} instead.  {{tar}}  overwrites the destination file but gzip by default does not., Here is a patch that switches to using gzip -f.  I tested this successfully on Mac and Windows., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12573480/HADOOP-9397.1.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-dist.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2321//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2321//console

This message is automatically generated., No tests, because it's a build script change only., Thanks for looking into this, Chris.  I'm assuming this was changed because some platform doesn't support the 'z' flag for {{tar}}.  Curious though, why does hadoop-dist invoke tar and gzip separately, while other projects pipe the output of tar to gzip (e.g.: hadoop-mapreduce-project, hadoop-yarn-project)?  The latter doesn't have this issue because the shell redirect clobbers the output file.  Do we really need the intermediate .tar file kept around?, Thanks, Jason.

{quote}
Curious though, why does hadoop-dist invoke tar and gzip separately, while other projects pipe the output of tar to gzip (e.g.: hadoop-mapreduce-project, hadoop-yarn-project)?
{quote}

The changes to the distribution scripts were originally submitted in HADOOP-9271.  I left detailed comments explaining all of the changes there.  I'm pasting the most relevant part here:

{code}
-                      run tar czf hadoop-${project.version}.tar.gz hadoop-${project.version}
+                      run tar cf hadoop-${project.version}.tar hadoop-${project.version}
+                      run gzip hadoop-${project.version}.tar
{code}

The 'z' flag for compression causes tar to fork a separate process for gzip. GnuWin32 tar has a limitation in that fork was never implemented, so this would fail on Windows with "Cannot fork: Function not implemented". Splitting this into separate tar and gzip commands works cross-platform.

Another option here would have been to control the pipeline explicitly using a shell pipeline (tar | gzip), but the "run" helper function used here isn't compatible with passing a command that has a pipe.

{quote}
Do we really need the intermediate .tar file kept around?
{quote}

No, and gzip actually replaces the original file, so we don't have this problem.  I just ran it again and confirmed that the end result was a .tar.gz file (and no separate .tar file).
, Thanks for the clarification, but I'm still wondering why this isn't consistent with the tar scripts used by hadoop-yarn-project, hadoop-mapreduce-project, etc.  Any legitimate reason this is different?, The difference is the use of the helper run method for error reporting (hadoop-dist) vs. not explicitly reporting errors (hadoop-yarn-project, hadoop-mapreduce-project, etc.).  As far as I can tell from revision history, this difference has always been there, dating back to initial commit of the code in HADOOP-7737 in 2011.  I don't know that there is a legitimate reason for it though.  You could argue that hadoop-yarn-project, hadoop-mapreduce-project, etc. should be doing something to check for errors after each command and report it, more like what hadoop-dist does.
, bq. You could argue that hadoop-yarn-project, hadoop-mapreduce-project, etc. should be doing something to check for errors after each command and report it, more like what hadoop-dist does.

That's basically what I'm getting at.  They probably shouldn't be different, so I was wondering which one is the "right" one.  Thanks for digging up the history.

+1, will commit shortly.  I'll also file followup JIRAs to make the tar scripts in the other projects consistent with the one in hadoop-dist.
, Thanks, Chris!  I committed this to trunk., Integrated in Hadoop-trunk-Commit #3468 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3468/])
    HADOOP-9397. Incremental dist tar build fails. Contributed by Chris Nauroth (Revision 1456212)

     Result = SUCCESS
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1456212
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-dist/pom.xml
, Thanks for the review and commit, Jason!  I'll keep an eye out for the follow-ups., Integrated in Hadoop-Yarn-trunk #155 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/155/])
    HADOOP-9397. Incremental dist tar build fails. Contributed by Chris Nauroth (Revision 1456212)

     Result = SUCCESS
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1456212
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-dist/pom.xml
, Integrated in Hadoop-Hdfs-trunk #1344 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1344/])
    HADOOP-9397. Incremental dist tar build fails. Contributed by Chris Nauroth (Revision 1456212)

     Result = FAILURE
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1456212
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-dist/pom.xml
, Integrated in Hadoop-Mapreduce-trunk #1372 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1372/])
    HADOOP-9397. Incremental dist tar build fails. Contributed by Chris Nauroth (Revision 1456212)

     Result = SUCCESS
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1456212
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-dist/pom.xml
, I pulled this change into branch-2 as well since it was missed when HADOOP-8562 was merged recently to branch-2., Seems like this JIRA is logged under trunk section in CHANGES.txt, instead of being in 2.1.0-beta part, This was initially checked into trunk then later merged to branch-2.  When it was merged to branch-2, the CHANGES.txt on branch-2 was updated to include this JIRA.  Are we supposed to be updating the trunk's version of CHANGES.txt every time we later merge something into another branch?  That has definitely not been happening for a lot of changes that have been subsequently pulled into branch-0.23., I updated trunk's CHANGES.txt to move HADOOP-9397 down into the 2.1.0 section, since that's what others are doing for trunk patches that have been merged to branch-2.

Note that there's a ton of stuff missing for branch-0.23 if the same should have been done there.  The only accurate CHANGES.txt for branch-0.23 is the one on branch-0.23 itself.  If we need to keep the CHANGES.txt up-to-date on all other branches when a change is merged between two branches, that's going to be fun times., Integrated in Hadoop-trunk-Commit #3838 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3838/])
    Move HADOOP-9397 to 2.1.0-beta after merging it into branch-2. (Revision 1489026)

     Result = SUCCESS
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1489026
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
, Integrated in Hadoop-Yarn-trunk #230 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/230/])
    Move HADOOP-9397 to 2.1.0-beta after merging it into branch-2. (Revision 1489026)

     Result = FAILURE
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1489026
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
, Integrated in Hadoop-Hdfs-trunk #1420 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1420/])
    Move HADOOP-9397 to 2.1.0-beta after merging it into branch-2. (Revision 1489026)

     Result = FAILURE
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1489026
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
, Integrated in Hadoop-Mapreduce-trunk #1446 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1446/])
    Move HADOOP-9397 to 2.1.0-beta after merging it into branch-2. (Revision 1489026)

     Result = SUCCESS
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1489026
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
]