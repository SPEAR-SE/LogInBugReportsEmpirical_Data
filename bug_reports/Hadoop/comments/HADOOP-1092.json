[A Datanode times-out and is declared dead by the Namenode. The Namenode invokes removeDatanode. This Datanode has a block that has only one replica.

Inside removeStoredBlock(), we remove this block from the blocksMap and then call neededReplication. update(block, -1, 0). Inside update(), we call blocksMap.get() and we fail to find the block becaase we have just removed it. Hence the null-pointer exception.

, Comments from Hairong: "needReplication.update should be able to remove the block with 0 copy. The code does not handle the case well. I will fix it.", Dhruba did not post my first comment. :-)

The problem can be solved by updating neededRepliction before we remove the block from the blockMap. , +1. Code reviewed. Looks good., I've just committed this. Thanks Hairong!]