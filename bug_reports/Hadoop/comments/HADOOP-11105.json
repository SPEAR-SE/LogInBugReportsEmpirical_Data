[Attaching two eclipse Memory Analyzer graph of the heap dump., Attaching a patch., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12669766/HADOOP-11105.patch
  against trunk revision 485c96e.

    {color:red}-1 patch{color}.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4759//console

This message is automatically generated., Fixing the format., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12669778/HADOOP-11105.2.patch
  against trunk revision 570b8b4.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/4760//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4760//console

This message is automatically generated., Nice catch.

I noticed that the callbacks become named in this patch. I wonder, is it possible to fix the leaks without this functionality?, Hi, [~wheat9].  We do need a way to track which of these callbacks are associated with an individual named metrics source.  This applies to the callbacks created internally as an implementation detail of {{MetricsSystemImpl}}.  Then, when the metrics source gets unregistered, we can drop all callbacks matching that name.

We also wanted to maintain the existing public interface, which allows registration of a callback without specifying name.  For that reason, we also still maintain the unnamed {{callbacks}} list.  The {{namedCallbacks}} map is only for the instances constructed internally by {{MetricsSystemImpl}}.

[~chuanliu], thank you for providing the patch and doing the testing to verify that this fixed the leak.  I'm +1 for the patch and will commit soon., I committed this to trunk and branch-2.  Chuan, thank you for contributing the patch.  Haohui, thank you for helping with code review., SUCCESS: Integrated in Hadoop-Yarn-trunk #685 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/685/])
HADOOP-11105. MetricsSystemImpl could leak memory in registered callbacks. Contributed by Chuan Liu. (cnauroth: rev 1942364ef14396e9bd94a87c0d901ff9abe1d42a)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsSystemImpl.java
HADOOP-11105. Update CHANGES.txt. (cnauroth: rev 1b4b46004acca1fcb2c291933c1cd3f75e9918b3)
* hadoop-common-project/hadoop-common/CHANGES.txt
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1901 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1901/])
HADOOP-11105. MetricsSystemImpl could leak memory in registered callbacks. Contributed by Chuan Liu. (cnauroth: rev 1942364ef14396e9bd94a87c0d901ff9abe1d42a)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsSystemImpl.java
HADOOP-11105. Update CHANGES.txt. (cnauroth: rev 1b4b46004acca1fcb2c291933c1cd3f75e9918b3)
* hadoop-common-project/hadoop-common/CHANGES.txt
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1876 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1876/])
HADOOP-11105. MetricsSystemImpl could leak memory in registered callbacks. Contributed by Chuan Liu. (cnauroth: rev 1942364ef14396e9bd94a87c0d901ff9abe1d42a)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/metrics2/impl/MetricsSystemImpl.java
HADOOP-11105. Update CHANGES.txt. (cnauroth: rev 1b4b46004acca1fcb2c291933c1cd3f75e9918b3)
* hadoop-common-project/hadoop-common/CHANGES.txt
]