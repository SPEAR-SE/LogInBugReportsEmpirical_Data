[Re-targeting to 2.5.0 as 0.23.x line is reaching maintenance mode. , Moving bugs out of previously closed releases into the next minor release 2.8.0., There has been no movement on this for a while. We'll need to move it out of scope for 2.8.0 soon. Let me know if you disagree., Not much going on here for a long time, dropping from 2.8.0.

Not putting any target-version either anymore, let's target this depending on when there is patch activity., This patch incorporates all the open subtasks.  Branch-2 patch forthcoming after conflicts resolved.

Major highlights:
# Frivolous synchronization in common code paths is eliminated.
# Login/logout/relogin synchronizes on the subject's private credentials to ensure atomic update relative to each other and SASL authentication.
# Supports concurrent UGI instantiation - ctor does not access priv creds that require locking and mutate during relogin.
# A login context wrapper "remembers" the login configuration so the class statics for principal and keytab can be eliminated.
# Is keytab/ticket is based on the login config, not the current state of the priv creds.
#* prevents race during relogin where new instances might think the ugi is not a keytab when logout has occurred and relogin underway.
#* ugis created for keytab users after a relogin failure now remember they are keytab based.
# Creating ugi from a subject will learn the principal and possibly keytab
#* no more "external" ugi hack
#* subject based-ugis will relogin, ie. after ipc errors

Basic design is:
* HadoopLoginContext wraps a "real" LoginContext and remembers the javax-derived HadoopConfiguration which is normally not accessible.
* HadoopConfiguration is based on LoginParams which track parameters for login and relogin.
* LoginParams for pre-existing subjects are learned prior to login and reused for subsequent relogins.
* LoginParams for new subjects are updated post-login., | (/) *{color:green}+1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 20s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 3 new or modified test files. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 15m 29s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 18m 57s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 39s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  8s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 20s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 33s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 50s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 40s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 17m 35s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 17m 35s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 43s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 14 new + 118 unchanged - 25 fixed = 132 total (was 143) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 15s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 20s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 51s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 52s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  7m 38s{color} | {color:green} hadoop-common in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 36s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 73m  5s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:a9ad5d6 |
| JIRA Issue | HADOOP-9747 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12860691/HADOOP-9747.trunk.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux 01692bb8c8db 3.13.0-107-generic #154-Ubuntu SMP Tue Dec 20 09:57:27 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / db2adf3 |
| Default Java | 1.8.0_121 |
| findbugs | v3.0.0 |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/11940/artifact/patchprocess/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/11940/testReport/ |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/11940/console |
| Powered by | Apache Yetus 0.5.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Resolved minor context differences., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 20s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 2 new or modified test files. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m 28s{color} | {color:green} branch-2 passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  5m 33s{color} | {color:green} branch-2 passed with JDK v1.8.0_121 {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  6m 36s{color} | {color:green} branch-2 passed with JDK v1.7.0_121 {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 27s{color} | {color:green} branch-2 passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 59s{color} | {color:green} branch-2 passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 15s{color} | {color:green} branch-2 passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 39s{color} | {color:green} branch-2 passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 45s{color} | {color:green} branch-2 passed with JDK v1.8.0_121 {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 57s{color} | {color:green} branch-2 passed with JDK v1.7.0_121 {color} |
| {color:red}-1{color} | {color:red} mvninstall {color} | {color:red}  0m 22s{color} | {color:red} hadoop-common in the patch failed. {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  5m 31s{color} | {color:green} the patch passed with JDK v1.8.0_121 {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  5m 31s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} compile {color} | {color:red}  0m 40s{color} | {color:red} root in the patch failed with JDK v1.7.0_121. {color} |
| {color:red}-1{color} | {color:red} javac {color} | {color:red}  0m 40s{color} | {color:red} root in the patch failed with JDK v1.7.0_121. {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 26s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 14 new + 118 unchanged - 26 fixed = 132 total (was 144) {color} |
| {color:red}-1{color} | {color:red} mvnsite {color} | {color:red}  0m 26s{color} | {color:red} hadoop-common in the patch failed. {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 15s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:red}-1{color} | {color:red} findbugs {color} | {color:red}  0m 22s{color} | {color:red} hadoop-common in the patch failed. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 44s{color} | {color:green} the patch passed with JDK v1.8.0_121 {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 57s{color} | {color:green} the patch passed with JDK v1.7.0_121 {color} |
| {color:red}-1{color} | {color:red} unit {color} | {color:red}  0m 26s{color} | {color:red} hadoop-common in the patch failed with JDK v1.7.0_121. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 21s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 44m 29s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| JDK v1.8.0_121 Failed junit tests | hadoop.security.TestUserGroupInformation |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:b59b8b7 |
| JIRA Issue | HADOOP-9747 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12860870/HADOOP-9747.branch-2.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux 5fc0d17ce93f 3.13.0-106-generic #153-Ubuntu SMP Tue Dec 6 15:44:32 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | branch-2 / ef43a62 |
| Default Java | 1.7.0_121 |
| Multi-JDK versions |  /usr/lib/jvm/java-8-oracle:1.8.0_121 /usr/lib/jvm/java-7-openjdk-amd64:1.7.0_121 |
| findbugs | v3.0.0 |
| mvninstall | https://builds.apache.org/job/PreCommit-HADOOP-Build/11951/artifact/patchprocess/patch-mvninstall-hadoop-common-project_hadoop-common.txt |
| compile | https://builds.apache.org/job/PreCommit-HADOOP-Build/11951/artifact/patchprocess/patch-compile-root-jdk1.7.0_121.txt |
| javac | https://builds.apache.org/job/PreCommit-HADOOP-Build/11951/artifact/patchprocess/patch-compile-root-jdk1.7.0_121.txt |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/11951/artifact/patchprocess/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
| mvnsite | https://builds.apache.org/job/PreCommit-HADOOP-Build/11951/artifact/patchprocess/patch-mvnsite-hadoop-common-project_hadoop-common.txt |
| findbugs | https://builds.apache.org/job/PreCommit-HADOOP-Build/11951/artifact/patchprocess/patch-findbugs-hadoop-common-project_hadoop-common.txt |
| unit | https://builds.apache.org/job/PreCommit-HADOOP-Build/11951/artifact/patchprocess/patch-unit-hadoop-common-project_hadoop-common-jdk1.7.0_121.txt |
| JDK v1.7.0_121  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/11951/testReport/ |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/11951/console |
| Powered by | Apache Yetus 0.5.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Branch-2 failures due to 8 allowing association of a principal with a keytab, unlike 7.  In practice the subject contains a KerberosPrincipal and Keytab.  I  opted to extract the keytab's principal as fallback if a KerberosPrincipal is not present.  It's a "nice to have" but I'll just remove it.  It shouldn't impede a review (hint, hint, watchers) because I'll just be deleting a handful of lines., Got rid of the new support for KeyTab.getInstance(principal, file).  Deleted relevant tests., | (/) *{color:green}+1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 25s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 3 new or modified test files. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 12m  7s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 16m  3s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 31s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 59s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 14s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 15s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 47s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 34s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 12m 51s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 12m 51s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 37s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 9 new + 118 unchanged - 25 fixed = 127 total (was 143) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  0s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 21s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 30s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 48s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  6m 57s{color} | {color:green} hadoop-common in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 31s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 59m 30s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:a9ad5d6 |
| JIRA Issue | HADOOP-9747 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12861100/HADOOP-9747.2.trunk.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux cdcaf380506f 4.4.0-43-generic #63-Ubuntu SMP Wed Oct 12 13:48:03 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 4966a6e |
| Default Java | 1.8.0_121 |
| findbugs | v3.0.0 |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/11992/artifact/patchprocess/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/11992/testReport/ |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/11992/console |
| Powered by | Apache Yetus 0.5.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, [~owen.omalley], do you have any cycles?, | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 16s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 3 new or modified test files. {color} |
|| || || || {color:brown} trunk Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 13m 19s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 13m 40s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 37s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 27s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 22s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 50s{color} | {color:green} trunk passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 38s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 10m 17s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 10m 17s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 37s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 9 new + 117 unchanged - 25 fixed = 126 total (was 142) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 28s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 35s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 50s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:red}-1{color} | {color:red} unit {color} | {color:red}  8m 19s{color} | {color:red} hadoop-common in the patch failed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 28s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 57m 34s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| Failed junit tests | hadoop.security.TestKDiag |
|   | hadoop.security.token.delegation.TestZKDelegationTokenSecretManager |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:14b5c93 |
| JIRA Issue | HADOOP-9747 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12861100/HADOOP-9747.2.trunk.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux 005ffdae540d 3.13.0-117-generic #164-Ubuntu SMP Fri Apr 7 11:05:26 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 0fd6d0f |
| Default Java | 1.8.0_131 |
| findbugs | v3.1.0-RC1 |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/12899/artifact/patchprocess/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
| unit | https://builds.apache.org/job/PreCommit-HADOOP-Build/12899/artifact/patchprocess/patch-unit-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/12899/testReport/ |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/12899/console |
| Powered by | Apache Yetus 0.6.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, 2.8.2 is not supposed to have big and risky feature/improvements. [~daryn], I will move this to 2.9.0 if you are ok with., I'd rather it not be moved out.  It's not exactly a "big and risky feature/improvement".  It does offer improvements via eliminating synchronization (all calls to getCurrentUser, getLoginUser, and relogins are class synchronized), but incidentally fixes some esoteric skeleton-in-the-closet potential privilege escalation.  Which is more risky?  Faster and correct?  Slower and vulnerable?

The basic premise is that all calls to getCurrentUser, getLoginUser, and relogin do not need to be class synchronized.  A few marketing points since my prior bullets were design oriented.
# A UGI identity is truly immutable after inception as was originally intended. Ie. What was the principal?  From keytab or ticket cache?
# Removes instance-level synchronization since it's generally worthless (multiple UGIs share the same Subject)
# Removes class-level synchronization by moving class static principal/keytab into the Subject
# Add synchronization only where necessary to fix races with relogins corrupting the Subject
# Incidentally fixes root cause of issue that inspired the completely broken "external ugi" hack
# Multiple logged in UGIs actually work correctly due to elimination of class statics.
# Incidentally prevents relogin of 1 UGI causing another UGI to morph (see linked jira)

It's really not that bad.  About 50% of the patch is adding lots of great tests since UGI tests are sparse.  I've been waiting 4 years to integrate this patch.  I gave up and added workarounds in the IPC layer and NN.  But then along came EZ file EDEK fetching causing high UGI contention..., [~daryn], I can understand your passion in fixing this long term existing issue so I am OK to get this in 2.8.2 if the patch get well tested in production environment before we cut RC (target before end of Aug.). Do you have specific test plan or this is already get tested in Yahoo! production cluster?, [~djp] [~daryn] I've tested this patch against an HDP 2.6 cluster using the code I've linked on HADOOP-14699, and the results are promising.  I'll be doing some more testing today to verify that the patch also resolves an issue with a single UGI that gets into a hung state where the principal has been "forgotten" and falls back to the login user, for which no ticket has been (or can be, in the tested configuration) be acquired., bq.  Do you have specific test plan or this is already get tested in Yahoo! production cluster?

We've waiting on community so we don't integrate something that causes massive conflicts going forward.  I'll push to deploy internally if it's what it will take to move forward., [~daryn] Can you confirm that the two patches, HADOOP-9747.2.branch-2.patch and HADOOP-9747.2.trunk.patch (for their respective branches) are all that is needed to resolve the two open subtasks in this JIRA?

I've done my own testing for two principals being logged in and that they are able to relogin simultaneously using a single classloader, and this fixes a core issue that NiFi has been trying to work around for quite a while.  I have a suspicion that this might help us out with another issue regarding TDE where the hadoop client is not able to authenticate with a KMS (no TGT found) after successfully logging in with the KDC from a keytab.  The client seems to be "forgetting" that a principal was logged in from a keytab and ends up falling back to the OS user., [~daryn], the following tests are failing with this patch and succeeding without it on trunk:

{noformat}
TestTokenClientRMService#testTokenRenewalByLoginUser
testTokenRenewalByLoginUser(org.apache.hadoop.yarn.server.resourcemanager.TestTokenClientRMService)  Time elapsed: 0.043 sec  <<< ERROR!
java.lang.reflect.UndeclaredThrowableException: null
    at org.apache.hadoop.yarn.server.resourcemanager.ClientRMService.renewDelegationToken(ClientRMService.java:1058)
    at org.apache.hadoop.yarn.server.resourcemanager.TestTokenClientRMService.checkTokenRenewal(TestTokenClientRMService.java:169)
    at org.apache.hadoop.yarn.server.resourcemanager.TestTokenClientRMService.access$500(TestTokenClientRMService.java:46)

TestRMDelegationTokens#testRMDTMasterKeyStateOnRollingMasterKey
testRMDTMasterKeyStateOnRollingMasterKey(org.apache.hadoop.yarn.server.resourcemanager.security.TestRMDelegationTokens)  Time elapsed: 0.792 sec  <<< ERROR!
org.apache.hadoop.yarn.exceptions.YarnException: java.io.IOException: Delegation Token can be issued only with kerberos authentication
    at org.apache.hadoop.yarn.server.resourcemanager.ClientRMService.getDelegationToken(ClientRMService.java:1022)
    at org.apache.hadoop.yarn.server.resourcemanager.security.TestRMDelegationTokens.testRMDTMasterKeyStateOnRollingMasterKey(TestRMDelegationTokens.java:102)
{noformat}, [~jtstorck], yes this patch supersedes the subtasks.  I'll look at the yarn failures.  Highly suspect tests are flawed.  Will update soon., When security is enabled, new ugi instances defaulted to unconditionally claiming to be kerberos authenticated - unless explicitly defined at creation, or redefined by something like the ipc server.  Now a ugi defaults to kerberos only if it's kerberos.

The yarn tests inadvertently relied on the bad behavior.  They failed because token ops must be kerberos authenticated.  The yarn tests aren't really using kerberos, so they bypassed the ipc layer (which would have set the auth to kerberos) and called straight into the token methods.  Formerly the dummy ugis were implicitly kerberos, so the tests passed.  Now the ugis are simple because that's what they really are, hence the tests failed.  All it takes is explicitly setting the auth type to kerberos and they pass.  Will file a couple line yarn jira., Had an incident today with a RM going dead-in-the-water that this patch would have allowed to self-heal.  A re-login was triggered, and it failed.  Now the UGI was left with no private credentials.  New calls to getCurrentUser() found neither a keytab nor ticket instance, so any call to relogin was a no-op.  This patch "remembers" the ugi was logged in from a keytab so re-logins would have been attempted.

Regarding earlier concerns, we've been running with the locking on subject's private credentials since early Feb 2017 after experiencing DN lockups.  We just aren't running the code to remember the login conf., [~daryn], Thanks for providing the fixes for the YARN tests.

+1. The patch LGTM. If there are no concerns, I will commit tomorrow afternoon., [~daryn], I started to commit this, but I ran into a couple of issues:

# If this fix needs to go into branch-2.8, we may need a separate 2.8 patch. I tried applying the branch-2 patch to branch-2.8, and there were several conflicts in {{UserGroupInformation.java}}
# {{HADOOP-9747.2.branch-2.patch}} does not apply cleanly to branch-2. It's just a minor import conflict that I could fix myself, but as long as you need to address the branch-2.8 conflicts..., I'm actively working on this.  I backported to 2.8, which wasn't too hard, mostly that exception types changed.

I did find one small gotcha when logging in directly from a subject.  If there's a keytab, it works fine, because the login module gets a TGT.  If the subject contains just a TGT, ex. storm auto-tgt, it fails to login.  Taking care of that use case., bq. I did find one small gotcha when logging in directly from a subject. If there's a keytab, it works fine, because the login module gets a TGT. If the subject contains just a TGT, ex. storm auto-tgt, it fails to login.
Is this a potential regression? If so, may be we should fix this issue or defer to 2.9? CC [~owen.omalley], [~jlowe]., I haven't received any confirmation on side-effort of this fix belongs to a regression or not. We clean up all blockers/critical issues for 2.8.2 so far except this one. I don't think we should wait for this one to block whole release.
I think a safe way here is to move target version to 2.8.3. [~eepayne], if you are comfortable to commit the patch, please land it to branch-2.8 for next 2.8 release train so we got more time for verification/discussions on side effort of this patch., bq.  think a safe way here is to move target version to 2.8.3
We discussed yesterday to move it to 2.8.3. So thank you !, | (/) *{color:green}+1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 19s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 3 new or modified test files. {color} |
|| || || || {color:brown} trunk Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 14m 18s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 16m 25s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 48s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 25s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 12m 36s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 52s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m  8s{color} | {color:green} trunk passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 54s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 15m 58s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 15m 58s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 52s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 9 new + 117 unchanged - 25 fixed = 126 total (was 142) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 20s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m 10s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m  3s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m  3s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:green}+1{color} | {color:green} unit {color} | {color:green} 10m 12s{color} | {color:green} hadoop-common in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 38s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 92m 10s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:71bbb86 |
| JIRA Issue | HADOOP-9747 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12861100/HADOOP-9747.2.trunk.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |
| uname | Linux 0e7354329303 3.13.0-119-generic #166-Ubuntu SMP Wed May 3 12:18:55 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / b34b3ff |
| Default Java | 1.8.0_144 |
| findbugs | v3.1.0-RC1 |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/13450/artifact/patchprocess/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/13450/testReport/ |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/13450/console |
| Powered by | Apache Yetus 0.6.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Hi [~daryn]
Thank You for providing patch.
One comment from me, this patch removed the flag HADOOP_TREAT_SUBJECT_EXTERNAL_KEY.
So, this configuration also need to be removed from the CommonConfigurations.java and also from core-default.xml

And also could you rebase your patch, as this is not cleanly applying to trunk., Hi [~daryn]
Ping again.

Could you please let me know if you are busy with other work, I can get the comments fixed and update on to of your patch.

As we need this code change to fix issue HADOOP-14699, Proceeded with code changes on top of [~daryn] patch.
[~daryn]
Uploaded a new patch v01 to address review comments.


, | (/) *{color:green}+1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 10s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 3 new or modified test files. {color} |
|| || || || {color:brown} trunk Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 16m 54s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 14m 19s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 38s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m 11s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 11m 41s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 35s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 58s{color} | {color:green} trunk passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 49s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 12m 33s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 12m 33s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 39s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 14 new + 191 unchanged - 25 fixed = 205 total (was 216) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  0s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} xml {color} | {color:green}  0m  2s{color} | {color:green} The patch has no ill-formed XML file. {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green}  9m 57s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 33s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 54s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  8m 32s{color} | {color:green} hadoop-common in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 32s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 83m 32s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:5b98639 |
| JIRA Issue | HADOOP-9747 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12898768/HADOOP-9747-trunk.01.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  xml  |
| uname | Linux d91c609ee750 3.13.0-135-generic #184-Ubuntu SMP Wed Oct 18 11:55:51 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 03c311e |
| maven | version: Apache Maven 3.3.9 |
| Default Java | 1.8.0_151 |
| findbugs | v3.1.0-RC1 |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/13734/artifact/out/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/13734/testReport/ |
| Max. process+thread count | 1399 (vs. ulimit of 5000) |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/13734/console |
| Powered by | Apache Yetus 0.7.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, I need to refresh my memory on why I thought this would break ranger's bizarre use of the ugi., Hi [~daryn]
Thanks for a great patch, this really simplifies UGI code. I have a few comments.
1. System.setProperty(KRB5CCNAME) is not being set, previously this is being set in the case of IBM_JAVA

2. getLoginUser is no longer Synchronized. If multiple threads call this in parallel, multiple loginUser ugi’s will be created and they could potentially spin up a new thread in spawnAutoRenewalThreadForUserCreds. I would suggest to synchronize it for the case when loginUser is null.

3. In loginUserFromSubject method, when subject passed is null the same situation will occur, it could spin multiple threads for renewal. Probably, we don’t need to support null subject in this API, because null subject use case is already handled by getLoginUser.

4. As you have noted in the comments that getKeyTabEntry is not very reliable for external subjects. I was wondering whether we really need it. Can we get away by saying that it’s user’s responsibility to renew external subjects?

5. Following 3 methods perform login and update the static loginUser. It might make sense to add documentation that these update the global loginUser.
getLoginUser, loginUserFromSubject and loginUserFromKeytab
 
*Minor Nits*
·         getSubjectLoginLock, does not actually getLock, can we change this method name getSubectPrivateCredentials.
·         In hasKerberosCredential, it might make sense to return false for null user, otherwise we will get an NPE.
·         Can we add assert hasSubjectLoginLock() in getTgt()?
·         In unprotectedLoginUserFromSubject we should change the local variable name instead of overloading loginUser, only for better readability.
 
Thank You [~xyao] [~jnp] for cumulative review on the patch., [~daryn]
Ping again.
If you are busy with other task, I can provide a patch for the review comments., Working on this today.  A few quick points:

bq. System.setProperty(KRB5CCNAME) is not being set, previously this is being set in the case of IBM_JAVA
Intentional.  If a specific ticket cache is defined, it must be used.  It's wrong set a property for one of the locations to look and then specify default cache which means it might find a ticket cache _somewhere other than specifically defined_.  Not to mention a system property has the same thread-safety issues as the statics I removed.

bq. getLoginUser is no longer Synchronized. 
That's definitely the intent.  I think it's fine, will re-verify correctness.

bq. Can we get away by saying that it’s user’s responsibility to renew external subjects?
That external subject behavior is/was completely broken and just an attempt to workaround a subject containing a keytab that wasn't in sync with the (now removed) class static.  I think I'm going to no-op relogin from keytab anyway since java caches and re-reads keytab contents as necessary.  We've dropped new keytabs with updated kvnos and java picked them up but I'll reverify.

bq. In unprotectedLoginUserFromSubject we should change the local variable name instead of overloading loginUser, only for better readability.

Sure.  Was only trying to minimize patch size., Trying to get this patch up but found out ranger is doing some amazing dubious things to/with the ugi.  I can't believe it actually works w/o identity race conditions., [~daryn]
Thanks for comments.
Intentional. If a specific ticket cache is defined, it must be used. It's wrong set a property for one of the locations to look and then specify default cache which means it might find a ticket cache somewhere other than specifically defined. Not to mention a system property has the same thread-safety issues as the statics I removed.

Got it, if Krb5CCName is set, now using useCCache and using that location, 


{code:java}
 put(LoginParam.TICKET_CACHE, System.getenv("KRB5CCNAME")); // 1801
if (ticketCache != null) { //1970
            options.put("useCcache", prependFileAuthority(ticketCache));
          }
{code}


if  Krb5CCName is not set or ticketCache is null,  then set useDefaultCcache to true and use it.

{code:java}
final String ticketCache = params.get(LoginParam.TICKET_CACHE); //1952
          if (ticketCache != null) {
            options.put("useCcache", prependFileAuthority(ticketCache));
          } else {
            options.put("useDefaultCcache", "true");
          }
        }
{code}

  
So, in this way this issue has been addressed in this patch?

, [~daryn]

One more thing I found is
we need to remove testCheckTGTAfterLoginFromSubject from branch-2 patch also, this has been addressed in trunk patch.
Because in latest patch we have only simple and kerberos configurations.
where as previously we used to have simple, user-kerberos(when login from subject) and keytab-kerberos. user-kerberos app config used to have os_specific_login and krb5login configurations, so if no kerberosprincipal is found it used to use os_specific_login user and loginUserFromSubject() used to pass, but now this will not work, as it will say User cannot be null, as the subject will be empty (as there is no user of type KerberosPrincipal).


I am providing multiple comments, as more i am understanding the code, getting more questions, hope you don't mind.

Please let me know if my analysis looks correct or am i missing something here.
, [~daryn]
Ping again, if you are busy with other tasks, I can provide patch to address review comments., Sorry, I've been out on vacation since before xmas and will be catching up this week.  This is my #1 code priority.  Per previous comments, ranger is (ab)using the ugi in interesting ways so I've had to change and undo some of what I did to ensure "compatibility"., Thank You [~daryn] for update.
 Per previous comments, ranger is (ab)using the ugi in interesting ways so I've had to change and undo some of what I did to ensure "compatibility".
{quote} You are mentioning about the usage of getting keytab from subject from external subject, when we do loginFromSubject(subject){quote}

, {quote}1. System.setProperty(KRB5CCNAME) is not being set, previously this is being set in the case of IBM_JAVA{quote}

Not required. See above comments for justification.

{quote}
2. getLoginUser is no longer Synchronized. If multiple threads call this in parallel, multiple loginUser ugi’s will be created and they could potentially spin up a new thread in spawnAutoRenewalThreadForUserCreds. I would suggest to synchronize it for the case when loginUser is null.{quote}

Done

{quote}3. In loginUserFromSubject method, when subject passed is null the same situation will occur, it could spin multiple threads for renewal. Probably, we don’t need to support null subject in this API, because null subject use case is already handled by getLoginUser.{quote}

Done

{quote}4. As you have noted in the comments that getKeyTabEntry is not very reliable for external subjects. I was wondering whether we really need it. Can we get away by saying that it’s user’s responsibility to renew external subjects?{quote}

Not addressed this, Left as it is. If keytab is there it will re-login, otherwise it will be a no-op. As this change it will not break anything, left as it is.

{quote}5. Following 3 methods perform login and update the static loginUser. It might make sense to add documentation that these update the global loginUser.
getLoginUser, loginUserFromSubject and loginUserFromKeytab{quote}

Done

Minor Nits
{quote}· getSubjectLoginLock, does not actually getLock, can we change this method name getSubectPrivateCredentials.
· In hasKerberosCredential, it might make sense to return false for null user, otherwise we will get an NPE.
· Can we add assert hasSubjectLoginLock() in getTgt()?
· In unprotectedLoginUserFromSubject we should change the local variable name instead of overloading loginUser, only for better readability.{quote}
Addressed all the above minot Nits.
, Uploaded patch v02 to address the review comments. 
Thank You [~daryn] for intial patch. I think, you are busy with other tasks, so I took a crack at addressing some of the review comments to help make forward progress on this jira.


Could you please review these changes.




, | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 18s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 3 new or modified test files. {color} |
|| || || || {color:brown} trunk Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 16m 30s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 13m 26s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 40s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  5s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 11m 49s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 27s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 54s{color} | {color:green} trunk passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 45s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 11m 45s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 11m 45s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 39s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 16 new + 189 unchanged - 27 fixed = 205 total (was 216) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  1s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} xml {color} | {color:green}  0m  1s{color} | {color:green} The patch has no ill-formed XML file. {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m  4s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 34s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 53s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:red}-1{color} | {color:red} unit {color} | {color:red}  8m 30s{color} | {color:red} hadoop-common in the patch failed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 32s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 81m 39s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| Failed junit tests | hadoop.ha.TestZKFailoverController |
\\
\\
|| Subsystem || Report/Notes ||
| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:5b98639 |
| JIRA Issue | HADOOP-9747 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12905187/HADOOP-9747-trunk.02.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  xml  |
| uname | Linux c4e4cbbd4e84 3.13.0-135-generic #184-Ubuntu SMP Wed Oct 18 11:55:51 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 59ab5da |
| maven | version: Apache Maven 3.3.9 |
| Default Java | 1.8.0_151 |
| findbugs | v3.1.0-RC1 |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/13935/artifact/out/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
| unit | https://builds.apache.org/job/PreCommit-HADOOP-Build/13935/artifact/out/patch-unit-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/13935/testReport/ |
| Max. process+thread count | 1717 (vs. ulimit of 5000) |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/13935/console |
| Powered by | Apache Yetus 0.7.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, I understand this patch is critical to you but please stop hijacking.  I'm working on this today and should have a patch by EOD., [~daryn] Thank you for the update.
My intention is just to make progress on this jira, as I have not heard back from you.
I will wait for your patch., As an update, extremely close, really planned to have a final patch much earlier.  I've stripped out all the "intelligence" that analyzed the ugi because it's actually quasi-broken in the sense that it causes kerberos instances to double up in the creds, and as mentioned before, didn't play nice with ranger's (ab)use of the ugi. Thought that would be simple but ran into issues with the "external ugi" hackery.  Found graceful way to manage them.  Updating/writing more tests.

The last thing I'm doing is solving the getLoginUser race.  I thought the unlikely race was "ok", but the dubious means of spawning renewals can be a problem.  We can't go back to a purely synchronized design because the NN's rpc handlers pile up getting the login user to fetch an EDEK which is the primary motivation for me atm., Will post a branch-2 patch if this version is deemed acceptable.  As mentioned before, all "intelligent" studying of the subject is gone.  It just tracks explicitly principal, keytab, ticket cache used during login.  Ensures those parameters are used during relogin.  Removes all the synchronization.  Ignores "external" subjects that lack a User principal not created by the UGI., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 18s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 3 new or modified test files. {color} |
|| || || || {color:brown} trunk Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 15m 24s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 12m 34s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 42s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  5s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m 15s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 20s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 46s{color} | {color:green} trunk passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 38s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 12m 41s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 12m 41s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 31s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 32 new + 189 unchanged - 27 fixed = 221 total (was 216) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 54s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} xml {color} | {color:green}  0m  1s{color} | {color:green} The patch has no ill-formed XML file. {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green}  8m 37s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 31s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 49s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:red}-1{color} | {color:red} unit {color} | {color:red}  8m 21s{color} | {color:red} hadoop-common in the patch failed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 28s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 76m 24s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| Failed junit tests | hadoop.security.token.delegation.TestDelegationToken |
\\
\\
|| Subsystem || Report/Notes ||
| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:5b98639 |
| JIRA Issue | HADOOP-9747 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12906860/HADOOP-9747-trunk-03.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  xml  |
| uname | Linux f1ad3947b167 4.4.0-64-generic #85-Ubuntu SMP Mon Feb 20 11:50:30 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 130f8bc |
| maven | version: Apache Maven 3.3.9 |
| Default Java | 1.8.0_151 |
| findbugs | v3.1.0-RC1 |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/14008/artifact/out/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
| unit | https://builds.apache.org/job/PreCommit-HADOOP-Build/14008/artifact/out/patch-unit-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/14008/testReport/ |
| Max. process+thread count | 1444 (vs. ulimit of 5000) |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/14008/console |
| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Hi [~daryn]

Thank You for the patch.

I am going through the patch, have some questions when I am trying to understand the code and also have some review comments.
 * In hasKerberosCredential methods, add user!=null check, as it might throw NPE, when user=null. So, the AppConfigEntry will have loginModule as OS_LOGIN_MODULE,
 * In case of loginuserfromSubject, as we pass params as null to doSubjectLogin, the configuration will be OS_SPECIFIC_LOGIN. So, in this case login fallbacks to Simple Auth login? Is this the expected behavior.

{code:java}
ArrayList<AppConfigurationEntry> entries = new ArrayList<>();
// login of external subject passes no params.  technically only
// existing credentials should be used but other components expect
// the login to succeed with local user fallback if no principal.
if (params == null || appName.equals(SIMPLE_CONFIG_NAME)) {
  entries.add(OS_SPECIFIC_LOGIN);
} {code}

 * renewTGT and refreshKrb5Config is not set in IBM_JAVA case, is there any reason for this?
 * @Test annotation is missing for tests in TestUGILoginFromKeytab.java
 * Following 3 methods perform login and update the static loginUser. It might make sense to add documentation that these update the global loginUser.
 getLoginUser, loginUserFromSubject and loginUserFromKeytab

I am still going through patch, and still reviewing test cases. Will update if I have more comments., Thanks Bharat!
 # Null user checks are unnecessary since they are impossible.  The UGI ctor will not allow a null user.
 # Regarding loginUserfromSubject semantics, yes, it falls back to OS_SPECIFIC_LOGIN.  As noted in comments, it preserves current behavior although I disagree with it.  There's even an existing kerberos test that breaks unless it falls back to the local user.  Seems better to err on side of caution at least for initial commit.
 # Options no longer set for IBM_JAVA were removed because they aren't valid options, but I can put them back...
 # I'll add the missing test annotations. 
 # I'll see what I can do to enhance the documentation for login users, but note that I didn't change the behavior so it'll just be an enhancement., Hi [~daryn]

Thanks for reply.

 
 # In getLoginUser(), there can be a still race condition, as setLoginUser() can be called from loginUserFromSubject/loginUserFromKeytab, which might change *_loginUserRef._*

Can we update the getLoginUser() as below, this will only penalize during initial creation of loginUserRef Object.
{code:java}
UserGroupInformation loginUser = logiUserRef;
if (loginUser == null) {
 synchronized(UserGroupInformation.class) {
 if (loginUser == null) {
 loginUser = createLoginUser(null);
 loginUserRef = loginUser;
 }
 }
}
return loginUser;{code}
 

 

   2. So, for this setLoginUser should be synchronized.

I think this might improvise the code, and also handle race condition. Could you please let me know your thoughts?, Thanks [~bharatviswa], [~daryn] for working on the issue,

Are you still actively working on the issue? If this cannot finish by Feb 18, can we move this to 3.2.0?, I'm back on it today., A synchronize somehow crept back into loginUserFromKeytab.  Removed it.

I put back the previous invalid options for IBM_JAVA because it doesn't hurt anything and is arguably the least risk.

Added missing @Test annotations.

Updated javadoc for getLoginUser to be a bit more informative about what it does (actually has always done).

Don't understand the concern over a race between getLoginUser and other login methods  (which does exist and is handled) is helped by synchronization.  Sure synchronize guards against 2 racing getLoginUser calls but not concurrent calls to the other login methods.  Whereas the CAS logic ensures that if any login call beats us to setting the default login user, that winner will be returned instead.  I unwound the code a bit (logic is identical) with better comments to better convey what's happening., | (/) *{color:green}+1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 18s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 3 new or modified test files. {color} |
|| || || || {color:brown} trunk Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 16m 45s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 13m 41s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 40s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  6s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 12m  4s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 28s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 56s{color} | {color:green} trunk passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 44s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 12m 26s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 12m 26s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 39s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 32 new + 189 unchanged - 27 fixed = 221 total (was 216) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  4s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} xml {color} | {color:green}  0m  1s{color} | {color:green} The patch has no ill-formed XML file. {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m  9s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 38s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 56s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  8m 44s{color} | {color:green} hadoop-common in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 34s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 83m 38s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:5b98639 |
| JIRA Issue | HADOOP-9747 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12910955/HADOOP-9747-trunk-04.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  xml  |
| uname | Linux ce8a8dd47a28 3.13.0-135-generic #184-Ubuntu SMP Wed Oct 18 11:55:51 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 4c2119f |
| maven | version: Apache Maven 3.3.9 |
| Default Java | 1.8.0_151 |
| findbugs | v3.1.0-RC1 |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/14158/artifact/out/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/14158/testReport/ |
| Max. process+thread count | 1647 (vs. ulimit of 5500) |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/14158/console |
| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Thanks [~daryn] for updating the patch, if there's any committer plan to help with the patch review? I'd like to help but I'm not sure about this part of code. , [~bharatviswa], can you take a look at the latest patch? Does it address your comments and concerns?
I will also go over the patch., It looks good as far as I can tell. I will be better if another person can have a look at this as it is a critical core component., [~kihwal]

I will go through the latest patch today., Hi [~daryn]

Thanks for the updated patch.

I am +1 on the latest patch V04.

 Regarding my earlier synchronization question, you can ignore it, it has been addressed by the patch and the comments are clear to understand.

I have one question in general, this is an already existing issue, if multiple threads try to call getLoginUser() (And system properties

KRB5CCNAME is set), so each thread tries to spawn Auto renewal thread here. So, is it required for renew for each thread?, Regarding auto-renewal, I specifically made getLoginUser only auto-renew if it's the first to set the login user.  Ie. If another concurrent login (extremely unlikely in practice, but possible) races with the other and loses the race, it doesn't spawn a renewal thread.  That's why it is guarded by a CAS., Thanks for the review [~bharatviswa]. With my official +1, I will commit it shortly., Thanks for the info [~daryn]. 

Yup, it will not create multiple threads., I've committed this to trunk, branch-3.1 and branch-3.0.  Please provide a branch-2 version., SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #13707 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/13707/])
HADOOP-9747. Reduce unnecessary UGI synchronization. Contributed by (kihwal: rev 59cf7588779145ad5850ad63426743dfe03d8347)
* (edit) hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUserGroupInformation.java
* (edit) hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/CommonConfigurationKeys.java
* (edit) hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/UserGroupInformation.java
* (edit) hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGIWithMiniKdc.java
* (edit) hadoop-common-project/hadoop-common/src/main/resources/core-default.xml
* (edit) hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/security/TestUGILoginFromKeytab.java
, | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m  0s{color} | {color:blue} Docker mode activated. {color} |
| {color:red}-1{color} | {color:red} patch {color} | {color:red}  0m  6s{color} | {color:red} HADOOP-9747 does not apply to trunk. Rebase required? Wrong Branch? See https://wiki.apache.org/hadoop/HowToContribute for help. {color} |
\\
\\
|| Subsystem || Report/Notes ||
| JIRA Issue | HADOOP-9747 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12910955/HADOOP-9747-trunk-04.patch |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/14793/console |
| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, I'm going to resolve this JIRA since it's been dangling for a while, please reopen for the branch-2 backport if/when a patch emerges.]