[A lot of this has been redone. Closing as stale.]