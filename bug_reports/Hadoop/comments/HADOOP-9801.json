[Thanks to [~daijy] for finding and reporting this bug via Hive testing on Windows, where the default encoding is CP-1252., I'm attaching a patch to set UTF-8 explicitly.  I've also added a unit test that round-trips saving and loading of multi-byte characters in property names and values.  If the config code change is not present, then the new test fails if run on a platform that has a default encoding that can't handle multi-byte characters (like Windows with CP-1252)., The branch-1 patch works for branch-1-win too., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12595292/HADOOP-9801-trunk.1.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2899//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2899//console

This message is automatically generated., +1 

Change looks good to me! Thanks, Chris!, The patch looks good. 
For the unit test(testMultiByteCharacters) to test the issue even when running on Linux, we may want to set the default character to non-utf8 in the test., bq. For the unit test(testMultiByteCharacters) to test the issue even when running on Linux, we may want to set the default character to non-utf8 in the test.

Thanks, Brandon!  This would be a good idea, but unfortunately, the documentation I've read indicates that the default character set gets read at JVM launch time and cached within relevant JDK classes that make use of a character set.  You can change it by passing JVM arguments at process launch time, but I don't see a way to change it programmatically within a running JVM.

Do you have any other ideas on how to do this?  If not, then I think we'll have to go with the patch as is., This seems to work for me: System.setProperty("file.encoding","Cp1252");, bq. This seems to work for me: System.setProperty("file.encoding","Cp1252");

That's interesting.  Everything I read said that this wouldn't work.  Maybe I was reading out-of-date docs.  Thanks for trying this out.

Here are new patches to set default encoding in the test, and then restore it to the prior default at the end of the tests.  I used US-ASCII for the test instead of CP-1252, because US-ASCII is required to be present in any spec-compliant JVM.

How does this look?
, +1. The patches look good., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12595470/HADOOP-9801-trunk.2.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2904//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2904//console

This message is automatically generated., SUCCESS: Integrated in Hadoop-trunk-Commit #4201 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/4201/])
HADOOP-9801. Configuration#writeXml uses platform defaulting encoding, which may mishandle multi-byte characters. Contributed by Chris Nauroth. (cnauroth: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1509405)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/conf/TestConfiguration.java
, Thanks for the reviews, Chuan and Brandon.  I've committed this to trunk, branch-2, branch-2.1-beta, branch-1, and branch-1-win., SUCCESS: Integrated in Hadoop-Yarn-trunk #289 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/289/])
HADOOP-9801. Configuration#writeXml uses platform defaulting encoding, which may mishandle multi-byte characters. Contributed by Chris Nauroth. (cnauroth: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1509405)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/conf/TestConfiguration.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1479 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1479/])
HADOOP-9801. Configuration#writeXml uses platform defaulting encoding, which may mishandle multi-byte characters. Contributed by Chris Nauroth. (cnauroth: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1509405)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/conf/TestConfiguration.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1506 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1506/])
HADOOP-9801. Configuration#writeXml uses platform defaulting encoding, which may mishandle multi-byte characters. Contributed by Chris Nauroth. (cnauroth: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1509405)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/conf/TestConfiguration.java
]