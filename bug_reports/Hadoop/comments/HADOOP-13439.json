[Hi [~iwasakims],

Any updates on this issue? As I found this JIRA and HADOOP-12588 interesting, do you remind I assign this to myself and work on this?, [~vagarychen], I assigned this to you. Thanks for your help., Hi [~iwasakims],

Thanks for assigning this to me. One question though, I was not able to reproduce this error in my environment, the test report of failed tests in HADOOP-13323 seems no longer accessible. I will leave a comment there. But do you mind elaborate a little bit more on the error and your thoughts there? Thanks., [~vagarychen] I hit a similar error, this is a link for your reference:
https://issues.apache.org/jira/browse/HADOOP-13441?focusedCommentId=15401700&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15401700
, Hi [~yuanbo],

Hmm...this does seem to be the same issue at the first glance, but I will dig into it a bit more. Thanks for the information!, bq. But do you mind elaborate a little bit more on the error and your thoughts there? Thanks.

Both TestGangliaMetrics and TestMetricsSystemImpl write configuration file to set up metrics system in the unit tests.

{noformat}
    ConfigBuilder cb = new ConfigBuilder().add("*.period", 120)
	.add("test.sink.gsink30.context", "test") // filter out only "test"
	.add("test.sink.gsink31.context", "test") // filter out only "test"
	.save(TestMetricsConfig.getTestFilename("hadoop-metrics2-test"));
{noformat}

{noformat}
    new ConfigBuilder().add("*.period", 8)
        //.add("test.sink.plugin.urls", getPluginUrlsAsString())
        .add("test.sink.test.class", TestSink.class.getName())
        .add("test.*.source.filter.exclude", "s0")
        .add("test.source.s1.metric.filter.exclude", "X*")
        .add("test.sink.sink1.metric.filter.exclude", "Y*")
        .add("test.sink.sink2.metric.filter.exclude", "Y*")
        .save(TestMetricsConfig.getTestFilename("hadoop-metrics2-test"));
{noformat}

They seem to race and read the configuration file created by another test when you run tests in parallel (e.g. by {{mvn test -Dtest=TestGangliaMetrics,TestMetricsSystemImpl -Pparallel-tests}}). I thought maven configuration in the parallel-tests profile takes care of test data dirs but we may need additional fix., Thanks for such detailed feedbacks [~iwasakims], it helped a lot!

Given what you mentioned here, I did some more investigation, and I think I verified that it is possible for one test to read config created by another. 

The two classes both have this line:
 {code}.save(TestMetricsConfig.getTestFilename("hadoop-metrics2-test"));{code}
Which writes the config to the exactly same file "hadoop-metrics2-test.properties" first. Then both classes have the call:
{code}ms.start();{code}
Which reads the file. So there can be race condition from the write to the read. This error can be reproduced by adding delay between .save() and ms.start() call, and run the tests at the same time.

Another problem with this race condition is the missing metric error of checkMetrics() as mentioned in HADOOP-12588. For example, one class might have the following in its config
{code}.add("test.source.s1.metric.filter.exclude", "X*"){code}
which configures to remove Xxx from the metric sources. If the other class is expecting this metric, we would end up getting this error:
{code}java.lang.AssertionError: Missing metrics: test.s1rec.Xxx{code}
One solution I'm thinking of is to separate the config file they are writing to by introducing a unique prefix for each test case, such that each test uses a different config file, similar to RollingFileSystemSinkTestBase#initMetricsSystem. The pros is that we are still able to run test cases in parallel without race condition, and the cons is that there might be a couple tens more .properties generated. What do you think about this approach? Or do you have any other suggestions?, Since it seems TestGangliaMetrics is the test cases that has been causing trouble mostly, this patch changes it's config file to another one to avoid sharing same config with other test cases. Please leave a comment if you think it is necessary to do this for all potentially competing test cases., Thanks for the patch, [~vagarychen]. +1, pending jenkins. I saw no failure in 100 runs of {{mvn test -Dtest=TestGangliaMetrics,TestMetricsSystemImpl -Pparallel-tests}} on my local.

bq. Please leave a comment if you think it is necessary to do this for all potentially competing test cases.

I think writing config file specific for TestGangliaMetrics is enough here., | (/) *{color:green}+1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 11s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  8m 50s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  8m  0s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 24s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  3s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 13s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 33s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 47s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 43s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  8m 18s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  8m 18s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 26s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 9 new + 9 unchanged - 5 fixed = 18 total (was 14) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  1s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 14s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 46s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 52s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  8m 40s{color} | {color:green} hadoop-common in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 22s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 44m 49s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:9560f25 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12822682/HADOOP-13439.001.patch |
| JIRA Issue | HADOOP-13439 |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux c1ee284b3bce 3.13.0-92-generic #139-Ubuntu SMP Tue Jun 28 20:42:26 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 0705489 |
| Default Java | 1.8.0_101 |
| findbugs | v3.0.0 |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/10205/artifact/patchprocess/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/10205/testReport/ |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/10205/console |
| Powered by | Apache Yetus 0.4.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Fix for checkstyle, | (/) *{color:green}+1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 10s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m 54s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  6m 49s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 23s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 55s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 12s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 17s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 45s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 37s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  6m 41s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  6m 41s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 22s{color} | {color:green} hadoop-common-project/hadoop-common: The patch generated 0 new + 9 unchanged - 5 fixed = 9 total (was 14) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 51s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 12s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 25s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 46s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  7m 43s{color} | {color:green} hadoop-common in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 22s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 37m 49s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:9560f25 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12822701/HADOOP-13439.002.patch |
| JIRA Issue | HADOOP-13439 |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux 3e4efc68a0e2 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 0ad48aa |
| Default Java | 1.8.0_101 |
| findbugs | v3.0.0 |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/10207/testReport/ |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/10207/console |
| Powered by | Apache Yetus 0.4.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, +1 on 002., SUCCESS: Integrated in Hadoop-trunk-Commit #10240 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/10240/])
HADOOP-13439. Fix race between TestMetricsSystemImpl and (iwasakims: rev 8f9b61852bf6600b65e49875fec172bac9e0a85d)
* hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/metrics2/impl/TestGangliaMetrics.java
, Committed to branch-2.8, branch-2 and trunk. Thanks, [~vagarychen].]