[Looking at FileSystem.java:checkapth()
{noformat} 
      if (thatAuthority == null &&                // path's authority is null
          thisAuthority != null) {                // fs has an authority
        URI defaultUri = getDefaultUri(getConf()); // & is the default fs
        if (thisScheme.equalsIgnoreCase(defaultUri.getScheme()) &&
            thisAuthority.equalsIgnoreCase(defaultUri.getAuthority()))
          return;
      }
{noformat} 

With output of hdfs:/user/knoguchi/outputpath

that Authority is null
this Authority is aaa.bbb.ccc
this Scheme is hdfs
default Scheme is hdfs
default Authority is aaa.bbb.ccc:8020

FileSystem.getDefaultUri simply takes "fs.default.name" and don't know about NameNode.DEFAULT_PORT.

, Is it possible that this is related to HADOOP-3317? Doug, could you please take a look? Is it better if HADOOP-3317 does not remove default port number in namenode URI but adds the default port number to a URL without a port number during normalization? This would be more backwards compatible., I'm having trouble reproducing this in a unit test.  I think the only way you can get this is if you set fs.default.name to hdfs://aaa.bbb.ccc:8020/ in your site config file.  Is that what you've done?  If so, the workaround is to instead use just hdfs://aaa.bbb.ccc/ there.  The problem is that the port-defaulting is filesystem specific, but the setting of the default FS is generic, and hence knows nothing about port defaulting., bq. I think the only way you can get this is if you set fs.default.name to hdfs://aaa.bbb.ccc:8020/ in your site config file.
That's exactly what I have.

bq. if so, the workaround is to instead use just hdfs://aaa.bbb.ccc/ there.
Thanks.
But can we have this fixed on hadoop side also?
I think application that worked on 0.17 started failing on 0.18 because of this., Here's a patch that I think will fix this.  Can you tell me if it works for you?  Thanks!, Thanks Doug!  (and sorry for my late response.)
Your patch fixed the error. 

Attaching your patch with one small testcase.

Without your patch, test fails with 
{noformat}
TTestcase: testWithDFSWithDefaultPort took 41.252 sec
        Caused an ERROR
Wrong FS: hdfs:/wc/output2, expected: hdfs://localhost
java.lang.IllegalArgumentException: Wrong FS: hdfs:/wc/output2, expected: hdfs://localhost
        at org.apache.hadoop.fs.FileSystem.checkPath(FileSystem.java:292)
        at org.apache.hadoop.hdfs.DistributedFileSystem.checkPath(DistributedFileSystem.java:98)
        at org.apache.hadoop.hdfs.DistributedFileSystem.getPathName(DistributedFileSystem.java:159)
        at org.apache.hadoop.hdfs.DistributedFileSystem.delete(DistributedFileSystem.java:230)
        at org.apache.hadoop.mapred.TestMiniMRWithDFS.launchWordCount(TestMiniMRWithDFS.java:69)
        at org.apache.hadoop.mapred.TestMiniMRWithDFS.testWithDFSWithDefaultPort(TestMiniMRWithDFS.java:282)
{noformat}

With your patch, test passed.
, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12401053/HADOOP-5259-withtest.patch
  against trunk revision 748770.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 4 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs warnings.

    +1 Eclipse classpath. The patch retains Eclipse classpath integrity.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    -1 contrib tests.  The patch failed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/16/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/16/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/16/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/16/console

This message is automatically generated., One of the test failures occurs in every other build done around the same time, so is clearly not the result of this patch.  The other also appears not to be related to the patch, but I'll resubmit to be sure., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12401053/HADOOP-5259-withtest.patch
  against trunk revision 749318.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 4 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs warnings.

    +1 Eclipse classpath. The patch retains Eclipse classpath integrity.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    -1 contrib tests.  The patch failed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/38/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/38/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/38/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch-vesta.apache.org/38/console

This message is automatically generated., I've committed this. Thanks, Doug and Koji!, Integrated in Hadoop-trunk #783 (See [http://hudson.zones.apache.org/hudson/job/Hadoop-trunk/783/])
    . Job with output hdfs:/user/<username>/outputpath (no authority) fails with Wrong FS. Contributed by Doug Cutting and Koji Noguchi.
]