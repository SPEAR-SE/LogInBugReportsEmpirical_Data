[I use HttpCookie class to get the cookie string so it will be quoted properly. then still manually construct the whole cookie so we could keep both secure and httponly flag. Cookie class doesn't support HttpOnly flag.
I think there is a bug in HttpCookie class, it doesn't remove double quote for empty token when calling HttpCookie#getValue() so I handle empty token separately., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12650960/HADOOP-10710.001.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:red}-1 javac{color:red}.  The patch appears to cause the build to fail.

Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4093//console

This message is automatically generated., Hadoop QA doesn't give any detail error message.
everything compiled successfully for me locally, and related unit tests are all passed. not sure why it fails.
Submit the same patch again., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12651438/HADOOP-10710.002.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:red}-1 javac{color:red}.  The patch appears to cause the build to fail.

Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4106//console

This message is automatically generated., I don't know why the patch does not compiling in jenkins, locally it does.

[~jyu@cloudera.com], any reason why not using the Servlet API Cookie class as before? I would prefer to go back to that.

, that one doesn't support httponly flag.
I could switch to Servlet Cookie class if it's ok to remove httponly
support.



On Thu, Jun 19, 2014 at 1:10 PM, Alejandro Abdelnur (JIRA) <jira@apache.org>




-- 
BR
- Juan
, Does this not work?  I haven't looked closely: http://docs.oracle.com/javaee/6/api/javax/servlet/http/Cookie.html#setHttpOnly(boolean), OK, got it. Now looking at how the cookie is created, it seems it could be done simpler:

{code}
  public static void createAuthCookie(HttpServletResponse resp, String token,
                                      String domain, String path, long expires,
                                      boolean isSecure) {
    if (token != null) {
      HttpCookie cookie = new HttpCookie(AuthenticatedURL.AUTH_COOKIE, token);
      cookie.setPath(path);
      cookie.setMaxAge(expires);
      cookie.setDomain(domain);
      cookie.setSecure(isSecure);
      cookie.setHttpOnly(true);
      resp.addHeader("Set-Cookie", cookie.toString());
    }
  }
{code}

Can you give it a try that way?, I tried to use it before, but the HttpCookie#toString() only include cookie name and value, doesn't include all other attributes., that's Servlet 3.0 API, Hadoop uses 2.5, doesn't it?

http://docs.oracle.com/cd/E17802_01/products/products/servlet/2.5/docs/servlet-2_5-mr2/javax/servlet/http/Cookie.html



On Thu, Jun 19, 2014 at 2:27 PM, Alejandro Abdelnur (JIRA) <jira@apache.org>




-- 
BR
- Juan
, [~jyu@cloudera.com], do setVersion(1), that would force the toString() to print all attributes:

{code}
  public static void createAuthCookie(HttpServletResponse resp, String token,
                                      String domain, String path, long expires,
                                      boolean isSecure) {
    if (token != null) {
      HttpCookie cookie = new HttpCookie(AuthenticatedURL.AUTH_COOKIE, token);
      cookie.setVersion(1);
      cookie.setPath(path);
      cookie.setMaxAge(expires);
      cookie.setDomain(domain);
      cookie.setSecure(isSecure);
      cookie.setHttpOnly(true);
      resp.addHeader("Set-Cookie", cookie.toString());
    }
  }
{code}, [~tucu], I tried, toString() still doesn't print other attributes., arghh, you right, it does not, only prints path/domain.

Then i wouldn't bother using JDK HttpCookie. I would simply make the value to be printed between double quotes and add also the {{; Version=1}} attribute., Thanks tucu, new patch uploaded., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12651552/HADOOP-10710.003.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:red}-1 javac{color:red}.  The patch appears to cause the build to fail.

Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4115//console

This message is automatically generated., revert the new unit test and some changes in TestHttpCookieFlag.java, try to figure out why the build fails., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12651607/HADOOP-10710.004.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:red}-1 javac{color:red}.  The patch appears to cause the build to fail.

Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4123//console

This message is automatically generated., [~jyu@cloudera.com], the append("; VERSION=1") should be done always, not when token not null. other than that seems fine, have you figured out why compilation is failing in test-patch?, Thanks tucu for the review.
I still don't know why the build fails. I didn't use anything uncommon.

What else could I do to fix the build or get detailed info about the failure?, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12651673/HADOOP-10710.005.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:red}-1 javac{color:red}.  The patch appears to cause the build to fail.

Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4127//console

This message is automatically generated., i don't know what is going on on testpatch, i'm able to compile and run the related tests successfully.

[~jyu@cloudera.com], would you run please test-patch locally and post here the results. +1 pending that., [~tucu], I tried "mvn clean test -DskipTests -DHadoopPatchProcess -Ptest-patch"
The build success. Here is the output. 

I checked the test-patch script. here is how it check for failure
 $MVN clean test -DskipTests -D${PROJECT_NAME}PatchProcess $NATIVE_PROFILE -Ptest-patch > $PATCH_DIR/patchJavacWarnings.txt 2>&1
  if [[ $? != 0 ]] ; then
    JIRA_COMMENT="$JIRA_COMMENT

    {color:red}-1 javac{color:red}.  The patch appears to cause the build to fail."
    return 2
  fi

In the Hadoop QA test output, there seems two extra empty lines, could that cause the check fail?
======================================================================
======================================================================
    Determining number of patched javac warnings.
======================================================================
======================================================================


/home/jenkins/tools/maven/latest/bin/mvn clean test -DskipTests -DHadoopPatchProcess -Pnative -Ptest-patch > /home/jenkins/jenkins-slave/workspace/PreCommit-HADOOP-Build/patchprocess/patchJavacWarnings.txt 2>&1




{color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12651673/HADOOP-10710.005.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:red}-1 javac{color:red}.  The patch appears to cause the build to fail.

Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4127//console

This message is automatically generated., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12651758/HADOOP-10710.test-patch.log
  against trunk revision .

    {color:red}-1 patch{color}.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4130//console

This message is automatically generated., Sorry for the late catch up, but I believe that the reason why the patch fails to compile is that {{HttpCookie#isHttpOnly()}} / {{HttpCookie#setHttpOnly()}} are only available on Java 7+, and Jenkins are running on Java 6.

Please check:

http://docs.oracle.com/javase/7/docs/api/java/net/HttpCookie.html

http://docs.oracle.com/javase/6/docs/api/java/net/HttpCookie.html, oh I see. I'll modify the unit tests to not use HttpCookie#isHttpOnly() / HttpCookie#setHttpOnly() 
Thanks a lot [~wheat9]
, remove isHttpOnly(), {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12652346/HADOOP-10710.006.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-auth hadoop-common-project/hadoop-common.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/4167//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4167//console

This message is automatically generated., [~tucu], Jenkins passed now after removing {code} HttpCookie#isHttpOnly() {code}.
Could you take a look at the patch and let me know if anything else is needed?
Thanks., The {{VERSION}} attribute should be {{Version}}. RFC2109 it does not indicate if the attribute names are case insensitive or not, so we should assume they are not.

The assertion for 'HttpOnly' should be {{contains("; HttpOnly")}} instead {{endsWith("HttpOnly")}}.

, [~tucu], thanks for the review, new patch uploaded., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12653187/HADOOP-10710.007.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-auth hadoop-common-project/hadoop-common.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/4191//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4191//console

This message is automatically generated., +1, Thanks Juan. Committed to trunk and branch-2., SUCCESS: Integrated in Hadoop-trunk-Commit #5802 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/5802/])
HADOOP-10710. hadoop.auth cookie is not properly constructed according to RFC2109. (Juan Yu via tucu) (tucu: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1606923)
* /hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/server/TestAuthenticationFilter.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/http/TestHttpCookieFlag.java
, FAILURE: Integrated in Hadoop-Yarn-trunk #600 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/600/])
HADOOP-10710. hadoop.auth cookie is not properly constructed according to RFC2109. (Juan Yu via tucu) (tucu: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1606923)
* /hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/server/TestAuthenticationFilter.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/http/TestHttpCookieFlag.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1791 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1791/])
HADOOP-10710. hadoop.auth cookie is not properly constructed according to RFC2109. (Juan Yu via tucu) (tucu: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1606923)
* /hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/server/TestAuthenticationFilter.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/http/TestHttpCookieFlag.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1818 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1818/])
HADOOP-10710. hadoop.auth cookie is not properly constructed according to RFC2109. (Juan Yu via tucu) (tucu: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1606923)
* /hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/server/TestAuthenticationFilter.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/http/TestHttpCookieFlag.java
, Just as an additional data point, HADOOP-10379  also breaks the use of OOZIE web console in  secure clusters, [~venkatraghavang], are things fixed in Oozie with this patch?, [~nrv]  , [~tucu00] ... Wronly tagged.,, [~tucu00]   Yes.   With the fixes in HADOOP-10710, Oozie console in a secure cluster is functional. , FAILURE: Integrated in Hadoop-Yarn-trunk #664 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/664/])
HADOOP-10911. hadoop.auth cookie after HADOOP-10710 still not proper according to RFC2109. (gchanan via tucu) (tucu: rev 156e6a4f8aed69febec408af423b2a8ac313c643)
* hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/client/TestKerberosAuthenticator.java
* hadoop-common-project/hadoop-common/CHANGES.txt
* hadoop-common-project/hadoop-auth/pom.xml
* hadoop-project/pom.xml
* hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/client/AuthenticatorTestCase.java
* hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1855 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1855/])
HADOOP-10911. hadoop.auth cookie after HADOOP-10710 still not proper according to RFC2109. (gchanan via tucu) (tucu: rev 156e6a4f8aed69febec408af423b2a8ac313c643)
* hadoop-project/pom.xml
* hadoop-common-project/hadoop-auth/pom.xml
* hadoop-common-project/hadoop-common/CHANGES.txt
* hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/client/AuthenticatorTestCase.java
* hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/client/TestKerberosAuthenticator.java
* hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1881 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1881/])
HADOOP-10911. hadoop.auth cookie after HADOOP-10710 still not proper according to RFC2109. (gchanan via tucu) (tucu: rev 156e6a4f8aed69febec408af423b2a8ac313c643)
* hadoop-common-project/hadoop-common/CHANGES.txt
* hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/client/AuthenticatorTestCase.java
* hadoop-common-project/hadoop-auth/pom.xml
* hadoop-project/pom.xml
* hadoop-common-project/hadoop-auth/src/test/java/org/apache/hadoop/security/authentication/client/TestKerberosAuthenticator.java
* hadoop-common-project/hadoop-auth/src/main/java/org/apache/hadoop/security/authentication/server/AuthenticationFilter.java
]