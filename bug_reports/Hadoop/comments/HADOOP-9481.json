[Since commit 102f2e3ea007f8cda041f9df7358098482e5f3e2 in classes SnappyCompressor.c/SnappyDecompressor.c was added includes and conditional logic (if defined),
But his order make classes (SnappyCompressor/SnappyDecompressor) with empty body after compilation in so file.
This easy to prove with this test method:

SnappyCompressor compressor = new SnappyCompressor();
compressor.compress(compressed, 0, compressed.length);

Call method compress() was fail with java.lang.UnsatisfiedLinkError: org.apache.hadoop.io.compress.snappy.SnappyCompressor.compressBytesDirect()I

, Its has affected on patch https://issues.apache.org/jira/browse/HADOOP-9225, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12579129/HADOOP-9481-trunk--N1.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2452//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2452//console

This message is automatically generated., I don't understand what problem is being fixed here, even after looking at the patch.  Can you add a description?

Also, have you installed snappy locally?  If you have not, compiling without snappy is the correct course of action, and not a problem., The patch verification complains about not added/changed tests. We don't add tests there in this patch since comprehensive tests for Snappy are suggested in another patch: https://issues.apache.org/jira/browse/HADOOP-9225 .  So, these 2 fixes can be reviewed and applied together., Hi, Vadim.  I thought cmake was taking care of defining HADOOP_SNAPPY_LIBRARY when building with Snappy.  (See src/CMakeLists.txt and src/config.h.cmake.)  I'm curious if the cmake piece is somehow not working correctly for your builds.
, Hi, Chris, 
what version of cmake do you use? We use cmake 2.8.8., In our experiments "config.h" is generated by cmake and its content is okay.
The problem is that "config.h" is not included into "hadoop-common-project/hadoop-common/src/main/native/src/org/apache/hadoop/io/compress/snappy/SnappyCompressor.c" because "if defined HADOOP_SNAPPY_LIBRARY" condition is false (see desription)., Ivan, thank you for the further explanation.  I understand the problem now.

I think a simpler fix would be to add {{#include "org_apache_hadoop.h"}} as the first line of SnappyCompressor.c and SnappyDecompressor.c.  Can you check if that would work?

Right now, this gets included transitively through {{#include "org_apache_hadoop_io_compress_snappy.h"}}, but that's too late.  Including it explicitly as the first line would guarantee that {{UNIX}} or {{WINDOWS}} gets defined before any other header or code processing.  This also would guarantee that config.h gets included for {{UNIX}}, and therefore {{HADOOP_SNAPPY_LIBRARY}} would be defined.  This is the same approach used in NativeIO.c.

In general, both the .h and .c files are structured such that they expect {{UNIX}}, {{WINDOWS}}, {{HADOOP_SNAPPY_LIBRARY}}, and other build configuration dependencies to be defined before the preprocessor handles anything else.  Therefore, I think it's best that we always {{#include "org_apache_hadoop.h"}} as the first line in any file.

BTW, I have build environments for both Linux and Windows ready to go, so I can volunteer to test the patch cross-platform after we resolve this feedback.  I don't have any test jobs ready to go that use Snappy, so I can't fully verify that, but I assume you already tested that part before submitting the patch.

Thank you for addressing this!
, Chris, yes it's looks simpler. I add #include "org_apache_hadoop.h" as the first line of SnappyCompressor.c/SnappyDecompressor.c. and check for work. 
Test methods in TestSnappyCompressorDecompressor was passed. New version patch in attachments., TestSnappyCompressorDecompressor it's a class from https://issues.apache.org/jira/browse/HADOOP-9225, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12579801/HADOOP-9481-trunk--N4.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2465//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2465//console

This message is automatically generated., +1 for the patch.  (Including org_apache_hadoop_io_compress_snappy.h first transitively includes org_apache_hadoop.h first, so it has the same effect as my earlier suggestion.)  I verified successful builds on Ubuntu and Windows.  Thank you for the pointer to the new test on HADOOP-9225.  I ran that successfully on the Ubuntu machine.

Thank you, Vadim!
, thanks for the explanation.  I would prefer that you explicitly include config.h prior to doing the test for {{HADOOP_SNAPPY_LIBRARY}}, rather than relying on a chain of includes.  aside from that, looks good to me., First patch version do explicitly include config.h prior to doing the test for HADOOP_SNAPPY_LIBRARY, you can use it more preferable, Colin told me offline that he doesn't mind the way the current patch is re: the chain of includes.

+1, the latest patch looks good to me. I confirmed that this fixes the Hadoop snappy build on my box.

I'm going to commit this momentarily., I've just committed this to trunk. Thanks a lot for the contribution, Vadim, and thanks also to Colin for the reviews., (Whoops, thanks also to Chris for the review as well.), Integrated in Hadoop-trunk-Commit #3740 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3740/])
    HADOOP-9481. Broken conditional logic with HADOOP_SNAPPY_LIBRARY. Contributed by Vadim Bondarev. (Revision 1481191)

     Result = SUCCESS
atm : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1481191
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/native/src/org/apache/hadoop/io/compress/snappy/SnappyCompressor.c
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/native/src/org/apache/hadoop/io/compress/snappy/SnappyDecompressor.c
, Integrated in Hadoop-Yarn-trunk #206 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/206/])
    HADOOP-9481. Broken conditional logic with HADOOP_SNAPPY_LIBRARY. Contributed by Vadim Bondarev. (Revision 1481191)

     Result = SUCCESS
atm : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1481191
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/native/src/org/apache/hadoop/io/compress/snappy/SnappyCompressor.c
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/native/src/org/apache/hadoop/io/compress/snappy/SnappyDecompressor.c
, Integrated in Hadoop-Hdfs-trunk #1395 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1395/])
    HADOOP-9481. Broken conditional logic with HADOOP_SNAPPY_LIBRARY. Contributed by Vadim Bondarev. (Revision 1481191)

     Result = FAILURE
atm : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1481191
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/native/src/org/apache/hadoop/io/compress/snappy/SnappyCompressor.c
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/native/src/org/apache/hadoop/io/compress/snappy/SnappyDecompressor.c
, Integrated in Hadoop-Mapreduce-trunk #1422 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1422/])
    HADOOP-9481. Broken conditional logic with HADOOP_SNAPPY_LIBRARY. Contributed by Vadim Bondarev. (Revision 1481191)

     Result = SUCCESS
atm : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1481191
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/native/src/org/apache/hadoop/io/compress/snappy/SnappyCompressor.c
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/native/src/org/apache/hadoop/io/compress/snappy/SnappyDecompressor.c
, Integrated in Hadoop-trunk-Commit #3851 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3851/])
    HADOOP-9481. Move from trunk to release 2.1.0 section (Revision 1489261)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1489261
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
, Integrated in Hadoop-Yarn-trunk #230 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/230/])
    HADOOP-9481. Move from trunk to release 2.1.0 section (Revision 1489261)

     Result = FAILURE
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1489261
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
, Integrated in Hadoop-Hdfs-trunk #1420 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1420/])
    HADOOP-9481. Move from trunk to release 2.1.0 section (Revision 1489261)

     Result = FAILURE
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1489261
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
, Integrated in Hadoop-Mapreduce-trunk #1446 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1446/])
    HADOOP-9481. Move from trunk to release 2.1.0 section (Revision 1489261)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1489261
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
]