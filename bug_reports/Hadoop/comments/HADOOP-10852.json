[The _NetgroupCache_ is fixed by keeping state in only one _ConcurrentHashMap_ - {{userToNetgroupsMap}}.
{{add}} updates {{userToNetgroupsMap}} directly.

There is a slight performance loss when invoking {{isCached}} and {{{userToNetgroupsMap}}
But these are invoked only during {{refresh}} and adding a new group. These invocations should be rare compared to {{getNetgroups}} invocation., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12656115/HADOOP-10852.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-common-project/hadoop-common:

                  org.apache.hadoop.security.TestNetgroupCache
                  org.apache.hadoop.ha.TestZKFailoverController

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/4490//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4490//console

This message is automatically generated., updating the patch to fix the test failures., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12662925/HADOOP-10852.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-common-project/hadoop-common:

                  org.apache.hadoop.ha.TestActiveStandbyElector

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/4515//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/4515//console

This message is automatically generated., Attaching a newer patch which keeps single collection., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12687046/HADOOP-10852.patch
  against trunk revision cbfb996.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:red}-1 findbugs{color}.  The patch appears to introduce 3 new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-common-project/hadoop-common:

                  org.apache.hadoop.crypto.random.TestOsSecureRandom

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/5261//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HADOOP-Build/5261//artifact/patchprocess/newPatchFindbugsWarningshadoop-common.html
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/5261//console

This message is automatically generated., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12687046/HADOOP-10852.patch
  against trunk revision cbfb996.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:red}-1 findbugs{color}.  The patch appears to introduce 3 new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/5262//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HADOOP-Build/5262//artifact/patchprocess/newPatchFindbugsWarningshadoop-common.html
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/5262//console

This message is automatically generated., +1 for the patch except for some formatting. Feel free to commit after fixing it.

# Space between {{//}} and comment text. e.g. _//ConcurrentHashMap does not allow null values;_
# Spaces around tokens in for e.g. _String user:users_

The patch looks good otherwise and existing unit tests look sufficient., Thanks for the review [~arpitagarwal]. Attaching the newer patch. Will commit once jenkins build is done with expected results., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12687279/HADOOP-10852.patch
  against trunk revision 832ebd8.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:red}-1 findbugs{color}.  The patch appears to introduce 3 new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-common-project/hadoop-common:

                  org.apache.hadoop.ha.TestZKFailoverControllerStress

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/5270//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HADOOP-Build/5270//artifact/patchprocess/newPatchFindbugsWarningshadoop-common.html
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/5270//console

This message is automatically generated., committed to trunk and branch-2, FAILURE: Integrated in Hadoop-trunk-Commit #6724 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6724/])
HADOOP-10852 Fix thread safety issues in NetgroupCache. (Benoy Antony) (benoy: rev a095622f36c5e9fff3ec02b14b800038a81f6286)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/NetgroupCache.java
, FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #43 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/43/])
HADOOP-10852 Fix thread safety issues in NetgroupCache. (Benoy Antony) (benoy: rev a095622f36c5e9fff3ec02b14b800038a81f6286)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/NetgroupCache.java
, FAILURE: Integrated in Hadoop-Yarn-trunk #777 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/777/])
HADOOP-10852 Fix thread safety issues in NetgroupCache. (Benoy Antony) (benoy: rev a095622f36c5e9fff3ec02b14b800038a81f6286)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/NetgroupCache.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1994 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1994/])
HADOOP-10852 Fix thread safety issues in NetgroupCache. (Benoy Antony) (benoy: rev a095622f36c5e9fff3ec02b14b800038a81f6286)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/NetgroupCache.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1975 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1975/])
HADOOP-10852 Fix thread safety issues in NetgroupCache. (Benoy Antony) (benoy: rev a095622f36c5e9fff3ec02b14b800038a81f6286)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/NetgroupCache.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #40 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/40/])
HADOOP-10852 Fix thread safety issues in NetgroupCache. (Benoy Antony) (benoy: rev a095622f36c5e9fff3ec02b14b800038a81f6286)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/NetgroupCache.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #44 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/44/])
HADOOP-10852 Fix thread safety issues in NetgroupCache. (Benoy Antony) (benoy: rev a095622f36c5e9fff3ec02b14b800038a81f6286)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/NetgroupCache.java
]