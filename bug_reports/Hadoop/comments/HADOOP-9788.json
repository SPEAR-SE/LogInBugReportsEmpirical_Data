[Duping it to HADOOP-9652 since we reverted it and want to just fix all these issues there in a new patch.]