[More from the logs:

Namenode Log After 1st Startup:
-------------------------------
2007-03-06 18:27:23,217 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/foo4193.bar.com:50010
2007-03-06 18:27:23,219 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/foo4194.bar.com:50010
2007-03-06 18:27:23,219 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/foo4191.bar.com:50010
2007-03-06 18:27:23,220 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/foo4190.bar.com:50010
2007-03-06 18:27:23,345 INFO org.apache.hadoop.dfs.StateChange: STATE* SafeModeInfo.enter: Safe mode is ON.
Safe mode will be turned off automatically.
2007-03-06 18:27:23,462 INFO org.mortbay.util.Credential: Checking Resource aliases
2007-03-06 18:27:23,527 INFO org.mortbay.http.HttpServer: Version Jetty/5.1.4
2007-03-06 18:27:24,375 INFO org.mortbay.util.Container: Started org.mortbay.jetty.servlet.WebApplicationHandler@4fc156
2007-03-06 18:27:24,442 INFO org.mortbay.util.Container: Started WebApplicationContext[/,/]
2007-03-06 18:27:24,442 INFO org.mortbay.util.Container: Started HttpContext[/logs,/logs]
2007-03-06 18:27:24,442 INFO org.mortbay.util.Container: Started HttpContext[/static,/static]
2007-03-06 18:27:24,448 INFO org.mortbay.http.SocketListener: Started SocketListener on 0.0.0.0:50070
2007-03-06 18:27:24,448 INFO org.mortbay.util.Container: Started org.mortbay.jetty.Server@bb7759
2007-03-06 18:27:24,468 INFO org.apache.hadoop.ipc.Server: IPC Server listener on 8020: starting
2007-03-06 18:27:24,470 INFO org.apache.hadoop.ipc.Server: IPC Server handler 0 on 8020: starting
2007-03-06 18:27:24,470 INFO org.apache.hadoop.ipc.Server: IPC Server handler 1 on 8020: starting
2007-03-06 18:27:24,470 INFO org.apache.hadoop.ipc.Server: IPC Server handler 2 on 8020: starting
2007-03-06 18:27:24,471 INFO org.apache.hadoop.ipc.Server: IPC Server handler 3 on 8020: starting
2007-03-06 18:27:24,471 INFO org.apache.hadoop.ipc.Server: IPC Server handler 4 on 8020: starting
2007-03-06 18:27:24,471 INFO org.apache.hadoop.ipc.Server: IPC Server handler 5 on 8020: starting
2007-03-06 18:27:24,471 INFO org.apache.hadoop.ipc.Server: IPC Server handler 6 on 8020: starting
2007-03-06 18:27:24,472 INFO org.apache.hadoop.ipc.Server: IPC Server handler 7 on 8020: starting
2007-03-06 18:27:24,472 INFO org.apache.hadoop.ipc.Server: IPC Server handler 8 on 8020: starting
2007-03-06 18:27:24,472 INFO org.apache.hadoop.ipc.Server: IPC Server handler 9 on 8020: starting
2007-03-06 18:27:25,567 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.125:50010 storage DS-998622396
2007-03-06 18:27:25,571 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/foo4193.bar.com:50010
2007-03-06 18:27:25,571 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.125:50010
2007-03-06 18:27:25,790 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.70:50010 storage DS1861818967
2007-03-06 18:27:25,793 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/foo4191.bar.com:50010
2007-03-06 18:27:25,794 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.70:50010
2007-03-06 18:27:25,830 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.124:50010 storage DS-251661422
2007-03-06 18:27:25,838 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/foo4194.bar.com:50010
2007-03-06 18:27:25,838 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.124:50010
2007-03-06 18:27:26,744 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.71:50010 storage DS-559823463
2007-03-06 18:27:26,747 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/foo4190.bar.com:50010
2007-03-06 18:27:26,747 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.71:50010
2007-03-06 18:27:27,045 INFO org.apache.hadoop.dfs.StateChange: STATE* SafeModeInfo.leave: Safe mode is OFF.
	
Namenode Log After 2nd Startup:
-------------------------------
2007-03-06 18:27:39,587 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/foo4194.bar.com:50010
2007-03-06 18:27:39,589 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/foo4190.bar.com:50010
2007-03-06 18:27:39,590 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/foo4193.bar.com:50010
2007-03-06 18:27:39,590 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/foo4191.bar.com:50010
2007-03-06 18:27:39,592 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.125:50010
2007-03-06 18:27:39,592 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.70:50010
2007-03-06 18:27:39,593 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.124:50010
2007-03-06 18:27:39,594 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.71:50010
2007-03-06 18:27:39,613 INFO org.apache.hadoop.dfs.StateChange: STATE* SafeModeInfo.enter: Safe mode is ON.
Safe mode will be turned off automatically.
2007-03-06 18:27:39,726 INFO org.mortbay.util.Credential: Checking Resource aliases
2007-03-06 18:27:39,793 INFO org.mortbay.http.HttpServer: Version Jetty/5.1.4
2007-03-06 18:27:40,457 INFO org.mortbay.util.Container: Started org.mortbay.jetty.servlet.WebApplicationHandler@12a55aa
2007-03-06 18:27:40,528 INFO org.mortbay.util.Container: Started WebApplicationContext[/,/]
2007-03-06 18:27:40,528 INFO org.mortbay.util.Container: Started HttpContext[/logs,/logs]
2007-03-06 18:27:40,528 INFO org.mortbay.util.Container: Started HttpContext[/static,/static]
2007-03-06 18:27:40,535 INFO org.mortbay.http.SocketListener: Started SocketListener on 0.0.0.0:50070
2007-03-06 18:27:40,535 INFO org.mortbay.util.Container: Started org.mortbay.jetty.Server@d1fa5
2007-03-06 18:27:40,556 INFO org.apache.hadoop.ipc.Server: IPC Server listener on 8020: starting
2007-03-06 18:27:40,558 INFO org.apache.hadoop.ipc.Server: IPC Server handler 0 on 8020: starting
2007-03-06 18:27:40,559 INFO org.apache.hadoop.ipc.Server: IPC Server handler 1 on 8020: starting
2007-03-06 18:27:40,559 INFO org.apache.hadoop.ipc.Server: IPC Server handler 2 on 8020: starting
2007-03-06 18:27:40,559 INFO org.apache.hadoop.ipc.Server: IPC Server handler 3 on 8020: starting
2007-03-06 18:27:40,559 INFO org.apache.hadoop.ipc.Server: IPC Server handler 4 on 8020: starting
2007-03-06 18:27:40,560 INFO org.apache.hadoop.ipc.Server: IPC Server handler 5 on 8020: starting
2007-03-06 18:27:40,560 INFO org.apache.hadoop.ipc.Server: IPC Server handler 6 on 8020: starting
2007-03-06 18:27:40,560 INFO org.apache.hadoop.ipc.Server: IPC Server handler 7 on 8020: starting
2007-03-06 18:27:40,561 INFO org.apache.hadoop.ipc.Server: IPC Server handler 8 on 8020: starting
2007-03-06 18:27:40,561 INFO org.apache.hadoop.ipc.Server: IPC Server handler 9 on 8020: starting
2007-03-06 18:27:41,850 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.70:50010 storage DS1861818967
2007-03-06 18:27:41,854 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/75.75.60.70:50010
2007-03-06 18:27:41,854 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.70:50010
2007-03-06 18:27:41,932 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.124:50010 storage DS-251661422
2007-03-06 18:27:41,950 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/75.75.60.124:50010
2007-03-06 18:27:41,950 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.124:50010
2007-03-06 18:27:41,953 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.71:50010 storage DS-559823463
2007-03-06 18:27:41,996 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/75.75.60.71:50010
2007-03-06 18:27:41,996 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.71:50010
2007-03-06 18:27:42,012 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.125:50010 storage DS-998622396
2007-03-06 18:27:42,015 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/75.75.60.125:50010
2007-03-06 18:27:42,015 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.125:50010
2007-03-06 18:27:43,201 INFO org.apache.hadoop.dfs.StateChange: STATE* SafeModeInfo.leave: Safe mode is OFF.
2007-03-06 18:27:43,201 INFO org.apache.hadoop.dfs.StateChange: STATE* Network topology has 2 racks and 8 datanodes

Namenode Log After 3rd Startup:
-------------------------------
2007-03-06 18:28:06,129 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.124:50010
2007-03-06 18:28:06,130 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.71:50010
2007-03-06 18:28:06,131 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.125:50010
2007-03-06 18:28:06,131 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.70:50010
2007-03-06 18:28:06,132 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.70:50010
2007-03-06 18:28:06,132 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.124:50010
2007-03-06 18:28:06,133 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.71:50010
2007-03-06 18:28:06,133 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.125:50010
2007-03-06 18:28:06,146 INFO org.apache.hadoop.dfs.StateChange: STATE* SafeModeInfo.enter: Safe mode is ON.
Safe mode will be turned off automatically.
2007-03-06 18:28:06,258 INFO org.mortbay.util.Credential: Checking Resource aliases
2007-03-06 18:28:06,325 INFO org.mortbay.http.HttpServer: Version Jetty/5.1.4
2007-03-06 18:28:06,985 INFO org.mortbay.util.Container: Started org.mortbay.jetty.servlet.WebApplicationHandler@5dd582
2007-03-06 18:28:07,049 INFO org.mortbay.util.Container: Started WebApplicationContext[/,/]
2007-03-06 18:28:07,050 INFO org.mortbay.util.Container: Started HttpContext[/logs,/logs]
2007-03-06 18:28:07,050 INFO org.mortbay.util.Container: Started HttpContext[/static,/static]
2007-03-06 18:28:07,056 INFO org.mortbay.http.SocketListener: Started SocketListener on 0.0.0.0:50070
2007-03-06 18:28:07,056 INFO org.mortbay.util.Container: Started org.mortbay.jetty.Server@ca0115
2007-03-06 18:28:07,074 INFO org.apache.hadoop.ipc.Server: IPC Server listener on 8020: starting
2007-03-06 18:28:07,076 INFO org.apache.hadoop.ipc.Server: IPC Server handler 0 on 8020: starting
2007-03-06 18:28:07,077 INFO org.apache.hadoop.ipc.Server: IPC Server handler 2 on 8020: starting
2007-03-06 18:28:07,077 INFO org.apache.hadoop.ipc.Server: IPC Server handler 3 on 8020: starting
2007-03-06 18:28:07,077 INFO org.apache.hadoop.ipc.Server: IPC Server handler 1 on 8020: starting
2007-03-06 18:28:07,077 INFO org.apache.hadoop.ipc.Server: IPC Server handler 4 on 8020: starting
2007-03-06 18:28:07,077 INFO org.apache.hadoop.ipc.Server: IPC Server handler 5 on 8020: starting
2007-03-06 18:28:07,078 INFO org.apache.hadoop.ipc.Server: IPC Server handler 6 on 8020: starting
2007-03-06 18:28:07,078 INFO org.apache.hadoop.ipc.Server: IPC Server handler 7 on 8020: starting
2007-03-06 18:28:07,078 INFO org.apache.hadoop.ipc.Server: IPC Server handler 8 on 8020: starting
2007-03-06 18:28:07,078 INFO org.apache.hadoop.ipc.Server: IPC Server handler 9 on 8020: starting
2007-03-06 18:28:08,459 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.70:50010 storage DS1861818967
2007-03-06 18:28:08,462 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/75.75.60.70:50010
2007-03-06 18:28:08,463 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.70:50010
2007-03-06 18:28:08,550 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.124:50010 storage DS-251661422
2007-03-06 18:28:08,552 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/75.75.60.124:50010
2007-03-06 18:28:08,552 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.124:50010
2007-03-06 18:28:08,676 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.71:50010 storage DS-559823463
2007-03-06 18:28:08,678 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/75.75.60.71:50010
2007-03-06 18:28:08,679 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.71:50010
2007-03-06 18:28:08,858 INFO org.apache.hadoop.dfs.StateChange: BLOCK* NameSystem.registerDatanode: node registration from 75.75.60.125:50010 storage DS-998622396
2007-03-06 18:28:08,862 INFO org.apache.hadoop.net.NetworkTopology: Removing a node: /default-rack/75.75.60.125:50010
2007-03-06 18:28:08,862 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /162.254.0.0/75.75.60.125:50010
2007-03-06 18:28:09,730 INFO org.apache.hadoop.dfs.StateChange: STATE* SafeModeInfo.leave: Safe mode is OFF.
2007-03-06 18:28:09,730 INFO org.apache.hadoop.dfs.StateChange: STATE* Network topology has 1 racks and 4 datanodes
, My guess this is caused by some interaction between the rack aware patch, the Datanode IP address patch and hostnames being stored in the fsimage file., 
This confusion might be between 11.2 and 12.0.

>2007-03-06 18:28:06,131 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.70:50010
>2007-03-06 18:28:06,132 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /default-rack/75.75.60.70:50010 

I will look into why there are double entries in fsimage. will update with what should happen in this case.

, Looks like this is fairly harmless so defering to 0.13.0, >When upgrading from Hadoop 0.10.1 to 0.11.2, I see the number of racks and datanode double after the 2nd startup of the Namenode. 
> After the 3rd startup, they correct themselves:
This is between 0.11.2 and 0.12.x

> Namenode Log After 1st Startup:
> 2007-03-06 18:27:27,045 INFO org.apache.hadoop.dfs.StateChange: STATE* Network topology has 1 racks and 4 datanodes

> Namenode Log After 2nd Startup:
> 2007-03-06 18:27:43,201 INFO org.apache.hadoop.dfs.StateChange: STATE* Network topology has 2 racks and 8 datanodes

Because namenode was restarted before check point in the prev run, both hostName and ip are added to n/w topology. When a datanode is removed in the image or edits log, we dont delete its entry from n/w topo, I am not sure why. Now only ip entries get updated with the new topo info. This explains extra nodes. Now new image is written to disk (equivalent to a checkpoint in the first start up).

>Namenode Log After 3rd Startup:
>2007-03-06 18:28:09,730 INFO org.apache.hadoop.dfs.StateChange: STATE* Network topology has 1 racks and 4 datanodes

Because there at least one checkpoint, we dont see multiple entries.

I am not entirely sure how LOG_DATANODE_REMOVE operation is handled.



, This is made obsolete by HADOOP-993 which is scheduled to be implemented., 
> Because namenode was restarted before check point in the prev run, both hostName and ip are added to n/w topology. 
> When a datanode is removed in the image or edits log, we dont delete its entry from n/w topo, I am not sure why. Now only ip 
> entries get updated with the new topo info. This explains extra nodes. Now new image is written to disk (equivalent to a
> checkpoint in the first start up). 

Looks like this could lead to a situation where a datanode is marked dead but Namenode tries to schedule blocks to it since it exists in NetworkTopology clusterMap.

One suggested fix ( by Konstantin ) is not to add any nodes to clusterMap while loading fsimage. So the clusterMap is updated only when nodes register and when they are marked dead. Will submit a patch for this. , The main problem turns out to be that old nodes were considered alive, and 
the name-node was trying to place block replicas on them.
The solution is to add the nodes to the topology map only when they register., +1.  This passes all unit tests when applied against revision 517769., Hairong,

This also shows implicit assumption that existence of a node in clusterNode implies node is healthy. I think we should either make it explicit or work around it. Does node decommision work well with clusterMap? My understanding is the 'being decommissioned' is kind of an in-between state.. there is special handling of decommissioned nodes else where in the code.
, I've just committed this. Thanks Konstantin!]