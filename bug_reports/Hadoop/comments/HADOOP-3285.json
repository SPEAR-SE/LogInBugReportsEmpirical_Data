[The namenode (via {{Namenode.getBlockLocations()}}) returns different block location information than the one in {{split.getLocations()}}.  Note that {{split.getLocations()}} is used for task cache creation in JobInProgress while {{Namenode.getBlockLocations()}} is used by the DFS client for pulling the split before starting the actual map phase. One possible problem is 2027. We are investigating. , This patch fixes the off by one bug that was messing up the locality of InputSplits., This throws a runtime exception if offset and file size are both zero. Is that ok?, Added test case, Owen, I'm guessing you uploaded the wrong patch:
{code}
@@ -279,12 +279,17 @@
   protected int getBlockIndex(BlockLocation[] blkLocations, 
                               long offset) {
     for (int i = 0 ; i < blkLocations.length; i++) {
+      // is the offset inside this block?
       if ((blkLocations[i].getOffset() <= offset) &&
-        ((blkLocations[i].getOffset() + blkLocations[i].getLength()) >= 
-        offset))
-          return i;
+          (offset <= blkLocations[i].getOffset() + blkLocations[i].getLength())){
+        return i;
+      }

{code}, Here is the corrected patch. The previous patch was my test that the regression test caught the previous problem!, 
I tried out the patch, it worked, and it makes big difference in terms of network bandwidth consumption.

Note: this patch is a client side patch. I was puzzled for a long while for not seeing the expected effect after applying the patch 
to the server side, until realizing that I had to apply the patch to the machine where I submit jobs.
, Chris asked for a finally block to call minidfscluster shutdown., +1, Do we know since when this was messed up?
, -1 overall.  Here are the results of testing the latest attachment 
http://issues.apache.org/jira/secure/attachment/12380724/3285-4.patch
against trunk revision 645773.

    @author +1.  The patch does not contain any @author tags.

    tests included +1.  The patch appears to include 3 new or modified tests.

    javadoc +1.  The javadoc tool did not generate any warning messages.

    javac +1.  The applied patch does not generate any new javac compiler warnings.

    release audit +1.  The applied patch does not generate any new release audit warnings.

    findbugs +1.  The patch does not introduce any new Findbugs warnings.

    core tests -1.  The patch failed core unit tests.

    contrib tests +1.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/2298/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/2298/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/2298/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/2298/console

This message is automatically generated., I managed to get the wrong test file in the previous patch with the wrong block size., Going through qa one more time., The problem was introduced by HADOOP-2027., +1 overall.  Here are the results of testing the latest attachment 
http://issues.apache.org/jira/secure/attachment/12380747/3285-5.patch
against trunk revision 645773.

    @author +1.  The patch does not contain any @author tags.

    tests included +1.  The patch appears to include 3 new or modified tests.

    javadoc +1.  The javadoc tool did not generate any warning messages.

    javac +1.  The applied patch does not generate any new javac compiler warnings.

    release audit +1.  The applied patch does not generate any new release audit warnings.

    findbugs +1.  The patch does not introduce any new Findbugs warnings.

    core tests +1.  The patch passed core unit tests.

    contrib tests +1.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/2305/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/2305/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Checkstyle results: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/2305/artifact/trunk/build/test/checkstyle-errors.html
Console output: http://hudson.zones.apache.org/hudson/job/Hadoop-Patch/2305/console

This message is automatically generated., I just committed this., Integrated in Hadoop-trunk #469 (See [http://hudson.zones.apache.org/hudson/job/Hadoop-trunk/469/])]