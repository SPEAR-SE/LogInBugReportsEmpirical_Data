[Initial patch without test, I think the test should be in hdfs cause only hdfs filesystem has .snapshot dir., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12598267/HADOOP-9877.v1.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-common-project/hadoop-common:

                  org.apache.hadoop.fs.TestPath

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2990//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2990//console

This message is automatically generated., Hi Binglin,

Patch looks good, nice catch! Two requests:

- Can you add a code comment explaining why we need this additional check? For example, "Some special filesystem directories (e.g. HDFS snapshot directories) are not returned by listStatus, but do exist if checked explicitly via getFileStatus."
- Need to fix Jenkins issues. It's fine to include a "list snapshots via shell" test in HDFS, especially because shell+snapshots seems to be a weak spot in our current unit tests.

+1 once these are addressed.

p.s. normally, patches are generated via a command like "git diff --no-prefix", I had to apply your patch with -p1 rather than -p0., Can you please add a unit test to ensure in future if someone broke this functionality it is caught by the unit test failure.

bq. normally, patches are generated via a command like "git diff --no-prefix", I had to apply your patch with -p1 rather than -p0.
This is no longer the norm. Now that Jenkins handles both variants, lot of people no longer care to generate diff with --no-prefix., Thanks for finding this.

{code}
+          } else {
+            FileStatus s = getFileStatus(new Path(candidate.getPath(), component));
+            if (s != null) {
+              newCandidates.add(s);
{code}

This is incorrect.  If you try to list a symlink this way, it will list the target file instead.
You need to build up the path the same way the other code path does, except using {{getFileLinkStatus}} (not {{getFileStatus}}).

I agree with Andrew's suggestion about comments and Suresh's suggestion about tests.  Rather than creating snapshots in the unit test, you could list things in the /.reserved directory, since that always exists (and will not be returned by listStatus)., Thanks for the review and advice, here is the new patch with test, changes:
1. Add some comments to explain the change.
2. Change getFileStatus to getFileLinkStatus
3. Add unquotePathComponent to fix test failure of org.apache.hadoop.fs.TestPath
4. Add test in hdfs to check .snapshot can be correctly globbed.

@Colin
I tried .reserved but it can not work currently, because:
getFileStatus("/.reserved") failed
getFileStatus("/.reserved/.inodes") failed
getFileStatus("/.reserved/.inodes/[id]") success
This behavior is not consistent with /.snapshot, I you agree, I can fire a bug to fix this.


 
, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12598358/HADOOP-9877.v2.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.fs.viewfs.TestFcMainOperationsLocalFs
                  org.apache.hadoop.fs.TestFsShellReturnCode
                  org.apache.hadoop.fs.TestGlobPaths

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2993//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2993//console

This message is automatically generated., Add code to explicitly set the path of FileStatus like the original code., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12598391/HADOOP-9877.v3.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.fs.TestFsShellReturnCode

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2994//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2994//console

This message is automatically generated., Upload v4 patch, add mock getFileLinkStatus to TestFsShellReturnCode.RawLocalFileSystemExtn, {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12598498/HADOOP-9877.v4.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 3 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/2995//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/2995//console

This message is automatically generated., OK, looks good. Only one small nit:

* In {{FileContextMainOperationsBaseTest}}, instead of doing an {{hidden != null}} check, you can use JUnit's {{assumeNotNull}}. This makes unimplementing tests show up as skipped rather than passing, which is nicer., Thanks, Binglin.  +1 once Andrew's comment is addressed, Thanks for the review, Andrew and Colin!
New patch addressing the comments., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12598917/HADOOP-9877.v5.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 3 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HADOOP-Build/3005//testReport/
Console output: https://builds.apache.org/job/PreCommit-HADOOP-Build/3005//console

This message is automatically generated., +1, will commit shortly. Thanks Binglin!, Committed to trunk and branch-2., SUCCESS: Integrated in Hadoop-trunk-Commit #4299 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/4299/])
HADOOP-9877. Fix listing of snapshot directories in globStatus. (Binglin Chang via Andrew Wang) (wang: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1515955)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/Globber.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/FileContextMainOperationsBaseTest.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/TestFsShellReturnCode.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHDFSFileContextMainOperations.java
, Seems like this was merged badly to branch-2 so that it doesn't compile. Can we get a quick fix?, Just spoke with Andrew.  He is on it., Thanks, Chris., Hey Binglin, turns out this doesn't apply cleanly to branch-2 (had to revert it out).

Do you mind submitting a branch-2 version as well?, Here is the patch for branch-2., SUCCESS: Integrated in Hadoop-Yarn-trunk #308 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/308/])
HADOOP-9877. Fix listing of snapshot directories in globStatus. (Binglin Chang via Andrew Wang) (wang: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1515955)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/Globber.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/FileContextMainOperationsBaseTest.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/TestFsShellReturnCode.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHDFSFileContextMainOperations.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1525 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1525/])
HADOOP-9877. Fix listing of snapshot directories in globStatus. (Binglin Chang via Andrew Wang) (wang: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1515955)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/Globber.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/FileContextMainOperationsBaseTest.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/TestFsShellReturnCode.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHDFSFileContextMainOperations.java
, +1 for branch-2 patch, committed. Thanks Binglin for the quick turnaround!, Hi, [~decster].  This patch caused a regression on Windows.  Could you please take a look at HDFS-5125?  Thanks!, Hi [~decster] and [~andrew.wang], this change has caused a regression for Pig.  Could you please take a look at HADOOP-9912?  Thanks!, Hey folks, based on Jason's report in HADOOP-9912, I reverted this change from branch-2 and trunk, since it broke Pig completely. This, of course, means we can no longer list snapshot directories, so this is a temporary fix while we work on fixing the globber more broadly in HADOOP-9912., SUCCESS: Integrated in Hadoop-trunk-Commit #4382 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/4382/])
Revert HADOOP-9877 because of breakage reported in HADOOP-9912 (wang: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1520713)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/Globber.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/FileContextMainOperationsBaseTest.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/TestFsShellReturnCode.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHDFSFileContextMainOperations.java
, SUCCESS: Integrated in Hadoop-Yarn-trunk #325 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/325/])
Revert HADOOP-9877 because of breakage reported in HADOOP-9912 (wang: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1520713)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/Globber.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/FileContextMainOperationsBaseTest.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/TestFsShellReturnCode.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHDFSFileContextMainOperations.java
, SUCCESS: Integrated in Hadoop-Hdfs-trunk #1515 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1515/])
Revert HADOOP-9877 because of breakage reported in HADOOP-9912 (wang: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1520713)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/Globber.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/FileContextMainOperationsBaseTest.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/TestFsShellReturnCode.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHDFSFileContextMainOperations.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1541 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1541/])
Revert HADOOP-9877 because of breakage reported in HADOOP-9912 (wang: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1520713)
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/CHANGES.txt
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/Globber.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/FileContextMainOperationsBaseTest.java
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/fs/TestFsShellReturnCode.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHDFSFileContextMainOperations.java
, This was fixed in HADOOP-9981, Closing old tickets that are already part of a release.]