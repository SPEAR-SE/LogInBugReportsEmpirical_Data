[I was investigating HADOOP-643. The problem is that the FSDataSet is not protected by locks. In this case, data-receive thread is receiving some data from another datanaode and is traversing the dataset to validate that the directory is valid. At the same time,  the main datanode thread (offerService()) could be modifying the FSDataset. Protecting the DataXceiveServer thread from the offerservice thread is all this is needed.

It appears that the DataTransfer does not need any protection., 
Thanks Dhruba. Yes, lot of accesses from offerServer() and other threads is not protected. I just started reading the surounding code to see exactly how this exception occurs what we should protect.
, 
What should this thread do if it gets a run time exception like this? Should that be part of the patch for this?
, it's best effort:
if you can recover, by restarting the thread or otherwise, then recover.
Otherwise, take down the entire process, so it's clear that you're down and require manual intervention., 
This patch fixes the NPE and synchronizes datanode's directories and maps.
, I just committed this.  Thanks, Raghu!]