{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "fields": {
        "aggregateprogress": {
            "percent": 0,
            "progress": 0,
            "total": 259200
        },
        "aggregatetimeestimate": 259200,
        "aggregatetimeoriginalestimate": 259200,
        "aggregatetimespent": null,
        "assignee": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Eric Lei",
            "key": "eric88",
            "name": "Eric88",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=Eric88",
            "timeZone": "Etc/UTC"
        },
        "components": [{
            "id": "12330961",
            "name": "common",
            "self": "https://issues.apache.org/jira/rest/api/2/component/12330961"
        }],
        "created": "2017-07-27T09:05:25.000+0000",
        "creator": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Eric Lei",
            "key": "eric88",
            "name": "Eric88",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=Eric88",
            "timeZone": "Etc/UTC"
        },
        "customfield_10010": null,
        "customfield_12310191": null,
        "customfield_12310192": null,
        "customfield_12310220": "2017-07-27T20:11:22.769+0000",
        "customfield_12310222": null,
        "customfield_12310230": null,
        "customfield_12310250": [
            {
                "id": "10430",
                "self": "https://issues.apache.org/jira/rest/api/2/customFieldOption/10430",
                "value": "Patch"
            },
            {
                "id": "10431",
                "self": "https://issues.apache.org/jira/rest/api/2/customFieldOption/10431",
                "value": "Important"
            }
        ],
        "customfield_12310290": null,
        "customfield_12310291": null,
        "customfield_12310300": null,
        "customfield_12310310": "4.0",
        "customfield_12310320": null,
        "customfield_12310420": "9223372036854775807",
        "customfield_12310920": "9223372036854775807",
        "customfield_12310921": null,
        "customfield_12311020": null,
        "customfield_12311024": null,
        "customfield_12311120": null,
        "customfield_12311820": "0|i3i2vz:",
        "customfield_12312022": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "customfield_12312026": null,
        "customfield_12312220": null,
        "customfield_12312320": null,
        "customfield_12312321": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312324": null,
        "customfield_12312325": null,
        "customfield_12312326": null,
        "customfield_12312327": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312330": null,
        "customfield_12312331": null,
        "customfield_12312332": null,
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12312335": null,
        "customfield_12312336": null,
        "customfield_12312337": null,
        "customfield_12312338": null,
        "customfield_12312339": null,
        "customfield_12312340": null,
        "customfield_12312341": null,
        "customfield_12312520": null,
        "customfield_12312521": "Wed Aug 09 12:44:36 UTC 2017",
        "customfield_12312720": null,
        "customfield_12312823": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "customfield_12312923": null,
        "customfield_12313422": "false",
        "customfield_12313520": null,
        "description": "1.\tBug description\nShell command \u201cHadoop fs -put\u201d is a write operation. In this process, FSDataOutputStream is new created and closed lastly. Finally, the FSDataOutputStream.close() calls the close method in HDFS to end up the communication of this write process between the server and client.\nWith the command \u201cHadoop fs -put\u201d, for each created FSDataOutputStream object, FSDataOutputStream.close() is called twice, which means the close method, in the underlying distributed file system, is called twice. This is the error, that\u2019s because the communication process, for example socket, might be repeated shut down. Unfortunately, if there is no error protection for the socket, there might be error for the socket in the second close. \nFurther, we think a correct upper file system design should keep the one time close principle. It means that each creation of underlying distributed file system object should correspond with close only once. \nFor the command \u201cHadoop fs -put\u201d, there are double close as follows:\na.\tThe first close process:\nat org.apache.hadoop.fs.FSDataOutputStream$PositionCache.close(FSDataOutputStream.java:72)\nat org.apache.hadoop.fs.FSDataOutputStream.close(FSDataOutputStream.java:106)\nat org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:61)\nat org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:119)\nat org.apache.hadoop.fs.shell.CommandWithDestination$TargetFileSystem.writeStreamToFile(CommandWithDestination.java:466)\nat org.apache.hadoop.fs.shell.CommandWithDestination.copyStreamToTarget(CommandWithDestination.java:391)\nat org.apache.hadoop.fs.shell.CommandWithDestination.copyFileToTarget(CommandWithDestination.java:328)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPath(CommandWithDestination.java:263)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPath(CommandWithDestination.java:248)\nat org.apache.hadoop.fs.shell.Command.processPaths(Command.java:317)\nat org.apache.hadoop.fs.shell.Command.processPathArgument(Command.java:289)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPathArgument(CommandWithDestination.java:243)\nat org.apache.hadoop.fs.shell.Command.processArgument(Command.java:271)\nat org.apache.hadoop.fs.shell.Command.processArguments(Command.java:255)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processArguments(CommandWithDestination.java:220)\nat org.apache.hadoop.fs.shell.CopyCommands$Put.processArguments(CopyCommands.java:267)\nat org.apache.hadoop.fs.shell.Command.processRawArguments(Command.java:201)\nat org.apache.hadoop.fs.shell.Command.run(Command.java:165)\nat org.apache.hadoop.fs.FsShell.run(FsShell.java:287)\nat org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:70)\nat org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:84)\nat org.apache.hadoop.fs.FsShell.main(FsShell.java:340)\n\nb.\tThe second close process:\nat org.apache.hadoop.fs.FSDataOutputStream$PositionCache.close(FSDataOutputStream.java:72)\nat org.apache.hadoop.fs.FSDataOutputStream.close(FSDataOutputStream.java:106)\nat org.apache.hadoop.io.IOUtils.cleanup(IOUtils.java:244)\nat org.apache.hadoop.io.IOUtils.closeStream(IOUtils.java:261)\nat org.apache.hadoop.fs.shell.CommandWithDestination$TargetFileSystem.writeStreamToFile(CommandWithDestination.java:468)\nat org.apache.hadoop.fs.shell.CommandWithDestination.copyStreamToTarget(CommandWithDestination.java:391)\nat org.apache.hadoop.fs.shell.CommandWithDestination.copyFileToTarget(CommandWithDestination.java:328)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPath(CommandWithDestination.java:263)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPath(CommandWithDestination.java:248)\nat org.apache.hadoop.fs.shell.Command.processPaths(Command.java:317)\nat org.apache.hadoop.fs.shell.Command.processPathArgument(Command.java:289)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processPathArgument(CommandWithDestination.java:243)\nat org.apache.hadoop.fs.shell.Command.processArgument(Command.java:271)\nat org.apache.hadoop.fs.shell.Command.processArguments(Command.java:255)\nat org.apache.hadoop.fs.shell.CommandWithDestination.processArguments(CommandWithDestination.java:220)\nat org.apache.hadoop.fs.shell.CopyCommands$Put.processArguments(CopyCommands.java:267)\nat org.apache.hadoop.fs.shell.Command.processRawArguments(Command.java:201)\nat org.apache.hadoop.fs.shell.Command.run(Command.java:165)\nat org.apache.hadoop.fs.FsShell.run(FsShell.java:287)\nat org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:70)\nat org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:84)\nat org.apache.hadoop.fs.FsShell.main(FsShell.java:340)\n\n2.\tCode analysis\nvoid writeStreamToFile(InputStream in, PathData target, boolean lazyPersist) throws IOException {\n    FSDataOutputStream out = null;\n\n    try {\n        out = this.create(target, lazyPersist);\n        IOUtils.copyBytes(in, out, this.getConf(), true);\n    } finally {\n        IOUtils.closeStream(out);\n    }\n\n}\n\npublic static void copyBytes(InputStream in, OutputStream out, int buffSize, boolean close) throws IOException {\n    try {\n        copyBytes(in, out, buffSize);\n        if(close) {\n            out.close();\n            out = null;\n            in.close();\n            in = null;\n        }\n    } finally {\n        if(close) {\n            closeStream(out);\n            closeStream(in);\n        }\n    }\n}\n\nThe problem is caused by these two methods. \nFSDataOutputStream out is defined in the method writeStreamToFile, and it is a input parameter of copyBytes. When an object is as an input parameter of a API, it equals to a new reference in this API. It points to the same address with the external API. In the API copyBytes(), the code \u201cout = null\u201d means that within this API, the reference object out points to the address null, but it doesn\u2019t change the external reference object\u2019s address value. As a result, \u201cout = null\u201d is only valid for \u201ccloseStream(out)\u201d in copyBytes(), so for\u201d IOUtils.closeStream(out)\u201d  in writeStreamToFile (), out is not null in the normal process. That\u2019s why there are double close calls.\n\n3.\tSolution\na.\tSuggest solution:\nFor the input object in an API, it is not suitable to set it as null within this API. It should to be set in its defined API. And for this problem, the parameter \u201cBoolean close\u201d seems unsuitable. The close operation should be written in the definition API of \u201cFSDataOutputStream out\u201d. \nThis problem is also occurred for \u201cFSDataInputStream in\u201d which is defined in copyFileToTarget().\nThis modification solution could solve this problem thoroughly. And it makes the design to be more suitable for the file system.\nHowever, with this modification solution, there are many related code for this process. Only the \u201cpublic static void copyBytes(InputStream in, OutputStream out, int buffSize, boolean close)\u201d, there are 16 calls of this method. Considering the call path through \u201ccopyFileToTarget()\u201d to \u201ccopyBytes()\u201d and related tests to submit the patch, it will be a huge work for us. We use the above workaround solution to test our idea.\n\nb.\tOur workaround solution:\nOur solution is to add a return value to record the close status of out and in. If it has been closed, it won\u2019t be re-closed in the external API. \nThis solution could make sure the out and in are closed only once easily.\nThe details could refer to the patch. It shows the least modification for this \u201cHadoop fs -put\u201d command with this solution.\n",
        "duedate": null,
        "environment": "CentOS7.0\nJDK1.8.0_121\nhadoop2.7.3",
        "fixVersions": [],
        "issuelinks": [{
            "id": "12511442",
            "outwardIssue": {
                "fields": {
                    "issuetype": {
                        "avatarId": 21133,
                        "description": "A problem which impairs or prevents the functions of the product.",
                        "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
                        "id": "1",
                        "name": "Bug",
                        "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
                        "subtask": false
                    },
                    "priority": {
                        "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
                        "id": "3",
                        "name": "Major",
                        "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
                    },
                    "status": {
                        "description": "A patch for this issue has been uploaded to JIRA by a contributor.",
                        "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/document.png",
                        "id": "10002",
                        "name": "Patch Available",
                        "self": "https://issues.apache.org/jira/rest/api/2/status/10002",
                        "statusCategory": {
                            "colorName": "yellow",
                            "id": 4,
                            "key": "indeterminate",
                            "name": "In Progress",
                            "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/4"
                        }
                    },
                    "summary": "IOUtils#copyBytes methods should not close streams that are passed in as parameters"
                },
                "id": "12426715",
                "key": "HADOOP-5943",
                "self": "https://issues.apache.org/jira/rest/api/2/issue/12426715"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12511442",
            "type": {
                "id": "10030",
                "inward": "is related to",
                "name": "Reference",
                "outward": "relates to",
                "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"
            }
        }],
        "issuetype": {
            "avatarId": 21133,
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "id": "1",
            "name": "Bug",
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "subtask": false
        },
        "labels": [
            "close",
            "filesystem",
            "hadoop",
            "multi"
        ],
        "lastViewed": null,
        "priority": {
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "id": "3",
            "name": "Major",
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
        },
        "progress": {
            "percent": 0,
            "progress": 0,
            "total": 259200
        },
        "project": {
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310240&avatarId=10095",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310240&avatarId=10095",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310240&avatarId=10095",
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310240&avatarId=10095"
            },
            "id": "12310240",
            "key": "HADOOP",
            "name": "Hadoop Common",
            "projectCategory": {
                "description": "Scalable Distributed Computing",
                "id": "10292",
                "name": "Hadoop",
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10292"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/project/12310240"
        },
        "reporter": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Eric Lei",
            "key": "eric88",
            "name": "Eric88",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=Eric88",
            "timeZone": "Etc/UTC"
        },
        "resolution": null,
        "resolutiondate": null,
        "status": {
            "description": "A patch for this issue has been uploaded to JIRA by a contributor.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/document.png",
            "id": "10002",
            "name": "Patch Available",
            "self": "https://issues.apache.org/jira/rest/api/2/status/10002",
            "statusCategory": {
                "colorName": "yellow",
                "id": 4,
                "key": "indeterminate",
                "name": "In Progress",
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/4"
            }
        },
        "subtasks": [],
        "summary": "Shell command \"hadoop fs -put\" multiple close problem",
        "timeestimate": 259200,
        "timeoriginalestimate": 259200,
        "timespent": null,
        "updated": "2017-08-09T12:44:36.000+0000",
        "versions": [{
            "archived": false,
            "description": "2.7.3 release",
            "id": "12334005",
            "name": "2.7.3",
            "releaseDate": "2016-08-25",
            "released": true,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12334005"
        }],
        "votes": {
            "hasVoted": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HADOOP-14691/votes",
            "votes": 0
        },
        "watches": {
            "isWatching": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HADOOP-14691/watchers",
            "watchCount": 6
        },
        "workratio": 0
    },
    "id": "13090459",
    "key": "HADOOP-14691",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13090459"
}