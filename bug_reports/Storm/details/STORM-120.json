{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12684744","self":"https://issues.apache.org/jira/rest/api/2/issue/12684744","key":"STORM-120","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-03-20T22:03:08.433+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 02 13:34:02 UTC 2015","customfield_12312320":null,"customfield_12310222":null,"customfield_12310420":"363816","customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-120/watchers","watchCount":8,"isWatching":false},"created":"2013-12-15T03:11:19.777+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"customfield_12312339":null,"issuelinks":[],"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-10-09T00:27:07.441+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12327950","id":"12327950","name":"storm-core","description":"Core storm daemons and APIs including trident"}],"timeoriginalestimate":null,"description":"https://github.com/nathanmarz/storm/issues/724\n\nConcurrent calls to util/acquire-random-range-id with the same parameters can result in an IndexOutOfBoundsException, as an increment in one thread may occur after the bounds check in another. The resulting curr value can be >= the size of the List state.\n\nhttps://github.com/nathanmarz/storm/blob/fc5fbb8b352cf91050cdde4a9f9e77e673ab7f48/storm-core/src/clj/backtype/storm/util.clj#L606","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"364122","customfield_12312823":null,"summary":"util/acquire-random-range-id is not thread-safe","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xumingming","name":"xumingming","key":"xumingming","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xumingming&avatarId=18354","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xumingming&avatarId=18354","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xumingming&avatarId=18354","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xumingming&avatarId=18354"},"displayName":"James Xu","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xumingming","name":"xumingming","key":"xumingming","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xumingming&avatarId=18354","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xumingming&avatarId=18354","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xumingming&avatarId=18354","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xumingming&avatarId=18354"},"displayName":"James Xu","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13942381","id":"13942381","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"body":"We are also affected by this, seemingly every time we increase the number of tasks of an intensive bolt above the number of executors. It's not clear to me why there would be a threadsafety issue hereâ€”aren't executors single-threaded by definition? And wouldn't there be one {{shuffle-grouper}} per executor per downstream component?\n\nI would appreciate an increase of the priority of this ticket, as we seem to be wholly unable to increase our task/executor-level parallelism.\n\nHere's an example of the traceback we see:\n{code}\njava.lang.RuntimeException: java.lang.RuntimeException: java.lang.IndexOutOfBoundsException: Index: 10, Size: 10\n\tat backtype.storm.utils.DisruptorQueue.consumeBatchToCursor(DisruptorQueue.java:107)\n\tat backtype.storm.utils.DisruptorQueue.consumeBatchWhenAvailable(DisruptorQueue.java:78)\n\tat backtype.storm.disruptor$consume_batch_when_available.invoke(disruptor.clj:77)\n\tat backtype.storm.daemon.executor$eval3918$fn__3919$fn__3931$fn__3978.invoke(executor.clj:745)\n\tat backtype.storm.util$async_loop$fn__384.invoke(util.clj:433)\n\tat clojure.lang.AFn.run(AFn.java:24)\n\tat java.lang.Thread.run(Thread.java:662)\nCaused by: java.lang.RuntimeException: java.lang.IndexOutOfBoundsException: Index: 10, Size: 10\n\tat backtype.storm.task.ShellBolt.execute(ShellBolt.java:164)\n\tat backtype.storm.daemon.executor$eval3918$fn__3919$tuple_action_fn__3921.invoke(executor.clj:630)\n\tat backtype.storm.daemon.executor$mk_task_receiver$fn__3839.invoke(executor.clj:398)\n\tat backtype.storm.disruptor$clojure_handler$reify__1560.onEvent(disruptor.clj:58)\n\tat backtype.storm.utils.DisruptorQueue.consumeBatchToCursor(DisruptorQueue.java:104)\n\t... 6 more\nCaused by: java.lang.IndexOutOfBoundsException: Index: 10, Size: 10\n\tat java.util.ArrayList.RangeCheck(ArrayList.java:547)\n\tat java.util.ArrayList.get(ArrayList.java:322)\n\tat backtype.storm.util$acquire_random_range_id.invoke(util.clj:641)\n\tat backtype.storm.daemon.executor$mk_shuffle_grouper$fn__3601.invoke(executor.clj:44)\n\tat backtype.storm.daemon.task$mk_tasks_fn$fn__3372.invoke(task.clj:158)\n\tat backtype.storm.daemon.executor$eval3918$fn__3919$fn__3931$bolt_emit__3958.invoke(executor.clj:660)\n\tat backtype.storm.daemon.executor$eval3918$fn__3919$fn$reify__3964.emit(executor.clj:695)\n\tat backtype.storm.task.OutputCollector.emit(OutputCollector.java:203)\n\tat backtype.storm.task.ShellBolt.handleEmit(ShellBolt.java:232)\n\tat backtype.storm.task.ShellBolt.access$500(ShellBolt.java:66)\n\tat backtype.storm.task.ShellBolt$1.run(ShellBolt.java:129)\n\t... 1 more\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"created":"2014-03-20T22:03:08.433+0000","updated":"2014-03-20T22:03:08.433+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13943107","id":"13943107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"body":"It seems like it should be simple enough to change the acquire-random-rande-id\n{code}\n(defn acquire-random-range-id [[^MutableInt curr ^List state ^Random rand]]\n  (locking curr\n    (when (>= (.increment curr) (.size state))\n      (.set curr 0)\n      (Collections/shuffle state rand))\n    (.get state (.get curr))))\n{code}\n\nBut I agree that I want to understand better how multiple instances of this could be called in parallel on the same curr without the bolt or spout specifically doing it from multiple threads.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"created":"2014-03-21T14:43:50.019+0000","updated":"2014-03-21T14:43:50.019+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13943515","id":"13943515","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user patricklucas opened a pull request:\n\n    https://github.com/apache/incubator-storm/pull/49\n\n    Add locking in acquire-random-range-id\n\n    This fixes a threadsafety issue documented in STORM-120. This is an\n    acceptable temporary fix, but the cause of concurrent access to this\n    variable should still be identified.\n    \n    @revans2 suggested this fix.\n    \n    Refs STORM-120\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/patricklucas/incubator-storm STORM-120_fix_executor_threadsafety\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/incubator-storm/pull/49.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #49\n    \n----\ncommit ac993b43db57e8971a9a662c208f8ac07571e44d\nAuthor: Patrick Lucas <plucas@yelp.com>\nDate:   2014-03-21T20:33:56Z\n\n    Add locking in acquire-random-range-id\n    \n    This fixes a threadsafety issue documented in STORM-120. This is an\n    acceptable temporary fix, but the cause of concurrent access to this\n    variable should still be identified.\n    \n    Refs STORM-120\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-03-21T20:40:22.538+0000","updated":"2014-03-21T20:40:22.538+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13945191","id":"13945191","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"body":"We have been running topologies similar to yours for a long time now and have never seen this happen, but it sounds like this is very simple for you to reproduce this, which is great for us to try and fix it.  The trick is that we need to understand why multiple threads are calling that code at the same time for the same counter, and just reading through the code I don't see anything obvious about how that is happening.\n\nIf you could create a small topology that reproduces this issue reliably that you are willing to share with the community then we can dig into it and see what is happening.  If would rather I can try and walk you through some debugging of your existing topology, but that is going to be more difficult.  My biggest question is if the stack traces are all the same when this happens?  If you can capture as many of these stack traces as possible, it would be very helpful.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"created":"2014-03-24T15:01:29.849+0000","updated":"2014-03-24T15:01:29.849+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13945769","id":"13945769","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"body":"Sure I'll try to come up with a minimal reproducing case. In the mean time I'll collect some tracebacks. I believe they are almost always the same: an IndexOutOfBoundsError on the list of downstream tasks in a shufflegrouping, and the bad index is always the same as the size of the list. (off-by-one)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"created":"2014-03-24T22:03:52.347+0000","updated":"2014-03-24T22:03:52.347+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13946669","id":"13946669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"body":"What I am interested in is the full stack trace simply because it can give an indication of the thread that execution is happening on.  In this case we see that the shuffle code was called form backtype.storm.task.ShellBolt$1.run(ShellBolt.java:129) which is the base thread insize teh ShellBolt calling handleEmit.  If there is any other type of stack trace that shows up it could indicate how/where we are having the count object shared with other threads.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"created":"2014-03-25T15:26:03.420+0000","updated":"2014-03-25T15:26:03.420+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13955754","id":"13955754","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user patricklucas closed the pull request at:\n\n    https://github.com/apache/incubator-storm/pull/49\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-03-31T21:42:56.706+0000","updated":"2014-03-31T21:42:56.706+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13955769","id":"13955769","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"body":"[~revans2]: I haven't had a chance yet to create a minimal reproducing topology, but here are examples of the two different tracebacks we regularly see in such a topology:\n\n{code}\njava.lang.RuntimeException: java.lang.NullPointerException\n    at backtype.storm.utils.DisruptorQueue.consumeBatchToCursor(DisruptorQueue.java:107)\n    at backtype.storm.utils.DisruptorQueue.consumeBatchWhenAvailable(DisruptorQueue.java:78)\n    at backtype.storm.disruptor$consume_batch_when_available.invoke(disruptor.clj:77)\n    at backtype.storm.disruptor$consume_loop_STAR_$fn__1577.invoke(disruptor.clj:89)\n    at backtype.storm.util$async_loop$fn__384.invoke(util.clj:433)\n    at clojure.lang.AFn.run(AFn.java:24)\n    at java.lang.Thread.run(Thread.java:662)\nCaused by: java.lang.NullPointerException\n    at backtype.storm.serialization.KryoTupleSerializer.serialize(KryoTupleSerializer.java:41)\n    at backtype.storm.daemon.worker$mk_transfer_fn$fn__4217$fn__4221.invoke(worker.clj:123)\n    at backtype.storm.util$fast_list_map.invoke(util.clj:832)\n    at backtype.storm.daemon.worker$mk_transfer_fn$fn__4217.invoke(worker.clj:123)\n    at backtype.storm.daemon.executor$start_batch_transfer__GT_worker_handler_BANG_$fn__3746.invoke(executor.clj:255)\n    at backtype.storm.disruptor$clojure_handler$reify__1560.onEvent(disruptor.clj:58)\n    at backtype.storm.utils.DisruptorQueue.consumeBatchToCursor(DisruptorQueue.java:104)\n    ... 6 more\n{code}\n\nand\n\n{code}\njava.lang.RuntimeException: java.lang.RuntimeException: java.lang.IndexOutOfBoundsException: Index: 10, Size: 10\n    at backtype.storm.utils.DisruptorQueue.consumeBatchToCursor(DisruptorQueue.java:107)\n    at backtype.storm.utils.DisruptorQueue.consumeBatchWhenAvailable(DisruptorQueue.java:78)\n    at backtype.storm.disruptor$consume_batch_when_available.invoke(disruptor.clj:77)\n    at backtype.storm.daemon.executor$eval3918$fn__3919$fn__3931$fn__3978.invoke(executor.clj:745)\n    at backtype.storm.util$async_loop$fn__384.invoke(util.clj:433)\n    at clojure.lang.AFn.run(AFn.java:24)\n    at java.lang.Thread.run(Thread.java:662)\nCaused by: java.lang.RuntimeException: java.lang.IndexOutOfBoundsException: Index: 10, Size: 10\n    at backtype.storm.task.ShellBolt.execute(ShellBolt.java:164)\n    at backtype.storm.daemon.executor$eval3918$fn__3919$tuple_action_fn__3921.invoke(executor.clj:630)\n    at backtype.storm.daemon.executor$mk_task_receiver$fn__3839.invoke(executor.clj:398)\n    at backtype.storm.disruptor$clojure_handler$reify__1560.onEvent(disruptor.clj:58)\n    at backtype.storm.utils.DisruptorQueue.consumeBatchToCursor(DisruptorQueue.java:104)\n    ... 6 more\nCaused by: java.lang.IndexOutOfBoundsException: Index: 10, Size: 10\n    at java.util.ArrayList.RangeCheck(ArrayList.java:547)\n    at java.util.ArrayList.get(ArrayList.java:322)\n    at backtype.storm.util$acquire_random_range_id.invoke(util.clj:641)\n    at backtype.storm.daemon.executor$mk_shuffle_grouper$fn__3601.invoke(executor.clj:44)\n    at backtype.storm.daemon.task$mk_tasks_fn$fn__3372.invoke(task.clj:158)\n    at backtype.storm.daemon.executor$eval3918$fn__3919$fn__3931$bolt_emit__3958.invoke(executor.clj:660)\n    at backtype.storm.daemon.executor$eval3918$fn__3919$fn$reify__3964.emit(executor.clj:695)\n    at backtype.storm.task.OutputCollector.emit(OutputCollector.java:203)\n    at backtype.storm.task.ShellBolt.handleEmit(ShellBolt.java:232)\n    at backtype.storm.task.ShellBolt.access$500(ShellBolt.java:66)\n    at backtype.storm.task.ShellBolt$1.run(ShellBolt.java:129)\n    ... 1 more\n{code}\n\nThis is happening to us in the following situation:\n * The upstream bolt has m executors and 2*m tasks\n * The downstream bolt has m executors and 2*m tasks\n * The downstream bolt uses a shuffle grouping from a non-default stream of the upstream bolt\n * When the upstream bolt has the same number of tasks as executors, this does not happen, even if the downstream bolt is m/2*m.\n\nThe traceback occurs where the upstream bolt chooses the downstream task to which to send a tuple.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"created":"2014-03-31T21:54:53.902+0000","updated":"2014-03-31T21:54:53.902+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13956025","id":"13956025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"body":"I tried adding locking as a temporary fix. This eliminated the IndexOutOfBoundsException, but the NullPointerException remains (albeit with slightly different line numbers due to running v0.9.2-incubating-SNAPSHOT):\n\n{code}\njava.lang.RuntimeException: java.lang.NullPointerException\n    at backtype.storm.utils.DisruptorQueue.consumeBatchToCursor(DisruptorQueue.java:107)\n    at backtype.storm.utils.DisruptorQueue.consumeBatchWhenAvailable(DisruptorQueue.java:78)\n    at backtype.storm.disruptor$consume_batch_when_available.invoke(disruptor.clj:77)\n    at backtype.storm.disruptor$consume_loop_STAR_$fn__1577.invoke(disruptor.clj:89)\n    at backtype.storm.util$async_loop$fn__384.invoke(util.clj:433)\n    at clojure.lang.AFn.run(AFn.java:24)\n    at java.lang.Thread.run(Thread.java:662)\nCaused by: java.lang.NullPointerException\n    at backtype.storm.serialization.KryoTupleSerializer.serialize(KryoTupleSerializer.java:41)\n    at backtype.storm.daemon.worker$mk_transfer_fn$fn__4217$fn__4221.invoke(worker.clj:123)\n    at backtype.storm.util$fast_list_map.invoke(util.clj:832)\n    at backtype.storm.daemon.worker$mk_transfer_fn$fn__4217.invoke(worker.clj:123)\n    at backtype.storm.daemon.executor$start_batch_transfer__GT_worker_handler_BANG_$fn__3746.invoke(executor.clj:255)\n    at backtype.storm.disruptor$clojure_handler$reify__1560.onEvent(disruptor.clj:58)\n    at backtype.storm.utils.DisruptorQueue.consumeBatchToCursor(DisruptorQueue.java:104)\n    ... 6 more\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"created":"2014-04-01T02:18:58.517+0000","updated":"2014-04-01T02:18:58.517+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13957182","id":"13957182","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"body":"Regarding the NullPointerException, it seems that a null tuple is being enqueued for transmission by Disruptor in this function, but I'm not familiar with the Storm code going up to have an intuition of where it might be coming from:\n\n{code:clojure}\n(defn mk-transfer-fn [worker]\n  (let [local-tasks (-> worker :task-ids set)\n        local-transfer (:transfer-local-fn worker)\n        ^DisruptorQueue transfer-queue (:transfer-queue worker)]\n    (fn [^KryoTupleSerializer serializer tuple-batch]\n      (let [local (ArrayList.)\n            remote (ArrayList.)]\n        (fast-list-iter [[task tuple :as pair] tuple-batch]\n          (if (local-tasks task)\n            (.add local pair)\n            (.add remote pair)\n            ))\n        (local-transfer local)\n        ;; not using map because the lazy seq shows up in perf profiles\n        (let [serialized-pairs (fast-list-for [[task ^TupleImpl tuple] remote] [task (.serialize serializer tuple)])]\n          (disruptor/publish transfer-queue serialized-pairs)\n          )))))\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"created":"2014-04-02T00:21:19.668+0000","updated":"2014-04-02T00:21:19.668+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13972138","id":"13972138","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"body":"I believe I'm closing in on a cause: I don't think ShellBolts (and presumably spouts) are threadsafe when there are multiple running in a single executor.\n\nIn ShellBolt.prepare, two threads are created: [one|https://github.com/apache/incubator-storm/blob/1a0b46e95ab4ac467525314a75819a75dec92c40/storm-core/src/jvm/backtype/storm/task/ShellBolt.java#L109] for reading from a synchronous queue of events populated by ShellBolt.execute and writing to stdin of the subprocess, and [one|https://github.com/apache/incubator-storm/blob/1a0b46e95ab4ac467525314a75819a75dec92c40/storm-core/src/jvm/backtype/storm/task/ShellBolt.java#L141] for reading from stdout of the subprocess and calling emit/ack/fail/etc. on the OutputCollector. I believe these calls are the source of the thread safety problems.\n\nIf there are two ShellBolt tasks in the same executor, there will be two \"readerThread\"s emitting in parallel. These calls need to be synchronized on some aspect of the OutputCollector: To test this theory, I [patched|https://github.com/patricklucas/incubator-storm/blob/caeb80d3402fa4eeae7e03871379c18f8f4e8838/storm-core/src/clj/backtype/storm/daemon/executor.clj#L689] Storm to lock on the executor's grouper, and have not seen any of these errors having turned up the tasks-per-executor on my bolts. (I don't intend to offer this patch to merge; just as a proof-of-concept)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=plucas","name":"plucas","key":"plucas","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Lucas","active":true,"timeZone":"Europe/Berlin"},"created":"2014-04-17T00:32:51.946+0000","updated":"2014-04-17T00:32:51.946+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/13972266","id":"13972266","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marz","name":"marz","key":"marz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nathan Marz","active":true,"timeZone":"Etc/UTC"},"body":"Good catch, you are absolutely correct about that being the cause. I'm not sure on the best fix, the two approaches would be to either lock like your proposed, or to insert a queue in front of the OutputCollector and make sure only one thread ever writes to it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marz","name":"marz","key":"marz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nathan Marz","active":true,"timeZone":"Etc/UTC"},"created":"2014-04-17T03:27:30.997+0000","updated":"2014-04-17T03:27:30.997+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684744/comment/14569103","id":"14569103","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brianghig","name":"brianghig","key":"brianghig","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Ghigiarelli","active":true,"timeZone":"America/New_York"},"body":"Any progress on this bug? With parallel streams for Collections in Java 8, this issue seems like it should bump up in priority.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brianghig","name":"brianghig","key":"brianghig","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Ghigiarelli","active":true,"timeZone":"America/New_York"},"created":"2015-06-02T13:34:02.127+0000","updated":"2015-06-02T13:34:02.127+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-120/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1qpmf:"}}