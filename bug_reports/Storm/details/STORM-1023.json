{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12860990","self":"https://issues.apache.org/jira/rest/api/2/issue/12860990","key":"STORM-1023","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2015-09-01 12:14:25.805","customfield_12312320":null,"customfield_12310222":null,"customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-1023/watchers","watchCount":1,"isWatching":false},"created":"2015-09-01T12:14:25.805+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12327112","id":"12327112","name":"0.9.3","archived":false,"released":true,"releaseDate":"2014-11-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12327123","id":"12327123","description":"security feature branch","name":"0.10.0","archived":false,"released":true,"releaseDate":"2015-11-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12329548","id":"12329548","name":"0.9.4","archived":false,"released":true,"releaseDate":"2015-03-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12329843","id":"12329843","name":"1.0.0","archived":false,"released":true,"releaseDate":"2016-04-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12332476","id":"12332476","name":"0.9.5","archived":false,"released":true,"releaseDate":"2015-06-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12333021","id":"12333021","name":"0.9.6","archived":false,"released":true,"releaseDate":"2015-11-05"}],"customfield_12312339":null,"issuelinks":[],"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-09-30T01:00:56.949+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12327950","id":"12327950","name":"storm-core","description":"Core storm daemons and APIs including trident"}],"timeoriginalestimate":null,"description":"Testing environment is Storm 0.9.5 / thrift java 0.7.\nTest scenario: \n  Deploy storm topology in loop.\n  When nimbus cleanup timeout is reached, an error is thrown by thrift server: \n  \"Exception while invoking ...\" ... TException\n\nTest result:\n  Thrift java server in nimbus goes 100% CPU in infinite loop in:\n\njstack:\n{code}\n\"Thread-5\" prio=10 tid=0x00007fb134aab800 nid=0x6767 runnable [0x00007fb129c9b000]\n   java.lang.Thread.State: RUNNABLE\n                                      at sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)\n                                      at sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:269)\n                                      at sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:79)\n                                      at sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:87)\n...\nat org.apache.thrift7.server.TNonblockingServer$SelectThread.select(TNonblockingServer.java:284) \n{code}\n\nstrace:\n{code}\nepoll_wait(70, {{EPOLLIN, {u32=866, u64=866}}, {EPOLLIN, {u32=876, u64=876}}}, 4096, 4294967295) = 2\n{code}\n\nInvestigation and tests show that:\nAny Exception thrown during the processor execution will bypass the call to {code} responseReady() {code} and will cause the counter {code}       readBufferBytesAllocated.addAndGet(-buffer_.array().length); {code} not to be decremented by the size of the request buffer.\n\nAfter a bunch of failed requests, this counter almost reaches the max value MAX_READ_BUFFER_BYTES causing any subsequent request to be delayed forever because the following test in {code} read() {code}:\n{code}           if (readBufferBytesAllocated.get() + frameSize > MAX_READ_BUFFER_BYTES)  {code} is always true.\n\nAt the end, the server thread loops in select() which immediately wakes up for read() since the content of the socket was never drained.\n\nThis loops forever between select and read() method above causing a 100% CPU on server thread.\nMoreover, all client requests are stuck forever.\n\nExample of failed request:\n{code}\n2015-09-01T12:19:35.954+0200 b.s.d.nimbus [WARN] Topology submission exception. (topology name='mytopology') #<IllegalArgumentException java.lang.IllegalArgumentException: /opt/SPE/share/stor\nm/storm/local/nimbus/inbox/stormjar-3f8f3ba7-5420-4773-af24-bfa294cceb79.jar to copy to /opt/SPE/share/storm/storm/local/nimbus/stormdist/mytopology-87-1441102775 does not exist!>\n2015-09-01T12:19:35.955+0200 o.a.t.s.TNonblockingServer [ERROR] Unexpected exception while invoking!\njava.lang.IllegalArgumentException: /opt/SPE/share/storm/storm/local/nimbus/inbox/stormjar-3f8f3ba7-5420-4773-af24-bfa294cceb79.jar to copy to /opt/SPE/share/storm/storm/local/nimbus/stormdis\nt/mytopology-87-1441102775 does not exist!\n        at backtype.storm.daemon.nimbus$fn__3827.invoke(nimbus.clj:1173) ~[storm-core-0.9.5.jar:0.9.5]\n        at clojure.lang.MultiFn.invoke(MultiFn.java:236) ~[clojure-1.5.1.jar:na]\n        at backtype.storm.daemon.nimbus$setup_storm_code.invoke(nimbus.clj:307) ~[storm-core-0.9.5.jar:0.9.5]\n        at backtype.storm.daemon.nimbus$fn__3724$exec_fn__1103__auto__$reify__3737.submitTopologyWithOpts(nimbus.clj:953) ~[storm-core-0.9.5.jar:0.9.5]\n        at backtype.storm.daemon.nimbus$fn__3724$exec_fn__1103__auto__$reify__3737.submitTopology(nimbus.clj:966) ~[storm-core-0.9.5.jar:0.9.5]\n        at backtype.storm.generated.Nimbus$Processor$submitTopology.getResult(Nimbus.java:1240) ~[storm-core-0.9.5.jar:0.9.5]\n        at backtype.storm.generated.Nimbus$Processor$submitTopology.getResult(Nimbus.java:1228) ~[storm-core-0.9.5.jar:0.9.5]\n        at org.apache.thrift7.ProcessFunction.process(ProcessFunction.java:32) ~[storm-core-0.9.5.jar:0.9.5]\n        at org.apache.thrift7.TBaseProcessor.process(TBaseProcessor.java:34) ~[storm-core-0.9.5.jar:0.9.5]\n        at org.apache.thrift7.server.TNonblockingServer$FrameBuffer.invoke(TNonblockingServer.java:632) ~[storm-core-0.9.5.jar:0.9.5]\n        at org.apache.thrift7.server.THsHaServer$Invocation.run(THsHaServer.java:201) [storm-core-0.9.5.jar:0.9.5]\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_75]\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_75]\n        at java.lang.Thread.run(Thread.java:745) [na:1.7.0_75]\n{code} ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Nimbus server hogs 100% CPU and clients are stuck ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fmazoyer","name":"fmazoyer","key":"fmazoyer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Frantz Mazoyer","active":true,"timeZone":"Europe/Paris"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fmazoyer","name":"fmazoyer","key":"fmazoyer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Frantz Mazoyer","active":true,"timeZone":"Europe/Paris"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"Storm 0.9.5 / thrift 0.7","customfield_12313520":null,"customfield_12311020":"https://issues.apache.org/jira/browse/THRIFT-3313","duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-1023/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2jncn:"}}