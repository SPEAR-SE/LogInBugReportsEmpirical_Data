{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13100825","self":"https://issues.apache.org/jira/rest/api/2/issue/13100825","key":"STORM-2732","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":2400,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false}],"aggregatetimespent":2400,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-09-11T15:42:53.353+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Sep 11 15:42:53 UTC 2017","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_624906_*|*_3_*:*_1_*:*_263369362_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2017-09-11T15:42:53.302+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2732/watchers","watchCount":2,"isWatching":false},"created":"2017-09-08T14:22:59.098+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ethanli","name":"ethanli","key":"ethanli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ethanli&avatarId=32192","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ethanli&avatarId=32192","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ethanli&avatarId=32192","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ethanli&avatarId=32192"},"displayName":"Ethan Li","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-09-11T15:42:53.358+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324395","id":"12324395","name":"storm-hdfs","description":"Storm HDFS Integration"}],"timeoriginalestimate":null,"description":"WritersMap only keeps maxWriters number of Writers. It will automatically remove the eldest entry to keep the number of entries in the WritersMap under maxWriters limit. But it doesn't close the removed writer, which could lead to potential data loss.","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"40m","remainingEstimateSeconds":0,"timeSpentSeconds":2400},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Eldest writer is not closed when removed from WritersMap","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ethanli","name":"ethanli","key":"ethanli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ethanli&avatarId=32192","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ethanli&avatarId=32192","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ethanli&avatarId=32192","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ethanli&avatarId=32192"},"displayName":"Ethan Li","active":true,"timeZone":"America/Chicago"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ethanli","name":"ethanli","key":"ethanli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ethanli&avatarId=32192","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ethanli&avatarId=32192","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ethanli&avatarId=32192","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ethanli&avatarId=32192"},"displayName":"Ethan Li","active":true,"timeZone":"America/Chicago"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":2400,"total":2400,"percent":100},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":2400,"total":2400,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13100825/comment/16161459","id":"16161459","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"body":"Thanks [~ethanli],\n\nI merged this into master.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"created":"2017-09-11T15:42:53.353+0000","updated":"2017-09-11T15:42:53.353+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2732/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":4,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13100825/worklog/51958","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user Ethanlm opened a pull request:\n\n    https://github.com/apache/storm/pull/2315\n\n    [STORM-2732] Close the eldest writer before removing it from WritersMap\n\n    [JIRA-STORM-2732](https://issues.apache.org/jira/browse/STORM-2732)\n    \n    `WritersMap` serves as an LRU cache for `maxWriters` number of `Writer`s. But it doesn't close the removed writer, which could lead to potential data loss.\n    \n    The exception handling is really hard. The bolt behaviors depend on later on situations. I don't know how to address the exception handling currently so I chose to just log the error which is also what we have done elsewhere in this class.\n    \n    --------\n    \n    I wanted to discuss about what would happen. Please correct me if I am wrong.\n    #### Case 1\n    If `eldest.getValue().close()` failed, assume next tuple invokes SyncPolicy but the sync failed, then the bolt will call `collector.fail()` on all the tuples in `tupleBatch`. In this case, all those tuples will be transferred again, which gives the bolt another chance to write those tuples later.  However, if some tuples has been written to hdfs before `eldest.getValue().close()` failed, these tuples could be written to hdfs **twice**. \n    \n    #### Case 2\n    If `eldest.getValue().close()` failed, assume next tuple invokes SyncPolicy and the sync succeed, then the bolt will call `collector.ack()` on all the tuples in `tupleBatch`. Then the lost data because of  `eldest.getValue().close()` failure will not be transferred to the bolt again, which means they are **lost** permanently .\n    \n    #### Case 3\n    If `eldest.getValue().close()` succeeded, assume next tuple invokes SyncPolicy but the sync failed, then the bolt will call `collector.fail()` on all the tuples in `tupleBatch`. Then the tuples have been written to hdfs by `eldest.getValue().close()`  will be transferred to the bolt again. Potentially they could be written **twice**.\n    \n    The same issues apply to the calling to `doRotationAndRemoveWriter()`. The behaviors are not consistent.  We might want to have a better way to deal with exceptions.\n    \n    \n    \n\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/Ethanlm/storm STORM-2732\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2315.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2315\n    \n----\ncommit 56fefea364a1fdcf92352d873ac56d4ba6dc4243\nAuthor: Ethan Li <ethanopensource@gmail.com>\nDate:   2017-09-08T19:17:50Z\n\n    [STORM-2732] Close the eldest writer before removing it from WritersMap\n\n----\n","created":"2017-09-08T19:51:18.828+0000","updated":"2017-09-08T19:51:18.828+0000","started":"2017-09-08T19:51:18.826+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"51958","issueId":"13100825"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13100825/worklog/52090","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user revans2 commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2315#discussion_r138088942\n  \n    --- Diff: external/storm-hdfs/src/main/java/org/apache/storm/hdfs/bolt/AbstractHdfsBolt.java ---\n    @@ -317,7 +319,18 @@ public WritersMap(long maxWriters) {\n     \n             @Override\n             protected boolean removeEldestEntry(Map.Entry<String, Writer> eldest) {\n    -            return this.size() > this.maxWriters;\n    +            if (this.size() > this.maxWriters) {\n    +                //The writer must be closed before removed from the map.\n    +                //If it failed, we might lose some data.\n    +                try {\n    +                    eldest.getValue().close();\n    +                } catch (IOException e) {\n    +                    LOG.error(\"Failed to close the eldest Writer\");\n    --- End diff --\n    \n    Would it be possible to report the error here like we do in other places in the code?\n    \n    ```\n    this.collector.reportError(e);\n    ```\n    \n    It would also be create if you could add it to `doRotationAndRemoveAllWriters` too just so it is consistent everywhere.\n","created":"2017-09-11T14:35:04.261+0000","updated":"2017-09-11T14:35:04.261+0000","started":"2017-09-11T14:35:04.260+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"52090","issueId":"13100825"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13100825/worklog/52107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user Ethanlm commented on the issue:\n\n    https://github.com/apache/storm/pull/2315\n  \n    Thanks @revans2  . I forgot it.  Addressed in the latest commit (and squashed).\n","created":"2017-09-11T15:21:57.997+0000","updated":"2017-09-11T15:21:57.997+0000","started":"2017-09-11T15:21:57.996+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"52107","issueId":"13100825"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13100825/worklog/52110","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/storm/pull/2315\n","created":"2017-09-11T15:42:32.278+0000","updated":"2017-09-11T15:42:32.278+0000","started":"2017-09-11T15:42:32.276+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"52110","issueId":"13100825"}]},"customfield_12311820":"0|i3jtpz:"}}