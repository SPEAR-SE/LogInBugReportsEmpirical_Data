{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13071199","self":"https://issues.apache.org/jira/rest/api/2/issue/13071199","key":"STORM-2509","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":1200,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[],"aggregatetimespent":1200,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu May 11 15:05:26 UTC 2017","customfield_12312320":null,"customfield_12310222":null,"customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2509/watchers","watchCount":1,"isWatching":false},"created":"2017-05-11T15:03:12.967+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335748","id":"12335748","name":"1.1.0","archived":false,"released":true,"releaseDate":"2017-03-29"}],"customfield_12312339":null,"issuelinks":[],"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-06-09T08:58:51.322+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324395","id":"12324395","name":"storm-hdfs","description":"Storm HDFS Integration"}],"timeoriginalestimate":null,"description":"When the eldest entry in the WritersMap in the AbstractHDFSBolt gets removed due to the number of writers exceeding maxWriters (see below), the writer is not closed and rotation actions are not executed (doRotationAndRemoveWriter is not called).\n\n{code}\nstatic class WritersMap extends LinkedHashMap<String, AbstractHDFSWriter> {\n    final long maxWriters;\n\n    public WritersMap(long maxWriters) {\n        super((int)maxWriters, 0.75f, true);\n        this.maxWriters = maxWriters;\n    }\n\n    @Override\n    protected boolean removeEldestEntry(Map.Entry<String, AbstractHDFSWriter> eldest) {\n        return this.size() > this.maxWriters;\n    }\n}\n{code}","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"20m","remainingEstimateSeconds":0,"timeSpentSeconds":1200},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Writers in AbstractHDFSBolt are not closed/rotated when evicted from WritersMap","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpersaud","name":"rpersaud","key":"rpersaud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Persaud","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpersaud","name":"rpersaud","key":"rpersaud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Persaud","active":true,"timeZone":"Etc/UTC"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":1200,"total":1200,"percent":100},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":1200,"total":1200,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13071199/comment/16006598","id":"16006598","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpersaud","name":"rpersaud","key":"rpersaud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Persaud","active":true,"timeZone":"Etc/UTC"},"body":"I used code in the HiveBolt as a starting point for handling retiring writers (see below), and I'll create a PR with the same:\n\n{code}\n // Setting accessOrder to true to facilitate obtaining the LRU  entry\n writers = new LinkedHashMap<>(this.maxOpenFiles, 0.75f, true);\n\nprivate AbstractHDFSWriter getOrCreateWriter(String writerKey, Tuple tuple) throws IOException {\n    AbstractHDFSWriter writer = writers.get( writerKey );\n    if (writer == null) {\n        LOG.debug(\"Creating Writer for writerKey : \" + writerKey);\n        Path pathForNextFile = getBasePathForNextFile(tuple);\n        writer = makeNewWriter(pathForNextFile, tuple);\n\n        if (writers.size() > (this.maxOpenFiles - 1)) {\n            LOG.info(\"cached writers size {} exceeded maxOpenFiles {} \", writers.size(), this.maxOpenFiles);\n            retireEldestWriter();\n        }\n        this.writers.put(writerKey, writer);\n    }\n    return writer;\n}\n\n/**\n * Locate writer that has not been used for longest time and retire it\n */\nprivate void retireEldestWriter() throws IOException {\n    LOG.info(\"Attempting to close eldest writer\");\n    Iterator<String> iterator = this.writers.keySet().iterator();\n    if (iterator.hasNext()) {\n        String eldestKey = iterator.next();\n        doRotationAndRemoveWriter(eldestKey, this.writers.get(eldestKey));\n    }\n}\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpersaud","name":"rpersaud","key":"rpersaud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Persaud","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-11T15:05:26.553+0000","updated":"2017-05-11T15:24:48.604+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2509/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":2,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13071199/worklog/42956","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user ryanpersaud opened a pull request:\n\n    https://github.com/apache/storm/pull/2119\n\n    STORM-2509 Close and perform rotation actions for retired writers in …\n\n    …AbstractHDFSBolt.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/ryanpersaud/storm storm-2509\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2119.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2119\n    \n----\ncommit a51494c0ec4a5b47077a4eca5741b8a514f2e4b2\nAuthor: Ryan Persaud <ryan.persaud@gmail.com>\nDate:   2017-05-16T20:05:12Z\n\n    STORM-2509 Close and perform rotation actions for retired writers in AbstractHDFSBolt.\n\n----\n","created":"2017-05-16T20:11:31.987+0000","updated":"2017-05-16T20:11:31.987+0000","started":"2017-05-16T20:11:31.986+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"42956","issueId":"13071199"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13071199/worklog/44551","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/2119\n  \n    @ryanpersaud Thanks for contributing. We introduced checkstyle and the build is failing with checkstyle violation. Could you fix the violation from your changeset and update the patch?\n","created":"2017-06-09T08:58:51.316+0000","updated":"2017-06-09T08:58:51.316+0000","started":"2017-06-09T08:58:51.315+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"44551","issueId":"13071199"}]},"customfield_12311820":"0|i3euaf:"}}