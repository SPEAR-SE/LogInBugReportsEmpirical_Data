{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13132922","self":"https://issues.apache.org/jira/rest/api/2/issue/13132922","key":"STORM-2906","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":5400,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341047","id":"12341047","name":"1.2.0","archived":false,"released":true,"releaseDate":"2018-02-15"}],"aggregatetimespent":5400,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-01-23T05:05:22.838+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Feb 01 14:20:25 UTC 2018","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_16293_*|*_3_*:*_1_*:*_813182890_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2018-02-01T14:20:25.321+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2906/watchers","watchCount":2,"isWatching":false},"created":"2018-01-23T04:27:06.176+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":["pull-request-available"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-02-01T14:20:25.351+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324394","id":"12324394","name":"storm-hbase","description":"Storm HBase Integration"}],"timeoriginalestimate":null,"description":"We have observed that the topology which has HDFS and HBase bolts fails with GSS exception no valid credentials.","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"1.5h","remainingEstimateSeconds":0,"timeSpentSeconds":5400},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"HDFS and HBase bolt on the same worker fails with GSS no valid credentials exception","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=santhoshbg","name":"santhoshbg","key":"santhoshbg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Santhosh B Gowda","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":5400,"total":5400,"percent":100},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":5400,"total":5400,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/comment/16335386","id":"16335386","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"[~satish.duggana] stated that it doesn't occur when HDFS and HBase bolts are running in different workers.\r\n\r\nAfter some investigation I found the cause, \r\n\r\n[https://github.com/apache/storm/blob/6402d436a8700eb743ccd84f7f562c51d8cf9be7/external/storm-hbase/src/main/java/org/apache/storm/hbase/common/Utils.java#L39-L65]\r\n\r\n \r\n{code:java}\r\n    public static HTable getTable(UserProvider provider, final Configuration config, final String tableName)\r\n            throws IOException, InterruptedException {\r\n        UserGroupInformation ugi;\r\n        if (provider != null) {\r\n            ugi = provider.getCurrent().getUGI();\r\n            LOG.debug(\"Current USER for provider: {}\", ugi.getUserName());\r\n        } else {\r\n            // autocreds puts delegation token into current user UGI\r\n            ugi = UserGroupInformation.getCurrentUser();\r\n\r\n\r\n            LOG.debug(\"UGI for current USER : {}\", ugi.getUserName());\r\n            for (Token<? extends TokenIdentifier> token : ugi.getTokens()) {\r\n                LOG.debug(\"Token in UGI (delegation token): {} / {}\", token.toString(),\r\n                        token.decodeIdentifier().getUser());\r\n\r\n\r\n                // use UGI from token\r\n                ugi = token.decodeIdentifier().getUser();\r\n                ugi.addToken(token);\r\n            }\r\n        }\r\n\r\n\r\n        return ugi.doAs(new PrivilegedExceptionAction<HTable>() {\r\n            @Override public HTable run() throws IOException {\r\n                return new HTable(config, tableName);\r\n            }\r\n        });\r\n    }{code}\r\nUGI is always selected from last element of tokens, and unfortunately tokens have HDFS delegation tokens as well. So we should check kind of token (HBASE_AUTH_TOKEN) before leveraging it.\r\n\r\nIf nimbus can distribute tokens based on worker, then it will not occur when HDFS and HBase bolts are running different workers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2018-01-23T05:05:22.838+0000","updated":"2018-01-23T05:05:22.838+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/comment/16348636","id":"16348636","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"Merged into master and 1.x-branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2018-02-01T14:20:25.347+0000","updated":"2018-02-01T14:20:25.347+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2906/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":9,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/worklog/67492","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user HeartSaVioR opened a pull request:\n\n    https://github.com/apache/storm/pull/2527\n\n    STORM-2906 Pick HBase delegation token properly while handling HBase …\n\n    …auth via delegation token\r\n    \r\n    Please refer [STORM-2906](https://issues.apache.org/jira/browse/STORM-2906) to see more details.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/HeartSaVioR/storm STORM-2906\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2527.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2527\n    \n----\ncommit d291f39c9aa6e29184a2712797e956b42cae3293\nAuthor: Jungtaek Lim <kabhwan@...>\nDate:   2018-01-23T04:34:22Z\n\n    STORM-2906 Pick HBase delegation token properly while handling HBase auth via delegation token\n\n----\n","created":"2018-01-23T04:37:06.136+0000","updated":"2018-01-23T04:37:06.136+0000","started":"2018-01-23T04:37:06.135+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"67492","issueId":"13132922"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/worklog/67526","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user satishd commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2527#discussion_r163188315\n  \n    --- Diff: external/storm-hbase/src/main/java/org/apache/storm/hbase/common/Utils.java ---\n    @@ -47,14 +48,28 @@ public static HTable getTable(UserProvider provider, Configuration config, Strin\n                 ugi = UserGroupInformation.getCurrentUser();\n     \n                 LOG.debug(\"UGI for current USER : {}\", ugi.getUserName());\n    +            boolean foundHBaseAuthToken = false;\n                 for (Token<? extends TokenIdentifier> token : ugi.getTokens()) {\n                     LOG.debug(\"Token in UGI (delegation token): {} / {}\", token.toString(),\n                             token.decodeIdentifier().getUser());\n     \n    -                // use UGI from token\n    -                ugi = token.decodeIdentifier().getUser();\n    -                ugi.addToken(token);\n    +                // token.getKind() = Text, Text is annotated by @Stringable\n    +                // which ensures toString() implementation\n    +                if (token.getKind().toString().equals(TOKEN_KIND_HBASE_AUTH_TOKEN)) {\n    +                    // use UGI from token\n    +                    LOG.debug(\"Found HBASE_AUTH_TOKEN - using the token to replace current user.\");\n    +\n    +                    ugi = token.decodeIdentifier().getUser();\n    +                    ugi.addToken(token);\n    +\n    +                    foundHBaseAuthToken = true;\n    --- End diff --\n    \n    @HeartSaVioR Can there be more than one HBASE_AUTH_TOKEN token for the current UGI?\n","created":"2018-01-23T09:42:49.504+0000","updated":"2018-01-23T09:42:49.504+0000","started":"2018-01-23T09:42:49.503+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"67526","issueId":"13132922"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/worklog/67539","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2527#discussion_r163216104\n  \n    --- Diff: external/storm-hbase/src/main/java/org/apache/storm/hbase/common/Utils.java ---\n    @@ -47,14 +48,28 @@ public static HTable getTable(UserProvider provider, Configuration config, Strin\n                 ugi = UserGroupInformation.getCurrentUser();\n     \n                 LOG.debug(\"UGI for current USER : {}\", ugi.getUserName());\n    +            boolean foundHBaseAuthToken = false;\n                 for (Token<? extends TokenIdentifier> token : ugi.getTokens()) {\n                     LOG.debug(\"Token in UGI (delegation token): {} / {}\", token.toString(),\n                             token.decodeIdentifier().getUser());\n     \n    -                // use UGI from token\n    -                ugi = token.decodeIdentifier().getUser();\n    -                ugi.addToken(token);\n    +                // token.getKind() = Text, Text is annotated by @Stringable\n    +                // which ensures toString() implementation\n    +                if (token.getKind().toString().equals(TOKEN_KIND_HBASE_AUTH_TOKEN)) {\n    +                    // use UGI from token\n    +                    LOG.debug(\"Found HBASE_AUTH_TOKEN - using the token to replace current user.\");\n    +\n    +                    ugi = token.decodeIdentifier().getUser();\n    +                    ugi.addToken(token);\n    +\n    +                    foundHBaseAuthToken = true;\n    --- End diff --\n    \n    I don't think if there's one HBase cluster needed to be connected in worker, but not sure if there're more than one HBase clusters. If we need to consider and handle multiple tokens, matching token would be completely different scenario.\n","created":"2018-01-23T11:31:53.728+0000","updated":"2018-01-23T11:31:53.728+0000","started":"2018-01-23T11:31:53.726+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"67539","issueId":"13132922"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/worklog/67625","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2527#discussion_r163403457\n  \n    --- Diff: external/storm-hbase/src/main/java/org/apache/storm/hbase/common/Utils.java ---\n    @@ -47,14 +48,28 @@ public static HTable getTable(UserProvider provider, Configuration config, Strin\n                 ugi = UserGroupInformation.getCurrentUser();\n     \n                 LOG.debug(\"UGI for current USER : {}\", ugi.getUserName());\n    +            boolean foundHBaseAuthToken = false;\n                 for (Token<? extends TokenIdentifier> token : ugi.getTokens()) {\n                     LOG.debug(\"Token in UGI (delegation token): {} / {}\", token.toString(),\n                             token.decodeIdentifier().getUser());\n     \n    -                // use UGI from token\n    -                ugi = token.decodeIdentifier().getUser();\n    -                ugi.addToken(token);\n    +                // token.getKind() = Text, Text is annotated by @Stringable\n    +                // which ensures toString() implementation\n    +                if (token.getKind().toString().equals(TOKEN_KIND_HBASE_AUTH_TOKEN)) {\n    +                    // use UGI from token\n    +                    LOG.debug(\"Found HBASE_AUTH_TOKEN - using the token to replace current user.\");\n    +\n    +                    ugi = token.decodeIdentifier().getUser();\n    +                    ugi.addToken(token);\n    +\n    +                    foundHBaseAuthToken = true;\n    --- End diff --\n    \n    I didn't test it actually, but looks like we don't support it, since we are only using **one** of tokens. Not sure HDFS/Hive bolt supports it, too.\n","created":"2018-01-23T22:54:50.171+0000","updated":"2018-01-23T22:54:50.171+0000","started":"2018-01-23T22:54:50.171+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"67625","issueId":"13132922"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/worklog/67651","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user satishd commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2527#discussion_r163450608\n  \n    --- Diff: external/storm-hbase/src/main/java/org/apache/storm/hbase/common/Utils.java ---\n    @@ -47,14 +48,28 @@ public static HTable getTable(UserProvider provider, Configuration config, Strin\n                 ugi = UserGroupInformation.getCurrentUser();\n     \n                 LOG.debug(\"UGI for current USER : {}\", ugi.getUserName());\n    +            boolean foundHBaseAuthToken = false;\n                 for (Token<? extends TokenIdentifier> token : ugi.getTokens()) {\n                     LOG.debug(\"Token in UGI (delegation token): {} / {}\", token.toString(),\n                             token.decodeIdentifier().getUser());\n     \n    -                // use UGI from token\n    -                ugi = token.decodeIdentifier().getUser();\n    -                ugi.addToken(token);\n    +                // token.getKind() = Text, Text is annotated by @Stringable\n    +                // which ensures toString() implementation\n    +                if (token.getKind().toString().equals(TOKEN_KIND_HBASE_AUTH_TOKEN)) {\n    +                    // use UGI from token\n    +                    LOG.debug(\"Found HBASE_AUTH_TOKEN - using the token to replace current user.\");\n    +\n    +                    ugi = token.decodeIdentifier().getUser();\n    +                    ugi.addToken(token);\n    +\n    +                    foundHBaseAuthToken = true;\n    --- End diff --\n    \n    @HeartSaVioR There should not be multiple tokens with HBASE_AUTH_TOKEN key with the current implementation. It is better to log a message(atleast with info level) if we find multiple tokens so that it is easy to debug such scenarios.\n","created":"2018-01-24T04:29:02.364+0000","updated":"2018-01-24T04:29:02.364+0000","started":"2018-01-24T04:29:02.363+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"67651","issueId":"13132922"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/worklog/67660","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2527#discussion_r163456585\n  \n    --- Diff: external/storm-hbase/src/main/java/org/apache/storm/hbase/common/Utils.java ---\n    @@ -47,14 +48,28 @@ public static HTable getTable(UserProvider provider, Configuration config, Strin\n                 ugi = UserGroupInformation.getCurrentUser();\n     \n                 LOG.debug(\"UGI for current USER : {}\", ugi.getUserName());\n    +            boolean foundHBaseAuthToken = false;\n                 for (Token<? extends TokenIdentifier> token : ugi.getTokens()) {\n                     LOG.debug(\"Token in UGI (delegation token): {} / {}\", token.toString(),\n                             token.decodeIdentifier().getUser());\n     \n    -                // use UGI from token\n    -                ugi = token.decodeIdentifier().getUser();\n    -                ugi.addToken(token);\n    +                // token.getKind() = Text, Text is annotated by @Stringable\n    +                // which ensures toString() implementation\n    +                if (token.getKind().toString().equals(TOKEN_KIND_HBASE_AUTH_TOKEN)) {\n    +                    // use UGI from token\n    +                    LOG.debug(\"Found HBASE_AUTH_TOKEN - using the token to replace current user.\");\n    +\n    +                    ugi = token.decodeIdentifier().getUser();\n    +                    ugi.addToken(token);\n    +\n    +                    foundHBaseAuthToken = true;\n    --- End diff --\n    \n    Makes sense. I'll update the patch.\n","created":"2018-01-24T05:31:37.344+0000","updated":"2018-01-24T05:31:37.344+0000","started":"2018-01-24T05:31:37.343+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"67660","issueId":"13132922"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/worklog/67664","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2527#discussion_r163457487\n  \n    --- Diff: external/storm-hbase/src/main/java/org/apache/storm/hbase/common/Utils.java ---\n    @@ -47,14 +48,28 @@ public static HTable getTable(UserProvider provider, Configuration config, Strin\n                 ugi = UserGroupInformation.getCurrentUser();\n     \n                 LOG.debug(\"UGI for current USER : {}\", ugi.getUserName());\n    +            boolean foundHBaseAuthToken = false;\n                 for (Token<? extends TokenIdentifier> token : ugi.getTokens()) {\n                     LOG.debug(\"Token in UGI (delegation token): {} / {}\", token.toString(),\n                             token.decodeIdentifier().getUser());\n     \n    -                // use UGI from token\n    -                ugi = token.decodeIdentifier().getUser();\n    -                ugi.addToken(token);\n    +                // token.getKind() = Text, Text is annotated by @Stringable\n    +                // which ensures toString() implementation\n    +                if (token.getKind().toString().equals(TOKEN_KIND_HBASE_AUTH_TOKEN)) {\n    +                    // use UGI from token\n    +                    LOG.debug(\"Found HBASE_AUTH_TOKEN - using the token to replace current user.\");\n    +\n    +                    ugi = token.decodeIdentifier().getUser();\n    +                    ugi.addToken(token);\n    +\n    +                    foundHBaseAuthToken = true;\n    --- End diff --\n    \n    @satishd Addressed.\n","created":"2018-01-24T05:41:45.557+0000","updated":"2018-01-24T05:41:45.557+0000","started":"2018-01-24T05:41:45.557+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"67664","issueId":"13132922"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/worklog/67665","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user satishd commented on the issue:\n\n    https://github.com/apache/storm/pull/2527\n  \n    +1 \r\n    Thanks @HeartSaVioR for addressing review comments.\n","created":"2018-01-24T05:46:49.550+0000","updated":"2018-01-24T05:46:49.550+0000","started":"2018-01-24T05:46:49.550+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"67665","issueId":"13132922"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13132922/worklog/69846","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/storm/pull/2527\n","created":"2018-02-01T14:16:36.953+0000","updated":"2018-02-01T14:16:36.953+0000","started":"2018-02-01T14:16:36.953+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"69846","issueId":"13132922"}]},"customfield_12311820":"0|i3p85r:"}}