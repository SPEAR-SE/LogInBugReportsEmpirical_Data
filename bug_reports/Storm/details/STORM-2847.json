{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13123503","self":"https://issues.apache.org/jira/rest/api/2/issue/13123503","key":"STORM-2847","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":18000,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341047","id":"12341047","name":"1.2.0","archived":false,"released":true,"releaseDate":"2018-02-15"}],"aggregatetimespent":18000,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-12-07T17:57:47.448+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Dec 13 15:16:32 UTC 2017","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_104785803_*|*_3_*:*_1_*:*_1107097271_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2017-12-21T17:29:04.067+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2847/watchers","watchCount":2,"isWatching":false},"created":"2017-12-07T16:51:01.096+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["pull-request-available"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":"STORM-2710","customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341047","id":"12341047","name":"1.2.0","archived":false,"released":true,"releaseDate":"2018-02-15"}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-12-21T18:05:00.280+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12331080","id":"12331080","name":"storm-kafka-client"}],"timeoriginalestimate":null,"description":"After rebalance the storm-kafka-client spout attempts to check the current position of partitions that are no longer assigned to the current spout. This occurs in a topology with multiple spout instances.\r\n\r\njava.lang.IllegalArgumentException: You can only check the position for partitions assigned to this consumer. at org.apache.kafka.clients.consumer.KafkaConsumer.position(KafkaConsumer.java:1262) at org.apache.storm.kafka.spout.KafkaSpout.commitOffsetsForAckedTuples(KafkaSpout.java:473)","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"5h","remainingEstimateSeconds":0,"timeSpentSeconds":18000},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Exception thrown after rebalance IllegalArgumentException","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":18000,"total":18000,"percent":100},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":18000,"total":18000,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16282240","id":"16282240","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"[~erosebrook] Do you have a few more lines of the stack trace? I'm curious if the commit is happening in the rebalance listener.\r\n\r\nAlso just so I know which version of the code to look at, which commit is your build of 1.2.0 from?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-12-07T17:57:47.448+0000","updated":"2017-12-07T18:02:32.983+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16282544","id":"16282544","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"body":"[~Srdo] This is all I have at the moment. If you need more I can get that for you tomorrow. It was on the latest commit as of this morning.\r\n\r\njava.lang.IllegalArgumentException: You can only check the position for partitions assigned to this consumer. at org.apache.kafka.clients.consumer.KafkaConsumer.position(KafkaConsumer.java:1262) at org.apache.storm.kafka.spout.KafkaSpout.emitTupleIfNotEmitted(KafkaSpout.java:328) at org.apache.storm.kafka.spout.KafkaSpout.emit(KafkaSpout.java:309) at org.apache.storm.kafka.spout.KafkaSpout.nextTuple(KafkaSpout.java:233) at org.apache.storm.daemon.executor$fn__4976$fn__4991$fn__5022.invoke(executor.clj:644) at org.apache.storm.util$async_loop$fn__557.invoke(util.clj:484) at clojure.lang.AFn.run(AFn.java:22) at java.lang.Thread.run(Thread.java:745)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-07T21:20:51.997+0000","updated":"2017-12-07T21:22:20.714+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16282584","id":"16282584","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"[~erosebrook] Those line numbers don't match up with the line numbers from 1.x-branch (the 1.2.0 branch). See for example https://github.com/apache/storm/blob/1.x-branch/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L328 which is supposed to be where emitTupleIfNotEmitted starts according to the stack trace. We haven't merged anything to storm-kafka-client since a few days ago as far as I know. I checked 1.1.x-branch, 1.0.x-branch and master as well (1.0.6, 1.1.2 and 2.0.0 respectively) and the line numbers don't match up to your stack trace either.\r\n\r\nI'm assuming the new stack trace is unrelated to the original, since the new trace doesn't contain org.apache.storm.kafka.spout.KafkaSpout.commitOffsetsForAckedTuples(KafkaSpout.java:473)?\r\n\r\nIt would be good if you could find the commit hash you built from.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-12-07T21:50:50.553+0000","updated":"2017-12-07T21:51:45.646+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16282880","id":"16282880","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"body":"Apologies [~Srdo] , the second stack trace is from a fix I was playing with for the 1.1.x-branch. I am having trouble with rebalance there as well. Ultimately it seemed like I needed some of your recent changes from the 1.x-branch. Here is the rest of the stack trace. Commit 31133fdcecb5e83317729de67ef7ea12a1bd9929\r\n\r\njava.lang.IllegalArgumentException: You can only check the position for partitions assigned to this consumer. at org.apache.kafka.clients.consumer.KafkaConsumer.position(KafkaConsumer.java:1262) at org.apache.storm.kafka.spout.KafkaSpout.commitOffsetsForAckedTuples(KafkaSpout.java:473) at org.apache.storm.kafka.spout.KafkaSpout.nextTuple(KafkaSpout.java:239) at org.apache.storm.daemon.executor$fn__4976$fn__4991$fn__5022.invoke(executor.clj:644) at org.apache.storm.util$async_loop$fn__557.invoke(util.clj:484) at clojure.lang.AFn.run(AFn.java:22) at java.lang.Thread.run(Thread.java:745)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-08T01:19:20.996+0000","updated":"2017-12-08T01:29:55.773+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16282925","id":"16282925","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"body":"the problems persists in 53c2c677e1066df1ac97b7a62a2d41cab484ecbd\r\n\r\njava.lang.IllegalArgumentException: You can only check the position for partitions assigned to this consumer. at org.apache.kafka.clients.consumer.KafkaConsumer.position(KafkaConsumer.java:1262) at org.apache.storm.kafka.spout.KafkaSpout.commitOffsetsForAckedTuples(KafkaSpout.java:475) at org.apache.storm.kafka.spout.KafkaSpout.nextTuple(KafkaSpout.java:239) at org.apache.storm.daemon.executor$fn__4976$fn__4991$fn__5022.invoke(executor.clj:644) at org.apache.storm.util$async_loop$fn__557.invoke(util.clj:484) at clojure.lang.AFn.run(AFn.java:22) at java.lang.Thread.run(Thread.java:745)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-08T02:02:03.976+0000","updated":"2017-12-08T02:02:03.976+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16283134","id":"16283134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"[~erosebrook] Thanks. I'll try to figure out why this is happening. In the meantime could you post your KafkaSpout configuration and which Kafka version you're using (broker and client)?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-12-08T06:55:00.362+0000","updated":"2017-12-08T06:55:00.362+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16283832","id":"16283832","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"body":"[~Srdo] Here is the requested info:\r\n\r\nkafka-clients: 0.10.2.0\r\nkafka-broker: 0.10.1.0\r\n\r\n    val retryService = new KafkaSpoutRetryExponentialBackoff(\r\n      KafkaSpoutRetryExponentialBackoff.TimeInterval.microSeconds(500),\r\n      KafkaSpoutRetryExponentialBackoff.TimeInterval.milliSeconds(2),\r\n      10,\r\n      KafkaSpoutRetryExponentialBackoff.TimeInterval.seconds(10))\r\n\r\n    val recordTranslator = new CustomRecordTranslator(topics, SerializableFactories.getDeserializer)\r\n\r\n    new KafkaSpoutConfig.Builder(hosts, classOf[CustomDeserializer], classOf[CustomDeserializer], topics)\r\n      .setGroupId(consumerGroup)\r\n      .setRetry(retryService)\r\n      .setRecordTranslator(recordTranslator)\r\n      .setProp(ConsumerConfig.FETCH_MAX_WAIT_MS_CONFIG, 10000)\r\n      .setProp(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, \"false\")\r\n      .setProp(ConsumerConfig.RECEIVE_BUFFER_CONFIG, 1048576)\r\n      .setOffsetCommitPeriodMs(500)\r\n      .build()","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-08T16:59:01.387+0000","updated":"2017-12-08T16:59:01.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16284070","id":"16284070","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Thanks [~erosebrook]. Your configuration and versions look fine to me.\r\n\r\nI've spent some time going over the code, and I'm having a hard time spotting the problem.\r\n\r\nThe exception you're getting from https://github.com/apache/storm/blob/e2e3f5d19a8671e3759a04b94135fd6643b3aa61/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L475 is saying that the TopicPartition parameter to KafkaConsumer.position was not assigned to the consumer. I don't understand how that can happen, because the TopicPartition parameter is based on the offsetManagers map, and the key set of that map is set to be exactly the partitions that are assigned to the consumer, at https://github.com/apache/storm/blob/e2e3f5d19a8671e3759a04b94135fd6643b3aa61/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L174 and https://github.com/apache/storm/blob/e2e3f5d19a8671e3759a04b94135fd6643b3aa61/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L197.\r\n\r\nCould you try to enable debug logging for the org.apache.storm.kafka.spout log domain and provoking the error again? I particularly want to see if the partitions logged at https://github.com/apache/storm/blob/e2e3f5d19a8671e3759a04b94135fd6643b3aa61/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L164 match the ones logged at https://github.com/apache/storm/blob/e2e3f5d19a8671e3759a04b94135fd6643b3aa61/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L469.\r\n\r\nI'm also curious if the error happens at random, or does it happen at particular moments?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-12-08T19:19:37.447+0000","updated":"2017-12-08T19:19:37.447+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16284249","id":"16284249","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"body":"[~Srdo]\r\n\r\nIt happens at every manually triggered rebalance. It seemed to me like it has to do with partitions being revoked from kafka itself, but the spout still has a reference to them. I'll get you the debug data when I am able.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-08T21:28:20.322+0000","updated":"2017-12-08T21:28:20.322+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16284263","id":"16284263","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"When you refer to triggering a rebalance what do you mean? Asking Storm to rebalance the topology or something else?\r\n\r\nAlso as of 1.2.0 Kafka isn't responsible for managing consumer group partition assignment anymore, the spout handles distributing partitions without consulting Kafka. See https://issues.apache.org/jira/browse/STORM-2542 for why we made this change. Partition assignment is now handled by https://github.com/apache/storm/blob/master/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/subscription/ManualPartitionSubscription.java and associated classes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-12-08T21:39:13.855+0000","updated":"2017-12-08T21:41:54.781+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16284266","id":"16284266","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"body":"yes, asking storm to rebalance","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-08T21:40:52.151+0000","updated":"2017-12-08T21:40:52.151+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16284286","id":"16284286","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"I think I have a guess as to what could be wrong. If the spout is deactivated and then reactivated, we replace the KafkaConsumer with a new one. Unfortunately https://github.com/apache/storm/blob/master/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/subscription/ManualPartitionSubscription.java#L58 will ensure that we don't assign partitions to the new consumer unless the assignment changes, because we reuse the old ManualPartitionSubscription instance.\r\n\r\nI'll look at fixing this in the next few days. Hopefully it's what's causing this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-12-08T21:50:26.150+0000","updated":"2017-12-08T21:50:57.856+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16285331","id":"16285331","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"[~erosebrook] I believe I have a fix ready for this. Would you be willing to try it out? You can get it from https://github.com/srdo/storm/tree/STORM-2847-1.x.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-12-10T17:47:58.630+0000","updated":"2017-12-10T17:47:58.630+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16286149","id":"16286149","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"body":"[~Srdo] I Tried your branch and got an error. Apparently the partitions provided to onPartitionsRevoked can be empty. I was able to resolve this by adding \" && partitions.size() > 0\" to line 152.\r\n\r\nPartitions revoked. [consumer-group=MyStormTopology, consumer=org.apache.kafka.clients.consumer.KafkaConsumer@2ada06e4, topic-partitions=[]]\r\n2017-12-11 15:21:19.908 o.a.s.k.s.KafkaSpout Thread-34-uisspout-executor[703 703] [DEBUG] Offsets successfully committed to Kafka [{uis-12=OffsetAndMetadata{offset=6606783674, metadata='{topic-partition=uis-12, offset=6606783673, numFails=0, thread='Thread-34-uisspout-executor[703 703]'}'}, uis-28=OffsetAndMetadata{offset=4262625500, metadata='{topic-partition=uis-28, offset=4262625499, numFails=0, thread='Thread-34-uisspout-executor[703 703]'}'}, uis-44=OffsetAndMetadata{offset=4263152272, metadata='{topic-partition=uis-44, offset=4263152271, numFails=0, thread='Thread-34-uisspout-executor[703 703]'}'}, uis-60=OffsetAndMetadata{offset=3855749917, metadata='{topic-partition=uis-60, offset=3855749916, numFails=0, thread='Thread-34-uisspout-executor[703 703]'}'}, uis-76=OffsetAndMetadata{offset=3196437627, metadata='{topic-partition=uis-76, offset=3196437626, numFails=0, thread='Thread-34-uisspout-executor[703 703]'}'}, uis-92=OffsetAndMetadata{offset=3209173441, metadata='{topic-partition=uis-92, offset=3209173440, numFails=0, thread='Thread-34-uisspout-executor[703 703]'}'}}]\r\n\tat org.apache.storm.kafka.spout.KafkaSpout.commitOffsetsForAckedTuples(KafkaSpout.java:467) ~[stormjar.jar:local]\r\n\tat org.apache.storm.kafka.spout.KafkaSpout.access$400(KafkaSpout.java:59) ~[stormjar.jar:local]\r\n\tat org.apache.storm.kafka.spout.KafkaSpout$KafkaSpoutConsumerRebalanceListener.onPartitionsRevoked(KafkaSpout.java:154) ~[stormjar.jar:local]\r\n\tat org.apache.storm.kafka.spout.KafkaSpout.subscribeKafkaConsumer(KafkaSpout.java:564) ~[stormjar.jar:local]\r\n\tat org.apache.storm.kafka.spout.KafkaSpout.activate(KafkaSpout.java:555) ~[stormjar.jar:local]\r\n\tat org.apache.storm.kafka.spout.KafkaSpout.commitOffsetsForAckedTuples(KafkaSpout.java:467) ~[stormjar.jar:local]\r\n\tat org.apache.storm.kafka.spout.KafkaSpout.access$400(KafkaSpout.java:59) ~[stormjar.jar:local]\r\n\tat org.apache.storm.kafka.spout.KafkaSpout$KafkaSpoutConsumerRebalanceListener.onPartitionsRevoked(KafkaSpout.java:154) ~[stormjar.jar:local]\r\n\tat org.apache.storm.kafka.spout.KafkaSpout.subscribeKafkaConsumer(KafkaSpout.java:564) ~[stormjar.jar:local]\r\n\tat org.apache.storm.kafka.spout.KafkaSpout.activate(KafkaSpout.java:555) ~[stormjar.jar:local]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-11T16:28:58.048+0000","updated":"2017-12-11T16:28:58.048+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16288077","id":"16288077","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"[~erosebrook] Thanks for testing it. I've updated the branch I linked earlier, please try again if you can. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-12-12T18:57:47.977+0000","updated":"2017-12-12T18:57:47.977+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/comment/16289373","id":"16289373","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"body":"Looks good [~Srdo]. I am no longer seeing any exception when manually triggering a rebalance. Nice work!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erosebrook","name":"erosebrook","key":"erosebrook","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Evan Rosebrook","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T15:16:32.039+0000","updated":"2017-12-13T15:16:32.039+0000"}],"maxResults":16,"total":16,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2847/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":30,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60617","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user srdo opened a pull request:\n\n    https://github.com/apache/storm/pull/2454\n\n    STORM-2847: Ensure spout can handle being activated and deactivated\n\n    See https://issues.apache.org/jira/browse/STORM-2847.\r\n    \r\n    The cause of the bug here is that we are shutting down the KafkaConsumer when the spout is deactivated, but aren't returning to a \"clean\" state in the spout fields. When the spout is reactivated and we call Subscribe in the ManualPartitionSubscription, it skips doing the assignment because the new assignment is the same as the assignment it has cached from before the deactivation.\r\n    \r\n    The fix is to not cache the assignment in ManualPartitionSubscription, but just ask the consumer what its assignment is.\r\n    \r\n    There are some other related changes in this as well:\r\n    * Removed the initialized flag in the spout. Initialization is always synchronous, and happens in the call to KafkaSpout.activate, which happens before Storm starts calling nextTuple. There's no need to have a flag.\r\n    * Fixed too strict check of whether consumer position was behind the committed offset. The committed offset is the offset the spout will start at, so it is allowed that the position is at the committed offset.\r\n    * Refactor tests that use a stubbed consumer to use a mocked Subscription instead of the real classes. The real classes make stubbing more complicated than it should be, and we are testing the subscription when doing integration tests with the embedded Kafka instance, and also in the ManualPartitionSubscription unit test.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/srdo/storm STORM-2847\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2454.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2454\n    \n----\ncommit 26e438c7e5397d1b8556d542c56c8693862d74f7\nAuthor: Stig Rohde Døssing <srdo@apache.org>\nDate:   2017-12-09T08:00:33Z\n\n    STORM-2847: Ensure spout can handle being activated and deactivated\n\n----\n","created":"2017-12-10T19:46:37.306+0000","updated":"2017-12-10T19:46:37.306+0000","started":"2017-12-10T19:46:37.305+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60617","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60697","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r156208523\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -186,12 +182,13 @@ private void initialize(Collection<TopicPartition> partitions) {\n                 for (TopicPartition tp : newPartitions) {\n                     final OffsetAndMetadata committedOffset = kafkaConsumer.committed(tp);\n                     final long fetchOffset = doSeek(tp, committedOffset);\n    +                LOG.debug(\"Set consumer position to [{}] for topic-partition [{}], based on strategy [{}] and committed offset [{}]\",\n    --- End diff --\n    \n    Isn't this log message useful? I would suggest that unless this info is elsewhere, we leave this message. If you want it lower priority, we can put it as TRACE level.\n","created":"2017-12-11T22:41:10.930+0000","updated":"2017-12-11T22:41:10.930+0000","started":"2017-12-11T22:41:10.926+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60697","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60698","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r156220249\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -395,7 +387,7 @@ private boolean emitOrRetryTuple(ConsumerRecord<K, V> record) {\n             } else if (emitted.contains(msgId)) {   // has been emitted and it is pending ack or fail\n                 LOG.trace(\"Tuple for record [{}] has already been emitted. Skipping\", record);\n             } else {\n    -            if (kafkaConsumer.committed(tp) != null && (kafkaConsumer.committed(tp).offset() >= kafkaConsumer.position(tp))) {\n    +            if (kafkaConsumer.committed(tp) != null && (kafkaConsumer.committed(tp).offset() > kafkaConsumer.position(tp))) {\n    --- End diff --\n    \n    Is this change to address https://issues.apache.org/jira/browse/STORM-2844 ?\n","created":"2017-12-11T22:41:11.390+0000","updated":"2017-12-11T22:41:11.390+0000","started":"2017-12-11T22:41:11.384+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60698","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60699","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r156208684\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -223,29 +220,24 @@ private long doSeek(TopicPartition tp, OffsetAndMetadata committedOffset) {\n         @Override\n         public void nextTuple() {\n             try {\n    -            if (initialized) {             \n    --- End diff --\n    \n    Why is this flag no longer necessary?\n","created":"2017-12-11T22:41:11.584+0000","updated":"2017-12-11T22:41:11.584+0000","started":"2017-12-11T22:41:11.582+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60699","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60700","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r156222547\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -186,12 +182,13 @@ private void initialize(Collection<TopicPartition> partitions) {\n                 for (TopicPartition tp : newPartitions) {\n                     final OffsetAndMetadata committedOffset = kafkaConsumer.committed(tp);\n                     final long fetchOffset = doSeek(tp, committedOffset);\n    +                LOG.debug(\"Set consumer position to [{}] for topic-partition [{}], based on strategy [{}] and committed offset [{}]\",\n    --- End diff --\n    \n    The message is added in this PR, not removed.\n","created":"2017-12-11T22:43:32.871+0000","updated":"2017-12-11T22:43:32.871+0000","started":"2017-12-11T22:43:32.870+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60700","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60701","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r156222931\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -395,7 +387,7 @@ private boolean emitOrRetryTuple(ConsumerRecord<K, V> record) {\n             } else if (emitted.contains(msgId)) {   // has been emitted and it is pending ack or fail\n                 LOG.trace(\"Tuple for record [{}] has already been emitted. Skipping\", record);\n             } else {\n    -            if (kafkaConsumer.committed(tp) != null && (kafkaConsumer.committed(tp).offset() >= kafkaConsumer.position(tp))) {\n    +            if (kafkaConsumer.committed(tp) != null && (kafkaConsumer.committed(tp).offset() > kafkaConsumer.position(tp))) {\n    --- End diff --\n    \n    No, it's just to get a test to pass that happened to hit this case. 2844 is still an issue.\n","created":"2017-12-11T22:45:14.160+0000","updated":"2017-12-11T22:45:14.160+0000","started":"2017-12-11T22:45:14.159+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60701","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60702","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r156223919\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -186,12 +182,13 @@ private void initialize(Collection<TopicPartition> partitions) {\n                 for (TopicPartition tp : newPartitions) {\n                     final OffsetAndMetadata committedOffset = kafkaConsumer.committed(tp);\n                     final long fetchOffset = doSeek(tp, committedOffset);\n    +                LOG.debug(\"Set consumer position to [{}] for topic-partition [{}], based on strategy [{}] and committed offset [{}]\",\n    --- End diff --\n    \n    LOL, my bad :). I was reviewing this on diff and confused it.\n","created":"2017-12-11T22:49:38.888+0000","updated":"2017-12-11T22:49:38.888+0000","started":"2017-12-11T22:49:38.886+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60702","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60703","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r156224126\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -395,7 +387,7 @@ private boolean emitOrRetryTuple(ConsumerRecord<K, V> record) {\n             } else if (emitted.contains(msgId)) {   // has been emitted and it is pending ack or fail\n                 LOG.trace(\"Tuple for record [{}] has already been emitted. Skipping\", record);\n             } else {\n    -            if (kafkaConsumer.committed(tp) != null && (kafkaConsumer.committed(tp).offset() >= kafkaConsumer.position(tp))) {\n    +            if (kafkaConsumer.committed(tp) != null && (kafkaConsumer.committed(tp).offset() > kafkaConsumer.position(tp))) {\n    --- End diff --\n    \n    OK, I agree. Because initially I thought that this could be a potential fix, but then found out that it wouldn't work. I was wondering if I had missed anything. Thanks.\n","created":"2017-12-11T22:50:36.200+0000","updated":"2017-12-11T22:50:36.200+0000","started":"2017-12-11T22:50:36.199+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60703","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60704","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r156224911\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -223,29 +220,24 @@ private long doSeek(TopicPartition tp, OffsetAndMetadata committedOffset) {\n         @Override\n         public void nextTuple() {\n             try {\n    -            if (initialized) {             \n    --- End diff --\n    \n    I'm not sure it was ever necessary.\r\n    \r\n    When we were using the subscribe API the consumer rebalance code would be running as part of a call to KafkaConsumer.poll, initially from e.g. the NamedSubscription.subscribe method called by KafkaSpout.activate. The call to poll blocks until the initial rebalance is complete.\r\n    \r\n    Since switching to the assign API, the rebalance code is running as part of the call to Subscription.subscribe/refreshPartitions, still initially called by KafkaSpout.activate.\r\n    \r\n    The rebalance listener is always called synchronously as part of the Subscription.subscribe call in KafkaSpout.activate, so it shouldn't be possible to reach KafkaSpout.nextTuple without initialized being true, because it will be true once KafkaSpout.activate returns. \n","created":"2017-12-11T22:53:46.891+0000","updated":"2017-12-11T22:53:46.891+0000","started":"2017-12-11T22:53:46.889+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60704","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60705","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2454\n  \n    This PR doesn't actually fix the issue reported in STORM-2847. The problem is that we can't commit offsets for partitions the consumer is not assigned. We've previously assumed that the spout was assigned every partition it had offset managers for, but this isn't true when reactivating a deactivated spout. When we reactivate a spout, the consumer has no assigned partitions when onPartitionsRevoked is called initially.\r\n    \r\n    It doesn't seem ideal that we unconditionally commit offsets for all partitions we have offset managers for, when the onPartitionsRevoked method parameter tells us which partitions were assigned previously. \r\n    \r\n    I'll close this and reopen once the issue is fixed. My immediate ideas would be these:\r\n    * Put KafkaConsumer instantiation in open(), keep the same consumer for the lifetime of the spout: Benefit is that it's easy to \"get right\". Drawback is that if you deactivate a spout in order to e.g. update a committed offset with the scripts Kafka ships with, when you activate the spout it will resume from where it was, not from the new committed offset. Maybe it is better if deactivate/activate behaves the same as if the spout had restarted (e.g. as it would if the worker crashed). Also the consumer remains open while the spout isn't running.\r\n    * Wipe internal spout state when deactivating, including OffsetManagers: Benefit is that the spout behaves as if it had been restarted when reactivated, drawback is that some acked tuples that couldn't be committed when the spout was deactivated may be unnecessarily replayed in at-least-once mode, e.g. if offset 0-2, 4-5 had been acked before deactivating, 4-5 couldn't be committed and would be replayed.\r\n    * Do a quick hack and make ManualPartitionSubscription only call onPartitionsRevoked if the assignment wasn't empty. \r\n    \r\n    I'd appreciate your thoughts on which of these proposals you prefer (or if you have other ideas). Sorry about the partial PR.\n","created":"2017-12-11T23:05:05.904+0000","updated":"2017-12-11T23:05:05.904+0000","started":"2017-12-11T23:05:05.903+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60705","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/60706","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo closed the pull request at:\n\n    https://github.com/apache/storm/pull/2454\n","created":"2017-12-11T23:05:06.282+0000","updated":"2017-12-11T23:05:06.282+0000","started":"2017-12-11T23:05:06.281+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60706","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/61016","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2454\n  \n    I've put up a solution that doesn't have any of the drawbacks I mentioned.\r\n    \r\n    commitOffsetsForAckedTuples will now only commit offsets on the partitions it's told to. I think it makes sense that we implement the rebalance listener to only commit offsets for the partitions that are assigned, and not all partitions.\r\n    \r\n    The only drawback I see to this solution is that it is less visible if we have offset managers for partitions the spout isn't assigned (it would previously crash when attempting to commit, now it will silently be ignored). \r\n    \r\n    Having offset managers for unassigned partitions shouldn't happen during normal operation, only when the spout is deactivated, receives an ack that allows a commit, and is then reactivated. If you like I'm happy to add a flag similar to \"initialized\" so we can check that we never have offset managers for unassigned partitions except in this case.\n","created":"2017-12-13T15:39:11.415+0000","updated":"2017-12-13T15:39:11.415+0000","started":"2017-12-13T15:39:11.414+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61016","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/61017","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user srdo reopened a pull request:\n\n    https://github.com/apache/storm/pull/2454\n\n    STORM-2847: Ensure spout can handle being activated and deactivated\n\n    See https://issues.apache.org/jira/browse/STORM-2847.\r\n    \r\n    The cause of the bug here is that we are shutting down the KafkaConsumer when the spout is deactivated, but aren't returning to a \"clean\" state in the spout fields. When the spout is reactivated and we call Subscribe in the ManualPartitionSubscription, it skips doing the assignment because the new assignment is the same as the assignment it has cached from before the deactivation.\r\n    \r\n    The fix is to not cache the assignment in ManualPartitionSubscription, but just ask the consumer what its assignment is.\r\n    \r\n    There are some other related changes in this as well:\r\n    * Removed the initialized flag in the spout. Initialization is always synchronous, and happens in the call to KafkaSpout.activate, which happens before Storm starts calling nextTuple. There's no need to have a flag.\r\n    * Fixed too strict check of whether consumer position was behind the committed offset. The committed offset is the offset the spout will start at, so it is allowed that the position is at the committed offset.\r\n    * Refactor tests that use a stubbed consumer to use a mocked Subscription instead of the real classes. The real classes make stubbing more complicated than it should be, and we are testing the subscription when doing integration tests with the embedded Kafka instance, and also in the ManualPartitionSubscription unit test.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/srdo/storm STORM-2847\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2454.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2454\n    \n----\n\n----\n","created":"2017-12-13T15:39:12.699+0000","updated":"2017-12-13T15:39:12.699+0000","started":"2017-12-13T15:39:12.699+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61017","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/61301","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r157061077\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -442,10 +435,13 @@ private boolean isEmitTuple(List<Object> tuple) {\n             return tuple != null || kafkaSpoutConfig.isEmitNullTuples();\n         }\n     \n    -    private void commitOffsetsForAckedTuples() {\n    -        // Find offsets that are ready to be committed for every topic partition\n    +    private void commitOffsetsForAckedTuples(Set<TopicPartition> assignedPartitions) {\n    +        // Find offsets that are ready to be committed for every assigned topic partition\n    +        final Map<TopicPartition, OffsetManager> assignedOffsetManagers = offsetManagers.entrySet().stream()\n    +            .filter(entry -> assignedPartitions.contains(entry.getKey()))\n    +            .collect(Collectors.toMap(entry -> entry.getKey(), entry -> entry.getValue()));\n    --- End diff --\n    \n    Can use method reference for key/value\n","created":"2017-12-15T01:24:48.767+0000","updated":"2017-12-15T01:24:48.767+0000","started":"2017-12-15T01:24:48.766+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61301","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/61302","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r157104947\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -442,10 +435,13 @@ private boolean isEmitTuple(List<Object> tuple) {\n             return tuple != null || kafkaSpoutConfig.isEmitNullTuples();\n         }\n     \n    -    private void commitOffsetsForAckedTuples() {\n    -        // Find offsets that are ready to be committed for every topic partition\n    +    private void commitOffsetsForAckedTuples(Set<TopicPartition> assignedPartitions) {\n    +        // Find offsets that are ready to be committed for every assigned topic partition\n    +        final Map<TopicPartition, OffsetManager> assignedOffsetManagers = offsetManagers.entrySet().stream()\n    +            .filter(entry -> assignedPartitions.contains(entry.getKey()))\n    +            .collect(Collectors.toMap(entry -> entry.getKey(), entry -> entry.getValue()));\n             final Map<TopicPartition, OffsetAndMetadata> nextCommitOffsets = new HashMap<>();\n    --- End diff --\n    \n    An empty line before this var would make the code easier to read\n","created":"2017-12-15T01:24:48.913+0000","updated":"2017-12-15T01:24:48.913+0000","started":"2017-12-15T01:24:48.912+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61302","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/61303","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on the issue:\n\n    https://github.com/apache/storm/pull/2454\n  \n    @srdo Can you explain how can the drawback scenario you describe in your [comment](https://github.com/apache/storm/pull/2454#issuecomment-351428500) happen? When activate happens, refresh partitions will be called, onPartitionsRevoked will commit only for the partitions that are now assigned to the consumer (so acks that make commits eligible for other partitions won't matter), and onPartitionsReassigned will remove the offset managers for the partitions that are no longer assigned to this spout instance.\n","created":"2017-12-15T01:28:22.361+0000","updated":"2017-12-15T01:28:22.361+0000","started":"2017-12-15T01:28:22.359+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61303","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/61375","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r157134967\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -442,10 +435,13 @@ private boolean isEmitTuple(List<Object> tuple) {\n             return tuple != null || kafkaSpoutConfig.isEmitNullTuples();\n         }\n     \n    -    private void commitOffsetsForAckedTuples() {\n    -        // Find offsets that are ready to be committed for every topic partition\n    +    private void commitOffsetsForAckedTuples(Set<TopicPartition> assignedPartitions) {\n    +        // Find offsets that are ready to be committed for every assigned topic partition\n    +        final Map<TopicPartition, OffsetManager> assignedOffsetManagers = offsetManagers.entrySet().stream()\n    +            .filter(entry -> assignedPartitions.contains(entry.getKey()))\n    +            .collect(Collectors.toMap(entry -> entry.getKey(), entry -> entry.getValue()));\n    --- End diff --\n    \n    Will fix\n","created":"2017-12-15T07:05:44.868+0000","updated":"2017-12-15T07:05:44.868+0000","started":"2017-12-15T07:05:44.866+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61375","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/61376","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2454#discussion_r157134976\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -442,10 +435,13 @@ private boolean isEmitTuple(List<Object> tuple) {\n             return tuple != null || kafkaSpoutConfig.isEmitNullTuples();\n         }\n     \n    -    private void commitOffsetsForAckedTuples() {\n    -        // Find offsets that are ready to be committed for every topic partition\n    +    private void commitOffsetsForAckedTuples(Set<TopicPartition> assignedPartitions) {\n    +        // Find offsets that are ready to be committed for every assigned topic partition\n    +        final Map<TopicPartition, OffsetManager> assignedOffsetManagers = offsetManagers.entrySet().stream()\n    +            .filter(entry -> assignedPartitions.contains(entry.getKey()))\n    +            .collect(Collectors.toMap(entry -> entry.getKey(), entry -> entry.getValue()));\n             final Map<TopicPartition, OffsetAndMetadata> nextCommitOffsets = new HashMap<>();\n    --- End diff --\n    \n    Will fix\n","created":"2017-12-15T07:05:51.202+0000","updated":"2017-12-15T07:05:51.202+0000","started":"2017-12-15T07:05:51.202+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61376","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/61381","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2454\n  \n    @hmcl I don't think the drawback scenario can happen \"normally\", since the spout never has OffsetManagers for partitions it isn't assigned except when reactivating after deactivation. It's mainly a drawback for debugging in case we introduce a bug where we don't clean up the OffsetManagers correctly, or create too many OffsetManagers for some reason. Previously we'd be getting an error when trying to commit on a partition the consumer doesn't own. Now it will quietly skip that partition in commitOffsets, so we won't necessarily be told if there's superfluous OffsetManagers floating around.\r\n    \r\n    I think it's a fairly minor downside.\n","created":"2017-12-15T07:11:22.500+0000","updated":"2017-12-15T07:11:22.500+0000","started":"2017-12-15T07:11:22.499+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61381","issueId":"13123503"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123503/worklog/61589","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on the issue:\n\n    https://github.com/apache/storm/pull/2454\n  \n    +1. @srdo can you please squash.\n","created":"2017-12-16T00:16:36.700+0000","updated":"2017-12-16T00:16:36.700+0000","started":"2017-12-16T00:16:36.698+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61589","issueId":"13123503"}]},"customfield_12311820":"0|i3nnnr:"}}