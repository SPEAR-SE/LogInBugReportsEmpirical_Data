{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13156193","self":"https://issues.apache.org/jira/rest/api/2/issue/13156193","key":"STORM-3053","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":6600,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false}],"aggregatetimespent":6600,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-06-01T15:19:24.434+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jun 01 15:19:24 UTC 2018","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_5417_*|*_3_*:*_1_*:*_2749062421_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2018-06-01T15:19:02.522+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-3053/watchers","watchCount":2,"isWatching":false},"created":"2018-04-30T19:41:14.718+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["pull-request-available"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agresch","name":"agresch","key":"agresch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Gresch","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-06-01T15:19:24.434+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"We have integration tests failing that create a blobstore and then fail to submit a topology.  Digging into the logs, it looks like there is a nimbus thread that runs every 10 seconds and deletes blobstores if there is no associated topology.  We're hitting a race between the two calls periodically.  \r\n\r\n \r\n\r\n \r\n\r\nA possible fix could be to save the timestamp when the blobstore AtomicOutputStream closes and give some grace period before cleaning up based on this timestamp.\r\n\r\n \r\n\r\n \r\n\r\n ","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"1h 50m","remainingEstimateSeconds":0,"timeSpentSeconds":6600},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"blobstores deleted before topologies can be submitted","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agresch","name":"agresch","key":"agresch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Gresch","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agresch","name":"agresch","key":"agresch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Gresch","active":true,"timeZone":"Etc/UTC"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":6600,"total":6600,"percent":100},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":6600,"total":6600,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/comment/16498118","id":"16498118","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Thanks for the fix [~agresch]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-06-01T15:19:24.434+0000","updated":"2018-06-01T15:19:24.434+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-3053/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":13,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/104241","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user agresch opened a pull request:\n\n    https://github.com/apache/storm/pull/2686\n\n    STORM-3053 prevent race deleting blobs before topologies can be submitted\n\n    When submitting a toplogy, the jar first gets uploaded, and then the topology is submitted.  Between these two events, a nimbus timer can go off and it finds that the jar belongs to a topology that does not exist, and removes it, causing topology submission to fail.\r\n    \r\n    This change logs when a blob is first detected for deletion.  It then waits a period of time (defaulting to 5 minutes) before considering it idle.\r\n    \r\n    \r\n\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/agresch/storm agresch_storm3053\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2686.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2686\n    \n----\ncommit 99f47570750266c12d31eaa11ef912e92575b095\nAuthor: Aaron Gresch <agresch@...>\nDate:   2018-05-21T19:52:58Z\n\n    STORM-3053 prevent race deleting blobstores before topologies can be submitted\n\n----\n","created":"2018-05-21T20:31:51.350+0000","updated":"2018-05-21T20:31:51.350+0000","started":"2018-05-21T20:31:51.349+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"104241","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/106130","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2686#discussion_r191042463\n  \n    --- Diff: storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java ---\n    @@ -828,12 +831,54 @@ private static boolean isTopologyActive(IStormClusterState state, String topoNam\n             }\n         }\n     \n    +    private static void rotateTopologyCleanupMap(long deletionDelay) {\n    +        if (Time.currentTimeMillis() - topologyCleanupRotationTime > deletionDelay) {\n    +            topologyCleanupDetected.rotate();\n    +            topologyCleanupRotationTime = Time.currentTimeMillis();\n    +        }\n    +    }\n    +\n    +    private static long getTopologyCleanupDetectedTime(String topologyId) {\n    +        Long firstDetectedForDeletion = topologyCleanupDetected.get(topologyId);\n    +        if (firstDetectedForDeletion == null) {\n    +            firstDetectedForDeletion = Time.currentTimeMillis();\n    +            topologyCleanupDetected.put(topologyId, firstDetectedForDeletion);\n    +        }\n    +        return firstDetectedForDeletion;\n    +    }\n    +\n    +    /**\n    +     * Finds blobstore entries with no matching topology.  Waits NIMBUS_TOPOLOGY_BLOBSTORE_DELETION_DELAY_MSEC\n    +     * before reporting the topologies found.  The delay is to prevent a race condition between when a blobstore\n    +     * is created and when the topology is submitted.  It is possible the Nimbus cleanup timer task will find\n    +     * entries to delete between these two events.\n    +     *\n    +     * @param store  blobstore to search\n    +     * @param conf  the nimbus conf\n    +     * @return a set of\n    +     */\n    +    static Set<String> getIdleTopologyIds(BlobStore store, Map<String, Object> conf) {\n    +        Set<String> toposToClean = store.storedTopoIds();\n    +        Set<String> idleTopologies = new HashSet<>();\n    +        long topologyDeletionDelay = ObjectReader.getInt(\n    +                conf.get(DaemonConfig.NIMBUS_TOPOLOGY_BLOBSTORE_DELETION_DELAY_MSEC), 5 * 60 * 1000);\n    --- End diff --\n    \n    Nit: Consider putting this default in the defaults.yaml instead, I think it's easier for users to know the default that way.\n","created":"2018-05-26T09:06:01.321+0000","updated":"2018-05-26T09:06:01.321+0000","started":"2018-05-26T09:06:01.320+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"106130","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/106131","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2686#discussion_r191042445\n  \n    --- Diff: storm-server/src/main/java/org/apache/storm/DaemonConfig.java ---\n    @@ -279,6 +279,12 @@\n         @isString\n         public static final String NIMBUS_WORKER_HEARTBEATS_RECOVERY_STRATEGY_CLASS = \"nimbus.worker.heartbeats.recovery.strategy.class\";\n     \n    +    /**\n    +     * This controls the number of milliseconds nimbus will wait before deleting a topology blobstore once detected it is able to delete.\n    +     */\n    +    @isInteger\n    +    public static final String NIMBUS_TOPOLOGY_BLOBSTORE_DELETION_DELAY_MSEC = \"nimbus.topology.blobstore.deletion.delay.msec\";\n    --- End diff --\n    \n    Nit: Other millisecond variables are postfixed \"_MS\" rather than \"_MSEC\"\n","created":"2018-05-26T09:06:01.333+0000","updated":"2018-05-26T09:06:01.333+0000","started":"2018-05-26T09:06:01.332+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"106131","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/106132","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2686#discussion_r191043657\n  \n    --- Diff: storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java ---\n    @@ -371,6 +372,8 @@\n         private static final List<String> EMPTY_STRING_LIST = Collections.unmodifiableList(Collections.emptyList());\n         private static final Set<String> EMPTY_STRING_SET = Collections.unmodifiableSet(Collections.emptySet());\n         private static final Pattern TOPOLOGY_NAME_REGEX = Pattern.compile(\"^[^/.:\\\\\\\\]+$\");\n    +    private static final RotatingMap<String, Long> topologyCleanupDetected = new RotatingMap<String, Long>(2);\n    --- End diff --\n    \n    Nit: Could use `<>` on the right hand side\n","created":"2018-05-26T09:06:01.447+0000","updated":"2018-05-26T09:06:01.447+0000","started":"2018-05-26T09:06:01.446+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"106132","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/106133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2686#discussion_r191043819\n  \n    --- Diff: storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java ---\n    @@ -828,12 +831,54 @@ private static boolean isTopologyActive(IStormClusterState state, String topoNam\n             }\n         }\n     \n    +    private static void rotateTopologyCleanupMap(long deletionDelay) {\n    +        if (Time.currentTimeMillis() - topologyCleanupRotationTime > deletionDelay) {\n    +            topologyCleanupDetected.rotate();\n    +            topologyCleanupRotationTime = Time.currentTimeMillis();\n    +        }\n    +    }\n    +\n    +    private static long getTopologyCleanupDetectedTime(String topologyId) {\n    +        Long firstDetectedForDeletion = topologyCleanupDetected.get(topologyId);\n    +        if (firstDetectedForDeletion == null) {\n    +            firstDetectedForDeletion = Time.currentTimeMillis();\n    +            topologyCleanupDetected.put(topologyId, firstDetectedForDeletion);\n    +        }\n    +        return firstDetectedForDeletion;\n    +    }\n    +\n    +    /**\n    +     * Finds blobstore entries with no matching topology.  Waits NIMBUS_TOPOLOGY_BLOBSTORE_DELETION_DELAY_MSEC\n    +     * before reporting the topologies found.  The delay is to prevent a race condition between when a blobstore\n    +     * is created and when the topology is submitted.  It is possible the Nimbus cleanup timer task will find\n    +     * entries to delete between these two events.\n    --- End diff --\n    \n    The javadoc should mention that this method updates the rotating map I think.\n","created":"2018-05-26T09:06:01.449+0000","updated":"2018-05-26T09:06:01.449+0000","started":"2018-05-26T09:06:01.448+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"106133","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/106134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2686#discussion_r191043807\n  \n    --- Diff: storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java ---\n    @@ -828,12 +831,54 @@ private static boolean isTopologyActive(IStormClusterState state, String topoNam\n             }\n         }\n     \n    +    private static void rotateTopologyCleanupMap(long deletionDelay) {\n    +        if (Time.currentTimeMillis() - topologyCleanupRotationTime > deletionDelay) {\n    +            topologyCleanupDetected.rotate();\n    +            topologyCleanupRotationTime = Time.currentTimeMillis();\n    +        }\n    +    }\n    +\n    +    private static long getTopologyCleanupDetectedTime(String topologyId) {\n    +        Long firstDetectedForDeletion = topologyCleanupDetected.get(topologyId);\n    +        if (firstDetectedForDeletion == null) {\n    +            firstDetectedForDeletion = Time.currentTimeMillis();\n    +            topologyCleanupDetected.put(topologyId, firstDetectedForDeletion);\n    +        }\n    +        return firstDetectedForDeletion;\n    +    }\n    +\n    +    /**\n    +     * Finds blobstore entries with no matching topology.  Waits NIMBUS_TOPOLOGY_BLOBSTORE_DELETION_DELAY_MSEC\n    +     * before reporting the topologies found.  The delay is to prevent a race condition between when a blobstore\n    +     * is created and when the topology is submitted.  It is possible the Nimbus cleanup timer task will find\n    +     * entries to delete between these two events.\n    +     *\n    +     * @param store  blobstore to search\n    +     * @param conf  the nimbus conf\n    +     * @return a set of\n    +     */\n    +    static Set<String> getIdleTopologyIds(BlobStore store, Map<String, Object> conf) {\n    --- End diff --\n    \n    I think the name here is confusing. Isn't this method returning all topology ids that have existed in the blob store for longer than NIMBUS_TOPOLOGY_BLOBSTORE_DELETION_DELAY_MSEC?\n","created":"2018-05-26T09:06:01.454+0000","updated":"2018-05-26T09:06:01.454+0000","started":"2018-05-26T09:06:01.453+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"106134","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/106135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2686#discussion_r191042475\n  \n    --- Diff: storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java ---\n    @@ -828,12 +831,54 @@ private static boolean isTopologyActive(IStormClusterState state, String topoNam\n             }\n         }\n     \n    +    private static void rotateTopologyCleanupMap(long deletionDelay) {\n    +        if (Time.currentTimeMillis() - topologyCleanupRotationTime > deletionDelay) {\n    +            topologyCleanupDetected.rotate();\n    +            topologyCleanupRotationTime = Time.currentTimeMillis();\n    +        }\n    +    }\n    +\n    +    private static long getTopologyCleanupDetectedTime(String topologyId) {\n    +        Long firstDetectedForDeletion = topologyCleanupDetected.get(topologyId);\n    +        if (firstDetectedForDeletion == null) {\n    +            firstDetectedForDeletion = Time.currentTimeMillis();\n    +            topologyCleanupDetected.put(topologyId, firstDetectedForDeletion);\n    +        }\n    +        return firstDetectedForDeletion;\n    +    }\n    +\n    +    /**\n    +     * Finds blobstore entries with no matching topology.  Waits NIMBUS_TOPOLOGY_BLOBSTORE_DELETION_DELAY_MSEC\n    --- End diff --\n    \n    Nit: For some reason there are two spaces between each sentence here and in the params\n","created":"2018-05-26T09:06:01.471+0000","updated":"2018-05-26T09:06:01.471+0000","started":"2018-05-26T09:06:01.471+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"106135","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/106136","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2686#discussion_r191043922\n  \n    --- Diff: storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java ---\n    @@ -828,12 +831,54 @@ private static boolean isTopologyActive(IStormClusterState state, String topoNam\n             }\n         }\n     \n    +    private static void rotateTopologyCleanupMap(long deletionDelay) {\n    +        if (Time.currentTimeMillis() - topologyCleanupRotationTime > deletionDelay) {\n    +            topologyCleanupDetected.rotate();\n    +            topologyCleanupRotationTime = Time.currentTimeMillis();\n    +        }\n    +    }\n    +\n    +    private static long getTopologyCleanupDetectedTime(String topologyId) {\n    +        Long firstDetectedForDeletion = topologyCleanupDetected.get(topologyId);\n    +        if (firstDetectedForDeletion == null) {\n    +            firstDetectedForDeletion = Time.currentTimeMillis();\n    +            topologyCleanupDetected.put(topologyId, firstDetectedForDeletion);\n    +        }\n    +        return firstDetectedForDeletion;\n    +    }\n    +\n    +    /**\n    +     * Finds blobstore entries with no matching topology.  Waits NIMBUS_TOPOLOGY_BLOBSTORE_DELETION_DELAY_MSEC\n    +     * before reporting the topologies found.  The delay is to prevent a race condition between when a blobstore\n    +     * is created and when the topology is submitted.  It is possible the Nimbus cleanup timer task will find\n    +     * entries to delete between these two events.\n    +     *\n    +     * @param store  blobstore to search\n    +     * @param conf  the nimbus conf\n    +     * @return a set of\n    --- End diff --\n    \n    Nit: This sentence seems incomplete.\n","created":"2018-05-26T09:06:01.520+0000","updated":"2018-05-26T09:06:01.520+0000","started":"2018-05-26T09:06:01.520+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"106136","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/106137","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2686#discussion_r191043439\n  \n    --- Diff: storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java ---\n    @@ -828,12 +831,54 @@ private static boolean isTopologyActive(IStormClusterState state, String topoNam\n             }\n         }\n     \n    +    private static void rotateTopologyCleanupMap(long deletionDelay) {\n    +        if (Time.currentTimeMillis() - topologyCleanupRotationTime > deletionDelay) {\n    +            topologyCleanupDetected.rotate();\n    +            topologyCleanupRotationTime = Time.currentTimeMillis();\n    +        }\n    +    }\n    +\n    +    private static long getTopologyCleanupDetectedTime(String topologyId) {\n    +        Long firstDetectedForDeletion = topologyCleanupDetected.get(topologyId);\n    +        if (firstDetectedForDeletion == null) {\n    +            firstDetectedForDeletion = Time.currentTimeMillis();\n    +            topologyCleanupDetected.put(topologyId, firstDetectedForDeletion);\n    +        }\n    +        return firstDetectedForDeletion;\n    +    }\n    +\n    +    /**\n    +     * Finds blobstore entries with no matching topology.  Waits NIMBUS_TOPOLOGY_BLOBSTORE_DELETION_DELAY_MSEC\n    +     * before reporting the topologies found.  The delay is to prevent a race condition between when a blobstore\n    --- End diff --\n    \n    This phrasing makes it sound like the method will block. How about something like \"Blobstore entries first detected less than NIMBUS_TOPOLOGY_BLOBSTORE_DELETION_DELAY_MSEC ago are ignored\"?\n","created":"2018-05-26T09:06:01.540+0000","updated":"2018-05-26T09:06:01.540+0000","started":"2018-05-26T09:06:01.539+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"106137","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/107207","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user agresch commented on the issue:\n\n    https://github.com/apache/storm/pull/2686\n  \n    @srdo - made the changes you requested.\n","created":"2018-05-30T15:42:32.839+0000","updated":"2018-05-30T15:42:32.839+0000","started":"2018-05-30T15:42:32.839+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"107207","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/108107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2686\n  \n    +1, thanks for addressing my nitpicks.\n","created":"2018-06-01T15:15:41.990+0000","updated":"2018-06-01T15:15:41.990+0000","started":"2018-06-01T15:15:41.990+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"108107","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/108109","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/storm/pull/2686\n","created":"2018-06-01T15:18:06.024+0000","updated":"2018-06-01T15:18:06.024+0000","started":"2018-06-01T15:18:06.024+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"108109","issueId":"13156193"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13156193/worklog/108110","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2686\n  \n    Thanks @agresch, merged to master.\r\n    \r\n    I forgot to check that commits were squashed, hopefully it doesn't bother anyone too much.\n","created":"2018-06-01T15:18:55.539+0000","updated":"2018-06-01T15:18:55.539+0000","started":"2018-06-01T15:18:55.539+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"108110","issueId":"13156193"}]},"customfield_12311820":"0|i3t6tz:"}}