{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13004935","self":"https://issues.apache.org/jira/rest/api/2/issue/13004935","key":"STORM-2095","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":1800,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335748","id":"12335748","name":"1.1.0","archived":false,"released":true,"releaseDate":"2017-03-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12337341","id":"12337341","name":"1.0.3","archived":false,"released":true,"releaseDate":"2017-02-14"}],"aggregatetimespent":1800,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2016-12-29T15:42:57.373+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jan 03 14:18:39 UTC 2017","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_9584289407_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2017-01-03T14:18:39.322+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2095/watchers","watchCount":3,"isWatching":false},"created":"2016-09-14T16:00:30.502+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329843","id":"12329843","name":"1.0.0","archived":false,"released":true,"releaseDate":"2016-04-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335587","id":"12335587","name":"1.0.1","archived":false,"released":true,"releaseDate":"2016-05-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335747","id":"12335747","name":"1.0.2","archived":false,"released":true,"releaseDate":"2016-08-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335748","id":"12335748","name":"1.1.0","archived":false,"released":true,"releaseDate":"2017-03-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12337341","id":"12337341","name":"1.0.3","archived":false,"released":true,"releaseDate":"2017-02-14"}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwissman","name":"mwissman","key":"mwissman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Wissman","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-01-03T14:18:39.812+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12328752","id":"12328752","name":"blobstore"}],"timeoriginalestimate":null,"description":"To Recreate:\n--------------------------------------\n1) Create a blobstore key for a large file (1 or 2 GB). Size of the file does not matter if nimbus can be killed while the blob is being created.\n2) while the blob is being created, restart nimbus (this is easiest way to regenerate, there can be various reasons due to which a blob couldn't be successfully created in nimbus)\n3) When nimbus tries to start on restart, it will keep dying due to DirectoryNotEmptyException and never come up.\n\nExpected Behavior\n--------------------------------------\nPartial blobstore key is deleted cleanly and doesn't affect nimbus.\n\nThe actual, incorrect behavior.\n--------------------------------------\n2016-09-14 15:07:48.518 o.a.s.zookeeper [INFO] Queued up for leader lock.\n2016-09-14 15:07:48.576 o.a.s.zookeeper [INFO] xxx gained leadership\n2016-09-14 15:07:48.581 o.a.s.d.nimbus [ERROR] Error on initialization of server service-handler\njava.lang.RuntimeException: java.nio.file.DirectoryNotEmptyException: /opt/storm/storm-local/blobs/955/some_big_file\n\tat org.apache.storm.blobstore.LocalFsBlobStore.deleteBlob(LocalFsBlobStore.java:229)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:497)\n\tat clojure.lang.Reflector.invokeMatchingMethod(Reflector.java:93)\n\tat clojure.lang.Reflector.invokeInstanceMethod(Reflector.java:28)\n\tat org.apache.storm.daemon.nimbus$setup_blobstore.invoke(nimbus.clj:1196)\n\tat org.apache.storm.daemon.nimbus$fn__7064$exec_fn__2461__auto____7065.invoke(nimbus.clj:1416)\n\tat clojure.lang.AFn.applyToHelper(AFn.java:156)\n\tat clojure.lang.AFn.applyTo(AFn.java:144)\n\tat clojure.core$apply.invoke(core.clj:630)\n\tat org.apache.storm.daemon.nimbus$fn__7064$service_handler__7308.doInvoke(nimbus.clj:1358)\n\tat clojure.lang.RestFn.invoke(RestFn.java:421)\n\tat org.apache.storm.daemon.nimbus$launch_server_BANG_.invoke(nimbus.clj:2206)\n\tat org.apache.storm.daemon.nimbus$_launch.invoke(nimbus.clj:2239)\n\tat org.apache.storm.daemon.nimbus$_main.invoke(nimbus.clj:2262)\n\tat clojure.lang.AFn.applyToHelper(AFn.java:152)\n\tat clojure.lang.AFn.applyTo(AFn.java:144)\n\tat org.apache.storm.daemon.nimbus.main(Unknown Source)\nCaused by: java.nio.file.DirectoryNotEmptyException: /opt/storm/storm-local/blobs/955/some_big_file\n\tat sun.nio.fs.UnixFileSystemProvider.implDelete(UnixFileSystemProvider.java:242)\n\tat sun.nio.fs.AbstractFileSystemProvider.deleteIfExists(AbstractFileSystemProvider.java:108)\n\tat java.nio.file.Files.deleteIfExists(Files.java:1165)\n\tat org.apache.storm.blobstore.FileBlobStoreImpl.delete(FileBlobStoreImpl.java:239)\n\tat org.apache.storm.blobstore.FileBlobStoreImpl.deleteKey(FileBlobStoreImpl.java:178)\n\tat org.apache.storm.blobstore.LocalFsBlobStore.deleteBlob(LocalFsBlobStore.java:226)\n\t... 19 more\n2016-09-14 15:07:48.588 o.a.s.util [ERROR] Halting process: (\"Error on initialization\")\njava.lang.RuntimeException: (\"Error on initialization\")\n\tat org.apache.storm.util$exit_process_BANG_.doInvoke(util.clj:341)\n\tat clojure.lang.RestFn.invoke(RestFn.java:423)\n\tat org.apache.storm.daemon.nimbus$fn__7064$service_handler__7308.doInvoke(nimbus.clj:1358)\n\tat clojure.lang.RestFn.invoke(RestFn.java:421)\n\tat org.apache.storm.daemon.nimbus$launch_server_BANG_.invoke(nimbus.clj:2206)\n\tat org.apache.storm.daemon.nimbus$_launch.invoke(nimbus.clj:2239)\n\tat org.apache.storm.daemon.nimbus$_main.invoke(nimbus.clj:2262)\n\tat clojure.lang.AFn.applyToHelper(AFn.java:152)\n\tat clojure.lang.AFn.applyTo(AFn.java:144)\n\tat org.apache.storm.daemon.nimbus.main(Unknown Source)\n\n\n[root]# ls -l  /opt/storm/storm-local/blobs/955/some_big_file\ntotal 591060\n-rw-r--r-- 1 storm storm 605241344 Sep 14 15:07 1473865562841.tmp","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"0.5h","remainingEstimateSeconds":0,"timeSpentSeconds":1800},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Nimbus dies and never recovers due to java.nio.file.DirectoryNotEmptyException","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abid.m","name":"abid.m","key":"abid.m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abid Mohammed","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abid.m","name":"abid.m","key":"abid.m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abid Mohammed","active":true,"timeZone":"Etc/UTC"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":1800,"total":1800,"percent":100},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":1800,"total":1800,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13004935/comment/15785548","id":"15785548","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwissman","name":"mwissman","key":"mwissman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Wissman","active":true,"timeZone":"America/Chicago"},"body":"When nimbus dies while a blob is being created, the temp file is left in the directory. When Nimbus starts up and tries to delete the blob, it's looking for a file named after the blob name. That file doesn't exist, and when the delete of the blob folder is attempted, it fails.\n\nTo fix this, when deleting the folder for the blob, this will also delete any partially uploaded temp files.\n\nI created a pull request for this: https://github.com/apache/storm/pull/1848","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwissman","name":"mwissman","key":"mwissman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Wissman","active":true,"timeZone":"America/Chicago"},"created":"2016-12-29T15:42:57.373+0000","updated":"2016-12-29T15:42:57.373+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13004935/comment/15795160","id":"15795160","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"Thanks [~mwissman], I merged into master, 1.x, 1.0.x branches.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2017-01-03T14:18:39.663+0000","updated":"2017-01-03T14:18:39.663+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2095/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":3,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13004935/worklog/34406","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user mwissman opened a pull request:\n\n    https://github.com/apache/storm/pull/1848\n\n    STORM-2095 remove any remaining files when deleting blobstore directory\n\n    \n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/mwissman/storm 1.0.x-branch\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/1848.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #1848\n    \n----\ncommit 6a922002e96eadfcab635cacbeceed8800f53bd3\nAuthor: Wissman, Matthew <matthew.wissman@here.com>\nDate:   2016-12-29T15:29:39Z\n\n    STORM-2095 remove any remaining files when deleting blobstore directory\n\n----\n","created":"2016-12-29T15:35:53.167+0000","updated":"2016-12-29T15:35:53.167+0000","started":"2016-12-29T15:35:53.167+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"34406","issueId":"13004935"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13004935/worklog/34510","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/1848\n  \n    +1\n","created":"2017-01-03T13:44:15.331+0000","updated":"2017-01-03T13:44:15.331+0000","started":"2017-01-03T13:44:15.330+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"34510","issueId":"13004935"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13004935/worklog/34514","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/storm/pull/1848\n","created":"2017-01-03T14:17:01.232+0000","updated":"2017-01-03T14:17:01.232+0000","started":"2017-01-03T14:17:01.232+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"34514","issueId":"13004935"}]},"customfield_12311820":"0|i33mm7:"}}