{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13016253","self":"https://issues.apache.org/jira/rest/api/2/issue/13016253","key":"STORM-2176","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":3600,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335748","id":"12335748","name":"1.1.0","archived":false,"released":true,"releaseDate":"2017-03-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12337341","id":"12337341","name":"1.0.3","archived":false,"released":true,"releaseDate":"2017-02-14"}],"aggregatetimespent":3600,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2016-11-23T10:05:31.778+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jan 20 01:24:48 UTC 2017","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_6006021446_*|*_3_*:*_1_*:*_1184676097_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2017-01-20T01:24:48.831+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2176/watchers","watchCount":4,"isWatching":false},"created":"2016-10-28T19:59:51.353+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":"STORM-1856","customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329843","id":"12329843","name":"1.0.0","archived":false,"released":true,"releaseDate":"2016-04-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335587","id":"12335587","name":"1.0.1","archived":false,"released":true,"releaseDate":"2016-05-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335747","id":"12335747","name":"1.0.2","archived":false,"released":true,"releaseDate":"2016-08-10"}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-01-20T01:24:48.880+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"This appears to have been introduced in the 1.0.0 release. The issues does not seem to affect 0.10.2.\n\nWhen a topology is killed and workers receive the notification to shutdown, they do not shutdown cleanly, so worker hooks never get invoked.\n\nWhen a worker shuts down cleanly, the worker logs should contain entries such as the following:\n\n{code}\n2016-10-28 18:52:06.273 b.s.d.worker [INFO] Shut down transfer thread\n2016-10-28 18:52:06.279 b.s.d.worker [INFO] Shutting down default resources\n2016-10-28 18:52:06.287 b.s.d.worker [INFO] Shut down default resources\n2016-10-28 18:52:06.351 b.s.d.worker [INFO] Disconnecting from storm cluster state context\n2016-10-28 18:52:06.359 b.s.d.worker [INFO] Shut down worker exclaim-1-1477680593 61bddd66-0fda-4556-b742-4b63f0df6fc1 6700\n{code}\n\nIn the 1.0.x line of releases (and presumably 1.x, though I haven't checked) this does not happen -- the worker shutdown process appears to get stuck shutting down executors (https://github.com/apache/storm/blob/v1.0.2/storm-core/src/clj/org/apache/storm/daemon/worker.clj#L666), no further log messages are seen in the worker log, and worker hooks do not run.\n\nThere are two properties that affect how workers exit. The first is the configuration property {{supervisor.worker.shutdown.sleep.secs}}, which defaults to 1 second. This corresponds to how long the supervisor will wait for a worker to exit gracefully before forcibly killing it with {{kill -9}}. When this happens the supervisor will log that the worker terminated with exit code 137 (128 + 9).\n\nThe second property is a hard-coded 1 second delay (https://github.com/apache/storm/blob/v1.0.2/storm-core/src/clj/org/apache/storm/util.clj#L463) added as a shutdown hook that will call {{Runtime.halt()}} if the delay is exceeded. When this happens, the supervisor will log that the worker terminated with exit code 20 (hard-coded).\n\nSide Note: The hardcoded halt delay in worker.clj and the default value for {{supervisor.worker.shutdown.sleep.secs}} both being 1 second should probably be changed since it creates a race to see whether the supervisor delay or the worker delay wins.\n\n\nTo test this, I set {{supervisor.worker.shutdown.sleep.secs}} to 15 to allow plenty of time for the worker to exit gracefully, and deployed and killed a topology. In this case the supervisor consistently reported exit code 20 for the worker, indicating the hard-coded shutdown hook caused the worker to exit.\n\nI thought the hard-coded 1 second shutdown hook delay might not be long enough for the worker to shutdown cleanly. To test that hypothesis, I changed the hard-code delay to 10 seconds, leaving {{supervisor.worker.shutdown.sleep.secs}} at 15 seconds. Again supervisor reported an exit code of 20 for the worker, and there were no log messages indicating the worker had exited cleanly and that the worker hook had run.\n","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"1h","remainingEstimateSeconds":0,"timeSpentSeconds":3600},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Workers do not shutdown cleanly and worker hooks don't run when a topology is killed","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ptgoetz","name":"ptgoetz","key":"ptgoetz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"P. Taylor Goetz","active":true,"timeZone":"America/Havana"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ptgoetz","name":"ptgoetz","key":"ptgoetz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"P. Taylor Goetz","active":true,"timeZone":"America/Havana"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":3600,"total":3600,"percent":100},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":3600,"total":3600,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13016253/comment/15689620","id":"15689620","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"I can reproduce it with Storm 1.1.0 SNAPSHOT: running org.apache.storm.starter.WordCountTopology to remote cluster always reproduces it.\n\nOne thiing I found is, log messages might not be written properly while shutdown is being in progress.\nI changed the code to leave thread dump just before halting:\n\n{code}\n(defn add-shutdown-hook-with-force-kill-in-1-sec\n  \"adds the user supplied function as a shutdown hook for cleanup.\n   Also adds a function that sleeps for a second and then sends kill -9 to process to avoid any zombie process in case\n   cleanup function hangs.\"\n  [func]\n  (.addShutdownHook (Runtime/getRuntime) (Thread. #(func)))\n  (.addShutdownHook (Runtime/getRuntime) (Thread. #((sleep-secs 1)\n                                                     (log-message \"Shutdown doesn't end in 1 sec, force shutdown\")\n                                                     (log-message (Utils/threadDump))\n                                                     (print \"Shutdown doesn't end in 1 sec, force shutdown\")\n                                                     (print (Utils/threadDump))\n                                                    (.halt (Runtime/getRuntime) 20)))))\n{code}\n\nWith multiple workers I can't get any log messages. After reducing worker into one I can get stack trace log but only from  STDERR (not printed twice), and it seems not print whole stack trace.\n\n{code}\n2016-11-23 18:37:59.535 o.a.s.d.worker Thread-59 [INFO] Shutting down worker wordcount-3-1479893791 95a6817f-678d-40a5-ac78-4b6047b4e77f 6700\n2016-11-23 18:37:59.535 o.a.s.d.worker Thread-59 [INFO] Terminating messaging context\n2016-11-23 18:37:59.535 o.a.s.d.worker Thread-59 [INFO] Shutting down executors\n2016-11-23 18:37:59.536 o.a.s.d.executor Thread-59 [INFO] Shutting down executor count:[8 8]\n2016-11-23 18:38:00.547 STDERR Thread-2 [INFO] Shutdown doesn't end in 1 sec, force shutdown\"SIGTERM handler\"\n2016-11-23 18:38:00.550 STDERR Thread-2 [INFO]    lock: java.lang.Class@1153f092 owner: Thread-63\n2016-11-23 18:38:00.551 STDERR Thread-2 [INFO]    java.lang.Thread.State: BLOCKED\n2016-11-23 18:38:00.551 STDERR Thread-2 [INFO]         at java.lang.Shutdown.exit(Shutdown.java:212)\n2016-11-23 18:38:00.551 STDERR Thread-2 [INFO]         at java.lang.Terminator$1.handle(Terminator.java:52)\n2016-11-23 18:38:00.551 STDERR Thread-2 [INFO]         at sun.misc.Signal$1.run(Signal.java:212)\n2016-11-23 18:38:00.551 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.551 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.551 STDERR Thread-2 [INFO] \"Thread-60\"\n2016-11-23 18:38:00.552 STDERR Thread-2 [INFO]    lock: null owner: null\n2016-11-23 18:38:00.552 STDERR Thread-2 [INFO]    java.lang.Thread.State: RUNNABLE\n2016-11-23 18:38:00.552 STDERR Thread-2 [INFO]         at sun.management.ThreadImpl.getThreadInfo1(Native Method)\n2016-11-23 18:38:00.552 STDERR Thread-2 [INFO]         at sun.management.ThreadImpl.getThreadInfo(ThreadImpl.java:174)\n2016-11-23 18:38:00.552 STDERR Thread-2 [INFO]         at org.apache.storm.utils.Utils.threadDump(Utils.java:1284)\n2016-11-23 18:38:00.553 STDERR Thread-2 [INFO]         at org.apache.storm.util$add_shutdown_hook_with_force_kill_in_1_sec$fn__496.invoke(util.clj:466)\n2016-11-23 18:38:00.553 STDERR Thread-2 [INFO]         at clojure.lang.AFn.run(AFn.java:22)\n2016-11-23 18:38:00.553 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.553 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.553 STDERR Thread-2 [INFO] \"process reaper\"\n2016-11-23 18:38:00.554 STDERR Thread-2 [INFO]    lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n2016-11-23 18:38:00.554 STDERR Thread-2 [INFO]    java.lang.Thread.State: TIMED_WAITING\n2016-11-23 18:38:00.554 STDERR Thread-2 [INFO]         at sun.misc.Unsafe.park(Native Method)\n2016-11-23 18:38:00.554 STDERR Thread-2 [INFO]         at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n2016-11-23 18:38:00.554 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n2016-11-23 18:38:00.555 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n2016-11-23 18:38:00.555 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n2016-11-23 18:38:00.555 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n2016-11-23 18:38:00.555 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n2016-11-23 18:38:00.556 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n2016-11-23 18:38:00.556 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.556 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.556 STDERR Thread-2 [INFO] \"Thread-65\"\n2016-11-23 18:38:00.556 STDERR Thread-2 [INFO]    lock: java.lang.Class@1153f092 owner: Thread-63\n2016-11-23 18:38:00.557 STDERR Thread-2 [INFO]    java.lang.Thread.State: BLOCKED\n2016-11-23 18:38:00.557 STDERR Thread-2 [INFO]         at java.lang.Shutdown.exit(Shutdown.java:212)\n2016-11-23 18:38:00.559 STDERR Thread-2 [INFO]         at java.lang.Runtime.exit(Runtime.java:109)\n2016-11-23 18:38:00.559 STDERR Thread-2 [INFO]         at java.lang.System.exit(System.java:971)\n2016-11-23 18:38:00.560 STDERR Thread-2 [INFO]         at org.apache.storm.task.ShellBolt.die(ShellBolt.java:321)\n2016-11-23 18:38:00.560 STDERR Thread-2 [INFO]         at org.apache.storm.task.ShellBolt.access$400(ShellBolt.java:70)\n2016-11-23 18:38:00.560 STDERR Thread-2 [INFO]         at org.apache.storm.task.ShellBolt$BoltWriterRunnable.run(ShellBolt.java:417)\n2016-11-23 18:38:00.560 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.560 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.560 STDERR Thread-2 [INFO] \"Thread-63\"\n2016-11-23 18:38:00.560 STDERR Thread-2 [INFO]    lock: java.lang.Thread@7209ffb5 owner: null\n2016-11-23 18:38:00.561 STDERR Thread-2 [INFO]    java.lang.Thread.State: WAITING\n2016-11-23 18:38:00.561 STDERR Thread-2 [INFO]         at java.lang.Object.wait(Native Method)\n2016-11-23 18:38:00.561 STDERR Thread-2 [INFO]         at java.lang.Thread.join(Thread.java:1245)\n2016-11-23 18:38:00.561 STDERR Thread-2 [INFO]         at java.lang.Thread.join(Thread.java:1319)\n2016-11-23 18:38:00.561 STDERR Thread-2 [INFO]         at java.lang.ApplicationShutdownHooks.runHooks(ApplicationShutdownHooks.java:106)\n2016-11-23 18:38:00.561 STDERR Thread-2 [INFO]         at java.lang.ApplicationShutdownHooks$1.run(ApplicationShutdownHooks.java:46)\n2016-11-23 18:38:00.562 STDERR Thread-2 [INFO]         at java.lang.Shutdown.runHooks(Shutdown.java:123)\n2016-11-23 18:38:00.562 STDERR Thread-2 [INFO]         at java.lang.Shutdown.sequence(Shutdown.java:167)\n2016-11-23 18:38:00.562 STDERR Thread-2 [INFO]         at java.lang.Shutdown.exit(Shutdown.java:212)\n2016-11-23 18:38:00.562 STDERR Thread-2 [INFO]         at java.lang.Runtime.exit(Runtime.java:109)\n2016-11-23 18:38:00.562 STDERR Thread-2 [INFO]         at java.lang.System.exit(System.java:971)\n2016-11-23 18:38:00.562 STDERR Thread-2 [INFO]         at org.apache.storm.task.ShellBolt.die(ShellBolt.java:321)\n2016-11-23 18:38:00.562 STDERR Thread-2 [INFO]         at org.apache.storm.task.ShellBolt.access$400(ShellBolt.java:70)\n2016-11-23 18:38:00.563 STDERR Thread-2 [INFO]         at org.apache.storm.task.ShellBolt$BoltReaderRunnable.run(ShellBolt.java:386)\n2016-11-23 18:38:00.563 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.563 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.563 STDERR Thread-2 [INFO] \"Thread-61\"\n2016-11-23 18:38:00.563 STDERR Thread-2 [INFO]    lock: java.lang.Class@1153f092 owner: Thread-63\n2016-11-23 18:38:00.564 STDERR Thread-2 [INFO]    java.lang.Thread.State: BLOCKED\n2016-11-23 18:38:00.564 STDERR Thread-2 [INFO]         at java.lang.Shutdown.exit(Shutdown.java:212)\n2016-11-23 18:38:00.564 STDERR Thread-2 [INFO]         at java.lang.Runtime.exit(Runtime.java:109)\n2016-11-23 18:38:00.564 STDERR Thread-2 [INFO]         at java.lang.System.exit(System.java:971)\n2016-11-23 18:38:00.564 STDERR Thread-2 [INFO]         at org.apache.storm.task.ShellBolt.die(ShellBolt.java:321)\n2016-11-23 18:38:00.565 STDERR Thread-2 [INFO]         at org.apache.storm.task.ShellBolt.access$400(ShellBolt.java:70)\n2016-11-23 18:38:00.565 STDERR Thread-2 [INFO]         at org.apache.storm.task.ShellBolt$BoltReaderRunnable.run(ShellBolt.java:386)\n2016-11-23 18:38:00.565 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.565 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.565 STDERR Thread-2 [INFO] \"process reaper\"\n2016-11-23 18:38:00.565 STDERR Thread-2 [INFO]    lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n2016-11-23 18:38:00.565 STDERR Thread-2 [INFO]    java.lang.Thread.State: TIMED_WAITING\n2016-11-23 18:38:00.565 STDERR Thread-2 [INFO]         at sun.misc.Unsafe.park(Native Method)\n2016-11-23 18:38:00.566 STDERR Thread-2 [INFO]         at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n2016-11-23 18:38:00.566 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n2016-11-23 18:38:00.566 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n2016-11-23 18:38:00.566 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n2016-11-23 18:38:00.566 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n2016-11-23 18:38:00.566 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n2016-11-23 18:38:00.566 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n2016-11-23 18:38:00.567 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.567 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.567 STDERR Thread-2 [INFO] \"process reaper\"\n2016-11-23 18:38:00.567 STDERR Thread-2 [INFO]    lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n2016-11-23 18:38:00.567 STDERR Thread-2 [INFO]    java.lang.Thread.State: TIMED_WAITING\n2016-11-23 18:38:00.567 STDERR Thread-2 [INFO]         at sun.misc.Unsafe.park(Native Method)\n2016-11-23 18:38:00.568 STDERR Thread-2 [INFO]         at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n2016-11-23 18:38:00.568 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n2016-11-23 18:38:00.568 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n2016-11-23 18:38:00.568 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n2016-11-23 18:38:00.568 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n2016-11-23 18:38:00.569 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n2016-11-23 18:38:00.569 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n2016-11-23 18:38:00.569 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.569 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.569 STDERR Thread-2 [INFO] \"process reaper\"\n2016-11-23 18:38:00.569 STDERR Thread-2 [INFO]    lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n2016-11-23 18:38:00.569 STDERR Thread-2 [INFO]    java.lang.Thread.State: TIMED_WAITING\n2016-11-23 18:38:00.569 STDERR Thread-2 [INFO]         at sun.misc.Unsafe.park(Native Method)\n2016-11-23 18:38:00.570 STDERR Thread-2 [INFO]         at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n2016-11-23 18:38:00.570 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n2016-11-23 18:38:00.570 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n2016-11-23 18:38:00.570 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n2016-11-23 18:38:00.570 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n2016-11-23 18:38:00.570 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n2016-11-23 18:38:00.570 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n2016-11-23 18:38:00.570 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.571 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.571 STDERR Thread-2 [INFO] \"process reaper\"\n2016-11-23 18:38:00.571 STDERR Thread-2 [INFO]    lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n2016-11-23 18:38:00.571 STDERR Thread-2 [INFO]    java.lang.Thread.State: TIMED_WAITING\n2016-11-23 18:38:00.572 STDERR Thread-2 [INFO]         at sun.misc.Unsafe.park(Native Method)\n2016-11-23 18:38:00.572 STDERR Thread-2 [INFO]         at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n2016-11-23 18:38:00.572 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n2016-11-23 18:38:00.572 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n2016-11-23 18:38:00.572 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n2016-11-23 18:38:00.573 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n2016-11-23 18:38:00.573 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n2016-11-23 18:38:00.573 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n2016-11-23 18:38:00.573 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.573 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.573 STDERR Thread-2 [INFO] \"process reaper\"\n2016-11-23 18:38:00.574 STDERR Thread-2 [INFO]    lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n2016-11-23 18:38:00.574 STDERR Thread-2 [INFO]    java.lang.Thread.State: TIMED_WAITING\n2016-11-23 18:38:00.574 STDERR Thread-2 [INFO]         at sun.misc.Unsafe.park(Native Method)\n2016-11-23 18:38:00.574 STDERR Thread-2 [INFO]         at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n2016-11-23 18:38:00.575 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n2016-11-23 18:38:00.575 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n2016-11-23 18:38:00.575 STDERR Thread-2 [INFO]         at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n2016-11-23 18:38:00.575 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n2016-11-23 18:38:00.575 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n2016-11-23 18:38:00.575 STDERR Thread-2 [INFO]         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n2016-11-23 18:38:00.575 STDERR Thread-2 [INFO]         at java.lang.Thread.run(Thread.java:745)\n2016-11-23 18:38:00.576 STDERR Thread-2 [INFO]\n2016-11-23 18:38:00.576 STDERR Thread-2 [INFO] \"process reaper\"\n2016-11-23 18:38:00.582 STDERR Thread-2 [INFO]    lock: java.util.concurrent.SynchronousQueue$Trans\n{code}\n\nso as worker.log.err.\n\n{code}\nShutdown doesn't end in 1 sec, force shutdown\"SIGTERM handler\"\n   lock: java.lang.Class@1153f092 owner: Thread-63\n   java.lang.Thread.State: BLOCKED\n        at java.lang.Shutdown.exit(Shutdown.java:212)\n        at java.lang.Terminator$1.handle(Terminator.java:52)\n        at sun.misc.Signal$1.run(Signal.java:212)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"Thread-60\"\n   lock: null owner: null\n   java.lang.Thread.State: RUNNABLE\n        at sun.management.ThreadImpl.getThreadInfo1(Native Method)\n        at sun.management.ThreadImpl.getThreadInfo(ThreadImpl.java:174)\n        at org.apache.storm.utils.Utils.threadDump(Utils.java:1284)\n        at org.apache.storm.util$add_shutdown_hook_with_force_kill_in_1_sec$fn__496.invoke(util.clj:466)\n        at clojure.lang.AFn.run(AFn.java:22)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"process reaper\"\n   lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n   java.lang.Thread.State: TIMED_WAITING\n        at sun.misc.Unsafe.park(Native Method)\n        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n        at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n        at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n        at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"Thread-65\"\n   lock: java.lang.Class@1153f092 owner: Thread-63\n   java.lang.Thread.State: BLOCKED\n        at java.lang.Shutdown.exit(Shutdown.java:212)\n        at java.lang.Runtime.exit(Runtime.java:109)\n        at java.lang.System.exit(System.java:971)\n        at org.apache.storm.task.ShellBolt.die(ShellBolt.java:321)\n        at org.apache.storm.task.ShellBolt.access$400(ShellBolt.java:70)\n        at org.apache.storm.task.ShellBolt$BoltWriterRunnable.run(ShellBolt.java:417)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"Thread-63\"\n   lock: java.lang.Thread@7209ffb5 owner: null\n   java.lang.Thread.State: WAITING\n        at java.lang.Object.wait(Native Method)\n        at java.lang.Thread.join(Thread.java:1245)\n        at java.lang.Thread.join(Thread.java:1319)\n        at java.lang.ApplicationShutdownHooks.runHooks(ApplicationShutdownHooks.java:106)\n        at java.lang.ApplicationShutdownHooks$1.run(ApplicationShutdownHooks.java:46)\n        at java.lang.Shutdown.runHooks(Shutdown.java:123)\n        at java.lang.Shutdown.sequence(Shutdown.java:167)\n        at java.lang.Shutdown.exit(Shutdown.java:212)\n        at java.lang.Runtime.exit(Runtime.java:109)\n        at java.lang.System.exit(System.java:971)\n        at org.apache.storm.task.ShellBolt.die(ShellBolt.java:321)\n        at org.apache.storm.task.ShellBolt.access$400(ShellBolt.java:70)\n        at org.apache.storm.task.ShellBolt$BoltReaderRunnable.run(ShellBolt.java:386)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"Thread-61\"\n   lock: java.lang.Class@1153f092 owner: Thread-63\n   java.lang.Thread.State: BLOCKED\n        at java.lang.Shutdown.exit(Shutdown.java:212)\n        at java.lang.Runtime.exit(Runtime.java:109)\n        at java.lang.System.exit(System.java:971)\n        at org.apache.storm.task.ShellBolt.die(ShellBolt.java:321)\n        at org.apache.storm.task.ShellBolt.access$400(ShellBolt.java:70)\n        at org.apache.storm.task.ShellBolt$BoltReaderRunnable.run(ShellBolt.java:386)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"process reaper\"\n   lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n   java.lang.Thread.State: TIMED_WAITING\n        at sun.misc.Unsafe.park(Native Method)\n        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n        at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n        at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n        at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"process reaper\"\n   lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n   java.lang.Thread.State: TIMED_WAITING\n        at sun.misc.Unsafe.park(Native Method)\n        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n        at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n        at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n        at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"process reaper\"\n   lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n   java.lang.Thread.State: TIMED_WAITING\n        at sun.misc.Unsafe.park(Native Method)\n        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n        at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n        at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n        at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"process reaper\"\n   lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n   java.lang.Thread.State: TIMED_WAITING\n        at sun.misc.Unsafe.park(Native Method)\n        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n        at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n        at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n        at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"process reaper\"\n   lock: java.util.concurrent.SynchronousQueue$TransferStack@1f940cc8 owner: null\n   java.lang.Thread.State: TIMED_WAITING\n        at sun.misc.Unsafe.park(Native Method)\n        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n        at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:460)\n        at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)\n        at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:941)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1066)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1127)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n\n\"process reaper\"\n   lock: java.util.concurrent.SynchronousQueue$Trans\n{code}\n\nSupervisor log for that worker is below:\n{code}\n2016-11-23 18:37:59.493 SLOT_6700 o.a.s.d.s.Container [INFO] Killing 95a6817f-678d-40a5-ac78-4b6047b4e77f:0337f37e-f9a2-4278-a855-075425127b32\n2016-11-23 18:38:00.601 Thread-57 o.a.s.d.s.BasicContainer [INFO] Worker Process 0337f37e-f9a2-4278-a855-075425127b32 exited with code: 20\n{code}\n\n[~ptgoetz]\nIs it multilang topology, or normal topology? In multilang topology, worker often get into other issue when killing topology so it might affect shutdown process, but I'm not sure.\n\n{code}\n2016-11-23 18:37:59.517 o.a.s.t.ShellBolt Thread-63 [ERROR] Halting process: ShellBolt died. Command: [python, splitsentence.py], ProcessInfo pid:20336, name:split exitCode:143, errorString:\njava.lang.RuntimeException: org.apache.storm.multilang.NoOutputException: Pipe to subprocess seems to be broken! No output read.\nSerializer Exception:\n\n\n\tat org.apache.storm.utils.ShellProcess.readShellMsg(ShellProcess.java:127) ~[storm-core-1.1.0-SNAPSHOT.jar:1.1.0-SNAPSHOT]\n\tat org.apache.storm.task.ShellBolt$BoltReaderRunnable.run(ShellBolt.java:352) [storm-core-1.1.0-SNAPSHOT.jar:1.1.0-SNAPSHOT]\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_66]\n2016-11-23 18:37:59.521 o.a.s.d.executor Thread-63 [ERROR]\njava.lang.RuntimeException: org.apache.storm.multilang.NoOutputException: Pipe to subprocess seems to be broken! No output read.\nSerializer Exception:\n\n\n\tat org.apache.storm.utils.ShellProcess.readShellMsg(ShellProcess.java:127) ~[storm-core-1.1.0-SNAPSHOT.jar:1.1.0-SNAPSHOT]\n\tat org.apache.storm.task.ShellBolt$BoltReaderRunnable.run(ShellBolt.java:352) [storm-core-1.1.0-SNAPSHOT.jar:1.1.0-SNAPSHOT]\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_66]\n2016-11-23 18:37:59.529 o.a.s.t.ShellBolt Thread-61 [ERROR] Halting process: ShellBolt died. Command: [python, splitsentence.py], ProcessInfo pid:20337, name:split exitCode:143, errorString:\njava.lang.RuntimeException: org.apache.storm.multilang.NoOutputException: Pipe to subprocess seems to be broken! No output read.\nSerializer Exception:\n\n\n\tat org.apache.storm.utils.ShellProcess.readShellMsg(ShellProcess.java:127) ~[storm-core-1.1.0-SNAPSHOT.jar:1.1.0-SNAPSHOT]\n\tat org.apache.storm.task.ShellBolt$BoltReaderRunnable.run(ShellBolt.java:352) [storm-core-1.1.0-SNAPSHOT.jar:1.1.0-SNAPSHOT]\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_66]\n2016-11-23 18:37:59.530 o.a.s.d.executor Thread-61 [ERROR]\njava.lang.RuntimeException: org.apache.storm.multilang.NoOutputException: Pipe to subprocess seems to be broken! No output read.\nSerializer Exception:\n\n\n\tat org.apache.storm.utils.ShellProcess.readShellMsg(ShellProcess.java:127) ~[storm-core-1.1.0-SNAPSHOT.jar:1.1.0-SNAPSHOT]\n\tat org.apache.storm.task.ShellBolt$BoltReaderRunnable.run(ShellBolt.java:352) [storm-core-1.1.0-SNAPSHOT.jar:1.1.0-SNAPSHOT]\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2016-11-23T10:05:31.778+0000","updated":"2016-11-23T10:05:31.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13016253/comment/15803845","id":"15803845","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"Investigated this and got some informations:\n\n1. As Taylor stated, give same seconds to supervisor waiting time and worker waiting time doesn't make sense. Supervisor should wait longer. If not there's no reason for worker to kill itself.\n\n2. For normal topology, after adjusting seconds I got error code 143 (128 + 15), which seems to be expected.\n<= CORRECTION: It should be 20. I was modifying the code around this, and hook for waiting and shutdown seemed to have a bug.\n\n3. If worker has one or more multi-lang tasks, for now they are having high chance to raise NoOutputException in progress of shutting down (yes we should fix that, but not considered as critical for me), and when it calls System.exit() to give up, worker is going into deadlock since shutdown hook is already running.\n\nhttps://dzone.com/articles/know-jvm-series-2-shutdown\n\n{quote}\n5. Once shutdown sequence starts, it can be stopped by Runtime.halt() only.\n\nOnce the shutdown sequence starts, only Runtime.halt() (which forcefully terminates the JVM) can stop the execution of the shutdown sequence (except for external influences such as SIGKILL). This means that calling System.exit() with in a Shutdown Hook will not work. Actually, if you call System.exit() with in a Shutdown Hook, the VM will get stuck, and you have to terminate the process forcefully.\n{quote}\n\n4. Why log is not written after shutdown is starting is not relevant to this issue.\nLog4j2 also registers shutdown hook to close its resource, and after hook is run we're unable to log.\n(I'm not sure it is only related to async logger.)\nGiven that JVM runs shutdown hooks concurrently without guaranteeing the sequence, eventually log is not written to anywhere.\nLog4j2 provides configuration to disable its shutdown hook: add attribute shutdownHook=\"disable\" to the configuration tag.\n\nNot sure it makes any leaks, but given that we're losing logs shutdown hook for log4j2 should be disabled.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2017-01-06T07:26:54.944+0000","updated":"2017-01-06T07:42:53.346+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13016253/comment/15803954","id":"15803954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"I'm testing on multi-lang topology now, and found it also works well. \nEven NoOutputException is occurred after shutdown hook is started, other threads do their cleanup, and one of shutdown hook calls Runtime.getRuntime.halt(20) after 1 seconds to force shutting down JVM.\n\nSo I guess we don't have an issue except race condition for killing between supervisor and worker itself. But silently dropped logs make us confusing.\n\nI'll submit a patch regarding adjusting supervisor sleep secs, and also disabling shutdown hook for Log4j2.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2017-01-06T08:19:54.041+0000","updated":"2017-01-06T08:19:54.041+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13016253/comment/15830978","id":"15830978","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"Merged into master, 1.x, 1.0.x branches.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2017-01-20T01:24:48.867+0000","updated":"2017-01-20T01:24:48.867+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2176/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":6,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13016253/worklog/34847","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user HeartSaVioR opened a pull request:\n\n    https://github.com/apache/storm/pull/1864\n\n    STORM-2176 Workers do not shutdown cleanly and worker hooks don't run when a topology is killed\n\n    * increase supervisor.worker.shutdown.sleep.secs to let workers kill themselves first even stuck\n    * disable shutdown hook for log4j2 to make sure logs are written after shutdown is started\n    \n    Please note that I didn't touch JVM's shutdown hook (leaving it to sleep 1 sec and halt) given that 1 sec looks enough if there's no issue on the worker. In fact shutdown hook shouldn't take too much time.\n    \n    Given that this is blocker for releasing 1.0.3 and 1.1.0, please review soon so that we can go ahead.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/HeartSaVioR/storm STORM-2176\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/1864.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #1864\n    \n----\ncommit 296828704431e9e481a470e1f2ee6ac8aa15c865\nAuthor: Jungtaek Lim <kabhwan@gmail.com>\nDate:   2017-01-06T08:21:05Z\n\n    STORM-2176 Workers do not shutdown cleanly and worker hooks don't run when a topology is killed\n    \n    * increase supervisor.worker.shutdown.sleep.secs to let workers kill themselves first even stuck\n    * disable shutdown hook for log4j2 to make sure logs are written after shutdown is started\n\n----\n","created":"2017-01-06T08:37:15.218+0000","updated":"2017-01-06T08:37:15.218+0000","started":"2017-01-06T08:37:15.217+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"34847","issueId":"13016253"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13016253/worklog/34848","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/1864\n  \n    cherry-picking will work for 1.x and 1.0.x branches.\n","created":"2017-01-06T08:42:04.327+0000","updated":"2017-01-06T08:42:04.327+0000","started":"2017-01-06T08:42:04.327+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"34848","issueId":"13016253"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13016253/worklog/34849","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/1864\n  \n    @ptgoetz Could you test my patch to see it can resolve STORM-2176 pretty well?\n","created":"2017-01-06T08:44:18.027+0000","updated":"2017-01-06T08:44:18.027+0000","started":"2017-01-06T08:44:18.026+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"34849","issueId":"13016253"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13016253/worklog/35937","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/1864\n  \n    @ptgoetz Ping again. I think we can start release process for 1.0.3 after this, so would like to review this soon.\n","created":"2017-01-19T08:20:21.480+0000","updated":"2017-01-19T08:20:21.480+0000","started":"2017-01-19T08:20:21.480+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"35937","issueId":"13016253"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13016253/worklog/36022","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user ptgoetz commented on the issue:\n\n    https://github.com/apache/storm/pull/1864\n  \n    +1\n    \n    In local mode, I found that the JVM never exits, but that's likely a different issue.\n","created":"2017-01-19T19:48:08.762+0000","updated":"2017-01-19T19:48:08.762+0000","started":"2017-01-19T19:48:08.762+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"36022","issueId":"13016253"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13016253/worklog/36027","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/storm/pull/1864\n","created":"2017-01-20T01:23:36.866+0000","updated":"2017-01-20T01:23:36.866+0000","started":"2017-01-20T01:23:36.866+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"36027","issueId":"13016253"}]},"customfield_12311820":"0|i35k93:"}}