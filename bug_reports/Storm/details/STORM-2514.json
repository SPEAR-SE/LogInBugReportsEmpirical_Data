{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13072101","self":"https://issues.apache.org/jira/rest/api/2/issue/13072101","key":"STORM-2514","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-05-15T22:48:41.030+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Apr 30 19:16:00 UTC 2018","customfield_12312320":null,"customfield_12310222":null,"customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2514/watchers","watchCount":4,"isWatching":false},"created":"2017-05-15T18:13:27.223+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hmclouro","name":"hmclouro","key":"hmclouro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hugo Louro","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-04-30T19:17:40.041+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/3","description":"This issue is being actively worked on at the moment by the assignee.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/inprogress.png","name":"In Progress","id":"3","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12331080","id":"12331080","name":"storm-kafka-client"}],"timeoriginalestimate":null,"description":"While working on [STORM-2506|https://issues.apache.org/jira/browse/STORM-2506], the worker logs were generated with debug mode on. The information printed about mapping between Task IDs and kafka partitions was contradictory to my assumptions. I ran a topology which used KafkaSpout from the storm-kafka-client module, it had a parallelism hint of 2 (number of executors) and a total of 16 tasks. \nThe log lines mentioned below show assigned mapping between executors and kafka partitions:\n{noformat}\no.a.k.c.c.i.ConsumerCoordinator Thread-12-kafkaspout-executor[3 10] [INFO] Setting newly assigned partitions [8topic-4, 8topic-6, 8topic-5, 8topic-7] for group kafkaSpoutTestGroup\no.a.s.k.s.KafkaSpout Thread-12-kafkaspout-executor[3 10] [INFO] Partitions reassignment. [taskID=10, consumer-group=kafkaSpoutTestGroup, consumer=org.apache.kafka.clients.consumer.KafkaConsumer@108e79ce, topic-partitions=[8topic-4, 8topic-6, 8topic-5, 8topic-7]]\no.a.k.c.c.i.ConsumerCoordinator Thread-8-kafkaspout-executor[11 18] [INFO] Setting newly assigned partitions [8topic-2, 8topic-1, 8topic-3, 8topic-0] for group kafkaSpoutTestGroup\no.a.s.k.s.KafkaSpout Thread-8-kafkaspout-executor[11 18] [INFO] Partitions reassignment. [taskID=15, consumer-group=kafkaSpoutTestGroup, consumer=org.apache.kafka.clients.consumer.KafkaConsumer@2dc37126, topic-partitions=[8topic-2, 8topic-1, 8topic-3, 8topic-0]]\n{noformat}\n\nIt is evident that only tasks (with ID 3, 4, 5, 6, 7, 8, 9, 10) in Executor1 (3 10) will be reading from kafka partitions 4, 5, 6 and 7. Similarly, tasks in Executor2 (11 18) will be reading from kafka partitions 0, 1, 2 and 3. These log lines are being printed by Tasks with IDs 10 and 15 in respective executors. \n\nLogs which emit individual messages do not abide by the above assumption. For example in the log mentioned below, Task ID 3 (added code, as a part of debugging STORM-2506, to print the Task ID right next to component ID) which runs on Executor1 reads from partition 2 (the second value inside the square brackets), instead of 4, 5, 6 or 7. \n\n{noformat}Thread-12-kafkaspout-executor[3 10] [INFO] Emitting: kafkaspout 3 default [8topic, 2, 0, null, 1]{noformat}\n\nThis behavior has been summarized in the table below : \n{noformat}\nTask IDs ------- 3, 4, 7, 8, 9, 11, 15, 18 ------------ Partitions 0, 1, 2, 3\nTask IDs ------- 5, 6, 10, 12, 13, 14, 16, 17 --------- Partition 4, 5, 6, 7\n{noformat}\n\n[You can find the relevant parts of log file here.|https://gist.github.com/srishtyagrawal/f7c53db6b8391e2c3bd522afc93b5351] \n\nAm I misunderstanding something here? Do tasks {{5, 6, 10, 12, 13, 14, 16, 17}} correspond to executor1 and {{3, 4, 7, 8, 9, 11, 15, 18}} correspond to executor2? Are (3 10) not the starting and ending task IDs in Executor1? \n\nAnother interesting thing to note is that, Task IDs 10 and 15 are always reading from the partitions they claimed to be reading from (while setting partition assignments). \n\nIf my assumptions are correct, there is a bug in the way the mapping information is being/passed to worker logs. If not, we need to make changes in our docs.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12868545","id":"12868545","filename":"NewClass.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-05-17T15:20:11.387+0000","size":3810,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12868545/NewClass.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12868418","id":"12868418","filename":"worker.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-16T23:06:14.636+0000","size":42505834,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12868418/worker.log"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Incorrect logs for mapping between Kafka partitions and task IDs","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16011341","id":"16011341","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"body":"[~erikdw], [~Srdo], [~revans2], [~harshach] kindly provide your insight on this issue. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-15T21:16:05.956+0000","updated":"2017-05-15T21:16:05.956+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16011458","id":"16011458","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Hi. Yes, the numbers in the brackets for the executor thread are the tasks that executor is running, they should be set here https://github.com/apache/storm/blob/a4afacd9617d620f50cf026fc599821f7ac25c79/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java#L589.\n\nI think executor1 should correspond to tasks 3,4,5,6,7,8,9,10, and executor2 should correspond to 11,12,13,14,15,16,17,18. How did you get the task lists you posted?\n\nI don't think it's exactly right that all the tasks in executor1 (3 10) will be reading from topics 4,6,5,7. Each task has its own spout instance (and corresponding KafkaConsumer), so only task 10 is actually assigned those partitions at the start of the log. I'm not sure how task 3 is even emitting anything? Is the start of the log the first occurence of partition assignments in the log?\n\nI also noticed that many tasks are emitting what appears to be the same message? e.g. \n\n{code}\n2017-05-03 13:50:47.655 o.a.s.d.task Thread-8-kafkaspout-executor[11 18] [INFO] Emitting: kafkaspout 18 default [8topic, 2, 0, null, 1]\n2017-05-03 13:50:47.658 o.a.s.d.task Thread-8-kafkaspout-executor[11 18] [INFO] Emitting: kafkaspout 11 default [8topic, 2, 0, null, 1]\n2017-05-03 13:50:47.660 o.a.s.d.task Thread-12-kafkaspout-executor[3 10] [INFO] Emitting: kafkaspout 7 default [8topic, 2, 0, null, 1]\n2017-05-03 13:50:47.670 o.a.s.d.task Thread-12-kafkaspout-executor[3 10] [INFO] Emitting: kafkaspout 8 default [8topic, 2, 0, null, 1]\n{code}\n\nAre you using automatic or manual subscription to Kafka?\n\nCaveat: I haven't really looked too much at the executor/task code before, so everything I posted above may be wrong :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-05-15T22:48:41.030+0000","updated":"2017-05-15T22:48:41.030+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16013088","id":"16013088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Out of curiosity are you seeing weird logs if you have one task per executor?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-05-16T20:49:07.914+0000","updated":"2017-05-16T20:49:07.914+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16013239","id":"16013239","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for the clarification. Please find answers to your questions inline:\n\n*How did you get the task lists you posted?*\n{noformat}\nTask IDs ------- 3, 4, 7, 8, 9, 11, 15, 18 ------------ Partitions 0, 1, 2, 3\nTask IDs ------- 5, 6, 10, 12, 13, 14, 16, 17 --------- Partition 4, 5, 6, 7\n{noformat}\nThe above table has been derived from the worker logs. For instance, if you search for {{kafkaspout 3}}, which means Task ID 3, you will find results for messages which are being read from partitions 0, 1, 2 and 3. This table seems to convey that {noformat}  5, 6, 10, 12, 13, 14, 16, 17 correspond to executor1 and 3, 4, 7, 8, 9, 11, 15, 18 correspond to executor2 {noformat}\nIf I assume that Executor1 should only be running tasks 3, 4, 5, 6, 7, 8, 9, 10, then only these tasks should be reading from partitions 4, 5, 6 or 7.\n\n*I don't think it's exactly right that all the tasks in executor1 (3 10) will be reading from topics 4,6,5,7.*\nSorry for the confusion, I meant only tasks in Executor1 should read from the partitions 4, 5, 6 or 7. I have re-worded the same in the description above. I agree that there is a possibility that not all the tasks will end up reading from partitions 4, 5, 6 and 7.\n\n*Each task has its own spout instance (and corresponding KafkaConsumer), so only task 10 is actually assigned those partitions at the start of the log. I'm not sure how task 3 is even emitting anything?*\nShouldn’t 3 more tasks (from Executor1) apart from task ID 10 be assigned to read from partitions 4, 5, 6 and 7. If there are more tasks than the number of partitions there should be one to one mapping between tasks and partitions is what I remember reading in the docs. Hence it is not surprising for me that task 3 is reading from a Kafka partition, although it does not seem to read from the assigned Kafka partition (according to the {{Setting newly assigned}} log line ).\n\n*I also noticed that many tasks are emitting what appears to be the same message?*\n{noformat}\ne.g.\n2017-05-03 13:50:47.655 o.a.s.d.task Thread-8-kafkaspout-executor[11 18] [INFO] Emitting: kafkaspout 18 default [8topic, 2, 0, null, 1]\n2017-05-03 13:50:47.658 o.a.s.d.task Thread-8-kafkaspout-executor[11 18] [INFO] Emitting: kafkaspout 11 default [8topic, 2, 0, null, 1]\n2017-05-03 13:50:47.660 o.a.s.d.task Thread-12-kafkaspout-executor[3 10] [INFO] Emitting: kafkaspout 7 default [8topic, 2, 0, null, 1]\n2017-05-03 13:50:47.670 o.a.s.d.task Thread-12-kafkaspout-executor[3 10] [INFO] Emitting: kafkaspout 8 default [8topic, 2, 0, null, 1]\n{noformat}\nAre you deriving this information from the fact that all of the above messages have the same message ID (0) ? \n\n*Is the start of the log the first occurrence of partition assignments in the log?*\nNo, I have randomly taken a segment from the worker logs. I am attaching the full worker.log file in this ticket.\n\n*Are you using automatic or manual subscription to Kafka?*\nI did not understand the question. I am running Kafka on my local machine and using a KafkaSpout to read a topic from this local instance of Kafka. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-16T23:04:42.169+0000","updated":"2017-05-16T23:08:21.416+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16013241","id":"16013241","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"body":"Attaching the original worker.log file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-16T23:06:14.788+0000","updated":"2017-05-16T23:06:14.788+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16013262","id":"16013262","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"body":"[~Srdo] the logs are as expected if the number of tasks are equivalent to number of executors.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-16T23:29:51.871+0000","updated":"2017-05-16T23:29:51.871+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16014194","id":"16014194","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Uploaded test code demonstrating how KafkaConsumer acts when multiple consumers in a thread use the subscribe() API","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-05-17T15:20:11.394+0000","updated":"2017-05-17T15:20:41.232+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16014195","id":"16014195","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Sorry, I should have explained. The KafkaConsumer supports subscriptions via two APIs: subscribe() and assign(). subscribe() lets Kafka deal with assigning partitions to each consumer, assign() lets the calling code assign them manually. When I asked if you were using automatic assignment, I meant which of these APIs your spout was using. The default is subscribe().  \n\nI think the subscribe() API doesn't really work when there are multiple consumers in a thread. As far as I can tell, the KafkaConsumer will initiate a partition reassignment whenever a new consumer joins the consumer group. The rebalance seems to require all active consumers to call poll(), and poll() doesn't return until the rebalance is complete. \n\nThe problem seems to be that when we run multiple spout tasks in one executor, we end up triggering a rebalance when each consumer joins the group. Since the other consumers in the executor can't call poll until the rebalance is complete, because the newly joined consumer is blocking the thread in poll(), they are booted from the list of active consumers. For the version of Kafka you're running, this will happen once the session.timeout.ms expires (default 30 seconds), at which point the blocking poll() returns. At this point Kafka considers only the newly joined consumer to be alive. When the other tasks in the executor next call poll, they try to rejoin the group, which again causes a rebalance and and reassignment.\n\nThe log you posted shows partition reassignment to a new task id every 30 seconds for each executor (look for \"Partitions reassignment.\"). I don't think the subscribe() API was designed with the expectation that one thread might be running multiple consumers.\n\nI attached some test code that starts two KafkaConsumers and repeatedly polls with them. It seems to demonstrate this behavior where the subscribe() API works poorly when there are multiple consumers in a thread. The assignments keep flip flopping between the consumers. With one consumer per thread, or manual assignment through the assign() API, it works fine.\n\nHere's a sample print\n{code}\n176 [main] INFO org.apache.kafka.common.utils.AppInfoParser - Kafka version : 0.10.0.0\n176 [main] INFO org.apache.kafka.common.utils.AppInfoParser - Kafka commitId : b8642491e78c5a13\n176 [main] INFO com.mycompany.scratch.NewClass - Polling from c1\n301 [main] INFO org.apache.kafka.clients.consumer.internals.AbstractCoordinator - Discovered coordinator DESKTOP-AGC8TKM:9092 (id: 2147483647 rack: null) for group test.\n302 [main] INFO org.apache.kafka.clients.consumer.internals.ConsumerCoordinator - Revoking previously assigned partitions [] for group test\n302 [main] INFO com.mycompany.scratch.NewClass - Partitions [] revoked for c1\n302 [main] INFO org.apache.kafka.clients.consumer.internals.AbstractCoordinator - (Re-)joining group test\n309 [main] INFO org.apache.kafka.clients.consumer.internals.AbstractCoordinator - Successfully joined group test with generation 42\n309 [main] INFO org.apache.kafka.clients.consumer.internals.ConsumerCoordinator - Setting newly assigned partitions [topic-0, topic-1] for group test\n309 [main] INFO com.mycompany.scratch.NewClass - Partitions [topic-0, topic-1] assigned to c1\n2185 [main] INFO com.mycompany.scratch.NewClass - Polling from c2\n2290 [main] INFO org.apache.kafka.clients.consumer.internals.AbstractCoordinator - Discovered coordinator DESKTOP-AGC8TKM:9092 (id: 2147483647 rack: null) for group test.\n2292 [main] INFO org.apache.kafka.clients.consumer.internals.ConsumerCoordinator - Revoking previously assigned partitions [] for group test\n2292 [main] INFO com.mycompany.scratch.NewClass - Partitions [] revoked for c2\n2292 [main] INFO org.apache.kafka.clients.consumer.internals.AbstractCoordinator - (Re-)joining group test\n30321 [main] INFO org.apache.kafka.clients.consumer.internals.AbstractCoordinator - Successfully joined group test with generation 43\n30321 [main] INFO org.apache.kafka.clients.consumer.internals.ConsumerCoordinator - Setting newly assigned partitions [topic-0, topic-1] for group test\n30321 [main] INFO com.mycompany.scratch.NewClass - Partitions [topic-0, topic-1] assigned to c2\n35340 [main] INFO com.mycompany.scratch.NewClass - Polling from c1\n{code}\n\nDuring the hang in poll, the consumer group tool shows the group as rebalancing\n{code}\n$ ./kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group test\nConsumer group `test` is rebalancing.\n{code}\n\nI think we can work around this by switching to manual partition assignment (as the default?), since rebalances don't happen then. We already have support for this with https://github.com/apache/storm/blob/master/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/ManualPartitionNamedSubscription.java. I'm not sure I see a good reason we'd need Kafka to manage assignments in any case.\n\n[~srishtyagrawal9@gmail.com] can you try to set the Subscription to the class I mentioned above in the KafkaSpoutConfig, and see if it helps?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-05-17T15:20:31.148+0000","updated":"2017-05-17T15:20:31.148+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16014216","id":"16014216","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"*Shouldn’t 3 more tasks (from Executor1) apart from task ID 10 be assigned to read from partitions 4, 5, 6 and 7*\nJust to clarify\n{code}\no.a.s.k.s.KafkaSpout Thread-12-kafkaspout-executor[3 10] [INFO] Partitions reassignment. [taskID=10, consumer-group=kafkaSpoutTestGroup, consumer=org.apache.kafka.clients.consumer.KafkaConsumer@108e79ce, topic-partitions=[8topic-4, 8topic-6, 8topic-5, 8topic-7]]\n{code}\nThis log line ought to mean that only task 10 is reading from partitions 4,5,6,7 until next reassignment. The partitions are being assigned to the KafkaConsumer in task 10, not to all the tasks in executor 1.\n\nIn general I'd expect the partitions to be reasonably evenly distributed across all tasks. Assigning a lot of them to a single task is suspicious, and is hopefully due to a problem with multiple consumers in a thread breaking the rebalance mechanism.\n\n*Are you deriving this information from the fact that all of the above messages have the same message ID (0) ?*\nYes. Shouldn't partition 2 offset 0 refer to the same message every time?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-05-17T15:32:17.493+0000","updated":"2017-05-17T16:16:46.028+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16018177","id":"16018177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for the explanation [~Srdo]. Yes, I agree that any combination of partition and offset number should refer to the same message.\n\nI am still struggling to get the example working with the ManualPartitioner(using RoundRobinManualPartitioner). I will be posting the results soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-19T23:44:24.203+0000","updated":"2017-05-19T23:44:24.203+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16033299","id":"16033299","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"[~srishtyagrawal9@gmail.com] Have you had any luck with the ManualPartitioner?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-06-01T17:00:36.090+0000","updated":"2017-06-01T17:00:36.090+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16037423","id":"16037423","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"body":"Sorry [~Srdo] I completely missed your comment. No, I have not been able to dedicate enough time to test the ManualPartitioner, will update the ticket with results when I am able to get it working.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-05T19:13:04.248+0000","updated":"2017-06-05T19:13:04.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16037464","id":"16037464","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"[~srishtyagrawal9@gmail.com] Don't worry about it :). I think the manual partitioning code is slightly broken at the moment, see https://github.com/apache/storm/pull/2150","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-06-05T19:48:20.628+0000","updated":"2017-06-05T19:48:20.628+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16456964","id":"16456964","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"[~srishtyagrawal9@gmail.com] Did you have any luck with this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-04-27T19:45:10.718+0000","updated":"2018-04-27T19:45:10.718+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13072101/comment/16458903","id":"16458903","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"body":"[~Srdo] Sorry, I had forgotten about this ticket altogether. I see that the PR that you had linked earlier has been fixed. I can keep this in my `To Do list` and will update it when I start working on it again. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srishtyagrawal9%40gmail.com","name":"srishtyagrawal9@gmail.com","key":"srishtyagrawal9@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Srishty Agrawal","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-30T19:16:00.123+0000","updated":"2018-04-30T19:17:40.034+0000"}],"maxResults":15,"total":15,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2514/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3ezuv:"}}