{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13144745","self":"https://issues.apache.org/jira/rest/api/2/issue/13144745","key":"STORM-2994","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":13800,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342767","id":"12342767","name":"1.1.3","archived":false,"released":true,"releaseDate":"2018-06-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342768","id":"12342768","name":"1.0.7","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342807","id":"12342807","name":"1.2.2","archived":false,"released":true,"releaseDate":"2018-06-04"}],"aggregatetimespent":13800,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-03-13T19:47:54.716+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Apr 03 20:53:40 UTC 2018","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1837276058_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2018-04-03T20:53:01.404+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2994/watchers","watchCount":2,"isWatching":false},"created":"2018-03-13T14:31:45.370+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["pull-request-available"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341265","id":"12341265","name":"1.1.2","archived":false,"released":true,"releaseDate":"2018-02-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341596","id":"12341596","name":"1.0.6","archived":false,"released":true,"releaseDate":"2018-02-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342766","id":"12342766","name":"1.2.1","archived":false,"released":true,"releaseDate":"2018-02-15"}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-04-03T20:57:31.729+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12331080","id":"12331080","name":"storm-kafka-client"}],"timeoriginalestimate":null,"description":"A topology that consumes from two different Kafka clusters: 0.10.1.1 and 0.10.2.1.\r\n\r\nSpouts consuming from 0.10.2.1 have a low lag (and regularly commit offsets) \r\n\r\nThe Spout that consumes from 0.10.1.1 exhibits either:\r\n\r\n1- Unknown lag\r\n\r\n2- Lag that increments as the Spout reads messages from Kafka\r\n\r\n \r\n\r\nIn DEBUG, Offset manager logs: \"topic-partition has NO offsets ready to be committed\", despite continuing to consume messages.\r\n\r\nSeveral configuration tweaks were tried, including setting maxRetries to 1, in case messages with a lower offset were being retried (logs didn't show it, though)\r\n\r\noffsetCommitPeriodMs was also  lowered to no avail.\r\n\r\nThe only configuration that works is to have ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG=true, but this is undesired   since we lose processing guarantees.\r\n\r\n ","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"3h 50m","remainingEstimateSeconds":0,"timeSpentSeconds":13800},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"KafkaSpout consumes messages but doesn't commit offsets","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":13800,"total":13800,"percent":100},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":13800,"total":13800,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16397541","id":"16397541","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"You've listed 1.1.0 and 1.1.2 as affected versions. Could you elaborate on which version your storm-kafka-client dependency is?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-03-13T19:47:54.716+0000","updated":"2018-03-13T19:47:54.716+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16397768","id":"16397768","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"body":"Hello Stig. This was observed in both versions, but the vast majority of tests I conducted was on 1.1.2. Let me know if you would like to know more details.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-13T22:26:09.611+0000","updated":"2018-03-13T22:26:45.051+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16399079","id":"16399079","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Ok, thanks. I'm asking because the debug log you posted is definitely from 1.1.0, and versions prior to 1.0.6, 1.1.2 or 1.2.0 are known to suffer from a number of issues.\r\n\r\nYour best bet to figure out what's going on would be to enable trace logging for this class https://github.com/apache/storm/blob/v1.1.2/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/internal/OffsetManager.java. The log you posted is here https://github.com/apache/storm/blob/v1.1.2/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/internal/OffsetManager.java#L156, and if you enable trace logging, the class will log all the message offsets that are pending commit. That should make it pretty easy to spot why the messages can't be committed. \r\n\r\nYou might also want to look at trace logging for https://github.com/apache/storm/blob/v1.1.2/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpoutRetryExponentialBackoff.java#L264, and the KafkaSpout class itself.\r\n\r\nRegarding the different Kafka versions, I took a quick look at the release notes for Kafka 0.10.2.0 and 0.10.2.1, and noticed https://issues.apache.org/jira/browse/KAFKA-4547. The spout uses kafkaConsumer.position a bunch, so maybe that's the issue? I believe the Kafka consumer is backwards compatible with older brokers https://cwiki.apache.org/confluence/display/KAFKA/KIP-97%3A+Improved+Kafka+Client+RPC+Compatibility+Policy. Could you try running your topology with the kafka-client dependency set to 0.10.2.1 against your 0.10.1.1 Kafka cluster, and see if that resolves the issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-03-14T18:40:30.019+0000","updated":"2018-03-14T18:40:30.019+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16399480","id":"16399480","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"body":"Thank you for your suggestions and for you time.\r\n\r\nI was already using kafka-clients 0.10.2.1, so that shouldn't be the cause.\r\n\r\nIt seems the are pending messages in the Spout, i.e., acked but not commited\r\n\r\n \r\n\r\n \r\n{code:java}\r\n2018-03-14T21:19:16.348Z o.a.s.k.s.KafkaSpout [TRACE] - No offsets to commit. KafkaSpout{acked={sample.topic-0=OffsetManager{topic-partition=sample.topic-0, fetchOffset=32592, committedOffset=32591, ackedMsgs=[{topic-partition=sample.topic-0, offset=32802, numFails=0}, {topic-partition=sample.topic-0, offset=32803, numFails=0}, {topic-partition=sample.topic-0, offset=32805, numFails=0}, {topic-partition=sample.topic-0, offset=32806, numFails=0}, {topic-partition=sample.topic-0, offset=32807, numFails=0}, {topic-partition=sample.topic-0, offset=32809, numFails=0}, {topic-partition=sample.topic-0, offset=32810, numFails=0}, {topic-partition=sample.topic-0, offset=32811, numFails=0}, {topic-partition=sample.topic-0, offset=32813, numFails=0}, {topic-partition=sample.topic-0, offset=33243, numFails=0}, {topic-partition=sample.topic-0, offset=33244, numFails=0}, {topic-partition=sample.topic-0, offset=33246, numFails=0}, {topic-partition=sample.topic-0, offset=33247, numFails=0}, {topic-partition=sample.topic-0, offset=33248, numFails=0}, {topic-partition=sample.topic-0, offset=33250, numFails=0}]}}, emitted=[]}\r\n\r\n\r\n2018-03-14T21:19:16.348Z o.a.s.k.s.i.OffsetManager [TRACE] - OffsetManager{topic-partition=sample.topic-0, fetchOffset=32592, committedOffset=32591, ackedMsgs=[{topic-partition=sample.topic-0, offset=32802, numFails=0}, {topic-partition=sample.topic-0, offset=32803, numFails=0}, {topic-partition=sample.topic-0, offset=32805, numFails=0}, {topic-partition=sample.topic-0, offset=32806, numFails=0}, {topic-partition=sample.topic-0, offset=32807, numFails=0}, {topic-partition=sample.topic-0, offset=32809, numFails=0}, {topic-partition=sample.topic-0, offset=32810, numFails=0}, {topic-partition=sample.topic-0, offset=32811, numFails=0}, {topic-partition=sample.topic-0, offset=32813, numFails=0}, {topic-partition=sample.topic-0, offset=33243, numFails=0}, {topic-partition=sample.topic-0, offset=33244, numFails=0}, {topic-partition=sample.topic-0, offset=33246, numFails=0}, {topic-partition=sample.topic-0, offset=33247, numFails=0}, {topic-partition=sample.topic-0, offset=33248, numFails=0}, {topic-partition=sample.topic-0, offset=33250, numFails=0}]}\r\n\r\n2018-03-14T21:19:16.348Z o.a.s.k.s.i.OffsetManager [DEBUG] - topic-partition [sample.topic-0] has NO offsets ready to be committed\r\n\r\n\r\n2018-03-14T21:19:16.348Z o.a.s.k.s.i.OffsetManager [DEBUG] - topic-partition [sample.topic-0] has non-continuous offset [32802]. It will be processed in a subsequent batch.\r\n{code}\r\n I would expect them to be retried, however can't see any retry effort in the in the logs:\r\n\r\n\r\n{code:java}\r\n2018-03-14T21:22:54.091Z o.a.s.k.s.KafkaSpoutRetryExponentialBackoff [DEBUG] - Topic partitions with entries ready to be retried [[]]\r\n{code}\r\n\r\nDo you think this is similar to STORM-2639 ?\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-14T21:45:23.037+0000","updated":"2018-03-14T21:45:23.037+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16399494","id":"16399494","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"The version you are using which is producing those logs is 1.1.0, where e.g. STORM-2639 is not fixed. Please switch to 1.1.2 and post those logs, they are much easier to debug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-03-14T21:55:44.828+0000","updated":"2018-03-14T21:55:44.828+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16399611","id":"16399611","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"body":"Sorry, I had switched back to stom-kafka-client to 1.1.0 for a test and forgot to undo.\r\n\r\nstorm-kafka-clients 1.1.2 logs:\r\n\r\n \r\n\r\n(Note: the message was expected not be emitted by the Spout, hence the \"Not emitting null tuple\")\r\n{code:java}\r\n2018-03-14T23:06:50.777Z o.a.k.c.c.i.Fetcher [TRACE] - Skipping fetch for partition sample.topic-0 because the\r\nre is an in-flight request to worker:9092 (id: 1 rack: null)\r\n2018-03-14T23:06:50.777Z o.a.k.c.NetworkClient [TRACE] - Completed receive from node 1, for key 1, received {throttle_time_ms=0,resp\r\nonses=[{topic=sample.topic,partition_responses=[{partition_header={partition=0,error_code=0,high_watermark=38785}\r\n,record_set=[(offset=38781,record=Record(magic = 0, attributes = 0, compression = NONE, crc = 1115540089, key = 3 bytes, value = 285 by\r\ntes)), (offset=38782,record=Record(magic = 0, attributes = 0, compression = NONE, crc = 1115540089, key = 3 bytes, value = 285 bytes)),\r\n(offset=38783,record=Record(magic = 0, attributes = 0, compression = NONE, crc = 1115540089, key = 3 bytes, value = 285 bytes)), (offs\r\net=38784,record=Record(magic = 0, attributes = 0, compression = NONE, crc = 1115540089, key = 3 bytes, value = 285 bytes))]}]}]}\r\n2018-03-14T23:06:50.777Z o.a.s.k.s.KafkaSpoutRetryExponentialBackoff [DEBUG] - Topic partitions with entries ready to be retried [{}\r\n] \r\n2018-03-14T23:06:50.777Z o.a.k.c.c.i.Fetcher [TRACE] - Adding fetched record for partition sample.topic-0 with\r\noffset 38781 to buffered record list\r\n2018-03-14T23:06:50.777Z o.a.k.c.c.i.Fetcher [TRACE] - Received 4 records in fetch response for partition sample.topic-0 with offset 38781\r\n2018-03-14T23:06:50.777Z o.a.k.c.c.i.Fetcher [TRACE] - Returning fetched records at offset 38781 for assigned partition sample.topic-0 and update position to 38785\r\n2018-03-14T23:06:50.777Z o.a.k.c.c.i.Fetcher [DEBUG] - Ignoring fetched records for sample.topic-0 at offset 3\r\n8781 since the current position is 38785\r\n2018-03-14T23:06:50.777Z o.a.k.c.c.i.Fetcher [TRACE] - Added fetch request for partition sample.topic-0 at off\r\nset 38785 to node worker:9092 (id: 1 rack: null)\r\n2018-03-14T23:06:50.777Z o.a.k.c.c.i.Fetcher [DEBUG] - Sending fetch for partitions [sample.topic-0] to broker\r\nworker:9092 (id: 1 rack: null)\r\n2018-03-14T23:06:50.777Z o.a.k.c.NetworkClient [TRACE] - Sending {replica_id=-1,max_wait_time=500,min_bytes=1,max_bytes=52428800,top\r\nics=[{topic=sample.topic,partitions=[{partition=0,fetch_offset=38785,max_bytes=1048576}]}]} to node 1.\r\n2018-03-14T23:06:50.777Z o.a.s.k.s.KafkaSpout [DEBUG] - Polled [4] records from Kafka\r\n2018-03-14T23:06:50.778Z o.a.s.k.s.KafkaSpoutRetryExponentialBackoff [DEBUG] - Topic partitions with entries ready to be retried [{}\r\n] \r\n\r\n2018-03-14T23:06:50.779Z o.a.s.k.s.KafkaSpout [DEBUG] - Not emitting null tuple for record [ConsumerRecord(topic = sample.topic, partition = 0, offset = 38781, NoTimestampType = -1, checksum = 1115540089, serialized key size = 3, serialized value size = 285, key = 123, value = {\"id\":\"100\"})] as defined in configuration.\r\n2018-03-14T23:06:50.779Z o.a.s.k.s.KafkaSpout [DEBUG] - Received direct ack for message [{topic-partition=sample.topic-0, offset=38781, numFails=0, emitted=false}], associated with null tuple\r\n2018-03-14T23:06:50.779Z o.a.s.k.s.KafkaSpoutRetryExponentialBackoff [DEBUG] - Topic partitions with entries ready to be retried [{}] \r\n2018-03-14T23:06:50.779Z o.a.s.k.s.KafkaSpoutRetryExponentialBackoff [DEBUG] - Topic partitions with entries ready to be retried [{}] \r\n2018-03-14T23:06:50.780Z o.a.s.k.s.KafkaSpout [DEBUG] - Not emitting null tuple for record [ConsumerRecord(topic = sample.topic, partition = 0, offset = 38782, NoTimestampType = -1, checksum = 1115540089, serialized key size = 3, serialized value size = 285, key = 123, value = {\"id\":\"100\"})] as defined in configuration.\r\n2018-03-14T23:06:50.780Z o.a.s.k.s.KafkaSpout [DEBUG] - Received direct ack for message [{topic-partition=sample.topic-0, offset=38782, numFails=0, emitted=false}], associated with null tuple\r\n2018-03-14T23:06:50.958Z o.a.s.k.s.KafkaSpout [TRACE] - No offsets to commit. KafkaSpout{offsetManagers ={}, emitted=[]}\r\n2018-03-14T23:06:50.958Z o.a.s.k.s.KafkaSpoutRetryExponentialBackoff [DEBUG] - Topic partitions with entries ready to be retried [{}]\r\n\r\n{code}\r\n \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-14T23:38:09.006+0000","updated":"2018-03-14T23:55:18.227+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16400333","id":"16400333","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"body":"I've been injecting in the Kafka topic two types of messages\r\n * messages that are incorrect and won't be emitted by the Spout\r\n * messages that are correct and will be emitted by the Spout\r\n\r\nUsing storm-kafka-clients 1.1.0, even the messages that are emitted pile up and aren't commited\r\n\r\n \r\n\r\n \r\n{code:java}\r\n2018-03-15T12:22:25.880Z o.a.s.k.s.KafkaSpout [DEBUG] - Polled [0] records from Kafka. [1379] uncommitted offsets across all topic partitions\r\n\r\n{code}\r\nThe incorrect messages aren't added to the total of uncommitted messages.\r\n\r\nUsing storm-kafka-clients 1.1.2, the behaviour is different.\r\n\r\nI uploaded the same topology, bumping storm-kafka-clients to 1.1.2, picking up the previous lag of > 14000 and reducing it to ~3000.\r\n It didn't go to 0 and stayed firmly in that level.\r\n Once I started injecting correct messages, eventually all messages are committed (not sure at this point if it is when he commit interval elapses)\r\n\r\nQuestion:\r\n\r\nAren't the tuples for which \r\n{code:java}\r\nList<Object> apply(ConsumerRecord<K,V> record);\r\n{code}\r\n returns null, supposed the be added to the list of uncommited offsets?\r\n\r\n \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-15T12:46:13.195+0000","updated":"2018-03-15T12:47:36.663+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16400983","id":"16400983","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Yes, I think that's the bug. Nice find. Seems like there was a mistake when adding the null filtering code. See https://github.com/apache/storm/blob/v1.2.1/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L602. \r\n\r\nJust going to give a quick summary of how we got to this code, and what I think is wrong.\r\n\r\nOriginally the offset manager simply kept track of acked tuples, and committed tuples once there was a complete sequence of acked tuples to commit (e.g. if 1,2,3,5,6 were acked, the offset manager would commit 1,2,3 and wait for 4 to be acked). A later PR added support for topic compaction, i.e. topics where an offset sequence might look like 1,2,3,5,6, with offset 4 missing entirely. The offset manager now allows skipping offset 4 if it is known that it was never emitted by the spout.\r\n\r\nWhen null tuple filtering was added, I think this functionality wasn't kept in mind. When a null tuple is filtered out, it's just discarded without being added to the offset manager emitted list, or the acked list. The result seems to be that the offset manager is never told about the null tuples, so won't commit them either. When the next non-null tuple gets acked, the offset manager is told about it. From the offset manager's perspective, it now looks like there was a gap of offsets that weren't emitted by the spout, so it reacts by committing past them. Unfortunately this only happens once a non-null tuple is acked, which can take arbitrarily long.\r\n\r\nI think the fix should be fairly simple: We add the null filtered tuples to the offset manager acked and emitted lists, so null filtering will behave as if the null tuples were acked immediately. If you'd like to give fixing it a shot, the two places to look would be https://github.com/apache/storm/blob/v1.2.1/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L503 and https://github.com/apache/storm/blob/v1.2.1/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L602. If you don't, let me know and I'll take a look when I get a chance.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-03-15T19:17:44.451+0000","updated":"2018-03-15T19:18:02.179+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16401053","id":"16401053","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"body":"Thank you for taking the time to look into this. I'll submit a patch ASAP.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-15T20:14:50.263+0000","updated":"2018-03-15T20:14:50.263+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16401083","id":"16401083","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Great. Added you to the contributors list here, so you should be able to assign the issue to yourself now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-03-15T20:37:27.247+0000","updated":"2018-03-15T20:37:27.247+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16403384","id":"16403384","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"body":"Hello,\r\n\r\nI've created [https://github.com/apache/storm/pull/2593] for this. Unit tests were missing and I'm adding them.\r\nI'll have limited access to internet for the next days so I'll pick this up again as soon as possible","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=RAbreu","name":"RAbreu","key":"rabreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rui Abreu","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-17T11:14:13.811+0000","updated":"2018-03-17T11:14:13.811+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/comment/16424583","id":"16424583","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Thanks [~RAbreu], merged to master, 1.x, 1.1.x and 1.0.x branches. Keep up the good work.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-04-03T20:53:40.975+0000","updated":"2018-04-03T20:53:52.603+0000"}],"maxResults":12,"total":12,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2994/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":24,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/81570","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user reiabreu opened a pull request:\n\n    https://github.com/apache/storm/pull/2593\n\n    STORM-2994 KafkaSpout commit offsets for null tuples\n\n    Hello,\r\n    \r\n    Let's kick off this pull request.\r\n    Unit tests for null tuples were missing. I'm in the process of adding them.\r\n    I'll update this PR asap. Meanwhile, these seem to be the necessary changes\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/reiabreu/storm master\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2593.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2593\n    \n----\ncommit 1db31bcf784a69d3904f39d86d8987f3c9e5e4bd\nAuthor: Rui Abreu <rui.abreu@...>\nDate:   2018-03-16T12:50:11Z\n\n    null tuples are now marked as emitted and marked as acked\n\ncommit 59235e79d64b8888b0190bf1b9364066215f3650\nAuthor: Rui Abreu <rui.abreu@...>\nDate:   2018-03-17T11:09:08Z\n\n    Undoing import statements changes\n\n----\n","created":"2018-03-17T11:12:32.894+0000","updated":"2018-03-17T11:12:32.894+0000","started":"2018-03-17T11:12:32.894+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"81570","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/81574","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2593#discussion_r175256064\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -484,8 +484,11 @@ private boolean emitOrRetryTuple(ConsumerRecord<K, V> record) {\n                         return true;\n                     }\n                 } else {\n    +                /*if a null tuple is not configured to be emitted, it should be marked as emitted and acked immediately\n    +                * to allow its offset to be commited to Kafka*/\n                     LOG.debug(\"Not emitting null tuple for record [{}] as defined in configuration.\", record);\n                     msgId.setEmitted(false);\n    --- End diff --\n    \n    I'd like to see this property renamed to \"isFiltered\" or \"isNullTuple\" something similar. Right now we have both a list of emitted tuples, and also the isEmitted property, and they don't always match. It seems unnecessarily confusing.\n","created":"2018-03-17T12:06:30.904+0000","updated":"2018-03-17T12:06:30.904+0000","started":"2018-03-17T12:06:30.904+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"81574","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/81575","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2593#discussion_r175256133\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -576,6 +579,8 @@ public void ack(Object messageId) {\n                         + \"came from a topic-partition that this consumer group instance is no longer tracking \"\n                         + \"due to rebalance/partition reassignment. No action taken.\", msgId);\n                 } else {\n    +                //a null tuple should be added to the ack list since by definition is a direct ack\n    --- End diff --\n    \n    We should probably switch the order of the emitted contains and msgId isEmitted checks. It is not possible that isEmitted is false while the tuple is in the emitted list.\n","created":"2018-03-17T12:06:30.910+0000","updated":"2018-03-17T12:06:30.910+0000","started":"2018-03-17T12:06:30.910+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"81575","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/85208","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/2593\n  \n    @reiabreu kindly reminder.\n","created":"2018-03-28T11:14:55.326+0000","updated":"2018-03-28T11:14:55.326+0000","started":"2018-03-28T11:14:55.326+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"85208","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/85217","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user reiabreu commented on the issue:\n\n    https://github.com/apache/storm/pull/2593\n  \n    Hi folks! I won't have access to a computer until next weekend. I'll pick\n    it up then. Thank you for understanding\n    \n    On Wed, 28 Mar 2018, 08:15 Jungtaek Lim, <notifications@github.com> wrote:\n    \n    > @reiabreu <https://github.com/reiabreu> kindly reminder.\n    >\n    > —\n    > You are receiving this because you were mentioned.\n    > Reply to this email directly, view it on GitHub\n    > <https://github.com/apache/storm/pull/2593#issuecomment-376850473>, or mute\n    > the thread\n    > <https://github.com/notifications/unsubscribe-auth/AA3TIrYbwigR8oxWBJPugLQeTdTNB4Zmks5ti3DAgaJpZM4Suw4Q>\n    > .\n    >\n\n","created":"2018-03-28T11:31:01.509+0000","updated":"2018-03-28T11:31:01.509+0000","started":"2018-03-28T11:31:01.508+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"85217","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/86519","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user reiabreu commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2593#discussion_r178510737\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -484,8 +484,11 @@ private boolean emitOrRetryTuple(ConsumerRecord<K, V> record) {\n                         return true;\n                     }\n                 } else {\n    +                /*if a null tuple is not configured to be emitted, it should be marked as emitted and acked immediately\n    +                * to allow its offset to be commited to Kafka*/\n                     LOG.debug(\"Not emitting null tuple for record [{}] as defined in configuration.\", record);\n                     msgId.setEmitted(false);\n    --- End diff --\n    \n    I concur. I'll refactor it.\n","created":"2018-04-02T08:55:23.783+0000","updated":"2018-04-02T08:55:23.783+0000","started":"2018-04-02T08:55:23.782+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86519","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/86583","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2593#discussion_r178551488\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -570,20 +572,25 @@ public void ack(Object messageId) {\n             // Only need to keep track of acked tuples if commits to Kafka are controlled by\n             // tuple acks, which happens only for at-least-once processing semantics\n             final KafkaSpoutMessageId msgId = (KafkaSpoutMessageId) messageId;\n    -        if (!emitted.contains(msgId)) {\n    -            if (msgId.isEmitted()) {\n    +        if (!msgId.isNullTuple()) {\n    --- End diff --\n    \n    Nit: You can reduce the nesting by a bit here by switching this to a guard clause, e.g.\r\n    \r\n    ```\r\n    if (is null tuple) {\r\n      ...\r\n      return\r\n    }\r\n    if (emitted contains) {\r\n      ...\r\n    } else {\r\n      ...\r\n    }\r\n    ```\r\n    \r\n    Up to you whether you want to change it\n","created":"2018-04-02T14:15:19.891+0000","updated":"2018-04-02T14:15:19.891+0000","started":"2018-04-02T14:15:19.891+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86583","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/86593","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user reiabreu commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2593#discussion_r178559146\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -570,20 +572,25 @@ public void ack(Object messageId) {\n             // Only need to keep track of acked tuples if commits to Kafka are controlled by\n             // tuple acks, which happens only for at-least-once processing semantics\n             final KafkaSpoutMessageId msgId = (KafkaSpoutMessageId) messageId;\n    -        if (!emitted.contains(msgId)) {\n    -            if (msgId.isEmitted()) {\n    +        if (!msgId.isNullTuple()) {\n    --- End diff --\n    \n    Sounds good, will update it.\r\n    Regarding tests, we need to add at least one: \r\n    \r\n    Test all messages are commited for all null tuples when Spout is not set to emit null tuples\r\n    \r\n    ```\r\n    @Test\r\n        public void testShouldCommitAllMessagesIfNotSetToEmitNullTuples() throws Exception {\r\n            final int messageCount = 10;\r\n            prepareSpout(messageCount);\r\n    \r\n            //All null tuples should be commited, meaning they were considered by to be emitted and acked\r\n            for(int i = 0; i < messageCount; i++) {\r\n                spout.nextTuple();\r\n            }\r\n    \r\n            verify(collectorMock,never()).emit(\r\n                    anyString(),\r\n                    anyList(),\r\n                    any());\r\n    \r\n            Time.advanceTime(commitOffsetPeriodMs + KafkaSpout.TIMER_DELAY_MS);\r\n            //Commit offsets\r\n            spout.nextTuple();\r\n    \r\n            verifyAllMessagesCommitted(messageCount);\r\n        }\r\n    ```\r\n    We would need a  new SingleTopicKafkaSpoutConfiguration with something like:\r\n    \r\n    ```\r\n     private static class NullRecordExtractor implements RecordTranslator{\r\n            \r\n            @Override\r\n            public List<Object> apply(ConsumerRecord record) {\r\n                return null;\r\n    \r\n            }\r\n    \r\n            @Override\r\n            public Fields getFieldsFor(String stream) {\r\n                return new Fields(\"topic\", \"key\", \"value\");\r\n            }\r\n    \r\n            @Override\r\n            public Object apply(Object record) {\r\n                return null;\r\n            }\r\n        }\r\n    ```\r\n    \r\n    I was planning to extend KafkaSpoutAbstractTest on something similar to KafkaSpoutSingleTopicTest.\r\n\n","created":"2018-04-02T14:49:16.774+0000","updated":"2018-04-02T14:49:16.774+0000","started":"2018-04-02T14:49:16.774+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86593","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/86596","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2593#discussion_r178562679\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -570,20 +572,25 @@ public void ack(Object messageId) {\n             // Only need to keep track of acked tuples if commits to Kafka are controlled by\n             // tuple acks, which happens only for at-least-once processing semantics\n             final KafkaSpoutMessageId msgId = (KafkaSpoutMessageId) messageId;\n    -        if (!emitted.contains(msgId)) {\n    -            if (msgId.isEmitted()) {\n    +        if (!msgId.isNullTuple()) {\n    --- End diff --\n    \n    Great, that sounds good.\n","created":"2018-04-02T15:04:11.970+0000","updated":"2018-04-02T15:04:11.970+0000","started":"2018-04-02T15:04:11.969+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86596","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/86605","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user reiabreu commented on the issue:\n\n    https://github.com/apache/storm/pull/2593\n  \n    KafkaSpoutAbstractTest is tightly coupled to  KafkaSpoutConfig through createSpoutConfig, meaning that to test a single configuration change, we need to create a new test class. This is something that we can redesign in the future.\n","created":"2018-04-02T15:36:56.006+0000","updated":"2018-04-02T15:36:56.006+0000","started":"2018-04-02T15:36:56.005+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86605","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/86609","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2593#discussion_r178571949\n  \n    --- Diff: external/storm-kafka-client/src/test/java/org/apache/storm/kafka/spout/KafkaSpoutNullTupleTest.java ---\n    @@ -0,0 +1,76 @@\n    +/*\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + *   or more contributor license agreements.  See the NOTICE file\n    + *   distributed with this work for additional information\n    + *   regarding copyright ownership.  The ASF licenses this file\n    + *   to you under the Apache License, Version 2.0 (the\n    + *   \"License\"); you may not use this file except in compliance\n    + *   with the License.  You may obtain a copy of the License at\n    + *\n    + *   http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + *   Unless required by applicable law or agreed to in writing, software\n    + *   distributed under the License is distributed on an \"AS IS\" BASIS,\n    + *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + *   See the License for the specific language governing permissions and\n    + *   limitations under the License.\n    + */\n    +package org.apache.storm.kafka.spout;\n    +\n    +\n    +import org.apache.kafka.clients.consumer.ConsumerConfig;\n    +import org.apache.storm.kafka.spout.config.builder.SingleTopicKafkaSpoutConfiguration;\n    +import org.apache.storm.utils.Time;\n    +import org.junit.Test;\n    +\n    +import java.util.regex.Pattern;\n    +\n    +import static org.mockito.ArgumentMatchers.*;\n    +import static org.mockito.Mockito.never;\n    +import static org.mockito.Mockito.verify;\n    +\n    +public class KafkaSpoutNullTupleTest extends KafkaSpoutAbstractTest {\n    +    private final int maxPollRecords = 10;\n    +    private final int maxRetries = 3;\n    +\n    +    public KafkaSpoutNullTupleTest() {\n    +        super(2_000);\n    +    }\n    +\n    +\n    +    @Override\n    +    KafkaSpoutConfig<String, String> createSpoutConfig() {\n    +        return SingleTopicKafkaSpoutConfiguration.setCommonSpoutConfigNullTuples(\n    --- End diff --\n    \n    I think you can simplify this by using SingleTopicKafkaSpoutConfiguration.createKafkaSpoutConfigBuilder, and simply setting the record translator. I don't think there's a reason to put a whole new configuration in SingleTopicKafkaSpoutConfiguration. I'd also rather keep the record translator local to this class, since we're not using it in other tests.\n","created":"2018-04-02T15:43:45.232+0000","updated":"2018-04-02T15:43:45.232+0000","started":"2018-04-02T15:43:45.231+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86609","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/86610","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2593#discussion_r178571304\n  \n    --- Diff: external/storm-kafka-client/src/test/java/org/apache/storm/kafka/spout/KafkaSpoutNullTupleTest.java ---\n    @@ -0,0 +1,76 @@\n    +/*\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + *   or more contributor license agreements.  See the NOTICE file\n    + *   distributed with this work for additional information\n    + *   regarding copyright ownership.  The ASF licenses this file\n    + *   to you under the Apache License, Version 2.0 (the\n    + *   \"License\"); you may not use this file except in compliance\n    + *   with the License.  You may obtain a copy of the License at\n    + *\n    + *   http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + *   Unless required by applicable law or agreed to in writing, software\n    + *   distributed under the License is distributed on an \"AS IS\" BASIS,\n    + *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + *   See the License for the specific language governing permissions and\n    + *   limitations under the License.\n    + */\n    +package org.apache.storm.kafka.spout;\n    +\n    +\n    +import org.apache.kafka.clients.consumer.ConsumerConfig;\n    +import org.apache.storm.kafka.spout.config.builder.SingleTopicKafkaSpoutConfiguration;\n    +import org.apache.storm.utils.Time;\n    +import org.junit.Test;\n    +\n    +import java.util.regex.Pattern;\n    +\n    +import static org.mockito.ArgumentMatchers.*;\n    +import static org.mockito.Mockito.never;\n    +import static org.mockito.Mockito.verify;\n    +\n    +public class KafkaSpoutNullTupleTest extends KafkaSpoutAbstractTest {\n    +    private final int maxPollRecords = 10;\n    +    private final int maxRetries = 3;\n    +\n    +    public KafkaSpoutNullTupleTest() {\n    +        super(2_000);\n    +    }\n    +\n    +\n    +    @Override\n    +    KafkaSpoutConfig<String, String> createSpoutConfig() {\n    +        return SingleTopicKafkaSpoutConfiguration.setCommonSpoutConfigNullTuples(\n    +            KafkaSpoutConfig.builder(\"127.0.0.1:\" + kafkaUnitRule.getKafkaUnit().getKafkaPort(),\n    +                Pattern.compile(SingleTopicKafkaSpoutConfiguration.TOPIC)))\n    +            .setOffsetCommitPeriodMs(commitOffsetPeriodMs)\n    +            .setRetry(new KafkaSpoutRetryExponentialBackoff(KafkaSpoutRetryExponentialBackoff.TimeInterval.seconds(0), KafkaSpoutRetryExponentialBackoff.TimeInterval.seconds(0),\n    --- End diff --\n    \n    Nit: Unless it's important to the test, I'd leave this config out or use the SingleTopicKafkaSpoutConfiguration utility to set common configuration. Same for maxPollRecords.\n","created":"2018-04-02T15:43:45.329+0000","updated":"2018-04-02T15:43:45.329+0000","started":"2018-04-02T15:43:45.328+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86610","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/86645","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user reiabreu commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2593#discussion_r178586564\n  \n    --- Diff: external/storm-kafka-client/src/test/java/org/apache/storm/kafka/spout/KafkaSpoutNullTupleTest.java ---\n    @@ -0,0 +1,76 @@\n    +/*\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + *   or more contributor license agreements.  See the NOTICE file\n    + *   distributed with this work for additional information\n    + *   regarding copyright ownership.  The ASF licenses this file\n    + *   to you under the Apache License, Version 2.0 (the\n    + *   \"License\"); you may not use this file except in compliance\n    + *   with the License.  You may obtain a copy of the License at\n    + *\n    + *   http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + *   Unless required by applicable law or agreed to in writing, software\n    + *   distributed under the License is distributed on an \"AS IS\" BASIS,\n    + *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + *   See the License for the specific language governing permissions and\n    + *   limitations under the License.\n    + */\n    +package org.apache.storm.kafka.spout;\n    +\n    +\n    +import org.apache.kafka.clients.consumer.ConsumerConfig;\n    +import org.apache.storm.kafka.spout.config.builder.SingleTopicKafkaSpoutConfiguration;\n    +import org.apache.storm.utils.Time;\n    +import org.junit.Test;\n    +\n    +import java.util.regex.Pattern;\n    +\n    +import static org.mockito.ArgumentMatchers.*;\n    +import static org.mockito.Mockito.never;\n    +import static org.mockito.Mockito.verify;\n    +\n    +public class KafkaSpoutNullTupleTest extends KafkaSpoutAbstractTest {\n    +    private final int maxPollRecords = 10;\n    +    private final int maxRetries = 3;\n    +\n    +    public KafkaSpoutNullTupleTest() {\n    +        super(2_000);\n    +    }\n    +\n    +\n    +    @Override\n    +    KafkaSpoutConfig<String, String> createSpoutConfig() {\n    +        return SingleTopicKafkaSpoutConfiguration.setCommonSpoutConfigNullTuples(\n    --- End diff --\n    \n    Absolutely, will simplify it\n","created":"2018-04-02T16:46:55.283+0000","updated":"2018-04-02T16:46:55.283+0000","started":"2018-04-02T16:46:55.283+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86645","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/86705","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2593\n  \n    +1, thanks for your patience. Please squash to one commit, and we can merge.\n","created":"2018-04-02T19:07:12.227+0000","updated":"2018-04-02T19:07:12.227+0000","started":"2018-04-02T19:07:12.227+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86705","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/87003","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user reiabreu commented on the issue:\n\n    https://github.com/apache/storm/pull/2593\n  \n    Thank you for guiding me through the changes. I've squashed all the commits and pushed a fresh one\n","created":"2018-04-03T09:32:56.151+0000","updated":"2018-04-03T09:32:56.151+0000","started":"2018-04-03T09:32:56.150+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"87003","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/87149","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/storm/pull/2593\n","created":"2018-04-03T16:29:25.589+0000","updated":"2018-04-03T16:29:25.589+0000","started":"2018-04-03T16:29:25.589+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"87149","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/87150","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2593\n  \n    @reiabreu Merged to master. Looks like there are some small modifications to do to get it on to 1.x or earlier branches. Could you put up a PR against 1.x as well (should be pretty easy with `git cherry-pick`)?\n","created":"2018-04-03T16:30:40.192+0000","updated":"2018-04-03T16:30:40.192+0000","started":"2018-04-03T16:30:40.192+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"87150","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/87162","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user reiabreu commented on the issue:\n\n    https://github.com/apache/storm/pull/2593\n  \n    @srdo Sure, I'll have a look\n","created":"2018-04-03T17:06:19.787+0000","updated":"2018-04-03T17:06:19.787+0000","started":"2018-04-03T17:06:19.787+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"87162","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/87192","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user reiabreu opened a pull request:\n\n    https://github.com/apache/storm/pull/2620\n\n    STORM-2994: KafkaSpout doesn't commit offsets for null tuples\n\n    \n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/reiabreu/storm 1.x-branch\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2620.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2620\n    \n----\ncommit d8a37d8f4e1e4a5b42255d01f9743eed2a99424e\nAuthor: Rui Abreu <rui.abreu@...>\nDate:   2018-04-03T09:21:05Z\n\n    STORM-2994: KafkaSpout consumes messages but doesn't commit offsets\n\n----\n","created":"2018-04-03T18:07:42.600+0000","updated":"2018-04-03T18:07:42.600+0000","started":"2018-04-03T18:07:42.600+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"87192","issueId":"13144745"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13144745/worklog/87222","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user reiabreu closed the pull request at:\n\n    https://github.com/apache/storm/pull/2620\n","created":"2018-04-03T19:29:53.150+0000","updated":"2018-04-03T19:29:53.150+0000","started":"2018-04-03T19:29:53.149+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"87222","issueId":"13144745"}]},"customfield_12311820":"0|i3r8jz:"}}