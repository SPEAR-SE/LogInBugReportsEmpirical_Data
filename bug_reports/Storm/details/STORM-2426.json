{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13057485","self":"https://issues.apache.org/jira/rest/api/2/issue/13057485","key":"STORM-2426","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341047","id":"12341047","name":"1.2.0","archived":false,"released":true,"releaseDate":"2018-02-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341265","id":"12341265","name":"1.1.2","archived":false,"released":true,"releaseDate":"2018-02-15"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-06-30T23:16:16.214+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Oct 12 19:48:50 UTC 2017","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_17831070058_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2017-10-12T19:48:50.237+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2426/watchers","watchCount":3,"isWatching":false},"created":"2017-03-20T10:44:20.341+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335747","id":"12335747","name":"1.0.2","archived":false,"released":true,"releaseDate":"2016-08-10"}],"customfield_12312339":null,"issuelinks":[{"id":"12517308","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12517308","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13077203","key":"STORM-2541","self":"https://issues.apache.org/jira/rest/api/2/issue/13077203","fields":{"summary":"Manual partition assignment doesn't work","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12517307","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12517307","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13077243","key":"STORM-2542","self":"https://issues.apache.org/jira/rest/api/2/issue/13077243","fields":{"summary":"Deprecate storm-kafka-client KafkaConsumer.subscribe API subscriptions on 1.x and remove them as options in 2.x","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-10-12T19:48:50.313+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12331080","id":"12331080","name":"storm-kafka-client"}],"timeoriginalestimate":null,"description":"Topology with two Kafka spouts (org.apache.storm.kafka.spout.KafkaSpout) reading from two different topics with same consumer group ID. \n\n1. Kill the only worker process for topology\n2. Storm creates new worker\n3. Kafka starts rebalancing (log line 15-16)\n4. Kafka rebalancing done (log line 18-19)\n5. Kafka topics read and tuples emitted (log line 28-29)\n6. Tuples immediately fail (log line 30-33)\n\nThe delay between tuples emitted and tuples failing is just some 10 ms. No bolts in topology received the tuples.\n\nWhat could cause this? The assumption is that there are uncommitted messages in Spout when it is killed and those are retried.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12859542","id":"12859542","filename":"2017-03-20-Kafka-spout-issue.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=EitZei","name":"EitZei","key":"eitzei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antti Järvinen","active":true,"timeZone":"Europe/Helsinki"},"created":"2017-03-20T10:44:20.364+0000","size":9027,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12859542/2017-03-20-Kafka-spout-issue.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12859716","id":"12859716","filename":"2017-03-21-Timeout-ticks.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=EitZei","name":"EitZei","key":"eitzei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antti Järvinen","active":true,"timeZone":"Europe/Helsinki"},"created":"2017-03-21T08:53:44.917+0000","size":1114,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12859716/2017-03-21-Timeout-ticks.txt"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"First tuples fail after worker is respawn","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=EitZei","name":"EitZei","key":"eitzei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antti Järvinen","active":true,"timeZone":"Europe/Helsinki"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=EitZei","name":"EitZei","key":"eitzei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antti Järvinen","active":true,"timeZone":"Europe/Helsinki"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13057485/comment/15934267","id":"15934267","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=EitZei","name":"EitZei","key":"eitzei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antti Järvinen","active":true,"timeZone":"Europe/Helsinki"},"body":"Found the probable reason for why this is happening. Kafka rebalancing takes long time (over 2 minutes). The system ticks received by SpoutExecutor are queued for that time (?) and then received in quick succession after the rebalancing ends. This causes multiple (2 in the example case) rotations of executors RotatingMap which again causes the tuples that were just emitted to be timed out. Please see the attached log file 2017-03-21-Timeout-ticks.txt.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=EitZei","name":"EitZei","key":"eitzei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antti Järvinen","active":true,"timeZone":"Europe/Helsinki"},"created":"2017-03-21T08:53:34.341+0000","updated":"2017-03-21T08:53:34.341+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13057485/comment/16070847","id":"16070847","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hmclouro","name":"hmclouro","key":"hmclouro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hugo Louro","active":true,"timeZone":"Etc/UTC"},"body":"[~Srdo] Does STORM-2542 fix this bug ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hmclouro","name":"hmclouro","key":"hmclouro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hugo Louro","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-30T23:16:16.214+0000","updated":"2017-06-30T23:16:16.214+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13057485/comment/16071062","id":"16071062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Yes, I believe so. This looks a lot like how the subscribe API behaves when there are multiple KafkaConsumers in a thread, as described here https://issues.apache.org/jira/browse/STORM-2514?focusedCommentId=16014195&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16014195. I'm not really sure why the rebalance takes 3.5 minutes, since I would expect it to take 2.5 (the session timeout). In the linked demo code, the long rebalance happens because rebalancing can't finish until all the KafkaConsumers call (and block in) poll, which can't happen if there are multiple consumers in a thread. The rebalance times out at the session timeout.\n\nWas the number of executors lower than the number of tasks when you had this problem [~EitZei]?\n\nSTORM-2542 gets rid of long rebalances, so it should be fixed in any case even if it's not the issue where the task count isn't equal to the executor number.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-07-01T07:03:48.727+0000","updated":"2017-07-01T07:03:48.727+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13057485/comment/16073512","id":"16073512","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=EitZei","name":"EitZei","key":"eitzei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antti Järvinen","active":true,"timeZone":"Europe/Helsinki"},"body":"First of all it very nice to hear that the issue is worked on.\n\nIn this case both the number of tasks and number of executors was 1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=EitZei","name":"EitZei","key":"eitzei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antti Järvinen","active":true,"timeZone":"Europe/Helsinki"},"created":"2017-07-04T11:39:43.936+0000","updated":"2017-07-04T11:39:43.936+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13057485/comment/16074058","id":"16074058","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"[~EitZei] Okay, it isn't exactly that issue then, but it's very similar. When the worker is killed, the KafkaConsumer doesn't get a chance to disconnect cleanly from Kafka, so Kafka will wait for the full session timeout before it declares the missing consumer dead and finishes rebalancing. I tried out killing workers with settings similar to yours, and the rebalance ends up taking a few minutes. This should explain the long rebalance. STORM-2542 will definitely solve this, since Kafka is not involved in assigning partitions with that change, so rebalances are local to each spout instance instead of being something the spouts need to coordinate through Kafka.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-07-04T20:17:01.003+0000","updated":"2017-07-04T20:17:01.003+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13057485/comment/16202518","id":"16202518","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"This should no longer be an issue once we move away from the Named/PatternSubscription Subscription implementations. Those implementations are no longer an option in 2.0.0, and are deprecated from 1.2.0. Please switch to using the ManualPartitionSubscription class when configuring KafkaSpoutConfig. ManualPartitionSubscription should work from 1.1.2 on.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-10-12T19:48:50.294+0000","updated":"2017-10-12T19:48:50.294+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2426/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3cibr:"}}