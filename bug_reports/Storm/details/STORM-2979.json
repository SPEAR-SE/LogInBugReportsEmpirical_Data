{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13141208","self":"https://issues.apache.org/jira/rest/api/2/issue/13141208","key":"STORM-2979","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":15600,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342767","id":"12342767","name":"1.1.3","archived":false,"released":true,"releaseDate":"2018-06-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342768","id":"12342768","name":"1.0.7","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342807","id":"12342807","name":"1.2.2","archived":false,"released":true,"releaseDate":"2018-06-04"}],"aggregatetimespent":15600,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-03-11T14:25:22.341+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Apr 11 12:51:21 UTC 2018","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_3716580023_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2018-04-11T12:51:21.045+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2979/watchers","watchCount":2,"isWatching":false},"created":"2018-02-27T12:28:21.062+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["pull-request-available"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341596","id":"12341596","name":"1.0.6","archived":false,"released":true,"releaseDate":"2018-02-14"}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hummelm","name":"hummelm","key":"hummelm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michel hummel","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-04-11T19:09:11.640+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12327950","id":"12327950","name":"storm-core","description":"Core storm daemons and APIs including trident"}],"timeoriginalestimate":null,"description":"Hi,\r\n\r\nI'm trying to use the BaseWorkerHook but an exception is thrown after I killed the topology.\r\n\r\nThe issue is exactly the same as : [http://user.storm.apache.narkive.com/uchOrwlH/workerhook-deserialization-problem|http://user.storm.apache.narkive.com/uchOrwlH/workerhook-deserialization-problem]\r\n\r\nAn extract of my code :\r\n\r\n \r\n{code:java}\r\n// topology\r\nfinal TridentTopology topology = new TridentTopology();\r\n// ... I skip all the topology configuration part\r\nfinal StormTopology topo = topology.build();\r\n\r\n// hook\r\nfinal BaseWorkerHook hook = new BaseWorkerHook();\r\nfinal ByteBuffer serializedHook = ByteBuffer.wrap(Utils.javaSerialize(hook ));\r\ntopo.add_to_worker_hooks(hook);\r\n\r\n// submit topology\r\nLocalCluster cluster = new LocalCluster();\r\ncluster.submitTopology(name,config,topo);\r\nUtils.sleep(60000);\r\n\r\n// kill topology\r\nfinal KillOptions killOptions = new KillOptions();\r\nkillOptions.set_wait_secs(0);\r\ncluster.killTopologyWithOpts(name, killOptions);\r\nUtils.sleep(10000);\r\ncluster.shutdown();\r\n{code}\r\n \r\n\r\nI have the following error :\r\n{code:java}\r\njava.lang.RuntimeException: java.io.EOFException\r\n    at org.apache.storm.utils.Utils.javaDeserialize(Utils.java:254)\r\n    at org.apache.storm.daemon.worker$run_worker_shutdown_hooks$iter__5456__5460$fn__5461.invoke(worker.clj:578)\r\n    at clojure.lang.LazySeq.sval(LazySeq.java:40)\r\n    at clojure.lang.LazySeq.seq(LazySeq.java:49)\r\n    at clojure.lang.RT.seq(RT.java:507)\r\n    at clojure.core$seq__4128.invoke(core.clj:137)\r\n    at clojure.core$dorun.invoke(core.clj:3009)\r\n    at clojure.core$doall.invoke(core.clj:3025)\r\n    at org.apache.storm.daemon.worker$run_worker_shutdown_hooks.invoke(worker.clj:576)\r\n    at org.apache.storm.daemon.worker$fn__5471$exec_fn__1371__auto__$reify__5473$shutdown_STAR___5493.invoke(worker.clj:693)\r\n    at org.apache.storm.daemon.worker$fn__5471$exec_fn__1371__auto__$reify$reify__5519.shutdown(worker.clj:706)\r\n    at org.apache.storm.ProcessSimulator.killProcess(ProcessSimulator.java:67)\r\n    at org.apache.storm.daemon.supervisor.LocalContainer.kill(LocalContainer.java:59)\r\n    at org.apache.storm.daemon.supervisor.Slot.killContainerForChangedAssignment(Slot.java:311)\r\n    at org.apache.storm.daemon.supervisor.Slot.handleRunning(Slot.java:527)\r\n    at org.apache.storm.daemon.supervisor.Slot.stateMachineStep(Slot.java:265)\r\n    at org.apache.storm.daemon.supervisor.Slot.run(Slot.java:741)\r\nCaused by: java.io.EOFException\r\n    at java.io.ObjectInputStream$PeekInputStream.readFully(ObjectInputStream.java:2680)\r\n    at java.io.ObjectInputStream$BlockDataInputStream.readShort(ObjectInputStream.java:3155)\r\n    at java.io.ObjectInputStream.readStreamHeader(ObjectInputStream.java:864)\r\n    at java.io.ObjectInputStream.<init>(ObjectInputStream.java:360)\r\n    at org.apache.storm.utils.Utils.javaDeserialize(Utils.java:245)\r\n    ... 16 more\r\n{code}\r\n \r\n\r\nMaybe it is related to log4j shutdown hooks (https://issues.apache.org/jira/browse/STORM-2176) so I tried to disable the hook in my src/test/resources/log4j2.xml.\r\n\r\n \r\n{code:java}\r\n<Configuration monitorInterval=\"60\" shutdownHook=\"disable\">\r\n    <Appenders>\r\n        <Console name=\"Console\" target=\"SYSTEM_OUT\">\r\n            <PatternLayout pattern=\"%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n\" />\r\n        </Console>\r\n    </Appenders>\r\n\r\n    <Loggers>\r\n        <Root level=\"debug\">\r\n            <AppenderRef ref=\"Console\" />\r\n        </Root>\r\n    </Loggers>\r\n</Configuration>\r\n{code}\r\nBut it does not change anything.\r\n\r\n \r\n\r\nOf course the purpose of my work is to use my own worker hook extending the BaseWorkerHook.\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n ","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"4h 20m","remainingEstimateSeconds":0,"timeSpentSeconds":15600},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"WorkerHooks EOFException during run_worker_shutdown_hooks","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=robin.perice","name":"robin.perice","key":"robin.perice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Perice","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=robin.perice","name":"robin.perice","key":"robin.perice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Perice","active":true,"timeZone":"Etc/UTC"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":15600,"total":15600,"percent":100},"environment":"centos 7\r\nstorm-core 1.0.6\r\neclipse Mars2\r\njava 1.8.0_151","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":15600,"total":15600,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/comment/16394521","id":"16394521","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hummel.michel%40gmail.com","name":"hummel.michel@gmail.com","key":"hummel.michel@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"michel hummel","active":true,"timeZone":"Etc/UTC"},"body":"The issue seems to be related with the use if a ByteBuffer to store the serialized workerhook.\r\n The byteBuffer is deserialized two time:\r\n * On start\r\n * On Stop\r\n\r\nOn worker start, the worker retrieves the byte array of the ByteBuffer and the position on the ByteBuffer is then at the end of the ByteBuffer.\r\n On worker stop, the worker retrieves the byte array of the ByteBuffer but its position is at the end of the bytebuffer.\r\n\r\nThere multiple way to fix this issue:\r\n * in worker.clj run-worker-start-hooks, store and reset the Bytebuffer position after the workerhook start.\r\n\r\nThis is the purpose of my commit: [https://github.com/hummelm/storm/commit/7afeff6d8db4a78250ff8827207e80247b0acd25]\r\n\r\n \r\n * Add a method to the Utils class to allow the retreiving of a byteArray from byteBuffer without changing the internal position of the byteBuffer and use it in the worker.clj\r\n\r\nMay be a storm developer can give us an advice on the better way to fix the issue, it is a blocking issue for us and we will be happy to contibute to storm.\r\n\r\n \r\n\r\nOne thing is strange, the ByteBuffer seems to contain more data than expected, I mean the serialized workerhook is about 106 Bytes and the buffer position is more than 2800.\r\n\r\nIn any case, the submitted fix is not impacted by this question.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hummel.michel%40gmail.com","name":"hummel.michel@gmail.com","key":"hummel.michel@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"michel hummel","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-11T14:25:22.341+0000","updated":"2018-03-11T14:56:31.931+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/comment/16433868","id":"16433868","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"Thanks [~hummelm], I merged into master, 1.x for 1.2.2, 1.1.x for 1.1.3, 1.0.x for 1.0.7.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2018-04-11T12:51:21.077+0000","updated":"2018-04-11T12:51:21.077+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2979/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":26,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/79594","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user hummelm opened a pull request:\n\n    https://github.com/apache/storm/pull/2591\n\n    STORM-2979\n\n    The pom modification is only for test propose.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/hummelm/storm 1.0.6-p1-fix-STORM-2979\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2591.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2591\n    \n----\ncommit 7afeff6d8db4a78250ff8827207e80247b0acd25\nAuthor: michelo <michelo@...>\nDate:   2018-03-11T13:51:12Z\n\n    fix workerhook start by keeping location of byteBuffer.\n\ncommit 5e05882e07257f28eefa15dee28122b394f2caab\nAuthor: michelo <michelo@...>\nDate:   2018-03-11T16:06:29Z\n\n    generate version 1.0.6-p1 of storm-core which fix issue STORM-2979\n\n----\n","created":"2018-03-12T20:16:34.112+0000","updated":"2018-03-12T20:16:34.112+0000","started":"2018-03-12T20:16:34.111+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"79594","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/80064","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hummelm commented on the issue:\n\n    https://github.com/apache/storm/pull/2591\n  \n    After some tests I can say that the issue also affects:\r\n    1.1.X\r\n    1.2.X\r\n    \r\n    I'm pretty sure that master branch (2.X)  is also affected but the worker code have been rewritten in java.\r\n    I can easily create a patch for this branch if needed.\n","created":"2018-03-13T21:23:22.117+0000","updated":"2018-03-13T21:23:22.117+0000","started":"2018-03-13T21:23:22.116+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"80064","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/83836","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hummelm commented on the issue:\n\n    https://github.com/apache/storm/pull/2591\n  \n    After some digging I finally found a workaround.\r\n    Using a simple trick in the start method of the worker-hook (rewind of\r\n    the byteBuffer to allow the deserialization on stop)it can work as\r\n    expected, here is a simple example if someone encounter the same issue\r\n    :\r\n    \r\n    package myTest.stormWorkerHook;\r\n    \r\n    import java.nio.ByteBuffer;\r\n    import java.util.Map;\r\n    \r\n    import org.apache.storm.Config;\r\n    import org.apache.storm.LocalCluster;\r\n    import org.apache.storm.generated.StormTopology;\r\n    import org.apache.storm.hooks.BaseWorkerHook;\r\n    import org.apache.storm.task.WorkerTopologyContext;\r\n    import org.apache.storm.trident.TridentState;\r\n    import org.apache.storm.trident.TridentTopology;\r\n    import org.apache.storm.trident.operation.BaseFunction;\r\n    import org.apache.storm.trident.operation.TridentCollector;\r\n    import org.apache.storm.trident.operation.builtin.Count;\r\n    import org.apache.storm.trident.testing.FixedBatchSpout;\r\n    import org.apache.storm.trident.testing.MemoryMapState;\r\n    import org.apache.storm.trident.tuple.TridentTuple;\r\n    import org.apache.storm.tuple.Fields;\r\n    import org.apache.storm.tuple.Values;\r\n    import org.apache.storm.utils.Utils;\r\n    \r\n    \r\n    public class App {\r\n    \r\n        static class myHook extends BaseWorkerHook {\r\n            // store the size of the serialization of this class\r\n            int mySize = 0;\r\n    \r\n            public int getMySize() {\r\n                return mySize;\r\n            }\r\n    \r\n            public void setMySize(int mySize) {\r\n                this.mySize = mySize;\r\n            }\r\n    \r\n            /**\r\n             *\r\n             */\r\n            private static final long serialVersionUID = 1L;\r\n    \r\n             public void start(Map stormConf, WorkerTopologyContext context) {\r\n                   System.out.println(\"### START HOOK\");\r\n                   ByteBuffer bf =\r\n    context.getRawTopology().get_worker_hooks().get(0);\r\n                   // getting the byte data for deserialization has move\r\n    the position\r\n                   // to the end of the buffer\r\n                   int pos = bf.position();\r\n                   // rewind the position of the buffer to allow\r\n                   // the deserialization which will occur on STOp\r\n                   bf.position(pos-mySize);\r\n    \r\n                }\r\n    \r\n                /**\r\n                 * This method is called right before a worker shuts down\r\n                 */\r\n                @Override\r\n                public void shutdown() {\r\n                       System.out.println(\"### STOP HOOK\");\r\n                }\r\n    \r\n        }\r\n    \r\n    \r\n    \r\n        /*\r\n         * Function takes the \"sentence\" field and emits a tuple for each word.\r\n         */\r\n        public static class Split extends BaseFunction {\r\n            @Override\r\n            public void execute(TridentTuple tuple, TridentCollector collector) {\r\n                String sentence = tuple.getString(0);\r\n                for(String word: sentence.split(\" \")) {\r\n                    collector.emit(new Values(word));\r\n                }\r\n            }\r\n        }\r\n    \r\n        // simple topo\r\n        public static StormTopology buildTridentTopology() {\r\n            /*\r\n             * spout reads an infinite stream of sentences from the following source\r\n             */\r\n            @SuppressWarnings(\"unchecked\")\r\n            FixedBatchSpout spout = new FixedBatchSpout(new Fields(\"sentence\"), 3,\r\n                    new Values(\"the cow jumped over the moon\"),\r\n                    new Values(\"the man went to the store and bought some candy\"),\r\n                    new Values(\"four score and seven years ago\"),\r\n                    new Values(\"how many apples can you eat\"),\r\n                    new Values(\"to be or not to be the person\"));\r\n            spout.setCycle(true);\r\n    \r\n            /*\r\n             * TridentTopology object exposes the interface for\r\n    constructing Trident computations\r\n             */\r\n            TridentTopology topology = new TridentTopology();\r\n    \r\n            TridentState wordCounts =\r\n                    topology.newStream(\"spout1\", spout)\r\n                            .parallelismHint(16)\r\n                            .each(new Fields(\"sentence\"), new Split(), new\r\n    Fields(\"word\"))\r\n                            .groupBy(new Fields(\"word\"))\r\n                            .persistentAggregate(new\r\n    MemoryMapState.Factory(), new Count(), new Fields(\"count\"))\r\n                            .parallelismHint(16)\r\n    \r\n    \r\n            ;\r\n            StormTopology topo = topology.build();\r\n            myHook mh =new myHook();\r\n            // serialize one time to get the size of the byte[] result\r\n            byte[] rawdata = Utils.javaSerialize(mh);\r\n            // store the size inside the hook\r\n            // it will be use to fix issue regarding byteBuffer\r\n          mh.setMySize(rawdata.length );\r\n          // serialize with the the size as attibute\r\n          rawdata = Utils.javaSerialize(mh);\r\n    \r\n            ByteBuffer a = ByteBuffer.wrap(rawdata);\r\n            topo.add_to_worker_hooks(a);\r\n    \r\n            return topo;\r\n    \r\n        }\r\n    \r\n    \r\n    \r\n    \r\n        public static void main(String[] args) throws Exception {\r\n    \r\n            Config conf = new Config();\r\n            conf.setMaxSpoutPending(20);\r\n    \r\n                LocalCluster cluster = new LocalCluster();\r\n                cluster.submitTopology(\"wordCounter\", conf, buildTridentTopology());\r\n                    Thread.sleep(10000);\r\n                    cluster.killTopology(\"wordCounter\");\r\n                    Thread.sleep(10000);\r\n                    cluster.shutdown();\n","created":"2018-03-23T21:56:31.635+0000","updated":"2018-03-23T21:56:31.635+0000","started":"2018-03-23T21:56:31.635+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"83836","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/85652","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2591#discussion_r178078460\n  \n    --- Diff: storm-core/src/clj/org/apache/storm/daemon/worker.clj ---\n    @@ -566,9 +566,12 @@\n             worker-topology-context (worker-context worker)\n             hooks (.get_worker_hooks topology)]\n         (dofor [hook hooks]\n    -      (let [hook-bytes (Utils/toByteArray hook)\n    -            deser-hook (Utils/javaDeserialize hook-bytes BaseWorkerHook)]\n    -        (.start deser-hook topo-conf worker-topology-context)))))\n    +      (let [savedposition (.position hook)\n    --- End diff --\n    \n    I guess we could do simpler: `(.duplicate hook)` to get duplicated ByteBuffer object, and read from that instance. It will not increase position from `hook` object.\n","created":"2018-03-29T14:42:54.969+0000","updated":"2018-03-29T14:42:54.969+0000","started":"2018-03-29T14:42:54.969+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"85652","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/85670","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hummelm commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2591#discussion_r178086243\n  \n    --- Diff: storm-core/src/clj/org/apache/storm/daemon/worker.clj ---\n    @@ -566,9 +566,12 @@\n             worker-topology-context (worker-context worker)\n             hooks (.get_worker_hooks topology)]\n         (dofor [hook hooks]\n    -      (let [hook-bytes (Utils/toByteArray hook)\n    -            deser-hook (Utils/javaDeserialize hook-bytes BaseWorkerHook)]\n    -        (.start deser-hook topo-conf worker-topology-context)))))\n    +      (let [savedposition (.position hook)\n    --- End diff --\n    \n    For sure this is a better solution.\r\n    Do I push a new commit implementing this or is there a better way to take into account your suggestion ?\n","created":"2018-03-29T15:05:37.172+0000","updated":"2018-03-29T15:05:37.172+0000","started":"2018-03-29T15:05:37.172+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"85670","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/85674","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user Ethanlm commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2591#discussion_r178087708\n  \n    --- Diff: storm-core/src/clj/org/apache/storm/daemon/worker.clj ---\n    @@ -566,9 +566,12 @@\n             worker-topology-context (worker-context worker)\n             hooks (.get_worker_hooks topology)]\n         (dofor [hook hooks]\n    -      (let [hook-bytes (Utils/toByteArray hook)\n    -            deser-hook (Utils/javaDeserialize hook-bytes BaseWorkerHook)]\n    -        (.start deser-hook topo-conf worker-topology-context)))))\n    +      (let [savedposition (.position hook)\n    --- End diff --\n    \n    You can just push a new commit and squash the commits later\n","created":"2018-03-29T15:09:43.821+0000","updated":"2018-03-29T15:09:43.821+0000","started":"2018-03-29T15:09:43.820+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"85674","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/85679","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2591#discussion_r178093387\n  \n    --- Diff: storm-core/src/clj/org/apache/storm/daemon/worker.clj ---\n    @@ -566,9 +566,12 @@\n             worker-topology-context (worker-context worker)\n             hooks (.get_worker_hooks topology)]\n         (dofor [hook hooks]\n    -      (let [hook-bytes (Utils/toByteArray hook)\n    -            deser-hook (Utils/javaDeserialize hook-bytes BaseWorkerHook)]\n    -        (.start deser-hook topo-conf worker-topology-context)))))\n    +      (let [savedposition (.position hook)\n    --- End diff --\n    \n    I'm OK if you just make change to new squashed commit, since the diff will be one-liner or couple of lines. Sure I'm also OK to see new commit and squash later.\n","created":"2018-03-29T15:27:06.848+0000","updated":"2018-03-29T15:27:06.848+0000","started":"2018-03-29T15:27:06.848+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"85679","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/86153","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user revans2 commented on the issue:\n\n    https://github.com/apache/storm/pull/2591\n  \n    This works and I am OK with merging it in +1.  But the implementation of deserializing the hooks twice feels really odd and non-intuitive to me.  But this is not your problem so it should be fine.\r\n    \r\n    Please do put up a pull request for the master branch too.\r\n    \r\n    I think this should probably apply to the other 1.x branches without any changes.\n","created":"2018-03-30T20:33:32.008+0000","updated":"2018-03-30T20:33:32.008+0000","started":"2018-03-30T20:33:32.008+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86153","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/86429","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/2591\n  \n    Yeah the valid patch should deserialize them only once while initializing worker state, and use them from both places (start and shutdown). Current implementation will not work properly if the implementation of worker hook is something stateful (since we deserialize and initialize two separate objects).\r\n    \r\n    @hummelm \r\n    Could you address this issue? You would want to craft a patch against master branch and 1.x-branch.\n","created":"2018-04-02T00:46:04.139+0000","updated":"2018-04-02T00:46:04.139+0000","started":"2018-04-02T00:46:04.138+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86429","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/86488","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hummelm commented on the issue:\n\n    https://github.com/apache/storm/pull/2591\n  \n    Yes i Will add a list of deserialized hook into the worker and use it to start.stop.\r\n\n","created":"2018-04-02T06:08:53.645+0000","updated":"2018-04-02T06:08:53.645+0000","started":"2018-04-02T06:08:53.645+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"86488","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/87295","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hummelm commented on the issue:\n\n    https://github.com/apache/storm/pull/2591\n  \n    Here is a new implementation which is compatible with stateful workerhook.\r\n    I think this implementation is better isn't it ?\n","created":"2018-04-03T21:45:15.813+0000","updated":"2018-04-03T21:45:15.813+0000","started":"2018-04-03T21:45:15.813+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"87295","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/88661","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2591#discussion_r179904186\n  \n    --- Diff: storm-core/src/clj/org/apache/storm/daemon/worker.clj ---\n    @@ -585,6 +588,8 @@\n     (defserverfn mk-worker [conf shared-mq-context storm-id assignment-id port worker-id]\n       (log-message \"Launching worker for \" storm-id \" on \" assignment-id \":\" port \" with id \" worker-id\n                    \" and conf \" conf)\n    +  ;; create an empty list to store deserialized hooks\n    +  (def deserialized-hooks (java.util.ArrayList.))\n    --- End diff --\n    \n    It would be better to include this in `worker-data` so that it can be reused at any time. Please add this to the returning recursive-map in `worker-data` function, and refer it from other functions.\n","created":"2018-04-07T01:20:14.302+0000","updated":"2018-04-07T01:20:14.302+0000","started":"2018-04-07T01:20:14.301+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"88661","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/88662","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/2591\n  \n    @hummelm \r\n    Btw, we can't merge in this patch without PR for master branch, since master branch is the place which developments take place. Please let me know when you mind taking a look at master branch. I'll submit a patch then.\n","created":"2018-04-07T01:24:26.672+0000","updated":"2018-04-07T01:24:26.672+0000","started":"2018-04-07T01:24:26.671+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"88662","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/88698","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hummelm commented on the issue:\n\n    https://github.com/apache/storm/pull/2591\n  \n    for master branch do I have to create a new pull request ?\n","created":"2018-04-07T07:27:25.408+0000","updated":"2018-04-07T07:27:25.408+0000","started":"2018-04-07T07:27:25.408+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"88698","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/88710","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/2591\n  \n    @hummelm \r\n    Yes since two branches are diverged so I can't port forward/back.\n","created":"2018-04-07T11:16:50.526+0000","updated":"2018-04-07T11:16:50.526+0000","started":"2018-04-07T11:16:50.526+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"88710","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/88726","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user hummelm opened a pull request:\n\n    https://github.com/apache/storm/pull/2625\n\n    fix STORM-2979 (master branch)\n\n    Add in WorkerState an internal list of deserialized workerHooks and use it to\r\n    start/stop\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/hummelm/storm STORM-2979-master\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2625.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2625\n    \n----\ncommit ce7c716fc55c9af792998c2b3d512018cdbd8bec\nAuthor: michelo <michelo@...>\nDate:   2018-04-07T16:13:12Z\n\n    fix STORM-2979\n    \n    Add in WorkerState an internal list of workerHooks and use it to\n    start/stop\n\n----\n","created":"2018-04-07T16:17:17.171+0000","updated":"2018-04-07T16:17:17.171+0000","started":"2018-04-07T16:17:17.170+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"88726","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/88727","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hummelm commented on the issue:\n\n    https://github.com/apache/storm/pull/2591\n  \n    pull request for master branch:\r\n    [https://github.com/apache/storm/pull/2625](https://github.com/apache/storm/pull/2625)\n","created":"2018-04-07T16:19:02.704+0000","updated":"2018-04-07T16:19:02.704+0000","started":"2018-04-07T16:19:02.703+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"88727","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/88736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2625#discussion_r179931937\n  \n    --- Diff: storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java ---\n    @@ -599,20 +613,16 @@ public WorkerTopologyContext getWorkerTopologyContext() {\n         public void runWorkerStartHooks() {\n             WorkerTopologyContext workerContext = getWorkerTopologyContext();\n             if (topology.is_set_worker_hooks()) {\n    -            for (ByteBuffer hook : topology.get_worker_hooks()) {\n    -                byte[] hookBytes = Utils.toByteArray(hook);\n    -                BaseWorkerHook hookObject = Utils.javaDeserialize(hookBytes, BaseWorkerHook.class);\n    -                hookObject.start(topologyConf, workerContext);\n    +            for (IWorkerHook hook : getDeserializedWorkerHooks()) {\n    +                hook.start(topologyConf, workerContext);\n                 }\n             }\n         }\n     \n         public void runWorkerShutdownHooks() {\n             if (topology.is_set_worker_hooks()) {\n    --- End diff --\n    \n    if statement unnecessary for now.\n","created":"2018-04-08T01:05:03.895+0000","updated":"2018-04-08T01:05:03.895+0000","started":"2018-04-08T01:05:03.895+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"88736","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/88737","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2625#discussion_r179931931\n  \n    --- Diff: storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java ---\n    @@ -599,20 +613,16 @@ public WorkerTopologyContext getWorkerTopologyContext() {\n         public void runWorkerStartHooks() {\n             WorkerTopologyContext workerContext = getWorkerTopologyContext();\n             if (topology.is_set_worker_hooks()) {\n    --- End diff --\n    \n    if statement unnecessary for now.\n","created":"2018-04-08T01:05:04.421+0000","updated":"2018-04-08T01:05:04.421+0000","started":"2018-04-08T01:05:04.421+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"88737","issueId":"13141208"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13141208/worklog/88738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2625#discussion_r179931950\n  \n    --- Diff: storm-client/src/jvm/org/apache/storm/daemon/worker/WorkerState.java ---\n    @@ -339,6 +344,15 @@ public WorkerState(Map<String, Object> conf, IContext mqContext, String topology\n             int maxTaskId = getMaxTaskId(componentToSortedTasks);\n             this.workerTransfer = new WorkerTransfer(this, topologyConf, maxTaskId);\n             this.bpTracker = new BackPressureTracker(workerId, localTaskIds);\n    +        // \n    --- End diff --\n    \n    ‘//‘ can be removed, and better to extract below to private method as we did above.\n","created":"2018-04-08T01:05:05.047+0000","updated":"2018-04-08T01:05:05.047+0000","started":"2018-04-08T01:05:05.046+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"88738","issueId":"13141208"}]},"customfield_12311820":"0|i3qn6n:"}}