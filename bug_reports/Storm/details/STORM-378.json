{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12724630","self":"https://issues.apache.org/jira/rest/api/2/issue/12724630","key":"STORM-378","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2014-10-16T02:49:25.060+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jan 09 02:08:09 UTC 2015","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_16586124189_*|*_4_*:*_1_*:*_16375_*|*_6_*:*_2_*:*_23585177436","customfield_12310420":"402813","customfield_12312321":null,"resolutiondate":"2015-10-09T01:35:30.189+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-378/watchers","watchCount":2,"isWatching":false},"created":"2014-07-01T02:53:32.212+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326452","id":"12326452","name":"0.9.2-incubating","archived":false,"released":true,"releaseDate":"2014-06-25"}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caofangkun","name":"caofangkun","key":"caofangkun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=caofangkun&avatarId=23151","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=caofangkun&avatarId=23151","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=caofangkun&avatarId=23151","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=caofangkun&avatarId=23151"},"displayName":"caofangkun","active":true,"timeZone":"Asia/Shanghai"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-10-09T01:35:30.210+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12327950","id":"12327950","name":"storm-core","description":"Core storm daemons and APIs including trident"}],"timeoriginalestimate":null,"description":"{code:java}\nIndex: src/jvm/backtype/storm/spout/SleepSpoutWaitStrategy.java\n===================================================================\n--- src/jvm/backtype/storm/spout/SleepSpoutWaitStrategy.java\t(revision 2868)\n+++ src/jvm/backtype/storm/spout/SleepSpoutWaitStrategy.java\t(working copy)\n@@ -18,6 +18,8 @@\n package backtype.storm.spout;\n \n import backtype.storm.Config;\n+import backtype.storm.utils.Utils;\n+\n import java.util.Map;\n \n \n@@ -27,13 +29,14 @@\n     \n     @Override\n     public void prepare(Map conf) {\n-        sleepMillis = ((Number) conf.get(Config.TOPOLOGY_SLEEP_SPOUT_WAIT_STRATEGY_TIME_MS)).longValue();\n+        sleepMillis = Utils.getLong(\n+            conf.get(Config.TOPOLOGY_SLEEP_SPOUT_WAIT_STRATEGY_TIME_MS), 500);\n     }\n \n     @Override\n     public void emptyEmit(long streak) {\n         try {\n-            Thread.sleep(sleepMillis);\n+            Thread.sleep(Math.abs(sleepMillis + streak));\n         } catch (InterruptedException e) {\n             throw new RuntimeException(e);\n         }\nIndex: src/jvm/backtype/storm/utils/Utils.java\n===================================================================\n--- src/jvm/backtype/storm/utils/Utils.java\t(revision 2888)\n+++ src/jvm/backtype/storm/utils/Utils.java\t(working copy)\n@@ -325,6 +325,24 @@\n           throw new IllegalArgumentException(\"Don't know how to convert \" + o + \" + to int\");\n       }\n     }\n+    \n+    public static Long getLong(Object o, long defaultValue) {\n+\n+      if (o == null) {\n+        return defaultValue;\n+      }\n+\n+      if (o instanceof String) {\n+        return Long.valueOf(String.valueOf(o));\n+      } else if (o instanceof Integer) {\n+        Integer value = (Integer) o;\n+        return Long.valueOf((Integer) value);\n+      } else if (o instanceof Long) {\n+        return (Long) o;\n+      } else {\n+        return defaultValue;\n+      }\n+    }\n \n     public static boolean getBoolean(Object o, boolean defaultValue) {\n       if (null == o) {\n{code}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"402874","customfield_12312823":null,"summary":"SleepSpoutWaitStrategy.emptyEmit should use  the variable \"streak\"","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caofangkun","name":"caofangkun","key":"caofangkun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=caofangkun&avatarId=23151","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=caofangkun&avatarId=23151","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=caofangkun&avatarId=23151","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=caofangkun&avatarId=23151"},"displayName":"caofangkun","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caofangkun","name":"caofangkun","key":"caofangkun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=caofangkun&avatarId=23151","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=caofangkun&avatarId=23151","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=caofangkun&avatarId=23151","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=caofangkun&avatarId=23151"},"displayName":"caofangkun","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12724630/comment/14173265","id":"14173265","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user caofangkun opened a pull request:\n\n    https://github.com/apache/storm/pull/295\n\n    STORM-378,SleepSpoutWaitStrategy.emptyEmit should use the variable strea...\n\n    ...k\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/caofangkun/apache-storm storm-378\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/295.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #295\n    \n----\ncommit 154c54d53399756a66a8ad51d93e9e7f58117c7d\nAuthor: caofangkun <caofangkun@gmail.com>\nDate:   2014-10-16T02:41:25Z\n\n    STORM-378,SleepSpoutWaitStrategy.emptyEmit should use the variable streak\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-16T02:49:25.060+0000","updated":"2014-10-16T02:49:25.060+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12724630/comment/14183698","id":"14183698","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user HeartSaVioR commented on the pull request:\n\n    https://github.com/apache/storm/pull/295#issuecomment-60460916\n  \n    @caofangkun \n    It's mk-threads in executor.clj.\n    \n    ```\n                (if (and (= curr-count (.get emitted-count)) active?)\n                  (do (.increment empty-emit-streak)\n                      (.emptyEmit spout-wait-strategy (.get empty-emit-streak)))\n                  (.set empty-emit-streak 0)\n                  ))           \n    ```\n    \n    You can find that streak gets increased by 1, so I think it's for alternative implementation of ISpoutWaitStrategy, not SleepSpoutWaitStrategy.\n    (@nathanmarz Could you please confirm it?)\n    If it is for, just adding it to sleepMillis barely affects sleep time.\n    Streak should be multiplied by 10 or something bigger, maybe we can apply exponential value of already multiplied streak.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-24T23:10:40.266+0000","updated":"2014-10-24T23:10:40.266+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12724630/comment/14196059","id":"14196059","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user clockfly commented on the pull request:\n\n    https://github.com/apache/storm/pull/295#issuecomment-61634029\n  \n    To make the whole topology responsive, the spout need to stay active to pull data frequently from acker or system tick.\n    \n    When setting \"topology.sleep.spout.wait.strategy.time.ms\" to 1 ms,  it should be good enough, the system load is relatively small.\n    \n    What is the motivation to make it increasing?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-04T12:43:32.826+0000","updated":"2014-11-04T12:43:32.826+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12724630/comment/14197683","id":"14197683","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user itaifrenkel commented on the pull request:\n\n    https://github.com/apache/storm/pull/295#issuecomment-61766182\n  \n    On the one hand - when the spout is a multilang bolt, 1ms drains ~10-5% of a CPU core on aws c3.large, so we increase it to 10ms.\n    On the other hand, increasing the sleep adds jitter to the spout latency when maxSpoutPending is enabled. Is there a configurable maximum value for the streak?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-05T06:41:50.761+0000","updated":"2014-11-05T06:41:50.761+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12724630/comment/14197697","id":"14197697","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user HeartSaVioR commented on the pull request:\n\n    https://github.com/apache/storm/pull/295#issuecomment-61767078\n  \n    To make it clear, PR points to \"increase/decrease\" sleep time with streak.\n    Fixed sleep time is configurable so it doesn't matter how long it is, optimal value should be vary for workload.\n    \n    I think we can make new ISpoutWaitStrategy implementation that play with streak if we really need it.\n    We definitely need wait strategy to always sleep same time (ex. 1ms), so it isn't a good idea to change existing class's behavior.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-05T06:55:03.324+0000","updated":"2014-11-05T06:55:03.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12724630/comment/14198850","id":"14198850","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user ptgoetz commented on the pull request:\n\n    https://github.com/apache/storm/pull/295#issuecomment-61860848\n  \n    -1\n    \n    I agree with @HeartSaVioR that if we want an implementation of `ISpoutWaitStrategy` that takes into account the `streak` parameter, it should be a separate implementation and `SleepSpoutWaitStrategy` should be left as-is.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-05T18:54:04.445+0000","updated":"2014-11-05T18:54:04.445+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12724630/comment/14270412","id":"14270412","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user caofangkun closed the pull request at:\n\n    https://github.com/apache/storm/pull/295\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-09T02:08:09.020+0000","updated":"2015-01-09T02:08:09.020+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-378/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1xbxr:"}}