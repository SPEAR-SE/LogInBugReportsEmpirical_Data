{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12856754","self":"https://issues.apache.org/jira/rest/api/2/issue/12856754","key":"STORM-996","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12333021","id":"12333021","name":"0.9.6","archived":false,"released":true,"releaseDate":"2015-11-05"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-08-19T18:32:43.707+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Oct 17 14:20:08 UTC 2015","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1570523062_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2015-09-05T01:59:58.926+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-996/watchers","watchCount":4,"isWatching":false},"created":"2015-08-17T21:44:35.912+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12327123","id":"12327123","description":"security feature branch","name":"0.10.0","archived":false,"released":true,"releaseDate":"2015-11-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12333021","id":"12333021","name":"0.9.6","archived":false,"released":true,"releaseDate":"2015-11-05"}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knusbaum","name":"knusbaum","key":"knusbaum","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knusbaum&avatarId=22452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knusbaum&avatarId=22452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knusbaum&avatarId=22452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knusbaum&avatarId=22452"},"displayName":"Kyle Nusbaum","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-10-17T14:20:08.737+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12327950","id":"12327950","name":"storm-core","description":"Core storm daemons and APIs including trident"}],"timeoriginalestimate":null,"description":"backtype.storm.messaging.netty-unit-test/test-batch\n\nOne example of output.  Similar things happen sporadically and vary widely by number of failed assertions.\n\nTuples are not just skewed, but actually seem to come in out-of-order.\n\n{quote}\nactual: (not (= \"66040\" \"66041\"))\nat: test_runner.clj:105\n\nexpected: (= req_msg resp_msg)\nactual: (not (= \"66041\" \"66042\"))\nat: test_runner.clj:105\n\nexpected: (= req_msg resp_msg)\nactual: (not (= \"66042\" \"66040\"))\nat: test_runner.clj:105\n{quote}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12753204","id":"12753204","filename":"storm-996-OrderedDownstreamThreadPoolExecutor-failed.txt.bz2","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"created":"2015-08-30T18:24:15.223+0000","size":48280,"mimeType":"application/x-bzip2","content":"https://issues.apache.org/jira/secure/attachment/12753204/storm-996-OrderedDownstreamThreadPoolExecutor-failed.txt.bz2"}],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"netty-unit-tests/test-batch demonstrates out-of-order delivery","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14701818","id":"14701818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"body":"Suspecting maybe the [asynchronous write|https://github.com/apache/storm/blob/3b1b3bfa595851afd468594079caa7c772dafd48/storm-core/src/jvm/backtype/storm/messaging/netty/Client.java#L323] in Client#flushMesages might be the issue.  We create a future here to write the data asynchronously, but the new thread does not have to be scheduled to run before subsequent batches are written, and so batches can be sent in the wrong order.\n\nEDIT: spelling","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"created":"2015-08-18T19:18:20.521+0000","updated":"2015-08-18T19:19:02.101+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14703522","id":"14703522","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=parth.brahmbhatt","name":"parth.brahmbhatt","key":"parth.brahmbhatt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Parth Brahmbhatt","active":true,"timeZone":"America/Los_Angeles"},"body":"[~dagit] How are you reproducing this? I just ran this test in a loop for 50 times and it passed all the time for me. I am on following java version\n\n➜  incubator-storm git:(ha-merge) ✗ java -version\njava version \"1.8.0_31\"\nJava(TM) SE Runtime Environment (build 1.8.0_31-b13)\nJava HotSpot(TM) 64-Bit Server VM (build 25.31-b07, mixed mode)\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=parth.brahmbhatt","name":"parth.brahmbhatt","key":"parth.brahmbhatt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Parth Brahmbhatt","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-08-19T18:32:43.707+0000","updated":"2015-08-19T18:32:43.707+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14704748","id":"14704748","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"I'm not sure it was same issue cause error messages were not properly logged, but sometimes Travis CI also fails because of netty unit test. Please see here.\nhttps://travis-ci.org/apache/storm/jobs/76404540\n\nIf it succeeds, test result is below,\n{quote}\nRunning backtype.storm.messaging.netty-unit-test\nTests run: 3, Passed: 100003, Failures: 0, Errors: 0\n{quote}\n\nBut in this situation, test result shows difference,\n{quote}\nRunning backtype.storm.messaging.netty-unit-test\n16417 [main] INFO  b.s.m.n.Client - closing Netty Client Netty-Client-localhost/127.0.0.1:6700\n16417 [main] INFO  b.s.m.n.Client - waiting up to 600000 ms to send 0 pending messages to Netty-Client-localhost/127.0.0.1:6700\nTests run: 3, Passed: 100001, Failures: 2, Errors: 0\n{quote}\n\nStrange thing comes here - INFO lines exposed to output which didn't.\n\nActually I've met failure of test-batch on my Mac recently, but it is not reproducible.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2015-08-20T12:17:53.209+0000","updated":"2015-08-20T12:17:53.209+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14706417","id":"14706417","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"body":"> How are you reproducing this?\n\nWe have seen intermittent test failures on OSX and Linux.  It varies, but I see it happen at least once in 10 tries when doing `mvn test -Dtest=...`.  When I tested via the REPL with `run-tests`, it seemed not to happen.  I have not tried on a single-core environment, but I imagine it could be more likely on multi-core machines.\n\nI have this on OSX:\n\n{code}\n∴ java -version\njava version \"1.8.0_45\"\nJava(TM) SE Runtime Environment (build 1.8.0_45-b14)\nJava HotSpot(TM) 64-Bit Server VM (build 25.45-b02, mixed mode)\n{code}\n\n> Strange thing comes here - INFO lines exposed to output which didn't.\n\nYeah, I noticed the output in the XML file under test-reports.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"created":"2015-08-21T08:42:27.471+0000","updated":"2015-08-21T08:42:27.471+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14720912","id":"14720912","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"body":"After discussion with [~revans2] and [~knusbaum], I am looking at correcting out-of-order messages on the receiving side by adding sequence numbers to each batch.\n\nMeanwhile, on [~kishorvpatil]'s suggestion, I looked at using the [OrderedDownstreamThreadPoolExecutor|http://netty.io/3.9/api/org/jboss/netty/handler/execution/OrderedDownstreamThreadPoolExecutor.html] where we initialize the Netty [Context|https://github.com/apache/storm/blob/07e0ff2e206a0e0ca96da9137ebbd3fc7a5e9c8b/storm-core/src/jvm/backtype/storm/messaging/netty/Context.java#L58-L64].  This approach could have some impact to performance, as it guarantees that downstream events, per-channel, are ordered when sending.  I tried it out and found that the batch test still fails with individual messages appearing out of order.  The reproducability is similar to testing without changes.  \n\n{code}\n            <failure>expected: (= req_msg resp_msg)\n  actual: (not (= &quot;64648&quot; &quot;64649&quot;))\n      at: test_runner.clj:105</failure>\n            <failure>expected: (= req_msg resp_msg)\n  actual: (not (= &quot;64649&quot; &quot;64648&quot;))\n      at: test_runner.clj:105</failure>\n            <failure>expected: (= req_msg resp_msg)\n  actual: (not (= &quot;68841&quot; &quot;68842&quot;))\n      at: test_runner.clj:105</failure>\n            <failure>expected: (= req_msg resp_msg)\n  actual: (not (= &quot;68842&quot; &quot;68841&quot;))\n      at: test_runner.clj:105</failure>\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"created":"2015-08-29T02:07:35.825+0000","updated":"2015-08-29T02:07:35.825+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14721639","id":"14721639","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"body":"Following up briefly: I wanted to see if the nature of the failures when using the OrderedDownstreamThreadPoolExecutor was different from before, but with another test run just now it appears the same.\n\nIn the quoted example, it shows individual messages—but not batches—being delivered out of order from the perspective of the test.  I ran it again just now, and the test failed with long sequences of messages being delivered out-of-order as in the description.  I will attach a file with just the test failure output as an example.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"created":"2015-08-30T18:10:07.136+0000","updated":"2015-08-30T18:10:07.136+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14721645","id":"14721645","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"body":"assertions failed from test-report output for netty-unit-test/test-batch with OrderedDownstreamThreadPoolExecutor used in backtype.storm.messaging.netty.Context","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"created":"2015-08-30T18:24:15.226+0000","updated":"2015-08-30T18:24:15.226+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14722708","id":"14722708","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"body":"If I enable the debugging statement that logs how many messages are sent when sending a batch, I can no longer reproduce the error.  As soon as I disable this statement, the error reappears.\n\nSo I thought I would quickly check the actual network traffic.  I confirmed by inspecting packets sent during the netty-unit-test/test-batch that the task messages were actually sent out-of-order, and it is not a matter of the test code incorrectly handling what had been received in-order.\n\nPatch:\n\n{code}\ndiff --git a/storm-core/src/jvm/backtype/storm/messaging/netty/Context.java b/storm-core/src/jvm/backtype/storm/messaging/netty/Context.java\nindex 5d27a16..0b59ec6 100644\n--- a/storm-core/src/jvm/backtype/storm/messaging/netty/Context.java\n+++ b/storm-core/src/jvm/backtype/storm/messaging/netty/Context.java\n@@ -18,6 +18,7 @@\n package backtype.storm.messaging.netty;\n \n import org.jboss.netty.channel.socket.nio.NioClientSocketChannelFactory;\n+import org.jboss.netty.handler.execution.OrderedDownstreamThreadPoolExecutor;\n import org.jboss.netty.util.HashedWheelTimer;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n@@ -56,11 +57,10 @@ public class Context implements IContext {\n \t\tThreadFactory bossFactory = new NettyRenameThreadFactory(\"client\" + \"-boss\");\n         ThreadFactory workerFactory = new NettyRenameThreadFactory(\"client\" + \"-worker\");\n         if (maxWorkers > 0) {\n-            clientChannelFactory = new NioClientSocketChannelFactory(Executors.newCachedThreadPool(bossFactory),\n-                    Executors.newCachedThreadPool(workerFactory), maxWorkers);\n+            clientChannelFactory = new NioClientSocketChannelFactory(new OrderedDownstreamThreadPoolExecutor(4, 30, TimeUnit.SECONDS, bossFactory),\n+                    new OrderedDownstreamThreadPoolExecutor(4, 30, TimeUnit.SECONDS, workerFactory), maxWorkers);\n         } else {\n-            clientChannelFactory = new NioClientSocketChannelFactory(Executors.newCachedThreadPool(bossFactory),\n-                    Executors.newCachedThreadPool(workerFactory));\n+            throw new RuntimeException(Config.STORM_MESSAGING_NETTY_CLIENT_WORKER_THREADS + \" should be greater than 0\");\n         }\n         \n         clientScheduleService = new HashedWheelTimer(new NettyRenameThreadFactory(\"client-schedule-service\"));\n{code}\n\n\nHere are three messages received in sequence showing out-of-order sending from the network perspective:\n\n{code}\nASCII-encoded hex values of task message \n                               |\n   payload length (long)       |\n                |              |\ntaskId (short)  |              |\n    |           |              |\n<...> <.........> <............>\n00:01:00:00:00:05:36:32:32:32:34:ff:37\n00:01:00:00:00:05:36:32:32:32:36:ff:37\n00:01:00:00:00:05:36:32:32:32:35:ff:37\n{code}\n\nMessages decode to \"62224\", \"62226\", \"62225\", and this corresponds with the test output:\n\n\n{code}\n  expected: (= req_msg resp_msg)\n  actual: (not (= \"62225\" \"62226\"))\n      at: test_runner.clj:105\n  expected: (= req_msg resp_msg)\n  actual: (not (= \"62226\" \"62225\"))\n      at: test_runner.clj:105\n{code}\n\nIt does not happen every time, and the specific failures vary, but at least this confirms that it is not an issue with the test code, and that the client actually sent things out-of-order even when Netty's executor ensures ordering of downstream events.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dagit","name":"dagit","key":"dagit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dagit&avatarId=25742","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dagit&avatarId=25742","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dagit&avatarId=25742","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dagit&avatarId=25742"},"displayName":"Derek Dagit","active":true,"timeZone":"America/Chicago"},"created":"2015-08-31T04:54:41.634+0000","updated":"2015-08-31T04:54:41.634+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14725756","id":"14725756","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user knusbaum opened a pull request:\n\n    https://github.com/apache/storm/pull/711\n\n    STORM-996: netty-unit-tests/test-batch demonstrates out-of-order delivery\n\n    Netty calls notifyInterestChanged which causes a race condition in flushMessages.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/knusbaum/incubator-storm STORM-996\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/711.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #711\n    \n----\ncommit 11886c0c4c3aa2547b1ef571712bed83229dc4e4\nAuthor: Kyle Nusbaum <kylejnusbaum@gmail.com>\nDate:   2015-09-01T17:13:05Z\n\n    Netty Fix.\n\ncommit 3783f4e6669d185d5a0fd42468347238350c2774\nAuthor: Kyle Nusbaum <kylejnusbaum@gmail.com>\nDate:   2015-09-01T17:37:01Z\n\n    Whitespace\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-01T17:43:17.788+0000","updated":"2015-09-01T17:43:17.788+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14725795","id":"14725795","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user d2r commented on the pull request:\n\n    https://github.com/apache/storm/pull/711#issuecomment-136813085\n  \n    +1 This seems to fix the issue. I ran test-batch ~50 times without a failure.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-01T18:00:40.322+0000","updated":"2015-09-01T18:00:40.322+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14726065","id":"14726065","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user kishorvpatil commented on the pull request:\n\n    https://github.com/apache/storm/pull/711#issuecomment-136840377\n  \n    LGTM. +1\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-01T19:53:09.794+0000","updated":"2015-09-01T19:53:09.794+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14726177","id":"14726177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user HeartSaVioR commented on the pull request:\n\n    https://github.com/apache/storm/pull/711#issuecomment-136859814\n  \n    +1\n    Great! Missed StormClientHandler so there's only one thread which accesses to Client at any time.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-01T20:58:38.833+0000","updated":"2015-09-01T20:58:38.833+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14726357","id":"14726357","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user ptgoetz commented on the pull request:\n\n    https://github.com/apache/storm/pull/711#issuecomment-136884363\n  \n    +1 Nice work.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-01T22:47:01.357+0000","updated":"2015-09-01T22:47:01.357+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14731705","id":"14731705","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/storm/pull/711\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-05T01:59:36.589+0000","updated":"2015-09-05T01:59:36.589+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14731706","id":"14731706","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"Nice work, [~knusbaum]\nI merged into master and 0.10.x-branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2015-09-05T01:59:58.961+0000","updated":"2015-09-05T01:59:58.961+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12856754/comment/14961920","id":"14961920","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"body":"Also backported to 0.9.x-branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kabhwan","name":"kabhwan","key":"kabhwan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jungtaek Lim","active":true,"timeZone":"Asia/Seoul"},"created":"2015-10-17T14:20:08.737+0000","updated":"2015-10-17T14:20:08.737+0000"}],"maxResults":16,"total":16,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-996/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2j0z3:"}}