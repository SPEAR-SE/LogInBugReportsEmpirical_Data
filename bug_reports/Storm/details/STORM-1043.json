{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12863418","self":"https://issues.apache.org/jira/rest/api/2/issue/12863418","key":"STORM-1043","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":"2015-09-11T15:02:10.490+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Sep 14 16:17:25 UTC 2015","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_549368_*|*_4_*:*_2_*:*_53231_*|*_6_*:*_3_*:*_2369057665","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2015-10-09T01:07:37.081+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-1043/watchers","watchCount":3,"isWatching":false},"created":"2015-09-11T14:53:16.840+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["mesosphere"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12332476","id":"12332476","name":"0.9.5","archived":false,"released":true,"releaseDate":"2015-06-04"}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erikdw","name":"erikdw","key":"erikdw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=erikdw&avatarId=26098","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=erikdw&avatarId=26098","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=erikdw&avatarId=26098","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=erikdw&avatarId=26098"},"displayName":"Erik Weathers","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-10-09T01:07:37.101+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12327950","id":"12327950","name":"storm-core","description":"Core storm daemons and APIs including trident"}],"timeoriginalestimate":null,"description":"Hi,\n\nwe are running storm-mesos cluster and occassionaly workers die or are \"lost\" in mesos. When this happens it often coincides with errors in logs related to supervisors local state.\n\nBy looking at the storm code it seems this might be caused by the way how multiple supervisor processes access the local state in the same directory via VersionedStore.\n\nFor example: https://github.com/apache/storm/blob/master/storm-core/src/clj/backtype/storm/daemon/supervisor.clj#L434\n\nHere every supervisor does this concurrently:\n1. reads latest state from FS\n2. possibly updates the state\n3. writes the new version of the state\n\nSome updates could be lost if there are 2+ supervisors and they execute above steps concurrently - then only the updates from last supervisor would remain on the last state version on the disk.\n\nWe observed local state changes quite often (seconds), so the likelihood of this concurrency issue occurring is high.\n\nSome examples of exeptions:\n------------------------------------------\njava.lang.RuntimeException: Version already exists or data already exists\nat backtype.storm.utils.VersionedStore.createVersion(VersionedStore.java:85) ~[storm-core-0.9.5.jar:0.9.5]\nat backtype.storm.utils.VersionedStore.createVersion(VersionedStore.java:79) ~[storm-core-0.9.5.jar:0.9.5]\nat backtype.storm.utils.LocalState.persist(LocalState.java:101) ~[storm-core-0.9.5.jar:0.9.5]\nat backtype.storm.utils.LocalState.put(LocalState.java:82) ~[storm-core-0.9.5.jar:0.9.5]\nat backtype.storm.utils.LocalState.put(LocalState.java:76) ~[storm-core-0.9.5.jar:0.9.5]\nat backtype.storm.daemon.supervisor$mk_synchronize_supervisor$this7400.invoke(supervisor.clj:382) ~[storm-core-0.9.5.jar:0.9.5]\nat backtype.storm.event$event_manager$fn2625.invoke(event.clj:40) ~[storm-core-0.9.5.jar:0.9.5]\nat clojure.lang.AFn.run(AFn.java:24) [clojure-1.5.1.jar:na]\nat java.lang.Thread.run(Thread.java:745) [na:1.8.0_60]\n\n---------------------------------------\njava.io.FileNotFoundException: File '/var/lib/storm/supervisor/localstate/1441034838231' does not exist\nat org.apache.commons.io.FileUtils.openInputStream(FileUtils.java:299) ~[commons-io-2.4.jar:2.4]\nat org.apache.commons.io.FileUtils.readFileToByteArray(FileUtils.java:1763) ~[commons-io-2.4.jar:2.4]\nat backtype.storm.utils.LocalState.deserializeLatestVersion(LocalState.java:61) ~[storm-core-0.9.5.jar:0.9.5]\nat backtype.storm.utils.LocalState.snapshot(LocalState.java:47) ~[storm-core-0.9.5.jar:0.9.5]\nat backtype.storm.utils.LocalState.get(LocalState.java:72) ~[storm-core-0.9.5.jar:0.9.5]\nat backtype.storm.daemon.supervisor$sync_processes.invoke(supervisor.clj:234) ~[storm-core-0.9.5.jar:0.9.5]\nat clojure.lang.AFn.applyToHelper(AFn.java:161) [clojure-1.5.1.jar:na]\nat clojure.lang.AFn.applyTo(AFn.java:151) [clojure-1.5.1.jar:na]\nat clojure.core$apply.invoke(core.clj:619) ~[clojure-1.5.1.jar:na]\nat clojure.core$partial$fn4190.doInvoke(core.clj:2396) ~[clojure-1.5.1.jar:na]\nat clojure.lang.RestFn.invoke(RestFn.java:397) ~[clojure-1.5.1.jar:na]\nat backtype.storm.event$event_manager$fn2625.invoke(event.clj:40) ~[storm-core-0.9.5.jar:0.9.5]\nat clojure.lang.AFn.run(AFn.java:24) [clojure-1.5.1.jar:na]\nat java.lang.Thread.run(Thread.java:745) [na:1.8.0_60]\n-----------------------------------------","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Concurrent access to state on local FS by multiple supervisors","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ernisv","name":"ernisv","key":"ernisv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ernestas Vaiciukevičius","active":true,"timeZone":"Europe/Vilnius"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ernisv","name":"ernisv","key":"ernisv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ernestas Vaiciukevičius","active":true,"timeZone":"Europe/Vilnius"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12863418/comment/14740950","id":"14740950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"body":"Having multiple supervisors share the same storm-local is bad and can result in a lot of other errors beyond this.\n\nIf you want to run multiple supervisors on the same node please set {code}storm.local.dir{code} differently for each of them.  I am not totally sure how you are launching your supervisors through mesos, but you can set configs on the command line using -c when launching the supervisor just like you can when launching a topology.\n\nYou are also going to have to set the {code}supervisor.slots.ports{code} to be different for each supervisor or the workers will collide with each other when trying to run.  There are likely to be other issues too.  This is not officially supported.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"created":"2015-09-11T15:02:10.490+0000","updated":"2015-09-11T15:02:10.490+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12863418/comment/14743632","id":"14743632","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ernisv","name":"ernisv","key":"ernisv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ernestas Vaiciukevičius","active":true,"timeZone":"Europe/Vilnius"},"body":"We are using this project to integrate Storm and Mesos: https://github.com/mesos/storm and it actually launches several supervisors on the same storm local dir.\nIt seems it's more to do with that project, therefore i submitted this issue on their GitHub page.\n\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ernisv","name":"ernisv","key":"ernisv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ernestas Vaiciukevičius","active":true,"timeZone":"Europe/Vilnius"},"created":"2015-09-14T15:00:54.886+0000","updated":"2015-09-14T15:00:54.886+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12863418/comment/14743637","id":"14743637","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ernisv","name":"ernisv","key":"ernisv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ernestas Vaiciukevičius","active":true,"timeZone":"Europe/Vilnius"},"body":"The link to submitted issue: https://github.com/mesos/storm/issues/60","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ernisv","name":"ernisv","key":"ernisv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ernestas Vaiciukevičius","active":true,"timeZone":"Europe/Vilnius"},"created":"2015-09-14T15:02:23.850+0000","updated":"2015-09-14T15:02:23.850+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12863418/comment/14743763","id":"14743763","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erikdw","name":"erikdw","key":"erikdw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=erikdw&avatarId=26098","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=erikdw&avatarId=26098","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=erikdw&avatarId=26098","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=erikdw&avatarId=26098"},"displayName":"Erik Weathers","active":true,"timeZone":"Etc/UTC"},"body":"As I replied in the issue that [~ernisv] raised (https://github.com/mesos/storm/issues/60), the solution is to leverage mesos's ability to put framework's data into separate sandboxes.  Just *don't* set {{storm.local.dir}} and the cwd of the Mesos Executor will be used for the Supervisor, which will be in the supervisor-specific sandbox.\n\nFYI [~revans2], the ports are taken care of automatically by Mesos's scheduler/offer system, as they are considered part of the resources that each topology is claiming on the Mesos worker nodes (\"mesos-slave\" has now been renamed as \"mesos-agent\").","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=erikdw","name":"erikdw","key":"erikdw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=erikdw&avatarId=26098","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=erikdw&avatarId=26098","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=erikdw&avatarId=26098","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=erikdw&avatarId=26098"},"displayName":"Erik Weathers","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-14T16:17:25.148+0000","updated":"2015-09-14T16:18:17.725+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-1043/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2k247:"}}