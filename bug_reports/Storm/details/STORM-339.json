{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12718534","self":"https://issues.apache.org/jira/rest/api/2/issue/12718534","key":"STORM-339","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-06-16T17:43:43.539+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Dec 02 17:35:04 UTC 2015","customfield_12312320":null,"customfield_12310222":null,"customfield_12310420":"396733","customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-339/watchers","watchCount":6,"isWatching":false},"created":"2014-06-05T04:31:12.020+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326452","id":"12326452","name":"0.9.2-incubating","archived":false,"released":true,"releaseDate":"2014-06-25"}],"customfield_12312339":null,"issuelinks":[{"id":"12390912","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12390912","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12725384","key":"STORM-387","self":"https://issues.apache.org/jira/rest/api/2/issue/12725384","fields":{"summary":"Memory leak in worker","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-12-02T17:35:04.012+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12327950","id":"12327950","name":"storm-core","description":"Core storm daemons and APIs including trident"}],"timeoriginalestimate":null,"description":"Without any ackers enabled, fast component  will continuously leak memory and causing OOM problems when target component is slow. The OOM problem can be reproduced by running this fast-slow-topology:\n\nhttps://github.com/Gvain/storm-perf-test/tree/fast-slow-topology\n\nwith command:\n\n{code}\n$ storm jar storm_perf_test-1.0.0-SNAPSHOT-jar-with-dependencies.jar com.yahoo.storm.perftest.Main --spout 1 --bolt 1 --workers 2 --testTime 600 --messageSize 6400\n{code}\n\nAnd the worker childopts with {{-Xms2g -Xmx2g -Xmn512m ...}}.\n\nAt the same time, the executed count of target component is far behind from the emitted count of source component.  I guess it could be that netty client is buffering too much messages in its message_queue as target component sends back OK/Failure Response too slowly. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"396852","customfield_12312823":null,"summary":"Severe memory leak to OOM when ackers disabled","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Gvain","name":"Gvain","key":"gvain","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jiahong Li","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Gvain","name":"Gvain","key":"gvain","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jiahong Li","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718534/comment/14032672","id":"14032672","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"body":"This is not specific to the Netty transport, although it does not help because it does buffer a lot more than the zeromq code did.  If you don't have acking enabled there is no flow control in storm, and if you have not properly sized your components the tuples will be buffered in memory and eventually OOM or be shot by the supervisor because GC took too long and the heartbeats stopped coming.\n\nI'm not sure that there is a really good way to fix this totally without acking.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"created":"2014-06-16T17:43:43.539+0000","updated":"2014-06-16T17:43:43.539+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718534/comment/14052518","id":"14052518","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hsn","name":"hsn","key":"hsn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hsn&avatarId=11931","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hsn&avatarId=11931","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hsn&avatarId=11931","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hsn&avatarId=11931"},"displayName":"Radim Kolar","active":true,"timeZone":"Europe/Prague"},"body":"There are 3 methods for implementing protection against OOM without need to acknowledge every message. Storm in ack mode has 10x lower throughput.\n\nSee end of http://docs.jboss.org/hornetq/2.2.5.Final/user-manual/en/html/queue-attributes.html#queue-attributes.address-settings\n\n1) use ring buffer for receiving messages. If messages are processed too slowly newly arriving message will replace older unprocessed message. This is not a flow control - just protection against OOM. (type DROP)\n\n2) implement flow control messages, something simple like XON/XOFF protocol (http://en.wikipedia.org/wiki/Software_flow_control) should suffice (type BLOCK)\n\n3) save messages to disk instead of throwing them away (type PAGE)\n\nfor inspiration see http://docs.jboss.org/hornetq/2.2.5.Final/user-manual/en/html/flow-control.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hsn","name":"hsn","key":"hsn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hsn&avatarId=11931","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hsn&avatarId=11931","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hsn&avatarId=11931","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hsn&avatarId=11931"},"displayName":"Radim Kolar","active":true,"timeZone":"Europe/Prague"},"created":"2014-07-04T15:39:27.818+0000","updated":"2014-07-04T15:39:27.818+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718534/comment/14053676","id":"14053676","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Gvain","name":"Gvain","key":"gvain","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jiahong Li","active":true,"timeZone":"Asia/Shanghai"},"body":"1)DROP is not a good way because if your components are not properly sized, there will be many dropped tuples and there is no good way to measure the max throughput  your topology can bear without significant dropping.\n2)BLOCK is not a good way either because it will cause potential dead loop problem in transport layer. It will cause the whole topology hang.\n3)PAGE is not a good way as it will continuous  increase latency and there is no good way to measure the max throughput your topology can bear with all tuples executed in reasonable latency.\n\nMaybe the best way is to implement a flow control mechanism like spout pending but much simple one.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Gvain","name":"Gvain","key":"gvain","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jiahong Li","active":true,"timeZone":"Asia/Shanghai"},"created":"2014-07-07T14:05:19.311+0000","updated":"2014-07-07T14:05:19.311+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718534/comment/14054120","id":"14054120","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"body":"DROP is what zeromq did by default and there has been some discussion about supporting that for netty as well.   Adding flow control to storm sounds like a reasonable solution.  \n\n[~hsn] I am curious where you got your 10x decrease in throughput numbers? All of my throughput testing I have done with acking enabled to avoid these types of issues.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=revans2","name":"revans2","key":"revans2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Joseph Evans","active":true,"timeZone":"America/Chicago"},"created":"2014-07-07T19:56:16.607+0000","updated":"2014-07-07T19:56:16.607+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718534/comment/14054268","id":"14054268","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hsn","name":"hsn","key":"hsn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hsn&avatarId=11931","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hsn&avatarId=11931","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hsn&avatarId=11931","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hsn&avatarId=11931"},"displayName":"Radim Kolar","active":true,"timeZone":"Europe/Prague"},"body":"I have 10k msg/sec throughput without ack, 100 per sec with ack, using different number of unconfirmed messages did not change anything. This made storm unusable for me and i am exploring different solution.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hsn","name":"hsn","key":"hsn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hsn&avatarId=11931","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hsn&avatarId=11931","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hsn&avatarId=11931","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hsn&avatarId=11931"},"displayName":"Radim Kolar","active":true,"timeZone":"Europe/Prague"},"created":"2014-07-07T22:59:02.552+0000","updated":"2014-07-07T22:59:02.552+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718534/comment/15036212","id":"15036212","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sotiris.matzanas%40gmail.com","name":"sotiris.matzanas@gmail.com","key":"sotiris.matzanas@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sotos Matzanas","active":true,"timeZone":"Etc/UTC"},"body":"We are hitting the same issue with Storm 0.10.0, heap balloons past our -Xmx4G setting very fast and eventually worker gets killed from an OOM Exception. Heap dump shows millions of byte[] arrays in Netty Server that correspond to our serialized tuples being passed around. Issue goes away as soon as we enable ackers but of course we pay the slow throughput penalty ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sotiris.matzanas%40gmail.com","name":"sotiris.matzanas@gmail.com","key":"sotiris.matzanas@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sotos Matzanas","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-02T17:35:04.012+0000","updated":"2015-12-02T17:35:04.012+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-339/votes","votes":4,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1wawv:"}}