{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13161061","self":"https://issues.apache.org/jira/rest/api/2/issue/13161061","key":"STORM-3081","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-05-22T15:27:31.359+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed May 23 20:02:16 UTC 2018","customfield_12312320":null,"customfield_12310222":null,"customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-3081/watchers","watchCount":2,"isWatching":false},"created":"2018-05-22T13:18:34.101+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12342766","id":"12342766","name":"1.2.1","archived":false,"released":true,"releaseDate":"2018-02-15"}],"customfield_12312339":null,"issuelinks":[],"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-06-25T01:19:57.339+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12331080","id":"12331080","name":"storm-kafka-client"}],"timeoriginalestimate":null,"description":"A single thread is pushing some messages to kafka serially and we consume it at the storm's end using storm-kafka-client.\r\nAfter a few requests, the consumer is not able to consume from the queue blocking the thread which waits for the response from storm's end. \r\nWe added one more consumer with a different consumer group and there the messages are getting read properly.\r\nSo we know there is some problem at the storm kafka client consumer's end.\r\nThe kafka spout config is written like this - \r\n\r\nKafkaSpoutConfig<String, String> kafkaSpoutConfig = KafkaSpoutConfig.builder(kafkaProperties.getProperty(\"bootstrap.servers\"), stormProperties.getProperty(\"TOPIC\"))\r\n                .setFirstPollOffsetStrategy(KafkaSpoutConfig.FirstPollOffsetStrategy.LATEST)\r\n                .setRecordTranslator(new MessageDeserializer(), arguments)\r\n                .build();\r\n\r\nI can't seem to figure out the issue.\r\nCan someone please help me out?\r\n\r\nThanks.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Storm kafka client not consuming messages properly","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kush.kh","name":"kush.kh","key":"kush.kh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34055","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"},"displayName":"Kush Khandelwal","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kush.kh","name":"kush.kh","key":"kush.kh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34055","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"},"displayName":"Kush Khandelwal","active":true,"timeZone":"Etc/UTC"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13161061/comment/16484142","id":"16484142","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Your configuration looks fine. Could you post some more details about your topology? e.g. do you have tuple failures when you look in Storm UI, does the spout consume properly if you just have it emit to a dummy bolt?\r\n\r\nI'd also recommend you try enabling debug logging for the org.apache.storm.kafka.spout package, it will likely help you figure out what's going on.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-05-22T15:27:31.359+0000","updated":"2018-05-22T15:27:31.359+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13161061/comment/16487330","id":"16487330","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kush.kh","name":"kush.kh","key":"kush.kh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34055","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"},"displayName":"Kush Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"The topology has 39 bolts.\r\nThere are no tuple failures in the UI.\r\nWe tried enabling debug logging, but there also we didn't see any abnormal behaviour as such. Its polling every 200 ms like it should and even when we push messages to kafka, it logs - \"Polled [0] records from Kafka.\".\r\nThe problem is not sequential. Even if a message is not consumed, some different message is unaffected by it. It gets consumed properly inspite of the last unconsumed message.\r\nSo somehow storm is missing a message and incrementing the offset.\r\nI changed the pollOffSet to Uncommitted_Earliest, but there was no change.\r\nCan u please tell us something more which can help out with the issue?\r\n\r\n\r\nAlso, how can I set TOPOLOGY_BACKPRESSURE_ENABLE as false for the kafkaSpout.\r\nI tried - \r\nKafkaSpoutConfig<String, String> kafkaSpoutConfig = KafkaSpoutConfig.builder(kafkaProperties.getProperty(\"bootstrap.servers\"), stormProperties.getProperty(\"TOPIC\"))\r\n                .setFirstPollOffsetStrategy(KafkaSpoutConfig.FirstPollOffsetStrategy.LATEST)\r\n                .setRecordTranslator(new MessageDeserializer(), arguments)\r\n                .setProp(Config.TOPOLOGY_BACKPRESSURE_ENABLE, false)\r\n                .build();\r\n\r\nIt didn't seem to work. \r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kush.kh","name":"kush.kh","key":"kush.kh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34055","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"},"displayName":"Kush Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2018-05-23T14:19:04.829+0000","updated":"2018-05-23T14:41:56.675+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13161061/comment/16487501","id":"16487501","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"The properties you pass to the KafkaSpoutConfig are the KafkaConsumer properties documented at https://kafka.apache.org/documentation/#newconsumerconfigs. The TOPOLOGY_BACKPRESSURE_ENABLE setting is a Storm parameter, so you should set it in your Storm config (you're likely creating a Config object when you create your topology).\r\n\r\n{quote}\r\nEven if a message is not consumed, some different message is unaffected by it. It gets consumed properly inspite of the last unconsumed message.\r\n{quote}\r\nI'm not sure I follow. Do you mean that if you put e.g. message \"a\" and \"b\" into partition 0, then \"b\" is emitted, but \"a\" isn't?\r\n\r\nAre you producing into Kafka with acks, so you're sure the message is actually written to Kafka?\r\n\r\nIn order to narrow it down to the spout, you might want to try running a KafkaConsumer manually and verify that it doesn't drop messages. Then try using a test topology where you have only the spout and a logging bolt, and check whether messages are dropped here.\r\n\r\nFinally, do the offsets that are skipped contain null values? The spout will skip these by default https://github.com/apache/storm/blob/v1.2.1/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpoutConfig.java#L655.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-05-23T15:45:06.984+0000","updated":"2018-05-23T15:45:06.984+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13161061/comment/16487878","id":"16487878","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kush.kh","name":"kush.kh","key":"kush.kh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34055","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"},"displayName":"Kush Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"We debugged it a little more and there are multiple situations we are facing randomly.\r\nThe spout randomly stops consuming messages from kafka.\r\n\r\nThe kafka spout config looks like this - \r\n\r\n KafkaSpoutConfig<String, String> kafkaSpoutConfig = KafkaSpoutConfig.builder(kafkaProperties.getProperty(\"bootstrap.servers\"), stormProperties.getProperty(\"TOPIC\"))\r\n                .setFirstPollOffsetStrategy(KafkaSpoutConfig.FirstPollOffsetStrategy.UNCOMMITTED_EARLIEST)\r\n                .setRecordTranslator(new MessageDeserializer(), new Fields(\"msg\"))\r\n                .setProcessingGuarantee(KafkaSpoutConfig.ProcessingGuarantee.NO_GUARANTEE)\r\n                .setProp(ConsumerConfig.GROUP_ID_CONFIG, \"message\")\r\n                .build();\r\n\r\n\r\n* There are times when the message is not consumed by the spout, but when we kill the topology and restart it, the messages which weren't consumed get \r\n   consumed automatically.\r\n* Sometimes, the same set of messages is getting consumed multiple times.\r\n* Sometimes, even after restarting the topology, the previous messages are not getting consumed at all.\r\n* There are also times, when if we keep the topology running, some/all (randomly) of the missed messages get processed.\r\n\r\nEither something related to committing the messages or getting the messages from the partition is screwing this up.\r\n\r\nI can't seem to figure out why this is happening so randomly.\r\n\r\nAnd how/where are the offsets stored ?\r\n\r\nCan u please tell something which would help in solving this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kush.kh","name":"kush.kh","key":"kush.kh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34055","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34055","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34055","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34055"},"displayName":"Kush Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2018-05-23T19:15:34.286+0000","updated":"2018-05-23T19:30:09.417+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13161061/comment/16487955","id":"16487955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Just to make it clear to me, how are you determining that a message was consumed or not? If you're not already doing it, please try to use the this log line to check what the spout emits [https://github.com/apache/storm/blob/d156d25d991311eaa1f5131d3dc34787f87ce684/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L488.]\r\n\r\n \r\n\r\nYour spout configuration uses the NO_GUARANTEE processing guarantee, which means messages may be processed 0, 1, or more times. If you need all messages to be processed, you shouldn't use this value. When the spout is configured to use this value, it will commit messages at arbitrary times once they've been emitted, which means you can lose messages if e.g. messages disappear on your network, or a transient error occurs. Use AT_LEAST_ONCE instead (and ensure acking is enabled in your topology), to guarantee that all messages are processed at least once. That way, if a message disappears or fails in the topology, it will be retried a configurable number of times.\r\n\r\n \r\n\r\nCommitted offsets are stored in the Kafka __consumer_offsets topic. You can check the committed offset via the kafka-consumer-groups.sh command in your Kafka install. The script may not work in earlier versions of Kafka, I believe someone else mentioned having to upgrade to Kafka 0.11 or 1.x to get it to work.\r\n\r\n \r\n\r\nSome of what you describe could be caused by the spout restarting, e.g. processing the same set of messages multiple times. Given that you're using NO_GUARANTEE, I'd only expect this if the spout worker was restarting though. I'm not sure what would be causing the rest of what you describe.\r\n\r\n \r\n\r\nHow large is your Kafka cluster? Which version are you using? Is the version you have installed as brokers the same version you are using for Storm?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-05-23T20:02:16.939+0000","updated":"2018-05-23T20:02:16.939+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-3081/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3tzzj:"}}