{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13162943","self":"https://issues.apache.org/jira/rest/api/2/issue/13162943","key":"STORM-3090","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":16200,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12343340","id":"12343340","name":"1.2.3","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343376","id":"12343376","name":"1.1.4","archived":false,"released":false}],"aggregatetimespent":16200,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-07-06T16:06:05.765+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jul 06 16:06:05 UTC 2018","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_3194555873_*|*_4_*:*_1_*:*_13519_*|*_5_*:*_2_*:*_277880321","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2018-07-09T21:17:39.579+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-3090/watchers","watchCount":1,"isWatching":false},"created":"2018-05-30T16:43:29.901+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":["pull-request-available"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335748","id":"12335748","name":"1.1.0","archived":false,"released":true,"releaseDate":"2017-03-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12339564","id":"12339564","name":"1.0.4","archived":false,"released":true,"releaseDate":"2017-07-28"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342807","id":"12342807","name":"1.2.2","archived":false,"released":true,"releaseDate":"2018-06-04"}],"customfield_12312339":null,"issuelinks":[{"id":"12536723","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12536723","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13035415","key":"STORM-2296","self":"https://issues.apache.org/jira/rest/api/2/issue/13035415","fields":{"summary":"Kafka spout - no duplicates on topic leader changes","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=choojoyq","name":"choojoyq","key":"choojoyq","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nikita Gorbachevski","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-07-09T21:18:06.656+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324393","id":"12324393","name":"storm-kafka","description":"Storm Kafka Integration"}],"timeoriginalestimate":null,"description":"In the current implementation of `ZkCoordinator` deleted partition managers are used as state holders for newly created partition managers. This behaviour was introduced in the scope of [this|https://issues-test.apache.org/jira/browse/STORM-2296] ticket. However existing lookup is based on only on partition number.\r\n{code:java}\r\nMap<Integer, PartitionManager> deletedManagers = new HashMap<>();\r\nfor (Partition id : deletedPartitions) {\r\n deletedManagers.put(id.partition, _managers.remove(id));\r\n}\r\nfor (PartitionManager manager : deletedManagers.values()) {\r\n if (manager != null) manager.close();\r\n}\r\nLOG.info(taskPrefix(_taskIndex, _totalTasks, _taskId) + \" New partition managers: \" + newPartitions.toString());\r\n\r\nfor (Partition id : newPartitions) {\r\n PartitionManager man = new PartitionManager(\r\n _connections,\r\n _topologyInstanceId,\r\n _state,\r\n _topoConf,\r\n _spoutConfig,\r\n id,\r\n deletedManagers.get(id.partition));\r\n _managers.put(id, man);\r\n{code}\r\nWhich is definitely incorrect as the same task is able to manage multiple partitions with the same number but for different topics. In this case all new partition managers obtain the same offset value from a random deleted partition manager (as `HashMap` is used). And all fetch requests for the new partition managers fail with `TopicOffsetOutOfRangeException`. Some of them are recovered via this logic if assigned offset is smaller than the real one, but other continue to repetitively fail with offset out of range exception preventing fetching messages from Kafka.\r\n{code:java}\r\nif (offset > _emittedToOffset) {\r\n _lostMessageCount.incrBy(offset - _emittedToOffset);\r\n _emittedToOffset = offset;\r\n LOG.warn(\"{} Using new offset: {}\", _partition, _emittedToOffset);\r\n}\r\n{code}\r\nI assume that state holder lookup should be based both on topic and partition number.","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"4.5h","remainingEstimateSeconds":0,"timeSpentSeconds":16200},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"The same offset value is used by the same partition number of different topics.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=choojoyq","name":"choojoyq","key":"choojoyq","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nikita Gorbachevski","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=choojoyq","name":"choojoyq","key":"choojoyq","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nikita Gorbachevski","active":true,"timeZone":"Etc/UTC"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":16200,"total":16200,"percent":100},"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":16200,"total":16200,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/comment/16535051","id":"16535051","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Thanks [~choojoyq], merged to 1.x-branch. It doesn't cherry-pick cleanly onto 1.1.x/1.0.x, so please raise a new PR if you'd like the fix to go in those versions.\r\n\r\nFor later reference, this is not merged to master, since we're planning to delete storm-kafka there.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2018-07-06T16:06:05.765+0000","updated":"2018-07-06T16:06:05.765+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-3090/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":28,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/113185","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user choojoyq opened a pull request:\n\n    https://github.com/apache/storm/pull/2726\n\n    STORM-3090 - Fix bug when different topics use the same offset for a partition\n\n    In the current implementation of `ZkCoordinator` deleted partition managers are used as state holders for newly created partition managers. This behavour was introduced in the scope of [this](https://issues-test.apache.org/jira/browse/STORM-2296) ticket. However existing lookup is based on only on partition number.\r\n    \r\n    ```\r\n    Map<Integer, PartitionManager> deletedManagers = new HashMap<>();\r\n    for (Partition id : deletedPartitions) {\r\n        deletedManagers.put(id.partition, _managers.remove(id));\r\n    }\r\n    for (PartitionManager manager : deletedManagers.values()) {\r\n        if (manager != null) manager.close();\r\n    }\r\n    LOG.info(taskPrefix(_taskIndex, _totalTasks, _taskId) + \" New partition managers: \" + newPartitions.toString());\r\n    \r\n    for (Partition id : newPartitions) {\r\n        PartitionManager man = new PartitionManager(\r\n            _connections,\r\n            _topologyInstanceId,\r\n            _state,\r\n            _topoConf,\r\n            _spoutConfig,\r\n            id,\r\n            deletedManagers.get(id.partition));\r\n        _managers.put(id, man);\r\n    ```\r\n    Which is definitely incorrect as the same task is able to manage multiple partitions with the same number but for different topics. In this case all new partition managers obtain the same offset value from a random deleted partition manager (as `HashMap` is used). And all fetch requests for the new partition managers fail with `TopicOffsetOutOfRangeException`. Some of them are recovered via this logic if assigned offset is smaller than the real one, but other continue to repetitively fail with offset out of range exception preventing fetching messages from Kafka.\r\n    ```\r\n    if (offset > _emittedToOffset) {\r\n        _lostMessageCount.incrBy(offset - _emittedToOffset);\r\n        _emittedToOffset = offset;\r\n        LOG.warn(\"{} Using new offset: {}\", _partition, _emittedToOffset);\r\n    }\r\n    ```\r\n    I assume that state holder lookup should be based both on topic and partition number.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/choojoyq/storm STORM-3090\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2726.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2726\n    \n----\ncommit 808e6be3edc7f83c80ad2ad4fb0a11091e81cc66\nAuthor: Nikita Gorbachevsky <nikitag@...>\nDate:   2018-06-19T14:02:28Z\n\n    STORM-3090 - use topic together with partition number during recreation of partition managers\n\n----\n","created":"2018-06-19T14:27:54.960+0000","updated":"2018-06-19T14:27:54.960+0000","started":"2018-06-19T14:27:54.960+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"113185","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/113336","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/2726\n  \n    @choojoyq\r\n    First of all, thanks for your contribution. We are deprecating storm-kafka from 1.x version and plan to remove this entirely in 2.0 (there're couple of pull requests to be reviewed before that, though). \r\n    \r\n    So you may need to submit this PR against 1.x-branch.\n","created":"2018-06-19T19:43:56.634+0000","updated":"2018-06-19T19:43:56.634+0000","started":"2018-06-19T19:43:56.633+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"113336","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/113662","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user choojoyq commented on the issue:\n\n    https://github.com/apache/storm/pull/2726\n  \n    @HeartSaVioR \r\n    Thanks for the fast reply. I pointed this pull request to 1.x-branch. \r\n    Does it make sense to open one more pull request for 1.0.x-branch as well?\n","created":"2018-06-20T10:34:20.067+0000","updated":"2018-06-20T10:34:20.067+0000","started":"2018-06-20T10:34:20.067+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"113662","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/113924","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/2726\n  \n    @choojoyq Let us port back first if it is OK to be merged.\n","created":"2018-06-20T20:37:06.250+0000","updated":"2018-06-20T20:37:06.250+0000","started":"2018-06-20T20:37:06.249+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"113924","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/114269","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user choojoyq commented on the issue:\n\n    https://github.com/apache/storm/pull/2726\n  \n    @HeartSaVioR Sure, thanks.\n","created":"2018-06-21T09:26:13.750+0000","updated":"2018-06-21T09:26:13.750+0000","started":"2018-06-21T09:26:13.750+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"114269","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119300","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user choojoyq commented on the issue:\n\n    https://github.com/apache/storm/pull/2726\n  \n    @HeartSaVioR \r\n    Hi, do you probably know release date of the next storm version where this pull request potentially will be merged? We are facing this issue pretty often in our cluster which requires restarting of storm topology with ``ignoreZkOffsets`` flag, so we consider temporary solution with releasing of our own version of ``storm-kafka`` module if the next official version will not be released soon. Thanks.\n","created":"2018-07-05T10:22:48.651+0000","updated":"2018-07-05T10:22:48.651+0000","started":"2018-07-05T10:22:48.650+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119300","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119538","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2726#discussion_r200456703\n  \n    --- Diff: external/storm-kafka/src/test/org/apache/storm/kafka/ZkCoordinatorTest.java ---\n    @@ -140,6 +140,42 @@ public void testPartitionManagerRecreate() throws Exception {\n             }\n         }\n     \n    +    @Test\n    +    public void testPartitionManagerRecreateMultipleTopics() throws Exception {\n    +        List<ZkCoordinator> coordinatorList = buildCoordinators(1);\n    +\n    +        when(reader.getBrokerInfo()).thenReturn(TestUtils.buildPartitionInfoList(\n    +            TestUtils.buildPartitionInfo(\"topic1\", 1, 9092),\n    +            TestUtils.buildPartitionInfo(\"topic2\", 1, 9092)));\n    +\n    +        List<PartitionManager> partitionManagersBeforeRefresh = coordinatorList.get(0).getMyManagedPartitions();\n    +        assertEquals(2, partitionManagersBeforeRefresh.size());\n    +        for (PartitionManager partitionManager : partitionManagersBeforeRefresh) {\n    +            partitionManager._emittedToOffset = 100L;\n    +            partitionManager._committedTo = 100L;\n    +        }\n    +\n    +        waitForRefresh();\n    +\n    +        when(reader.getBrokerInfo()).thenReturn(TestUtils.buildPartitionInfoList(\n    +            TestUtils.buildPartitionInfo(\"topic1\", 1, 9093),\n    +            TestUtils.buildPartitionInfo(\"topic3\", 1, 9093)));\n    --- End diff --\n    \n    Nit: Seems weird to exclude topic 2, that can't happen in a real setup. Shouldn't you be checking that topic1 and topic2 can't overwrite each others' offsets instead (e.g by making them different a few lines up)?\n","created":"2018-07-05T19:10:25.140+0000","updated":"2018-07-05T19:10:25.140+0000","started":"2018-07-05T19:10:25.140+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119538","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119539","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2726#discussion_r200456835\n  \n    --- Diff: external/storm-kafka/src/jvm/org/apache/storm/kafka/ZkCoordinator.java ---\n    @@ -107,14 +110,14 @@ public void refresh() {\n                             _stormConf,\n                             _spoutConfig,\n                             id,\n    -                        deletedManagers.get(id.partition));\n    +                        deletedManagers.get(new TopicAndPartition(id.topic, id.partition)));\n    --- End diff --\n    \n    Are you sure this lookup makes sense? The deletedManagers only contains partitions that this task is no longer responsible for (curr - mine). That partition shouldn't be able to also be in newPartitions (mine - curr). Won't this always return null (unless you're hitting the bug that this PR is trying to fix, namely that offsets are being copied from the PartitionManager for e.g. topic1 to the PartitionManager for topic2)?\n","created":"2018-07-05T19:10:25.161+0000","updated":"2018-07-05T19:10:25.161+0000","started":"2018-07-05T19:10:25.161+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119539","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119540","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2726\n  \n    The changes look good to me, +1. Left some comments, but I don't think it makes sense to put too much effort into making the tests more realistic, or refactoring, given that storm-kafka is being removed.\n","created":"2018-07-05T19:12:33.007+0000","updated":"2018-07-05T19:12:33.007+0000","started":"2018-07-05T19:12:33.007+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119540","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119836","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user choojoyq commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2726#discussion_r200651516\n  \n    --- Diff: external/storm-kafka/src/jvm/org/apache/storm/kafka/ZkCoordinator.java ---\n    @@ -107,14 +110,14 @@ public void refresh() {\n                             _stormConf,\n                             _spoutConfig,\n                             id,\n    -                        deletedManagers.get(id.partition));\n    +                        deletedManagers.get(new TopicAndPartition(id.topic, id.partition)));\n    --- End diff --\n    \n    I believe that this lookup exists for preserving information about partitions from other brokers in case of rebalancing. If for example one of brokers fail and its partitions are reassigned to other brokers this lookup should find information about this partition and reuse it during recreation of the same partition but on other host. ``equals()`` and ``hashCode()`` in Partition are based on topic, partition and host while this lookup in based only on topic and partition.\n","created":"2018-07-06T13:23:16.059+0000","updated":"2018-07-06T13:23:16.059+0000","started":"2018-07-06T13:23:16.059+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119836","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119838","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2726#discussion_r200653436\n  \n    --- Diff: external/storm-kafka/src/jvm/org/apache/storm/kafka/ZkCoordinator.java ---\n    @@ -107,14 +110,14 @@ public void refresh() {\n                             _stormConf,\n                             _spoutConfig,\n                             id,\n    -                        deletedManagers.get(id.partition));\n    +                        deletedManagers.get(new TopicAndPartition(id.topic, id.partition)));\n    --- End diff --\n    \n    Good point, never mind then.\n","created":"2018-07-06T13:30:24.819+0000","updated":"2018-07-06T13:30:24.819+0000","started":"2018-07-06T13:30:24.819+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119838","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119840","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user choojoyq commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2726#discussion_r200655178\n  \n    --- Diff: external/storm-kafka/src/test/org/apache/storm/kafka/ZkCoordinatorTest.java ---\n    @@ -140,6 +140,42 @@ public void testPartitionManagerRecreate() throws Exception {\n             }\n         }\n     \n    +    @Test\n    +    public void testPartitionManagerRecreateMultipleTopics() throws Exception {\n    +        List<ZkCoordinator> coordinatorList = buildCoordinators(1);\n    +\n    +        when(reader.getBrokerInfo()).thenReturn(TestUtils.buildPartitionInfoList(\n    +            TestUtils.buildPartitionInfo(\"topic1\", 1, 9092),\n    +            TestUtils.buildPartitionInfo(\"topic2\", 1, 9092)));\n    +\n    +        List<PartitionManager> partitionManagersBeforeRefresh = coordinatorList.get(0).getMyManagedPartitions();\n    +        assertEquals(2, partitionManagersBeforeRefresh.size());\n    +        for (PartitionManager partitionManager : partitionManagersBeforeRefresh) {\n    +            partitionManager._emittedToOffset = 100L;\n    +            partitionManager._committedTo = 100L;\n    +        }\n    +\n    +        waitForRefresh();\n    +\n    +        when(reader.getBrokerInfo()).thenReturn(TestUtils.buildPartitionInfoList(\n    +            TestUtils.buildPartitionInfo(\"topic1\", 1, 9093),\n    +            TestUtils.buildPartitionInfo(\"topic3\", 1, 9093)));\n    --- End diff --\n    \n    The idea of the test that before rebalancing some ``Task`` was responsible for 2 partitions from topics 1 and 2 from broker 9092, but after rebalancing of Kafka brokers it became responsible for the same partition for topic 1 and another partition from topic 3 which are hosted now on broker 9093. So ``Task`` should preserve partition information about topic1 as it was managed by this task before and it knows how many messages was already emitted, committed, etc. While partition from topic3 is a brand new and so it should be created from scratch without reusing of any information. Before the fix information for topic3 would be reused from topic1 as lookup of previously managed partitions was performed only on partition number ignoring topic.\n","created":"2018-07-06T13:36:25.455+0000","updated":"2018-07-06T13:36:25.455+0000","started":"2018-07-06T13:36:25.455+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119840","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119845","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2726#discussion_r200657323\n  \n    --- Diff: external/storm-kafka/src/test/org/apache/storm/kafka/ZkCoordinatorTest.java ---\n    @@ -140,6 +140,42 @@ public void testPartitionManagerRecreate() throws Exception {\n             }\n         }\n     \n    +    @Test\n    +    public void testPartitionManagerRecreateMultipleTopics() throws Exception {\n    +        List<ZkCoordinator> coordinatorList = buildCoordinators(1);\n    +\n    +        when(reader.getBrokerInfo()).thenReturn(TestUtils.buildPartitionInfoList(\n    +            TestUtils.buildPartitionInfo(\"topic1\", 1, 9092),\n    +            TestUtils.buildPartitionInfo(\"topic2\", 1, 9092)));\n    +\n    +        List<PartitionManager> partitionManagersBeforeRefresh = coordinatorList.get(0).getMyManagedPartitions();\n    +        assertEquals(2, partitionManagersBeforeRefresh.size());\n    +        for (PartitionManager partitionManager : partitionManagersBeforeRefresh) {\n    +            partitionManager._emittedToOffset = 100L;\n    +            partitionManager._committedTo = 100L;\n    +        }\n    +\n    +        waitForRefresh();\n    +\n    +        when(reader.getBrokerInfo()).thenReturn(TestUtils.buildPartitionInfoList(\n    +            TestUtils.buildPartitionInfo(\"topic1\", 1, 9093),\n    +            TestUtils.buildPartitionInfo(\"topic3\", 1, 9093)));\n    --- End diff --\n    \n    Thanks, it makes sense. Since there's only one task, topic 2 can't be removed though. It's not really important, the test makes sense regardless.\n","created":"2018-07-06T13:43:54.099+0000","updated":"2018-07-06T13:43:54.099+0000","started":"2018-07-06T13:43:54.098+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119845","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119846","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2726\n  \n    Is this ready to merge @choojoyq?\n","created":"2018-07-06T13:44:29.379+0000","updated":"2018-07-06T13:44:29.379+0000","started":"2018-07-06T13:44:29.378+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119846","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119858","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user choojoyq commented on the issue:\n\n    https://github.com/apache/storm/pull/2726\n  \n    @srdo i think so, thanks for the review\n","created":"2018-07-06T14:31:22.013+0000","updated":"2018-07-06T14:31:22.013+0000","started":"2018-07-06T14:31:22.013+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119858","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/119891","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/storm/pull/2726\n","created":"2018-07-06T16:03:51.018+0000","updated":"2018-07-06T16:03:51.018+0000","started":"2018-07-06T16:03:51.018+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119891","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/120208","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user choojoyq opened a pull request:\n\n    https://github.com/apache/storm/pull/2756\n\n    STORM-3090 - Fix bug when different topics use the same offset for a partition\n\n    This pull request contains the same changes from https://github.com/apache/storm/pull/2726 that was merged in 1.x branch. As there are some conflicts during cherry-picking of these changes into 1.0.x/1.1.x branch this pull request is created.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/choojoyq/storm STORM-3090\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2756.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2756\n    \n----\ncommit 2bebe35cd15cd814db1b1587add60a056a00672b\nAuthor: Nikita Gorbachevsky <nikitag@...>\nDate:   2018-07-06T17:32:50Z\n\n    STORM-3090 - use topic together with partition number during recreation of partition managers\n\n----\n","created":"2018-07-07T09:17:27.862+0000","updated":"2018-07-07T09:17:27.862+0000","started":"2018-07-07T09:17:27.862+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"120208","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/120257","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2756#discussion_r200818671\n  \n    --- Diff: external/storm-kafka/src/jvm/org/apache/storm/kafka/ZkCoordinator.java ---\n    @@ -80,22 +81,24 @@ public void refresh() {\n                 List<Partition> mine = KafkaUtils.calculatePartitionsForTask(brokerInfo, _totalTasks, _taskIndex);\n     \n                 Set<Partition> curr = _managers.keySet();\n    -            Set<Partition> newPartitions = new HashSet<Partition>(mine);\n    +            Set<Partition> newPartitions = new HashSet<>(mine);\n                 newPartitions.removeAll(curr);\n     \n    -            Set<Partition> deletedPartitions = new HashSet<Partition>(curr);\n    +            Set<Partition> deletedPartitions = new HashSet<>(curr);\n                 deletedPartitions.removeAll(mine);\n     \n    -            LOG.info(taskId(_taskIndex, _totalTasks) + \"Deleted partition managers: \" + deletedPartitions.toString());\n    +            LOG.info(\"{}Deleted partition managers: {}\",\n    --- End diff --\n    \n    Missing space\n","created":"2018-07-07T18:04:56.976+0000","updated":"2018-07-07T18:04:56.976+0000","started":"2018-07-07T18:04:56.976+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"120257","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/120258","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2756#discussion_r200818673\n  \n    --- Diff: external/storm-kafka/src/jvm/org/apache/storm/kafka/ZkCoordinator.java ---\n    @@ -80,22 +81,24 @@ public void refresh() {\n                 List<Partition> mine = KafkaUtils.calculatePartitionsForTask(brokerInfo, _totalTasks, _taskIndex);\n     \n                 Set<Partition> curr = _managers.keySet();\n    -            Set<Partition> newPartitions = new HashSet<Partition>(mine);\n    +            Set<Partition> newPartitions = new HashSet<>(mine);\n                 newPartitions.removeAll(curr);\n     \n    -            Set<Partition> deletedPartitions = new HashSet<Partition>(curr);\n    +            Set<Partition> deletedPartitions = new HashSet<>(curr);\n                 deletedPartitions.removeAll(mine);\n     \n    -            LOG.info(taskId(_taskIndex, _totalTasks) + \"Deleted partition managers: \" + deletedPartitions.toString());\n    +            LOG.info(\"{}Deleted partition managers: {}\",\n    +                taskId(_taskIndex, _totalTasks), deletedPartitions);\n     \n    -            Map<Integer, PartitionManager> deletedManagers = new HashMap<>();\n    +            Map<TopicAndPartition, PartitionManager> deletedManagers = new HashMap<>();\n                 for (Partition id : deletedPartitions) {\n    -                deletedManagers.put(id.partition, _managers.remove(id));\n    +                PartitionManager manager = _managers.remove(id);\n    +                manager.close();\n    +                deletedManagers.put(new TopicAndPartition(id.topic, id.partition), manager);\n                 }\n    -            for (PartitionManager manager : deletedManagers.values()) {\n    -                if (manager != null) manager.close();\n    -            }\n    -            LOG.info(taskId(_taskIndex, _totalTasks) + \"New partition managers: \" + newPartitions.toString());\n    +\n    +            LOG.info(\"{}New partition managers: {}\",\n    --- End diff --\n    \n    Missing space\n","created":"2018-07-07T18:04:56.977+0000","updated":"2018-07-07T18:04:56.977+0000","started":"2018-07-07T18:04:56.977+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"120258","issueId":"13162943"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162943/worklog/120682","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on the issue:\n\n    https://github.com/apache/storm/pull/2756\n  \n    Could you please point this to at least 1.1.x-branch? We are trying to maintain 3 version lines and due to this, 1.0.x version is no longer supported.\n","created":"2018-07-09T09:05:36.692+0000","updated":"2018-07-09T09:05:36.692+0000","started":"2018-07-09T09:05:36.691+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"120682","issueId":"13162943"}]},"customfield_12311820":"0|i3ubkf:"}}