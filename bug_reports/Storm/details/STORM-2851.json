{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13123997","self":"https://issues.apache.org/jira/rest/api/2/issue/13123997","key":"STORM-2851","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":15600,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341047","id":"12341047","name":"1.2.0","archived":false,"released":true,"releaseDate":"2018-02-15"}],"aggregatetimespent":15600,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-12-10T17:24:36.088+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sun Dec 10 17:24:36 UTC 2017","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_10858702_*|*_3_*:*_1_*:*_486801337_*|*_5_*:*_1_*:*_0","customfield_12310420":"9223372036854775807","customfield_12312321":null,"resolutiondate":"2017-12-16T08:38:02.740+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2851/watchers","watchCount":2,"isWatching":false},"created":"2017-12-10T14:23:42.819+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["pull-request-available"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":"STORM-2710","customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334657","id":"12334657","name":"2.0.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341047","id":"12341047","name":"1.2.0","archived":false,"released":true,"releaseDate":"2018-02-15"}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-12-16T08:38:09.880+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12331080","id":"12331080","name":"storm-kafka-client"}],"timeoriginalestimate":null,"description":"Hello,\r\n\r\nWe have been running Storm 1.2.0 preview on our pre-production supervision system.\r\nWe noticed that in the logs of our topology to logs persistency in Hbase, we got the following exceptions (about 4 times in a 48 hours period):\r\n\r\njava.util.ConcurrentModificationException at java.util.HashMap$HashIterator.nextNode(HashMap.java:1442) \r\nat java.util.HashMap$KeyIterator.next(HashMap.java:1466) \r\nat org.apache.storm.kafka.spout.KafkaSpout.doSeekRetriableTopicPartitions(KafkaSpout.java:347) \r\nat org.apache.storm.kafka.spout.KafkaSpout.pollKafkaBroker(KafkaSpout.java:320) \r\nat org.apache.storm.kafka.spout.KafkaSpout.nextTuple(KafkaSpout.java:245) \r\nat org.apache.storm.daemon.executor$fn__4963$fn__4978$fn__5009.invoke(executor.clj:647) \r\nat org.apache.storm.util$async_loop$fn__557.invoke(util.clj:484) \r\nat clojure.lang.AFn.run(AFn.java:22) \r\nat java.lang.Thread.run(Thread.java:748) \r\n\r\nIt looks like there's something to fix here, such as making the map thread-safe, or managing the exclusivity of modification of this map at a caller level.\r\n\r\nNote: this topology is using Storm Kafka Client spout with default properties (unlike other topologies we have based on autocommit). However, it's the one which deals with highest rate of messages (line of logs coming from about 10000 VMs, a nice scale test for Storm :))\r\n\r\nCould it be fixed in Storm 1.2.0 final version?\r\n\r\nBest regards,\r\nAlexandre Vermeerbergen\r\n","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"4h 20m","remainingEstimateSeconds":0,"timeSpentSeconds":15600},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"org.apache.storm.kafka.spout.KafkaSpout.doSeekRetriableTopicPartitions sometimes throws ConcurrentModificationException","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=avermeerbergen","name":"avermeerbergen","key":"avermeerbergen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexandre Vermeerbergen","active":true,"timeZone":"Europe/Paris"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=avermeerbergen","name":"avermeerbergen","key":"avermeerbergen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexandre Vermeerbergen","active":true,"timeZone":"Europe/Paris"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":15600,"total":15600,"percent":100},"environment":"Using Storm 1.2.0 preview binaries shared by Stig Rohde Døssing & Jungtaek Lim through the \"[Discuss] Release Storm 1.2.0\" discussion is Storm Developer's mailing list\r\n\r\nWith one Nimbus Vm, 6 Supervisor VMs, 3 Zookeeper VMs, 15 topologies, talking with a 5 VMs Kafka Brokers set (based on Kafka 0.10.2), all with ORACLE Server JRE 8 update 152.\r\n\r\nAbout 15 topologies, handling around 1 million Kafka messages per minute, and connected to Redis, OpenTSDB & HBase.","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":15600,"total":15600,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/comment/16285328","id":"16285328","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"body":"Sorry, I'll fix this. It's a very obvious wrong use of Map.remove while iterating over the same Map here https://github.com/apache/storm/blob/master/external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java#L336, I must have been asleep at the wheel when this was added.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Srdo","name":"Srdo","key":"srdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stig Rohde Døssing","active":true,"timeZone":"Europe/Copenhagen"},"created":"2017-12-10T17:24:36.088+0000","updated":"2017-12-10T17:24:36.088+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-2851/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":28,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user srdo opened a pull request:\n\n    https://github.com/apache/storm/pull/2453\n\n    STORM-2851: Fix ConcurrentModificationException in doSeekRetriablePar…\n\n    …titions\r\n    \r\n    See https://issues.apache.org/jira/browse/STORM-2851.\r\n    \r\n    The bug is caused by the call to `retriableTopicPartitions.remove(tp)` in doSeekRetriablePartitions. Rather than just rewriting it to use an iterator I thought it was better to get rid of the loop. It was meant to ensure that we didn't seek the consumer on partitions that would be paused in the current call to nextTuple. I've moved this filtering into PollingInfo, and have made poll() return it. This also allows us to only get earliestRetriableOffsets once for the call to nextTuple, rather than once in poll and once in doSeek.\r\n    \r\n    The added test is not related to the fix, it just adds more verification that the maxUncommittedOffsets limit is enforced.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/srdo/storm STORM-2851\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/storm/pull/2453.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #2453\n    \n----\ncommit 8086605ee727ccbd0e2230238f3415786e83df58\nAuthor: Stig Rohde Døssing <srdo@apache.org>\nDate:   2017-12-10T18:22:14Z\n\n    STORM-2851: Fix ConcurrentModificationException in doSeekRetriablePartitions\n\n----\n","created":"2017-12-10T19:39:38.460+0000","updated":"2017-12-10T19:39:38.460+0000","started":"2017-12-10T19:39:38.457+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60616","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60646","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user HeartSaVioR commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156013674\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -625,4 +619,15 @@ public String toString() {\n         private String getTopicsString() {\n             return kafkaSpoutConfig.getSubscription().getTopicsString();\n         }\n    +    \n    +    private static class PollingInfo {\n    +        private final Set<TopicPartition> pollablePartitions;\n    +        private final Map<TopicPartition, Long> pollableEarliestRetriableOffsets;\n    +        \n    +        public PollingInfo(Set<TopicPartition> pollablePartitions, Map<TopicPartition, Long> earliestRetriableOffsets) {\n    +            this.pollablePartitions = pollablePartitions;\n    +            earliestRetriableOffsets.keySet().removeIf(tp -> !pollablePartitions.contains(tp));\n    --- End diff --\n    \n    minor: might be better to copy the map first, and remove the elements to avoid side-effect to the parameter.\n","created":"2017-12-11T09:06:22.191+0000","updated":"2017-12-11T09:06:22.191+0000","started":"2017-12-11T09:06:22.191+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60646","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60805","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2453\n  \n    @HeartSaVioR Thanks, I agree about the map copy. I've made the change you suggested, and also very slightly expanded a test to check that we only seek on partitions that are both pollable and retriable when retrying tuples.\r\n    \r\n    I'll squash before merging if it looks good to you. \n","created":"2017-12-12T18:05:31.546+0000","updated":"2017-12-12T18:05:31.546+0000","started":"2017-12-12T18:05:31.545+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60805","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60808","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156234691\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -625,4 +619,15 @@ public String toString() {\n         private String getTopicsString() {\n             return kafkaSpoutConfig.getSubscription().getTopicsString();\n         }\n    +    \n    +    private static class PollingInfo {\n    --- End diff --\n    \n    I would rename it to **PollInfo** and I would add the following method\r\n    \r\n    ```java\r\n    boolean isPollable() { return pollablePartitions.isEmpty(); }\r\n    ```\n","created":"2017-12-12T18:15:41.232+0000","updated":"2017-12-12T18:15:41.232+0000","started":"2017-12-12T18:15:41.231+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60808","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60809","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156234755\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -625,4 +619,15 @@ public String toString() {\n         private String getTopicsString() {\n             return kafkaSpoutConfig.getSubscription().getTopicsString();\n         }\n    +    \n    +    private static class PollingInfo {\n    +        private final Set<TopicPartition> pollablePartitions;\n    +        private final Map<TopicPartition, Long> pollableEarliestRetriableOffsets;\n    --- End diff --\n    \n    tpEarliestRetriableOffsets; ?\n","created":"2017-12-12T18:15:41.247+0000","updated":"2017-12-12T18:15:41.247+0000","started":"2017-12-12T18:15:41.246+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60809","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60810","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156450849\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -625,4 +619,15 @@ public String toString() {\n         private String getTopicsString() {\n             return kafkaSpoutConfig.getSubscription().getTopicsString();\n         }\n    +    \n    +    private static class PollingInfo {\n    +        private final Set<TopicPartition> pollablePartitions;\n    +        private final Map<TopicPartition, Long> pollableEarliestRetriableOffsets;\n    +        \n    +        public PollingInfo(Set<TopicPartition> pollablePartitions, Map<TopicPartition, Long> earliestRetriableOffsets) {\n    +            this.pollablePartitions = pollablePartitions;\n    +            earliestRetriableOffsets.keySet().removeIf(tp -> !pollablePartitions.contains(tp));\n    --- End diff --\n    \n    agree\n","created":"2017-12-12T18:15:41.281+0000","updated":"2017-12-12T18:15:41.281+0000","started":"2017-12-12T18:15:41.280+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60810","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60812","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156455782\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -625,4 +619,15 @@ public String toString() {\n         private String getTopicsString() {\n             return kafkaSpoutConfig.getSubscription().getTopicsString();\n         }\n    +    \n    +    private static class PollingInfo {\n    +        private final Set<TopicPartition> pollablePartitions;\n    +        private final Map<TopicPartition, Long> pollableEarliestRetriableOffsets;\n    --- End diff --\n    \n    OK, the name is fine after understanding it better. Can you put a line comment saying what is in this var. Thanks.\n","created":"2017-12-12T18:33:41.936+0000","updated":"2017-12-12T18:33:41.936+0000","started":"2017-12-12T18:33:41.934+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60812","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60822","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2453\n  \n    @hmcl Thanks, made most of the changes you mentioned. I thought PollInfo was a little vague, how about PollablePartitionInfo?\r\n    \r\n    Also the tests are failing for some reason, give me a minute.\n","created":"2017-12-12T19:23:08.758+0000","updated":"2017-12-12T19:23:08.758+0000","started":"2017-12-12T19:23:08.756+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60822","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2453\n  \n    Fixed, sorry.\n","created":"2017-12-12T19:26:30.178+0000","updated":"2017-12-12T19:26:30.178+0000","started":"2017-12-12T19:26:30.177+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60823","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60830","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156496925\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -257,23 +258,24 @@ private void throwKafkaConsumerInterruptedException() {\n             throw new RuntimeException(new InterruptedException(\"Kafka consumer was interrupted\"));\n         }\n     \n    -    private boolean commit() {\n    +    private boolean isCommitAllowed() {\n             return isAtLeastOnceProcessing() && commitTimer.isExpiredResetOnTrue();    // timer != null for non auto commit mode\n         }\n    -\n    -    private Set<TopicPartition> poll() {\n    -        final int maxUncommittedOffsets = kafkaSpoutConfig.getMaxUncommittedOffsets();\n    -\n    +    \n    +    private PollablePartitionInfo getPollablePartitionInfo() {\n    --- End diff --\n    \n    getPollablePartitions\n","created":"2017-12-12T21:36:53.078+0000","updated":"2017-12-12T21:36:53.078+0000","started":"2017-12-12T21:36:53.077+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60830","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60831","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156499862\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -625,4 +620,21 @@ public String toString() {\n         private String getTopicsString() {\n             return kafkaSpoutConfig.getSubscription().getTopicsString();\n         }\n    +    \n    +    private static class PollablePartitionInfo {\n    +        private final Set<TopicPartition> pollablePartitions;\n    +        //The subset of earliest retriable offsets that are on pollable partitions\n    +        private final Map<TopicPartition, Long> pollableEarliestRetriableOffsets;\n    +        \n    +        public PollablePartitionInfo(Set<TopicPartition> pollablePartitions, Map<TopicPartition, Long> earliestRetriableOffsets) {\n    +            this.pollablePartitions = pollablePartitions;\n    +            this.pollableEarliestRetriableOffsets = earliestRetriableOffsets.entrySet().stream()\n    +                .filter(entry -> pollablePartitions.contains(entry.getKey()))\n    +                .collect(Collectors.toMap(entry -> entry.getKey(), entry -> entry.getValue()));\n    +        }\n    +        \n    +        public boolean isPollAllowed() {\n    --- End diff --\n    \n    why not simply `isEmpty()` ? \r\n    \r\n    I really don't thing that _allowed_ is a very suitable name here because we are not checking for permissions or anything like that. If it is in the pollable set it is always allowed.\n","created":"2017-12-12T21:36:53.079+0000","updated":"2017-12-12T21:36:53.079+0000","started":"2017-12-12T21:36:53.078+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60831","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60832","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156470144\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -230,14 +230,14 @@ public void nextTuple() {\n                         kafkaSpoutConfig.getSubscription().refreshAssignment();\n                     }\n     \n    -                if (commit()) {\n    +                if (isCommitAllowed()) {\n    --- End diff --\n    \n    I guess you say allowed because of `isAtLeastOnceProcessing() && ...` ?\r\n    \r\n    Other ideas would be\r\n    isReadyToCommit / isCommitReady / isCommittable ?\r\n     \r\n    Because for atLeastOnceProcessing() the commits are always allowed if ready, right?\n","created":"2017-12-12T21:36:53.188+0000","updated":"2017-12-12T21:36:53.188+0000","started":"2017-12-12T21:36:53.186+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60832","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60834","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156508668\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -230,14 +230,14 @@ public void nextTuple() {\n                         kafkaSpoutConfig.getSubscription().refreshAssignment();\n                     }\n     \n    -                if (commit()) {\n    +                if (isCommitAllowed()) {\n    --- End diff --\n    \n    How about shouldCommit()?\n","created":"2017-12-12T22:02:03.494+0000","updated":"2017-12-12T22:02:03.494+0000","started":"2017-12-12T22:02:03.492+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60834","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60835","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156508850\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -625,4 +620,21 @@ public String toString() {\n         private String getTopicsString() {\n             return kafkaSpoutConfig.getSubscription().getTopicsString();\n         }\n    +    \n    +    private static class PollablePartitionInfo {\n    +        private final Set<TopicPartition> pollablePartitions;\n    +        //The subset of earliest retriable offsets that are on pollable partitions\n    +        private final Map<TopicPartition, Long> pollableEarliestRetriableOffsets;\n    +        \n    +        public PollablePartitionInfo(Set<TopicPartition> pollablePartitions, Map<TopicPartition, Long> earliestRetriableOffsets) {\n    +            this.pollablePartitions = pollablePartitions;\n    +            this.pollableEarliestRetriableOffsets = earliestRetriableOffsets.entrySet().stream()\n    +                .filter(entry -> pollablePartitions.contains(entry.getKey()))\n    +                .collect(Collectors.toMap(entry -> entry.getKey(), entry -> entry.getValue()));\n    +        }\n    +        \n    +        public boolean isPollAllowed() {\n    --- End diff --\n    \n    I agree that allowed can be misunderstood. I'd prefer not calling it isEmpty, since this isn't a collection and it's not obvious which internal collection it would be referring to. How about shouldPoll?\n","created":"2017-12-12T22:02:54.721+0000","updated":"2017-12-12T22:02:54.721+0000","started":"2017-12-12T22:02:54.719+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60835","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60836","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156508891\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -257,23 +258,24 @@ private void throwKafkaConsumerInterruptedException() {\n             throw new RuntimeException(new InterruptedException(\"Kafka consumer was interrupted\"));\n         }\n     \n    -    private boolean commit() {\n    +    private boolean isCommitAllowed() {\n             return isAtLeastOnceProcessing() && commitTimer.isExpiredResetOnTrue();    // timer != null for non auto commit mode\n         }\n    -\n    -    private Set<TopicPartition> poll() {\n    -        final int maxUncommittedOffsets = kafkaSpoutConfig.getMaxUncommittedOffsets();\n    -\n    +    \n    +    private PollablePartitionInfo getPollablePartitionInfo() {\n    --- End diff --\n    \n    Will rename\n","created":"2017-12-12T22:03:04.047+0000","updated":"2017-12-12T22:03:04.047+0000","started":"2017-12-12T22:03:04.046+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60836","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60838","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156518312\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -230,14 +230,14 @@ public void nextTuple() {\n                         kafkaSpoutConfig.getSubscription().refreshAssignment();\n                     }\n     \n    -                if (commit()) {\n    +                if (isCommitAllowed()) {\n    --- End diff --\n    \n    That would work. However, I would say that most conventions suggest that booleans methods should be of the for isPredicate. Of course there are variants such as hasPredicate, shouldPredicate, mustPredicate. \r\n    \r\n    When I suggested is* names above was with the intent of saying exactly should commit, but starting with is. Up to you what to pick, and I am +1 after that.\n","created":"2017-12-12T22:46:37.390+0000","updated":"2017-12-12T22:46:37.390+0000","started":"2017-12-12T22:46:37.389+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60838","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60839","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on a diff in the pull request:\n\n    https://github.com/apache/storm/pull/2453#discussion_r156519020\n  \n    --- Diff: external/storm-kafka-client/src/main/java/org/apache/storm/kafka/spout/KafkaSpout.java ---\n    @@ -625,4 +620,21 @@ public String toString() {\n         private String getTopicsString() {\n             return kafkaSpoutConfig.getSubscription().getTopicsString();\n         }\n    +    \n    +    private static class PollablePartitionInfo {\n    +        private final Set<TopicPartition> pollablePartitions;\n    +        //The subset of earliest retriable offsets that are on pollable partitions\n    +        private final Map<TopicPartition, Long> pollableEarliestRetriableOffsets;\n    +        \n    +        public PollablePartitionInfo(Set<TopicPartition> pollablePartitions, Map<TopicPartition, Long> earliestRetriableOffsets) {\n    +            this.pollablePartitions = pollablePartitions;\n    +            this.pollableEarliestRetriableOffsets = earliestRetriableOffsets.entrySet().stream()\n    +                .filter(entry -> pollablePartitions.contains(entry.getKey()))\n    +                .collect(Collectors.toMap(entry -> entry.getKey(), entry -> entry.getValue()));\n    +        }\n    +        \n    +        public boolean isPollAllowed() {\n    --- End diff --\n    \n    Building on the comment above, I would still call it something along the lines `isReadyToPoll()` or `isPollableRetryReady`, because that's what it is, a retry that is ready to poll. However, it's up to you and I am +1 after this.\n","created":"2017-12-12T22:50:16.680+0000","updated":"2017-12-12T22:50:16.680+0000","started":"2017-12-12T22:50:16.679+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60839","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/60908","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2453\n  \n    Updated with renames. I went with should* because I think the is* convention gets a little awkward here. \n","created":"2017-12-13T08:19:06.054+0000","updated":"2017-12-13T08:19:06.054+0000","started":"2017-12-13T08:19:06.054+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"60908","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/61011","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hmcl commented on the issue:\n\n    https://github.com/apache/storm/pull/2453\n  \n    +1. Can you please squash such that I can merge it in. Thanks.\n","created":"2017-12-13T15:28:32.942+0000","updated":"2017-12-13T15:28:32.942+0000","started":"2017-12-13T15:28:32.936+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61011","issueId":"13123997"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13123997/worklog/61014","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user srdo commented on the issue:\n\n    https://github.com/apache/storm/pull/2453\n  \n    Squashed. I'll merge it in a few minutes, and put up a 1.x version soon.\n","created":"2017-12-13T15:33:34.722+0000","updated":"2017-12-13T15:33:34.722+0000","started":"2017-12-13T15:33:34.720+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"61014","issueId":"13123997"}]},"customfield_12311820":"0|i3nqpj:"}}