{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12710998","self":"https://issues.apache.org/jira/rest/api/2/issue/12710998","key":"STORM-303","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12314820","id":"12314820","key":"STORM","name":"Apache Storm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12314820&avatarId=21667","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12314820&avatarId=21667","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12314820&avatarId=21667","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12314820&avatarId=21667"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/13260","id":"13260","description":"Apache Storm Related","name":"Storm"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326452","id":"12326452","name":"0.9.2-incubating","archived":false,"released":true,"releaseDate":"2014-06-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-05-06T15:15:18.013+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue May 20 18:59:03 UTC 2014","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1898802142_*|*_5_*:*_1_*:*_0","customfield_12310420":"389319","customfield_12312321":null,"resolutiondate":"2014-05-20T18:59:29.975+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-303/watchers","watchCount":3,"isWatching":false},"created":"2014-04-28T19:32:47.864+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326452","id":"12326452","name":"0.9.2-incubating","archived":false,"released":true,"releaseDate":"2014-06-25"}],"customfield_12312339":null,"issuelinks":[],"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brenden","name":"brenden","key":"brenden","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brenden Matthews","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-09-26T02:42:37.970+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324393","id":"12324393","name":"storm-kafka","description":"Storm Kafka Integration"}],"timeoriginalestimate":null,"description":"This is a placeholder issue for the patch at https://github.com/apache/incubator-storm/pull/94.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"attachment":[],"customfield_12312340":null,"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"389565","customfield_12312823":null,"summary":"Forward port of storm-kafka work","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brenden","name":"brenden","key":"brenden","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brenden Matthews","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[{"id":"12714160","key":"STORM-318","self":"https://issues.apache.org/jira/rest/api/2/issue/12714160","fields":{"summary":"storm-kafka curator.version fix","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brenden","name":"brenden","key":"brenden","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brenden Matthews","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310291":null,"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"environment":"linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13990731","id":"13990731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user revans2 commented on a diff in the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#discussion_r12329583\n  \n    --- Diff: external/storm-kafka/src/jvm/storm/kafka/DynamicBrokersReader.java ---\n    @@ -75,6 +74,8 @@ public GlobalPartitionInformation getBrokerInfo() {\n                         LOG.error(\"Node {} does not exist \", path);\n                     }\n                 }\n    +\t\t\t\t} catch(java.net.SocketTimeoutException e) {\n    --- End diff --\n    \n    The indentation seems to be off here.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-06T15:15:18.013+0000","updated":"2014-05-06T15:15:18.013+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13990732","id":"13990732","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user revans2 commented on a diff in the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#discussion_r12329609\n  \n    --- Diff: external/storm-kafka/src/jvm/storm/kafka/DynamicBrokersReader.java ---\n    @@ -52,15 +51,15 @@ public DynamicBrokersReader(Map conf, String zkStr, String zkPath, String topic)\n                                 Utils.getInt(conf.get(Config.STORM_ZOOKEEPER_RETRY_INTERVAL))));\n                 _curator.start();\n             } catch (Exception ex) {\n    -            LOG.error(\"can't connect to zookeeper\");\n    +            LOG.error(\"Couldn't connect to zookeeper\", ex);\n             }\n         }\n     \n         /**\n          * Get all partitions with their current leaders\n          */\n    -    public GlobalPartitionInformation getBrokerInfo() {\n    -        GlobalPartitionInformation globalPartitionInformation = new GlobalPartitionInformation();\n    +    public GlobalPartitionInformation getBrokerInfo() throws java.net.SocketTimeoutException {\n    --- End diff --\n    \n    Do we want to import java.net.SocketTimeoutException as it is used more then once? (very minor)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-06T15:15:45.190+0000","updated":"2014-05-06T15:15:45.190+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13990736","id":"13990736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user brndnmtthws commented on a diff in the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#discussion_r12329833\n  \n    --- Diff: external/storm-kafka/src/jvm/storm/kafka/DynamicBrokersReader.java ---\n    @@ -75,6 +74,8 @@ public GlobalPartitionInformation getBrokerInfo() {\n                         LOG.error(\"Node {} does not exist \", path);\n                     }\n                 }\n    +\t\t\t\t} catch(java.net.SocketTimeoutException e) {\n    --- End diff --\n    \n    True.  I'll fix that.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-06T15:19:53.653+0000","updated":"2014-05-06T15:19:53.653+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13990737","id":"13990737","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user brndnmtthws commented on a diff in the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#discussion_r12329854\n  \n    --- Diff: external/storm-kafka/src/jvm/storm/kafka/DynamicBrokersReader.java ---\n    @@ -52,15 +51,15 @@ public DynamicBrokersReader(Map conf, String zkStr, String zkPath, String topic)\n                                 Utils.getInt(conf.get(Config.STORM_ZOOKEEPER_RETRY_INTERVAL))));\n                 _curator.start();\n             } catch (Exception ex) {\n    -            LOG.error(\"can't connect to zookeeper\");\n    +            LOG.error(\"Couldn't connect to zookeeper\", ex);\n             }\n         }\n     \n         /**\n          * Get all partitions with their current leaders\n          */\n    -    public GlobalPartitionInformation getBrokerInfo() {\n    -        GlobalPartitionInformation globalPartitionInformation = new GlobalPartitionInformation();\n    +    public GlobalPartitionInformation getBrokerInfo() throws java.net.SocketTimeoutException {\n    --- End diff --\n    \n    Probably a good idea.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-06T15:20:14.217+0000","updated":"2014-05-06T15:20:14.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13990738","id":"13990738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user revans2 commented on a diff in the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#discussion_r12329867\n  \n    --- Diff: external/storm-kafka/src/jvm/storm/kafka/KafkaUtils.java ---\n    @@ -159,12 +171,17 @@ public static ByteBufferMessageSet fetchMessages(KafkaConfig config, SimpleConsu\n             for (int errors = 0; errors < 2 && msgs == null; errors++) {\n                 FetchRequestBuilder builder = new FetchRequestBuilder();\n                 FetchRequest fetchRequest = builder.addFetch(topic, partitionId, offset, config.fetchSizeBytes).\n    -                    clientId(config.clientId).build();\n    +                    clientId(config.clientId).maxWait(config.fetchMaxWait).build();\n                 FetchResponse fetchResponse;\n                 try {\n                     fetchResponse = consumer.fetch(fetchRequest);\n                 } catch (Exception e) {\n    -                if (e instanceof ConnectException) {\n    +                if (e instanceof ConnectException ||\n    --- End diff --\n    \n    This is a java 7 specific construct.  Currently we have JDK6 compatibility listed in the pom.  If we want to move to Java7, which I personally am OK with, but I know others are not, we need to discuss this on the mailing list.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-06T15:20:26.446+0000","updated":"2014-05-06T15:20:26.446+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13990739","id":"13990739","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user brndnmtthws commented on a diff in the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#discussion_r12329890\n  \n    --- Diff: external/storm-kafka/src/jvm/storm/kafka/KafkaUtils.java ---\n    @@ -159,12 +171,17 @@ public static ByteBufferMessageSet fetchMessages(KafkaConfig config, SimpleConsu\n             for (int errors = 0; errors < 2 && msgs == null; errors++) {\n                 FetchRequestBuilder builder = new FetchRequestBuilder();\n                 FetchRequest fetchRequest = builder.addFetch(topic, partitionId, offset, config.fetchSizeBytes).\n    -                    clientId(config.clientId).build();\n    +                    clientId(config.clientId).maxWait(config.fetchMaxWait).build();\n                 FetchResponse fetchResponse;\n                 try {\n                     fetchResponse = consumer.fetch(fetchRequest);\n                 } catch (Exception e) {\n    -                if (e instanceof ConnectException) {\n    +                if (e instanceof ConnectException ||\n    --- End diff --\n    \n    Ah, okay.  JDK6 is fine too.  I can repair this.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-06T15:20:59.029+0000","updated":"2014-05-06T15:20:59.029+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13990740","id":"13990740","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user revans2 commented on a diff in the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#discussion_r12329897\n  \n    --- Diff: external/storm-kafka/src/jvm/storm/kafka/PartitionManager.java ---\n    @@ -147,80 +146,97 @@ public EmitState next(SpoutOutputCollector collector) {\n     \n         private void fill() {\n             long start = System.nanoTime();\n    -        ByteBufferMessageSet msgs = KafkaUtils.fetchMessages(_spoutConfig, _consumer, _partition, _emittedToOffset);\n    +        long offset;\n    +        final boolean had_failed = !failed.isEmpty();\n    +\n    +        // Are there failed tuples? If so, fetch those first.\n    +        if (had_failed) {\n    +            offset = failed.first();\n    +        } else {\n    +            offset = _emittedToOffset + 1;\n    +        }\n    +\n    +        ByteBufferMessageSet msgs = KafkaUtils.fetchMessages(_spoutConfig, _consumer, _partition, offset);\n             long end = System.nanoTime();\n             long millis = (end - start) / 1000000;\n             _fetchAPILatencyMax.update(millis);\n             _fetchAPILatencyMean.update(millis);\n             _fetchAPICallCount.incr();\n    -        int numMessages = countMessages(msgs);\n    -        _fetchAPIMessageCount.incrBy(numMessages);\n    +        if (msgs != null) {\n    +            int numMessages = 0;\n     \n    -        if (numMessages > 0) {\n    -            LOG.info(\"Fetched \" + numMessages + \" messages from: \" + _partition);\n    -        }\n    -        for (MessageAndOffset msg : msgs) {\n    -            _pending.add(_emittedToOffset);\n    -            _waitingToEmit.add(new MessageAndRealOffset(msg.message(), _emittedToOffset));\n    -            _emittedToOffset = msg.nextOffset();\n    -        }\n    -        if (numMessages > 0) {\n    -            LOG.info(\"Added \" + numMessages + \" messages from: \" + _partition + \" to internal buffers\");\n    -        }\n    -    }\n    -\n    -    private int countMessages(ByteBufferMessageSet messageSet) {\n    -        int counter = 0;\n    -        for (MessageAndOffset messageAndOffset : messageSet) {\n    -            counter = counter + 1;\n    +            for (MessageAndOffset msg : msgs) {\n    +                final Long cur_offset = msg.offset();\n    +                if (!had_failed || failed.contains(cur_offset)) {\n    +                    numMessages += 1;\n    +                    _pending.add(cur_offset);\n    +                    _waitingToEmit.add(new MessageAndRealOffset(msg.message(), cur_offset));\n    +                    _emittedToOffset = Math.max(cur_offset, _emittedToOffset);\n    +                    if (had_failed) {\n    +                        failed.remove(cur_offset);\n    +                    }\n    +                }\n    +            }\n    +            _fetchAPIMessageCount.incrBy(numMessages);\n             }\n    -        return counter;\n         }\n     \n         public void ack(Long offset) {\n    -        _pending.remove(offset);\n    +        if (!_pending.isEmpty() && _pending.first() < offset - _spoutConfig.maxOffsetBehind) {\n    +            // Too many things pending!\n    +            _pending.headSet(offset).clear();\n    +        } else {\n    +            _pending.remove(offset);\n    +        }\n    +        numberAcked++;\n         }\n     \n         public void fail(Long offset) {\n    -        //TODO: should it use in-memory ack set to skip anything that's been acked but not committed???\n    -        // things might get crazy with lots of timeouts\n    -        if (_emittedToOffset > offset) {\n    -            _emittedToOffset = offset;\n    -            _pending.tailSet(offset).clear();\n    +        if (offset < _emittedToOffset - _spoutConfig.maxOffsetBehind) {\n    +            LOG.info(\n    +                    \"Skipping failed tuple at offset=\" + offset +\n    +                            \" because it's more than maxOffsetBehind=\" + _spoutConfig.maxOffsetBehind +\n    +                            \" behind _emittedToOffset=\" + _emittedToOffset\n    +            );\n    +        } else {\n    +            LOG.debug(\"failing at offset=\" + offset + \" with _pending.size()=\" + _pending.size() + \" pending and _emittedToOffset=\" + _emittedToOffset);\n    +            failed.add(offset);\n    +            numberFailed++;\n    +            if (numberAcked == 0 && numberFailed > _spoutConfig.maxOffsetBehind) {\n    +                throw new RuntimeException(\"Too many tuple failures\");\n    +            }\n             }\n         }\n     \n         public void commit() {\n    -        long lastCompletedOffset = lastCompletedOffset();\n    -        if (lastCompletedOffset != lastCommittedOffset()) {\n    -            LOG.info(\"Writing last completed offset (\" + lastCompletedOffset + \") to ZK for \" + _partition + \" for topology: \" + _topologyInstanceId);\n    -            Map<Object, Object> data = ImmutableMap.builder()\n    +        LOG.debug(\"Committing offset for \" + _partition);\n    +        long committedTo;\n    +        if (_pending.isEmpty()) {\n    +            committedTo = _emittedToOffset;\n    +        } else {\n    +            committedTo = _pending.first() - 1;\n    +        }\n    +        if (committedTo != _committedTo) {\n    +            LOG.debug(\"Writing committed offset to ZK: \" + committedTo);\n    +\n    +            Map<Object, Object> data = (Map<Object, Object>) ImmutableMap.builder()\n                         .put(\"topology\", ImmutableMap.of(\"id\", _topologyInstanceId,\n                                 \"name\", _stormConf.get(Config.TOPOLOGY_NAME)))\n    -                    .put(\"offset\", lastCompletedOffset)\n    +                    .put(\"offset\", committedTo)\n                         .put(\"partition\", _partition.partition)\n                         .put(\"broker\", ImmutableMap.of(\"host\", _partition.host.host,\n                                 \"port\", _partition.host.port))\n                         .put(\"topic\", _spoutConfig.topic).build();\n                 _state.writeJSON(committedPath(), data);\n    -            _committedTo = lastCompletedOffset;\n    -            LOG.info(\"Wrote last completed offset (\" + lastCompletedOffset + \") to ZK for \" + _partition + \" for topology: \" + _topologyInstanceId);\n    -        } else {\n    -            LOG.info(\"No new offset for \" + _partition + \" for topology: \" + _topologyInstanceId);\n    +\n    +            //LOG.info(\"Wrote committed offset to ZK: \" + committedTo);\n    --- End diff --\n    \n    Either remove this or change it to debug.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-06T15:21:07.837+0000","updated":"2014-05-06T15:21:07.837+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13990741","id":"13990741","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user brndnmtthws commented on the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#issuecomment-42316449\n  \n    I'll update the PR as per the comments above, but I can't do this today.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-06T15:21:12.857+0000","updated":"2014-05-06T15:21:12.857+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13990744","id":"13990744","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user revans2 commented on the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#issuecomment-42316654\n  \n    I am not a Kafka expert in any way, I just did a quick pass through the code.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-06T15:22:40.136+0000","updated":"2014-05-06T15:22:40.136+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13999067","id":"13999067","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user brndnmtthws commented on a diff in the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#discussion_r12705493\n  \n    --- Diff: external/storm-kafka/src/jvm/storm/kafka/KafkaUtils.java ---\n    @@ -159,12 +171,17 @@ public static ByteBufferMessageSet fetchMessages(KafkaConfig config, SimpleConsu\n             for (int errors = 0; errors < 2 && msgs == null; errors++) {\n                 FetchRequestBuilder builder = new FetchRequestBuilder();\n                 FetchRequest fetchRequest = builder.addFetch(topic, partitionId, offset, config.fetchSizeBytes).\n    -                    clientId(config.clientId).build();\n    +                    clientId(config.clientId).maxWait(config.fetchMaxWait).build();\n                 FetchResponse fetchResponse;\n                 try {\n                     fetchResponse = consumer.fetch(fetchRequest);\n                 } catch (Exception e) {\n    -                if (e instanceof ConnectException) {\n    +                if (e instanceof ConnectException ||\n    --- End diff --\n    \n    Actually, it looks like this is okay with Java 6, unless I'm mistaken.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-15T18:35:36.662+0000","updated":"2014-05-15T18:35:36.662+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13999085","id":"13999085","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user brndnmtthws commented on the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#issuecomment-43248872\n  \n    Updated as per comments above, with a couple other minor fixes.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-15T18:42:08.595+0000","updated":"2014-05-15T18:42:08.595+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13999908","id":"13999908","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user revans2 commented on a diff in the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#discussion_r12745379\n  \n    --- Diff: external/storm-kafka/src/jvm/storm/kafka/KafkaUtils.java ---\n    @@ -159,12 +171,17 @@ public static ByteBufferMessageSet fetchMessages(KafkaConfig config, SimpleConsu\n             for (int errors = 0; errors < 2 && msgs == null; errors++) {\n                 FetchRequestBuilder builder = new FetchRequestBuilder();\n                 FetchRequest fetchRequest = builder.addFetch(topic, partitionId, offset, config.fetchSizeBytes).\n    -                    clientId(config.clientId).build();\n    +                    clientId(config.clientId).maxWait(config.fetchMaxWait).build();\n                 FetchResponse fetchResponse;\n                 try {\n                     fetchResponse = consumer.fetch(fetchRequest);\n                 } catch (Exception e) {\n    -                if (e instanceof ConnectException) {\n    +                if (e instanceof ConnectException ||\n    --- End diff --\n    \n    You are correct.  I though I saw the java 7 ```catch ConnectException | SocketTimeoutException | ...``` But I could be mistaken.  It looks fine now\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-16T15:54:13.248+0000","updated":"2014-05-16T15:54:13.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/13999912","id":"13999912","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user revans2 commented on the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#issuecomment-43348089\n  \n    The code looks good to me, but I am not a kafka expert and would really like someone else with more kafka knowledge to take a look at this too. I am +1.  \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-16T15:57:07.073+0000","updated":"2014-05-16T15:57:07.073+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/14000215","id":"14000215","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user brndnmtthws commented on the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#issuecomment-43372409\n  \n    Updated as per @wurstmeister's comments.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-16T19:51:18.028+0000","updated":"2014-05-16T19:51:18.028+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/14003450","id":"14003450","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user ptgoetz commented on the pull request:\n\n    https://github.com/apache/incubator-storm/pull/94#issuecomment-43641973\n  \n    +1\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-20T15:32:29.917+0000","updated":"2014-05-20T15:32:29.917+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12710998/comment/14003826","id":"14003826","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/incubator-storm/pull/94\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-20T18:59:03.561+0000","updated":"2014-05-20T18:59:03.561+0000"}],"maxResults":16,"total":16,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/STORM-303/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1v27j:"}}