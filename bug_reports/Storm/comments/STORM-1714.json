[GitHub user arunmahadevan opened a pull request:

    https://github.com/apache/storm/pull/1343

    [STORM-1714] StatefulBolts ends up as normal bolts while using TopologyBuilder.setBolt without parallelism

    Refactored IstatefulBolt to be independent of IRichBolt so that setBolt overloads in TopologyBuilder can work correctly.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/arunmahadevan/storm STORM-1714

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/storm/pull/1343.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #1343
    
----
commit 8868a58c27b6baee3d8fa1487434fc58509e514d
Author: Arun Mahadevan <aiyer@hortonworks.com>
Date:   2016-04-15T12:06:07Z

    [STORM-1714] StatefulBolts ends up as normal bolts while using TopologyBuilder.setBolt without parallelism

----
, Github user harshach commented on the pull request:

    https://github.com/apache/storm/pull/1343#issuecomment-210850532
  
    +1. @arunmahadevan we want this in 1.x-branch as well right?
, Github user arunmahadevan commented on the pull request:

    https://github.com/apache/storm/pull/1343#issuecomment-210853684
  
    @harshach yes both master and 1.x branch
, Github user HeartSaVioR commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1343#discussion_r60014901
  
    --- Diff: storm-core/src/jvm/org/apache/storm/topology/CheckpointTupleForwarder.java ---
    @@ -53,6 +53,10 @@
         private long lastTxid = Long.MIN_VALUE;
         private AnchoringOutputCollector collector;
     
    +    public CheckpointTupleForwarder() {
    --- End diff --
    
    Do we need this constructor? Especially it will incur NPE since this.bolt is accessed from various methods.
, Github user HeartSaVioR commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1343#discussion_r60016236
  
    --- Diff: storm-core/src/jvm/org/apache/storm/topology/CheckpointTupleForwarder.java ---
    @@ -53,6 +53,10 @@
         private long lastTxid = Long.MIN_VALUE;
         private AnchoringOutputCollector collector;
     
    +    public CheckpointTupleForwarder() {
    --- End diff --
    
    Oh I'm seeing StatefulBoltExecutor extends this class.
    
    IMO StatefulBoltExecutor extending CheckpointTupleForwarder could make us confusing, since StatefulBoltExecutor always call default constructor of CheckpointTupleForwarder, which means that StatefulBoltExecutor should hide all methods which access (directly or indirectly) this.bolt to avoid NPE.
    
    Could we introduce base class extracting common logic from CheckpointTupleForwarder?
, Github user HeartSaVioR commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1343#discussion_r60016799
  
    --- Diff: storm-core/src/jvm/org/apache/storm/topology/IStatefulBolt.java ---
    @@ -27,5 +32,17 @@
      * state updates. The stateful bolts are expected to anchor the tuples while emitting
      * and ack the input tuples once its processed.</p>
      */
    -public interface IStatefulBolt<T extends State> extends IStatefulComponent<T>, IRichBolt {
    +public interface IStatefulBolt<T extends State> extends IStatefulComponent<T> {
    --- End diff --
    
    Good fix. :)
, Github user arunmahadevan commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1343#discussion_r60036656
  
    --- Diff: storm-core/src/jvm/org/apache/storm/topology/CheckpointTupleForwarder.java ---
    @@ -53,6 +53,10 @@
         private long lastTxid = Long.MIN_VALUE;
         private AnchoringOutputCollector collector;
     
    +    public CheckpointTupleForwarder() {
    --- End diff --
    
    Since the IStatefulBolt is no longer an IRichBolt it cannot be passed to the base class. Makes sense to move the common functionality to a base class which both StatefulBoltExecutor and CheckpointTupleForwarder inherit to avoid the confusion. Will do the refactoring.
, Github user arunmahadevan commented on the pull request:

    https://github.com/apache/storm/pull/1343#issuecomment-211524696
  
    @HeartSaVioR refactored and extracted common logic to a common parent of StatefulBoltExecutor and CheckpointTupleForwarder. Please review.
, Github user HeartSaVioR commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1343#discussion_r60164876
  
    --- Diff: storm-core/src/jvm/org/apache/storm/topology/StatefulBoltExecutor.java ---
    @@ -74,6 +71,23 @@ void prepare(Map stormConf, TopologyContext context, OutputCollector collector,
         }
     
         @Override
    +    public void cleanup() {
    +        bolt.cleanup();
    +    }
    +
    +    @Override
    +    public void declareOutputFields(OutputFieldsDeclarer declarer) {
    +        bolt.declareOutputFields(declarer);
    +        super.declareCheckpointStream(declarer);
    --- End diff --
    
    Nit: It doesn't need to be called with `super.`.
, Github user HeartSaVioR commented on the pull request:

    https://github.com/apache/storm/pull/1343#issuecomment-211690204
  
    +1 with nit comment which could be skipped.
, Github user asfgit closed the pull request at:

    https://github.com/apache/storm/pull/1343
, Github user HeartSaVioR commented on the pull request:

    https://github.com/apache/storm/pull/1343#issuecomment-212321561
  
    +1
, Thanks [~arunmahadevan], I merged into master and 1.x-branch (by cherry-picking.)]