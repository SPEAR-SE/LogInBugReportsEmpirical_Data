[GitHub user schonfeld opened a pull request:

    https://github.com/apache/storm/pull/794

    [STORM-1104] Nimbus HA fails to find newly downloaded code files

    Nimbus HA using Local File System code distribution is broken. We seem to be "caching" the return value of `(code-ids (:conf nimbus))` in the sync-code method, by overriding the `code-ids` var from a method ([nimbus.clj#854](../blob/master/storm-core/src/clj/backtype/storm/daemon/nimbus.clj#L854) `defn code-ids`), to a local var ([nimbus.clj#1669](../blob/master/storm-core/src/clj/backtype/storm/daemon/nimbus.clj#L1669) `code-ids (set (code-ids (:conf nimbus)))`).
    
    The problem is, that after downloading code for missing topologies, sync-code doesn't realize it has gotten the new missing topology files.


You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/schonfeld/storm nimbus-ha-fails-to-find-code-files

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/storm/pull/794.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #794
    
----
commit ba1250993d10ffc523c9f5464371fbeb406d216f
Author: Michael Schonfeld <michael@schonfeld.org>
Date:   2015-10-09T23:48:41Z

    dont override code-ids method

----
, Github user Parth-Brahmbhatt commented on the pull request:

    https://github.com/apache/storm/pull/794#issuecomment-147019720
  
    +1, good catch.
, Github user revans2 commented on the pull request:

    https://github.com/apache/storm/pull/794#issuecomment-147452170
  
    Ah I see ```(when-not (contains? (code-ids (:conf nimbus)) missing)``` uses code-ids later after it was cached.
    
    +1
, Github user revans2 commented on the pull request:

    https://github.com/apache/storm/pull/794#issuecomment-147452406
  
    The test failure looks unrelated.
, Github user schonfeld commented on the pull request:

    https://github.com/apache/storm/pull/794#issuecomment-147454281
  
    @revans2 true, but more importantly `(if (empty? (set/difference active-topologies (set (code-ids (:conf nimbus)))))` needs to know about the new code-ids, otherwise new nimbuses won't go into the leader lock queue...
, Github user asfgit closed the pull request at:

    https://github.com/apache/storm/pull/794
, Thanks [~BaconSeason],

I merged this into master.]