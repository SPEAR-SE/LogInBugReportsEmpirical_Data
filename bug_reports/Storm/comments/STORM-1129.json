[GitHub user priyank5485 opened a pull request:

    https://github.com/apache/storm/pull/854

    STORM-1129: Use topology name instead of id in UI calls.

    Note that all-topologies-summary has been used to get topology id from a topology name. That involves a few calls to zookeeper which is not ideal. However, UI does not seem to take any significant performance hit. If needed we can handle it possibly using one of the options below. Since its a separate performance issue we can handle it in a separate JIRA.
    
    1. Have nimbus thrift server cache summary for topologies so it does not hit zookeeper every time we try to get topology id from name.
    2. Update nimbus thrift api with a method that takes options and use that to do only the minimal necessary interaction with zookeeper for a given option.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/priyank5485/storm STORM-1129

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/storm/pull/854.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #854
    
----
commit 77b73af52bdc2d691ae172a1a2905a94395c3c70
Author: Priyank <pshah@hortonworks.com>
Date:   2015-11-04T00:20:50Z

    STORM-1129: Use topology name instead of id in UI calls.

----
, Github user jerrypeng commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-153816194
  
    Topology names are not unique.  Users can submit topologies with the same name, but the their auto generated topology ids will be unique.  I am not sure this is the right way to go about this
, Github user revans2 commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-153818643
  
    @jerrypeng they can submit topologies with the same name, but not at the same time.  You can only have one "foo" topology running at any point in time.
, Github user priyank5485 commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-153819160
  
    @jerrypeng We have a check and it throws the following exception.
    
    Exception in thread "main" java.lang.RuntimeException: Topology with name `wordcount` already exists on cluster
    	at backtype.storm.StormSubmitter.submitTopologyAs(StormSubmitter.java:231)
    	at backtype.storm.StormSubmitter.submitTopology(StormSubmitter.java:275)
    	at backtype.storm.StormSubmitter.submitTopologyWithProgressBar(StormSubmitter.java:311)
    	at backtype.storm.StormSubmitter.submitTopologyWithProgressBar(StormSubmitter.java:292)
    	at storm.starter.WordCountTopology.main(WordCountTopology.java:94)
    
    @revans2 Thanks for chiming in.
, Github user harshach commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-153819804
  
    @jerrypeng topology names are unique
, Github user Parth-Brahmbhatt commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-153836316
  
    +1.
, Github user jerrypeng commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-153838740
  
    thanks for the explanation and clarification everybody
, Github user revans2 commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-153854331
  
    This is a non-backwards compatible change to the REST API and I really would prefer to maintain compatibility if at all possible.  It seems fairly simple to make the REST API work with the name or the id.  We call get-id-from-name all over the place, it seems fairly simple to check to see if there is a topology with that as the ID, if not check to see if there is a topology with it as the name. 
, Github user revans2 commented on a diff in the pull request:

    https://github.com/apache/storm/pull/854#discussion_r43935706
  
    --- Diff: storm-core/src/clj/backtype/storm/ui/core.clj ---
    @@ -851,141 +859,151 @@
         (populate-context! servlet-request)
         (assert-authorized-user "getClusterInfo")
         (json-response (all-topologies-summary) (:callback m)))
    -  (GET "/api/v1/topology/:id" [:as {:keys [cookies servlet-request scheme]} id & m]
    -    (populate-context! servlet-request)
    -    (assert-authorized-user "getTopology" (topology-config id))
    -    (let [user (get-user-name servlet-request)]
    -      (json-response (topology-page id (:window m) (check-include-sys? (:sys m)) user (= scheme :https)) (:callback m))))
    -  (GET "/api/v1/topology/:id/visualization-init" [:as {:keys [cookies servlet-request]} id & m]
    -    (populate-context! servlet-request)
    -    (assert-authorized-user "getTopology" (topology-config id))
    -    (json-response (build-visualization id (:window m) (check-include-sys? (:sys m))) (:callback m)))
    -  (GET "/api/v1/topology/:id/visualization" [:as {:keys [cookies servlet-request]} id & m]
    -    (populate-context! servlet-request)
    -    (assert-authorized-user "getTopology" (topology-config id))
    -    (json-response (mk-visualization-data id (:window m) (check-include-sys? (:sys m))) (:callback m)))
    -  (GET "/api/v1/topology/:id/component/:component" [:as {:keys [cookies servlet-request scheme]} id component & m]
    -    (populate-context! servlet-request)
    -    (assert-authorized-user "getTopology" (topology-config id))
    -    (let [user (get-user-name servlet-request)]
    -      (json-response
    -          (component-page id component (:window m) (check-include-sys? (:sys m)) user (= scheme :https))
    -          (:callback m))))
    -  (GET "/api/v1/topology/:id/logconfig" [:as {:keys [cookies servlet-request]} id & m]
    -    (populate-context! servlet-request)
    -    (assert-authorized-user "getTopology" (topology-config id))
    -       (json-response (log-config id) (:callback m)))
    -  (POST "/api/v1/topology/:id/activate" [:as {:keys [cookies servlet-request]} id & m]
    -    (populate-context! servlet-request)
    -    (assert-authorized-user "activate" (topology-config id))
    -    (thrift/with-configured-nimbus-connection nimbus
    -       (let [tplg (->> (doto
    -                        (GetInfoOptions.)
    -                        (.set_num_err_choice NumErrorsChoice/NONE))
    -                      (.getTopologyInfoWithOpts ^Nimbus$Client nimbus id))
    -            name (.get_name tplg)]
    -        (.activate nimbus name)
    -        (log-message "Activating topology '" name "'")))
    -    (json-response (topology-op-response id "activate") (m "callback")))
    -  (POST "/api/v1/topology/:id/deactivate" [:as {:keys [cookies servlet-request]} id & m]
    -    (populate-context! servlet-request)
    -    (assert-authorized-user "deactivate" (topology-config id))
    -    (thrift/with-configured-nimbus-connection nimbus
    +  (GET "/api/v1/topology/:name" [:as {:keys [cookies servlet-request scheme]} name & m]
    +    (let [id (get-id-from-name name)]
    +      (populate-context! servlet-request)
    --- End diff --
    
    We have to populate the context before ever talking to nimbus.  `get-id-from-name` talks to nimbus and could potentially authenticate with the wrong user to nimbus.  This needs to be fixed everywhere.
, Github user revans2 commented on a diff in the pull request:

    https://github.com/apache/storm/pull/854#discussion_r43935881
  
    --- Diff: storm-core/src/ui/public/component.html ---
    @@ -116,7 +116,7 @@
     
             var componentSummary = $("#component-summary");
             var componentActions = $("#component-actions");
    -        var buttonJsonData = componentActionJson(response["encodedTopologyId"], response["encodedId"], response["id"],
    +        var buttonJsonData = componentActionJson(response["name"], response["encodedId"], response["id"],
    --- End diff --
    
    We need to encode the name just like we conded the topologyId, or we have the possibility of an incorrect URL for odd characters in a topology name.
, Github user revans2 commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-153855653
  
    @priyank5485 for the most part this change looks good to me, but there are a few serious bugs/incompatibilities that need to be fixed before this can go in.
, Github user Parth-Brahmbhatt commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-153864538
  
    I agree with @revans2 , lets maintain backward compatibility.
, Github user priyank5485 commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-154136188
  
    @revans2 @Parth-Brahmbhatt @jerrypeng @harshach  Thanks all for the feedback.  Other than the changes here there are some commits to apache/master after creation of this PR which added some more apis in UI using topology id making this PR unmergeable. I will  sort all of that out and update the PR.
, Github user revans2 commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-154151451
  
    @priyank5485 thanks for doing this.  I think it is going to make the UI much more usable.  Essentially giving us perma-links to a topology. 
, Github user wuchong commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-154403920
  
    +1 
    
    In Alibaba, we implement our monitor system using topology name instead of id. And it is very useful , as users often resubmit topology several times , and they do not need to find the new topology page link.
    
    But we should  maintain backward compatibility. maybe we can deal with  topology-id arg in function  `get-id-from-name`
, Github user harshach commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-195881422
  
    @priyank5485 sorry for the delay. can you please upmerge this patch and open up another PR for 1.x-branch as well.
, GitHub user priyank5485 opened a pull request:

    https://github.com/apache/storm/pull/1277

    STORM-1129: Update ui to use topology name

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/priyank5485/storm STORM-1129-1.x

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/storm/pull/1277.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #1277
    
----
commit 2648d74cad7d1e46ec9bcceb9b3b388cb98cfc8d
Author: Priyank <pshah@hortonworks.com>
Date:   2016-03-29T05:31:08Z

    STORM-1129: Update ui to use topology name

----
, Github user priyank5485 commented on the pull request:

    https://github.com/apache/storm/pull/854#issuecomment-203246876
  
    @harshach @revans2 I have addressed the comments  and raised a PR https://github.com/apache/storm/pull/1277 against the 1.x branch as I could not test my branch off of master due to another issue. Can you please review the PR against 1.x branch? I will port the same to master by updating this PR.
, Github user abhishekagarwal87 commented on the pull request:

    https://github.com/apache/storm/pull/1277#issuecomment-203279789
  
    @priyank5485 I see that you have the changed the logviewer urls in the topology page to use topology name but there are no changes in logviewer.clj. I think logviewer links should just point to topology id since log links are anyway tied to a specific instance of topology run. 
, Github user abhishekagarwal87 commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1277#discussion_r57843883
  
    --- Diff: storm-core/src/ui/public/component.html ---
    @@ -176,7 +176,7 @@
               var loc = $(row[3])[0]; // logviewer URL
               return '<input type="checkbox" class="workerActionCheckbox"'+
                   'id="'+checkboxId+'" value="'+host_port+'"'+checkedString+'/> '+
    -              '<a href="'+loc.protocol+'//'+loc.host+'/dumps/'+topologyId+'/'+
    +              '<a href="'+loc.protocol+'//'+loc.host+'/dumps/'+topologyName+'/'+
    --- End diff --
    
    should be left as it is. 
, Github user priyank5485 commented on the pull request:

    https://github.com/apache/storm/pull/1277#issuecomment-203557013
  
    @abhishekagarwal87 Thanks for the catch. I have updated the PR. Can you please review?
, Github user knusbaum commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1277#discussion_r57948138
  
    --- Diff: storm-core/src/clj/org/apache/storm/ui/core.clj ---
    @@ -466,6 +466,21 @@
            "assignedCpu" (.get_assigned_cpu t)})
         "schedulerDisplayResource" (*STORM-CONF* Config/SCHEDULER_DISPLAY_RESOURCE)}))
     
    +(defn get-topology-id [topology-name-or-id]
    +  (let [summary ((all-topologies-summary) "topologies")
    +        filter-fun-name (fn[topo-summary] (= (topo-summary "name") topology-name-or-id))
    +        filter-fun-id (fn[topo-summary] (= (topo-summary "id") topology-name-or-id))
    +        matching-topologies-by-name (filter filter-fun-name summary)
    +        matching-topologies-by-id (filter filter-fun-id summary)
    +        matching-topologies
    +        (cond
    +          (not-empty matching-topologies-by-name) matching-topologies-by-name
    +          (not-empty matching-topologies-by-id) matching-topologies-by-id
    +          :else nil)
    +        _ (when (empty? matching-topologies) (throw (NotAliveException. (str topology-name-or-id " is not alive"))))
    +        id ((first matching-topologies) "id")]
    +    id))
    --- End diff --
    
    We should probably prioritize matching ids here instead of matching names. As it is now, If I give my topology a name that matches another topology's id, the topology whose id I stole will become inaccessible. Since we're prioritizing names, it will match that topology's id to my topology's name, and display my topology instead.
, Github user priyank5485 commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1277#discussion_r57950485
  
    --- Diff: storm-core/src/clj/org/apache/storm/ui/core.clj ---
    @@ -466,6 +466,21 @@
            "assignedCpu" (.get_assigned_cpu t)})
         "schedulerDisplayResource" (*STORM-CONF* Config/SCHEDULER_DISPLAY_RESOURCE)}))
     
    +(defn get-topology-id [topology-name-or-id]
    +  (let [summary ((all-topologies-summary) "topologies")
    +        filter-fun-name (fn[topo-summary] (= (topo-summary "name") topology-name-or-id))
    +        filter-fun-id (fn[topo-summary] (= (topo-summary "id") topology-name-or-id))
    +        matching-topologies-by-name (filter filter-fun-name summary)
    +        matching-topologies-by-id (filter filter-fun-id summary)
    +        matching-topologies
    +        (cond
    +          (not-empty matching-topologies-by-name) matching-topologies-by-name
    +          (not-empty matching-topologies-by-id) matching-topologies-by-id
    +          :else nil)
    +        _ (when (empty? matching-topologies) (throw (NotAliveException. (str topology-name-or-id " is not alive"))))
    +        id ((first matching-topologies) "id")]
    +    id))
    --- End diff --
    
    @knusbaum Thats true. But if we prioritize ids would not your topology become inaccessible? I think going forward we should use topology names in ui and elsewhere so that we can have permanent links and since thats the identifier given by the user. Support for lookup with ids was added for backwards compatibility as suggested by @revans2 and others.
, Github user knusbaum commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1277#discussion_r57951884
  
    --- Diff: storm-core/src/clj/org/apache/storm/ui/core.clj ---
    @@ -466,6 +466,21 @@
            "assignedCpu" (.get_assigned_cpu t)})
         "schedulerDisplayResource" (*STORM-CONF* Config/SCHEDULER_DISPLAY_RESOURCE)}))
     
    +(defn get-topology-id [topology-name-or-id]
    +  (let [summary ((all-topologies-summary) "topologies")
    +        filter-fun-name (fn[topo-summary] (= (topo-summary "name") topology-name-or-id))
    +        filter-fun-id (fn[topo-summary] (= (topo-summary "id") topology-name-or-id))
    +        matching-topologies-by-name (filter filter-fun-name summary)
    +        matching-topologies-by-id (filter filter-fun-id summary)
    +        matching-topologies
    +        (cond
    +          (not-empty matching-topologies-by-name) matching-topologies-by-name
    +          (not-empty matching-topologies-by-id) matching-topologies-by-id
    +          :else nil)
    +        _ (when (empty? matching-topologies) (throw (NotAliveException. (str topology-name-or-id " is not alive"))))
    +        id ((first matching-topologies) "id")]
    +    id))
    --- End diff --
    
    That's fine with me. 
, Github user abhishekagarwal87 commented on the pull request:

    https://github.com/apache/storm/pull/1277#issuecomment-203743167
  
    Thanks @priyank5485 - Though I am still not sure how logviewer links will work. topologyId variable is not assigned any value. Original code -
    https://github.com/apache/storm/blob/master/storm-core/src/ui/public/component.html#L136
, Github user priyank5485 commented on the pull request:

    https://github.com/apache/storm/pull/1277#issuecomment-203751947
  
    @abhishekagarwal87 Please look at the $.getJson method. Line 190 in component.html. Now, instead of topologyId being assigned on onReady i do it in $.getJson. Its a side effect of squashing commits that makes it hard to look at the commits that addressed review comments. Sorry about that. Do you guys usually keep separate commits and squash in the end? I will do that next time.
, Github user abhishekagarwal87 commented on the pull request:

    https://github.com/apache/storm/pull/1277#issuecomment-203756449
  
    I think either way is fine. My only concern was logviewer links which I think you have addressed. 
, Github user harshach commented on the issue:

    https://github.com/apache/storm/pull/1277
  
    @priyank5485 sorry for the delay on this. Can you up merge this patch.
]