[GitHub user satishd opened a pull request:

    https://github.com/apache/storm/pull/1446

    STORM-1864 StormSubmitter should throw respective exceptions and log respective errors forregistered submitter hook invocation

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/satishd/storm STORM-1864

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/storm/pull/1446.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #1446
    
----
commit a061d45f3ebe68a3e2f0265e9c606f86445c8f35
Author: Satish Duggana <sduggana@hortonworks.com>
Date:   2016-05-25T06:21:12Z

    STORM-1864 StormSubmitter should throw respective exceptions and log respective errors forregistered submitter hook invocation.

----
, Github user satishd commented on the pull request:

    https://github.com/apache/storm/pull/1446#issuecomment-221486787
  
    @arunmahadevan Can you please review this?
, Github user satishd commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1446#discussion_r64522988
  
    --- Diff: storm-core/src/jvm/org/apache/storm/hooks/SubmitterHookException.java ---
    @@ -0,0 +1,41 @@
    +/*
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + * http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing,
    + * software distributed under the License is distributed on an
    + * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    + * KIND, either express or implied.  See the License for the
    + * specific language governing permissions and limitations
    + * under the License.
    + */
    +package org.apache.storm.hooks;
    +
    +/**
    + * This Exception is thrown when registered {@link org.apache.storm.ISubmitterHook} could not be initialized or invoked.
    + */
    +public class SubmitterHookException extends RuntimeException {
    --- End diff --
    
    Maintaining backward compatibility is the main reason for this exception being _RuntimeException_
    Added docs at the appropriate places for this usage.
, Github user abhishekagarwal87 commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1446#discussion_r64523789
  
    --- Diff: storm-core/src/jvm/org/apache/storm/StormSubmitter.java ---
    @@ -223,48 +227,60 @@ public static void submitTopologyAs(String name, Map stormConf, StormTopology to
                         // this is for backwards compatibility
                         localNimbus.submitTopology(name, stormConf, topology);
                     }
    +                LOG.info("Finished submitting topology: " +  name);
                 } else {
                     String serConf = JSONValue.toJSONString(stormConf);
    -                NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser);
                     if(topologyNameExists(conf, name, asUser)) {
                         throw new RuntimeException("Topology with name `" + name + "` already exists on cluster");
                     }
                     String jar = submitJarAs(conf, System.getProperty("storm.jar"), progressListener, asUser);
    -                try {
    -                    LOG.info("Submitting topology " +  name + " in distributed mode with conf " + serConf);
    -                    if(opts!=null) {
    +                try (NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser)) {
    +                    LOG.info("Submitting topology " + name + " in distributed mode with conf " + serConf);
    +                    if (opts != null) {
                             client.getClient().submitTopologyWithOpts(name, jar, serConf, topology, opts);
                         } else {
                             // this is for backwards compatibility
                             client.getClient().submitTopology(name, jar, serConf, topology);
                         }
    -                } catch(InvalidTopologyException e) {
    -                    LOG.warn("Topology submission exception: "+e.get_msg());
    +                    LOG.info("Finished submitting topology: " + name);
    +                } catch (InvalidTopologyException e) {
    +                    LOG.warn("Topology submission exception: " + e.get_msg());
                         throw e;
    -                } catch(AlreadyAliveException e) {
    +                } catch (AlreadyAliveException e) {
                         LOG.warn("Topology already alive exception", e);
                         throw e;
    -                } finally {
    -                    client.close();
                     }
                 }
    -            LOG.info("Finished submitting topology: " +  name);
             } catch(TException e) {
                 throw new RuntimeException(e);
             }
             invokeSubmitterHook(name, asUser, conf, topology);
     
         }
     
    +    /**
    +     *
    +     * @param name
    +     * @param asUser
    +     * @param stormConf
    +     * @param topology
    +     *
    +     * @thorws SubmitterHookException This is thrown when any Exception occurs during initialization or invocation of registered {@link ISubmitterHook}
    +     */
         private static void invokeSubmitterHook(String name, String asUser, Map stormConf, StormTopology topology) {
    +        String submissionNotifierClassName = null;
             try {
                 if (stormConf.containsKey(Config.STORM_TOPOLOGY_SUBMISSION_NOTIFIER_PLUGIN)) {
    -                ISubmitterHook submitterHook = (ISubmitterHook) Class.forName(stormConf.get(Config.STORM_TOPOLOGY_SUBMISSION_NOTIFIER_PLUGIN).toString()).newInstance();
    +                submissionNotifierClassName = stormConf.get(Config.STORM_TOPOLOGY_SUBMISSION_NOTIFIER_PLUGIN).toString();
    +                LOG.info("Initializing the registered ISubmitterHook [{}]", submissionNotifierClassName);
    +                ISubmitterHook submitterHook = (ISubmitterHook) Class.forName(submissionNotifierClassName).newInstance();
                     TopologyInfo topologyInfo = Utils.getTopologyInfo(name, asUser, stormConf);
    +                LOG.info("Invoking the registered ISubmitterHook [{}]", submissionNotifierClassName);
                     submitterHook.notify(topologyInfo, stormConf, topology);
                 }
             } catch (Exception e) {
    -            throw new RuntimeException(e);
    +            LOG.warn("Error occurred in invoking submitter hook: "+submissionNotifierClassName, e);
    --- End diff --
    
    Minor. can use {} notation instead of concatenation. 
, Github user abhishekagarwal87 commented on the pull request:

    https://github.com/apache/storm/pull/1446#issuecomment-221491488
  
    +1
, Github user satishd commented on the pull request:

    https://github.com/apache/storm/pull/1446#issuecomment-221629286
  
    @ptgoetz Can you please review this PR?
, Github user ptgoetz commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1446#discussion_r64612709
  
    --- Diff: storm-core/src/jvm/org/apache/storm/StormSubmitter.java ---
    @@ -223,48 +227,65 @@ public static void submitTopologyAs(String name, Map stormConf, StormTopology to
                         // this is for backwards compatibility
                         localNimbus.submitTopology(name, stormConf, topology);
                     }
    +                LOG.info("Finished submitting topology: " +  name);
                 } else {
                     String serConf = JSONValue.toJSONString(stormConf);
    -                NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser);
                     if(topologyNameExists(conf, name, asUser)) {
                         throw new RuntimeException("Topology with name `" + name + "` already exists on cluster");
                     }
                     String jar = submitJarAs(conf, System.getProperty("storm.jar"), progressListener, asUser);
    -                try {
    -                    LOG.info("Submitting topology " +  name + " in distributed mode with conf " + serConf);
    -                    if(opts!=null) {
    +                try (NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser)) {
    +                    LOG.info("Submitting topology " + name + " in distributed mode with conf " + serConf);
    +                    if (opts != null) {
                             client.getClient().submitTopologyWithOpts(name, jar, serConf, topology, opts);
                         } else {
                             // this is for backwards compatibility
                             client.getClient().submitTopology(name, jar, serConf, topology);
                         }
    -                } catch(InvalidTopologyException e) {
    -                    LOG.warn("Topology submission exception: "+e.get_msg());
    +                    LOG.info("Finished submitting topology: " + name);
    +                } catch (InvalidTopologyException e) {
    +                    LOG.warn("Topology submission exception: " + e.get_msg());
                         throw e;
    -                } catch(AlreadyAliveException e) {
    +                } catch (AlreadyAliveException e) {
                         LOG.warn("Topology already alive exception", e);
                         throw e;
    -                } finally {
    -                    client.close();
    --- End diff --
    
    Shouldn't we close the thrift client?
, Github user ptgoetz commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1446#discussion_r64612906
  
    --- Diff: storm-core/src/jvm/org/apache/storm/StormSubmitter.java ---
    @@ -223,48 +227,65 @@ public static void submitTopologyAs(String name, Map stormConf, StormTopology to
                         // this is for backwards compatibility
                         localNimbus.submitTopology(name, stormConf, topology);
                     }
    +                LOG.info("Finished submitting topology: " +  name);
                 } else {
                     String serConf = JSONValue.toJSONString(stormConf);
    -                NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser);
                     if(topologyNameExists(conf, name, asUser)) {
                         throw new RuntimeException("Topology with name `" + name + "` already exists on cluster");
                     }
                     String jar = submitJarAs(conf, System.getProperty("storm.jar"), progressListener, asUser);
    -                try {
    -                    LOG.info("Submitting topology " +  name + " in distributed mode with conf " + serConf);
    -                    if(opts!=null) {
    +                try (NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser)) {
    +                    LOG.info("Submitting topology " + name + " in distributed mode with conf " + serConf);
    +                    if (opts != null) {
                             client.getClient().submitTopologyWithOpts(name, jar, serConf, topology, opts);
                         } else {
                             // this is for backwards compatibility
                             client.getClient().submitTopology(name, jar, serConf, topology);
                         }
    -                } catch(InvalidTopologyException e) {
    -                    LOG.warn("Topology submission exception: "+e.get_msg());
    +                    LOG.info("Finished submitting topology: " + name);
    +                } catch (InvalidTopologyException e) {
    +                    LOG.warn("Topology submission exception: " + e.get_msg());
                         throw e;
    -                } catch(AlreadyAliveException e) {
    +                } catch (AlreadyAliveException e) {
                         LOG.warn("Topology already alive exception", e);
                         throw e;
    -                } finally {
    -                    client.close();
                     }
                 }
    -            LOG.info("Finished submitting topology: " +  name);
    --- End diff --
    
    Shouldn't this just be moved up rather than deleted?
, Github user abhishekagarwal87 commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1446#discussion_r64617209
  
    --- Diff: storm-core/src/jvm/org/apache/storm/StormSubmitter.java ---
    @@ -223,48 +227,65 @@ public static void submitTopologyAs(String name, Map stormConf, StormTopology to
                         // this is for backwards compatibility
                         localNimbus.submitTopology(name, stormConf, topology);
                     }
    +                LOG.info("Finished submitting topology: " +  name);
                 } else {
                     String serConf = JSONValue.toJSONString(stormConf);
    -                NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser);
                     if(topologyNameExists(conf, name, asUser)) {
                         throw new RuntimeException("Topology with name `" + name + "` already exists on cluster");
                     }
                     String jar = submitJarAs(conf, System.getProperty("storm.jar"), progressListener, asUser);
    -                try {
    -                    LOG.info("Submitting topology " +  name + " in distributed mode with conf " + serConf);
    -                    if(opts!=null) {
    +                try (NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser)) {
    +                    LOG.info("Submitting topology " + name + " in distributed mode with conf " + serConf);
    +                    if (opts != null) {
                             client.getClient().submitTopologyWithOpts(name, jar, serConf, topology, opts);
                         } else {
                             // this is for backwards compatibility
                             client.getClient().submitTopology(name, jar, serConf, topology);
                         }
    -                } catch(InvalidTopologyException e) {
    -                    LOG.warn("Topology submission exception: "+e.get_msg());
    +                    LOG.info("Finished submitting topology: " + name);
    +                } catch (InvalidTopologyException e) {
    +                    LOG.warn("Topology submission exception: " + e.get_msg());
                         throw e;
    -                } catch(AlreadyAliveException e) {
    +                } catch (AlreadyAliveException e) {
                         LOG.warn("Topology already alive exception", e);
                         throw e;
    -                } finally {
    -                    client.close();
    --- End diff --
    
    It is created inside try-with-resource statement  and will be closed automatically.
, Github user abhishekagarwal87 commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1446#discussion_r64617620
  
    --- Diff: storm-core/src/jvm/org/apache/storm/StormSubmitter.java ---
    @@ -223,48 +227,65 @@ public static void submitTopologyAs(String name, Map stormConf, StormTopology to
                         // this is for backwards compatibility
                         localNimbus.submitTopology(name, stormConf, topology);
                     }
    +                LOG.info("Finished submitting topology: " +  name);
                 } else {
                     String serConf = JSONValue.toJSONString(stormConf);
    -                NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser);
                     if(topologyNameExists(conf, name, asUser)) {
                         throw new RuntimeException("Topology with name `" + name + "` already exists on cluster");
                     }
                     String jar = submitJarAs(conf, System.getProperty("storm.jar"), progressListener, asUser);
    -                try {
    -                    LOG.info("Submitting topology " +  name + " in distributed mode with conf " + serConf);
    -                    if(opts!=null) {
    +                try (NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser)) {
    +                    LOG.info("Submitting topology " + name + " in distributed mode with conf " + serConf);
    +                    if (opts != null) {
                             client.getClient().submitTopologyWithOpts(name, jar, serConf, topology, opts);
                         } else {
                             // this is for backwards compatibility
                             client.getClient().submitTopology(name, jar, serConf, topology);
                         }
    -                } catch(InvalidTopologyException e) {
    -                    LOG.warn("Topology submission exception: "+e.get_msg());
    +                    LOG.info("Finished submitting topology: " + name);
    --- End diff --
    
    This statement seems to be misplaced. Missed it before
, Github user satishd commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1446#discussion_r64620395
  
    --- Diff: storm-core/src/jvm/org/apache/storm/StormSubmitter.java ---
    @@ -223,48 +227,65 @@ public static void submitTopologyAs(String name, Map stormConf, StormTopology to
                         // this is for backwards compatibility
                         localNimbus.submitTopology(name, stormConf, topology);
                     }
    +                LOG.info("Finished submitting topology: " +  name);
                 } else {
                     String serConf = JSONValue.toJSONString(stormConf);
    -                NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser);
                     if(topologyNameExists(conf, name, asUser)) {
                         throw new RuntimeException("Topology with name `" + name + "` already exists on cluster");
                     }
                     String jar = submitJarAs(conf, System.getProperty("storm.jar"), progressListener, asUser);
    -                try {
    -                    LOG.info("Submitting topology " +  name + " in distributed mode with conf " + serConf);
    -                    if(opts!=null) {
    +                try (NimbusClient client = NimbusClient.getConfiguredClientAs(conf, asUser)) {
    +                    LOG.info("Submitting topology " + name + " in distributed mode with conf " + serConf);
    +                    if (opts != null) {
                             client.getClient().submitTopologyWithOpts(name, jar, serConf, topology, opts);
                         } else {
                             // this is for backwards compatibility
                             client.getClient().submitTopology(name, jar, serConf, topology);
                         }
    -                } catch(InvalidTopologyException e) {
    -                    LOG.warn("Topology submission exception: "+e.get_msg());
    +                    LOG.info("Finished submitting topology: " + name);
    +                } catch (InvalidTopologyException e) {
    +                    LOG.warn("Topology submission exception: " + e.get_msg());
                         throw e;
    -                } catch(AlreadyAliveException e) {
    +                } catch (AlreadyAliveException e) {
                         LOG.warn("Topology already alive exception", e);
                         throw e;
    -                } finally {
    -                    client.close();
                     }
                 }
    -            LOG.info("Finished submitting topology: " +  name);
    --- End diff --
    
    Right, this is already moved to Line no:245. This message should be there before any error is thrown in closing thrift client.
, Github user ptgoetz commented on the pull request:

    https://github.com/apache/storm/pull/1446#issuecomment-221764594
  
    +1 Thanks for the clarification @satishd!
, Github user satishd commented on the pull request:

    https://github.com/apache/storm/pull/1446
  
    @ptgoetz @harshach Comments/Clarifications are addressed. Can you merge this PR?
, Github user harshach commented on the issue:

    https://github.com/apache/storm/pull/1446
  
    +1
, Github user asfgit closed the pull request at:

    https://github.com/apache/storm/pull/1446
, Github user harshach commented on the issue:

    https://github.com/apache/storm/pull/1446
  
    @satishd merged into master but getting following error on 1.x-branch
    [ERROR] COMPILATION ERROR : 
    [INFO] -------------------------------------------------------------
    [ERROR] /Users/harsha/code/apache/storm/storm-core/src/jvm/org/apache/storm/StormSubmitter.java:[237,35] incompatible types: try-with-resources not applicable to variable type
        (org.apache.storm.utils.NimbusClient cannot be converted to java.lang.AutoCloseable)
    [INFO] 1 error
    [INFO] -------------------------------------------------------------
    [INFO] ------------------------------------------------------------------------
    [INFO] BUILD FAILURE
    [INFO] ------------------------------------------------------------------------
    [INFO] Total time: 9.033 s
    [INFO] Finished at: 2016-06-06T20:00:00-07:00
    [INFO] Final Memory: 43M/927M
    [INFO] ------------------------------------------------------------------------
    [ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.1:compile (default-compile) on project storm-core: Compilation failure
    [ERROR] /Users/harsha/code/apache/storm/storm-core/src/jvm/org/apache/storm/StormSubmitter.java:[237,35] incompatible types: try-with-resources not applicable to variable type
    [ERROR] (org.apache.storm.utils.NimbusClient cannot be converted to java.lang.AutoCloseable)
    [ERROR] -> [Help 1]
    [ERROR] 

, GitHub user satishd opened a pull request:

    https://github.com/apache/storm/pull/1469

    STORM-1864 : StormSubmitter should throw respective exceptions and log respective errors forregistered submitter hook invocation

    Cherry picked form master #1446 and made relevant changes for this branch.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/satishd/storm STORM-1864-1.x

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/storm/pull/1469.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #1469
    
----
commit 6d51bb831af4c57deed901cf7dd59ee99d1a740f
Author: Satish Duggana <sduggana@hortonworks.com>
Date:   2016-05-25T06:21:12Z

    STORM-1864 StormSubmitter should throw respective exceptions and log respective errors forregistered submitter hook invocation.

commit 051b9086ca9ce16f57fb20a6f3e9e102c740bbb2
Author: Satish Duggana <sduggana@hortonworks.com>
Date:   2016-05-25T07:05:26Z

    STORM-1864 log messages with format

commit fc404b595da2bf7199d29b9d06b9452ff17ad0be
Author: Satish Duggana <sduggana@hortonworks.com>
Date:   2016-06-07T04:42:10Z

    STORM-1864 Removed NimbusClient in try-resource-as clause as it is not autocloseable

----
, Github user satishd commented on the issue:

    https://github.com/apache/storm/pull/1446
  
    @harshach Thanks for merging into master. `NimbusClient` is not auto closeable in 1.x branch. Raised #1469, Can you merge that?
, Github user satishd commented on the issue:

    https://github.com/apache/storm/pull/1469
  
    @harshach Can you merge this PR?
, Github user harshach commented on the issue:

    https://github.com/apache/storm/pull/1469
  
    +1
, Github user asfgit closed the pull request at:

    https://github.com/apache/storm/pull/1469
, This should be applied to the 1.0.x-branch as well if it is to be included in the 1.0.2 release., GitHub user satishd opened a pull request:

    https://github.com/apache/storm/pull/1473

    STORM-1864 : StormSubmitter should throw respective exceptions and log respective errors for registered submitter hook invocation 

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/satishd/storm STORM-1864-1.0.x

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/storm/pull/1473.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #1473
    
----
commit 8c3e21e5ea0687ee0c398203a640b084fcc6b38e
Author: Satish Duggana <sduggana@hortonworks.com>
Date:   2016-05-25T06:21:12Z

    STORM-1864 StormSubmitter should throw respective exceptions and log respective errors forregistered submitter hook invocation.

commit a5620b6ac0f78c8c82d231bb82bf38b51e7a3abc
Author: Satish Duggana <sduggana@hortonworks.com>
Date:   2016-05-25T07:05:26Z

    STORM-1864 log messages with format

commit e522615df1db589f05e5171f77c26869207576c5
Author: Satish Duggana <sduggana@hortonworks.com>
Date:   2016-06-07T04:42:10Z

    STORM-1864 Removed NimbusClient in try-resource-as clause as it is not autocloseable

----
, Github user satishd commented on the issue:

    https://github.com/apache/storm/pull/1473
  
    @ptgoetz Pl merge this PR. This is already merged in master and 1.x-branch.
, [~ptgoetz] https://github.com/apache/storm/pull/1473 is raised against 1.0.x branch., Reopened for getting this fix into 1.0.x branch., Github user ptgoetz commented on the issue:

    https://github.com/apache/storm/pull/1473
  
    +1
, Github user asfgit closed the pull request at:

    https://github.com/apache/storm/pull/1473
]