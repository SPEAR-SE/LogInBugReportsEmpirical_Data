[Issue is that current code executes a login from keytab for every instance of the HBase bolt, in a multi threaded environment that corrupts the UGI and the ticket is not renewed.

Added checks around login when using keytab to make sure that is only happens once per process.

https://github.com/apache/storm/pull/1064

, Github user harshach commented on the pull request:

    https://github.com/apache/storm/pull/1064#issuecomment-181798435
  
    @dbahir patch looks good to me. Can you squash multiple commits into single commit. Thanks
, Github user harshach commented on the pull request:

    https://github.com/apache/storm/pull/1064#issuecomment-181811775
  
    @dbahir I think this issue will be in storm-hdfs as well https://github.com/apache/storm/blob/master/external/storm-hdfs/src/main/java/org/apache/storm/hdfs/common/security/HdfsSecurityUtil.java . Can you add changes there as well.
, Github user dbahir commented on the pull request:

    https://github.com/apache/storm/pull/1064#issuecomment-181931344
  
    Squashed the commits.
    
    Took a look at the HDFS bolt code path there is a somewhat different and requires additional testing. Created https://issues.apache.org/jira/browse/STORM-1535 to handle it, will create a separate pull request
, Github user harshach commented on the pull request:

    https://github.com/apache/storm/pull/1064#issuecomment-182400744
  
    +1. @Parth-Brahmbhatt can you review this as well.
, Github user Parth-Brahmbhatt commented on the pull request:

    https://github.com/apache/storm/pull/1064#issuecomment-182469322
  
    @dbahir Does the legacy provider take care of logging in only once internally? 
, Github user dbahir commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1064#discussion_r52486706
  
    --- Diff: external/storm-hbase/src/main/java/org/apache/storm/hbase/security/HBaseSecurityUtil.java ---
    @@ -39,26 +39,34 @@
     
         public static final String STORM_KEYTAB_FILE_KEY = "storm.keytab.file";
         public static final String STORM_USER_NAME_KEY = "storm.kerberos.principal";
    +    private static  UserProvider legacyProvider = null;
     
         public static UserProvider login(Map conf, Configuration hbaseConfig) throws IOException {
             //Allowing keytab based login for backward compatibility.
    -        UserProvider provider = UserProvider.instantiate(hbaseConfig);
    -        if (conf.get(TOPOLOGY_AUTO_CREDENTIALS) == null ||
    -                !(((List) conf.get(TOPOLOGY_AUTO_CREDENTIALS)).contains(AutoHBase.class.getName()))) {
    +        if (UserGroupInformation.isSecurityEnabled() && (conf.get(TOPOLOGY_AUTO_CREDENTIALS) == null ||
    +                !(((List) conf.get(TOPOLOGY_AUTO_CREDENTIALS)).contains(AutoHBase.class.getName())))) {
                 LOG.info("Logging in using keytab as AutoHBase is not specified for " + TOPOLOGY_AUTO_CREDENTIALS);
    -            if (UserGroupInformation.isSecurityEnabled()) {
    -                String keytab = (String) conf.get(STORM_KEYTAB_FILE_KEY);
    -                if (keytab != null) {
    -                    hbaseConfig.set(STORM_KEYTAB_FILE_KEY, keytab);
    +            //insure that if keytab is used only one login per process executed
    +            if(legacyProvider == null) {
    +                synchronized (HBaseSecurityUtil.class) {
    +                    if(legacyProvider == null) {
    --- End diff --
    
    There is a double check pattern here which locks on the class, the lock on the class will ensure that the legacy provider is instantiated and logged in only once per process
, Github user Parth-Brahmbhatt commented on the pull request:

    https://github.com/apache/storm/pull/1064#issuecomment-182478517
  
    Not sure how i missed that you were creating a singleton :-). +1.
, Github user asfgit closed the pull request at:

    https://github.com/apache/storm/pull/1064
]