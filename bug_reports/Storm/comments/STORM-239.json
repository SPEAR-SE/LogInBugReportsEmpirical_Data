[GitHub user apetresc opened a pull request:

    https://github.com/apache/incubator-storm/pull/188

    [STORM-239] Allow supervisor to operate in paths with spaces in them

    Works around a bug in path-escaping for Resources, described here:
    http://bugs.java.com/bugdatabase/view_bug.do?bug_id=4466485

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/apetresc/incubator-storm STORM-239

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/incubator-storm/pull/188.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #188
    
----
commit ebfc0d3de05dbef0479c81ce4274360d1e3c483c
Author: Adrian Petrescu <apetresc@gmail.com>
Date:   2014-07-11T17:18:30Z

    [STORM-239] Allow supervisor to operate in paths with spaces in them
    
    Works around a bug in path-escaping for Resources, described here:
    http://bugs.java.com/bugdatabase/view_bug.do?bug_id=4466485

----
, Okay, I diagnosed this and it is caused by a bug in the JDK when calling `getFile()` on a Resource with spaces in the path (described here: http://bugs.java.com/bugdatabase/view_bug.do?bug_id=4466485).

I applied the recommended workaround, which is to create a `java.net.URI` object for the resource instead.

Tested locally (in a directory with a space in the path) and all tests pass (whereas they did NOT before).

Pull Request is here: https://github.com/apache/incubator-storm/pull/188, Github user d2r commented on a diff in the pull request:

    https://github.com/apache/incubator-storm/pull/188#discussion_r14839191
  
    --- Diff: storm-core/src/clj/backtype/storm/daemon/supervisor.clj ---
    @@ -522,6 +523,7 @@
           (FileUtils/copyDirectory (File. master-code-dir) (File. stormroot))
           (let [classloader (.getContextClassLoader (Thread/currentThread))
                 resources-jar (resources-jar)
    +            uri (URI. (str (.getResource classloader RESOURCES-SUBDIR)))
    --- End diff --
    
    Could do:
    ```Clojure
    ;; Work-around for JDK-4466485
    uri (if-let [url-str (str (.getResource classloader RESOURCES-DIR))]
          (URI. url-str))
    ```
    
    Then replace all `url` with `uri` below.

, Github user d2r commented on the pull request:

    https://github.com/apache/incubator-storm/pull/188#issuecomment-48772740
  
    Good find.  I made one comment about how we can re-use code better, and also since it looks strange, we can put a comment in the code to the effect that this is a work-around for that JDK bug.
, Github user apetresc commented on the pull request:

    https://github.com/apache/incubator-storm/pull/188#issuecomment-48779351
  
    Hey @d2r,
    
    Thanks, I've made your recommended changes (although there was no `else` clause in your `if-let`, and I'm not sure what we could possibly do to recover if `(.getResource classloader RESOURCES-SUBDIR)` was `nil` anyway, so I just kept the `let`).
    
    Commit amended!
, Github user d2r commented on a diff in the pull request:

    https://github.com/apache/incubator-storm/pull/188#discussion_r14843674
  
    --- Diff: storm-core/src/clj/backtype/storm/daemon/supervisor.clj ---
    @@ -522,17 +523,18 @@
           (FileUtils/copyDirectory (File. master-code-dir) (File. stormroot))
           (let [classloader (.getContextClassLoader (Thread/currentThread))
                 resources-jar (resources-jar)
    -            url (.getResource classloader RESOURCES-SUBDIR)
    +            ;; Work-around for JDK-4466485
    +            uri (URI. (str (.getResource classloader RESOURCES-SUBDIR)))
    --- End diff --
    
    I wanted to avoid trying to copy when no resource was found.  Now that we are making a string out of what is returned by .getResource, `uri` won't be `nil` when no resource is foundâ€”it will be a URI with an empty path.  And we do not want to try and do a dir copy from a File with an empty path, since it will likely bring down the supervisor with an exception.
    
    We really want something like:
    ```Clojure
    uri (if-let [url (.getResource classloader RESOURCES-DIR)]
          (URI. (str url)))
    ```
    
    This is slightly corrected from my earlier comment, and with this change:
    
      * If `.getResource` returns `nil`, then `uri` becomes `nil` (no else is needed within `if-let`), and the `cond` does not evaluate the `do` expression paired to `uri` with the `copyDirectory` below.
    
      * If `.getResource` returns a URL, then `uri` becomes a URI of the string of `url`, and `cond` evaluates the `do` expression with the `copyDirectory`.

, Github user apetresc commented on the pull request:

    https://github.com/apache/incubator-storm/pull/188#issuecomment-48784372
  
    @d2r, thanks for the detail, that makes a lot of sense :) Commit amended with all your comments.
, Github user ptgoetz commented on the pull request:

    https://github.com/apache/incubator-storm/pull/188#issuecomment-49932845
  
    This need an upmerge, but other than that I'm +1.
, Github user apetresc commented on the pull request:

    https://github.com/apache/incubator-storm/pull/188#issuecomment-50076920
  
    Upmerged. There were some conflicts and I reworked it a bit to deal with the new logic, but it still works (and allows tests to run in paths with spaces in them)
    
    Let me know if you want these commits squashed before merging!
, Github user apetresc closed the pull request at:

    https://github.com/apache/incubator-storm/pull/188
, Github user apetresc commented on the pull request:

    https://github.com/apache/incubator-storm/pull/188#issuecomment-50649340
  
    Anything else I need to do for this?
, GitHub user apetresc reopened a pull request:

    https://github.com/apache/incubator-storm/pull/188

    [STORM-239] Allow supervisor to operate in paths with spaces in them

    Works around a bug in path-escaping for Resources, described here:
    http://bugs.java.com/bugdatabase/view_bug.do?bug_id=4466485

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/apetresc/incubator-storm STORM-239

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/incubator-storm/pull/188.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #188
    
----
commit dcd4bf7c33c799fca8ea67ba22f1bee7c6b40f4b
Author: Adrian Petrescu <apetresc@gmail.com>
Date:   2014-07-11T17:18:30Z

    [STORM-239] Allow supervisor to operate in paths with spaces in them
    
    Works around a bug in path-escaping for Resources, described here:
    http://bugs.java.com/bugdatabase/view_bug.do?bug_id=4466485

commit 8c89d188a910a57a4e10bc956206c0f16e5d827d
Author: Adrian Petrescu <apetresc@gmail.com>
Date:   2014-07-24T20:53:59Z

    Upmerging with master and fixing merge conflicts

----
, Github user ptgoetz commented on the pull request:

    https://github.com/apache/incubator-storm/pull/188#issuecomment-50649984
  
    @apetresc Nope. Just need more committer +1 in order to merge.
, Github user d2r commented on the pull request:

    https://github.com/apache/incubator-storm/pull/188#issuecomment-50654810
  
    +1
, Github user revans2 commented on the pull request:

    https://github.com/apache/incubator-storm/pull/188#issuecomment-50699284
  
    +1.
, Thanks Adrian,

I merged this into master., Github user asfgit closed the pull request at:

    https://github.com/apache/incubator-storm/pull/188
]