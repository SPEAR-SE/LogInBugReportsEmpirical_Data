[GitHub user ptgoetz opened a pull request:

    https://github.com/apache/incubator-storm/pull/219

    [STORM-447] shade/relocate packages of dependencies that are common causes of dependency conflicts

    This shades and does package relocation of several of Storm's dependencies that frequently conflict with user code (Netty, Guava, etc.).
    
    This also fixes: STORM-356, STORM-268
    
    Note that due to transitive dependencies, some additional dependencies had to be shaded as well (Curator and ZooKeeper).

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/ptgoetz/incubator-storm shading

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/incubator-storm/pull/219.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #219
    
----
commit 1800380c2b70bc0697f43db75777b97bf2acb0e5
Author: P. Taylor Goetz <ptgoetz@gmail.com>
Date:   2014-08-08T03:55:48Z

    shade common sources of dependency conflicts

commit de0aa5af21e4ef424e0e9074223ab8a19e832115
Author: P. Taylor Goetz <ptgoetz@gmail.com>
Date:   2014-08-08T17:56:29Z

    add exclusion for LICENCE.txt in zk jar

commit f51bbad17079ca1251992e3a30834c12fdedbf29
Author: P. Taylor Goetz <ptgoetz@gmail.com>
Date:   2014-08-08T18:35:33Z

    add exclusion for duplicate servlet jar (STORM-356)

----
, Github user ptgoetz commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-53475215
  
    Bump... any other committers have an opinion on this?
, Github user harshach commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-53475612
  
    +1
, Github user nathanmarz commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-53479618
  
    I'm for doing this as much as possible. You're confident these libraries don't use any reflection?
, Github user ptgoetz commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-53488049
  
    @nathanmarz I've tested storm (distributed) with this patch and not seen any issues.
    
    I know guava, netty, and httpclient are clean. I'll do an audit of zookeeper and curator to make sure.
, Github user ptgoetz commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-53492508
  
    I just checked zookeeper and curator and they look okay. There is some reflection in both (mostly in test code), but none of it involves classes from packages that are relocated in this pull request.
, Github user nathanmarz commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-53492850
  
    Thanks for the clarification. I'm +1.
, Github user revans2 commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-53724238
  
    +1
, Github user harshach commented on a diff in the pull request:

    https://github.com/apache/incubator-storm/pull/219#discussion_r16844933
  
    --- Diff: storm-core/pom.xml ---
    @@ -288,6 +298,26 @@
                                 <pattern>org.apache.thrift</pattern>
                                 <shadedPattern>org.apache.thrift7</shadedPattern>
                             </relocation>
    +                        <relocation>
    +                            <pattern>org.jboss.netty</pattern>
    +                            <shadedPattern>org.apache.storm.netty</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>com.google.common</pattern>
    +                            <shadedPattern>org.apache.storm.guava</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>org.apache.http</pattern>
    +                            <shadedPattern>org.apache.storm.http</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>org.apache.zookeeper</pattern>
    +                            <shadedPattern>org.apache.storm.zookeeper</shadedPattern>
    --- End diff --
    
    @ptgoetz this is causing the storm-dist/binary build not to include zookeeper-*.jar in the libs
, Github user ptgoetz commented on a diff in the pull request:

    https://github.com/apache/incubator-storm/pull/219#discussion_r16846611
  
    --- Diff: storm-core/pom.xml ---
    @@ -288,6 +298,26 @@
                                 <pattern>org.apache.thrift</pattern>
                                 <shadedPattern>org.apache.thrift7</shadedPattern>
                             </relocation>
    +                        <relocation>
    +                            <pattern>org.jboss.netty</pattern>
    +                            <shadedPattern>org.apache.storm.netty</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>com.google.common</pattern>
    +                            <shadedPattern>org.apache.storm.guava</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>org.apache.http</pattern>
    +                            <shadedPattern>org.apache.storm.http</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>org.apache.zookeeper</pattern>
    +                            <shadedPattern>org.apache.storm.zookeeper</shadedPattern>
    --- End diff --
    
    @harshach Correct. The ZooKeeper classes are package-relocated and included in the storm-core.jar.
, Github user revans2 commented on a diff in the pull request:

    https://github.com/apache/incubator-storm/pull/219#discussion_r16849273
  
    --- Diff: storm-core/pom.xml ---
    @@ -288,6 +298,26 @@
                                 <pattern>org.apache.thrift</pattern>
                                 <shadedPattern>org.apache.thrift7</shadedPattern>
                             </relocation>
    +                        <relocation>
    +                            <pattern>org.jboss.netty</pattern>
    +                            <shadedPattern>org.apache.storm.netty</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>com.google.common</pattern>
    +                            <shadedPattern>org.apache.storm.guava</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>org.apache.http</pattern>
    +                            <shadedPattern>org.apache.storm.http</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>org.apache.zookeeper</pattern>
    +                            <shadedPattern>org.apache.storm.zookeeper</shadedPattern>
    --- End diff --
    
    I am still +1 on merging this in as is, but like I said on the e-mail list, is there a way we can update the pom.xml before deploying installing it in the maven repo so that our customers don't have to try and do something to force zookeeper to show up.
, Github user ptgoetz commented on a diff in the pull request:

    https://github.com/apache/incubator-storm/pull/219#discussion_r16849948
  
    --- Diff: storm-core/pom.xml ---
    @@ -288,6 +298,26 @@
                                 <pattern>org.apache.thrift</pattern>
                                 <shadedPattern>org.apache.thrift7</shadedPattern>
                             </relocation>
    +                        <relocation>
    +                            <pattern>org.jboss.netty</pattern>
    +                            <shadedPattern>org.apache.storm.netty</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>com.google.common</pattern>
    +                            <shadedPattern>org.apache.storm.guava</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>org.apache.http</pattern>
    +                            <shadedPattern>org.apache.storm.http</shadedPattern>
    +                        </relocation>
    +                        <relocation>
    +                            <pattern>org.apache.zookeeper</pattern>
    +                            <shadedPattern>org.apache.storm.zookeeper</shadedPattern>
    --- End diff --
    
    @revans2 I'm not sure I understand what you mean by "force zookeeper to show up." Can you explain?
, Github user harshach commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-53746148
  
    @ptgoetz @revans2 Sorry!. I ran into ClassNotFoundException: org.apache.zookeeper.data.Stat when I tried to start nimbus and thought the issue might be related to this. But I tested again running storm cluster with above changes and deploying topologies don't see this issue. I am still +1. Thanks.
, Github user asfgit closed the pull request at:

    https://github.com/apache/incubator-storm/pull/219
, Github user revans2 commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-53901704
  
    OK So when you package a jar for storm we use the assembly plugin to pull in all dependencies that the jar has, except for the dependencies that are marked as provided, aka storm and its transitive dependencies.  When we shade one of our dependencies like guava we are no longer packaging guava with storm, but maven still thinks that we are because our pom.xml still say that we have a dependency on it.  As such anyone who actually wants to use guava might compile just fine, but end up with a class not found error when they try to run, because maven was not smart enough to package guava with their jar, because it still thinks storm is packaging it. 
, Github user ptgoetz commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-54369457
  
    @revans2 I just did a bunch of digging related to how the shade plugin handles dependencies. When a shaded artifact is installed or deployed to a maven repository, it is installed with the `dependency-reduced-pom.xml` instead of the original `pom.xml` it was built with. You have the choice of either removing shaded dependencies from the pom, or have them set to `provided` scope.
    
    Currently, our build is configured to set them to `provided` scope, which is actually not what we want, so we need to make the following change to the storm-core pom (which I've already done, just haven't pull requested it yet):
    
    ```
    <keepDependenciesWithProvidedScope>false</keepDependenciesWithProvidedScope>
    ```
    
    When maven builds a jar, it also puts the pom in `META-INF/${groupId}/${artifactId}/pom.xml`. In a shaded jar this will be the original pom, not the dependency reduced one. I'm not aware of any tools that use that pom, most use the pom that's in the maven repository. However, I do have a patched version of the shade plugin that will use the dependency reduced pom instead of the original if we need it.
    
    So long story short we should be able to flip that bit and avoid the scenarios you describe.
, Github user revans2 commented on the pull request:

    https://github.com/apache/incubator-storm/pull/219#issuecomment-54487806
  
    @ptgoetz Sounds good. Please through up a pull request.  
]