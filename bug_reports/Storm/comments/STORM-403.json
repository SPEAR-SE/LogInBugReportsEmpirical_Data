[GitHub user iwasakims opened a pull request:

    https://github.com/apache/incubator-storm/pull/193

    STORM-403: heartbeats-to-nimbus in supervisor-test failed due to uninten...

    ...tional worker launch

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/iwasakims/incubator-storm STORM-403

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/incubator-storm/pull/193.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #193
    
----
commit e6d138e1935ad77099ea8513a1ea3d6141beec82
Author: iwasakims <iwasakims@example.com>
Date:   2014-07-16T13:26:15Z

    STORM-403: heartbeats-to-nimbus in supervisor-test failed due to unintentional worker launch

----
, Github user revans2 commented on the pull request:

    https://github.com/apache/incubator-storm/pull/193#issuecomment-49321437
  
    The code change looks fine to me, and all of the tests still pass.  I am +1.
, Github user revans2 commented on the pull request:

    https://github.com/apache/incubator-storm/pull/193#issuecomment-49321526
  
    I forgot to mention that I'll give others some time to comment before merging this in.
, Github user d2r commented on the pull request:

    https://github.com/apache/incubator-storm/pull/193#issuecomment-49340669
  
    @iwasakims, I am not clear on how this would fix the problem described in the jira.  The bindings for `launch-worker` and `shutdown-worker` would not be used anyway by `advance-cluster-time`.
    
    How can we tell there is an unintentional worker launch that causes a test failure here?  Would that indicate a problem with some other test?
, Github user iwasakims commented on the pull request:

    https://github.com/apache/incubator-storm/pull/193#issuecomment-49348655
  
    @d2r, launch-worker and shutdown-worker are called from sync-processes which called every 3 seconds by even-manager thread in supervisor.
    If you submit-local-topology inside capture-changed-workers, advance-cluster-time also should be called inside the capture-changed-worker because launch-worker and shutdown-worker are mocked only inside it.  If you advance-cluster-time outside capture-changed-worker, actual launch-worker (:local) is called and the test process halt because of interrupt at end of the test.
    ```
    25524 [Thread-14] ERROR backtype.storm.daemon.worker - Error on initialization of server mk-worker
    java.io.InterruptedIOException: null
    	at reply.hacks.printing$print_sequential.invoke(printing.clj:31) ~[na:na]
    	at clojure.core$print_map.invoke(core_print.clj:203) ~[clojure-1.5.1.jar:na]
    	at clojure.core$fn__5431.invoke(core_print.clj:207) ~[clojure-1.5.1.jar:na]
    	at clojure.lang.MultiFn.invoke(MultiFn.java:231) [clojure-1.5.1.jar:na]
    	at clojure.core$pr_on.invoke(core.clj:3322) ~[clojure-1.5.1.jar:na]
    	at clojure.lang.Var.invoke(Var.java:419) ~[clojure-1.5.1.jar:na]
    	at clojure.lang.RT.print(RT.java:1748) [clojure-1.5.1.jar:na]
    	at clojure.lang.RT.printString(RT.java:1727) [clojure-1.5.1.jar:na]
    	at clojure.lang.APersistentMap.toString(APersistentMap.java:21) ~[clojure-1.5.1.jar:na]
    	at clojure.core$str.invoke(core.clj:513) ~[clojure-1.5.1.jar:na]
    	at clojure.core$str$fn__3896.invoke(core.clj:517) ~[clojure-1.5.1.jar:na]
    	at clojure.core$str.doInvoke(core.clj:519) ~[clojure-1.5.1.jar:na]
    	at clojure.lang.RestFn.invoke(RestFn.java:816) [clojure-1.5.1.jar:na]
    	at backtype.storm.daemon.worker$fn__6855$exec_fn__2478__auto____6856.invoke(worker.clj:356) ~[classes/:na]
    	at clojure.lang.AFn.applyToHelper(AFn.java:185) [clojure-1.5.1.jar:na]
    	at clojure.lang.AFn.applyTo(AFn.java:151) [clojure-1.5.1.jar:na]
    	at clojure.core$apply.invoke(core.clj:617) [clojure-1.5.1.jar:na]
    	at backtype.storm.daemon.worker$fn__6855$mk_worker__6911.doInvoke(worker.clj:355) [classes/:na]
    	at clojure.lang.RestFn.invoke(RestFn.java:512) [clojure-1.5.1.jar:na]
    	at backtype.storm.daemon.supervisor$fn__7382.invoke(supervisor.clj:561) [classes/:na]
    	at clojure.lang.MultiFn.invoke(MultiFn.java:241) [clojure-1.5.1.jar:na]
    	at backtype.storm.daemon.supervisor$sync_processes$iter__7226__7230$fn__7231.invoke(supervisor.clj:277) [classes/:na]
    	at clojure.lang.LazySeq.sval(LazySeq.java:42) [clojure-1.5.1.jar:na]
    	at clojure.lang.LazySeq.seq(LazySeq.java:60) [clojure-1.5.1.jar:na]
    	at clojure.lang.RT.seq(RT.java:484) [clojure-1.5.1.jar:na]
    	at clojure.core$seq.invoke(core.clj:133) [clojure-1.5.1.jar:na]
    	at clojure.core$dorun.invoke(core.clj:2780) [clojure-1.5.1.jar:na]
    	at clojure.core$doall.invoke(core.clj:2796) [clojure-1.5.1.jar:na]
    	at backtype.storm.daemon.supervisor$sync_processes.invoke(supervisor.clj:265) [classes/:na]
    	at clojure.lang.AFn.applyToHelper(AFn.java:161) [clojure-1.5.1.jar:na]
    	at clojure.lang.AFn.applyTo(AFn.java:151) [clojure-1.5.1.jar:na]
    	at clojure.core$apply.invoke(core.clj:619) [clojure-1.5.1.jar:na]
    	at clojure.core$partial$fn__4190.doInvoke(core.clj:2396) [clojure-1.5.1.jar:na]
    	at clojure.lang.RestFn.invoke(RestFn.java:397) [clojure-1.5.1.jar:na]
    	at backtype.storm.event$event_manager$fn__4814.invoke(event.clj:39) [classes/:na]
    	at clojure.lang.AFn.run(AFn.java:24) [clojure-1.5.1.jar:na]
    	at java.lang.Thread.run(Thread.java:744) [na:1.7.0_45]
    25525 [Thread-14] INFO  backtype.storm.util - Halting process: ("Error on initialization")
, Github user d2r commented on the pull request:

    https://github.com/apache/incubator-storm/pull/193#issuecomment-49354550
  
    @iwasakims That is clear, thank you.  It is good that you tracked it down.
    
    I am +1 on this change.
    
    I will also file a JIRA to take a look at simulated time and mocking in this and other situations, because I think there may be a deeper issue with these kinds of tests particularly in light of another recent change to mitigate test hangs:
    
    https://github.com/apache/incubator-storm/blob/ff345c1fa9dcbe55e96037bec3b59d06c3f64cd4/storm-core/src/clj/backtype/storm/testing.clj#L237-L240
, Github user asfgit closed the pull request at:

    https://github.com/apache/incubator-storm/pull/193
, Thanks Masatake, I merged this into master., Thanks [~revans2]!]