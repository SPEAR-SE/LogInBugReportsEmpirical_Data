[GitHub user srdo opened a pull request:

    https://github.com/apache/storm/pull/1384

    STORM-1750: Ensure worker dies when report-error-and-die is called. M…

    …ake ZkStateStorage set_data try setting data if node creation fails because the node exists
    
    Similar changes probably need to be made to 0.10.x and 1.x to prevent executors from disappearing until the worker is manually rebooted. The change to ZkStateStorage may not be strictly necessary to fix this issue, but it should reduce the number of exceptions thrown out of set_data due to some component creating a node after another has passed the exists check.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/srdo/storm STORM-1750

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/storm/pull/1384.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #1384
    
----
commit b267c292faffc28be869dfb0424dc729d45808fe
Author: Stig Rohde Døssing <sdo@it-minds.dk>
Date:   2016-04-30T20:50:15Z

    STORM-1750: Ensure worker dies when report-error-and-die is called. Make ZkStateStorage set_data try setting data if node creation fails because the node exists

----
, We've seen this issue manifest as storm-kafka spouts crashing and failing to recover on both 0.10.0 and 1.0.0. In Storm UI it will look like the spout executors keep running but just stop emitting tuples., Github user HeartSaVioR commented on the pull request:

    https://github.com/apache/storm/pull/1384#issuecomment-216463598
  
    +1 
    @srdo Nice finding. Could you address this to 1.x-branch and 0.10.x-branch, too? Thanks in advance!
, Github user srdo commented on the pull request:

    https://github.com/apache/storm/pull/1384#issuecomment-216464027
  
    Hi @HeartSaVioR,
    Sure, I'll make another pair of PRs soon.
, GitHub user srdo opened a pull request:

    https://github.com/apache/storm/pull/1389

    STORM-1750: Ensure worker dies when report-error-and-die is called. M…

    …ake zookeeper_state_factory set-data try setting data if node creation fails because the node exists.
    
    Backport of STORM-1750

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/srdo/storm STORM-1750-1.x

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/storm/pull/1389.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #1389
    
----
commit 6e4bdbc8cacd7621c570126a5d9e8da9f599d037
Author: Stig Rohde Døssing <sdo@it-minds.dk>
Date:   2016-05-03T11:51:13Z

    STORM-1750: Ensure worker dies when report-error-and-die is called. Make zookeeper_state_factory set-data try setting data if node creation fails because the node exists

----
, GitHub user srdo opened a pull request:

    https://github.com/apache/storm/pull/1390

    STORM-1750 (0.10.x): Ensure worker dies when report-error-and-die is …

    …called. Make cluster set-data try setting data if node creation fails because the node exists.
    
    Backport of STORM-1750

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/srdo/storm STORM-1750-0.10.x

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/storm/pull/1390.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #1390
    
----
commit aaf3abf1132db1f22789bd58875367ac75216e37
Author: Stig Rohde Døssing <sdo@it-minds.dk>
Date:   2016-05-03T13:04:27Z

    STORM-1750 (0.10.x): Ensure worker dies when report-error-and-die is called. Make cluster set-data try setting data if node creation fails because the node exists.

----
, Github user Jackyele commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1384#discussion_r62154514
  
    --- Diff: storm-core/src/jvm/org/apache/storm/cluster/ZKStateStorage.java ---
    @@ -189,7 +190,15 @@ public void set_data(String path, byte[] data, List<ACL> acls) {
                 Zookeeper.setData(zkWriter, path, data);
             } else {
                 Zookeeper.mkdirs(zkWriter, Zookeeper.parentPath(path), acls);
    -            Zookeeper.createNode(zkWriter, path, data, CreateMode.PERSISTENT, acls);
    +            try {
    +                Zookeeper.createNode(zkWriter, path, data, CreateMode.PERSISTENT, acls);
    +            } catch (RuntimeException e) {
    --- End diff --
    
    Why not catch NodeExistsException directly
, Github user srdo commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1384#discussion_r62155412
  
    --- Diff: storm-core/src/jvm/org/apache/storm/cluster/ZKStateStorage.java ---
    @@ -189,7 +190,15 @@ public void set_data(String path, byte[] data, List<ACL> acls) {
                 Zookeeper.setData(zkWriter, path, data);
             } else {
                 Zookeeper.mkdirs(zkWriter, Zookeeper.parentPath(path), acls);
    -            Zookeeper.createNode(zkWriter, path, data, CreateMode.PERSISTENT, acls);
    +            try {
    +                Zookeeper.createNode(zkWriter, path, data, CreateMode.PERSISTENT, acls);
    +            } catch (RuntimeException e) {
    --- End diff --
    
    Not sure how? createNode() wraps it in RuntimeException, so it has to be unwrapped first, right? https://github.com/apache/storm/blob/master/storm-core/src/jvm/org/apache/storm/zookeeper/Zookeeper.java#L129
, Github user Jackyele commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1384#discussion_r62157087
  
    --- Diff: storm-core/src/jvm/org/apache/storm/cluster/ZKStateStorage.java ---
    @@ -189,7 +190,15 @@ public void set_data(String path, byte[] data, List<ACL> acls) {
                 Zookeeper.setData(zkWriter, path, data);
             } else {
                 Zookeeper.mkdirs(zkWriter, Zookeeper.parentPath(path), acls);
    -            Zookeeper.createNode(zkWriter, path, data, CreateMode.PERSISTENT, acls);
    +            try {
    +                Zookeeper.createNode(zkWriter, path, data, CreateMode.PERSISTENT, acls);
    +            } catch (RuntimeException e) {
    --- End diff --
    
    yeah, we have to catch RuntimeError first; and how about using **Utils. exceptionCauseIsInstanceOf** instead for consistency, just like https://github.com/apache/storm/blob/master/storm-core/src/jvm/org/apache/storm/zookeeper/Zookeeper.java#L165 does
, Github user srdo commented on a diff in the pull request:

    https://github.com/apache/storm/pull/1384#discussion_r62162389
  
    --- Diff: storm-core/src/jvm/org/apache/storm/cluster/ZKStateStorage.java ---
    @@ -189,7 +190,15 @@ public void set_data(String path, byte[] data, List<ACL> acls) {
                 Zookeeper.setData(zkWriter, path, data);
             } else {
                 Zookeeper.mkdirs(zkWriter, Zookeeper.parentPath(path), acls);
    -            Zookeeper.createNode(zkWriter, path, data, CreateMode.PERSISTENT, acls);
    +            try {
    +                Zookeeper.createNode(zkWriter, path, data, CreateMode.PERSISTENT, acls);
    +            } catch (RuntimeException e) {
    --- End diff --
    
    Good idea, I hadn't noticed that function :)
, Thanks [~Srdo], I merged into master, 1.x, 1.0.x, 0.10.x branches.]