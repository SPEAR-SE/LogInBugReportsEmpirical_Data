{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12914273","self":"https://issues.apache.org/jira/rest/api/2/issue/12914273","key":"ZOOKEEPER-2325","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343268","id":"12343268","description":"Beta release against 3.5 branch","name":"3.5.5","archived":false,"released":false}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-04-27T22:37:43.983+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Apr 14 00:20:11 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":0,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2325/watchers","watchCount":12,"isWatching":false},"created":"2015-11-18T22:21:56.321+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":3600,"aggregatetimeoriginalestimate":3600,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-10T20:09:35.440+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/4","description":"This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/reopened.png","name":"Reopened","id":"4","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":3600,"description":"When loading state from snapshots on startup, FileTxnSnapLog.java ignores the result of FileSnap.deserialize, which is -1L if no valid snapshots are found. Recovery proceeds with dt.lastProcessed == 0, its initial value.\n\nThe result is that Zookeeper will process the transaction logs and then begin serving requests with a different state than the rest of the ensemble.\n\nTo reproduce:\nIn a healthy zookeeper cluster of size >= 3, shut down one node.\nEither delete all snapshots for this node or change all to be empty files.\nRestart the node.\n\nWe believe this can happen organically if a node runs out of disk space.","customfield_10010":null,"timetracking":{"originalEstimate":"1h","remainingEstimate":"1h","originalEstimateSeconds":3600,"remainingEstimateSeconds":3600},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12823508","id":"12823508","filename":"zk.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-12T18:06:26.376+0000","size":1398,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12823508/zk.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12773102","id":"12773102","filename":"ZOOKEEPER-2325.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agrasso","name":"agrasso","key":"agrasso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Grasso","active":true,"timeZone":"Etc/UTC"},"created":"2015-11-18T22:31:02.852+0000","size":846,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12773102/ZOOKEEPER-2325.001.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12801274","id":"12801274","filename":"ZOOKEEPER-2325-test.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agrasso","name":"agrasso","key":"agrasso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Grasso","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-28T16:54:38.744+0000","size":5513,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12801274/ZOOKEEPER-2325-test.patch"}],"aggregatetimeestimate":3600,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Data inconsistency if all snapshots empty or missing","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agrasso","name":"agrasso","key":"agrasso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Grasso","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agrasso","name":"agrasso","key":"agrasso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Grasso","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":3600,"percent":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":3600,"percent":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15012198","id":"15012198","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agrasso","name":"agrasso","key":"agrasso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Grasso","active":true,"timeZone":"Etc/UTC"},"body":"By returning -1L, transaction logs are skipped and recovery succeeds.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agrasso","name":"agrasso","key":"agrasso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Grasso","active":true,"timeZone":"Etc/UTC"},"created":"2015-11-18T22:31:02.855+0000","updated":"2015-11-18T22:31:02.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15261095","id":"15261095","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nwolchko","name":"nwolchko","key":"nwolchko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nicholas Wolchko","active":true,"timeZone":"America/Los_Angeles"},"body":"I've seen some cases where our zookeeper servers lost data, and this looks like it could be the cause. Is there anything blocking this change?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nwolchko","name":"nwolchko","key":"nwolchko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nicholas Wolchko","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-04-27T22:37:43.983+0000","updated":"2016-04-27T22:37:43.983+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15261574","id":"15261574","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"It sounds like this should be easy to reproduce. Do you think you can add a test case for this [~agrasso]?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-04-28T05:41:15.774+0000","updated":"2016-04-28T05:41:15.774+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15262505","id":"15262505","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agrasso","name":"agrasso","key":"agrasso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Grasso","active":true,"timeZone":"Etc/UTC"},"body":"This patch adds a test that fails due to this bug, but succeeds with the submitted patch applied.\n\nI believe the behavior expected by this test is the \"correct\" behavior, but please let me know if my understanding is incorrect.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agrasso","name":"agrasso","key":"agrasso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Grasso","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-28T16:54:38.749+0000","updated":"2016-04-28T16:54:38.749+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15419230","id":"15419230","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"patch for ZOOKEEPER-2325.001.patch to make sure the initial case is handled correctly: the server starts up and logs a few transactions and then restarts. (found because this patch doesn't pass unit tests.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-12T18:06:26.397+0000","updated":"2016-08-12T18:06:26.397+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15514078","id":"15514078","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12823508/zk.patch\n  against trunk revision ec20c5434cc8a334b3fd25e27d26dccf4793c8f3.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3447//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-22T18:23:56.679+0000","updated":"2016-09-22T18:23:56.679+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15706783","id":"15706783","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user breed opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/117\n\n    ZOOKEEPER-2325: Data inconsistency if all snapshots empty or missing\n\n    \n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/breed/zookeeper ZOOKEEPER-2325\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/117.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #117\n    \n----\ncommit 02bf3d57786d51da205e78a070a45703da21f916\nAuthor: Benjamin Reed <br33d@fb.com>\nDate:   2016-11-29T22:08:22Z\n\n    ZOOKEEPER-2325: Data inconsistency if all snapshots empty or missing\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-29T22:39:13.808+0000","updated":"2016-11-29T22:39:13.808+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15706785","id":"15706785","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"hey andrew, i've merged all the patches into a pull request. can you take a look and make sure everything looks ok?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-11-29T22:40:16.901+0000","updated":"2016-11-29T22:40:16.901+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15706823","id":"15706823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agrasso","name":"agrasso","key":"agrasso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Grasso","active":true,"timeZone":"Etc/UTC"},"body":"This looks good to me. Thanks for putting the pull request together.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=agrasso","name":"agrasso","key":"agrasso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Grasso","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-29T22:55:42.532+0000","updated":"2016-11-29T22:55:42.532+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15706861","id":"15706861","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 2 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/93//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/93//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/93//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-29T23:10:53.098+0000","updated":"2016-11-29T23:10:53.098+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15710502","id":"15710502","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user lvfangmin commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/117#discussion_r90368114\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java ---\n    @@ -165,8 +165,22 @@ public File getSnapDir() {\n          */\n         public long restore(DataTree dt, Map<Long, Integer> sessions,\n                 PlayBackListener listener) throws IOException {\n    -        snapLog.deserialize(dt, sessions);\n    +        long deserializeResult = snapLog.deserialize(dt, sessions);\n             FileTxnLog txnLog = new FileTxnLog(dataDir);\n    +        if (-1L == deserializeResult) {\n    +            /* this means that we couldn't find any snapshot, so we need to\n    +             * initialize an empty database */\n    +            if (txnLog.getLastLoggedZxid() != -1) {\n    +                throw new IOException(\n    +                        \"No snapshot found, but there are log entries. \" +\n    +                        \"Something is broken!\");\n    +            }\n    +            /* TODO: (br33d) we should either put a ConcurrentHashMap on restore()\n    +             *       or use Map on save() */\n    +            save(dt, (ConcurrentHashMap<Long, Integer>)sessions);\n    --- End diff --\n    \n    n00b question, why we need to save here? I saw there is potential that the follower will sync with with leader just to send over the empty snapshot.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T01:37:53.013+0000","updated":"2016-12-01T01:37:53.013+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15710994","id":"15710994","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 8 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/95//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/95//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/95//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T05:50:13.963+0000","updated":"2016-12-01T05:50:13.963+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15712489","id":"15712489","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rgs1 commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/117#discussion_r90490925\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java ---\n    @@ -165,8 +165,22 @@ public File getSnapDir() {\n          */\n         public long restore(DataTree dt, Map<Long, Integer> sessions,\n                 PlayBackListener listener) throws IOException {\n    -        snapLog.deserialize(dt, sessions);\n    +        long deserializeResult = snapLog.deserialize(dt, sessions);\n             FileTxnLog txnLog = new FileTxnLog(dataDir);\n    +        if (-1L == deserializeResult) {\n    +            /* this means that we couldn't find any snapshot, so we need to\n    +             * initialize an empty database */\n    --- End diff --\n    \n    nit: can you add a reference to ZOOKEEPER-2325 here?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T17:06:36.733+0000","updated":"2016-12-01T17:06:36.733+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15712490","id":"15712490","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rgs1 commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/117#discussion_r90491384\n  \n    --- Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java ---\n    @@ -0,0 +1,134 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +\n    +package org.apache.zookeeper.test;\n    +\n    +import java.io.IOException;\n    +import java.io.File;\n    +import java.io.PrintWriter;\n    +import java.util.List;\n    +import java.util.LinkedList;\n    +\n    +import org.apache.log4j.Logger;\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.WatchedEvent;\n    +import org.apache.zookeeper.Watcher;\n    +import org.apache.zookeeper.ZKTestCase;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.server.quorum.Leader.Proposal;\n    +import org.apache.zookeeper.server.ServerCnxnFactory;\n    +import org.apache.zookeeper.server.SyncRequestProcessor;\n    +import org.apache.zookeeper.server.ZooKeeperServer;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +/** If snapshots are corrupted to the empty file or deleted, Zookeeper should \n    + *  not proceed to read its transactiong log files\n    + *  Test that zxid == -1 in the presence of emptied/deleted snapshots\n    + */\n    +public class EmptiedSnapshotRecoveryTest extends ZKTestCase implements  Watcher {\n    +    private static final Logger LOG = Logger.getLogger(RestoreCommittedLogTest.class);\n    +    private static String HOSTPORT = \"127.0.0.1:\" + PortAssignment.unique();\n    +    private static final int CONNECTION_TIMEOUT = 3000;\n    +    private static final int N_TRANSACTIONS = 150;\n    +    private static final int SNAP_COUNT = 100;\n    +\n    +    public void runTest(boolean leaveEmptyFile) throws Exception {\n    +        File tmpSnapDir = ClientBase.createTmpDir();\n    +        File tmpLogDir  = ClientBase.createTmpDir();\n    +        ClientBase.setupTestEnv();\n    +        ZooKeeperServer zks = new ZooKeeperServer(tmpSnapDir, tmpLogDir, 3000);\n    +        SyncRequestProcessor.setSnapCount(SNAP_COUNT);\n    +        final int PORT = Integer.parseInt(HOSTPORT.split(\":\")[1]);\n    +        ServerCnxnFactory f = ServerCnxnFactory.createFactory(PORT, -1);\n    +        f.startup(zks);\n    +        Assert.assertTrue(\"waiting for server being up \",\n    +                ClientBase.waitForServerUp(HOSTPORT,CONNECTION_TIMEOUT));\n    +        ZooKeeper zk = new ZooKeeper(HOSTPORT, CONNECTION_TIMEOUT, this);\n    +        try {\n    +            for (int i = 0; i< N_TRANSACTIONS; i++) {\n    +                zk.create(\"/node-\" + i, new byte[0], Ids.OPEN_ACL_UNSAFE,\n    +                        CreateMode.PERSISTENT);\n    +            }\n    +        } finally {\n    +            zk.close();\n    +        }\n    +        f.shutdown();\n    +        zks.shutdown();\n    +        Assert.assertTrue(\"waiting for server to shutdown\",\n    +                ClientBase.waitForServerDown(HOSTPORT, CONNECTION_TIMEOUT));\n    +\n    +        // start server again with intact database\n    +        zks = new ZooKeeperServer(tmpSnapDir, tmpLogDir, 3000);\n    +        zks.startdata();\n    +        long zxid = zks.getZKDatabase().getDataTreeLastProcessedZxid();\n    +        LOG.info(\"After clean restart, zxid = \" + zxid);\n    +        Assert.assertTrue(\"zxid > 0\", zxid > 0);\n    +        zks.shutdown();\n    +\n    +        // Make all snapshots empty\n    +        FileTxnSnapLog txnLogFactory = zks.getTxnLogFactory();\n    +        List<File> snapshots = txnLogFactory.findNRecentSnapshots(10);\n    +        Assert.assertTrue(\"We have a snapshot to corrupt\", snapshots.size() > 0);\n    +        for (File file: snapshots) {\n    +            if (leaveEmptyFile) {\n    +                new PrintWriter(file).close ();\n    +            }\n    +            else {\n    --- End diff --\n    \n    nit: coding style `} else {`\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T17:06:36.752+0000","updated":"2016-12-01T17:06:36.752+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15712832","id":"15712832","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/117\n  \n    +1, just one comment on test coverage.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T19:24:04.602+0000","updated":"2016-12-01T19:24:04.602+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15712900","id":"15712900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user breed commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/117#discussion_r90523518\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java ---\n    @@ -165,8 +165,22 @@ public File getSnapDir() {\n          */\n         public long restore(DataTree dt, Map<Long, Integer> sessions,\n                 PlayBackListener listener) throws IOException {\n    -        snapLog.deserialize(dt, sessions);\n    +        long deserializeResult = snapLog.deserialize(dt, sessions);\n             FileTxnLog txnLog = new FileTxnLog(dataDir);\n    +        if (-1L == deserializeResult) {\n    +            /* this means that we couldn't find any snapshot, so we need to\n    +             * initialize an empty database */\n    +            if (txnLog.getLastLoggedZxid() != -1) {\n    +                throw new IOException(\n    +                        \"No snapshot found, but there are log entries. \" +\n    +                        \"Something is broken!\");\n    +            }\n    +            /* TODO: (br33d) we should either put a ConcurrentHashMap on restore()\n    +             *       or use Map on save() */\n    +            save(dt, (ConcurrentHashMap<Long, Integer>)sessions);\n    --- End diff --\n    \n    yes, ZOOKEEPER-261 is still a problem. is that what you are referring to? brian has a patch coming that builds on this one to fix that problem.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T19:51:06.965+0000","updated":"2016-12-01T19:51:06.965+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15712905","id":"15712905","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user breed commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/117#discussion_r90523812\n  \n    --- Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java ---\n    @@ -0,0 +1,134 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +\n    +package org.apache.zookeeper.test;\n    +\n    +import java.io.IOException;\n    +import java.io.File;\n    +import java.io.PrintWriter;\n    +import java.util.List;\n    +import java.util.LinkedList;\n    +\n    +import org.apache.log4j.Logger;\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.WatchedEvent;\n    +import org.apache.zookeeper.Watcher;\n    +import org.apache.zookeeper.ZKTestCase;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.server.quorum.Leader.Proposal;\n    +import org.apache.zookeeper.server.ServerCnxnFactory;\n    +import org.apache.zookeeper.server.SyncRequestProcessor;\n    +import org.apache.zookeeper.server.ZooKeeperServer;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +/** If snapshots are corrupted to the empty file or deleted, Zookeeper should \n    + *  not proceed to read its transactiong log files\n    + *  Test that zxid == -1 in the presence of emptied/deleted snapshots\n    + */\n    +public class EmptiedSnapshotRecoveryTest extends ZKTestCase implements  Watcher {\n    +    private static final Logger LOG = Logger.getLogger(RestoreCommittedLogTest.class);\n    +    private static String HOSTPORT = \"127.0.0.1:\" + PortAssignment.unique();\n    +    private static final int CONNECTION_TIMEOUT = 3000;\n    +    private static final int N_TRANSACTIONS = 150;\n    +    private static final int SNAP_COUNT = 100;\n    +\n    +    public void runTest(boolean leaveEmptyFile) throws Exception {\n    +        File tmpSnapDir = ClientBase.createTmpDir();\n    +        File tmpLogDir  = ClientBase.createTmpDir();\n    +        ClientBase.setupTestEnv();\n    +        ZooKeeperServer zks = new ZooKeeperServer(tmpSnapDir, tmpLogDir, 3000);\n    +        SyncRequestProcessor.setSnapCount(SNAP_COUNT);\n    +        final int PORT = Integer.parseInt(HOSTPORT.split(\":\")[1]);\n    +        ServerCnxnFactory f = ServerCnxnFactory.createFactory(PORT, -1);\n    +        f.startup(zks);\n    +        Assert.assertTrue(\"waiting for server being up \",\n    +                ClientBase.waitForServerUp(HOSTPORT,CONNECTION_TIMEOUT));\n    +        ZooKeeper zk = new ZooKeeper(HOSTPORT, CONNECTION_TIMEOUT, this);\n    +        try {\n    +            for (int i = 0; i< N_TRANSACTIONS; i++) {\n    +                zk.create(\"/node-\" + i, new byte[0], Ids.OPEN_ACL_UNSAFE,\n    +                        CreateMode.PERSISTENT);\n    +            }\n    +        } finally {\n    +            zk.close();\n    +        }\n    +        f.shutdown();\n    +        zks.shutdown();\n    +        Assert.assertTrue(\"waiting for server to shutdown\",\n    +                ClientBase.waitForServerDown(HOSTPORT, CONNECTION_TIMEOUT));\n    +\n    +        // start server again with intact database\n    +        zks = new ZooKeeperServer(tmpSnapDir, tmpLogDir, 3000);\n    +        zks.startdata();\n    +        long zxid = zks.getZKDatabase().getDataTreeLastProcessedZxid();\n    +        LOG.info(\"After clean restart, zxid = \" + zxid);\n    +        Assert.assertTrue(\"zxid > 0\", zxid > 0);\n    +        zks.shutdown();\n    +\n    +        // Make all snapshots empty\n    +        FileTxnSnapLog txnLogFactory = zks.getTxnLogFactory();\n    +        List<File> snapshots = txnLogFactory.findNRecentSnapshots(10);\n    +        Assert.assertTrue(\"We have a snapshot to corrupt\", snapshots.size() > 0);\n    +        for (File file: snapshots) {\n    +            if (leaveEmptyFile) {\n    +                new PrintWriter(file).close ();\n    +            }\n    +            else {\n    --- End diff --\n    \n    yes that is ugly!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T19:52:30.161+0000","updated":"2016-12-01T19:52:30.161+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15712961","id":"15712961","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user breed commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/117\n  \n    @hanm i can't seem to find your comment :)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T20:15:45.600+0000","updated":"2016-12-01T20:15:45.600+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15713015","id":"15713015","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/117#discussion_r90516233\n  \n    --- Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java ---\n    @@ -0,0 +1,134 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +\n    +package org.apache.zookeeper.test;\n    +\n    +import java.io.IOException;\n    +import java.io.File;\n    +import java.io.PrintWriter;\n    +import java.util.List;\n    +import java.util.LinkedList;\n    +\n    +import org.apache.log4j.Logger;\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.WatchedEvent;\n    +import org.apache.zookeeper.Watcher;\n    +import org.apache.zookeeper.ZKTestCase;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.server.quorum.Leader.Proposal;\n    +import org.apache.zookeeper.server.ServerCnxnFactory;\n    +import org.apache.zookeeper.server.SyncRequestProcessor;\n    +import org.apache.zookeeper.server.ZooKeeperServer;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +/** If snapshots are corrupted to the empty file or deleted, Zookeeper should \n    + *  not proceed to read its transactiong log files\n    + *  Test that zxid == -1 in the presence of emptied/deleted snapshots\n    + */\n    +public class EmptiedSnapshotRecoveryTest extends ZKTestCase implements  Watcher {\n    +    private static final Logger LOG = Logger.getLogger(RestoreCommittedLogTest.class);\n    +    private static String HOSTPORT = \"127.0.0.1:\" + PortAssignment.unique();\n    +    private static final int CONNECTION_TIMEOUT = 3000;\n    +    private static final int N_TRANSACTIONS = 150;\n    +    private static final int SNAP_COUNT = 100;\n    +\n    +    public void runTest(boolean leaveEmptyFile) throws Exception {\n    --- End diff --\n    \n    Test coverage improvement suggestion: here we don't cover the case where both transaction log files and snap shot files are missing (either deleted, or empty) - in which case the ZK server should happily recover w/o problem. Something like this should work: `runTest(boolean leaveEmptySnapshotFile, boolean leaveEmptyTxnLogFile)`.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T20:38:34.864+0000","updated":"2016-12-01T20:38:34.864+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15713016","id":"15713016","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/117#discussion_r90516950\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java ---\n    @@ -165,8 +165,22 @@ public File getSnapDir() {\n          */\n         public long restore(DataTree dt, Map<Long, Integer> sessions,\n                 PlayBackListener listener) throws IOException {\n    -        snapLog.deserialize(dt, sessions);\n    +        long deserializeResult = snapLog.deserialize(dt, sessions);\n             FileTxnLog txnLog = new FileTxnLog(dataDir);\n    +        if (-1L == deserializeResult) {\n    +            /* this means that we couldn't find any snapshot, so we need to\n    +             * initialize an empty database */\n    +            if (txnLog.getLastLoggedZxid() != -1) {\n    +                throw new IOException(\n    +                        \"No snapshot found, but there are log entries. \" +\n    +                        \"Something is broken!\");\n    +            }\n    +            /* TODO: (br33d) we should either put a ConcurrentHashMap on restore()\n    +             *       or use Map on save() */\n    +            save(dt, (ConcurrentHashMap<Long, Integer>)sessions);\n    --- End diff --\n    \n    I think we need it here because if we are getting here then the zxid of this server must be -1, so it would not win leader election if at least one other server is sane (with valid snapshot/txn log to recover.), so this server will become a follow and sync the (none empty) snapshot from the leader. If all servers have empty snapshots then this save is also required to bootstrap the recover process.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T20:38:34.868+0000","updated":"2016-12-01T20:38:34.868+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15713018","id":"15713018","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/117\n  \n    @breed I think I commented by started a review but not submitted - haven't used this github feature until now. Just submitted my comments, they should appear now.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T20:39:39.183+0000","updated":"2016-12-01T20:39:39.183+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15713392","id":"15713392","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 8 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/96//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/96//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/96//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-01T23:21:39.883+0000","updated":"2016-12-01T23:21:39.883+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15718424","id":"15718424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rgs1 commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/117#discussion_r90761121\n  \n    --- Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java ---\n    @@ -0,0 +1,134 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +\n    +package org.apache.zookeeper.test;\n    +\n    +import java.io.IOException;\n    +import java.io.File;\n    +import java.io.PrintWriter;\n    +import java.util.List;\n    +import java.util.LinkedList;\n    +\n    +import org.apache.log4j.Logger;\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.WatchedEvent;\n    +import org.apache.zookeeper.Watcher;\n    +import org.apache.zookeeper.ZKTestCase;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.server.quorum.Leader.Proposal;\n    +import org.apache.zookeeper.server.ServerCnxnFactory;\n    +import org.apache.zookeeper.server.SyncRequestProcessor;\n    +import org.apache.zookeeper.server.ZooKeeperServer;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +/** If snapshots are corrupted to the empty file or deleted, Zookeeper should \n    + *  not proceed to read its transactiong log files\n    + *  Test that zxid == -1 in the presence of emptied/deleted snapshots\n    + */\n    +public class EmptiedSnapshotRecoveryTest extends ZKTestCase implements  Watcher {\n    +    private static final Logger LOG = Logger.getLogger(RestoreCommittedLogTest.class);\n    +    private static String HOSTPORT = \"127.0.0.1:\" + PortAssignment.unique();\n    +    private static final int CONNECTION_TIMEOUT = 3000;\n    +    private static final int N_TRANSACTIONS = 150;\n    +    private static final int SNAP_COUNT = 100;\n    +\n    +    public void runTest(boolean leaveEmptyFile) throws Exception {\n    --- End diff --\n    \n    @breed do you want to take @hanm's suggestion or should I merge this and we get that in another pass?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-03T17:21:43.801+0000","updated":"2016-12-03T17:21:43.801+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15720874","id":"15720874","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user breed commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/117#discussion_r90791441\n  \n    --- Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java ---\n    @@ -0,0 +1,134 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +\n    +package org.apache.zookeeper.test;\n    +\n    +import java.io.IOException;\n    +import java.io.File;\n    +import java.io.PrintWriter;\n    +import java.util.List;\n    +import java.util.LinkedList;\n    +\n    +import org.apache.log4j.Logger;\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.WatchedEvent;\n    +import org.apache.zookeeper.Watcher;\n    +import org.apache.zookeeper.ZKTestCase;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.server.quorum.Leader.Proposal;\n    +import org.apache.zookeeper.server.ServerCnxnFactory;\n    +import org.apache.zookeeper.server.SyncRequestProcessor;\n    +import org.apache.zookeeper.server.ZooKeeperServer;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +/** If snapshots are corrupted to the empty file or deleted, Zookeeper should \n    + *  not proceed to read its transactiong log files\n    + *  Test that zxid == -1 in the presence of emptied/deleted snapshots\n    + */\n    +public class EmptiedSnapshotRecoveryTest extends ZKTestCase implements  Watcher {\n    +    private static final Logger LOG = Logger.getLogger(RestoreCommittedLogTest.class);\n    +    private static String HOSTPORT = \"127.0.0.1:\" + PortAssignment.unique();\n    +    private static final int CONNECTION_TIMEOUT = 3000;\n    +    private static final int N_TRANSACTIONS = 150;\n    +    private static final int SNAP_COUNT = 100;\n    +\n    +    public void runTest(boolean leaveEmptyFile) throws Exception {\n    --- End diff --\n    \n    i think we should skip that test. we have a fix for ZOOKEEPER-261 that fixes that specific scenario.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-05T00:36:58.601+0000","updated":"2016-12-05T00:36:58.601+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15752196","id":"15752196","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"[~rgs] can you commit this? we need it to get ZOOKEEPER-261 in.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-12-15T19:02:31.518+0000","updated":"2016-12-15T19:02:31.518+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15752213","id":"15752213","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"I noticed that the pull request of ZOOKEEPER-261 contains changes in ZOOKEEPER-2325 already: https://github.com/apache/zookeeper/pull/120/commits\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2016-12-15T19:07:58.080+0000","updated":"2016-12-15T19:07:58.080+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15805547","id":"15805547","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"body":"Any word on committing this patch? I'd love to unblock ZOOKEEPER-261.\n\n[~fpj] ?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-06T19:53:37.663+0000","updated":"2017-01-06T19:53:37.663+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15805924","id":"15805924","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"I could help committing this one as the patch is reviewed. [~nixon] I thought you just need the PR associated with ZOOKEEPER-261 whose change is a superset of this JIRA (and committing both same time would probably save your some effort on rebase, if any), but probably separation of concern is better..","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-01-06T22:04:39.008+0000","updated":"2017-01-06T22:04:39.008+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15806240","id":"15806240","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/117\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-07T00:10:18.224+0000","updated":"2017-01-07T00:10:18.224+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15806241","id":"15806241","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"Issue resolved by pull request 117\n[https://github.com/apache/zookeeper/pull/117]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-01-07T00:10:36.938+0000","updated":"2017-01-07T00:10:36.938+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15806250","id":"15806250","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"[~nixon] [~breed] merged in master and 3.5. \n\nI think we also want this in 3.4, but there is a merge conflict, so that merge will be handled separately. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-01-07T00:15:13.767+0000","updated":"2017-01-07T00:15:13.767+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15806330","id":"15806330","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user hanm opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/144\n\n    ZOOKEEPER-2325 for branch-3.4.\n\n    There was a merge conflict on file Zab1_0Test.java when cherry-picking commit 7c51b01e89acb38165553366f7e3b2a46c00aa27 to branch-3.4. This PR resolves the merge conflict (it is trivial, just two imports conflicts).\n    \n    @breed @rgs1 @rakeshadr Please take a look and help committing this thanks.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/hanm/zookeeper ZOOKEEPER-2325\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/144.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #144\n    \n----\ncommit afd34f286c860591f1e26b1c29539b322cef7bcc\nAuthor: Benjamin Reed <br33d@fb.com>\nDate:   2017-01-07T00:09:54Z\n\n    ZOOKEEPER-2325 (Data inconsistency if all snapshots empty or missing) for branch-3.4.\n    Resolved merge conflict on Zab1_0Test.java when cherry-picking 7c51b01e89acb38165553366f7e3b2a46c00aa27.\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-07T00:51:55.112+0000","updated":"2017-01-07T00:51:55.112+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15806336","id":"15806336","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"Reopen issue as patch is not merged in branch-3.4. Resolve the issue after https://github.com/apache/zookeeper/pull/144 merged in.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-01-07T00:53:03.064+0000","updated":"2017-01-07T00:53:03.064+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15806362","id":"15806362","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #3227 (See [https://builds.apache.org/job/ZooKeeper-trunk/3227/])\nZOOKEEPER-2325: Data inconsistency if all snapshots empty or missing (hanm: rev 7c51b01e89acb38165553366f7e3b2a46c00aa27)\n* (edit) src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java\n* (edit) src/java/test/org/apache/zookeeper/test/TruncateTest.java\n* (add) src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java\n* (edit) src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-07T01:04:48.147+0000","updated":"2017-01-07T01:04:48.147+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15810600","id":"15810600","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"body":"Thanks [~hanm]!\n\nGlad we kept the changes for this task and 261 separate. I'll make sure that https://github.com/apache/zookeeper/pull/120 still commits cleanly and update that PR as necessary.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-09T04:01:15.080+0000","updated":"2017-01-09T04:01:15.080+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15827048","id":"15827048","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/144#discussion_r96526559\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java ---\n    @@ -135,8 +135,22 @@ public File getSnapDir() {\n          */\n         public long restore(DataTree dt, Map<Long, Integer> sessions, \n                 PlayBackListener listener) throws IOException {\n    -        snapLog.deserialize(dt, sessions);\n    +        long deserializeResult = snapLog.deserialize(dt, sessions);\n             FileTxnLog txnLog = new FileTxnLog(dataDir);\n    +        if (-1L == deserializeResult) {\n    +            /* this means that we couldn't find any snapshot, so we need to\n    +             * initialize an empty database (reported in ZOOKEEPER-2325) */\n    +            if (txnLog.getLastLoggedZxid() != -1) {\n    --- End diff --\n    \n    would it be worth adding the -1 case to the javadoc for deserialize?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-17T23:30:39.661+0000","updated":"2017-01-17T23:30:39.661+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15827049","id":"15827049","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/144#discussion_r96534436\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java ---\n    @@ -37,6 +37,8 @@\n     import java.util.ArrayList;\n     import java.util.HashMap;\n     import java.util.List;\n    +import java.util.concurrent.ConcurrentHashMap;\n    +import java.util.Map;\n    --- End diff --\n    \n    this change appears to break `testDirtySnapshot`\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-17T23:30:39.664+0000","updated":"2017-01-17T23:30:39.664+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15827050","id":"15827050","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/144#discussion_r96534854\n  \n    --- Diff: src/java/test/org/apache/zookeeper/test/EmptiedSnapshotRecoveryTest.java ---\n    @@ -0,0 +1,133 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +\n    +package org.apache.zookeeper.test;\n    +\n    +import java.io.IOException;\n    +import java.io.File;\n    +import java.io.PrintWriter;\n    +import java.util.List;\n    +import java.util.LinkedList;\n    --- End diff --\n    \n    a couple unneeded imports here as well\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-17T23:30:39.701+0000","updated":"2017-01-17T23:30:39.701+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15827051","id":"15827051","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/144#discussion_r96525078\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java ---\n    @@ -37,6 +37,8 @@\n     import java.util.ArrayList;\n     import java.util.HashMap;\n     import java.util.List;\n    +import java.util.concurrent.ConcurrentHashMap;\n    +import java.util.Map;\n    --- End diff --\n    \n    nit: i don't think that this import is needed\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-17T23:30:39.701+0000","updated":"2017-01-17T23:30:39.701+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15827431","id":"15827431","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/144#discussion_r96568373\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java ---\n    @@ -37,6 +37,8 @@\n     import java.util.ArrayList;\n     import java.util.HashMap;\n     import java.util.List;\n    +import java.util.concurrent.ConcurrentHashMap;\n    +import java.util.Map;\n    --- End diff --\n    \n    Good catch, @afine. This test is related to ZOOKEEPER-1558. Perhaps, we need to re-look the fix to see any chance of creating snapshot with uncommitted state.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-18T05:07:07.697+0000","updated":"2017-01-18T05:07:07.697+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15963604","id":"15963604","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bothra90","name":"bothra90","key":"bothra90","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abhay Bothra","active":true,"timeZone":"America/Los_Angeles"},"body":"We saw a scenario where the zookeeper cluster had a log.1 file, but no snapshot.0. Is this a possible state of the data dir? If yes, this change prevents Zookeeper from restoring from just a txn log.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bothra90","name":"bothra90","key":"bothra90","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abhay Bothra","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-04-10T22:44:29.643+0000","updated":"2017-04-10T22:44:47.284+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914273/comment/15968437","id":"15968437","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"body":"When a server starts up, it should always capture the state of the loaded database with a fresh snapshot. I don't believe it is a valid state to have a log file without a snapshot file.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"created":"2017-04-14T00:20:11.358+0000","updated":"2017-04-14T00:20:11.358+0000"}],"maxResults":42,"total":42,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2325/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2oluf:"}}