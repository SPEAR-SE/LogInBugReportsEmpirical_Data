{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12473242","self":"https://issues.apache.org/jira/rest/api/2/issue/12473242","key":"ZOOKEEPER-863","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Sep 03 18:50:39 UTC 2010","customfield_12310420":"214195","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-863/watchers","watchCount":2,"isWatching":false},"created":"2010-09-03T14:33:42.750+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313976","id":"12313976","description":"Improved manageability and simplified client development process.","name":"3.3.0","archived":false,"released":true,"releaseDate":"2010-03-25"}],"issuelinks":[{"id":"12333719","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12333719","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"inwardIssue":{"id":"12473247","key":"ZOOKEEPER-865","self":"https://issues.apache.org/jira/rest/api/2/issue/12473247","fields":{"summary":"Runaway thread","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-09-03T18:52:11.514+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"I'm running Zookeeper inside an Eclipse application.  When I launch the application from inside Eclipse I use the following arguments:\n\n-Dzoodiscovery.autoStart=true\n-Dzoodiscovery.flavor=zoodiscovery.flavor.centralized=localhost\n\nThis causes the application to start its own ZooKeeper server inside the JVM/application.  It immediately goes into a runaway state.  The name of the runaway thread is \"NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181\".  When I suspend this thread, the CPU usage returns to 0.  Here is a stack trace from that thread when it is suspended:\n\nEPollArrayWrapper.epollWait(long, int, long, int) line: not available [native method]\t\nEPollArrayWrapper.poll(long) line: 215\t\nEPollSelectorImpl.doSelect(long) line: 77\t\nEPollSelectorImpl(SelectorImpl).lockAndDoSelect(long) line: 69\t\nEPollSelectorImpl(SelectorImpl).select(long) line: 80\t\nNIOServerCnxn$Factory.run() line: 232\t\n\nAny ideas what might be going wrong?\n\nThanks.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12453806","id":"12453806","filename":"zookeeper.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smccants","name":"smccants","key":"smccants","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen McCants","active":true,"timeZone":"America/Chicago"},"created":"2010-09-03T18:52:10.804+0000","size":6511071,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12453806/zookeeper.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32842","customfield_12312823":null,"summary":"Runaway thread - Zookeeper inside Eclipse","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smccants","name":"smccants","key":"smccants","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen McCants","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smccants","name":"smccants","key":"smccants","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen McCants","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux; x86","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473242/comment/12906012","id":"12906012","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smccants","name":"smccants","key":"smccants","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen McCants","active":true,"timeZone":"America/Chicago"},"body":"Okay, one of my coworkers was able to figure out some more about this. First off, the zookeeper.log file shows it spinning trying to request the discovery root over and over again. (I'll attach the log file).\n\nWe are using Eclipse CM (Configuration Manager) to start the service that registers with ZooKeeper. First we start the Eclipse based application (call it app1) that starts ZooKeeper internally (as described above). ZooKeeper immediately goes into its infinite loop.\n\nThen I can start a different Eclipse based application (call it app2) which uses has a service (LoadLevelerJobService) that registers with ZooKeeper. If the service was started previously, then it will register with ZK, but ZK will stay in the infinite loop.\n\nHere is the output for that:\n\nZooDiscovery> Service Unpublished: Sep 3, 2010 12:23:48 PM. ServiceInfo[uri=osgiservices://9.53.189.11:30001/svc_47oWIw/Wrs4W/KQiV3f78Ggucu0=;id=ServiceID[type=ServiceTypeID[typeName=_osgiservices._tcp.default._iana];location=osgiservices://9.53.189.11:30001/svc_47oWIw/Wrs4W/KQiV3f78Ggucu0=;full=_osgiservices._tcp.default._iana@osgiservices://9.53.189.11:30001/svc_47oWIw/Wrs4W/KQiV3f78Ggucu0=];priority=0;weight=0;props=ServiceProperties[{com.ibm.hdwb.jobs.common.monitor.port=9020, ecf.sp.ect=ecf.generic.server, com.ibm.hdwb.jobs.common.monitor.command=/afs/awd/projects/cte/tools/hdwb/prod/llmonitor/monitor.ksh, component.id=18, com.ibm.hdwb.jobs.common.monitor.host=smccants.austin.ibm.com, component.name=com.ibm.hdwb.ll.server.job_queue_service, ecf.rsvc.id=org.eclipse.ecf.discovery.ServiceProperties$ByteArrayWrapper@fec0fec, ll_submit_command=, ecf.sp.cid=org.eclipse.ecf.discovery.ServiceProperties$ByteArrayWrapper@6160616, com.ibm.hdwb.jobs.common.pool.uuid=dd38f018-b15e-4981-b71a-0453ea307634, com.ibm.hdwb.jobs.common.monitor.submitter=smccants, service.factoryPid=com.ibm.hdwb.ll.server.job_queue_service, service.pid=com.ibm.hdwb.ll.server.job_queue_service-1283452175751-0, com.ibm.hdwb.jobs.common.monitor.restlet.port=8080, osgi.remote.service.interfaces=com.ibm.hdwb.jobs.common.IJobQueueService, ecf.rsvc.ns=ecf.namespace.generic.remoteservice, ecf.sp.cns=org.eclipse.ecf.core.identity.StringID, com.ibm.hdwb.jobs.common.monitor.restlet.host=smccants.austin.ibm.com}]]\nActivating LoadLevelerJobService\n  Pool : null\n  Monitor Command : /afs/awd/projects/cte/tools/hdwb/prod/llmonitor/monitor.ksh\n  Monitor Host : smccants.austin.ibm.com\n  Monitor Port : 9020\n  Submit Command :\nActivating LoadLevelerJobLocatorService\n12:23:48.838 [1120420552@qtp-1972401552-0 - /system/console/configMgr/com.ibm.hdwb.ll.server.job_queue_service-1283452175751-0] DEBUG org.mortbay.log - RESPONSE /system/console/configMgr/com.ibm.hdwb.ll.server.job_queue_service-1283452175751-0 200\nZooDiscovery> Service Published: Sep 3, 2010 12:23:48 PM. ServiceInfo[uri=osgiservices://9.53.189.11:30001/svc_NgkGKIokGDJC86wytsCHPug3a1E=;id=ServiceID[type=ServiceTypeID[typeName=_osgiservices._tcp.default._iana];location=osgiservices://9.53.189.11:30001/svc_NgkGKIokGDJC86wytsCHPug3a1E=;full=_osgiservices._tcp.default._iana@osgiservices://9.53.189.11:30001/svc_NgkGKIokGDJC86wytsCHPug3a1E=];priority=0;weight=0;props=ServiceProperties[{com.ibm.hdwb.jobs.common.monitor.port=9020, ecf.sp.ect=ecf.generic.server, com.ibm.hdwb.jobs.common.monitor.command=/afs/awd/projects/cte/tools/hdwb/prod/llmonitor/monitor.ksh, component.id=19, com.ibm.hdwb.jobs.common.monitor.host=smccants.austin.ibm.com, component.name=com.ibm.hdwb.ll.server.job_queue_service, ecf.rsvc.id=org.eclipse.ecf.discovery.ServiceProperties$ByteArrayWrapper@314c314c, ll_submit_command=, ecf.sp.cid=org.eclipse.ecf.discovery.ServiceProperties$ByteArrayWrapper@188b188b, com.ibm.hdwb.jobs.common.pool.uuid=dd38f018-b15e-4981-b71a-0453ea307634, com.ibm.hdwb.jobs.common.monitor.submitter=smccants, service.factoryPid=com.ibm.hdwb.ll.server.job_queue_service, service.pid=com.ibm.hdwb.ll.server.job_queue_service-1283452175751-0, com.ibm.hdwb.jobs.common.monitor.restlet.port=8080, osgi.remote.service.interfaces=com.ibm.hdwb.jobs.common.IJobQueueService, ecf.rsvc.ns=ecf.namespace.generic.remoteservice, ecf.sp.cns=org.eclipse.ecf.core.identity.StringID, com.ibm.hdwb.jobs.common.monitor.restlet.host=smccants.austin.ibm.com}]]\n\nNot sure why it shows an unplublish first... that maybe a clue.\n\nIf I delete the Configuration for the service in app2, it will unregister:\n\nZooDiscovery> Service Unpublished: Sep 3, 2010 12:24:00 PM. ServiceInfo[uri=osgiservices://9.53.189.11:30001/svc_NgkGKIokGDJC86wytsCHPug3a1E=;id=ServiceID[type=ServiceTypeID[typeName=_osgiservices._tcp.default._iana];location=osgiservices://9.53.189.11:30001/svc_NgkGKIokGDJC86wytsCHPug3a1E=;full=_osgiservices._tcp.default._iana@osgiservices://9.53.189.11:30001/svc_NgkGKIokGDJC86wytsCHPug3a1E=];priority=0;weight=0;props=ServiceProperties[{com.ibm.hdwb.jobs.common.monitor.port=9020, ecf.sp.ect=ecf.generic.server, com.ibm.hdwb.jobs.common.monitor.command=/afs/awd/projects/cte/tools/hdwb/prod/llmonitor/monitor.ksh, component.id=19, com.ibm.hdwb.jobs.common.monitor.host=smccants.austin.ibm.com, component.name=com.ibm.hdwb.ll.server.job_queue_service, ecf.rsvc.id=org.eclipse.ecf.discovery.ServiceProperties$ByteArrayWrapper@314c314c, ll_submit_command=, ecf.sp.cid=org.eclipse.ecf.discovery.ServiceProperties$ByteArrayWrapper@188b188b, com.ibm.hdwb.jobs.common.pool.uuid=dd38f018-b15e-4981-b71a-0453ea307634, com.ibm.hdwb.jobs.common.monitor.submitter=smccants, service.factoryPid=com.ibm.hdwb.ll.server.job_queue_service, service.pid=com.ibm.hdwb.ll.server.job_queue_service-1283452175751-0, com.ibm.hdwb.jobs.common.monitor.restlet.port=8080, osgi.remote.service.interfaces=com.ibm.hdwb.jobs.common.IJobQueueService, ecf.rsvc.ns=ecf.namespace.generic.remoteservice, ecf.sp.cns=org.eclipse.ecf.core.identity.StringID, com.ibm.hdwb.jobs.common.monitor.restlet.host=smccants.austin.ibm.com}]]\n\nThen if I recreate the configuration (which recreates the service):\n\nActivating LoadLevelerJobService\n  Pool : null\n  Monitor Command : /afs/awd/u/smccants/pub/monitor2/monitor.ksh\n  Monitor Host : smccants.austin.ibm.com\n  Monitor Port : 9020\n  Submit Command :\nActivating LoadLevelerJobLocatorService\nZooDiscovery> Service Published: Sep 3, 2010 12:24:35 PM. ServiceInfo[uri=osgiservices://9.53.189.11:30001/svc_WIppgVmdSZTGK0xWz1mQ/OaSqYQ=;id=ServiceID[type=ServiceTypeID[typeName=_osgiservices._tcp.default._iana];location=osgiservices://9.53.189.11:30001/svc_WIppgVmdSZTGK0xWz1mQ/OaSqYQ=;full=_osgiservices._tcp.default._iana@osgiservices://9.53.189.11:30001/svc_WIppgVmdSZTGK0xWz1mQ/OaSqYQ=];priority=0;weight=0;props=ServiceProperties[{com.ibm.hdwb.jobs.common.monitor.port=9020, ecf.sp.ect=ecf.generic.server, com.ibm.hdwb.jobs.common.monitor.command=/afs/awd/u/smccants/pub/monitor2/monitor.ksh, component.id=20, com.ibm.hdwb.jobs.common.monitor.host=smccants.austin.ibm.com, component.name=com.ibm.hdwb.ll.server.job_queue_service, ecf.rsvc.id=org.eclipse.ecf.discovery.ServiceProperties$ByteArrayWrapper@7a847a84, ll_submit_command=, ecf.sp.cid=org.eclipse.ecf.discovery.ServiceProperties$ByteArrayWrapper@7d277d27, com.ibm.hdwb.jobs.common.pool.uuid=dd38f018-b15e-4981-b71a-0453ea307634, com.ibm.hdwb.jobs.common.monitor.submitter=smccants, service.factoryPid=com.ibm.hdwb.ll.server.job_queue_service, service.pid=com.ibm.hdwb.ll.server.job_queue_service-1283534671864-0, com.ibm.hdwb.jobs.common.monitor.restlet.port=8080, osgi.remote.service.interfaces=com.ibm.hdwb.jobs.common.IJobQueueService, ecf.rsvc.ns=ecf.namespace.generic.remoteservice, ecf.sp.cns=org.eclipse.ecf.core.identity.StringID, com.ibm.hdwb.jobs.common.monitor.restlet.host=smccants.austin.ibm.com}]]\n\nAt this point, ZooKeeper gets knocked out of its infinite loop and stops consuming all the CPU.\n\nThis looks to me like a pretty serious ZK bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smccants","name":"smccants","key":"smccants","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen McCants","active":true,"timeZone":"America/Chicago"},"created":"2010-09-03T18:43:51.776+0000","updated":"2010-09-03T18:43:51.776+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473242/comment/12906014","id":"12906014","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smccants","name":"smccants","key":"smccants","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen McCants","active":true,"timeZone":"America/Chicago"},"body":"Removing the registered service after ZK had stopped running away, causes ZK to return to using 100% of the CPU.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smccants","name":"smccants","key":"smccants","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen McCants","active":true,"timeZone":"America/Chicago"},"created":"2010-09-03T18:50:39.346+0000","updated":"2010-09-03T18:50:39.346+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-863/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05zg7:"}}