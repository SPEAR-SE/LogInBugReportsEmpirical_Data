{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13040862","self":"https://issues.apache.org/jira/rest/api/2/issue/13040862","key":"ZOOKEEPER-2684","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-02-07T06:19:47.543+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Nov 03 04:05:36 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_6288536577_*|*_3_*:*_1_*:*_16949284936_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-11-03T04:20:04.428+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2684/watchers","watchCount":8,"isWatching":false},"created":"2017-02-07T05:23:02.984+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false}],"issuelinks":[{"id":"12493602","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12493602","type":{"id":"12310361","name":"Blocked","inward":"Blocked","outward":"Blocked","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310361"},"outwardIssue":{"id":"12737480","key":"ZOOKEEPER-2024","self":"https://issues.apache.org/jira/rest/api/2/issue/12737480","fields":{"summary":"Major throughput improvement with mixed workloads","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-31T00:19:01.561+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"We deployed our build with ZOOKEEPER-2024 and it quickly started to crash with the following error\n\natla-buh-05-sr1.prod.twttr.net: 2017-01-18 22:24:42,305 - ERROR [CommitProcessor:2] -org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:268) – Got cxid 0x119fa expected 0x11fc5 for client session id 1009079ba470055\natla-buh-05-sr1.prod.twttr.net: 2017-01-18 22:32:04,746 - ERROR [CommitProcessor:2] -org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:268) – Got cxid 0x698 expected 0x928 for client session id 4002eeb3fd0009d\natla-buh-05-sr1.prod.twttr.net: 2017-01-18 22:34:46,648 - ERROR [CommitProcessor:2] -org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:268) – Got cxid 0x8904 expected 0x8f34 for client session id 51b8905c90251\natla-buh-05-sr1.prod.twttr.net: 2017-01-18 22:43:46,834 - ERROR [CommitProcessor:2] -org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:268) – Got cxid 0x3a8d expected 0x3ebc for client session id 2051af11af900cc\n\nclearly something is not right in the new commit processor per session queue implementation.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12851589","id":"12851589","filename":"ZOOKEEPER-2684.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"created":"2017-02-08T08:56:57.733+0000","size":6160,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12851589/ZOOKEEPER-2684.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Fix a crashing bug in the mixed workloads commit processor","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"with pretty heavy load on a real cluster","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15855408","id":"15855408","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"From these logs it is difficult to know what's going on besides that some reordering is happening somewhere. It would be good to find out where exactly this happens. It would be interesting for example to see what is the cxid order in which the leader commits these operations (you can print their zxid).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-07T06:19:47.543+0000","updated":"2017-02-07T06:22:18.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15855426","id":"15855426","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"The ZK as is lacks pretty much any live debuggability so that's all it logged. I did add temporary logs to the code base and was fortunately able to repro albeit with dismal performances. I was going to put the detailed logs in the comment following this but sounds like you would like to see them in the description (which I was going to just use as a description of the problem instead of an analysis and solution). I am still debating on a proper fix (I have two less than perfect solutions) and thinking of adding a more compelling test than the test I have now but it's kinda tricky. I will put in more details and possibly the solution tomorrow if I figure out how to do the github thing,  stay tuned.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-07T06:38:13.585+0000","updated":"2017-02-07T06:40:51.346+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15855428","id":"15855428","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Ryan, I didn't mean to rush you. Putting the logs in the comments sounds just fine.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-07T06:41:04.500+0000","updated":"2017-02-07T06:41:04.500+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15855432","id":"15855432","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Sounds good, btw, is this the recommended way to communicate (through comments)?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-07T06:44:03.250+0000","updated":"2017-02-07T06:44:03.250+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15855436","id":"15855436","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"yes, I think so","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-07T06:46:06.277+0000","updated":"2017-02-07T06:46:06.277+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15856615","id":"15856615","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"body":"Hi Ryan, is it possible that the reason you see this type of bad behavior is because it wasn't examined before in the commit processor? i.e., it's a new error message that we added in order to notify that commit messages don't follow their client order. \nI wonder, can you to add to an un-patched version the same error message? (and see if you get that error) \ne.g., before [this|https://github.com/apache/zookeeper/commit/9fc632c4f0a340b0a00ec6dff39c7b454c802822?diff=split#diff-5cc688a027068714af01b0ad4d292fe5L223] point, add something like        \n\nif (pending != null && pending.sessionId == request.sessionId && pending.cxid > request.cxid) \n LOG.error(\"Got cxid 0x \" + Long.toHexString(request.cxid) + \" expected 0x\" + Long.toHexString(pending.cxid) + \" for client session id \" + Long.toHexString(request.sessionId));\n throw new IOException(\"Error: unexpected cxid for\" + \"client session\");\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"created":"2017-02-07T19:26:06.480+0000","updated":"2017-02-07T19:26:06.480+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857009","id":"15857009","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi, Kfir,  I think you are getting to the point. (I don't need to add the log, I knew what happened) The unpatched version just pass that request to the next processor while this patch throw an exception. I am pasting the exact reason below to save you more guess time :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-07T23:17:03.199+0000","updated":"2017-02-07T23:20:04.200+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857018","id":"15857018","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"While I am at it, let me paste the enhanced log of a repo.\n\nThe problem was created when there is a session move. When a session just moved, the new processor starts to get requests from the session so it will crash when a commit coming from previous session handler comes.  Here are the logs from on repro\n\nLearner A  got the session 0x100186ea825fa45 starting from cxid 0xfb6 \n/var/log/zookeeper/zookeeper-info.log.65:2017-02-06 20:56:03,635 - INFO  [FollowerRequestProcessor:0] - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb6 zxi\nd:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_\n/var/log/zookeeper/zookeeper-info.log.65:2017-02-06 20:56:03,636 - INFO  [FollowerRequestProcessor:0] - Processing request:: sessionid:0x100186ea825fa45 type:delete cxid:0xfb7 zxi\nd:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1301965514\n/var/log/zookeeper/zookeeper-info.log.65:2017-02-06 20:56:03,636 - INFO  [FollowerRequestProcessor:0] - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb8 zxi\nd:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_\n/var/log/zookeeper/zookeeper-info.log.65:2017-02-06 20:56:04,123 - INFO  [QuorumPeer[myid=0](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x100186ea825fa45 type:error cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a\n/var/log/zookeeper/zookeeper-info.log.65:2017-02-06 20:56:04,123 - ERROR [CommitProcessor:0] - Got request sessionid:0x100186ea825fa45 type:error cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a\n/var/log/zookeeper/zookeeper-info.log.65: expected request sessionid:0x100186ea825fa45 type:create cxid:0xfb6 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_\n/var/log/zookeeper/zookeeper-info.log.65: for client session id 0x100186ea825fa45\n\n\nfollower B that processed 0xfb5 and got session 0x100186ea825fa45 closed after 0Xfb5\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,234 - INFO  [FollowerRequestProcessor:4] - Processing request:: sessionid:0x100186ea825fa45 type:delete cxid:0xfb0 zxi\nd:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1301965515\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,345 - INFO  [FollowerRequestProcessor:4] - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb1 zxi\nd:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,659 - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001\n86ea825fa45 type:delete cxid:0xfae zxid:0x8e06e3c727 txntype:2 reqpath:n/a\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,659 - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001\n86ea825fa45 type:create cxid:0xfaf zxid:0x8e06e3c728 txntype:1 reqpath:n/a\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,664 - INFO  [FollowerRequestProcessor:4] - Processing request:: sessionid:0x100186ea825fa45 type:delete cxid:0xfb2 zxi\nd:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1301965516\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:34,764 - INFO  [FollowerRequestProcessor:4] - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb3 zxi\nd:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:35,056 - INFO  [FollowerRequestProcessor:4] - Processing request:: sessionid:0x100186ea825fa45 type:delete cxid:0xfb4 zxi\nd:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1301965517\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:35,363 - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001\n86ea825fa45 type:delete cxid:0xfb0 zxid:0x8e06e3d4bc txntype:2 reqpath:n/a\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:35,465 - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001\n86ea825fa45 type:create cxid:0xfb1 zxid:0x8e06e3d718 txntype:1 reqpath:n/a\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:35,804 - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001\n86ea825fa45 type:delete cxid:0xfb2 zxid:0x8e06e3de59 txntype:2 reqpath:n/a\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:35,882 - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001\n86ea825fa45 type:create cxid:0xfb3 zxid:0x8e06e3dfe6 txntype:1 reqpath:n/a\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:55:36,150 - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x1001\n86ea825fa45 type:delete cxid:0xfb4 zxid:0x8e06e3e4c8 txntype:2 reqpath:n/a\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:56:03,132 - WARN  [NIOWorkerThread-16] - Unable to read additional data from client sessionid 0x100186ea825fa45, likely clie\nnt has closed socket\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:56:03,136 - INFO  [FollowerRequestProcessor:4] - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb5 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_\n/var/log/zookeeper/zookeeper-info.log.67:2017-02-06 20:56:04,123 - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x100186ea825fa45 type:error cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a\n\n2017-02-06 20:56:03,136 - INFO  [FollowerRequestProcessor:4] - Processing request:: sessionid:0x100186ea825fa45 type:create cxid:0xfb5 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_\n2017-02-06 20:56:04,123 - INFO  [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x100186ea825fa45 type:error cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a\n\nthe leader got 0xfb5 first\n2017-02-06 20:56:04,122 - INFO  [ProcessThread(sid:1 cport:-1):] - Leader proposing: sessionid:0x100186ea825fa45 type:create cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a\n2017-02-06 20:56:04,122 - INFO  [LearnerHandler-/10.40.89.122:42232] - Commit a proposal: sessionid:0x100186ea825fa45 type:create cxid:0xfb5 zxid:0x8e06e60288 txntype:-1 reqpath:n/a\n\nand then 0xfb6\n2017-02-06 20:56:04,610 - INFO  [ProcessThread(sid:1 cport:-1):] - Leader proposing: sessionid:0x100186ea825fa45 type:create cxid:0xfb6 zxid:0x8e06e60bfb txntype:1 reqpath:n/a\n2017-02-06 20:56:04,611 - INFO  [LearnerHandler-/10.40.91.124:52180] - Commit a proposal: sessionid:0x100186ea825fa45 type:create cxid:0xfb6 zxid:0x8e06e60bfb txntype:1 reqpath:n/a\n\nSo there is no out of order commit but the session queue in the commitProcessor gets created before the last commit from previous session life comes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-07T23:24:17.862+0000","updated":"2017-02-07T23:24:17.862+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857354","id":"15857354","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Ryan,\n\nThanks for the analysis! How about throwing an exception only in case we see a cxid > what we expected, and only logging if we see something smaller than expected ?\n\nThanks,\nAlex","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-08T04:04:11.790+0000","updated":"2017-02-08T04:04:11.790+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857357","id":"15857357","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"body":"+ to what Alex wrote - handle the case of < as a remote session commit. \nI.e., something like these changes:\n\n[here|https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java#L256] change the \"!=\" to \">\".\n\nand [here|https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java#L255] need to \"peek\" instead of \"poll\".\n\nand [here|https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java#L271] need to add \n\n\"if (request.cxid == topPending.cxid) {\nsessionQueue.poll();\"\nand the rest of the local request processing up until [this|https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java#L274] line.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"created":"2017-02-08T04:07:26.863+0000","updated":"2017-02-08T04:21:43.037+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857452","id":"15857452","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Alex, yes, I think the solution is pretty much along this line after we know what leads to this crash.\n\nKfir, I am sorry that I can't really make out exactly what those \"this\" links point to, can you put a line number somewhere?\n\nIn any case, I have a fix along the line of knowing the first CXid of the session this server sees and only does the comparison to queue head when it's larger than that. I am testing it internally and also trying to figure out how to do that github and \"pull request\" thing if I am happy with the result. I am still working on a test case that can repro this reliably and being unsuccessful so far.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-08T05:46:40.654+0000","updated":"2017-02-08T05:46:40.654+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857465","id":"15857465","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"newbie questions, there seems to be two git remote ( https://github.com/apache/zookeeper.git and https://git-wip-us.apache.org/repos/asf/zookeeper.git), which one should I pick?\nWhich branch should I base on? My understanding is that this is in 3.6 but there is no 3.6 branch, does this mean I will patch it on top of master?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-08T06:03:16.884+0000","updated":"2017-02-08T06:03:16.884+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857467","id":"15857467","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"Please use https://github.com/apache/zookeeper - fork it and you can create pull request.\nbranch master is for 3.6 so yes, patch on top of master.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-02-08T06:06:25.870+0000","updated":"2017-02-08T06:06:25.870+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857469","id":"15857469","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"btw more info on https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute (section Pull requests via github)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-02-08T06:09:13.104+0000","updated":"2017-02-08T06:09:13.104+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857496","id":"15857496","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"body":"Ryan, sorry for the mess I wrote, I'll write it again as a patch so that we'll see we're on the same page (I'll try to write a unit test that cover the case you identified).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"created":"2017-02-08T06:37:51.891+0000","updated":"2017-02-08T06:37:51.891+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857529","id":"15857529","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi, Michael,  the link you and Alex gave me has the \"git clone https://git-wip-us.apache.org/repos/asf/zookeeper.git\"  as the first command, that's why I was confused, I guess I will go through the github route. Thanks for the clarification.\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-08T06:59:10.211+0000","updated":"2017-02-08T06:59:10.211+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857531","id":"15857531","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi, Kfir, I have a unit case and it's not bad. The problem is to come up with a quorum based test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-08T07:00:24.911+0000","updated":"2017-02-08T07:00:24.911+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15857680","id":"15857680","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"body":"Hi Ryan, do you mean that you want  to test it on several running servers? \nI think you can modify the system test (or the upgraded one here - https://issues.apache.org/jira/browse/ZOOKEEPER-2023) by making clients to change server every couple of writes. \nIf this is what you need I can add it as well to 2023. \nI'm also attaching a patch, let me know if you agree with it. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"created":"2017-02-08T08:51:44.980+0000","updated":"2017-02-08T08:51:44.980+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15858474","id":"15858474","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi, Kfir, when I say a quorum based test I mean a test class that extends the QuorumBase class.\n\nas for your patch, the biggest question for me is that how does it check that the commit is not duplicated? The request could have been processed in the queue before. On a high level, I am not sure what piece of code ensures that won't happen (I assume in the lead code but I don't know on top of my head). My approach is to remember the first CXid ever appeared but it's kinda messy. If you can point me to that code guarantee no duplication and no reorder then I think I would be happy to not be so strict here in the commitProcessor\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-08T20:05:07.978+0000","updated":"2017-02-09T04:20:02.851+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15858769","id":"15858769","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"[~nerdyyatrice] The wiki page was a little bit out dated - I just updated the page https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute hopefully will create less confusions for new contributors.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-02-09T00:29:29.516+0000","updated":"2017-02-09T00:29:29.516+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15859210","id":"15859210","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"body":"[~nerdyyatrice], can you please describe the scenario in which the same request is processed in the queue twice? \n\nAs I see it, if a request r is received from a local client, then r is added to the queue (note that r was already sent to the leader prior to that point).\n\nOnce a commit arrives from the leader, r is processed, and r won't be back to the queue, regardless of a possible client disconnection (AFAIK, the connection is only needed at the end of the line, when some kind of result is returned).\n\nNow, lets say the client gets disconnected at some point in the time frame above while r is processed, and connects to some server (same server or different). \n\nIf a commit arrives to a different server, r will be processed as if it belongs to a remote client, i.e., we will only perform the update, without using the connection. I'm not sure that after disconnection ZK is required to inform the client's new session on his past actions.. (but I guess it can also be fixed if needed).\nIf a commit arrives and r is in the queue waiting for it, then it is processed as if it belongs to a local connected client, but eventually the connection handle will show that that connection ended, (if I remember the code correctly), so nothing to report, but ZK continue as usual. \n\nNote that if a client writes something with lower cxid than r, the commit processor doesn't track such a behavior, i.e., it is possible that the next head after r will have lower cxid than r. We only care about the order of commits that we receive from the leader, and that order can't be changed, because it is based on the network protocol order of messages (i.e., if r was already sent to the leader, than clearly r is committed prior to any new message of the same client). \n\nBottom line, it seems like r is processed only once per processor. What am I missing?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"created":"2017-02-09T08:38:02.994+0000","updated":"2017-02-09T08:41:07.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15860081","id":"15860081","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Kfir Lev-Ari, no, you are not missing anything. I just wondered how does ZK guarantee that the same request won't be send to the commit processor twice as a lot of strange things can happen in a distributed system. I would like to add a check in the commit processor but my implementation is a bit messier than I like, otherwise I think it won't hurt even if this never happens.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-09T19:52:41.313+0000","updated":"2017-02-09T19:53:12.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15860130","id":"15860130","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"body":"Oh, I see. Well, the leader is the one that sends commit messages (i.e., saying that an update should be committed). \nUnless I'm mistaken, based on ZAB (i.e., ZK's consensus algorithm), leaders wouldn't send commit of the same message twice. I'm not sure about the exact locations in the code that you can read in order to validate it (here is a link about ZAB - https://cwiki.apache.org/confluence/display/ZOOKEEPER/Zab1.0).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"created":"2017-02-09T20:22:50.948+0000","updated":"2017-02-09T20:22:50.948+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15860158","id":"15860158","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"If I understand the concern correctly, you're worried that we'd consider a duplicate request as legitimate because it has op cxid < queued cxid like in the session migration case. I agree that if something goes wrong that's possible. But, I think we should just log this when it happens, maybe Log.warn. This is very similar\nto what is done in other parts of ZooKeeper, see for example Follower.java  when the follower gets a proposal which it doesn't expect. \n\nIt is also somewhat related to ZooKeeper-22 Jira, which is about identifying whether a client's operation has been executed or not. I don't think we want to tackle it here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-09T20:38:51.012+0000","updated":"2017-02-09T20:38:51.012+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15860200","id":"15860200","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Sounds good to me. I will change my implementation then. I am still trying to figure out the github thing so please go ahead with the patch if I don't get time to do a pull request (which is not the same as doing a patch here, I guess?)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-09T21:02:55.234+0000","updated":"2017-02-09T21:02:55.234+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15860525","id":"15860525","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"k, I followed the instruction and (I think) submitted a pull request https://github.com/apache/zookeeper/pull/167. What's next?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-10T01:38:12.963+0000","updated":"2017-02-10T01:38:12.963+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15860894","id":"15860894","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user shralex commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/167#discussion_r100486359\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -251,27 +252,29 @@ public void run() {\n                         LinkedList<Request> sessionQueue = pendingRequests\n                                 .get(request.sessionId);\n                         if (sessionQueue != null) {\n    +                        Request topPending = sessionQueue.peekFirst();\n                             // If session queue != null, then it is also not empty.\n    -                        Request topPending = sessionQueue.poll();\n    -                        if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                        // we can get commit requests for requests before we even get this session\n    +                        //(see ZOOKEEPER-2684). We will just pass those commits to the next processor.\n    +                        if(request.cxid < topPending.cxid) {\n    +                            LOG.warn(\"Got commit request \" + request\n    +                                + \" that is less than our queue head \" + topPending);\n    +                        } else {\n    +                            topPending = sessionQueue.poll();\n    --- End diff --\n    \n    Do you mind separating the if into 3 cases instead of 2 ? here's a suggestion:\n    if ( < )\n        // comment here about this case, pointing to the JIRA.\n       Log.warn\n    else if ( > )\n       Log error, throw exception\n    else\n       poll and do what the old code does.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-10T08:06:42.052+0000","updated":"2017-02-10T08:06:42.052+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15860895","id":"15860895","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user shralex commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/167#discussion_r100486141\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -251,27 +252,29 @@ public void run() {\n                         LinkedList<Request> sessionQueue = pendingRequests\n                                 .get(request.sessionId);\n                         if (sessionQueue != null) {\n    +                        Request topPending = sessionQueue.peekFirst();\n                             // If session queue != null, then it is also not empty.\n    -                        Request topPending = sessionQueue.poll();\n    -                        if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                        // we can get commit requests for requests before we even get this session\n    +                        //(see ZOOKEEPER-2684). We will just pass those commits to the next processor.\n    +                        if(request.cxid < topPending.cxid) {\n    +                            LOG.warn(\"Got commit request \" + request\n    --- End diff --\n    \n    This isn't as informative as the other messsege. Could you please use the same message format in both ?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-10T08:06:42.094+0000","updated":"2017-02-10T08:06:42.094+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15860896","id":"15860896","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user shralex commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/167#discussion_r100486459\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -251,27 +252,29 @@ public void run() {\n                         LinkedList<Request> sessionQueue = pendingRequests\n                                 .get(request.sessionId);\n                         if (sessionQueue != null) {\n    +                        Request topPending = sessionQueue.peekFirst();\n                             // If session queue != null, then it is also not empty.\n    -                        Request topPending = sessionQueue.poll();\n    -                        if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                        // we can get commit requests for requests before we even get this session\n    +                        //(see ZOOKEEPER-2684). We will just pass those commits to the next processor.\n    --- End diff --\n    \n    please remove the new comments from here and add them inside the if, where this case is handled.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-10T08:06:42.097+0000","updated":"2017-02-10T08:06:42.097+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15866318","id":"15866318","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Unfortunately, this is only half of the story. I tested the build and see the following crash\n\natla-cbo-26-sr4.prod.twttr.net:  2017-02-14 17:55:42,323 - ERROR [CommitProcessor:4] - Severe unrecoverable error, from thread : CommitProcessor:4\natla-cbo-26-sr4.prod.twttr.net:  org.apache.zookeeper.KeeperException$RuntimeInconsistencyException: KeeperErrorCode = RuntimeInconsistency\natla-cbo-26-sr4.prod.twttr.net:  \tat org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:276)\natla-cbo-26-sr4.prod.twttr.net:  2017-02-14 18:12:25,515 - ERROR [CommitProcessor:4] - Got request sessionid:0x40069edcb5b7b7f type:create cxid:0x36 zxid:0x38205009d26 txntype:1 reqpath:n/a\natla-cbo-26-sr4.prod.twttr.net:   but we are expecting request sessionid:0x40069edcb5b7b7f type:delete cxid:0x30 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1759491424\natla-cbo-26-sr4.prod.twttr.net:  \n\n\nStay tuned, I am adding back the verbose logs and will report on what I found","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-14T18:18:30.332+0000","updated":"2017-02-14T18:20:09.149+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15866702","id":"15866702","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"body":"From what I understand, seems like a session starts a connection with a smaller cxid than it had in a previous connection?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"created":"2017-02-14T21:13:48.711+0000","updated":"2017-02-14T21:13:48.711+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15869349","id":"15869349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"so here is what actually happened\n\nOn the server A, the request is processed right after the session connection is closed and the request is forwarded to the lead\n\ninvestigate.log:2017-02-14 23:30:50,373 - INFO [FollowerRequestProcessor:4] - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x14 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775503086\ninvestigate.log:2017-02-14 23:30:54,327 - INFO [FollowerRequestProcessor:4] - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x15 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775503083\ninvestigate.log:2017-02-14 23:30:57,888 - INFO [FollowerRequestProcessor:4] - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x16 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775503084\ninvestigate.log:2017-02-14 23:31:01,583 - INFO [FollowerRequestProcessor:4] - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x17 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775493180\ninvestigate.log:2017-02-14 23:31:04,867 - INFO [FollowerRequestProcessor:4] - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x18 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775493181\ninvestigate.log:2017-02-14 23:31:08,150 - INFO [FollowerRequestProcessor:4] - Processing request:: sessionid:0x4006b1b17808b0c type:getData cxid:0x19 zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1775985079\ninvestigate.log:2017-02-14 23:31:12,672 - INFO [FollowerRequestProcessor:4] - Processing request:: sessionid:0x4006b1b17808b0c type:getChildren2 cxid:0x1a zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen\ninvestigate.log:2017-02-14 23:31:17,293 - WARN [NIOWorkerThread-16] - Exception causing close of session 0x4006b1b17808b0c: Broken pipe\ninvestigate.log:2017-02-14 23:31:17,297 - INFO [FollowerRequestProcessor:4] - Processing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1776069644\ninvestigate.log:2017-02-14 23:31:21,816 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x27 zxid:0x385012a1e94 txntype:2 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:21,816 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x28 zxid:0x385012a1e95 txntype:1 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:21,816 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x29 zxid:0x385012a1e96 txntype:2 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:21,816 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x2a zxid:0x385012a1e98 txntype:1 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:21,817 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x2b zxid:0x385012a1e9b txntype:2 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:21,817 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x2c zxid:0x385012a1e9c txntype:1 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:21,818 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x2d zxid:0x385012a1ea1 txntype:2 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:21,822 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x2e zxid:0x385012a1eb8 txntype:1 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:21,824 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x2f zxid:0x385012a1ec0 txntype:2 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:21,833 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x30 zxid:0x385012a1ee9 txntype:1 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:22,048 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:error cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:n/a\ninvestigate.log:2017-02-14 23:31:22,690 - ERROR [CommitProcessor:4] - Got request sessionid:0x4006b1b17808b0c type:delete cxid:0x27 zxid:0x385012a1e94 txntype:2 reqpath:n/a\ninvestigate.log: but we are expecting request sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0xfffffffffffffffe txntype:unknown reqpath:/loadgen/load_1776069644\ninvestigate.log:2017-02-14 23:32:39,172 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x4c zxid:0x385012b34fa txntype:1 reqpath:n/a\ninvestigate.log:2017-02-14 23:32:48,677 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x4e zxid:0x385012b6c31 txntype:2 reqpath:n/a\ninvestigate.log:2017-02-14 23:32:54,580 - INFO [QuorumPeer[myid=4](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled)] - Committing request:: se\n\n\nwhile on the lead side, the requests are arrived out of order (in terms of Cxid) \n\n2017-02-14 23:31:21,822 - INFO [LearnerHandler-/10.45.111.116:53431] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x2e zxid:0x385012a1eb8 txntype:1 reqpath:n/a\n2017-02-14 23:31:21,824 - INFO [LearnerHandler-/10.45.111.116:53431] - Commit a proposal: sessionid:0x4006b1b17808b0c type:delete cxid:0x2f zxid:0x385012a1ec0 txntype:2 reqpath:n/a\n2017-02-14 23:31:21,824 - INFO [LearnerHandler-/10.45.111.116:53431] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x2f zxid:0x385012a1ec0 txntype:2 reqpath:n/a\n2017-02-14 23:31:21,833 - INFO [LearnerHandler-/10.45.111.116:53431] - Commit a proposal: sessionid:0x4006b1b17808b0c type:create cxid:0x30 zxid:0x385012a1ee9 txntype:1 reqpath:n/a\n2017-02-14 23:31:21,833 - INFO [LearnerHandler-/10.45.111.116:53431] - Committing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x30 zxid:0x385012a1ee9 txntype:1 reqpath:n/a\n2017-02-14 23:31:21,999 - DEBUG [ProcessThread(sid:1 cport:-1):] - Got user-level KeeperException when processing sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:/loadgen/load_1776069644 Error Path:null Error:KeeperErrorCode = Session moved\ninvestigate.log.1:2017-02-14 23:31:21,999 - INFO [ProcessThread(sid:1 cport:-1):] - Processing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:/loadgen/load_1776069644\ninvestigate.log.1:2017-02-14 23:31:21,999 - INFO [ProcessThread(sid:1 cport:-1):] - Leader proposing: sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:/loadgen/load_1776069644\ninvestigate.log.1:2017-02-14 23:31:22,048 - INFO [LearnerHandler-/10.45.112.127:53292] - Commit a proposal: sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:/loadgen/load_1776069644\ninvestigate.log.1:2017-02-14 23:31:22,048 - INFO [LearnerHandler-/10.45.112.127:53292] - Committing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x1b zxid:0x385012a2156 txntype:-1 reqpath:/loadgen/load_1776069644\n2017-02-14 23:31:26,728 - INFO [ProcessThread(sid:1 cport:-1):] - Processing request:: sessionid:0x4006b1b17808b0c type:delete cxid:0x32 zxid:0x385012a3bd0 txntype:2 reqpath:n/a\n2017-02-14 23:31:26,728 - INFO [ProcessThread(sid:1 cport:-1):] - Leader proposing: sessionid:0x4006b1b17808b0c type:delete cxid:0x32 zxid:0x385012a3bd0 txntype:2 reqpath:n/a\n2017-02-14 23:31:26,728 - INFO [ProcessThread(sid:1 cport:-1):] - Processing request:: sessionid:0x4006b1b17808b0c type:create cxid:0x33 zxid:0x385012a3bd1 txntype:1 reqpath:n/a\n\nIdeally, I would like to check if the server still owns the session (has a connection open) but it seems there is no easy way to check that. Any thoughts? The worst case is just be like the un-patched version to not check at all...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-16T06:53:20.319+0000","updated":"2017-02-16T06:53:20.319+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15869431","id":"15869431","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"body":"Good catch!\nAbout testing if the connection is still open - I think that the following scenario is possible:\n1. a client C disconnects from server A.\n2. C sends some requests via server B\n3. C disconnects from B and returns to A. \n\nIn that scenario, we'll see that C has an open connection, but still we'll receive (at A) the messages from B with higher cxid.\nIMHO, we should just remove the check, i.e., only attach the connection info if it is equal to the pending commit we see, (as in the original version).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"created":"2017-02-16T07:51:09.496+0000","updated":"2017-02-16T07:51:09.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15871003","id":"15871003","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"That's what I thought too. I submitted the new change but the test failed at random places. How can I rekick this build?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-17T01:27:59.258+0000","updated":"2017-02-17T01:27:59.258+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15924710","id":"15924710","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"body":"Hi Ryan, any updates regarding your patch?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kfirlevari","name":"kfirlevari","key":"kfirlevari","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kfir Lev-Ari","active":true,"timeZone":"Asia/Jerusalem"},"created":"2017-03-14T18:09:12.161+0000","updated":"2017-03-14T18:09:56.009+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15947547","id":"15947547","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"[~nerdyyatrice] ping","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-03-29T17:18:37.249+0000","updated":"2017-03-29T17:18:37.249+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/15977838","id":"15977838","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Sorry, didn't follow this after my previous submission got stuck. Just kicked another round and still not sure what's next.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nerdyyatrice","name":"nerdyyatrice","key":"nerdyyatrice","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-04-21T00:11:22.426+0000","updated":"2017-04-21T00:21:39.394+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16016601","id":"16016601","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/167\n  \n    ZOOKEEPER-2684 kick jenkins bot\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-18T22:56:32.118+0000","updated":"2017-05-18T22:56:32.118+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16016632","id":"16016632","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/167\n  \n    @nerdyyatrice I don't see Jenkins pre-commit build is kicked off for your patch. I think a combination of these should kick the build bot:\n    * Put string \"ZOOKEEPER-2684\" in pull request title. The bot running a script that looks for JIRA number.\n    * And, after update title, close and reopen this pull request. This should again trigger a pre-commit build.\n    Do you mind do these so we can sign off this pull request from jenkins?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-18T23:12:23.239+0000","updated":"2017-05-18T23:12:23.239+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16022068","id":"16022068","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user nerdyyatrice closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/167\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-23T23:24:08.560+0000","updated":"2017-05-23T23:24:08.560+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16022069","id":"16022069","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user nerdyyatrice reopened a pull request:\n\n    https://github.com/apache/zookeeper/pull/167\n\n    ZOOKEEPER-2684 commitProcessor does not crash when an unseen commit somes\n\n    commitProcessor with the zookeeper-2024 improvement patch throws an exception when it sees a commit request that is not at the queue head.  It turned out that it is actually a valid case when there is session movement. After discussion with the community, I submit this pull request to mitigate this issue by passing those commits to the next processor instead.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/nerdyyatrice/zookeeper zookeeper-2684\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/167.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #167\n    \n----\ncommit 423e385038d055b034a71e91a503ff31532e84a2\nAuthor: rzhang <rzhang@twitter.com>\nDate:   2017-02-10T01:33:23Z\n\n    commitProcessor does not crash when an unseen commit somes\n\ncommit cde12800a4ddecce26d41a4870cd19ae8d7e6f15\nAuthor: rzhang <rzhang@twitter.com>\nDate:   2017-02-10T02:24:19Z\n\n    commitProcessor does not crash when an unseen commit somes\n\ncommit 0f7c2e815c3744d8088f12b6e802365ab164ff9a\nAuthor: rzhang <rzhang@twitter.com>\nDate:   2017-02-16T20:53:56Z\n\n    remove the exception in the commit processor as commit requests can arrive out of order in terms of CXid\n\ncommit d80b715620bbbef173be4acbeb022892ff13934d\nAuthor: rzhang <rzhang@twitter.com>\nDate:   2017-02-16T20:59:34Z\n\n    Merge branch 'zookeeper-2684' of https://github.com/nerdyyatrice/zookeeper into zookeeper-2684\n\ncommit 61f4764b51c92d93cdf5b63ab617efa41e1ee44c\nAuthor: rzhang <rzhang@twitter.com>\nDate:   2017-02-16T23:45:06Z\n\n    adjust the test and to re-kick the submit\n\ncommit 5191fa83eb88967e91fc7df4c18a106369b0dd0c\nAuthor: rzhang <rzhang@twitter.com>\nDate:   2017-04-21T00:18:51Z\n\n     ZOOKEEPER-2684: Fix a crashing bug in the mixed workloads commit processor\n\ncommit fde3b0eba781361e5775445ecc6cfd20efe71f05\nAuthor: rzhang <rzhang@twitter.com>\nDate:   2017-04-21T22:38:07Z\n\n    ZOOKEEPER-2684: Fix a crashing bug in the mixed workloads commit processor\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-23T23:24:11.486+0000","updated":"2017-05-23T23:24:11.486+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16022129","id":"16022129","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-24T00:13:57.069+0000","updated":"2017-05-24T00:13:57.069+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16022290","id":"16022290","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/167\n  \n    @nerdyyatrice I see you've closed / reopened this PR, and the build bot is kicked off as expected.  There is the same test failure in pre-commit build: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739/testReport/junit/org.apache.zookeeper.server.quorum/CommitProcessorConcurrencyTest/noCrashOnCommittedRequestsOfUnSeenRequestTest/. We should get this fixed before merging this PR.\n    \n    I'll try reviewing this patch in detail to understand what goes wrong here.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-24T04:15:39.044+0000","updated":"2017-05-24T04:15:39.044+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16022355","id":"16022355","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user nerdyyatrice commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/167\n  \n    I can’t repro it on my laptop so I tried to see if it can pass on the machine. I will look into code in more detail. \n    \n    > On May 23, 2017, at 9:15 PM, Michael Han <notifications@github.com> wrote:\n    > \n    > @nerdyyatrice <https://github.com/nerdyyatrice> I see you've closed / reopened this PR, and the build bot is kicked off as expected. There is the same test failure in pre-commit build: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739/testReport/junit/org.apache.zookeeper.server.quorum/CommitProcessorConcurrencyTest/noCrashOnCommittedRequestsOfUnSeenRequestTest/ <https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/739/testReport/junit/org.apache.zookeeper.server.quorum/CommitProcessorConcurrencyTest/noCrashOnCommittedRequestsOfUnSeenRequestTest/>. We should get this fixed before merging this PR.\n    > \n    > I'll try reviewing this patch in detail to understand what goes wrong here.\n    > \n    > —\n    > You are receiving this because you were mentioned.\n    > Reply to this email directly, view it on GitHub <https://github.com/apache/zookeeper/pull/167#issuecomment-303613061>, or mute the thread <https://github.com/notifications/unsubscribe-auth/ALGPjMle9unhxIR4OqgDteDFY_uCDzcLks5r867ygaJpZM4L85T6>.\n    > \n    \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-24T06:01:12.833+0000","updated":"2017-05-24T06:01:12.833+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16043497","id":"16043497","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user fpj commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/167#discussion_r121006265\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -254,24 +254,23 @@ public void run() {\n                             // If session queue != null, then it is also not empty.\n                             Request topPending = sessionQueue.poll();\n                             if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                            // we can get commit requests that is not at the queue head when \n    +                            // session moves (see ZOOKEEPER-2684). We will just pass the \n    +                            // commit to the next processor and put the pending back with\n    +                            // a warning, we should not see this often under normal load\n    +                            LOG.warn(\"Got request \" + request + \n    +                                \" but we are expecting request \" + topPending);\n    +                            sessionQueue.addFirst(topPending);\n    +                        } else {                            \n    --- End diff --\n    \n    Is it the case that for a given session, once we execute the else block once, executing the if block would be incorrect? If so, would it make sense to have a flag per session indicating that the else block has not been executed for the session? It might not even be a flag per session, but perhaps a set of session ids instead that we remove from once we execute the else block.   \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-08T21:43:29.441+0000","updated":"2017-06-08T21:43:29.441+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16224639","id":"16224639","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user kfirlevari opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/411\n\n    ZOOKEEPER-2684 Fix a crashing bug in the mixed workloads commit processor\n\n    We wish to fix this long-standing issue in the code.\r\n    Note that the previous commit processor algorithm had the same approach (as the one suggested in this fix) when dealing with a request that has a different cxid than session's expected one (see [here](https://github.com/apache/zookeeper/commit/9fc632c4f0a340b0a00ec6dff39c7b454c802822#diff-5cc688a027068714af01b0ad4d292fe5L238)).\r\n    \r\n    This fix is based on the code from https://github.com/apache/zookeeper/pull/167, following the discussion in https://issues.apache.org/jira/browse/ZOOKEEPER-2684 .\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/kfirlevari/zookeeper ZOOKEEPER-2684\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/411.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #411\n    \n----\ncommit 7e67982430d1f88fc50a6e60aceb168851a4c88c\nAuthor: Kfir Lev-Ari <klevari@apple.com>\nDate:   2017-10-30T10:29:58Z\n\n    ZOOKEEPER-2684 Fix a crashing bug in the mixed workloads commit processor\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-30T10:42:40.394+0000","updated":"2017-10-30T10:42:40.394+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16224664","id":"16224664","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1126//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1126//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1126//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-30T11:01:19.744+0000","updated":"2017-10-30T11:01:19.744+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16224777","id":"16224777","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user kfirlevari commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/411\n  \n    The build failed because _testNodeDataChanged_ failed (a test that doesn't seem related to the current change). \r\n    It seems like zk2.create at line 122 ([WatchEventWhenAutoResetTest.java](https://github.com/apache/zookeeper/blob/master/src/java/test/org/apache/zookeeper/test/WatchEventWhenAutoResetTest.java#L122)) is taking too long, and therefore we receive the NodeDeleted event instead of the expected NodeDataChanged (locally on my machine it didn't fail). I guess adding some kind of sleep prior to line 124 should solve this issue?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-30T11:51:21.358+0000","updated":"2017-10-30T11:51:21.358+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16225126","id":"16225126","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user anmolnar commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/411\n  \n    @kfirlevari yeah, that's an outstanding flaky test.\r\n    Here's the jira about it: https://issues.apache.org/jira/browse/ZOOKEEPER-2807\r\n    \r\n    Amend your latest commit to trigger another Jenkins build.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-30T15:26:17.514+0000","updated":"2017-10-30T15:26:17.514+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16225503","id":"16225503","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1130//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1130//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1130//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-30T18:33:05.595+0000","updated":"2017-10-30T18:33:05.595+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16225873","id":"16225873","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user shralex commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r147854385\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/CommitProcessorConcurrencyTest.java ---\n    @@ -376,4 +377,123 @@ public void noStarvationOfReadRequestsTest() throws Exception {\n                         !processedRequests.contains(r));\n             }\n         }\n    +\n    +    /**\n    +     * In the following test, we verify that we can handle the case that we got a commit\n    +     * of a request we never seen since the session that we just established. This can happen\n    +     * when a session is just established and there is request waiting to be committed in the\n    +     * in the session queue but it sees a commit for a request that belongs to the previous connection.\n    +     */\n    +    @Test(timeout = 1000)\n    +    public void noCrashOnCommittedRequestsOfUnseenRequestTest() throws Exception {\n    +        final String path = \"/noCrash/OnCommittedRequests/OfUnseenRequestTest\";\n    +        final int numberofReads = 10;\n    +        final int sessionid = 0x123456;\n    +        final int firstCXid = 0x100;\n    +        int readReqId = firstCXid;\n    +        processor.stoppedMainLoop = true;\n    +        HashSet<Request> localRequests = new HashSet<Request>();\n    +        // queue the blocking write request to queuedRequests\n    +        Request firstCommittedReq = newRequest(\n    +                new CreateRequest(path, new byte[0], Ids.OPEN_ACL_UNSAFE,\n    +                        CreateMode.PERSISTENT_SEQUENTIAL.toFlag()),\n    +                OpCode.create, sessionid, readReqId++);\n    +        processor.queuedRequests.add(firstCommittedReq);\n    +        localRequests.add(firstCommittedReq);\n    +\n    +        // queue read requests to queuedRequests\n    +        for (; readReqId <= numberofReads+firstCXid; ++readReqId) {\n    +            Request readReq = newRequest(new GetDataRequest(path, false),\n    +                    OpCode.getData, sessionid, readReqId);\n    +            processor.queuedRequests.add(readReq);\n    +            localRequests.add(readReq);\n    +        }\n    +\n    +        //run once\n    +        Assert.assertTrue(processor.queuedRequests.containsAll(localRequests));\n    +        processor.initThreads(numberofReads* 2);\n    +        processor.run();\n    +\n    +        //We verify that the processor is waiting for the commit\n    +        Assert.assertTrue(processedRequests.isEmpty());\n    +\n    +        // We add a commit that belongs to the same session but with smaller cxid,\n    +        // i.e., commit of an update from previous connection of this session.\n    +        Request preSessionCommittedReq = newRequest(\n    +                new CreateRequest(path, new byte[0], Ids.OPEN_ACL_UNSAFE,\n    +                        CreateMode.PERSISTENT_SEQUENTIAL.toFlag()),\n    +                OpCode.create, sessionid, firstCXid - 2);\n    +        processor.committedRequests.add(preSessionCommittedReq);\n    +        processor.committedRequests.add(firstCommittedReq);\n    +        processor.run();\n    +\n    +        //We verify that the commit processor processed the old commit prior to the newer messages\n    +        Assert.assertTrue(processedRequests.peek() == preSessionCommittedReq);\n    +\n    +        processor.run();\n    +\n    +        //We verify that the commit processor handle all messages.\n    +        Assert.assertTrue(processedRequests.containsAll(localRequests));\n    +    }\n    +\n    +    /**\n    +     * In the following test, we verify if we handle the case in which we get a commit\n    +     * for a request that has higher Cxid than the one we are waiting. This can happen\n    +     * when a session connection is lost but there is a request waiting to be committed in the\n    +     * session queue. However, since the session has moved, new requests can get to\n    +     * the leader out of order. Hence, the commits can also arrive \"out of order\" w.r.t. cxid.\n    +     * We should commit the requests according to the order we receive from the leader, i.e., wait for the relevant commit.\n    --- End diff --\n    \n    1) I think its worth while explaining the two scenarios in the CommitProcessor.java comments. I mean how its possible to get higher cxid and lower cxid from leader compared to what you expect. Including the part where requests may reach the leader out of cxid order if session is moved. \r\n    \r\n    2) I wonder if in this case (receiving higher cxid from leader) we should also empty the local pending requests ? What's the value of keeping the requests in the local queue ?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-30T22:39:42.368+0000","updated":"2017-10-30T22:39:42.368+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226141","id":"16226141","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r147883484\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -255,24 +255,23 @@ public void run() {\n                             // If session queue != null, then it is also not empty.\n                             Request topPending = sessionQueue.poll();\n                             if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                            // we can get commit requests that are not at the queue head after\n    +                            // a session moved (see ZOOKEEPER-2684). We will just pass the\n    +                            // commit to the next processor and put the pending back with\n    +                            // a warning, we should not see this often under normal load\n    +                            LOG.warn(\"Got request \" + request +\n    +                                    \" but we are expecting request \" + topPending);\n    +                            sessionQueue.addFirst(topPending);\n    +                        } else {\n    +                            /*\n    +                             * We want to send our version of the request. the\n    +                             * pointer to the connection in the request\n    +                             */\n    +                            topPending.setHdr(request.getHdr());\n    --- End diff --\n    \n    Would you mind explaining why we normally want to send our version of the request and why it is ok not to in this case?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T02:37:11.072+0000","updated":"2017-10-31T02:37:11.072+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226142","id":"16226142","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r147854977\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/CommitProcessorConcurrencyTest.java ---\n    @@ -376,4 +377,123 @@ public void noStarvationOfReadRequestsTest() throws Exception {\n                         !processedRequests.contains(r));\n             }\n         }\n    +\n    +    /**\n    +     * In the following test, we verify that we can handle the case that we got a commit\n    +     * of a request we never seen since the session that we just established. This can happen\n    +     * when a session is just established and there is request waiting to be committed in the\n    +     * in the session queue but it sees a commit for a request that belongs to the previous connection.\n    --- End diff --\n    \n    typo: \"in the in the\"\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T02:37:11.073+0000","updated":"2017-10-31T02:37:11.073+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226888","id":"16226888","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user kfirlevari commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r148014302\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/CommitProcessorConcurrencyTest.java ---\n    @@ -376,4 +377,123 @@ public void noStarvationOfReadRequestsTest() throws Exception {\n                         !processedRequests.contains(r));\n             }\n         }\n    +\n    +    /**\n    +     * In the following test, we verify that we can handle the case that we got a commit\n    +     * of a request we never seen since the session that we just established. This can happen\n    +     * when a session is just established and there is request waiting to be committed in the\n    +     * in the session queue but it sees a commit for a request that belongs to the previous connection.\n    +     */\n    +    @Test(timeout = 1000)\n    +    public void noCrashOnCommittedRequestsOfUnseenRequestTest() throws Exception {\n    +        final String path = \"/noCrash/OnCommittedRequests/OfUnseenRequestTest\";\n    +        final int numberofReads = 10;\n    +        final int sessionid = 0x123456;\n    +        final int firstCXid = 0x100;\n    +        int readReqId = firstCXid;\n    +        processor.stoppedMainLoop = true;\n    +        HashSet<Request> localRequests = new HashSet<Request>();\n    +        // queue the blocking write request to queuedRequests\n    +        Request firstCommittedReq = newRequest(\n    +                new CreateRequest(path, new byte[0], Ids.OPEN_ACL_UNSAFE,\n    +                        CreateMode.PERSISTENT_SEQUENTIAL.toFlag()),\n    +                OpCode.create, sessionid, readReqId++);\n    +        processor.queuedRequests.add(firstCommittedReq);\n    +        localRequests.add(firstCommittedReq);\n    +\n    +        // queue read requests to queuedRequests\n    +        for (; readReqId <= numberofReads+firstCXid; ++readReqId) {\n    +            Request readReq = newRequest(new GetDataRequest(path, false),\n    +                    OpCode.getData, sessionid, readReqId);\n    +            processor.queuedRequests.add(readReq);\n    +            localRequests.add(readReq);\n    +        }\n    +\n    +        //run once\n    +        Assert.assertTrue(processor.queuedRequests.containsAll(localRequests));\n    +        processor.initThreads(numberofReads* 2);\n    +        processor.run();\n    +\n    +        //We verify that the processor is waiting for the commit\n    +        Assert.assertTrue(processedRequests.isEmpty());\n    +\n    +        // We add a commit that belongs to the same session but with smaller cxid,\n    +        // i.e., commit of an update from previous connection of this session.\n    +        Request preSessionCommittedReq = newRequest(\n    +                new CreateRequest(path, new byte[0], Ids.OPEN_ACL_UNSAFE,\n    +                        CreateMode.PERSISTENT_SEQUENTIAL.toFlag()),\n    +                OpCode.create, sessionid, firstCXid - 2);\n    +        processor.committedRequests.add(preSessionCommittedReq);\n    +        processor.committedRequests.add(firstCommittedReq);\n    +        processor.run();\n    +\n    +        //We verify that the commit processor processed the old commit prior to the newer messages\n    +        Assert.assertTrue(processedRequests.peek() == preSessionCommittedReq);\n    +\n    +        processor.run();\n    +\n    +        //We verify that the commit processor handle all messages.\n    +        Assert.assertTrue(processedRequests.containsAll(localRequests));\n    +    }\n    +\n    +    /**\n    +     * In the following test, we verify if we handle the case in which we get a commit\n    +     * for a request that has higher Cxid than the one we are waiting. This can happen\n    +     * when a session connection is lost but there is a request waiting to be committed in the\n    +     * session queue. However, since the session has moved, new requests can get to\n    +     * the leader out of order. Hence, the commits can also arrive \"out of order\" w.r.t. cxid.\n    +     * We should commit the requests according to the order we receive from the leader, i.e., wait for the relevant commit.\n    --- End diff --\n    \n    Regarding 2 - I've answered the question also in the new comments. I think we shouldn't empty the queue because it is possible that the session returned to us (i.e., moved back). It does no harm to keep the old requests, given that the cnxn handle in the old request shows that the old connection is closed.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T14:35:04.863+0000","updated":"2017-10-31T14:35:04.863+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226889","id":"16226889","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user kfirlevari commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r148014452\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/CommitProcessorConcurrencyTest.java ---\n    @@ -376,4 +377,123 @@ public void noStarvationOfReadRequestsTest() throws Exception {\n                         !processedRequests.contains(r));\n             }\n         }\n    +\n    +    /**\n    +     * In the following test, we verify that we can handle the case that we got a commit\n    +     * of a request we never seen since the session that we just established. This can happen\n    +     * when a session is just established and there is request waiting to be committed in the\n    +     * in the session queue but it sees a commit for a request that belongs to the previous connection.\n    --- End diff --\n    \n    Fixed\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T14:35:35.033+0000","updated":"2017-10-31T14:35:35.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226890","id":"16226890","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user kfirlevari commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r148014638\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -255,24 +255,23 @@ public void run() {\n                             // If session queue != null, then it is also not empty.\n                             Request topPending = sessionQueue.poll();\n                             if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                            // we can get commit requests that are not at the queue head after\n    +                            // a session moved (see ZOOKEEPER-2684). We will just pass the\n    +                            // commit to the next processor and put the pending back with\n    +                            // a warning, we should not see this often under normal load\n    +                            LOG.warn(\"Got request \" + request +\n    +                                    \" but we are expecting request \" + topPending);\n    +                            sessionQueue.addFirst(topPending);\n    +                        } else {\n    +                            /*\n    +                             * We want to send our version of the request. the\n    +                             * pointer to the connection in the request\n    +                             */\n    +                            topPending.setHdr(request.getHdr());\n    --- End diff --\n    \n    I added an explanation, let me know if you meant something more specific. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T14:36:07.497+0000","updated":"2017-10-31T14:36:07.497+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226898","id":"16226898","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1133//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1133//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1133//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T14:40:48.344+0000","updated":"2017-10-31T14:40:48.344+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226899","id":"16226899","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1134//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1134//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1134//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T14:40:49.016+0000","updated":"2017-10-31T14:40:49.016+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226922","id":"16226922","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1131//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1131//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1131//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T14:50:22.538+0000","updated":"2017-10-31T14:50:22.538+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226923","id":"16226923","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1135//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1135//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1135//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T14:50:23.037+0000","updated":"2017-10-31T14:50:23.037+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226924","id":"16226924","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1136//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1136//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1136//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T14:50:23.865+0000","updated":"2017-10-31T14:50:23.865+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16226928","id":"16226928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1132//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1132//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1132//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T14:51:30.583+0000","updated":"2017-10-31T14:51:30.583+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16227448","id":"16227448","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r148115810\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -246,33 +246,51 @@ public void run() {\n                         }\n     \n                         /*\n    -                     * Check if request is pending, if so, update it with the\n    -                     * committed info\n    +                     * Check if request is pending, if so, update it with the committed info\n                          */\n                         LinkedList<Request> sessionQueue = pendingRequests\n                                 .get(request.sessionId);\n                         if (sessionQueue != null) {\n                             // If session queue != null, then it is also not empty.\n                             Request topPending = sessionQueue.poll();\n                             if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                            // TL;DR - we should not encounter this scenario often under normal load.\n    +                            // We pass the commit to the next processor and put the pending back with a warning.\n    +\n    +                            // Generally, we can get commit requests that are not at the queue head after\n    +                            // a session moved (see ZOOKEEPER-2684). Let's denote the previous server of the session\n    +                            // with A, and the server that the session moved to with B (keep in mind that it is\n    +                            // possible that the session already moved from B to a new server C, and maybe C=A).\n    +                            // 1. If request.cxid < topPending.cxid : this means that the session requested this update\n    +                            // from A, then moved to B (i.e., which is us), and now B receives the commit\n    +                            // for the update after the session already performed several operations in B\n    +                            // (and therefore its cxid is higher than that old request).\n    +                            // 2. If request.cxid > topPending.cxid : this means that the session requested an updated\n    +                            // from B with cxid that is bigger than the one we know therefore in this case we\n    +                            // are A, and we lost the connection to the session. Given that we are waiting for a commit\n    +                            // for that update, it means that we already sent the request to the leader and it will\n    +                            // be committed at some point (in this case the order of cxid won't follow zxid, since zxid\n    +                            // is an increasing order). It is not safe for us to delete the session's queue at this\n    +                            // point, since it is possible that the session has newer requests in it after it moved\n    +                            // back to us. We just leave the queue as it is, and once the commit arrives (for the old\n    +                            // request), the finalRequestProcessor will see a closed cnxn handle, and just won't send a\n    +                            // response.\n    +                            // Also note that we don't have a local session, therefore we treat the request\n    +                            // like any other commit for a remote request, i.e., we perform the update without sending\n    +                            // a response.\n    +\n    +                            LOG.warn(\"Got request \" + request +\n    +                                    \" but we are expecting request \" + topPending);\n    +                            sessionQueue.addFirst(topPending);\n    +                        } else {\n    +                            // We want to send to the next processor our version of the request,\n    +                            // since it contains the session information that is needed\n    +                            // for post update processing (e.g., using request.cnxn we send a response to the client).\n    +                            topPending.setHdr(request.getHdr());\n    --- End diff --\n    \n    The explanation is really great. I was also hoping you could shed some light on this part of the code. Why do we \"want to send to the next processor our version of the request\" and why can we proceed in the other case if this is required here?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T20:20:12.060+0000","updated":"2017-10-31T20:20:12.060+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16227449","id":"16227449","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r148113899\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -246,33 +246,51 @@ public void run() {\n                         }\n     \n                         /*\n    -                     * Check if request is pending, if so, update it with the\n    -                     * committed info\n    +                     * Check if request is pending, if so, update it with the committed info\n                          */\n                         LinkedList<Request> sessionQueue = pendingRequests\n                                 .get(request.sessionId);\n                         if (sessionQueue != null) {\n                             // If session queue != null, then it is also not empty.\n                             Request topPending = sessionQueue.poll();\n                             if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                            // TL;DR - we should not encounter this scenario often under normal load.\n    --- End diff --\n    \n    I hate to be \"that guy\" but we generally use \"/*\" comments for long blocks like this.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T20:20:12.248+0000","updated":"2017-10-31T20:20:12.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16227461","id":"16227461","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user shralex commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r148117464\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -246,33 +246,51 @@ public void run() {\n                         }\n     \n                         /*\n    -                     * Check if request is pending, if so, update it with the\n    -                     * committed info\n    +                     * Check if request is pending, if so, update it with the committed info\n                          */\n                         LinkedList<Request> sessionQueue = pendingRequests\n                                 .get(request.sessionId);\n                         if (sessionQueue != null) {\n                             // If session queue != null, then it is also not empty.\n                             Request topPending = sessionQueue.poll();\n                             if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                            // TL;DR - we should not encounter this scenario often under normal load.\n    +                            // We pass the commit to the next processor and put the pending back with a warning.\n    +\n    +                            // Generally, we can get commit requests that are not at the queue head after\n    +                            // a session moved (see ZOOKEEPER-2684). Let's denote the previous server of the session\n    +                            // with A, and the server that the session moved to with B (keep in mind that it is\n    +                            // possible that the session already moved from B to a new server C, and maybe C=A).\n    +                            // 1. If request.cxid < topPending.cxid : this means that the session requested this update\n    +                            // from A, then moved to B (i.e., which is us), and now B receives the commit\n    +                            // for the update after the session already performed several operations in B\n    +                            // (and therefore its cxid is higher than that old request).\n    +                            // 2. If request.cxid > topPending.cxid : this means that the session requested an updated\n    +                            // from B with cxid that is bigger than the one we know therefore in this case we\n    +                            // are A, and we lost the connection to the session. Given that we are waiting for a commit\n    +                            // for that update, it means that we already sent the request to the leader and it will\n    +                            // be committed at some point (in this case the order of cxid won't follow zxid, since zxid\n    +                            // is an increasing order). It is not safe for us to delete the session's queue at this\n    +                            // point, since it is possible that the session has newer requests in it after it moved\n    +                            // back to us. We just leave the queue as it is, and once the commit arrives (for the old\n    +                            // request), the finalRequestProcessor will see a closed cnxn handle, and just won't send a\n    +                            // response.\n    +                            // Also note that we don't have a local session, therefore we treat the request\n    +                            // like any other commit for a remote request, i.e., we perform the update without sending\n    +                            // a response.\n    +\n    +                            LOG.warn(\"Got request \" + request +\n    +                                    \" but we are expecting request \" + topPending);\n    +                            sessionQueue.addFirst(topPending);\n    +                        } else {\n    +                            // We want to send to the next processor our version of the request,\n    +                            // since it contains the session information that is needed\n    +                            // for post update processing (e.g., using request.cnxn we send a response to the client).\n    +                            topPending.setHdr(request.getHdr());\n    --- End diff --\n    \n    My understanding is that when a request is in the local queue, there is (or could be) a client attached to this server waiting for a response, and there is other bookeeping of requests that are outstanding and have originated from this server (e.g., for setting the max outstanding requests) - we need to update this info when an outstanding request completes. In the other case, the operation originated from a different server and there is no local bookeeeping or a local client session that needs to be notified. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T20:26:50.573+0000","updated":"2017-10-31T20:26:50.573+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16227464","id":"16227464","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1137//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1137//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1137//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T20:27:37.883+0000","updated":"2017-10-31T20:27:37.883+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16227480","id":"16227480","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user kfirlevari commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r148119207\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -246,33 +246,51 @@ public void run() {\n                         }\n     \n                         /*\n    -                     * Check if request is pending, if so, update it with the\n    -                     * committed info\n    +                     * Check if request is pending, if so, update it with the committed info\n                          */\n                         LinkedList<Request> sessionQueue = pendingRequests\n                                 .get(request.sessionId);\n                         if (sessionQueue != null) {\n                             // If session queue != null, then it is also not empty.\n                             Request topPending = sessionQueue.poll();\n                             if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                            // TL;DR - we should not encounter this scenario often under normal load.\n    --- End diff --\n    \n    NP ;)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T20:33:08.215+0000","updated":"2017-10-31T20:33:08.215+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16227481","id":"16227481","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1138//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1138//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1138//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T20:33:28.986+0000","updated":"2017-10-31T20:33:28.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16227482","id":"16227482","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user kfirlevari commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/411#discussion_r148119340\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java ---\n    @@ -246,33 +246,51 @@ public void run() {\n                         }\n     \n                         /*\n    -                     * Check if request is pending, if so, update it with the\n    -                     * committed info\n    +                     * Check if request is pending, if so, update it with the committed info\n                          */\n                         LinkedList<Request> sessionQueue = pendingRequests\n                                 .get(request.sessionId);\n                         if (sessionQueue != null) {\n                             // If session queue != null, then it is also not empty.\n                             Request topPending = sessionQueue.poll();\n                             if (request.cxid != topPending.cxid) {\n    -                            LOG.error(\n    -                                    \"Got cxid 0x\"\n    -                                            + Long.toHexString(request.cxid)\n    -                                            + \" expected 0x\" + Long.toHexString(\n    -                                                    topPending.cxid)\n    -                                    + \" for client session id \"\n    -                                    + Long.toHexString(request.sessionId));\n    -                            throw new IOException(\"Error: unexpected cxid for\"\n    -                                    + \"client session\");\n    +                            // TL;DR - we should not encounter this scenario often under normal load.\n    +                            // We pass the commit to the next processor and put the pending back with a warning.\n    +\n    +                            // Generally, we can get commit requests that are not at the queue head after\n    +                            // a session moved (see ZOOKEEPER-2684). Let's denote the previous server of the session\n    +                            // with A, and the server that the session moved to with B (keep in mind that it is\n    +                            // possible that the session already moved from B to a new server C, and maybe C=A).\n    +                            // 1. If request.cxid < topPending.cxid : this means that the session requested this update\n    +                            // from A, then moved to B (i.e., which is us), and now B receives the commit\n    +                            // for the update after the session already performed several operations in B\n    +                            // (and therefore its cxid is higher than that old request).\n    +                            // 2. If request.cxid > topPending.cxid : this means that the session requested an updated\n    +                            // from B with cxid that is bigger than the one we know therefore in this case we\n    +                            // are A, and we lost the connection to the session. Given that we are waiting for a commit\n    +                            // for that update, it means that we already sent the request to the leader and it will\n    +                            // be committed at some point (in this case the order of cxid won't follow zxid, since zxid\n    +                            // is an increasing order). It is not safe for us to delete the session's queue at this\n    +                            // point, since it is possible that the session has newer requests in it after it moved\n    +                            // back to us. We just leave the queue as it is, and once the commit arrives (for the old\n    +                            // request), the finalRequestProcessor will see a closed cnxn handle, and just won't send a\n    +                            // response.\n    +                            // Also note that we don't have a local session, therefore we treat the request\n    +                            // like any other commit for a remote request, i.e., we perform the update without sending\n    +                            // a response.\n    +\n    +                            LOG.warn(\"Got request \" + request +\n    +                                    \" but we are expecting request \" + topPending);\n    +                            sessionQueue.addFirst(topPending);\n    +                        } else {\n    +                            // We want to send to the next processor our version of the request,\n    +                            // since it contains the session information that is needed\n    +                            // for post update processing (e.g., using request.cnxn we send a response to the client).\n    +                            topPending.setHdr(request.getHdr());\n    --- End diff --\n    \n    Updated accordingly\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T20:33:37.487+0000","updated":"2017-10-31T20:33:37.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16227516","id":"16227516","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1141//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1141//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1141//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T20:46:16.209+0000","updated":"2017-10-31T20:46:16.209+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16227546","id":"16227546","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1143//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1143//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1143//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T20:57:16.493+0000","updated":"2017-10-31T20:57:16.493+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16227663","id":"16227663","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"+1 \r\n\r\nThanks a lot, Kfir, LGTM\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-31T21:44:43.452+0000","updated":"2017-10-31T21:44:43.452+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13040862/comment/16237057","id":"16237057","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/411\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-03T04:05:36.583+0000","updated":"2017-11-03T04:05:36.583+0000"}],"maxResults":73,"total":73,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2684/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i39pbb:"}}