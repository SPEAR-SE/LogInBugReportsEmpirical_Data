{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13002764","self":"https://issues.apache.org/jira/rest/api/2/issue/13002764","key":"ZOOKEEPER-2553","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-03-13T07:14:41.818+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Mar 13 18:33:36 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2553/watchers","watchCount":3,"isWatching":false},"created":"2016-09-05T17:20:17.866+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326517","id":"12326517","description":"Fix release against 3.4 branch","name":"3.4.8","archived":false,"released":true,"releaseDate":"2016-02-22"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-03-13T18:33:36.041+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"I am running a three node ZooKeeper cluster. \n\nWhen a new log file is created by ZooKeeper, I see the following sequence of system calls:\n\n1. creat(new_log)\n2. write(new_log, count=16) // This is a log header I believe/\n3. truncate(new_log, from 16 bytes to 16 KBytes) // I have configured the log size to be 16K. \n\nWhen the above sequence of operations complete, it is reasonable to expect the newly created log file to contain the header(16 bytes) and then filled with zeros till the end of the log.\n\nBut when a crash occurs (due to a power failure), while the truncate system call is in progress, it is possible for the log to contain garbage data when the system restarts from the crash. Note that if the crash occurs just after the truncate system call completes, then there is no problem. Basically, the truncate needs to be atomically persisted for ZooKeeper to recover from crashes correctly  or (more realistically) the recovery code needs to deal with the case of expecting garbage in a newly created log. \n\nAs mentioned, if a crash occurs during the truncate system call, then ZooKeeper will fail to start with the following exception. Here is the stack trace:\n\njava.io.IOException: Unreasonable length = -295704495\n        at org.apache.jute.BinaryInputArchive.checkLength(BinaryInputArchive.java:127)\n        at org.apache.jute.BinaryInputArchive.readBuffer(BinaryInputArchive.java:92)\n        at org.apache.zookeeper.server.persistence.Util.readTxnBytes(Util.java:233)\n        at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:625)\n        at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:652)\n        at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.init(FileTxnLog.java:552)\n        at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.<init>(FileTxnLog.java:527)\n        at org.apache.zookeeper.server.persistence.FileTxnLog.read(FileTxnLog.java:354)\n        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:132)\n        at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:223)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:510)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:500)\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:153)\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:111)\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)\n[myid:1] - ERROR [main:QuorumPeerMain@89] - Unexpected exception, exiting abnormally\njava.lang.RuntimeException: Unable to run quorum server\n        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:558)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:500)\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:153)\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:111)\n        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)\nCaused by: java.io.IOException: Unreasonable length = -295704495\n        at org.apache.jute.BinaryInputArchive.checkLength(BinaryInputArchive.java:127)\n        at org.apache.jute.BinaryInputArchive.readBuffer(BinaryInputArchive.java:92)\n        at org.apache.zookeeper.server.persistence.Util.readTxnBytes(Util.java:233)\n        at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:625)\n        at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:652)\n        at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.init(FileTxnLog.java:552)\n        at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.<init>(FileTxnLog.java:527)\n        at org.apache.zookeeper.server.persistence.FileTxnLog.read(FileTxnLog.java:354)\n        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:132)\n        at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:223)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:510)\n        ... 4 more\n\n\nNext, it is possible for two nodes of a 3-node  ZooKeeper cluster to reach the same state. In that case, they both will fail to startup, rendering the entire cluster unavailable. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ZooKeeper cluster unavailable due to corrupted log file during power failures -- java.io.IOException: Unreasonable length","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ramanala","name":"ramanala","key":"ramanala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ramnatthan Alagappan","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ramanala","name":"ramanala","key":"ramanala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ramnatthan Alagappan","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Normal ZooKeeper cluster with 3 nodes running Linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13002764/comment/15906944","id":"15906944","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=randgalt","name":"randgalt","key":"randgalt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=randgalt&avatarId=16746","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=randgalt&avatarId=16746","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=randgalt&avatarId=16746","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=randgalt&avatarId=16746"},"displayName":"Jordan Zimmerman","active":true,"timeZone":"America/Panama"},"body":"https://blog.acolyer.org/2017/03/08/redundancy-does-not-imply-fault-tolerance-analysis-of-distributed-storage-reactions-to-single-errors-and-corruptions/","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=randgalt","name":"randgalt","key":"randgalt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=randgalt&avatarId=16746","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=randgalt&avatarId=16746","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=randgalt&avatarId=16746","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=randgalt&avatarId=16746"},"displayName":"Jordan Zimmerman","active":true,"timeZone":"America/Panama"},"created":"2017-03-13T07:14:41.818+0000","updated":"2017-03-13T07:14:41.818+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13002764/comment/15922688","id":"15922688","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"This issue is not explicitly mentioned in the paper. The paper is more about ZOOKEEPER-2247 which is fixed in 3.4.9. \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-03-13T18:33:36.041+0000","updated":"2017-03-13T18:33:36.041+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2553/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3397z:"}}