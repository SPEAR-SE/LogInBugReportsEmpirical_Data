{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12539194","self":"https://issues.apache.org/jira/rest/api/2/issue/12539194","key":"ZOOKEEPER-1367","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12319288","id":"12319288","description":"Fix release against 3.4 branch","name":"3.4.3","archived":false,"released":true,"releaseDate":"2012-02-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12319081","id":"12319081","description":"Fix release against 3.3 branch","name":"3.3.5","archived":false,"released":true,"releaseDate":"2012-03-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-01-20T20:19:34.615+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Aug 28 22:20:04 UTC 2013","customfield_12310420":"224696","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_276162486_*|*_1_*:*_1_*:*_631530360_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-01-31T06:56:13.795+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1367/watchers","watchCount":8,"isWatching":false},"created":"2012-01-20T18:48:01.113+0000","customfield_12310192":"Fix Data inconsistencies and unexpired ephemeral nodes after cluster restart.","customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12319196","id":"12319196","description":"Fix release against 3.4 branch.","name":"3.4.2","archived":false,"released":true,"releaseDate":"2011-12-29"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-08-28T22:20:04.065+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"In one of our tests, we have a cluster of three ZooKeeper servers.  We kill all three, and then restart just two of them.  Sometimes we notice that on one of the restarted servers, ephemeral nodes from previous sessions do not get deleted, while on the other server they do.  We are effectively running 3.4.2, though technically we are running 3.4.1 with the patch manually applied for ZOOKEEPER-1333 and a C client for 3.4.1 with the patches for ZOOKEEPER-1163.\n\nI noticed that when I connected using zkCli.sh to the first node (90.0.0.221, zkid 84), I saw only one znode in a particular path:\n\n{quote}\n[zk: 90.0.0.221:2888(CONNECTED) 0] ls /election/zkrsm\n[nominee0000000011]\n[zk: 90.0.0.221:2888(CONNECTED) 1] get /election/zkrsm/nominee0000000011\n90.0.0.222:7777 \ncZxid = 0x400000027\nctime = Thu Jan 19 08:18:24 UTC 2012\nmZxid = 0x400000027\nmtime = Thu Jan 19 08:18:24 UTC 2012\npZxid = 0x400000027\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0xa234f4f3bc220001\ndataLength = 16\nnumChildren = 0\n{quote}\n\nHowever, when I connect zkCli.sh to the second server (90.0.0.222, zkid 251), I saw three znodes under that same path:\n\n{quote}\n[zk: 90.0.0.222:2888(CONNECTED) 2] ls /election/zkrsm\nnominee0000000006   nominee0000000010   nominee0000000011\n[zk: 90.0.0.222:2888(CONNECTED) 2] get /election/zkrsm/nominee0000000011\n90.0.0.222:7777 \ncZxid = 0x400000027\nctime = Thu Jan 19 08:18:24 UTC 2012\nmZxid = 0x400000027\nmtime = Thu Jan 19 08:18:24 UTC 2012\npZxid = 0x400000027\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0xa234f4f3bc220001\ndataLength = 16\nnumChildren = 0\n[zk: 90.0.0.222:2888(CONNECTED) 3] get /election/zkrsm/nominee0000000010\n90.0.0.221:7777 \ncZxid = 0x30000014c\nctime = Thu Jan 19 07:53:42 UTC 2012\nmZxid = 0x30000014c\nmtime = Thu Jan 19 07:53:42 UTC 2012\npZxid = 0x30000014c\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0xa234f4f3bc220000\ndataLength = 16\nnumChildren = 0\n[zk: 90.0.0.222:2888(CONNECTED) 4] get /election/zkrsm/nominee0000000006\n90.0.0.223:7777 \ncZxid = 0x200000cab\nctime = Thu Jan 19 08:00:30 UTC 2012\nmZxid = 0x200000cab\nmtime = Thu Jan 19 08:00:30 UTC 2012\npZxid = 0x200000cab\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x5434f5074e040002\ndataLength = 16\nnumChildren = 0\n{quote}\n\nThese never went away for the lifetime of the server, for any clients connected directly to that server.  Note that this cluster is configured to have all three servers still, the third one being down (90.0.0.223, zkid 162).\n\nI captured the data/snapshot directories for the the two live servers.  When I start single-node servers using each directory, I can briefly see that the inconsistent data is present in those logs, though the ephemeral nodes seem to get (correctly) cleaned up pretty soon after I start the server.\n\nI will upload a tar containing the debug logs and data directories from the failure.  I think we can reproduce it regularly if you need more info.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12512285","id":"12512285","filename":"1367-3.3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T04:27:43.539+0000","size":8259,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12512285/1367-3.3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12512280","id":"12512280","filename":"ZOOKEEPER-1367.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T03:13:31.929+0000","size":16276,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12512280/ZOOKEEPER-1367.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12512274","id":"12512274","filename":"ZOOKEEPER-1367.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T02:12:56.115+0000","size":15170,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12512274/ZOOKEEPER-1367.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12511304","id":"12511304","filename":"ZOOKEEPER-1367.tgz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-20T18:51:12.383+0000","size":5308121,"mimeType":"application/x-compressed-tar","content":"https://issues.apache.org/jira/secure/attachment/12511304/ZOOKEEPER-1367.tgz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12512604","id":"12512604","filename":"ZOOKEEPER-1367-3.3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-31T18:17:12.846+0000","size":12562,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12512604/ZOOKEEPER-1367-3.3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12512281","id":"12512281","filename":"ZOOKEEPER-1367-3.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T03:36:02.810+0000","size":16271,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12512281/ZOOKEEPER-1367-3.4.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32593","customfield_12312823":null,"summary":"Data inconsistencies and unexpired ephemeral nodes after cluster restart","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Debian Squeeze, 64-bit","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13189992","id":"13189992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"Contains logs and data/snapshot dirs for 90.0.0.221 and 90.0.0.222.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-20T18:51:12.491+0000","updated":"2012-01-20T18:51:12.491+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190066","id":"13190066","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"I'll take a look this weekend unless someone's on it now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-20T20:19:34.615+0000","updated":"2012-01-20T20:19:34.615+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190091","id":"13190091","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"body":"This sort of issue is usually a configuration bug.  Can you post your configs as well?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-20T20:51:03.380+0000","updated":"2012-01-20T20:51:03.380+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190101","id":"13190101","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"There are no config file -- we embed Zookeeper into our application framework and set up things through code.  I'm not sure what you're looking for exactly -- I've given the IPs and ZK ids of the servers above.  Besides that, we set up specific client, election, and server ports (those shouldn't matter), and put the snapshot and log directories together in the same place (I know, I know -- we're working on teasing them apart, but it's not currently a bottleneck for our application).  Tick time and election algorithm are the default.  Clients request a session timeout of 1 second, which means they get the default timeout of 2 times the default tick time.  Let me know if you are asking about some other config value.\n\nI certainly wouldn't be surprised if it's a problem with our use of Zookeeper, since we use it in a non-traditional way, but this scenario was so simple that nothing jumps to mind immediately that could cause it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-20T20:59:16.743+0000","updated":"2012-01-20T20:59:16.743+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190121","id":"13190121","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"body":"Jeremy,\n\nHow do you absolutely verify that all three nodes know about all three of the other nodes and that they have the correct zkid's?\n\nThis isn't a matter of what your code looks like on the face, or what the intent is.  The question is how do you ask each node's ZK instance about the configuration?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-20T21:18:43.069+0000","updated":"2012-01-20T21:18:43.069+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190131","id":"13190131","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"I'd like to avoid getting into the exact algorithmic details about our code, but the nodes share their local information to a central component via RPC that then updates each server with the full list, before any of them even start ZK in the first place.  We print this info out in another log, and I've verified that it's the same on the two live nodes before ZK starts.  That configuration info is:\n\n{quote}\n\"90.0.0.223\"\nclient_port: 2888\nserver_port: 2878\nelection_port: 3888\nserver_id: 162\nuuid: \"69dfc0f4-d2b7-4ee4-9dee-cf2bde2e386f\"\n\n\"90.0.0.221\"\nclient_port: 2888\nserver_port: 2878\nelection_port: 3888\nserver_id: 84\nuuid: \"2df0e0f4-612b-43b9-8871-52f601468577\"\n\n\"90.0.0.222\"\nclient_port: 2888\nserver_port: 2878\nelection_port: 3888\nserver_id: 251\nuuid: \"0e24e45e-7939-46b5-85b8-63919fab03b8\"\n{quote}\n\nFurthermore, we were running this exact same way with 3.3.3 for more than a year, and this particular test has always passed.  So unless we were doing something bad before and 3.4 now enforces it, or some new requirements crept into 3.4, I'm pretty confident in saying that our setup is consistent across both live nodes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-20T21:26:31.837+0000","updated":"2012-01-20T21:26:31.837+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190150","id":"13190150","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"body":"IF this were my system, I would interpret what you just said as \"we know what we are feeding to ZK\", but I would not say \"we know that ZK got the right config\".  \n\nYour point about the difference in behavior between 3.3 and 3.4 is very important, but we still need to lock down where the difference is.  Camille will be looking at the logs, but we still need to verify that the configs got to the right place.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-20T21:51:29.868+0000","updated":"2012-01-20T21:51:29.868+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190283","id":"13190283","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"@Camille, \n Great. Ill also dig in during the weekend. Hopefully you'll find it before I take a look :). \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-21T02:57:36.928+0000","updated":"2012-01-21T02:57:36.928+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190518","id":"13190518","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Jeremy pretty much always brings us good bugs, Ted, I don't think he's wasting our time.\n\nJeremy, these logs are from the point at which the cluster is running with two members and 221 doesn't have the nodes, but 222 does, correct?\n\nI'm noticing that in the log files I don't see a close session transaction for the session that created /election/zkrsm/nominee0000000010. Just verifying, the cluster is accepting write requests and client connections successfully at the point you captured these logs right? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-21T19:46:48.486+0000","updated":"2012-01-21T19:46:48.486+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190528","id":"13190528","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"So I pulled up a cluster on my local machine using these logs, and the two machines in my cluster did expire correctly all the ephemeral nodes you show in the errors. I'm going to assume that when you bring up a 2 node cluster with your setup and these data directories, you see the bad ephemeral nodes, correct? If so, can you try doing it with the latest 3.4.2 jar and see if it still happens?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-21T20:48:43.517+0000","updated":"2012-01-21T20:48:43.517+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190529","id":"13190529","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"That's correct Camille, 221 has what I think is the correct state -- specifically that nominee0000000006 and nominee0000000010 has been deleted.  I'm pretty sure those were ephemeral nodes that were created before the cluster was restarted -- hence the sessions that created them did not connect to the cluster during the session that these logs show.  Unfortunately I don't have the logs from the run of the cluster where these nodes were created.\n\nAnother thing I should mention about the logs is that they are just the first 100 MB or so of the session.  Our logs roll over after 100 MB, and in the tgz I only includes the first 100MB of the cluster's lifetime.  I didn't think anything particularly interesting happened after that, but if you need the rest let me know.\n\nMy clients were definitely successfully connected to node 222, and as far as I can tell it was accepting writes (I think nominee0000000011 is from a successful write during this cluster run).  For example, /zkrsm/cpt-0000000000000000-0000000000000000/0000000000000000_record0000004054 was created successfully.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-21T20:54:38.150+0000","updated":"2012-01-21T20:54:38.150+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190531","id":"13190531","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"{quote}\nSo I pulled up a cluster on my local machine using these logs, and the two machines in my cluster did expire correctly all the ephemeral nodes you show in the errors. I'm going to assume that when you bring up a 2 node cluster with your setup and these data directories, you see the bad ephemeral nodes, correct? If so, can you try doing it with the latest 3.4.2 jar and see if it still happens?\n{quote}\n\nI haven't tried it with a 2-node cluster yet.  I tried a 1-node cluster with each of the data directories, and yes I noticed that they both successfully deleted the ephemerals after a very short period of time.  I saw the bad ones only very briefly before they were deleted (as I would expect).  I can try a 2-node cluster with the latest jar (I will if I get some time later today), but I suspect that it will also behave correctly.  I think this session covered by the logs was the exception.\n\nBy \"doing it\", do you mean re-running the whole test with the latest 3.4.2 jar?  Is there something fixed besides 1333 that you suspect could have been the culprit?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-21T20:58:10.961+0000","updated":"2012-01-21T20:58:10.961+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190566","id":"13190566","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Hmmm I must be confused. I thought that the test you were running resulted in these the cluster in this setup, with the two nodes running and a third down, with these data directories. But if I start the cluster with two nodes and these data directories, the sessions immediately expire and delete those nodes. On the other hand, in the logs I don't see any evidence of session expiration for the sessions holding the ephemerals on either machine. When you get into this situation, if you bounce the cluster again with the two nodes does it fix the problem? \n\nI don't know if there's anything in 3.4.2 without checking but it seems like a worthwhile sanity check to do.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-22T00:12:26.780+0000","updated":"2012-01-22T00:12:26.780+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13190569","id":"13190569","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"{quote}\nHmmm I must be confused. I thought that the test you were running resulted in these the cluster in this setup, with the two nodes running and a third down, with these data directories. But if I start the cluster with two nodes and these data directories, the sessions immediately expire and delete those nodes. On the other hand, in the logs I don't see any evidence of session expiration for the sessions holding the ephemerals on either machine. When you get into this situation, if you bounce the cluster again with the two nodes does it fix the problem?\n{quote}\n\nVery sorry for not being clear.  I didn't capture the data directories for the system until after it was already in this state, so these data directories probably aren't exactly the same as the one the system started with when it got into a bad state (though they likely contain a superset of the logs/snapshots that were present at the time).  Later, when I manually tried to restart the system (in a 1-node configuration) using the data directories, I saw the same thing you did -- the ephemerals went away correctly.\n\nI did attempt bouncing the system live.  The setup is being run by a different team in my company (QA); I will try to get them to reproduce with straight 3.4.2, but it will take a few days.  I do suspect that bouncing it would fix the problem, since my manual restarting it later fixes things.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-22T00:35:47.252+0000","updated":"2012-01-22T00:35:47.252+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13191531","id":"13191531","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Some initial thoughts, things I hadn't seen mentioned already in this thread:\n\nOne thing to note - znodes 6 10 and 11 are each created in a different epoch (2,3,4 respectively). So in each case leadership must have changed hands. Also note each is a different ephemeralOwner session id.\n\nAlso notice the ctime of each of these znodes - znode 10 was created against a leader that's 10-20 minutes behind the other server(s). That said, it's not likely this is causing the issue but it is a variable. Might be good for you to rule it out by running ntp or something to update all the hosts.\n\nAnything special about these server hosts? For example are they virtualized? Anything else you can think of out of the ordinary - ordinary being the servers are run on dedicated non-virtualized hosts.\n\nAre you using multi for this or the pre-3.4 api only? Ie did you upgrade to 3.4, start using multi, then see this issue? Or just update to 3.4 from 3.3 with essentially no changes and see it start happening?\n\nIf you use 4letterwords to query the server (use 'dump' in this case) when you're in this bad state, what does it say about the ephemeralOwner session id of the ephemeral znode that shouldn't be there but is? Run this against each of the live servers.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-23T22:07:16.801+0000","updated":"2012-01-23T22:07:16.801+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13191568","id":"13191568","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"Thanks very much for your thoughts.  Inline:\n\n{quote}\nOne thing to note - znodes 6 10 and 11 are each created in a different epoch (2,3,4 respectively). So in each case leadership must have changed hands. Also note each is a different ephemeralOwner session id.\n{quote}\n\nYeah, that's not surprising.  Due to the nature of our ZooKeeper embedding, we need to restart all the ZK servers every time a new node comes up, probably leading to new internal ZK elections.\n\n{quote}\nAlso notice the ctime of each of these znodes - znode 10 was created against a leader that's 10-20 minutes behind the other server(s). That said, it's not likely this is causing the issue but it is a variable. Might be good for you to rule it out by running ntp or something to update all the hosts.\n{quote}\n\nThat's a good catch, and probably something I should have mentioned earlier.  I thought ZK didn't care much about wall-clock time, but obviously it would make the logs harder to read.  Here are the relative times of the 3 servers during the test:\n\n{noformat}\n90.0.0.221: Thu Jan 19 18:42:00 UTC 2012 (base)\n90.0.0.222: Thu Jan 19 18:26:55 UTC 2012 (-15:05)\n90.0.0.223: Thu Jan 19 18:17:50 UTC 2012 (-24:10)\n{noformat}\n\nCould that affect ZK correctness?\n\n{quote}\nAnything special about these server hosts? For example are they virtualized? Anything else you can think of out of the ordinary - ordinary being the servers are run on dedicated non-virtualized hosts.\n{quote}\n\nAs they run as part of our automated QA testing, they are virtualized 3- or 5- to a box on ESX.  Again, this hasn't changed since we were using 3.3.3, but I understand it's not the desired setup.  We runon bare metal in production, this is just for testing.\n\n{quote}\nAre you using multi for this or the pre-3.4 api only? Ie did you upgrade to 3.4, start using multi, then see this issue? Or just update to 3.4 from 3.3 with essentially no changes and see it start happening?\n{quote}\n\nPre-3.4 api only, no multi commands.  No changes to our application code after the upgrade.\n\n{quote}\nIf you use 4letterwords to query the server (use 'dump' in this case) when you're in this bad state, what does it say about the ephemeralOwner session id of the ephemeral znode that shouldn't be there but is? Run this against each of the live servers.\n{quote}\n\nI have not tried this.  If I can wrangle the QA team into re-running the test, I will give this a try and report back.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-23T22:37:26.582+0000","updated":"2012-01-23T22:37:26.582+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13191598","id":"13191598","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. we need to restart all the ZK servers\n\nHm..... very interesting. What exactly does this mean? You mentioned earlier that you \"embed Zookeeper into our application framework and set up things through code\" how exactly are you performing this \"restart\". Is ZK a separate process, are you killing processes, or are you calling some code to effect this? I ask because we really don't support this and I'm wondering if that could be related.\n\nIf I wanted to setup a junit test how might I go about doing it? If you could provide some insight it might help in reproducing.\n\nbq. I thought ZK didn't care much about wall-clock time\n\nthat's true, but the more variables we can eliminate the more easy it will be to track the real issue down.\n\nbq. I have not tried this. If I can wrangle the QA team into re-running the test, I will give this a try and report back.\n\nI suspect that the session is not getting cleared until after restarting the cluster, but this would help to verify (I need to dig into your attachment, planning to look at that next).\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-23T23:14:24.535+0000","updated":"2012-01-23T23:14:24.535+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13191619","id":"13191619","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"btw, if you do have QA retest this please do capture all the logs (log4j). Unfortunately the two logs don't both show the znode expiring (I see the time in question in one but not the other log), that would give much more insight into what happened...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-23T23:30:53.641+0000","updated":"2012-01-23T23:30:53.641+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13191650","id":"13191650","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"bq. Hm..... very interesting. What exactly does this mean? You mentioned earlier that you \"embed Zookeeper into our application framework and set up things through code\" how exactly are you performing this \"restart\". Is ZK a separate process, are you killing processes, or are you calling some code to effect this? I ask because we really don't support this and I'm wondering if that could be related.\n\nZK is embedded into a java process, running alongside some other java apps we need to manage.  The reason for this is that dynamic cluster membership is absolutely required for our application; we cannot know the IPs/ports/server IDs of all of the Zookeeper servers that will exist in the cluster.  So as new nodes come online, they connect to a centralized part of our service, and we distribute the new list of servers to all the existing servers, so they can restart themselves.  By \"restart\" here, I mean we call QuorumPeer.shutdown (and FastleaderElection.shutdown), delete the previous QuorumPeer, and construct a new one with the new configuration.\n\nThis is the same way we ran things under 3.3.3.  I understand that this is not officially supported, but in my heart of hearts I don't believe it is related to the bug at hand, so I appreciate your indulgence on the matter.\n\nbq. that's true, but the more variables we can eliminate the more easy it will be to track the real issue down.\n\nWe are supposed to be running with synced clocks, but QA is trying to track down a bug with their system right now to figure out why NTP isn't working in their environment.  Sorry for the extra level of confusion.\n\nbq. btw, if you do have QA retest this please do capture all the logs (log4j). Unfortunately the two logs don't both show the znode expiring (I see the time in question in one but not the other log), that would give much more insight into what happened...\n\nI don't quite follow your question.  Do you mean that my logs aren't capturing all of the output logged by ZooKeeper?  Or are you asking for the logs from the previous run of the system, when the znodes were originally created?  I will definitely try to get the latter, but as for the former problem -- this is everything that ZooKeeper logged, so I'm not sure what else I can capture during the run.\n\nI think the very problem is that one of the nodes didn't expire one of the sessions, so I wouldn't expect that to be in the log for that server.  But maybe I don't quite understand what you're asking.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-24T00:03:32.784+0000","updated":"2012-01-24T00:03:32.784+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13191652","id":"13191652","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"jeremy, with this embedding, do you ever change the set of machines you are using? like do you ever go from using machines A,B,C to machines A,B,C,D,E?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-24T00:05:26.221+0000","updated":"2012-01-24T00:05:26.221+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13191674","id":"13191674","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"bq. jeremy, with this embedding, do you ever change the set of machines you are using? like do you ever go from using machines A,B,C to machines A,B,C,D,E?\n\nYes, though we only add or remove one node at a time.  So when the system first comes up, we actually do {A} -> {A, B} -> {A, B, C}.  I know the first step is potentially problematic because there's no majority from the previous cluster present in the new cluster, but we make sure A comes up first.  Small comfort I know, but that's the best we've been able to do until real dynamic cluster membership is available.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-24T00:21:22.904+0000","updated":"2012-01-24T00:21:22.904+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13191710","id":"13191710","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"I just noticed something that doesn't look good:\n\nI started a 2 server ensemble, connected a client, then stopped/started the leader. I noticed that:\n\n1) the follower does not create a snapshot after reconnecting to the new leader (the same leader is re-elected to be the leader in epoch 3 as was lead in epoch 2)\n2) the follower continues to write changes from epoch 3 into the log from epoch 2.\n\n{noformat}\njava -cp '/home/phunt/Downloads/zk1367/jars/*' org.apache.zookeeper.server.LogFormatter log.200000001 \nZooKeeper Transactional Log File with dbid 0 txnlog format version 2\n1/23/12 4:39:45 PM PST session 0x1350d25cc790000 cxid 0x0 zxid 0x200000001 createSession 30000\n\n1/23/12 4:41:02 PM PST session 0x1350d25cc790000 cxid 0x2 zxid 0x300000001 create '/foo,#626172,v{s{31,s{'world,'anyone}}},F,1\n\n1/23/12 4:44:10 PM PST session 0x1350d25cc790000 cxid 0x4 zxid 0x300000002 closeSession null\n1/23/12 4:44:26 PM PST session 0x1350d283e690000 cxid 0x0 zxid 0x300000003 createSession 30000\n\n1/23/12 4:44:43 PM PST session 0x1350d283e690000 cxid 0x2 zxid 0x300000004 closeSession null\n1/23/12 4:44:51 PM PST session 0x2350d283e5c0000 cxid 0x0 zxid 0x300000005 createSession 30000\n\n1/23/12 4:45:10 PM PST session 0x2350d283e5c0000 cxid 0x2 zxid 0x300000006 closeSession null\n1/23/12 4:45:17 PM PST session 0x1350d283e690001 cxid 0x0 zxid 0x300000007 createSession 30000\n\nEOF reached after 8 txns.\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-24T01:02:08.411+0000","updated":"2012-01-24T01:02:08.411+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13191793","id":"13191793","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Hm, maybe not an issue - the new epoch tracking tracking code seemed to handle this ok. I also tried shutting down, deleting the old leader datadir, and restarting and the new leader tracked the changes properly...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-24T01:26:28.132+0000","updated":"2012-01-24T01:26:28.132+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13191797","id":"13191797","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"fwiw I did file ZOOKEEPER-1372 which does seems like a valid issue, although not related to this afaik ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-24T01:34:04.878+0000","updated":"2012-01-24T01:34:04.878+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13192863","id":"13192863","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"so when you say that you only add or remove one node at a time. does that mean you:\n\n1) have a running cluster\n2) take it done\n3) change the configuration to add a node\n4) start the cluster back up\n5) wait until a leader becomes active\n\nyou only add or remove the next steps after you have completed all 5 steps for the previous configuration?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-25T05:12:01.158+0000","updated":"2012-01-25T05:12:01.158+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13192870","id":"13192870","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"{quote}\nso when you say that you only add or remove one node at a time. does that mean you:\n\n1) have a running cluster\n2) take it done\n3) change the configuration to add a node\n4) start the cluster back up\n5) wait until a leader becomes active\n\nyou only add or remove the next steps after you have completed all 5 steps for the previous configuration?\n{quote}\n\nThat's more or less correct, except that steps 2-5 are being executed in parallel on all the nodes to speed things up, so they are not proceeding in lockstep across the cluster.  We wait for all nodes to complete the 5 steps before moving on to the next node, if there is one.\n\nI am still working on getting this reproduced by QA.  They said they've fixed the NTP issues, so hopefully the new logs will be easier to work with if we can get it to happen again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-25T06:04:25.628+0000","updated":"2012-01-25T06:04:25.628+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13193204","id":"13193204","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Looks like Ben is on to something here. I investigated this more and found the following:\n\nFirst off the problem statement is not correct - it's not that sessions are expiring/closing and ephemerals are hanging around on some servers. What's really happening is that the session is not being closed/expired at all. I can see in the txn logs where the session is created, but I never see the session closed. This goes for the sessions for both znodes 6 and 10. As far as the servers know the session is created but never explicitly closed/expired. (also the znode itself is never explicitly deleted via a client)\n\nsee this log msg for the location I'm talking about:\n\n2012-01-19 08:18:17,175 30953 [QuorumPeer[myid=84]/90.0.0.221:2888] TRACE org.apache.zookeeper.server.ZooKeeperServer  - ZooKeeperServer --- killSession: 0xa234f4f3bc220000\n\n\nLet's now talk more about ephemeral znode /election/zkrsm/nominee0000000010 owned by session 0xa234f4f3bc220000\n\nWhat is happening is that 221 is reading the snapshot/logs when it becomes leader, it does not see session 0xa234f4f3bc220000 at all. It's neither in the snapshot nor in the logs. \n\nI used LogFormatter/SnapshotFormatter to dump the logs/snaps, the interesting thing is that 221 never sees session 0xa234f4f3bc220000 in it's (session create/close related) txn logs. As far as it knows the session was never created.\n\nI see this on 221:\n\n1) log.200000ae7 ends with zxid 0x30000012c\n\n2) log.300000144.txt (the next log it has after log.200000ae7) starts with 0x300000144\n\nOn 222 I can see\n\n3) session 0xa234f4f3bc220000 was created at zxid 0x300000134\n\n1/18/12 11:53:36 PM PST session 0xa234f4f3bc220000 cxid 0x0 zxid 0x300000134 createSession 6000\n\n\nSo 221 doesn't see the session created because it was not active in the quorum during this time.\n\nIt seems that some side-effect of the restart/reconfig process being used in this test is causing the quorum to get into an inconsistent state.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-25T18:48:12.816+0000","updated":"2012-01-25T18:48:12.816+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13193301","id":"13193301","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Jeremy - It will be good if you can reproduce this and provide full logs(log4j) and datadir for the servers. Unfortunately I can't see prior to epoch 3 on 221 (log4j logs trunc). afaict this same issue is happening just prior to 221 becoming the leader as I just described in the comment - it's getting a diff and it's likely that that diff was missing the session detail for some reason, I can't tell why though, or if it might be a bug or just side-effect of how the restart/reconfig is happening. I'd really like to nail it down though.\n\nBen/Flavio any insights?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-25T20:28:44.109+0000","updated":"2012-01-25T20:28:44.109+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13193507","id":"13193507","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"QA was able to reproduce it.  The good news is that NTP is working properly, so the logs should be a bit saner; also, I was able to salvage all the logs for the node that has the incorrectly-unexpired session.  The bad news I don't have any usable logs for one of the nodes, and for the other one I only have the most recent logs.  I hope this helps at least a little.\n\nThis time around, all three nodes are live when the problem happens.  There are three nodes: 90.0.0.1/208/node1, 90.0.0.2/30/node2, 90.0.0.3/119/node3.  node2 is the one in the bad state:\n\n{noformat}\n[zk: 90.0.0.2:2888(CONNECTED) 0] ls /election/zkrsm\n[nominee0000000034, nominee0000000035, nominee0000000032, nominee0000000036]\n[zk: 90.0.0.2:2888(CONNECTED) 1] get /election/zkrsm/nominee0000000032 \n90.0.0.1:7777 \ncZxid = 0xe00000017\nctime = Wed Jan 25 20:53:15 UTC 2012\nmZxid = 0xe00000017\nmtime = Wed Jan 25 20:53:15 UTC 2012\npZxid = 0xe00000017\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x1e3516a4bb770000\ndataLength = 14\nnumChildren = 0\n{noformat}\n\n/election/zkrsm/nominee0000000032 is owned by a session (0x1e3516a4bb770000) that should be expired.  Connecting to the other two nodes show only the latest three znodes.\n\nI have uploaded a tar file containing the datadirs of all three nodes, the logs for all runs of node2, and the logs of the latest run of node3, to:\nhttp://pdos.lcs.mit.edu/~strib/ZOOKEEPER-1367-2.tgz (80 MB zipped, 2.8 GB unzipped)\n\nHere's how the logs break down:\n\n* run0.tgz: You can ignore this one, it's from a preliminary run that was not part of the cluster\n* run1.tgz: This is where the cluster is built up using restarts.  In node2's case, it is first started with two nodes (node1 and node2).  Then that QuorumPeer is shutdown, and restarted with a configuration of all three nodes.\n* run[2-8].tgz: Each represents a cluster restart.  No cluster re-configurations are done during this time.  Our whole application process is brought down and then back up using the same ZK configuration.\n* run7.tgz: This is the run where the bad session was created and live:\n{noformat}\n2012-01-25 20:53:09,948 505755 [ProcessThread(sid:119 cport:-1):] TRACE org.apache.zookeeper.server.PrepRequestProcessor  - :Psessionid:0x1e3516a4bb770000 type:createSession cxid:0x0 zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a\n{noformat}\n* run8.tgz: The session created in the previous run of the system lives on, and is never expired as far as I can tell:\n{noformat}\n2012-01-25 20:53:27,950 2929 [pool-1-thread-2] TRACE org.apache.zookeeper.server.persistence.FileTxnSnapLog  - playLog --- create session in log: 1e3516a4bb770000 with timeout: 6000\n{noformat}\n\nI have the matching run8.log for node3, but it does not mention the bad session at all.  I have no usable logs for node1.\n\nI also managed to do a dump against each node while the system was live.  Here are the results:\n\n{noformat}\n# telnet 90.0.0.1 2888\nTrying 90.0.0.1...\nConnected to 90.0.0.1.\nEscape character is '^]'.\ndump\nSessionTracker dump:\nSession Sets (3):\n0 expire at Thu Jan 26 00:09:30 UTC 2012:\n1 expire at Thu Jan 26 00:09:33 UTC 2012:\n\t0x773516a5076a0000\n2 expire at Thu Jan 26 00:09:36 UTC 2012:\n\t0xd03516a4f7960000\n\t0x1e3516a4f8520001\nephemeral nodes dump:\nSessions with Ephemerals (3):\n0x773516a5076a0000:\n\t/election/zk_live_members/nominee0000000035\n\t/election/role-cluster-mgmt_cluster/nominee0000000035\n\t/election/cassandra/nominee0000000036\n\t/election/zkrsm/nominee0000000034\n0xd03516a4f7960000:\n\t/election/role-cluster-api_provider/nominee0000000033\n\t/election/connection-cluster/nominee0000000033\n\t/election/zkrsm/nominee0000000036\n\t/election/zk_live_members/nominee0000000036\n\t/election/role-cluster-dht_node/nominee0000000034\n\t/election/role-cluster-mgmt_cluster/nominee0000000036\n\t/election/role-cluster-switch_manager/nominee0000000033\n\t/election/DHT/nominee0000000033\n\t/election/dht-reconciliation/nominee0000000034\n\t/election/cassandra/nominee0000000034\n\t/election/role-cluster-persistence_server/nominee0000000034\n\t/election/role-cluster-logical_manager/nominee0000000033\n0x1e3516a4f8520001:\n\t/election/zkrsm/nominee0000000035\n\t/election/zk_live_members/nominee0000000034\n\t/election/role-cluster-mgmt_cluster/nominee0000000034\n\t/election/cassandra/nominee0000000035\n\n\n# telnet 90.0.0.2 2888\nTrying 90.0.0.2...\nConnected to 90.0.0.2.\nEscape character is '^]'.\ndump\nSessionTracker dump:\norg.apache.zookeeper.server.quorum.LearnerSessionTracker@1479a6b\nephemeral nodes dump:\nSessions with Ephemerals (4):\n0x1e3516a4bb770000:\n\t/election/cassandra/nominee0000000032\n\t/election/role-cluster-mgmt_cluster/nominee0000000032\n\t/election/role-cluster-persistence_server/nominee0000000032\n\t/election/role-cluster-dht_node/nominee0000000032\n\t/election/dht-reconciliation/nominee0000000032\n\t/election/zkrsm/nominee0000000032\n\t/election/zk_live_members/nominee0000000032\n0x773516a5076a0000:\n\t/election/zk_live_members/nominee0000000035\n\t/election/role-cluster-mgmt_cluster/nominee0000000035\n\t/election/cassandra/nominee0000000036\n\t/election/zkrsm/nominee0000000034\n0xd03516a4f7960000:\n\t/election/role-cluster-api_provider/nominee0000000033\n\t/election/connection-cluster/nominee0000000033\n\t/election/zkrsm/nominee0000000036\n\t/election/zk_live_members/nominee0000000036\n\t/election/role-cluster-dht_node/nominee0000000034\n\t/election/role-cluster-mgmt_cluster/nominee0000000036\n\t/election/role-cluster-switch_manager/nominee0000000033\n\t/election/DHT/nominee0000000033\n\t/election/dht-reconciliation/nominee0000000034\n\t/election/cassandra/nominee0000000034\n\t/election/role-cluster-persistence_server/nominee0000000034\n\t/election/role-cluster-logical_manager/nominee0000000033\n0x1e3516a4f8520001:\n\t/election/zkrsm/nominee0000000035\n\t/election/zk_live_members/nominee0000000034\n\t/election/role-cluster-mgmt_cluster/nominee0000000034\n\t/election/cassandra/nominee0000000035\n\n\n# telnet 90.0.0.3 2888\nTrying 90.0.0.3...\nConnected to 90.0.0.3.\nEscape character is '^]'.\ndump\nSessionTracker dump:\norg.apache.zookeeper.server.quorum.LearnerSessionTracker@5960a2f1\nephemeral nodes dump:\nSessions with Ephemerals (3):\n0x773516a5076a0000:\n\t/election/zk_live_members/nominee0000000035\n\t/election/role-cluster-mgmt_cluster/nominee0000000035\n\t/election/cassandra/nominee0000000036\n\t/election/zkrsm/nominee0000000034\n0xd03516a4f7960000:\n\t/election/role-cluster-api_provider/nominee0000000033\n\t/election/connection-cluster/nominee0000000033\n\t/election/zkrsm/nominee0000000036\n\t/election/zk_live_members/nominee0000000036\n\t/election/role-cluster-dht_node/nominee0000000034\n\t/election/role-cluster-mgmt_cluster/nominee0000000036\n\t/election/role-cluster-switch_manager/nominee0000000033\n\t/election/DHT/nominee0000000033\n\t/election/dht-reconciliation/nominee0000000034\n\t/election/cassandra/nominee0000000034\n\t/election/role-cluster-persistence_server/nominee0000000034\n\t/election/role-cluster-logical_manager/nominee0000000033\n0x1e3516a4f8520001:\n\t/election/zkrsm/nominee0000000035\n\t/election/zk_live_members/nominee0000000034\n\t/election/role-cluster-mgmt_cluster/nominee0000000034\n\t/election/cassandra/nominee0000000035\n{noformat}\n\nThe system is still in that state right now; if anyone needs more info from the live system, please ask me for it in the next hour or so.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-26T01:31:25.356+0000","updated":"2012-01-26T01:31:25.356+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13194319","id":"13194319","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"can you tell me the server id's of each of the different servers?\n\nalso in the data directories the accepted and current epochs are all 15b, but your zxid's all have epochs way less than that. are those left over files from another run?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-27T00:34:06.023+0000","updated":"2012-01-27T00:34:06.023+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13194325","id":"13194325","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"bq. can you tell me the server id's of each of the different servers?\n\nSorry if that wasn't clear.  The server ID is the second element for each node in this list from my previous comment:\n\n90.0.0.1/208/node1, 90.0.0.2/30/node2, 90.0.0.3/119/node3\n\nbq. also in the data directories the accepted and current epochs are all 15b, but your zxid's all have epochs way less than that. are those left over files from another run?\n\nNo, I just copied the entire version-2 directory from the live, running system.  Not sure why they'd be inconsistent with the data in the recent snapshots and logs.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-27T00:40:52.565+0000","updated":"2012-01-27T00:40:52.565+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13194884","id":"13194884","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I'm a bit confused, I don't understand the following in run7.log, node 2:\n\n{noformat}\n2012-01-25 20:53:06,895 502702 [QuorumPeer[myid=119]/90.0.0.2:2888] TRACE org.apache.zookeeper.server.persistence.FileTxnSnapLog  - playLog --- create session in log: 1e35169d27b00000 with timeout: 6000\n{noformat}\n\nand \n\n{noformat}\n2012-01-25 20:53:09,948 505755 [ProcessThread(sid:119 cport:-1):] TRACE org.apache.zookeeper.server.PrepRequestProcessor  - :Psessionid:0x1e3516a4bb770000 type:createSession cxid:0x0 zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a\n{noformat}\n\nIs it creating the same session twice? I'm not convinced that I'm not overlooking anything obvious.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-01-27T16:15:29.759+0000","updated":"2012-01-27T16:15:29.759+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13194898","id":"13194898","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"never mind. it wasn't 15b, it was 15, which does match the epoch of the highest zxid.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-27T16:34:25.682+0000","updated":"2012-01-27T16:34:25.682+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13194901","id":"13194901","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"one thing that is throwing me is the abundance of -110 (node exists) errors! on recovery they are normal, but they should never happen during normal operation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-27T16:36:48.679+0000","updated":"2012-01-27T16:36:48.679+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13194935","id":"13194935","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"run8.log for 90.0.0.1 would be super useful! also it seems that run7.log is chopped in the beginning for 90.0.0.1, why is that happening? the other thing i don't understand is the version-2 directory for 90.0.0.1 doesn't have any log or snapshot for epoch f. were you having file system problems on 90.0.0.1?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-27T17:32:19.003+0000","updated":"2012-01-27T17:32:19.003+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13194954","id":"13194954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I haven't parsed the session ids properly, so my previous observation was dull.\n\nOn run8.log from 90.0.0.2, we can see that it adds the session (1e3516a4bb770000) to the sessions list (see FileTxnSnapLog), and it got it from its own transaction log. But, the leader (90.0.0.1) supposedly knows of that session as well, otherwise it was not committed or leader election didn't select the right server. Checking the leader election notification messages, I can't see any problem. The part about the leader being aware of that session so that it can recreate it is the one we can't verify because we don't have run8.log for 90.0.0.1. \n\nAlso, the file run7.log for 90.0.0.1 is chopped, so we can't see what happened in that server when the session was created (2012-01-25 20:53:09,948 according to 90.0.0.2). By inspecting the transaction logs of 90.0.0.1, I couldn't find a session creation for 1e3516a4bb770000, but it does appear in the description of some transactions in log.e00000016. It sounds like it has been transferred via a snapshot? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-01-27T17:50:16.111+0000","updated":"2012-01-27T17:50:16.111+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195004","id":"13195004","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"Yes, sorry, 90.0.0.1 was filling up its disk at a fast rate, and we have scripts that clean out old logs and runs the Zookeeper purge script when we get within 90% of disk capacity.  This is why it is missing older snapshots and why I said we don't have any usable logs for it.\n\nThe run7.log that's there for 90.0.0.1 should actually be called run8.log, but it is just the most recent log file after all the older ones have been rotated away due to the disk getting close to capacity.\n\nI will keep working on reproducing it and get into the system before the disks start filling up so I can get a more complete set of data for you.  I have been unable to reproduce it on simple setups myself, so I'm still relying on our QA tests which comes with all this annoying baggage.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-27T18:49:37.221+0000","updated":"2012-01-27T18:49:37.221+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195007","id":"13195007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"FYI, I created ZOOKEEPER-1377 just so I could look at the snapshot files on this issue. You might find it useful.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-27T18:52:29.156+0000","updated":"2012-01-27T18:52:29.156+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195053","id":"13195053","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Jeremy - can the cleanup scripts be modified to gzip the old logs rather than rm'ing them? That might allow you to provide us with the full logs for reproducing the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-27T19:57:51.623+0000","updated":"2012-01-27T19:57:51.623+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195213","id":"13195213","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Debugging notes:\n\nThe session that server 2 sees that server 1 is missing is created at zxid 0xe00000001, right after\nit assumes leadership with server 3.\nServer 1 then joins later, and gets a diff of transactions from zxid e0...1 to 15. It does seem to record the other\ntransactions in this batch. However, it doesn't record a create session txn, because data tree processTxn doesn't do\nanything for createSession txns. So now, the session is live on server 2. Writes go through it to all servers.\nAt some point the cluster is restarted and server 1 becomes the leader. It doesn't know about the session that was created so it never expires it. What I'm not sure about is how it manages to get removed from server 3... perhaps via a trunc? Or perhaps it isn't removed, just not showing up as owned by an ephemeral. I don't have the time to repro\nto that level right now.\nAnyway, I think the problem is not recording the create session to the txn log.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-27T23:10:34.991+0000","updated":"2012-01-27T23:10:34.991+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195218","id":"13195218","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"{quote}\nOn run8.log from 90.0.0.2, we can see that it adds the session (1e3516a4bb770000) to the sessions list (see FileTxnSnapLog), and it got it from its own transaction log. But, the leader (90.0.0.1) supposedly knows of that session as well, otherwise it was not committed or leader election didn't select the right server. Checking the leader election notification messages, I can't see any problem. The part about the leader being aware of that session so that it can recreate it is the one we can't verify because we don't have run8.log for 90.0.0.1.\n{quote}\n\nServer 1 (90.0.0.1) is not the leader at the time that session is created, server 2 is the leader. Server 1 is not even in the quorum at that point, it's just after 2 has gained leadership with 3 as follower.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-27T23:14:07.838+0000","updated":"2012-01-27T23:14:07.838+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195252","id":"13195252","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"pat and i just finished up a debug session (using his super cool snapshot dump utility :)\n\nwe found it (actually i see camille is also there too :)\n\nthe problem is that the create session happens while server 1 is not connected, but server 1 is not far behind server 2, so when server 1 connects to server 2 it sends a diff. this diff gets processed in Learner.syncWithLeader(). in that method as it processes the commited transactions of the diff it applies them to the dataTree. but the dataTree does not update the session map! thus in final request processor we have:\n\n{code}\n    rc = zks.getZKDatabase().processTxn(request.getHdr(), request.getTxn());\n                if (request.type == OpCode.createSession) {\n                    if (request.getTxn() instanceof CreateSessionTxn) {\n                        CreateSessionTxn cst = (CreateSessionTxn) request.getTxn();\n                        zks.sessionTracker.addSession(request.sessionId, cst\n                                .getTimeOut());\n                    } else {\n                        LOG.warn(\"*****>>>>> Got \"\n                                + request.getTxn().getClass() + \" \"\n                                + request.getTxn().toString());\n                    }\n                } else if (request.type == OpCode.closeSession) {\n                    zks.sessionTracker.removeSession(request.sessionId);\n                }\n{code}\n\nbecause we don't have the special handling for session ops in that method, 1 doesn't track them, so when it becomes the leader the session is missing.\n\nthe fix is rather simple as is the test case. i'll have both up tonight.\n\nthanx everyone for the help in debugging. and jeremy thanx for providing such great logs and traces and recreating the problem!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T00:03:55.863+0000","updated":"2012-01-28T00:03:55.863+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195260","id":"13195260","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Ben, I'm looking at 3.3 branch and I see the same issue in Learner syncWithLeader... is this a bug in 3.3. as well or are we/I on the wrong track?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T00:12:13.900+0000","updated":"2012-01-28T00:12:13.900+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195273","id":"13195273","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Wow, kudos to Ben/Pat/Camille. Am glad you guys figured it out but I have the same question as Pat, as to why we dont see this in 3.3*. Running your test case on 3.3 branch would be helpful.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T00:22:30.496+0000","updated":"2012-01-28T00:22:30.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195279","id":"13195279","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"kudos Jeremy for reporting and sticking with us! Much appreciated!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T00:26:01.602+0000","updated":"2012-01-28T00:26:01.602+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195285","id":"13195285","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Agreed! :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T00:33:20.749+0000","updated":"2012-01-28T00:33:20.749+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195290","id":"13195290","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"Thanks guys!  I just now reproduced it with the gzipped log suggestion from Patrick.  Anyone interested in more thorough logs?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T00:39:27.675+0000","updated":"2012-01-28T00:39:27.675+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195297","id":"13195297","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Jeremy - Ben's working on a reproducible test case now, I'd suggest hold on to it (if you can) for now, but I think we have enough detail at this point.\n\nIt would be great if you could verify the patch once it's available.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T00:45:10.552+0000","updated":"2012-01-28T00:45:10.552+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195303","id":"13195303","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"Will do, on both counts.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T00:52:55.546+0000","updated":"2012-01-28T00:52:55.546+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195352","id":"13195352","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"ok this should fix the bug and also has a test that reliably reproduces the bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T02:12:56.225+0000","updated":"2012-01-28T02:12:56.225+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195359","id":"13195359","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"bq. ok this should fix the bug and also has a test that reliably reproduces the bug.\n\nAwesome, thanks much Ben!  In your copious spare time, do you think you could post one that applies cleanly on 3.4.1 or 3.4.2?  The patch fails to apply for me to ZooKeeperServer.java and FinalRequestProcessor.java on both releases.  I'd like to send it to QA for testing, but I'd rather not take the whole master branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T02:26:43.202+0000","updated":"2012-01-28T02:26:43.202+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195362","id":"13195362","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"yeah, i'm working on that now. there were a couple of small patches that went in that i have to hand merge.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T02:34:09.207+0000","updated":"2012-01-28T02:34:09.207+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195369","id":"13195369","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12512274/ZOOKEEPER-1367.patch\n  against trunk revision 1234974.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/928//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/928//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/928//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T02:41:57.388+0000","updated":"2012-01-28T02:41:57.388+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195373","id":"13195373","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"From https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/928//testReport/\n\n{code}\norg.apache.zookeeper.server.quorum.LearnerTest.syncTest\nFailing for the past 1 build (Since #928 )\nTook 74 ms.\nStacktrace\njava.lang.NullPointerException\n\tat org.apache.zookeeper.server.quorum.LearnerZooKeeperServer.createSessionTracker(LearnerZooKeeperServer.java:73)\n\tat org.apache.zookeeper.server.quorum.Learner.syncWithLeader(Learner.java:355)\n\tat org.apache.zookeeper.server.quorum.LearnerTest.syncTest(LearnerTest.java:114)\n\tat org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:52)\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T02:45:30.730+0000","updated":"2012-01-28T02:45:30.730+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195375","id":"13195375","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"@Ben/Jeremy,\n Ill kick off a 3.4.3 release with this patch and ZOOKEEPER-1373. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T02:46:48.590+0000","updated":"2012-01-28T02:46:48.590+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195381","id":"13195381","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"fixed the LearnerTest (it needed to simulate the zk server a bit more robustly)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T03:13:32.157+0000","updated":"2012-01-28T03:13:32.157+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195385","id":"13195385","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"here is the patch for the 3.4 branch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T03:36:03.296+0000","updated":"2012-01-28T03:36:03.296+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195388","id":"13195388","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12512281/ZOOKEEPER-1367-3.4.patch\n  against trunk revision 1234974.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 6 new or modified tests.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/930//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T03:45:13.706+0000","updated":"2012-01-28T03:45:13.706+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195391","id":"13195391","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"body":"Is a patch for 3.3 branch needed ?\n\nI don't see src/java/test/org/apache/zookeeper/server/quorum/LearnerTest.java under 3.3 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T03:48:34.356+0000","updated":"2012-01-28T03:48:34.356+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195392","id":"13195392","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12512280/ZOOKEEPER-1367.patch\n  against trunk revision 1234974.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 6 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/929//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/929//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/929//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T03:48:53.150+0000","updated":"2012-01-28T03:48:53.150+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195407","id":"13195407","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"body":"Patch for 3.3 branch.\n\nRunning tests.\n\nSince there is no LearnerTest in 3.3, I don't know how we can verify that the problem has been fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T04:27:44.605+0000","updated":"2012-01-28T04:27:44.605+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195412","id":"13195412","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12512285/1367-3.3.patch\n  against trunk revision 1234974.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/931//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T04:33:11.792+0000","updated":"2012-01-28T04:33:11.792+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195415","id":"13195415","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"body":"{code}\nBUILD FAILED\n/Users/zhihyu/3.3-zookeeper/build.xml:934: The following error occurred while executing this line:\n/Users/zhihyu/3.3-zookeeper/build.xml:845: Tests failed!\n{code}\nBut it is not clear which test failed:\n{code}\ngrep 'Failures:' build/test/logs/TEST-org.apache.zookeeper.* | grep -v 'Failures: 0'\n{code}\nThe above command returned nothing.\nThere was no hanging test either.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T04:46:02.454+0000","updated":"2012-01-28T04:46:02.454+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195431","id":"13195431","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"nice job backporting. i don't think qa will be able to test it properly since it will try to apply to trunk. if you ambitious about writing at test. we need to:\n\n# startup a set of three servers\n# do something like setData\n# kill one of the followers\n# startup a client to create a new session\n# startup the follower\n# kill the other follower\n# do a setData\n# kill the leader\n# restart the other follower (the follower from step 3 should be elected here)\n\nif the bug is present, the session will be gone","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T05:29:04.591+0000","updated":"2012-01-28T05:29:04.591+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195433","id":"13195433","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"if noone writes the test for 3.3, i'll write one tomorrow. (i have a 10 mile race in the morning :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T05:30:04.566+0000","updated":"2012-01-28T05:30:04.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195435","id":"13195435","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"body":"@Benjamin:\nBackporting was the easy part. I am new to zookeeper codebase, so writing the test would take longer.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T05:34:35.630+0000","updated":"2012-01-28T05:34:35.630+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195487","id":"13195487","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"body":"The difference between 3.3 and TRUNK API is obvious:\n{code}\n    [javac] /Users/zhihyu/3.3-zookeeper/src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java:263: cannot find symbol\n    [javac] symbol  : method getAcceptedEpoch()\n    [javac] location: class org.apache.zookeeper.server.quorum.QuorumPeer\n    [javac]                     Assert.assertEquals(1, f.self.getAcceptedEpoch());\n    [javac]                                                  ^\n    [javac] /Users/zhihyu/3.3-zookeeper/src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java:264: cannot find symbol\n    [javac] symbol  : method getCurrentEpoch()\n    [javac] location: class org.apache.zookeeper.server.quorum.QuorumPeer\n    [javac]                     Assert.assertEquals(1, f.self.getCurrentEpoch());\n    [javac]                                                  ^\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T11:14:52.375+0000","updated":"2012-01-28T11:14:52.375+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195574","id":"13195574","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"body":"When I upload patch for trunk onto https://reviews.apache.org, I can clearly see some new whitespace getting introduced.\nMaybe this is not an issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-28T16:39:32.102+0000","updated":"2012-01-28T16:39:32.102+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195634","id":"13195634","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"good catch. although the added lines with tabs replace lines that also have tabs (as do the surrounding lines). i'm a bit torn as to whether we should fix it in the patch since the surrounding lines will then look messed up.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-28T22:05:30.828+0000","updated":"2012-01-28T22:05:30.828+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195699","id":"13195699","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"We can clean up the whitespace separately. Goal here is to fix the issue in as clear a way as possible and get a fix out.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-29T06:33:36.605+0000","updated":"2012-01-29T06:33:36.605+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195700","id":"13195700","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Downloaded the various patches and will try to take a look tomorrow AM assuming internet access (spotty in current location).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-29T07:04:35.063+0000","updated":"2012-01-29T07:04:35.063+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195777","id":"13195777","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Ok I looked at the trunk patch only (sorry but the beach awaits). It looks good to me from a correctness point of view. +1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-29T16:09:02.750+0000","updated":"2012-01-29T16:09:02.750+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195823","id":"13195823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"The patch looks good to me, but there is one thing that I'm not entirely clear about, which is why 90.0.0.3 didn't log the session creation. At least, I couldn't find it in the logs and I believe Camille raised a similar concern above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-01-29T19:36:32.705+0000","updated":"2012-01-29T19:36:32.705+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195824","id":"13195824","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I got it, 90.0.0.3 did log it in log.d00000001. +1 for the trunk patch, tests pass for me, and I checked that the test fails before the patch and passes after applying the patch. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-01-29T19:48:45.442+0000","updated":"2012-01-29T19:48:45.442+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195826","id":"13195826","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"In addition to this patch we need to have an option to turn off sending of diffs. There are a couple of really strong reasons I can think of to do this:\n\n1) 3.3.x is broken in a similar way, there is an upgrade problem we can't solve short of having ppl first upgrade to a fixed 3.3 (3.3.5 say) and then upgrading to 3.4.x. If we could turn off diff sending this would address the problem.\n\n2) safety valve. Say we find another new problem with diff sending in 3.4/3/5. Having an option to turn it off would be useful for people as a workaround until a fix is found and released.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-29T19:55:05.195+0000","updated":"2012-01-29T19:55:05.195+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195834","id":"13195834","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"body":"Can we address turning off diff sending in another JIRA ?\n\nThis JIRA is an important one and warrants new releases of 3.3 and 3.4, in my opinion.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-29T20:32:37.624+0000","updated":"2012-01-29T20:32:37.624+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195854","id":"13195854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Another jira is fine. It would be a shortsighted mistake to release a new version that didn't have an option to turn off the diffs though - see my comment re upgrade.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-29T22:08:51.008+0000","updated":"2012-01-29T22:08:51.008+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195867","id":"13195867","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"body":"I logged ZOOKEEPER-1378","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-29T22:51:46.132+0000","updated":"2012-01-29T22:51:46.132+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13195942","id":"13195942","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Zhihong.\n\n@Ben - the question asked by Mahadev/myself earlier in this jira never got answered -- why are we seeing this in 3.4 but not in 3.3?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-30T05:37:59.324+0000","updated":"2012-01-30T05:37:59.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13196168","id":"13196168","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Are we not seeing it in 3.3? It seems to me glancing at the code that we should also be vulnerable to this there.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-30T15:22:21.124+0000","updated":"2012-01-30T15:22:21.124+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13196225","id":"13196225","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"@camille - Jeremy reported only seeing it once upgrading to 3.4, he hadn't seen it previously in 3.3.x. (That's not to say there isn't a problem, just why the discrepancy)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-30T16:56:44.560+0000","updated":"2012-01-30T16:56:44.560+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13196226","id":"13196226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"We had been running the same test on 3.3.3 for the past year and never saw this failure.  Of course, that doesn't mean it wasn't there, but I still think something changed in 3.4, possibly elsewhere in the code, to make it more common.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-30T16:57:17.388+0000","updated":"2012-01-30T16:57:17.388+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13196249","id":"13196249","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=henryr","name":"henryr","key":"henryr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henry Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"All three patches (trunk, 3.4 and 3.3) look good to me. +1, nice job. I'm comfortable not having the 3.3 test case, although of course it would be good. \n\nI don't fully understand the reason for this diff:\n\n{code}\n@@ -240,8 +242,7 @@\n         // Clean up dead sessions\n         LinkedList<Long> deadSessions = new LinkedList<Long>();\n         for (long session : zkDb.getSessions()) {\n-            sessionsWithTimeouts = zkDb.getSessionWithTimeOuts();\n-            if (sessionsWithTimeouts.get(session) == null) {\n+          if (zkDb.getSessionWithTimeOuts().get(session) == null) {\n                 deadSessions.add(session);\n             }\n         }\n{code}\n\nbut if it's just tidying up, that's fine (although it would seem better to lift the getSessionWithTimeOuts call to outside the loop). There's also some extra whitespace and an unused import or two, but those can get cleaned up later. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=henryr","name":"henryr","key":"henryr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henry Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-30T17:55:20.112+0000","updated":"2012-01-30T17:55:20.112+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13196391","id":"13196391","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"QA has verified that the patch to the 3.4 branch fixes the problem they were seeing.  Thanks everyone for all your hard work on this!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-30T20:25:44.669+0000","updated":"2012-01-30T20:25:44.669+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13196739","id":"13196739","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for confirming Jeremy. Ill check this in now. The patch looks good to me though I think we need to clean up our classes so that we have cleaner seperation on what ZKS should be exposing and what ZKDatabase should be exposing.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-31T06:37:11.801+0000","updated":"2012-01-31T06:37:11.801+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13196746","id":"13196746","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"I just committed this. Thanks Ben and others!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-31T06:56:13.844+0000","updated":"2012-01-31T06:56:13.844+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13196832","id":"13196832","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in ZooKeeper-trunk #1445 (See [https://builds.apache.org/job/ZooKeeper-trunk/1445/])\n    ZOOKEEPER-1367. Data inconsistencies and unexpired ephemeral nodes after cluster restart. (Benjamin Reed via mahadev)\n\nmahadev : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1238176\nFiles : \n* /zookeeper/trunk/CHANGES.txt\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/FinalRequestProcessor.java\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/LeaderZooKeeperServer.java\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/Learner.java\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/LearnerZooKeeperServer.java\n* /zookeeper/trunk/src/java/test/org/apache/zookeeper/server/quorum/LearnerTest.java\n* /zookeeper/trunk/src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-31T10:55:59.480+0000","updated":"2012-01-31T10:55:59.480+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13197034","id":"13197034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"i have the test case to reproduce and patch for 3.3. should i upload it to this jira?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-31T17:49:34.793+0000","updated":"2012-01-31T17:49:34.793+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13197056","id":"13197056","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Great. Go ahead and upload. Ill commit it to the 3.3 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-31T18:05:42.611+0000","updated":"2012-01-31T18:05:42.611+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13197069","id":"13197069","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"@henry i realized that didn't answer your question about the diff. the sessionsWithTimeouts data structure moved as part of the zkdb reuse work mahadev did a long time ago, but the sessionWithTimeouts stayed a field in the class even though it was only used locally in the function, so i cleaned that up a bit just to make sure that it really wasn't used anywhere else.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-31T18:15:47.282+0000","updated":"2012-01-31T18:15:47.282+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13197071","id":"13197071","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"here is the patch to fix 3.3 with a testcase that will reproduce the bug in 3.3.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-31T18:17:12.952+0000","updated":"2012-01-31T18:17:12.952+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13197124","id":"13197124","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"body":"Mahadev has applied fix for 3.3\n\nI think only SnapshotSessionTest.java is needed for 3.3 branch at the moment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhihyu%40ebaysf.com","name":"zhihyu@ebaysf.com","key":"zhihyu@ebaysf.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Yu","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-31T19:01:56.488+0000","updated":"2012-01-31T19:01:56.488+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13197332","id":"13197332","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"yes, that is correct. the SnapshotSessionTest reproduces the problem using a method that is much slower than what is used in the 3.4 and trunk patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-01-31T22:30:54.580+0000","updated":"2012-01-31T22:30:54.580+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13199487","id":"13199487","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Ok,\n I went ahead and reverted the patch I had committed to 3.3 and committed the latest patch from Ben since it was a little better. Thanks again Ben!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-03T02:41:50.811+0000","updated":"2012-02-03T02:41:50.811+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539194/comment/13752947","id":"13752947","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmahler","name":"bmahler","key":"bmahler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bmahler&avatarId=27343","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bmahler&avatarId=27343","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bmahler&avatarId=27343","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bmahler&avatarId=27343"},"displayName":"Benjamin Mahler","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm seeing a regression when upgrading from 3.3.4 to 3.3.6 and tracked it down to this patch.\n\nWe make the following sequence of calls:\n\nZooKeeperServer.startup() -> ZooKeeperServer.shutdown() -> ZooKeeperServer.startup()\n\nThis is done through NIOServerCnxn::Factory:\n\n{code}\nfactory = new NIOServerCnxn::Factory(...);\nfactory.startup(zkserver);\nfactory.shutdown()\n{code}\n\n{code}\nfactory = new NIOServerCnxn::Factory(...);\nfactory.startup(zkserver); // Crashes with the stack trace below.\nfactory.shutdown()\n{code}\n\nResults in the following (on 3.3.6, not on 3.3.4):\n{noformat}\njava.lang.IllegalThreadStateException\n\tat java.lang.Thread.start(Thread.java:656)\n\tat org.apache.zookeeper.server.ZooKeeperServer.startSessionTracker(ZooKeeperServer.java:402)\n\tat org.apache.zookeeper.server.ZooKeeperServer.startup(ZooKeeperServer.java:376)\n\tat org.apache.zookeeper.server.NIOServerCnxn$Factory.startup(NIOServerCnxn.java:161)\nException in thread \"AWT-AppKit\" Caught a JVM exception, not propagating\n{noformat}\n\nAre we mis-using the API or is this a bug?\n\nLooking at the code, it's clear that calling ZooKeeperServer.startup twice in 3.3.6 will attempt to start the sessionTracker thread twice, which seems incorrect.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmahler","name":"bmahler","key":"bmahler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bmahler&avatarId=27343","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bmahler&avatarId=27343","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bmahler&avatarId=27343","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bmahler&avatarId=27343"},"displayName":"Benjamin Mahler","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-28T22:20:04.065+0000","updated":"2013-08-28T22:20:04.065+0000"}],"maxResults":95,"total":95,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1367/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05xwv:"}}