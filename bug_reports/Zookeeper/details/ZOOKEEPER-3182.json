{
  "expand": "renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations",
  "id": "13194141",
  "self": "https://issues.apache.org/jira/rest/api/2/issue/13194141",
  "key": "ZOOKEEPER-3182",
  "fields": {
    "issuetype": {
      "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
      "id": "1",
      "description": "A problem which impairs or prevents the functions of the product.",
      "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
      "name": "Bug",
      "subtask": false,
      "avatarId": 21133
    },
    "timespent": null,
    "project": {
      "self": "https://issues.apache.org/jira/rest/api/2/project/12310801",
      "id": "12310801",
      "key": "ZOOKEEPER",
      "name": "ZooKeeper",
      "avatarUrls": {
        "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011",
        "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011",
        "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011",
        "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"
      },
      "projectCategory": {
        "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10484",
        "id": "10484",
        "description": "Apache ZooKeeper related",
        "name": "ZooKeeper"
      }
    },
    "fixVersions": [],
    "aggregatetimespent": null,
    "resolution": null,
    "customfield_12312322": null,
    "customfield_12310220": "2018-10-25T19:59:13.583+0000",
    "customfield_12312520": null,
    "customfield_12312323": null,
    "customfield_12312521": "Thu Nov 22 00:36:14 UTC 2018",
    "customfield_12310420": "9223372036854775807",
    "customfield_12312320": null,
    "customfield_12310222": null,
    "customfield_12312321": null,
    "resolutiondate": null,
    "workratio": -1,
    "customfield_12312328": null,
    "customfield_12312329": null,
    "customfield_12312923": null,
    "customfield_12312326": null,
    "customfield_12312920": null,
    "customfield_12310300": null,
    "customfield_12312327": null,
    "customfield_12312921": null,
    "customfield_12312324": null,
    "customfield_12312720": null,
    "customfield_12312325": null,
    "lastViewed": null,
    "watches": {
      "self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3182/watchers",
      "watchCount": 5,
      "isWatching": false
    },
    "created": "2018-10-25T13:41:10.515+0000",
    "customfield_12310192": null,
    "customfield_12310191": null,
    "priority": {
      "self": "https://issues.apache.org/jira/rest/api/2/priority/2",
      "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/critical.svg",
      "name": "Critical",
      "id": "2"
    },
    "labels": [],
    "customfield_12312333": null,
    "customfield_12310230": null,
    "customfield_12312334": null,
    "customfield_12313422": "false",
    "customfield_12310310": "0.0",
    "customfield_12312331": null,
    "customfield_12312332": null,
    "timeestimate": null,
    "aggregatetimeoriginalestimate": null,
    "customfield_12311120": null,
    "customfield_12312330": null,
    "versions": [
      {
        "self": "https://issues.apache.org/jira/rest/api/2/version/12326518",
        "id": "12326518",
        "name": "3.6.0",
        "archived": false,
        "released": false
      }
    ],
    "issuelinks": [
      {
        "id": "12546621",
        "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12546621",
        "type": {
          "id": "12310560",
          "name": "Problem/Incident",
          "inward": "is caused by",
          "outward": "causes",
          "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/12310560"
        },
        "outwardIssue": {
          "id": "13079588",
          "key": "ZOOKEEPER-2807",
          "self": "https://issues.apache.org/jira/rest/api/2/issue/13079588",
          "fields": {
            "summary": "Flaky test: org.apache.zookeeper.test.WatchEventWhenAutoResetTest.testNodeDataChanged",
            "status": {
              "self": "https://issues.apache.org/jira/rest/api/2/status/5",
              "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
              "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
              "name": "Resolved",
              "id": "5",
              "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
              }
            },
            "priority": {
              "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
              "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
              "name": "Major",
              "id": "3"
            },
            "issuetype": {
              "self": "https://issues.apache.org/jira/rest/api/2/issuetype/7",
              "id": "7",
              "description": "The sub-task of the issue",
              "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype",
              "name": "Sub-task",
              "subtask": true,
              "avatarId": 21146
            }
          }
        }
      },
      {
        "id": "12546620",
        "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12546620",
        "type": {
          "id": "12310050",
          "name": "Regression",
          "inward": "is broken by",
          "outward": "breaks",
          "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"
        },
        "inwardIssue": {
          "id": "12737480",
          "key": "ZOOKEEPER-2024",
          "self": "https://issues.apache.org/jira/rest/api/2/issue/12737480",
          "fields": {
            "summary": "Major throughput improvement with mixed workloads",
            "status": {
              "self": "https://issues.apache.org/jira/rest/api/2/status/5",
              "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
              "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
              "name": "Resolved",
              "id": "5",
              "statusCategory": {
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3",
                "id": 3,
                "key": "done",
                "colorName": "green",
                "name": "Done"
              }
            },
            "priority": {
              "self": "https://issues.apache.org/jira/rest/api/2/priority/3",
              "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
              "name": "Major",
              "id": "3"
            },
            "issuetype": {
              "self": "https://issues.apache.org/jira/rest/api/2/issuetype/4",
              "id": "4",
              "description": "An improvement or enhancement to an existing feature or task.",
              "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype",
              "name": "Improvement",
              "subtask": false,
              "avatarId": 21140
            }
          }
        }
      }
    ],
    "customfield_12312339": null,
    "assignee": null,
    "customfield_12312337": null,
    "customfield_12312338": null,
    "updated": "2018-11-22T00:36:14.399+0000",
    "customfield_12312335": null,
    "customfield_12312336": null,
    "status": {
      "self": "https://issues.apache.org/jira/rest/api/2/status/1",
      "description": "The issue is open and ready for the assignee to start work on it.",
      "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png",
      "name": "Open",
      "id": "1",
      "statusCategory": {
        "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2",
        "id": 2,
        "key": "new",
        "colorName": "blue-gray",
        "name": "To Do"
      }
    },
    "components": [
      {
        "self": "https://issues.apache.org/jira/rest/api/2/component/12312382",
        "id": "12312382",
        "name": "server",
        "description": "General issues with the ZooKeeper server."
      }
    ],
    "timeoriginalestimate": null,
    "description": "This issue is probably introduced by ZOOKEEPER-2024 where 2 seperate queues have been implemented in CommitProcessor to improve performance. [~abrahamfine] 's analysis is accurate on GitHub: https://github.com/apache/zookeeper/pull/300\r\n\r\nHe was trying to introduce synchronization between Learner.syncWithLeader() and CommitProcessor to wait for in-flight requests to be committed before accepting client requests.\r\n\r\nIn the affected unit test ({{testNodeDataChanged}}) there's a race between reconnecting client's setWatches request and updates coming from the leader according to the following logs:\r\n\r\n{noformat}\r\n2018-10-25 13:59:58,556 [myid:] - DEBUG [FollowerRequestProcessor:1:CommitProcessor@424] - Processing request:: sessionid:0x10005d8fc4d0000 type:setWatches cxid:0x3 zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a\r\n2018-10-25 13:59:58,556 [myid:] - DEBUG [CommitProcWorkThread-1:FinalRequestProcessor@91] - Processing request:: sessionid:0x10005d8fc4d0000 type:setWatches cxid:0x3 zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a\r\n...\r\n2018-10-25 13:59:58,557 [myid:] - DEBUG [CommitProcWorkThread-1:FinalRequestProcessor@91] - Processing request:: sessionid:0x20005d8f8a40000 type:delete cxid:0x1 zxid:0x100000004 txntype:2 reqpath:n/a\r\n...\r\n2018-10-25 13:59:58,561 [myid:] - DEBUG [CommitProcWorkThread-1:FinalRequestProcessor@91] - Processing request:: sessionid:0x20005d8f8a40000 type:create cxid:0x2 zxid:0x100000005 txntype:1 reqpath:n/a\r\n2018-10-25 13:59:58,561 [myid:127.0.0.1:11231] - DEBUG [main-SendThread(127.0.0.1:11231):ClientCnxn$SendThread@864] - Got WatchedEvent state:SyncConnected type:NodeDeleted path:/test-changed for sessionid 0x10005d8fc4d0000\r\n{noformat}\r\n\r\n{{setWatches}} request is processed before {{delete}} and {{create}}, hence the client receives NodeDeleted event.\r\n\r\nIn the working scenario it looks like:\r\n\r\n{noformat}\r\n2018-10-25 14:04:55,247 [myid:] - DEBUG [CommitProcWorkThread-1:FinalRequestProcessor@91] - Processing request:: sessionid:0x20005dd88110000 type:delete cxid:\r\n0x1 zxid:0x100000004 txntype:2 reqpath:n/a\r\n2018-10-25 14:04:55,249 [myid:] - DEBUG [CommitProcWorkThread-1:FinalRequestProcessor@91] - Processing request:: sessionid:0x20005dd88110000 type:create cxid:\r\n0x2 zxid:0x100000005 txntype:1 reqpath:n/a\r\n...\r\n2018-10-25 14:04:56,314 [myid:] - DEBUG [FollowerRequestProcessor:1:CommitProcessor@424] - Processing request:: sessionid:0x10005dd88110000 type:setWatches cxid:0x3 zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a\r\n2018-10-25 14:04:56,315 [myid:] - DEBUG [CommitProcWorkThread-1:FinalRequestProcessor@91] - Processing request:: sessionid:0x10005dd88110000 type:setWatches cxid:0x3 zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a\r\n...\r\n2018-10-25 14:04:56,316 [myid:127.0.0.1:11231] - DEBUG [main-SendThread(127.0.0.1:11231):ClientCnxn$SendThread@842] - Got notification sessionid:0x10005dd88110000\r\n2018-10-25 14:04:56,316 [myid:127.0.0.1:11231] - DEBUG [main-SendThread(127.0.0.1:11231):ClientCnxn$SendThread@864] - Got WatchedEvent state:SyncConnected type:NodeDataChanged path:/test-changed for sessionid 0x10005dd88110000\r\n{noformat}\r\n\r\n{{delete}} and {{create}} requests happen way before {{setWatches}} comes in (even before the client connection is established) and client receives NodeDataChanged event only.\r\n\r\nAbe's approach unfortunately raises the following concerns:\r\n- modifies CommitProcessor's code which might affect performance and correctness ([~shralex] raised on ZOOKEEPER-2807),\r\n- we experienced deadlocks while testing the patch: https://github.com/apache/zookeeper/pull/300\r\n\r\nAs a consequence I raised this Jira to capture the experiences and to put the unit test on Ignore list, because currently I'm not sure about whether this is a real issue or a non-backward compatible change in 3.6 with the gain of a huge performance improvement.\r\n\r\nEither way I don't want this flaky test to influence contributions, so I'll mark as Ignored on trunk until the issue is resolved.",
    "customfield_10010": null,
    "timetracking": {},
    "customfield_12312026": null,
    "customfield_12312023": null,
    "customfield_12312024": null,
    "customfield_12312340": null,
    "attachment": [],
    "aggregatetimeestimate": null,
    "customfield_12312341": null,
    "customfield_12312220": null,
    "customfield_12312022": null,
    "customfield_12310921": null,
    "customfield_12310920": "9223372036854775807",
    "customfield_12312823": null,
    "summary": "Race condition when follower syncing with leader and starting to serve requests",
    "creator": {
      "self": "https://issues.apache.org/jira/rest/api/2/user?username=andorm",
      "name": "andorm",
      "key": "andorm",
      "avatarUrls": {
        "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935",
        "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935",
        "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935",
        "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"
      },
      "displayName": "Andor Molnar",
      "active": true,
      "timeZone": "Europe/Budapest"
    },
    "subtasks": [],
    "customfield_12310291": null,
    "reporter": {
      "self": "https://issues.apache.org/jira/rest/api/2/user?username=andorm",
      "name": "andorm",
      "key": "andorm",
      "avatarUrls": {
        "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935",
        "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935",
        "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935",
        "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"
      },
      "displayName": "Andor Molnar",
      "active": true,
      "timeZone": "Europe/Budapest"
    },
    "customfield_12310290": null,
    "aggregateprogress": {
      "progress": 0,
      "total": 0
    },
    "customfield_12311024": null,
    "environment": null,
    "customfield_12313520": null,
    "customfield_12311020": null,
    "duedate": null,
    "customfield_12310250": null,
    "progress": {
      "progress": 0,
      "total": 0
    },
    "comment": {
      "comments": [
        {
          "self": "https://issues.apache.org/jira/rest/api/2/issue/13194141/comment/16664232",
          "id": "16664232",
          "author": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=lvfangmin",
            "name": "lvfangmin",
            "key": "lvfangmin",
            "avatarUrls": {
              "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=lvfangmin&avatarId=24660",
              "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lvfangmin&avatarId=24660",
              "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lvfangmin&avatarId=24660",
              "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lvfangmin&avatarId=24660"
            },
            "displayName": "Fangmin Lv",
            "active": true,
            "timeZone": "Etc/UTC"
          },
          "body": "[~andorm] I'm trying to go through this problem to see if this is a real correctness issue or by designed behavior.\r\n\r\nSo first, let's see if we're on the same page about the designed behavior. The setWatches request is treated as a read request in Zeus, ZK only guarantees read after write for the same session on the same server, if it reconnects to a different server, that server might be slow, either slow syncing with leader or slow due to GC, it may not get the commits from leader on time, so it doesn't guarantee you'll see it unless issuing sync request. So this is not a follower/leader syncing time problem, this exists during broadcasting time as well.\r\n\r\nTo me, this seems to be a test problem, not the code, and we should check if we can issue sync before setWatches to fix the flaky test here.",
          "updateAuthor": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=lvfangmin",
            "name": "lvfangmin",
            "key": "lvfangmin",
            "avatarUrls": {
              "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=lvfangmin&avatarId=24660",
              "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lvfangmin&avatarId=24660",
              "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lvfangmin&avatarId=24660",
              "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lvfangmin&avatarId=24660"
            },
            "displayName": "Fangmin Lv",
            "active": true,
            "timeZone": "Etc/UTC"
          },
          "created": "2018-10-25T19:59:13.583+0000",
          "updated": "2018-10-25T20:04:44.335+0000"
        },
        {
          "self": "https://issues.apache.org/jira/rest/api/2/issue/13194141/comment/16664247",
          "id": "16664247",
          "author": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=andorm",
            "name": "andorm",
            "key": "andorm",
            "avatarUrls": {
              "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935",
              "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935",
              "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935",
              "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"
            },
            "displayName": "Andor Molnar",
            "active": true,
            "timeZone": "Europe/Budapest"
          },
          "body": "Got it. That was pretty much my other thinking: I wasn't sure about that the problem didn't exist before and whether the unit test actually makes sense.\r\nI'm not sure if we can issue sync, because reconnection / setWatches logic is automatic and built into the client. Maybe we should just remove this test or remove the shutdown / restart part, because it's not clear to me what exactly are we trying to test here by restarting the follower.",
          "updateAuthor": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=andorm",
            "name": "andorm",
            "key": "andorm",
            "avatarUrls": {
              "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935",
              "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935",
              "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935",
              "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"
            },
            "displayName": "Andor Molnar",
            "active": true,
            "timeZone": "Europe/Budapest"
          },
          "created": "2018-10-25T20:25:42.613+0000",
          "updated": "2018-10-25T20:25:42.613+0000"
        },
        {
          "self": "https://issues.apache.org/jira/rest/api/2/issue/13194141/comment/16666745",
          "id": "16666745",
          "author": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=lvfangmin",
            "name": "lvfangmin",
            "key": "lvfangmin",
            "avatarUrls": {
              "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=lvfangmin&avatarId=24660",
              "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lvfangmin&avatarId=24660",
              "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lvfangmin&avatarId=24660",
              "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lvfangmin&avatarId=24660"
            },
            "displayName": "Fangmin Lv",
            "active": true,
            "timeZone": "Etc/UTC"
          },
          "body": "[~andorm] the change in the updated PR looks good to me, I've approved it.",
          "updateAuthor": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=lvfangmin",
            "name": "lvfangmin",
            "key": "lvfangmin",
            "avatarUrls": {
              "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=lvfangmin&avatarId=24660",
              "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lvfangmin&avatarId=24660",
              "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lvfangmin&avatarId=24660",
              "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lvfangmin&avatarId=24660"
            },
            "displayName": "Fangmin Lv",
            "active": true,
            "timeZone": "Etc/UTC"
          },
          "created": "2018-10-29T04:21:34.904+0000",
          "updated": "2018-10-29T04:21:34.904+0000"
        },
        {
          "self": "https://issues.apache.org/jira/rest/api/2/issue/13194141/comment/16695423",
          "id": "16695423",
          "author": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=mkedwards",
            "name": "mkedwards",
            "key": "mkedwards",
            "avatarUrls": {
              "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mkedwards&avatarId=37306",
              "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mkedwards&avatarId=37306",
              "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mkedwards&avatarId=37306",
              "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mkedwards&avatarId=37306"
            },
            "displayName": "Michael K. Edwards",
            "active": true,
            "timeZone": "America/Los_Angeles"
          },
          "body": "Is this fix needed for 3.5.5?",
          "updateAuthor": {
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=mkedwards",
            "name": "mkedwards",
            "key": "mkedwards",
            "avatarUrls": {
              "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=mkedwards&avatarId=37306",
              "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mkedwards&avatarId=37306",
              "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mkedwards&avatarId=37306",
              "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mkedwards&avatarId=37306"
            },
            "displayName": "Michael K. Edwards",
            "active": true,
            "timeZone": "America/Los_Angeles"
          },
          "created": "2018-11-22T00:36:14.399+0000",
          "updated": "2018-11-22T00:36:14.399+0000"
        }
      ],
      "maxResults": 4,
      "total": 4,
      "startAt": 0
    },
    "votes": {
      "self": "https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3182/votes",
      "votes": 0,
      "hasVoted": false
    },
    "worklog": {
      "startAt": 0,
      "maxResults": 20,
      "total": 0,
      "worklogs": []
    },
    "customfield_12311820": "0|i3zmtr:"
  }
}