{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13184496","self":"https://issues.apache.org/jira/rest/api/2/issue/13184496","key":"ZOOKEEPER-3145","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":13200,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false}],"aggregatetimespent":13200,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-09-12T19:09:44.100+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Nov 22 00:51:48 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3145/watchers","watchCount":2,"isWatching":false},"created":"2018-09-11T23:47:07.954+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":["pull-request-available"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340141","id":"12340141","description":"Beta release against 3.5 branch","name":"3.5.4","archived":false,"released":true,"releaseDate":"2018-05-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342973","id":"12342973","description":"Fix release against 3.4 branch","name":"3.4.13","archived":false,"released":true,"releaseDate":"2018-07-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lvfangmin","name":"lvfangmin","key":"lvfangmin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lvfangmin&avatarId=24660","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lvfangmin&avatarId=24660","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lvfangmin&avatarId=24660","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lvfangmin&avatarId=24660"},"displayName":"Fangmin Lv","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-11-22T00:51:48.812+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"This is another issue I found recently, we haven't seen this problem on prod (or maybe we don't notice).\r\n\r\n \r\nCurrently, the CloseSession is not idempotent, executing the CloseSession twice won't get the same result.\r\n \r\nThe problem is that closeSession will only check what's the ephemeral nodes associated with that session bases on current states. Nodes deleted during taking fuzzy snapshot won't be deleted again when replay the txn.\r\n \r\nThis looks fine, since it's already gone, but there is problem with the pzxid of the parent node. Snapshot is taken fuzzily, so it's possible that the parent had been serialized while the nodes are being deleted when executing the closeSession Txn. The pzxid will not be updated in the snapshot when replaying the closeSession txn, because doesn't know what's the paths being deleted, so it won't patch the pzxid like what we did in the deleteNode ZOOKEEPER-3125.\r\n \r\nThe inconsistent pzxid will lead to potential watch notification missing when client reconnect with setWatches because of the staleness. \r\n \r\nThis JIRA is going to fix those issues by adding the CloseSessionTxn, it will record all those nodes being deleted in that CloseSession txn, so that we know which nodes to update when replaying the txn.","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"3h 40m","remainingEstimateSeconds":0,"timeSpentSeconds":13200},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Potential watch missing issue due to stale pzxid when replaying CloseSession txn with fuzzy snapshot","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lvfangmin","name":"lvfangmin","key":"lvfangmin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lvfangmin&avatarId=24660","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lvfangmin&avatarId=24660","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lvfangmin&avatarId=24660","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lvfangmin&avatarId=24660"},"displayName":"Fangmin Lv","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lvfangmin","name":"lvfangmin","key":"lvfangmin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lvfangmin&avatarId=24660","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lvfangmin&avatarId=24660","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lvfangmin&avatarId=24660","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lvfangmin&avatarId=24660"},"displayName":"Fangmin Lv","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":13200,"total":13200,"percent":100},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":13200,"total":13200,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/comment/16612617","id":"16612617","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 13 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2157//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2157//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2157//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2018-09-12T19:09:44.100+0000","updated":"2018-09-12T19:09:44.100+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/comment/16615117","id":"16615117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 13 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2173//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2173//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2173//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2018-09-14T17:28:16.025+0000","updated":"2018-09-14T17:28:16.025+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/comment/16615479","id":"16615479","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 13 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2180//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2180//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/2180//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2018-09-14T22:48:39.669+0000","updated":"2018-09-14T22:48:39.669+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/comment/16695436","id":"16695436","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkedwards","name":"mkedwards","key":"mkedwards","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mkedwards&avatarId=37306","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mkedwards&avatarId=37306","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mkedwards&avatarId=37306","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mkedwards&avatarId=37306"},"displayName":"Michael K. Edwards","active":true,"timeZone":"America/Los_Angeles"},"body":"Fix needed for 3.5.5?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkedwards","name":"mkedwards","key":"mkedwards","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mkedwards&avatarId=37306","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mkedwards&avatarId=37306","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mkedwards&avatarId=37306","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mkedwards&avatarId=37306"},"displayName":"Michael K. Edwards","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-11-22T00:51:48.812+0000","updated":"2018-11-22T00:51:48.812+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3145/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":26,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/143703","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user lvfangmin opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/622\n\n    [ZOOKEEPER-3145] Potential watch missing issue due to stale pzxid when replaying CloseSession txn with fuzzy snapshot\n\n    Currently, the CloseSession txn is not idempotent, executing the CloseSession twice won't get the same result, which could cause pzxid inconsistent, which in turn cause watches missing.\r\n    \r\n    For more details, please check the description in ZOOKEEPER-3145.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/lvfangmin/zookeeper ZOOKEEPER-3145\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/622.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #622\n    \n----\ncommit 9576e25ae1ecc09b8d17a144b9aa82604f03fdd0\nAuthor: Fangmin Lyu <allenlyu@...>\nDate:   2018-09-12T18:30:05Z\n\n    Add CloseSessionTxn to track the nodes being deleted when close session\n\n----\n","created":"2018-09-12T18:51:28.517+0000","updated":"2018-09-12T18:51:28.517+0000","started":"2018-09-12T18:51:28.516+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"143703","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144011","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user lvfangmin commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/622\n  \n    Can I have some to help review this one as well, this is a new issue found recently, it would be great to have the community review here as well before we land it internally.\n","created":"2018-09-13T17:08:04.562+0000","updated":"2018-09-13T17:08:04.562+0000","started":"2018-09-13T17:08:04.562+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144011","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144065","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user anmolnar commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/622\n  \n    @lvfangmin Give me a chance. :)\r\n    I'll review this tomorrow. ;)\n","created":"2018-09-13T20:16:38.242+0000","updated":"2018-09-13T20:16:38.242+0000","started":"2018-09-13T20:16:38.242+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144065","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144094","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user eolivelli commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217545459\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/DataTree.java ---\n    @@ -1057,22 +1065,49 @@ void killSession(long session, long zxid) {\n             // so there is no need for synchronization. The list is not\n             // changed here. Only create and delete change the list which\n             // are again called from FinalRequestProcessor in sequence.\n    -        Set<String> list = ephemerals.remove(session);\n    -        if (list != null) {\n    -            for (String path : list) {\n    -                try {\n    -                    deleteNode(path, zxid);\n    -                    if (LOG.isDebugEnabled()) {\n    -                        LOG\n    -                                .debug(\"Deleting ephemeral node \" + path\n    -                                        + \" for session 0x\"\n    -                                        + Long.toHexString(session));\n    -                    }\n    -                } catch (NoNodeException e) {\n    -                    LOG.warn(\"Ignoring NoNodeException for path \" + path\n    -                            + \" while removing ephemeral for dead session 0x\"\n    +        killSession(session, zxid, ephemerals.remove(session), null);\n    +    }\n    +\n    +    void killSession(long session, long zxid, Set<String> paths2DeleteLocal,\n    +            List<String> paths2DeleteInTxn) {\n    +        if (paths2DeleteInTxn != null) {\n    +            deleteNodes(session, zxid, paths2DeleteInTxn);\n    +        }\n    +\n    +        if (paths2DeleteLocal == null) {\n    +            return;\n    +        }\n    +\n    +        if (paths2DeleteInTxn != null) {\n    --- End diff --\n    \n    In case that paths2DeleteLocal is null we won't execute this block. Is it expected?\r\n    \r\n\n","created":"2018-09-13T22:00:54.535+0000","updated":"2018-09-13T22:00:54.535+0000","started":"2018-09-13T22:00:54.534+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144094","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144095","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user eolivelli commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217546112\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/util/SerializeUtils.java ---\n    @@ -116,6 +120,10 @@ public static Record deserializeTxn(byte txnBytes[], TxnHeader hdr)\n                         create.setAcl(createv0.getAcl());\n                         create.setEphemeral(createv0.getEphemeral());\n                         create.setParentCVersion(-1);\n    +                } else if (hdr.getType() == OpCode.closeSession) {\n    +                    // perhaps this is before CloseSessionTxn was added,\n    --- End diff --\n    \n    Do we have a test case for this case?\n","created":"2018-09-13T22:00:54.551+0000","updated":"2018-09-13T22:00:54.551+0000","started":"2018-09-13T22:00:54.550+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144095","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user eolivelli commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217546649\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/FuzzySnapshotRelatedTest.java ---\n    @@ -60,14 +60,17 @@\n     \n         MainThread[] mt = null;\n         ZooKeeper[] zk = null;\n    +    int[] clientPorts = null;\n         int leaderId;\n         int followerA;\n     \n         @Before\n         public void setup() throws Exception {\n    +        ZooKeeperServer.setCloseSessionTxnEnabled(true);\n    --- End diff --\n    \n    This test class will always be executed with this new option. It is an existing class, are we losing some coverage ?\n","created":"2018-09-13T22:00:54.863+0000","updated":"2018-09-13T22:00:54.863+0000","started":"2018-09-13T22:00:54.863+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144096","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144104","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user lvfangmin commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217554958\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/DataTree.java ---\n    @@ -1057,22 +1065,49 @@ void killSession(long session, long zxid) {\n             // so there is no need for synchronization. The list is not\n             // changed here. Only create and delete change the list which\n             // are again called from FinalRequestProcessor in sequence.\n    -        Set<String> list = ephemerals.remove(session);\n    -        if (list != null) {\n    -            for (String path : list) {\n    -                try {\n    -                    deleteNode(path, zxid);\n    -                    if (LOG.isDebugEnabled()) {\n    -                        LOG\n    -                                .debug(\"Deleting ephemeral node \" + path\n    -                                        + \" for session 0x\"\n    -                                        + Long.toHexString(session));\n    -                    }\n    -                } catch (NoNodeException e) {\n    -                    LOG.warn(\"Ignoring NoNodeException for path \" + path\n    -                            + \" while removing ephemeral for dead session 0x\"\n    +        killSession(session, zxid, ephemerals.remove(session), null);\n    +    }\n    +\n    +    void killSession(long session, long zxid, Set<String> paths2DeleteLocal,\n    +            List<String> paths2DeleteInTxn) {\n    +        if (paths2DeleteInTxn != null) {\n    +            deleteNodes(session, zxid, paths2DeleteInTxn);\n    +        }\n    +\n    +        if (paths2DeleteLocal == null) {\n    +            return;\n    +        }\n    +\n    +        if (paths2DeleteInTxn != null) {\n    --- End diff --\n    \n    Yes, this is expected behavior when we disabled the CloseSessionTxn, I added that option for safety and quicker rollback.\n","created":"2018-09-13T22:36:24.553+0000","updated":"2018-09-13T22:36:24.553+0000","started":"2018-09-13T22:36:24.553+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144104","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user lvfangmin commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217555258\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/util/SerializeUtils.java ---\n    @@ -116,6 +120,10 @@ public static Record deserializeTxn(byte txnBytes[], TxnHeader hdr)\n                         create.setAcl(createv0.getAcl());\n                         create.setEphemeral(createv0.getEphemeral());\n                         create.setParentCVersion(-1);\n    +                } else if (hdr.getType() == OpCode.closeSession) {\n    +                    // perhaps this is before CloseSessionTxn was added,\n    --- End diff --\n    \n    Yes, we do, check the QuorumPeerMainTest.testCloseSessionTxnCompatile, when leader disabled  the CloseSessionTxn, but follower enabled it, we'll hit this.\n","created":"2018-09-13T22:40:10.888+0000","updated":"2018-09-13T22:40:10.888+0000","started":"2018-09-13T22:40:10.888+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144105","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144106","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user lvfangmin commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217555585\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/FuzzySnapshotRelatedTest.java ---\n    @@ -60,14 +60,17 @@\n     \n         MainThread[] mt = null;\n         ZooKeeper[] zk = null;\n    +    int[] clientPorts = null;\n         int leaderId;\n         int followerA;\n     \n         @Before\n         public void setup() throws Exception {\n    +        ZooKeeperServer.setCloseSessionTxnEnabled(true);\n    --- End diff --\n    \n    Set this to false will reproduce inconsistent pzxid bug, which is what we're going to solve here by enabling CloseSessionTxn, so we're not missing anything, just to make sure the CloseSessionTxn solved the bug here.\n","created":"2018-09-13T22:40:10.999+0000","updated":"2018-09-13T22:40:10.999+0000","started":"2018-09-13T22:40:10.998+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144106","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144254","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user eolivelli commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217689225\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/DataTree.java ---\n    @@ -1057,22 +1065,49 @@ void killSession(long session, long zxid) {\n             // so there is no need for synchronization. The list is not\n             // changed here. Only create and delete change the list which\n             // are again called from FinalRequestProcessor in sequence.\n    -        Set<String> list = ephemerals.remove(session);\n    -        if (list != null) {\n    -            for (String path : list) {\n    -                try {\n    -                    deleteNode(path, zxid);\n    -                    if (LOG.isDebugEnabled()) {\n    -                        LOG\n    -                                .debug(\"Deleting ephemeral node \" + path\n    -                                        + \" for session 0x\"\n    -                                        + Long.toHexString(session));\n    -                    }\n    -                } catch (NoNodeException e) {\n    -                    LOG.warn(\"Ignoring NoNodeException for path \" + path\n    -                            + \" while removing ephemeral for dead session 0x\"\n    +        killSession(session, zxid, ephemerals.remove(session), null);\n    +    }\n    +\n    +    void killSession(long session, long zxid, Set<String> paths2DeleteLocal,\n    +            List<String> paths2DeleteInTxn) {\n    +        if (paths2DeleteInTxn != null) {\n    +            deleteNodes(session, zxid, paths2DeleteInTxn);\n    +        }\n    +\n    +        if (paths2DeleteLocal == null) {\n    +            return;\n    +        }\n    +\n    +        if (paths2DeleteInTxn != null) {\n    --- End diff --\n    \n    Ok\n","created":"2018-09-14T12:02:37.775+0000","updated":"2018-09-14T12:02:37.775+0000","started":"2018-09-14T12:02:37.773+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144254","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144255","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user eolivelli commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217689355\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/util/SerializeUtils.java ---\n    @@ -116,6 +120,10 @@ public static Record deserializeTxn(byte txnBytes[], TxnHeader hdr)\n                         create.setAcl(createv0.getAcl());\n                         create.setEphemeral(createv0.getEphemeral());\n                         create.setParentCVersion(-1);\n    +                } else if (hdr.getType() == OpCode.closeSession) {\n    +                    // perhaps this is before CloseSessionTxn was added,\n    --- End diff --\n    \n    That was my guess, but I just wanted a confirmation. Thanks\n","created":"2018-09-14T12:03:17.003+0000","updated":"2018-09-14T12:03:17.003+0000","started":"2018-09-14T12:03:17.002+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144255","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144257","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user eolivelli commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217689682\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/FuzzySnapshotRelatedTest.java ---\n    @@ -60,14 +60,17 @@\n     \n         MainThread[] mt = null;\n         ZooKeeper[] zk = null;\n    +    int[] clientPorts = null;\n         int leaderId;\n         int followerA;\n     \n         @Before\n         public void setup() throws Exception {\n    +        ZooKeeperServer.setCloseSessionTxnEnabled(true);\n    --- End diff --\n    \n    This property won't impact other testcases in the class. Okay\n","created":"2018-09-14T12:04:53.422+0000","updated":"2018-09-14T12:04:53.422+0000","started":"2018-09-14T12:04:53.421+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144257","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144313","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user anmolnar commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217743312\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/FuzzySnapshotRelatedTest.java ---\n    @@ -60,14 +60,17 @@\n     \n         MainThread[] mt = null;\n         ZooKeeper[] zk = null;\n    +    int[] clientPorts = null;\n         int leaderId;\n         int followerA;\n     \n         @Before\n         public void setup() throws Exception {\n    +        ZooKeeperServer.setCloseSessionTxnEnabled(true);\n    --- End diff --\n    \n    It would be slightly cleaner to set it back to false in @After method.\r\n    Out of interest, I find it a little bit strange to implement a feature switch to a bugfix, but on the other side I understand the concerns.\n","created":"2018-09-14T15:04:34.959+0000","updated":"2018-09-14T15:04:34.959+0000","started":"2018-09-14T15:04:34.959+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144313","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144314","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user anmolnar commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217739881\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/DataTree.java ---\n    @@ -1057,22 +1065,49 @@ void killSession(long session, long zxid) {\n             // so there is no need for synchronization. The list is not\n             // changed here. Only create and delete change the list which\n             // are again called from FinalRequestProcessor in sequence.\n    -        Set<String> list = ephemerals.remove(session);\n    -        if (list != null) {\n    -            for (String path : list) {\n    -                try {\n    -                    deleteNode(path, zxid);\n    -                    if (LOG.isDebugEnabled()) {\n    -                        LOG\n    -                                .debug(\"Deleting ephemeral node \" + path\n    -                                        + \" for session 0x\"\n    -                                        + Long.toHexString(session));\n    -                    }\n    -                } catch (NoNodeException e) {\n    -                    LOG.warn(\"Ignoring NoNodeException for path \" + path\n    -                            + \" while removing ephemeral for dead session 0x\"\n    +        killSession(session, zxid, ephemerals.remove(session), null);\n    +    }\n    +\n    +    void killSession(long session, long zxid, Set<String> paths2DeleteLocal,\n    +            List<String> paths2DeleteInTxn) {\n    +        if (paths2DeleteInTxn != null) {\n    +            deleteNodes(session, zxid, paths2DeleteInTxn);\n    +        }\n    +\n    +        if (paths2DeleteLocal == null) {\n    +            return;\n    +        }\n    +\n    +        if (paths2DeleteInTxn != null) {\n    +            // explicitly check and remove to avoid potential performance\n    +            // issue when using removeAll\n    +            for (String path: paths2DeleteInTxn) {\n    +                paths2DeleteLocal.remove(path);\n    +            }\n    +            if (!paths2DeleteLocal.isEmpty()) {\n    --- End diff --\n    \n    In which case could this happen?\n","created":"2018-09-14T15:04:34.967+0000","updated":"2018-09-14T15:04:34.967+0000","started":"2018-09-14T15:04:34.967+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144314","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144315","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user anmolnar commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217741801\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -1861,6 +1862,76 @@ public void testFaultyMetricsProviderOnConfigure() throws Exception {\n             Assert.assertTrue(\"complains about metrics provider MetricsProviderLifeCycleException\", found);\n         }\n     \n    +    /**\n    +     * Test leader/leader compatibility with/without CloseSessionTxn, so that\n    +     * we can gradually rollout this code and rollback if there is problem.\n    +     */\n    +    @Test\n    +    public void testCloseSessionTxnCompatile() throws Exception {\n    --- End diff --\n    \n    Using parameterized tests instead?\r\n    \r\n    https://github.com/junit-team/junit4/wiki/parameterized-tests\n","created":"2018-09-14T15:04:34.972+0000","updated":"2018-09-14T15:04:34.972+0000","started":"2018-09-14T15:04:34.972+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144315","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user anmolnar commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/622\n  \n    Why be afraid enabling it right on?\r\n    Jira is scoped for 3.6, but I think it should go into 3.5 too like the others.\n","created":"2018-09-14T15:05:37.484+0000","updated":"2018-09-14T15:05:37.484+0000","started":"2018-09-14T15:05:37.484+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144317","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144324","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user eolivelli commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/622\n  \n    Okay to enable by default on 3.6\n","created":"2018-09-14T15:41:05.327+0000","updated":"2018-09-14T15:41:05.327+0000","started":"2018-09-14T15:41:05.326+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144324","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user lvfangmin commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217769719\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/DataTree.java ---\n    @@ -1057,22 +1065,49 @@ void killSession(long session, long zxid) {\n             // so there is no need for synchronization. The list is not\n             // changed here. Only create and delete change the list which\n             // are again called from FinalRequestProcessor in sequence.\n    -        Set<String> list = ephemerals.remove(session);\n    -        if (list != null) {\n    -            for (String path : list) {\n    -                try {\n    -                    deleteNode(path, zxid);\n    -                    if (LOG.isDebugEnabled()) {\n    -                        LOG\n    -                                .debug(\"Deleting ephemeral node \" + path\n    -                                        + \" for session 0x\"\n    -                                        + Long.toHexString(session));\n    -                    }\n    -                } catch (NoNodeException e) {\n    -                    LOG.warn(\"Ignoring NoNodeException for path \" + path\n    -                            + \" while removing ephemeral for dead session 0x\"\n    +        killSession(session, zxid, ephemerals.remove(session), null);\n    +    }\n    +\n    +    void killSession(long session, long zxid, Set<String> paths2DeleteLocal,\n    +            List<String> paths2DeleteInTxn) {\n    +        if (paths2DeleteInTxn != null) {\n    +            deleteNodes(session, zxid, paths2DeleteInTxn);\n    +        }\n    +\n    +        if (paths2DeleteLocal == null) {\n    +            return;\n    +        }\n    +\n    +        if (paths2DeleteInTxn != null) {\n    +            // explicitly check and remove to avoid potential performance\n    +            // issue when using removeAll\n    +            for (String path: paths2DeleteInTxn) {\n    +                paths2DeleteLocal.remove(path);\n    +            }\n    +            if (!paths2DeleteLocal.isEmpty()) {\n    --- End diff --\n    \n    If there is no bug, I expect we won't hit this line, but I'd like to add the logs here to make sure this is true for now, we may remove it in the future.\n","created":"2018-09-14T16:30:29.067+0000","updated":"2018-09-14T16:30:29.067+0000","started":"2018-09-14T16:30:29.066+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144334","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144335","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user lvfangmin commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/622#discussion_r217770370\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -1861,6 +1862,76 @@ public void testFaultyMetricsProviderOnConfigure() throws Exception {\n             Assert.assertTrue(\"complains about metrics provider MetricsProviderLifeCycleException\", found);\n         }\n     \n    +    /**\n    +     * Test leader/leader compatibility with/without CloseSessionTxn, so that\n    +     * we can gradually rollout this code and rollback if there is problem.\n    +     */\n    +    @Test\n    +    public void testCloseSessionTxnCompatile() throws Exception {\n    --- End diff --\n    \n    It's not a good practice to add parameter in the test class if only a single test is using it, have a test helper function like this seems better to me.\n","created":"2018-09-14T16:30:29.067+0000","updated":"2018-09-14T16:30:29.067+0000","started":"2018-09-14T16:30:29.066+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144335","issueId":"13184496"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13184496/worklog/144337","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user lvfangmin commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/622\n  \n    @anmolnar @eolivelli thanks for review. About the switch, I think we can enable it by default, I'll make that change. But I think it's better to keep the switch, it's easier to turn off if something goes wrong when deploy it, also it makes the backward compatible test easier.\r\n    \r\n    I'll have a clean up PR to remove this switch (in the same Jira) when everything is verified and run stably for a while internally, does that sounds good to you?\n","created":"2018-09-14T16:35:53.371+0000","updated":"2018-09-14T16:35:53.371+0000","started":"2018-09-14T16:35:53.371+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"144337","issueId":"13184496"}]},"customfield_12311820":"0|i3xzm7:"}}