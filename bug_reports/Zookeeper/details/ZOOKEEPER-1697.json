{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12645566","self":"https://issues.apache.org/jira/rest/api/2/issue/12645566","key":"ZOOKEEPER-1697","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-05-01T01:02:28.047+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Mar 13 18:17:11 UTC 2014","customfield_12310420":"325927","customfield_12312320":null,"customfield_12310222":"10002_*:*_3_*:*_269359787_*|*_1_*:*_3_*:*_641287857_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-05-11T13:35:32.718+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1697/watchers","watchCount":11,"isWatching":false},"created":"2013-05-01T00:38:05.102+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12319288","id":"12319288","description":"Fix release against 3.4 branch","name":"3.4.3","archived":false,"released":true,"releaseDate":"2012-02-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"issuelinks":[{"id":"12368505","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12368505","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12534519","key":"ZOOKEEPER-1324","self":"https://issues.apache.org/jira/rest/api/2/issue/12534519","fields":{"summary":"Remove Duplicate NEWLEADER packets from the Leader to the Follower.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-13T18:17:11.473+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"I keep seeing this on the leader:\n\n2013-04-30 01:18:39,754 INFO\norg.apache.zookeeper.server.quorum.Leader: Shutdown called\njava.lang.Exception: shutdown Leader! reason: Only 0 followers, need 2\nat org.apache.zookeeper.server.quorum.Leader.shutdown(Leader.java:447)\nat org.apache.zookeeper.server.quorum.Leader.lead(Leader.java:422)\nat org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:753)\n\nThe followers are downloading the snapshot when this happens, and are\ntrying to do their first ACK to the leader, the ack fails with broken\npipe.\n\nIn this case the snapshots are large and the config has increased the\ninitLimit. syncLimit is small - 10 or so with ticktime of 2000. Note\nthis is 3.4.3 with ZOOKEEPER-1521 applied.\n\nI originally speculated that\nhttps://issues.apache.org/jira/browse/ZOOKEEPER-1521 might be related.\nI thought I might have broken something for this environment. That\ndoesn't look to be the case.\n\nAs it looks now it seems that 1521 didn't go far enough. The leader\nverifies that all followers have ACK'd to the leader within the last\n\"syncLimit\" time period. This runs all the time in the background on\nthe leader to identify the case where a follower drops. In this case\nthe followers take so long to load the snapshot that this check fails\nthe very first time, as a result the leader drops (not enough ack'd\nfollowers w/in the sync limit) and re-election happens. This repeats\nforever. (the above error)\n\nthis is the call:\norg.apache.zookeeper.server.quorum.LearnerHandler.synced() that's at\nodds.\n\nlook at setting of tickOfLastAck in\norg.apache.zookeeper.server.quorum.LearnerHandler.run()\nIt's not set until the follower first acks - in this case I can see\nthat the followers are not getting to the ack prior to the leader\nshutting down due to the error log above.\n\nIt seems that sync() should probably use the init limit until the\nfirst ack comes in from the follower. I also see that while tickOfLastAck and leader.self.tick is shared btw two threads there is no synchronization of the shared resources.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12582683","id":"12582683","filename":"ZOOKEEPER-1697_branch34.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-10T20:58:18.996+0000","size":3741,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12582683/ZOOKEEPER-1697_branch34.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12582497","id":"12582497","filename":"ZOOKEEPER-1697_branch34.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-09T19:27:37.580+0000","size":3671,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12582497/ZOOKEEPER-1697_branch34.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12582222","id":"12582222","filename":"ZOOKEEPER-1697_branch34.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-08T00:44:31.074+0000","size":1603,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12582222/ZOOKEEPER-1697_branch34.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12582684","id":"12582684","filename":"ZOOKEEPER-1697.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-10T20:58:28.876+0000","size":3786,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12582684/ZOOKEEPER-1697.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12582498","id":"12582498","filename":"ZOOKEEPER-1697.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-09T19:27:47.543+0000","size":3741,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12582498/ZOOKEEPER-1697.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12582223","id":"12582223","filename":"ZOOKEEPER-1697.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-08T00:44:42.493+0000","size":1670,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12582223/ZOOKEEPER-1697.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"326272","customfield_12312823":null,"summary":"large snapshots can cause continuous quorum failure","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13646256","id":"13646256","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"When I ran into a similar problem, I found that the main culprit is ZOOKEEPER-1324. \n\nThe side-effect of that bug is that it caused the initial set of followers that join the quorum before the quorum is formed to get duplicate NEWLEADER packets. Those followers will take one more additional snapshot after sending NEWLEADER's ACK back to the leader and before serving request. \n\nThis caused the leader to tear down the quorum if syncLimit is low and snapshot taking time is high.\n\nYou can look at the follower logs to see that they are taking 2 snapshots to confirm if this is the case.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-01T01:02:28.047+0000","updated":"2013-05-01T01:02:28.047+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13646365","id":"13646365","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~thawan] I really appreciate the feedback. I do indeed see two snapshotting messages in the follower log.\n\nSay ZOOKEEPER-1324 is fixed, it seems to me that this Jira would still need to be addressed, no? In the case with a very large snapshot file (say twice as large) we could still run into the same issue I describe here. \"tear down the quorum if syncLimit is low and snapshot taking time is high\". Do you agree or am I missing something?\n\nThanks again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-01T04:21:16.649+0000","updated":"2013-05-01T04:21:16.649+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13646723","id":"13646723","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I'm also not entirely convinced that solving ZOOKEEPER-1324 will solve this current issue. Talking about ZOOKEEPER-1324, I'd really like to have it in soon.\n\nI had a look at trunk, and I don't understand how LearnerHandler#synced() can be the culprit here. Calls to synced() appear in two places in Leader: \n\n# In the second while loop of lead(), after enough followers have synchronized;\n# In isQuorumSynced(), which is used with the RECONFIG command. It seems unrelated to the issue described here.\n\nI looked at trunk because this issue is also marked for 3.5.0.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-01T17:16:05.567+0000","updated":"2013-05-01T17:17:27.999+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13646820","id":"13646820","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~fpj] thanks for looking. \n\nbq. I looked at trunk because this issue is also marked for 3.5.0.\n\nSorry for the confusion. I listed the \"Affects Version\" as 3.4.3, because that's where I saw it. Marked as fix for both 3.4 and 3.5 because I wanted to make sure we considered it for both. I haven't looked to see if it effects 3.5 though. To be clear I've been looking at 3.4 codebase. In particular 3.4.3 release codebase which is where the issue was seen.\n\nbq. I had a look at trunk, and I don't understand how LearnerHandler#synced() can be the culprit here. Calls to synced() appear in two places in Leader:\n\nIs this still a question for you if you look at the 3.4.3 codebase?\n\nWhat I see in the logs is that the leader has shut down with the log I mentioned:\n\n{noformat}\norg.apache.zookeeper.server.quorum.Leader: Shutdown called\njava.lang.Exception: shutdown Leader! reason: Only 0 followers, need 2\n{noformat}\n\nAll four of the followers were in the middle of snapshotting during this time. Once they complete that task they then attempt to \n\n{noformat}\n        writePacket(ack, true);\n{noformat}\n\nI've verified from all four follower logs that this fails for all four in this location - acking to the leader and getting \"broken pipe\" due to the leader having already shutdown.\n\nBased on my reading of the code:\n\n1) it seems that the followers are busy snapshotting and have not yet ack'd.\n\n2) Because LearnerHandler hasn't seen the ack it has not yet updated tickOfLastAck for the first time (so 0). We're in bootstrapping so we should allow for initLimit (which is configured large relative to syncLimit)\n\n3) Leader lead() method is checking the tickOfLastAck against the syncLimit via the synced() call, which has expired and therefore calls shutdown. I'm suggesting that if initLimit were used instead during this call to synced (but only during the bootstrapping phase, you still want to use syncLimit otw) that the followers would eventually have been able to snapshot, send the ack, and the leader would be happy (tickOfLastAck updated appropriately). In other words we need to extend the time period of the check in synced during the bootstrapping of a learner.\n\nThis make sense to you all? If not what am I missing. Thanks!\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-01T18:56:54.136+0000","updated":"2013-05-01T18:56:54.136+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13646852","id":"13646852","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"I do see this on the leader just prior to the shutdown:\n\nbq. INFO org.apache.zookeeper.server.quorum.Leader: Have quorum of supporters; starting up and setting last processed zxid: ...\n\nSo perhaps the first newleader ack (based on Thawan's speculation we are getting 2 dup newleader pkts) does get sent by the learner to the learnerhandler, which allows the leader to make progress. However learnerhandler will wait at the top of the while loop (bottom of run method) for another packet to come before it first updates tickOfLastAck. That packet is the one that's causing the \"broken pipe\" error message on the follower. i.e. tickOfLastAck is therefore never updated.\n\nAnother issue to consider is that the leader.self.tick and tickOfLastAck are both unsynchronized in these code sections...\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-01T19:30:50.101+0000","updated":"2013-05-01T19:30:50.101+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13647436","id":"13647436","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"It is legitimate that we use syncLimit at the part of the Leader code because when we start that while loop, the leader has already received enough acks for the newleader proposal. After looking more into it, I think that the culprit is ZOOKEEPER-1324 as Thawan suggested. The followers are taking to long to send an ack back because they are taking an additional snapshot.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-02T10:56:00.330+0000","updated":"2013-05-02T10:56:00.330+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13647703","id":"13647703","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"ZOOKEEPER-1324 is probably one of the issues, but i think after that gets fixed we can run into the issue that pat identified. we don't set tickOfLastAck until after we receive the first message from the follower after the leader becomes active. after the leader becomes active it will sleep for tickTime/2 and then check to see if the followers are synced, which uses tickOfLastAck. that gives followers a very small window in which to send the first message. perhaps when the leader starts. a simple fix would be to set the tickOfLastAck of all its followers to the current tickTime.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-02T17:02:21.800+0000","updated":"2013-05-02T17:02:21.800+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13647851","id":"13647851","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"bq. a simple fix would be to set the tickOfLastAck of all its followers to the current tickTime.\n\nAnd to avoid a race, I think we need to reset tickOfLastAck before calling zk.startup().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-02T20:05:29.565+0000","updated":"2013-05-02T20:05:29.565+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13651503","id":"13651503","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"I've attached a patch for trunk & 3.4 that I think will fix the problem. \n\nAll tests pass on branch34, however I'm running into ZOOKEEPER-1700 on trunk and can't get the tests to run cleanly (only FLETest.testJoin is failing on trunk, but that fails with or without this patch applied)\n\nPlease take a look and let me know if this patch makes sense to you for both 3.4 and trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-08T00:47:05.269+0000","updated":"2013-05-08T00:47:05.269+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13651532","id":"13651532","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12582223/ZOOKEEPER-1697.patch\n  against trunk revision 1463329.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1470//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1470//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1470//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-08T01:25:03.668+0000","updated":"2013-05-08T01:25:03.668+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13652413","id":"13652413","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"ZOOKEEPER-1700 turned out to be a bug in the FLETest. This patch now passes for me on both branch34 and trunk. There are no updates to existing tests as this is closing a very small timing hole. The existing tests verify this codepath and are passing. [~breed] or [~fpj] et. al. can you take a look at the two patches? Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-08T22:17:01.977+0000","updated":"2013-05-08T22:17:01.977+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13652842","id":"13652842","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Pat, It doesn't quite work, I think. Setting the tickOfLastAck where you're setting could still cause the same problem because this loop:\n\n{code}\n            /*\n             * Wait until leader starts up\n             */\n            synchronized(leader.zk){\n                while(!leader.zk.isRunning() && !this.isInterrupted()){\n                    leader.zk.wait(20);\n                }\n            }\n{code}\n\ncould still spin for a while, no?. It might work better to set tickOfLastAck for the learners that have ack'ed at that point in Leader#tryToCommit() right before zk.startup().\n\nOne smaller comment, perhaps not for this jira, is that I'd rather use QuorumPeer#getTick() rather than accessing tick directly. We are doing it this way in a number of places so it might be better to use it consistently. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-09T09:45:47.885+0000","updated":"2013-05-09T09:45:47.885+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653089","id":"13653089","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"[~fpj] that's a good point, a window still exists. (see if this comment/solution solves the problem - I'd rather hold off on \"why not tryToCommit\" in case we solve this in another way)\n\nPerhaps the original approach is flawed, I tried thinking about this from a different angle and I think I came up with a patch that addresses all concerns. Take a look at the latest patch for trunk/branch34 (attached)\n\nIn this case I turn things around - we define a deadline for next ack rather than tracking the last time we heard from the learner. This allows us to take into account the bootstrapping phase, and the fact that the learner is not out of bootstrapping until it reaches the point where the leader receives the response to UPTODATE message. What do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-09T19:39:02.411+0000","updated":"2013-05-09T19:39:02.411+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653114","id":"13653114","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=henryr","name":"henryr","key":"henryr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henry Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"[~phunt] - this seems _much_ clearer and easier to reason about.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=henryr","name":"henryr","key":"henryr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henry Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-09T19:58:30.076+0000","updated":"2013-05-09T19:58:30.076+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653142","id":"13653142","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12582498/ZOOKEEPER-1697.patch\n  against trunk revision 1463329.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1474//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1474//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1474//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-09T20:25:12.135+0000","updated":"2013-05-09T20:25:12.135+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653229","id":"13653229","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Pat, The new approach you propose looks good to me. One advantage is that it concentrates the changes on LearnerHandler and it is easier to read the code this way. \n\nI like the approach of resetting tickOfLastAck for the second ack and on because the first ack is a bit odd, so resetting is a way of separating the timing of the first ack from the rest.\n\nIn your patch, I was actually thinking that this statement:\n\n{code}\ntickOfNextAckDeadline = leader.self.tick + leader.self.initLimit;\n{code} \n\nmight not be right because of the following argument. An instance of LearnerHandler may take up to initLimit to get to the point that the leader is running. From the point that the LearnerHandler instance crosses the start up while loop, we should grant another syncLimit ticks until next ack because the first might have arrived right before it crosses the while loop, no? If so, then perhaps the initialization of tickOfNextAckDeadline should be instead:\n\n{code}\ntickOfNextAckDeadline = leader.self.syncLimit + leader.self.initLimit;\n{code} \n\nLet me know what you think.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-09T21:20:43.063+0000","updated":"2013-05-09T21:20:43.063+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653263","id":"13653263","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~fpj]\n\nbq. One advantage is that it concentrates the changes on LearnerHandler and it is easier to read the code this way.\n\nAgree. The encapsulation and code flow is much better.\n\nbq. An instance of LearnerHandler may take up to initLimit to get to the point that the leader is running.\n\nI was thinking that the initLimit is the amount of time you allow the servers to bootstrap and start serving, for me this included the initialization as well as the initial \"sync\" period. I could see going either way, but if we did make the change it seems like it would be odd - we do sock.setSoTimeout(initlimit) in some places (during bootstrapping), based on your comment we should change those as well? Why not have the operator just consider that (initi + sync) in setting the initLimit?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-09T21:43:55.635+0000","updated":"2013-05-09T21:43:55.635+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653298","id":"13653298","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"bq. I was thinking that the initLimit is the amount of time you allow the servers to bootstrap and start serving, for me this included the initialization as well as the initial \"sync\" period.\n\nAgreed, if the leader is not able to get a quorum of supporters within initLimit, it drops leadership. \n\nbq. we do sock.setSoTimeout(initlimit) in some places (during bootstrapping), based on your comment we should change those as well?\n\nNo, I think the setting of socket timeouts is correct, I don't see a problem with it, do you?\n\nbq. Why not have the operator just consider that (initi + sync) in setting the initLimit?\n\nMy point is not exactly that. Note that in my comment I'm talking about the first time we set tickOfNextAckDeadline in your patch. In the patch, it sounds like you're giving only one tick to the next ack in the case bootstrapping and syncing takes initLimit. This is the time until the LearnerHandler instance crosses the startup while loop. I'm saying that it should be syncLimit instead.  \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-09T22:07:41.338+0000","updated":"2013-05-09T22:07:41.338+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653323","id":"13653323","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"[~fpj] I believe I understand what you are saying, my point was just \"what's the definition of initLimit\". You've defined it as \"leader is not able to get a quorum of supporters within initLimit, it drops leadership.\"\n\nLooking at our docs they say: http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_clusterOptions\n\n\"initLimit: Amount of time, in ticks (see tickTime), to allow followers to connect and sync to a leader. Increased this value as needed, if the amount of data managed by ZooKeeper is large.\"\n\nafaict our official docs match what's currently in the patch.\n\nWould we not get the same thing as you are suggesting by running with a config of \n\ninitLimit=15\nsyncLimit=5\n\nvs changing the patch as you suggest and running with \n\ninitLimit=10\nsyncLimit=5\n\nOur docs seems to be saying you should run with the first config (and the current patch). Perhaps I'm missing something though....\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-09T22:27:02.250+0000","updated":"2013-05-09T22:27:02.250+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653338","id":"13653338","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I'm not sure if you're saying that my statement conflicts with the definition of initLimit in the docs. If followers are not able to sync with the leader, isn't it the case that the prospective leader will not have a quorum and will drop leadership? In any case, I was reading the code, not the docs. \n\nI don't think the two ways of configuring you're suggesting are equivalent because we use initLimit in a number of other places (Leader#lead() while waiting for a quorum of supporters, for example) and I'm not saying that we should replace that initLimit with initLimit + syncLimit for cases other than ack bookkeeping. Actually, I'm saying that we need syncLimit on top of initLimit for the first ack in LearnerHandler independent of how you choose the value for initLimit. This observation comes from the fact that between start up and the second ack we should allow syncLimit ticks. Say that the leader takes initLimit to form a quorum of supporters. Once the LeanerHandler starts processing messages, it has only a tick to update tickOfNextAckDeadline before the learner is considered out of sync with the patch you're proposing, right?  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-09T22:47:31.456+0000","updated":"2013-05-09T22:47:31.456+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653345","id":"13653345","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. only one tick to the next ack\n\nperhaps this is the point i'm missing that you're trying to make. Question: what do we consider \"sync'd\" wrt bootstrapping? After the first ack, or after the UPTODATE response comes back to the leader. I was assuming the second (uptodate). Is that not correct?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-09T22:54:38.530+0000","updated":"2013-05-09T22:54:38.530+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653351","id":"13653351","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Sorry, I was formulating my previous comment during your response and they crossed. I suspect that we are converging? (I'll wait and let you comment on my previous comment ;-) )","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-09T22:57:57.805+0000","updated":"2013-05-09T22:57:57.805+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13653624","id":"13653624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Ah, great question. In my view, the UPTODATE message is the commit of the synchronization phase of recovery, so no ack is actually needed, but we have it for backward compatibility. In the way we are doing it currently, you're right that the first ack received in the LearnerHandler#run() while(true) loop is a response to the UPTODATE so it could be considered part of the synchronization phase. \n\nHowever, if we follow this interpretation, there is a discrepancy in what is implemented, I think. The leader must gather a quorum of supporters within initLimit ticks. Once it gets it, the leader starts running and believes that everyone is synced up. But, the UPTODATE message really goes out only after the leader has already started running:\n\n{code}\n            /*\n             * Wait until leader starts up\n             */\n            synchronized(leader.zk){\n                while(!leader.zk.isRunning() && !this.isInterrupted()){\n                    leader.zk.wait(20);\n                }\n            }\n            // Mutation packets will be queued during the serialize,\n            // so we need to mark when the peer can actually start\n            // using the data\n            //\n            LOG.debug(\"Sending UPTODATE message to \" + sid);      \n            queuedPackets.add(new QuorumPacket(Leader.UPTODATE, -1, null, null));\n{code}  \n\nFrom the leader perspective, it is already established when leader.zk.isRunning() is true and in my understanding we should be giving syncLimit ticks for acks once that predicate is true. Now, in practice a tick should be long enough to enable the leader to get a response for the UPTODATE message. I think what we are really discussing here is definitions, which is great. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-10T07:51:16.634+0000","updated":"2013-05-10T07:51:16.634+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13654564","id":"13654564","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. I think what we are really discussing here is definitions, which is great.\n\nYes, absolutely. I don't mean to be a pain here, I'm just not fully groking something. Thanks for bearing with me [~fpj].\n\nSo based on my reading of your most recent comment you still feel we should allow \"initLimit + syncLimit\" during the initial phase, is that right? LMK for sure and I'll update the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-10T15:58:27.763+0000","updated":"2013-05-10T15:58:27.763+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13654816","id":"13654816","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Here is my take. Setting tickOfNextAckDeadline to initLimit + syncLimit initially is conservative. At the same time, if the follower reacts fast, the learner handler will update tickOfNextAckDeadline it sooner after the sync up phase. Also, it only impacts the time for the current leader to release leadership if the follower crashes after completing the sync up phase. \n\nI think it is safer to update it, but if you don't update it, it will be a corner case, very unlikely to happen. \n\nDoes it make sense?  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-10T20:49:25.857+0000","updated":"2013-05-10T20:49:25.857+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13654823","id":"13654823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Conservative is good. See the updated patches. [~fpj] if you +1 I'll be happy to do the commit. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-10T20:59:12.459+0000","updated":"2013-05-10T20:59:12.459+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13654871","id":"13654871","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12582684/ZOOKEEPER-1697.patch\n  against trunk revision 1463329.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1476//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1476//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1476//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-10T21:35:06.031+0000","updated":"2013-05-10T21:35:06.031+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13655272","id":"13655272","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"+1, Thanks, Pat. \n\nb3.4 Committed revision 1481322.\n\ntrunk Committed revision 1481325.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-11T13:35:32.741+0000","updated":"2013-05-11T13:35:32.741+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13655513","id":"13655513","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in ZooKeeper-trunk #1923 (See [https://builds.apache.org/job/ZooKeeper-trunk/1923/])\n    ZOOKEEPER-1697. large snapshots can cause continuous quorum failure\n  (phunt via fpj) (Revision 1481325)\n\n     Result = SUCCESS\nfpj : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1481325\nFiles : \n* /zookeeper/trunk/CHANGES.txt\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-12T11:09:13.066+0000","updated":"2013-05-12T11:09:13.066+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12645566/comment/13933778","id":"13933778","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Closing issues after releasing 3.4.6.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2014-03-13T18:17:11.468+0000","updated":"2014-03-13T18:17:11.468+0000"}],"maxResults":30,"total":30,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1697/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1k89r:"}}