{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12504432","self":"https://issues.apache.org/jira/rest/api/2/issue/12504432","key":"ZOOKEEPER-1049","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316276","id":"12316276","description":"Fix release against 3.3 branch","name":"3.3.4","archived":false,"released":true,"releaseDate":"2011-11-26"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314469","id":"12314469","description":"Kerberos client auth, multi support, deb/rpm pkging.","name":"3.4.0","archived":false,"released":true,"releaseDate":"2011-11-22"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-04-18T18:38:54.592+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Oct 12 17:54:42 UTC 2011","customfield_12310420":"47501","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_448872006_*|*_1_*:*_1_*:*_1083994972_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-05-03T21:30:42.894+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1049/watchers","watchCount":5,"isWatching":false},"created":"2011-04-16T03:42:55.931+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315108","id":"12315108","description":"Fix release against 3.3 branch","name":"3.3.2","archived":false,"released":true,"releaseDate":"2010-11-11"}],"issuelinks":[{"id":"12344511","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12344511","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12527976","key":"ZOOKEEPER-1238","self":"https://issues.apache.org/jira/rest/api/2/issue/12527976","fields":{"summary":"when the linger time was changed for NIO the patch missed Netty","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-23T19:22:20.716+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"Let's say we have 100 clients (group A) already connected to three-node ZK ensemble with session timeout of 15 second.  And we have 1000 clients (group B) already connected to the same ZK ensemble, all watching several nodes (with 15 second session timeout)\n\nConsider a case in which All clients in group B suddenly hung or deadlocked (JVM OOME) all at the same time. 15 seconds later, all sessions in group B gets expired, creating session closing stampede. Depending on the number of this clients in group B, all request/response ZK ensemble should process get delayed up to 8 seconds (1000 clients we have tested).\n\nThis delay causes some clients in group A their sessions expired due to delay in getting heartbeat response. This causes normal servers to drop out of clusters. This is a serious problem in our installation, since some of our services running batch servers or CI servers creating the same scenario as above almost everyday.\n\nI am attaching a graph showing ping response time delay.\n\nI think ordering of creating/closing sessions and ping exchange isn't important (quorum state machine). at least ping request / response should be handle independently (different queue and different thread) to keep realtime-ness of ping.\n\nAs a workaround, we are raising session timeout to 50 seconds.\nBut this causes max. failover of cluster to significantly increased, thus initial QoS we promised cannot be met.\n\n\n\n\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12476516","id":"12476516","filename":"zk_ping_latency.pdf","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T03:43:51.298+0000","size":3626,"mimeType":"application/pdf","content":"https://issues.apache.org/jira/secure/attachment/12476516/zk_ping_latency.pdf"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12477238","id":"12477238","filename":"ZOOKEEPER-1049.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=netspider","name":"netspider","key":"netspider","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chisu Ryu","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-24T06:44:17.488+0000","size":695,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12477238/ZOOKEEPER-1049.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12476696","id":"12476696","filename":"ZookeeperPingTest.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T07:15:20.233+0000","size":18970,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12476696/ZookeeperPingTest.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32754","customfield_12312823":null,"summary":"Session expire/close flooding renders heartbeats to delay significantly","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"CentOS 5.3, three node ZK ensemble","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13020549","id":"13020549","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"Ping delay with respect to the number of clients closing session.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T03:43:51.315+0000","updated":"2011-04-16T03:43:51.315+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13020550","id":"13020550","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"We have monitored ZK ensemble server. There are no significant I/O activity, this workload is CPU bound. 0-3% io wait (this is normal system I/O wait due to system log flush, page cache flush daemon).  User CPU goes up to 30-40% during this closing stampede.\n\nWe'll attach ZK config file.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T03:47:01.619+0000","updated":"2011-04-16T03:47:01.619+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13020551","id":"13020551","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"Log4J log level is \"error\" during this test.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T03:48:26.405+0000","updated":"2011-04-16T03:48:26.405+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13020552","id":"13020552","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"ZK version is 3.3.3\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T03:48:52.121+0000","updated":"2011-04-16T03:48:52.121+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13020553","id":"13020553","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"tickTime=2000\ninitLimit=10\nsyncLimit=5\n\ndataDir=/???/zookeeper/data\ndataLogDir=/???/zookeeper/log\n\nclientPort=17288\n\nmaxClientCnxns=0\n\n#globalOutstandingLimit=1000, we tried both (no difference)\nglobalOutstandingLimit=50000\n\n# Arcus ZooKeeper Servers\nserver.1=????\nserver.2=????\nserver.3=1????\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T04:00:29.631+0000","updated":"2011-04-16T04:00:29.631+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13020555","id":"13020555","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"log4j.rootLogger=ERROR, ROLLINGFILE\n\nlog4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender\nlog4j.appender.CONSOLE.Threshold=INFO\nlog4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout\nlog4j.appender.CONSOLE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}@%L] - %m%n\n\nlog4j.appender.ROLLINGFILE=org.apache.log4j.RollingFileAppender\nlog4j.appender.ROLLINGFILE.Threshold=DEBUG\nlog4j.appender.ROLLINGFILE.File=/???/zookeeper/log/zookeeper.log\n\nlog4j.appender.ROLLINGFILE.MaxFileSize=50MB\nlog4j.appender.ROLLINGFILE.layout=org.apache.log4j.PatternLayout\nlog4j.appender.ROLLINGFILE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}@%L] - %m%n\n\nlog4j.appender.TRACEFILE=org.apache.log4j.FileAppender\nlog4j.appender.TRACEFILE.Threshold=TRACE\nlog4j.appender.TRACEFILE.File=/???/zookeeper/log/zookeeper_trace.log\n\nlog4j.appender.TRACEFILE.layout=org.apache.log4j.PatternLayout\nlog4j.appender.TRACEFILE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}@%L][%x] - %m%n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T04:02:37.031+0000","updated":"2011-04-16T04:02:37.031+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13020564","id":"13020564","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"bq. 1) are you running in a virtualized environment?\n\nNO\n\n{quote}\n2) are you co-locating other services on the same host(s) that make up\nthe ZK serving cluster?\n{quote}\n\nNO. Dedicated ZK ensemble\n\n{quote}\n3) have you followed the admin guide's \"things to avoid\"?\nhttp://zookeeper.apache.org/doc/r3.3.3/zookeeperAdmin.html#sc_commonProblems\nIn particular ensuring that you are not swapping or going into gc\npause (both on the server and the client)\na) try turning on GC logging and ensure that you are not going into GC\npause, see the troubleshooting guide, this is the most common cause of\nhigh latency for the clients\n{quote}\n\nNo full GC (jstat output)\n\n{quote}\nb) ensure that you are not swapping\n{quote}\n\nNo swapping. No significant IO (0-3% iowait utilization)\n\n\n{quote}\nc) ensure that other processes are not causing log writing\n(transactional logging) to be slow.\n{quote}\n\nNo other processes are running on these hosts.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T06:28:54.975+0000","updated":"2011-04-16T06:28:54.975+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13020565","id":"13020565","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"{quote} \n1) what is the connectivity like btw the servers?\nWhat is the ping time btw them?\n{quote}\n\nping time is under 1ms (inter-IDC)\n\n{quote}\nIs the system perhaps loading down the network during this test,\ncausing network latency to increase? Are all the nic cards (server and\nclient) configured correctly? I've seen a number of cases where\nclients and/or server had incorrectly configured nics (ethtool\nreported 10 MB/sec half duplex for what should be 1gigeth)\n{quote}\n\nThey all are configured Full-Duplex 1Gbps NIC.\nSwitches are all operational.\n\n{quote}\n2) regarding IO, if you run 'iostat -x 2' on the zk servers while your\nissue is happening, what's the %util of the disk? what's the iowait\nlook like?\n{quote}\n\n0-3% at the time of testing. It varies. There is no significant IO\nfrom Zookeeper process. Just normal page cache flush activity.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T06:35:36.066+0000","updated":"2011-04-16T06:35:36.066+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13020567","id":"13020567","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"How to reproduce\n\n1. 50 clients connect to ZK ensemble watching a node with 15 sec session timeout (calling group A)\n\n2. Let 1000 clients in other group (called group B) connect to the ZK ensemble, but hang the JVM (or intentionally create OOM case). Again with 15 sec session timeout\n\n3. Watch clients in group A drop out of the cluster due to ping delay (session expired)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T06:41:13.641+0000","updated":"2011-04-16T06:41:13.641+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13020568","id":"13020568","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"{quote}\nWhat about using multiple ZK clusters for this, then?\n{quote}\nSorry, we cannot do that due to service deployment policy\n\n{quote}\nHave you tested a cluster where the machines are set up correctly with separate snapshot and log disks?\n{quote}\nWe have two test/staging ZK ensemble setup, and one production. They reproduce the same result.\nSince IO wasn't an issue, there is no point of separating snapshot and log.\n\n{quote}\nAre your ZK machines doing any other tasks? \n{quote}\nThis is a dedicated ZK ensemble\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-16T06:45:38.218+0000","updated":"2011-04-16T06:45:38.218+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13021169","id":"13021169","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"This might be related to this email chain from February:\n\nhttp://mail-archives.apache.org/mod_mbox/zookeeper-user/201102.mbox/%3C6642FC1CAF133548AA8FDF497C547F0A23C0C5265B@NYWEXMBX2126.msad.ms.com%3E\n\nI theorized at the time that the issue might be due to synchronization on the session table, but never got enough information to finish the investigation.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-18T18:38:54.592+0000","updated":"2011-04-18T18:38:54.592+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13021438","id":"13021438","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"We have uploaded a simple reproducer scripts.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T07:15:20.261+0000","updated":"2011-04-19T07:15:20.261+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13021447","id":"13021447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"I have uploaded a python-based reproducer, and test results.\n\nThis probably is the worst iowait CPU% (you can find them in Result directory.\n\navg-cpu:  %user   %nice %system %iowait  %steal   %idle\n           6.15    0.00    2.05    2.56    0.00   89.23\n\n\nThe resulting latency delay (with this reproducer)- You will find 2 second delay for some clients\n\nclose session elapsed : 0ms\nclose session elapsed : 0ms\nclose session elapsed : 2001ms\nclose session elapsed : 1ms\nclose session elapsed : 0ms\n\n.....\n\nclose session elapsed : 0ms\nclose session elapsed : 0ms\nclose session elapsed : 2001ms\nclose session elapsed : 0ms\nclose session elapsed : 0ms\n....\n\nclose session elapsed : 0ms\nclose session elapsed : 2000ms\nclose session elapsed : 2000ms\nclose session elapsed : 0ms\nclose session elapsed : 0ms\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T07:31:49.572+0000","updated":"2011-04-19T07:31:49.572+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13021448","id":"13021448","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"When this happens \nBelow thread becomes BLOCKED\n\n\"NIOServerCxn.Factory:0.0.0.0/0.0.0.0:17288\" - Thread t@11\n   java.lang.Thread.State: BLOCKED on org.apache.zookeeper.server.NIOServerCnxn$Factory@399831c3 owned by: CommitProcessor:3\n\tat org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:234)\n   Locked ownable synchronizers:\n\t- None\n\nIf you look at CommitProcessor:3\n\n\"CommitProcessor:3\" - Thread t@27\n   java.lang.Thread.State: RUNNABLE\n\tat sun.nio.ch.FileDispatcher.preClose0(Native Method)\n\tat sun.nio.ch.SocketDispatcher.preClose(SocketDispatcher.java:41)\n\tat sun.nio.ch.SocketChannelImpl.implCloseSelectableChannel(SocketChannelImpl.java:684)\n\t- locked java.lang.Object@@3186c91\n\tat java.nio.channels.spi.AbstractSelectableChannel.implCloseChannel(AbstractSelectableChannel.java:201)\n\tat java.nio.channels.spi.AbstractInterruptibleChannel.close(AbstractInterruptibleChannel.java:97)\n\t- locked java.lang.Object@@7fc600\n\tat sun.nio.ch.SocketAdaptor.close(SocketAdaptor.java:352)\n\tat org.apache.zookeeper.server.NIOServerCnxn.closeSock(NIOServerCnxn.java:1463)\n\tat org.apache.zookeeper.server.NIOServerCnxn.close(NIOServerCnxn.java:1412)\n\t- locked java.util.HashSet@@4b94a39\n\tat org.apache.zookeeper.server.NIOServerCnxn$Factory.closeSessionWithoutWakeup(NIOServerCnxn.java:343)\n\tat org.apache.zookeeper.server.NIOServerCnxn$Factory.closeSession(NIOServerCnxn.java:330)\n\t- locked org.apache.zookeeper.server.NIOServerCnxn$Factory@@399831c\n\tat org.apache.zookeeper.server.FinalRequestProcessor.processRequest(FinalRequestProcessor.java:133)\n\tat org.apache.zookeeper.server.quorum.Leader$ToBeAppliedRequestProcessor.processRequest(Leader.java:540)\n\tat org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:73)\n   Locked ownable synchronizers:\n\t- None\n\n\nscxn.closeSession(request.sessionId)\nif (request.hdr != null && request.hdr.getType() == OpCode.closeSession) {\n    Factory scxn = zks.getServerCnxnFactory();\n    // this might be possible since\n    // we might just be playing diffs from the leader\n    if (scxn != null && request.cnxn == null) {\n        // calling this if we have the cnxn results in the client's\n        // close session response being lost - we've already closed\n        // the session/socket here before we can send the closeSession\n        // in the switch block below\n        scxn.closeSession(request.sessionId);\n        return;\n    }\n}\n\n\n\nBelow is a synchronized method\n\nNIOServerCnxn.Factory.closeSession()\nsynchronized void closeSession(long sessionId) {\n    selector.wakeup();\n    closeSessionWithoutWakeup(sessionId);\n}\n\n\n@SuppressWarnings(\"unchecked\")\nprivate void closeSessionWithoutWakeup(long sessionId) {\n    HashSet<NIOServerCnxn> cnxns;\n    synchronized (this.cnxns) {\n        cnxns = (HashSet<NIOServerCnxn>)this.cnxns.clone();\n    }\n\n    for (NIOServerCnxn cnxn : cnxns) {\n        if (cnxn.sessionId == sessionId) {\n            try {\n                cnxn.close();\n            } catch (Exception e) {\n                LOG.warn(\"exception during session close\", e);\n            }\n            break;\n        }\n    }\n}\n\n\n\nWe measured the time spent in scxn.closeSession(request.sessionId), and the result is in the previous post.\n\n\nif (request.hdr != null && request.hdr.getType() == OpCode.closeSession) {\n    Factory scxn = zks.getServerCnxnFactory();\n\n    if (scxn != null && request.cnxn == null) {\n\n        scxn.closeSession(request.sessionId);\n\n        return;\n    }\n}\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T07:36:56.832+0000","updated":"2011-04-19T07:36:56.832+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13021452","id":"13021452","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"I think we found a culprit\n\n{code}\npublic NIOServerCnxn(ZooKeeperServer zk, SocketChannel sock,\n            SelectionKey sk, Factory factory) throws IOException {\n        this.zk = zk;\n        this.sock = sock;\n        this.sk = sk;\n        this.factory = factory;\n        sock.socket().setTcpNoDelay(true);\n        sock.socket().setSoLinger(true, 2); // socket linger option of \n        InetAddress addr = ((InetSocketAddress) sock.socket()\n                .getRemoteSocketAddress()).getAddress();\n        authInfo.add(new Id(\"ip\", addr.getHostAddress()));\n        sk.interestOps(SelectionKey.OP_READ);\n    }\n{code}\n\nit is the socket linger option.\nsince clients session already expired, do we need to wait 2 second to wait until clients to consume socket receive buffer?\n\nwe have set to linger option to 0 to send TCP RESET, and the problem went away.\n\nWe'll try to test original case, and report back.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T07:48:05.120+0000","updated":"2011-04-19T07:48:05.120+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13021524","id":"13021524","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"We just verified that the original problem goes away when linger option is off (0)\nMystery solved.\n\nWe will patch our production server right away.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T10:20:20.004+0000","updated":"2011-04-19T10:20:20.004+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13021601","id":"13021601","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Chang,\n  I am quite confused. Not sure how setting the tcp linger time to 0 is helping you? What OS are you using? I find it surprising that setting the linger time to be 0 doesnt delay packets to other sockets. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T14:17:12.185+0000","updated":"2011-04-19T14:17:12.185+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13021695","id":"13021695","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Ben and I looked at the man page of socket and here is what it says:\n\n{noformat}\nSO_LINGER\nSets or gets the SO_LINGER option. The argument is a linger structure.\nstruct linger {\n    int l_onoff;    /* linger active */\n    int l_linger;   /* how many seconds to linger for */\n};\nWhen enabled, a close(2) or shutdown(2) will not return until all queued messages for the socket have been successfully sent or the linger timeout has been reached. Otherwise, the call returns immediately and the closing is done in the background. When the socket is closed as part of exit(2), it always lingers in the background.\n{noformat}\n\nSo, since we have a single thread that calls close() and IO on sockets, it is possible that this can cause a huge delay in IO for other sockets. Anyone else hasmore information on this please feel free to update!\n\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T18:14:02.634+0000","updated":"2011-04-19T18:14:02.634+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13021788","id":"13021788","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"body":"Is it possible that somebody on the server side has a lock while trying to close a socket to a failed machine?\n\nOr is it possible that there is a limited number of threads available for this closing activity?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-04-19T20:46:27.605+0000","updated":"2011-04-19T20:46:27.605+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13021827","id":"13021827","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"OK.\n\nLinger option with 2 second timeout on Apache web server works because it is connection per process/thread model. Blocking in one process does not block other request processing.\n\nIf you look at the code below, I don't see why it shouldn't block.\nOne 2 sec delay causes some other closing activity to 4 or 6 or 8 seconds, and so forth.\n\n{code}\nNIOServerCnxn.Factory.closeSession()\nsynchronized void closeSession(long sessionId) { selector.wakeup(); closeSessionWithoutWakeup(sessionId); }\n\n@SuppressWarnings(\"unchecked\")\nprivate void closeSessionWithoutWakeup(long sessionId) {\n  HashSet<NIOServerCnxn> cnxns;\n  synchronized (this.cnxns) { cnxns = (HashSet<NIOServerCnxn>)this.cnxns.clone(); }\n\n  for (NIOServerCnxn cnxn : cnxns) {\n    if (cnxn.sessionId == sessionId) {\n      try { cnxn.close(); } \n      catch (Exception e) { LOG.warn(\"exception during session close\", e); }\n      break;\n    }\n  }\n}\n{code}\n\nOne thing I need to make correction, my team didn't set linger to 0.\nThey disabled the linger option, close() returns immediately (lingering done by TCP stack)\n\nThis is different than setting linger to 0, which simply flush all the buffers and send TCP RST.\nBy disabling linger option, system will hold on to the socket in FIN_WAIT_1 state for dead clients.\nnote that we have no timeout for FIN_WAIT_1 sockets.\n\nWe'll have to experiment with setting linger option 0 to move socket from ESTABLISHED to CLOSED states immediately. \n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T22:17:56.793+0000","updated":"2011-04-19T22:17:56.793+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13022691","id":"13022691","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"I don't see any problem with disabling linger option due to net.ipv4.tcp_orphan_retries being 200ms on Linux. socket without lingering option to dead server closed to FIN_WAIT_1 setting times out immediately (after 200ms) and immediately CLOSED.\n\nSo our final fix is \n\nsetSoLinger(false, -1)\n\nPlease consider this fix for next release.\nThank you.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-21T09:10:33.966+0000","updated":"2011-04-21T09:10:33.966+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13023635","id":"13023635","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=netspider","name":"netspider","key":"netspider","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chisu Ryu","active":true,"timeZone":"Etc/UTC"},"body":"This patch set NIOServerCnxn linger option to 'false, -1'.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=netspider","name":"netspider","key":"netspider","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chisu Ryu","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-24T06:44:17.513+0000","updated":"2011-04-24T06:44:17.513+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13026378","id":"13026378","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12477238/ZOOKEEPER-1049.patch\n  against trunk revision 1091841.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/235//testReport/\nFindbugs warnings: https://builds.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/235//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/235//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-28T17:13:32.607+0000","updated":"2011-04-28T17:13:32.607+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13028441","id":"13028441","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"I just committed this! Very nice catch! thanks chang!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-03T21:30:42.903+0000","updated":"2011-05-03T21:30:42.903+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13028443","id":"13028443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"BTW, I added a tiny comment with the patch so that its clear for others.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-03T21:32:50.359+0000","updated":"2011-05-03T21:32:50.359+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13028555","id":"13028555","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"Kudos to \"Chisu Ryu\", who found the root cause and came up with the fix.\nThank you.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-04T01:55:33.325+0000","updated":"2011-05-04T01:55:33.325+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13028703","id":"13028703","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in ZooKeeper-trunk #1172 (See [https://builds.apache.org/hudson/job/ZooKeeper-trunk/1172/])\n    ZOOKEEPER-1049. Session expire/close flooding renders heartbeats to delay significantly. (chang song via mahadev)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-04T10:55:05.942+0000","updated":"2011-05-04T10:55:05.942+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12504432/comment/13125996","id":"13125996","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Recently a couple of users have reported this - I'm including it in 3.3.4 as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-12T17:54:42.842+0000","updated":"2011-10-12T17:54:42.842+0000"}],"maxResults":28,"total":28,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1049/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05ywn:"}}