{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12515792","self":"https://issues.apache.org/jira/rest/api/2/issue/12515792","key":"ZOOKEEPER-1140","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314469","id":"12314469","description":"Kerberos client auth, multi support, deb/rpm pkging.","name":"3.4.0","archived":false,"released":true,"releaseDate":"2011-11-22"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-07-30T23:38:46.945+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Aug 30 10:55:32 UTC 2011","customfield_12310420":"3982","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_932966277_*|*_1_*:*_1_*:*_1795103125_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-08-30T06:37:27.216+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1140/watchers","watchCount":2,"isWatching":false},"created":"2011-07-29T16:49:37.972+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314469","id":"12314469","description":"Kerberos client auth, multi support, deb/rpm pkging.","name":"3.4.0","archived":false,"released":true,"releaseDate":"2011-11-22"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-23T19:22:38.015+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312427","id":"12312427","name":"tests","description":"For issues with test cases"}],"timeoriginalestimate":null,"description":"Near the end of QuorumZxidSyncTest there are tons of threads running - 115 \"ProcessThread\" threads, similar numbers of SessionTracker.\n\nAlso I see ~100 ReadOnlyRequestProcessor - why is this running as a separate thread? (henry/flavio?)\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12490942","id":"12490942","filename":"ZOOKEEPER-1140.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-08-19T11:24:27.441+0000","size":5915,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12490942/ZOOKEEPER-1140.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32696","customfield_12312823":null,"summary":"server shutdown is not stopping threads","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13072912","id":"13072912","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Comment on list from lakshman_ch:\n\nIn QuorumPeer, when the peer is in LOOKING state we are starting\nReadOnlyZooKeeperServer in a separate thread. And we are shutting down this\nserver even before startup which has no effect. Also, as this is not a\nblocking call QP keeps on spawning new servers.\n\n1) ReadOnlyZooKeeperServer.startup() need not be called in separate a\nthread.\n2) ReadOnlyZooKeeperServer.startup() is not a blocking call. Need to\nintroduce a method like Leader.lead(), Follower.followLeader()\n3) Shutdown should be called only after the a/m blocking call is returned.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-07-29T16:51:31.335+0000","updated":"2011-07-29T16:51:31.335+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13072914","id":"13072914","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Shouldn't R/O support only be enabled via an explicit configuration option? i.e. off by default.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-07-29T16:53:25.409+0000","updated":"2011-07-29T16:53:25.409+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13073264","id":"13073264","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Some comments:\n\n# Waiting for some grace period to start the RO zookeeper server avoids switching back and forth frequently when connectivity is intermittent;\n# Calling startup() in a new thread makes sense because otherwise we hold leader election until the grace period for RO expires. The alternative I see is to check for this grace period in the beginning of the run() method of RORequestProcessor; \n# shutdown() should have no effect if the zookeeper server hasn't started. Are you concerned that we might end up creating RO zookeeper servers and using them unnecessarily? \n# Pat, I think you had some insight for why it should be off by default. Could you remind me what it is, please?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-07-30T23:38:46.945+0000","updated":"2011-07-30T23:38:46.945+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13073560","id":"13073560","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks for the clarifications Flavio.\nI agree with your explanation in #1 and #2.\n\n{quote}shutdown() should have no effect if the zookeeper server hasn't started. Are you concerned that we might end up creating RO zookeeper servers and using them unnecessarily?\n{quote}\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-08-01T14:48:56.867+0000","updated":"2011-08-01T14:48:56.867+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13073561","id":"13073561","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"body":"Reposting the comment as I'm not able to edit my previous comment.\n\nThanks for the clarifications Flavio.\nI agree with your explanation in #1 and #2.\n\n{quote}\nshutdown() should have no effect if the zookeeper server hasn't started. Are you concerned that we might end up creating RO zookeeper servers and using them unnecessarily?\n{quote}\n\nYes, while debugging the flow I've noticed that many servers are getting spawned continuously.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-08-01T14:51:22.473+0000","updated":"2011-08-01T14:51:22.473+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13073620","id":"13073620","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. Pat, I think you had some insight for why it should be off by default. Could you remind me what it is, please?\n\nWe don't want to change the default behavior of the server during a minor release - if people upgrade they may not be expecting the server to drop into r/o mode automatically. New features such as this should be \"off by default\" with a configuration option to enable.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-08-01T17:30:50.172+0000","updated":"2011-08-01T17:30:50.172+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13076008","id":"13076008","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Laxman, I might have misinterpreted your comment initially about the shutting down the server before it starts. Just to see if I understand now, are you saying that the test is spawning over one hundred servers because we are shutting before the server actually starts? If so, then it is certainly a problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-08-02T02:38:34.376+0000","updated":"2011-08-02T02:38:34.376+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13082146","id":"13082146","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"body":"Thread [Sender-/127.0.0.1:3084] (Running)\n\nWhen I observed QuorumZxidSyncTest, the above thread is also leaking in a different scenario apart from ReadOnlyZKServer. Above mentioned thread will be shutdown only if it receives proposalOfDeath.\n\nWe are queuing proposalOfDeath in finally block of LearnerHandler.run().\n\nTo summarize, proposalOfDeath may not queued up when LearnerHandler receives IOException and other thread calling LearnerHandler.shutdown(). This leads to failure of queuing the proposalOfDeath.\n\nTo solve this, can we add the proposalOfDeath in shutdown() rather in finally block.\n\nAnyways, this finding will solve one of the leaks. We still need to fix other leaks caused by ROZK.\n\n{quote}Just to see if I understand now, are you saying that the test is spawning over one hundred servers because we are shutting before the server actually starts? If so, then it is certainly a problem.{quote}\n\nYes. I will add more analysis and possibly patch today.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-08-10T05:51:35.792+0000","updated":"2011-08-10T05:51:35.792+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13082253","id":"13082253","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"body":"Two leaks has been identified.\n\n1) SendThread is getting leaked. [LearnerHandler]\n*Approach to fix*\na) Add the proposalOfDeath in shutdown() rather in finally block. \n\n2) ROZK is getting shutdown even before startup.\n*Approach to fix*\na) Synchronize the startup and shutdown of ROZK to avoid concurrent startp and shutdown.\nb) Add a flag \"shutdown\" and check in startup to avoid startup after shutdown.\nc) Interrupt the thread that is starting ROZK and join on that thread in finally block before calling shutdown.\n\nBoth of these leaks I'm planning to address in my patch as per a/m approach.\n\nPlease let me know if you have any different approach or any suggestion.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-08-10T09:35:47.318+0000","updated":"2011-08-10T09:35:47.318+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13082254","id":"13082254","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"body":"{quote}Shouldn't R/O support only be enabled via an explicit configuration option? i.e. off by default.{quote}\n\nI feel we may need to address the above comment in separate jira.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-08-10T09:36:08.159+0000","updated":"2011-08-10T09:36:08.159+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13087658","id":"13087658","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"body":"Patch fixes both the thread leaks noticed as per the a/m approach.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-08-19T11:28:01.048+0000","updated":"2011-08-19T11:28:01.048+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13087666","id":"13087666","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12490942/ZOOKEEPER-1140.patch\n  against trunk revision 1159432.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/468//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/468//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/468//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-19T11:54:38.947+0000","updated":"2011-08-19T11:54:38.947+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13087677","id":"13087677","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"body":"{quote}\n-1 tests included. The patch doesn't appear to include any new or modified tests.\nPlease justify why no new tests are needed for this patch.\nAlso please list what manual steps were performed to verify this patch.\n{quote}\n\nThis fix doesn't include any new functionality. Fixes the thread leaks for which I'm not able to automate a testcase. \n\nManually verified the QuorumZxidSyncTest and checked the thread dumps to see any leaks in debug mode. All the thread leaks noticed were fixed with this patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-08-19T12:24:42.267+0000","updated":"2011-08-19T12:24:42.267+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13093456","id":"13093456","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"+1 looks good to me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-30T05:51:22.155+0000","updated":"2011-08-30T05:51:22.155+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13093470","id":"13093470","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12490942/ZOOKEEPER-1140.patch\n  against trunk revision 1163015.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/478//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/478//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/478//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-30T06:21:09.566+0000","updated":"2011-08-30T06:21:09.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13093480","id":"13093480","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"I just committed this. Thanks Laxman!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-30T06:37:27.233+0000","updated":"2011-08-30T06:37:27.233+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13093560","id":"13093560","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks for review and commit Mahadev.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-08-30T08:52:40.221+0000","updated":"2011-08-30T08:52:40.221+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12515792/comment/13093647","id":"13093647","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in ZooKeeper-trunk #1288 (See [https://builds.apache.org/job/ZooKeeper-trunk/1288/])\n    ZOOKEEPER-1140. server shutdown is not stopping threads. (laxman via mahadev)\n\nmahadev : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1163102\nFiles : \n* /zookeeper/trunk/CHANGES.txt\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/ReadOnlyZooKeeperServer.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-30T10:55:32.578+0000","updated":"2011-08-30T10:55:32.578+0000"}],"maxResults":18,"total":18,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1140/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05yjr:"}}