{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12546846","self":"https://issues.apache.org/jira/rest/api/2/issue/12546846","key":"ZOOKEEPER-1424","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2012-03-16T21:31:00.033+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Mar 20 21:53:11 UTC 2012","customfield_12310420":"232004","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1424/watchers","watchCount":3,"isWatching":false},"created":"2012-03-16T21:15:06.846+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12319196","id":"12319196","description":"Fix release against 3.4 branch.","name":"3.4.2","archived":false,"released":true,"releaseDate":"2011-12-29"}],"issuelinks":[{"id":"12398328","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12398328","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12745421","key":"ZOOKEEPER-2052","self":"https://issues.apache.org/jira/rest/api/2/issue/12745421","fields":{"summary":"Unable to delete a node when the node has no children","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-10-06T13:47:35.951+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"Hi all, \n\nWhile using zookeeper at midokura we hit an interesting bug in zookeeper. We did hit it sporadically \nwhile developing some functional tests so i had to build a test case for it. \n\nI finally created the test case and i think i narrowed down the conditions under which it happens. \nSo i wanted to let you know my findings since they are somewhat troublesome. \n\nWe need:\n  - one running zookeeper server (didn't test that with a cluster)\n      let's name this: server\n\n  - one running zookeeper client that will create an ephemeral node under the tree created by the next client\n      let's name this: the ephemeral client\n\n  - one running zookeeper client that will create a persistent tree and try to delete that tree\n      let's name this: the persistent client\n\nWhat needs to happen is this:\n\n step 1. - the server starts\n step 2. - the persistent client connects and creates a tree\n step 3. - the ephemeral client connects and adds a ephemeral node under the tree created by the persistent client\n step 4. - the persistent client will try to delete the tree recursively (without including the ephemeral node in the multi op\n step 5. - the ephemeral client crashes hard (the equivalent of kill -9)\n step 6. - the persistent client will try to delete the tree recursively again (and fail with NoEmptyNode even if when we list the node we don't see any childrens)\n    - the zookeeper server needs to be restarted in order for this to work. \n\nThe step 4 is critical in the sense that if we don't have that (there is no previous error trying to remove a tree) then the nexts steps behave as we would expect them to behave (aka pass). \n\nAlso no amount of fiddling with zookeeper connection timeouts (between zookeeper and ephemeral node) will help. \n \nIf the ephemeral client is shutdown properly it seems like everything will behave properly (even with step 4). \n\nThe test code is available here:\n   https://github.com/mtoadermido/play\n\nIt needs an zookeepr 3.4.2 installed on the system (it uses the installed jars from the deb to spawn the zookeeper server).\n\nThe entry point is https://github.com/mtoadermido/play/blob/master/src/main/java/com/midokura/tests/zookeeper/BlockingBug.java\n\nThere is a lot of boiler plate since i didn't want it to be depending on stuff from midonet but the interesting part is the BlockingBug.main() method. \n\nIt will launch a zookeeper process, an external ephemeral client process, and after that act as the second client. \n\nAvailable tweaks:\n- the zookeeper client timeout for the ephemeral client here: \n  https://github.com/mtoadermido/play/blob/master/src/main/java/com/midokura/tests/zookeeper/BlockingBug.java#L56\n\n- the step 4 here (set to true / false):\n https://github.com/mtoadermido/play/blob/master/src/main/java/com/midokura/tests/zookeeper/BlockingBug.java#L69\n\n- the shutdown of the ephemeral client (soft aka clean shutdown, hard aka kill -9):\n https://github.com/mtoadermido/play/blob/master/src/main/java/com/midokura/tests/zookeeper/BlockingBug.java#L88\n\nThe result is displayed depending on the fact that the final recursive deletion succeeded or not:\n   \nWe hit it !. The clear tree failed.\n   https://github.com/mtoadermido/play/blob/master/src/main/java/com/midokura/tests/zookeeper/BlockingBug.java#L103\n\n\"No error :(\"  \n   https://github.com/mtoadermido/play/blob/master/src/main/java/com/midokura/tests/zookeeper/BlockingBug.java#L99\n\n\nThe conclusion is that the bug seems to be inside the zookeeper codebase and it's prone to being triggered by this \nparticular usage of zookeeper combined with the misfortune of having to kill the ephemeral process hard. \n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12518761","id":"12518761","filename":"zookeeper.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mtoader","name":"mtoader","key":"mtoader","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mihai Claudiu Toader","active":true,"timeZone":"Etc/UTC"},"created":"2012-03-17T00:56:47.233+0000","size":25131,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12518761/zookeeper.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32565","customfield_12312823":null,"summary":"ZooKeeper will not allow a client to delete a tree when it should allow it","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mtoader","name":"mtoader","key":"mtoader","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mihai Claudiu Toader","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mtoader","name":"mtoader","key":"mtoader","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mihai Claudiu Toader","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux ubuntu 11.10, Zookeeper 3.4.2, One server, Two Java clients","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12546846/comment/13231650","id":"13231650","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Mihai thanks for the report. Would it be possible for you to run this with DEBUG logging turned on for the server and attach the server logs from after the test run?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-16T21:31:00.033+0000","updated":"2012-03-16T21:31:00.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12546846/comment/13231654","id":"13231654","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mtoader","name":"mtoader","key":"mtoader","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mihai Claudiu Toader","active":true,"timeZone":"Etc/UTC"},"body":"Right now i'm leaving for a trip but as soon as i get a computer i'll do that. No later than 22'th March. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mtoader","name":"mtoader","key":"mtoader","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mihai Claudiu Toader","active":true,"timeZone":"Etc/UTC"},"created":"2012-03-16T21:35:58.624+0000","updated":"2012-03-16T21:35:58.624+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12546846/comment/13231657","id":"13231657","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"No problem. You did an awesome job documenting the issue, I was just wondering if you had it close to hand (would make it easier for reviewers to take a look). Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-16T21:44:05.281+0000","updated":"2012-03-16T21:44:05.281+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12546846/comment/13231773","id":"13231773","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mtoader","name":"mtoader","key":"mtoader","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mihai Claudiu Toader","active":true,"timeZone":"Etc/UTC"},"body":"Zookeeper server log with DEBUG enabled when the issue appears.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mtoader","name":"mtoader","key":"mtoader","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mihai Claudiu Toader","active":true,"timeZone":"Etc/UTC"},"created":"2012-03-17T00:56:47.349+0000","updated":"2012-03-17T00:56:47.349+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12546846/comment/13233679","id":"13233679","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"body":"Pat,\n\nI looked through the scenarios and don't see anything that stands our as likely to be due to multi.\n\nMihai,\n\nIf you do the deletes without multi, do you see the problem?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-20T19:29:11.624+0000","updated":"2012-03-20T19:29:11.624+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12546846/comment/13233843","id":"13233843","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"body":"OK.  THis is strange.  I made some changes at git://github.com/tdunning/play.git\n\nThese include:\n\n- made the test run as a test instead of as main. (trivial change to all mvn test to work)\n\n- changed the classpath logic to look in ../zookeeper-3.4.5 for a dev version of Zookeeper.  (trivial change for convenience)\n\n- unrolled all of the multi's into a loop that calls each op separately.  (this is the money)\n\nAround line 139, I have two versions of an unrolled delete.  One is this:\n\n{code}\n            zooKeeper.delete(op.getPath(), -1);\n{code}\n\nand the other is this:\n\n{code}\n            zooKeeper.multi(ImmutableList.of(op));\n{code}\n\nThese should be equivalent. \n\nThey are not.\n\nSo the problem has nothing really to do with the multi-ness and seems to have something to do with the\nway that multi does one of the single deletions.\n\nI don't have more time today, but hopefully this puts the ball a little further down the field.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tdunning","name":"tdunning","key":"tdunning","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ted Dunning","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-20T21:53:11.344+0000","updated":"2012-03-20T21:53:11.344+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1424/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05xqn:"}}