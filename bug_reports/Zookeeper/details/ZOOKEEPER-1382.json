{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12540477","self":"https://issues.apache.org/jira/rest/api/2/issue/12540477","key":"ZOOKEEPER-1382","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-02-15T20:32:12.310+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Oct 14 05:46:57 UTC 2016","customfield_12310420":"225890","customfield_12312320":null,"customfield_12310222":"3_*:*_1_*:*_318560030_*|*_10002_*:*_5_*:*_22573523257_*|*_1_*:*_5_*:*_35925428374_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-12-11T19:18:31.158+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1382/watchers","watchCount":17,"isWatching":false},"created":"2012-01-31T01:06:39.532+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"10.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321883","id":"12321883","description":"Fix release against 3.4 branch","name":"3.4.5","archived":false,"released":true,"releaseDate":"2012-11-18"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-10-14T05:47:47.467+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"I've observed that zookeeper server holds onto expired session ids in the watcher data structures. The result is the wchp command reports session ids that cannot be found through cons/dump and those expired session ids sit there maybe until the server is restarted. Here are snippets from the client and the server logs that lead to this state, for one particular session id 0x134485fd7bcb26f -\n\nThere are 4 servers in the zookeeper cluster - 223, 224, 225 (leader), 226 and I'm using ZkClient to connect to the cluster\n\nFrom the application log -\n\napplication.log.2012-01-26-325.gz:2012/01/26 04:56:36.177 INFO [ClientCnxn] [main-SendThread(223.prod:12913)] [application Session establishment complete on server 223.prod/172.17.135.38:12913, sessionid = 0x134485fd7bcb26f, negotiated timeout = 6000\napplication.log.2012-01-27.gz:2012/01/27 09:52:37.714 INFO [ClientCnxn] [main-SendThread(223.prod:12913)] [application] Client session timed out, have not heard from server in 9827ms for sessionid 0x134485fd7bcb26f, closing socket connection and attempting reconnect\napplication.log.2012-01-27.gz:2012/01/27 09:52:38.191 INFO [ClientCnxn] [main-SendThread(226.prod:12913)] [application] Unable to reconnect to ZooKeeper service, session 0x134485fd7bcb26f has expired, closing socket connection\n\nOn the leader zk, 225 -\n\nzookeeper.log.2012-01-27-leader-225.gz:2012-01-27 09:52:34,010 - INFO  [SessionTracker:ZooKeeperServer@314] - Expiring session 0x134485fd7bcb26f, timeout of 6000ms exceeded\nzookeeper.log.2012-01-27-leader-225.gz:2012-01-27 09:52:34,010 - INFO  [ProcessThread:-1:PrepRequestProcessor@391] - Processed session termination for sessionid: 0x134485fd7bcb26f\n\nOn the server, the client was initially connected to, 223 -\n\nzookeeper.log.2012-01-26-223.gz:2012-01-26 04:56:36,173 - INFO  [CommitProcessor:1:NIOServerCnxn@1580] - Established session 0x134485fd7bcb26f with negotiated timeout 6000 for client /172.17.136.82:45020\nzookeeper.log.2012-01-27-223.gz:2012-01-27 09:52:34,018 - INFO  [CommitProcessor:1:NIOServerCnxn@1435] - Closed socket connection for client /172.17.136.82:45020 which had sessionid 0x134485fd7bcb26f\n\nHere are the log snippets from 226, which is the server, the client reconnected to, before getting session expired event -\n\n2012-01-27 09:52:38,190 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:12913:NIOServerCnxn@770] - Client attempting to renew session 0x134485fd7bcb26f at /172.17.136.82:49367\n2012-01-27 09:52:38,191 - INFO  [QuorumPeer:/0.0.0.0:12913:NIOServerCnxn@1573] - Invalid session 0x134485fd7bcb26f for client /172.17.136.82:49367, probably expired\n2012-01-27 09:52:38,191 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:12913:NIOServerCnxn@1435] - Closed socket connection for client /172.17.136.82:49367 which had sessionid 0x134485fd7bcb26f\n\nwchp output from 226, taken on 01/30 -\n\nnnarkhed-ld:zk-cons-wchp-2012013000 nnarkhed$ grep 0x134485fd7bcb26f *226.*wchp* | wc -l\n3\n\nwchp output from 223, taken on 01/30 -\n\nnnarkhed-ld:zk-cons-wchp-2012013000 nnarkhed$ grep 0x134485fd7bcb26f *223.*wchp* | wc -l\n0\n\ncons output from 223 and 226, taken on 01/30 -\n\nnnarkhed-ld:zk-cons-wchp-2012013000 nnarkhed$ grep 0x134485fd7bcb26f *226.*cons* | wc -l\n0\n\nnnarkhed-ld:zk-cons-wchp-2012013000 nnarkhed$ grep 0x134485fd7bcb26f *223.*cons* | wc -l\n0\n\nSo, what seems to have happened is that the client was able to re-register the watches on the new server (226), after it got disconnected from 223, inspite of having an expired session id. \n\n\nIn NIOServerCnxn, I saw that after suspecting that a session is expired, a server removes the cnxn and its watches from its internal data structures. But before that it allows more requests to be processed even if the session is expired -\n\n            // Now that the session is ready we can start receiving packets\n            synchronized (this.factory) {\n                sk.selector().wakeup();\n                enableRecv();\n            }\n        } catch (Exception e) {\n            LOG.warn(\"Exception while establishing session, closing\", e);\n            close();\n        }\n\nI wonder if the client somehow sneaked in the set watches, right after the server removed the connection through removeCnxn() API ?\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12514699","id":"12514699","filename":"ZOOKEEPER-1382_3.3.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-15T20:29:26.044+0000","size":45556,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12514699/ZOOKEEPER-1382_3.3.4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12617336","id":"12617336","filename":"ZOOKEEPER-1382.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-06T04:51:42.613+0000","size":20892,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12617336/ZOOKEEPER-1382.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12612572","id":"12612572","filename":"ZOOKEEPER-1382.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-07T10:46:49.699+0000","size":20740,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12612572/ZOOKEEPER-1382.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12610262","id":"12610262","filename":"ZOOKEEPER-1382.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-25T03:55:16.876+0000","size":20757,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12610262/ZOOKEEPER-1382.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12609581","id":"12609581","filename":"ZOOKEEPER-1382.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-22T02:26:39.401+0000","size":21968,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12609581/ZOOKEEPER-1382.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12572967","id":"12572967","filename":"ZOOKEEPER-1382.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"created":"2013-03-10T15:20:24.866+0000","size":19589,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12572967/ZOOKEEPER-1382.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12617335","id":"12617335","filename":"ZOOKEEPER-1382-branch-3.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-06T04:50:52.609+0000","size":16735,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12617335/ZOOKEEPER-1382-branch-3.4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12610261","id":"12610261","filename":"ZOOKEEPER-1382-branch-3.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-25T03:45:00.917+0000","size":16735,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12610261/ZOOKEEPER-1382-branch-3.4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12609579","id":"12609579","filename":"ZOOKEEPER-1382-branch-3.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-22T02:24:31.567+0000","size":15797,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12609579/ZOOKEEPER-1382-branch-3.4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12571817","id":"12571817","filename":"ZOOKEEPER-1382-branch-3.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"created":"2013-03-03T20:09:49.162+0000","size":14428,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12571817/ZOOKEEPER-1382-branch-3.4.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32583","customfield_12312823":null,"summary":"Zookeeper server holds onto dead/expired session ids in the watch data structures","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13208770","id":"13208770","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"body":"Found this bug on 3.3.4 and hence, am uploading a draft patch with a possible fix for 3.3.4 first. If it looks good, I'll try doing the same on trunk.\n\nHere is what I think is causing this bug. Please correct me if I'm wrong -\n\nSay a client connects to a > 1 node ZK cluster and registers watch on some path. After that, if the client goes into a GC pause, the leader expires the session and proposes closing the session to the followers. Meanwhile, the client wakes up and tries to renew its session with one of the followers. Now, when the follower detects that the session is invalid, it sends a close session response to the client, and enables receive on the selector key for that connection. So it receives the setWatches request during the renew session. There is a race condition since the request processors on the follower merely \"pass-through\" the non-transactional setWatches request while the NIOServerCnxn has sent the close session request to the client. Due to the above, sometimes, the watches are set right after the NIOServerCnxn is removed from the ZooKeeperServer. Hence, the watches are left on the servers, for expired sessions, effectively causing a memory leak.  \n\nThe fix is to enable reads on the connection only if the session is found to be valid.\n\nFor testing, I wrote a test and added it as part of the DisconnectedWatcherTest. However, it uses the in-memory ZK ensemble class from curator, with a few modifications to test watches. In addition to this, have added a timeoutSession() API to TestableZooKeeper to simulate the client side GC pause. However, it involves suspending and resuming the event thread. \n\nI have 2 concerns about tests for this patch -\n1. Method used to simulate a client side GC pause\n2. Longer test duration, since the test runs multiple iterations to reproduce this corner case race condition\n\nFor 1, this is hacky, works, but it will be good to know other alternatives for writing this test.\nFor 2, since this is more of a system test, wonder what is the best way to include it in zookeeper. Also, the new helper classes are from curator. \n\nLastly, I left the DEBUG/TRACE logging, that I found useful to understand the server code, in the patch. Maybe, not all of it follows logging conventions.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-15T20:29:26.226+0000","updated":"2012-02-15T20:29:26.226+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13208774","id":"13208774","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12514699/ZOOKEEPER-1382_3.3.4.patch\n  against trunk revision 1242982.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 16 new or modified tests.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/956//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-15T20:32:12.310+0000","updated":"2012-02-15T20:32:12.310+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13208792","id":"13208792","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"This is a lot of change for a fix that seems to be really small. Can you put this into reviewboard for more careful review? I'm not sure we will want all the logging changes so you might want to go through and trim that stuff up before putting it up there. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-15T21:03:54.399+0000","updated":"2012-02-15T21:03:54.399+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13232470","id":"13232470","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"this is a good one to get in, see the feedback provided so far though. (also, likely we'll need a patch for post 3.3).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-19T05:56:23.468+0000","updated":"2012-03-19T05:56:23.468+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13404070","id":"13404070","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Moving it out, Neha can you please provide a patch for trunk and 3.4 as well? Good to see the tests that you added.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-06-29T17:57:15.263+0000","updated":"2012-06-29T17:57:15.263+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13444683","id":"13444683","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Moving it out again, Neha any chance you will have some bandwidth to follow up on this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2012-08-30T05:16:35.529+0000","updated":"2012-08-30T05:16:35.529+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13575670","id":"13575670","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"body":"Since we monitor sessions and watches we note that we encounter this problem from time to time.\nThis is not a big issue but it causes a memory leak.\nI'll try to see if I can work on it but it does seem hard to reproduce in a unit test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"created":"2013-02-11T08:27:08.579+0000","updated":"2013-02-11T08:27:08.579+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13591846","id":"13591846","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"body":"I managed to create a JUnit test case that demonstrate the \"watches leak\", unfortunately i had to promote a few methods to the public scope.\n\nAs Neha pointed out the unit test shows that if a client send a connection request with an expired session the NIOServerCnxn class still processes upcoming messages like OpCode.setWatches.\n\nActually the fix simply consists to call cnxn.enableRecv() only if the session has been validated by the leader.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"created":"2013-03-03T19:48:55.701+0000","updated":"2013-03-03T19:48:55.701+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13591848","id":"13591848","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12571815/ZOOKEEPER-1382.patch\n  against trunk revision 1448007.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1419//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-03-03T19:51:49.271+0000","updated":"2013-03-03T19:51:49.271+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13591853","id":"13591853","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"body":"Current patch is for branch 3.4\nSorry","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"created":"2013-03-03T20:09:49.166+0000","updated":"2013-03-03T20:09:49.166+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13591854","id":"13591854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12571817/ZOOKEEPER-1382-branch-3.4.patch\n  against trunk revision 1448007.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1420//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-03-03T20:11:48.714+0000","updated":"2013-03-03T20:11:48.714+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13592041","id":"13592041","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Michael,\n Would you be able to upload a patch for trunk as well?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2013-03-04T07:36:58.213+0000","updated":"2013-03-04T07:36:58.213+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13592254","id":"13592254","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"body":"It seems that the behavior of disableRecv() / enableRecv() has changed a bit in 3.5 : there is a new thread (SelectorThread) in charge of interest op updates and updates are processed in a non blocking fashion (updates are queued to be handled later by the SelectorThread, if i understand correctly it is more a throttle mechanism than something else). The unit test is no more relevant.\n\nIf we want to fix the two branches (3.4 and 3.5) it is imho no more a good idea to rely on enableRecv().\nMay be it would be cleaner to introduce a new function ServerCnxn.setValidSession(boolean valid) that informs the implementation (NIOServerCnxn or NettyServerCnxn) that the session has been (re)validated and then allow subsequent messages to be processed.\n\nIf you don't mind i will try to provide an other patch and a unit test for both branches.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"created":"2013-03-04T14:57:18.500+0000","updated":"2013-03-04T14:57:18.500+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13594399","id":"13594399","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Can you explain a bit more why we cannot rely on disableRecv() / enableRecv() in 3.5 to fix this issue? \n\nFrom my understanding, although the request is now process in non-blocking fashion, we are calling disableRecv() while processing a ConnectRequest packet, so the SelectorThread won't try to select this socket again for reading after we finished processing the packet. \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-03-06T05:49:47.861+0000","updated":"2013-03-06T05:49:47.861+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13596979","id":"13596979","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"body":"My bad, I have not spend enough time on the new branch, you are right. The same fix could be applied.\nNevertheless the unit test is no more relevant.\nI'll try to work on that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"created":"2013-03-08T09:47:58.250+0000","updated":"2013-03-08T09:47:58.250+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13598293","id":"13598293","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12572967/ZOOKEEPER-1382.patch\n  against trunk revision 1453693.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1427//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1427//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1427//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-03-10T15:52:43.322+0000","updated":"2013-03-10T15:52:43.322+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13598296","id":"13598296","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"body":"testTransactionLogCorruption fails, not sure if is related to the patch or if it's because of ZOOKEEPER-1629","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barkbay","name":"barkbay","key":"barkbay","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=barkbay&avatarId=17145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=barkbay&avatarId=17145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=barkbay&avatarId=17145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=barkbay&avatarId=17145"},"displayName":"Michael Morello","active":true,"timeZone":"Europe/Paris"},"created":"2013-03-10T15:59:08.102+0000","updated":"2013-03-10T15:59:08.102+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13598458","id":"13598458","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"I can't even get the TruncateCorruptionTest to run to completion or failure at all with or without this patch. I think we need to open a separate bug report on it. Besides that, this fix looks good to me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2013-03-11T01:03:18.812+0000","updated":"2013-03-11T01:03:18.812+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13598463","id":"13598463","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"I've opened a bug for this some time ago: ZOOKEEPER-1629 perhaps we should disable this test for now ? for example, if one of the Java tests fails, the C tests don't run at all.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-03-11T01:16:00.830+0000","updated":"2013-10-08T16:41:44.472+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13753571","id":"13753571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"The fix looks good to me overall, I just have a couple of comments:\n\n# Some classes have been made public for testing. Could we use mock classes instead (classes that extend the target ZK classes)?\n# We don't really name the test classes after the jiras that originated them. Could we use a more expressive name here?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-08-29T12:42:13.246+0000","updated":"2013-08-29T12:42:13.246+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13777620","id":"13777620","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"I would like to propose to skip the tests cases for this JIRA.\nThe modification required is minimal and it seems clearly correct. However, trying to build a test that works and that doesn't require future maintenance seems to be very complex.\nI have done the mock classes as suggested by Flavio above, but the tests don't work any more (at least in trunk). My guess is that it is because of latest changes in the code. I don't see an easy fix (at least easy for me), and what is worse, it seems to me that these test cases will require review very often, since they depend very deeply on how things are implemented.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-09-25T15:34:06.950+0000","updated":"2013-09-25T15:34:06.950+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13788048","id":"13788048","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=antoniomau001","name":"antoniomau001","key":"antoniomau001","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antonio","active":true,"timeZone":"Etc/UTC"},"body":"Hi, is ZooKeeper 3.4.3 affected by this bug?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=antoniomau001","name":"antoniomau001","key":"antoniomau001","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antonio","active":true,"timeZone":"Etc/UTC"},"created":"2013-10-07T10:22:35.838+0000","updated":"2013-10-07T10:22:35.838+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13788227","id":"13788227","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"Yes","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-07T15:34:24.162+0000","updated":"2013-10-07T15:34:24.162+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13801426","id":"13801426","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"No luck with the previous lazy proposal, so I think this is it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-22T02:26:39.406+0000","updated":"2013-10-22T02:26:39.406+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13801438","id":"13801438","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12609581/ZOOKEEPER-1382.patch\n  against trunk revision 1534390.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 12 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1714//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1714//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1714//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-10-22T03:05:10.737+0000","updated":"2013-10-22T03:05:10.737+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13804293","id":"13804293","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Given that the Mock* classes are only used in WatchLeakTest, I was wondering if it wouldn't be best to have them defined inside the WatchLeakTest class. \n\nAlso, there is a test case not running because @Test is commented out.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-24T15:09:43.144+0000","updated":"2013-10-24T15:09:43.144+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13804987","id":"13804987","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"At some point I commented that out. I thought that the test case didn't make much sense since it was passing both with and without the change. It is also not there in the 3.4 version. But this was hiding an error in the test cases.\nNow it is fixed. \nI had to make a small modification in NIOServerCnxn.java in order to allow the test to work. SocketChannel.isOpen is a final method and can't be mocked by Mockito.\nThe Mock classes can't be moved to a different package. Otherwise they don't have access to the protected elements in that package any more. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-25T03:55:16.879+0000","updated":"2013-10-25T03:55:16.879+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13805018","id":"13805018","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12610262/ZOOKEEPER-1382.patch\n  against trunk revision 1535491.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 12 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1722//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1722//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1722//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-10-25T04:35:47.646+0000","updated":"2013-10-25T04:35:47.646+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13814641","id":"13814641","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"I wouldn't recommend to run zookeeper using ramdisk without having an additional method that ensures consistency. Ramdisk means data is not persistent after a reboot, and this JIRA shows that losing data in one node when the quorum was in minority may lead to permanent inconsistencies in the quorum.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-06T06:05:49.559+0000","updated":"2013-11-06T06:05:49.559+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13814672","id":"13814672","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"Added a review request for this [https://reviews.apache.org/r/15259/]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-06T07:06:05.031+0000","updated":"2013-11-06T07:06:05.031+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13815835","id":"13815835","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"spaces and style changes","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-07T10:46:49.704+0000","updated":"2013-11-07T10:46:49.704+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13815855","id":"13815855","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12612572/ZOOKEEPER-1382.patch\n  against trunk revision 1539529.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 12 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1747//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1747//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1747//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-07T11:24:17.880+0000","updated":"2013-11-07T11:24:17.880+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13821233","id":"13821233","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"I forgot to thank [~rgs] for reviewing the patch. ... dicen que m√°s vale tarde que nunca.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-13T11:29:39.060+0000","updated":"2013-11-13T11:29:39.060+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13832637","id":"13832637","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"[~fpj], could you please take a look at this and say if it is ok now?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-26T15:02:41.774+0000","updated":"2013-11-26T15:02:41.774+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13838906","id":"13838906","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi German, \nPatch looks very nice, especially test cases are really good:)\n\nAdd few suggestions:\n- Please add message while asserting, this will give more clarity, like\n{code}\nassertEquals(\"There must be NO watches!\", 0, watchCount);\n{code}\n- Formatting is not proper in MockSelectorThread.java. Normally, between methods there will be a newline.\n- This is a suggestion and FYI. I would like to use @RunWith(Parameterized.class), when there are situations to run the same test case with different input values. In the patch, we have testcases with sessiontimeout and without sessiontimeout flags. Please refer MultiTransactionTest to understand more on this pattern. This way it will again make the test cases very simple.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2013-12-04T14:00:34.908+0000","updated":"2013-12-04T14:00:34.908+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13839019","id":"13839019","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"Thank you [~rakeshr], but the test cases are originally from someone else, [~barkbay] I believe. And I agree, it seems very difficult to come up with a way to test this and he has done a good job.\nAnd thank you for the suggestions, I will try to take care of them in a few days and propose a new patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-04T15:55:56.109+0000","updated":"2013-12-04T15:55:56.109+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13840979","id":"13840979","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"Updated with last comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-06T04:51:42.617+0000","updated":"2013-12-06T04:51:42.617+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13841000","id":"13841000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12617336/ZOOKEEPER-1382.patch\n  against trunk revision 1547702.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 12 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1818//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1818//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1818//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-12-06T05:36:11.909+0000","updated":"2013-12-06T05:36:11.909+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13845600","id":"13845600","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Pretty sweet tests. I think this looks good on trunk, will check it in.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2013-12-11T18:18:41.014+0000","updated":"2013-12-11T18:18:41.014+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13845607","id":"13845607","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Looks good on 3.4 as well, will close this as soon as builds complete successfully. Thanks to all who helped with this!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2013-12-11T18:32:10.900+0000","updated":"2013-12-11T18:32:10.900+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13845636","id":"13845636","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in ZooKeeper-trunk #2150 (See [https://builds.apache.org/job/ZooKeeper-trunk/2150/])\nZOOKEEPER-1382. Zookeeper server holds onto dead/expired session ids in the watch data structures\n  (Germ√°n Blanco and Michael Morello via camille) (camille: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1550213)\n* /zookeeper/trunk/CHANGES.txt\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java\n* /zookeeper/trunk/src/java/test/org/apache/zookeeper/MockPacket.java\n* /zookeeper/trunk/src/java/test/org/apache/zookeeper/server/MockNIOServerCnxn.java\n* /zookeeper/trunk/src/java/test/org/apache/zookeeper/server/MockSelectorThread.java\n* /zookeeper/trunk/src/java/test/org/apache/zookeeper/server/quorum/WatchLeakTest.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2013-12-11T19:00:31.840+0000","updated":"2013-12-11T19:00:31.840+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13846547","id":"13846547","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"Thank you [~fournc]!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germ√°n Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-12T18:17:40.878+0000","updated":"2013-12-12T18:17:40.878+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/13933708","id":"13933708","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Closing issues after releasing 3.4.6.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2014-03-13T18:16:56.122+0000","updated":"2014-03-13T18:16:56.122+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12540477/comment/15574315","id":"15574315","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=guoping.gp","name":"guoping.gp","key":"guoping.gp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"guoping.gp","active":true,"timeZone":"Etc/UTC"},"body":"the same issue is still can be found on 3.4.6, https://issues.apache.org/jira/browse/ZOOKEEPER-2615.\n\nwhen the client app reconnect to a server, the setWatchs and close still stay in the race condition as following possible:\n\nDaemon Thread [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:6181] (Suspended (breakpoint at line 966 in NIOServerCnxn))\t\nNIOServerCnxn.close() line: 966\t\nNIOServerCnxn.doIO(SelectionKey) line: 360\t\nNIOServerCnxnFactory.run() line: 208\t\nThread.run() line: 745\n\nand then\n\nThread [CommitProcessor:1] (Suspended (breakpoint at line 303 in FinalRequestProcessor))\t\nFinalRequestProcessor.processRequest(Request) line: 303\t\nCommitProcessor.run() line: 74\n\nthe issue cause our production leak about 1 million watchs","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=guoping.gp","name":"guoping.gp","key":"guoping.gp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"guoping.gp","active":true,"timeZone":"Etc/UTC"},"created":"2016-10-14T05:46:57.302+0000","updated":"2016-10-14T05:47:47.372+0000"}],"maxResults":44,"total":44,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1382/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05xun:"}}