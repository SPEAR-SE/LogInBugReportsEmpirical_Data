{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12964315","self":"https://issues.apache.org/jira/rest/api/2/issue/12964315","key":"ZOOKEEPER-2421","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-05-26T04:04:52.515+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 12 04:43:33 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2421/watchers","watchCount":8,"isWatching":false},"created":"2016-05-02T14:56:30.743+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12536241","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12536241","type":{"id":"12310560","name":"Problem/Incident","inward":"is caused by","outward":"causes","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310560"},"inwardIssue":{"id":"12401819","key":"ZOOKEEPER-111","self":"https://issues.apache.org/jira/rest/api/2/issue/12401819","fields":{"summary":"significant cleanup of existing tests","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanthm","name":"prasanthm","key":"prasanthm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Mathialagan","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-06-12T04:43:59.563+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"This test case in SessionTest:\n{noformat}\n   testSessionReuse\n{noformat}\nis commented out.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"testSessionReuse is commented out","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964315/comment/16491500","id":"16491500","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanthm","name":"prasanthm","key":"prasanthm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Mathialagan","active":true,"timeZone":"America/Los_Angeles"},"body":"I just want to make sure I understood correctly what this test case is testing\r\n\r\nCreate a zk client and close it. Create second zk client using the same session id and password from the first client. Assert that the session id in the second client is same as the session id we used for creating the client.\r\n\r\nI have some questions. If we close a client, won't the session be expired by the server? I see some logs indicating this,\r\n{code:java}\r\n2018-05-25 20:54:55,424 [myid:] - DEBUG [SyncThread:0:SessionTrackerImpl@218] - Removing session 0x1000169b7970000\r\n2018-05-25 20:54:55,424 [myid:] - TRACE [SyncThread:0:ZooTrace@71] - SessionTrackerImpl --- Removing session 0x1000169b7970000\r\n{code}\r\nWhen the second client tries to connect using the same session id,\r\n{code:java}\r\n2018-05-25 20:54:55,431 [myid:] - INFO  [NIOWorkerThread-6:ZooKeeperServer@1040] - Client attempting to renew session 0x1000169b7970000 at /127.0.0.1:60428\r\n2018-05-25 20:54:55,431 [myid:] - TRACE [NIOWorkerThread-6:ZooTrace@71] - Session 0x1000169b7970000 is valid: false\r\n2018-05-25 20:54:55,431 [myid:] - TRACE [NIOWorkerThread-6:NIOServerCnxn@156] - Add a buffer to outgoingBuffers, sk sun.nio.ch.SelectionKeyImpl@5be8980 is valid: true\r\n2018-05-25 20:54:55,431 [myid:] - INFO  [NIOWorkerThread-6:ZooKeeperServer@750] - Invalid session 0x1000169b7970000 for client /127.0.0.1:60428, probably expired\r\n2018-05-25 20:54:55,431 [myid:] - TRACE [NIOWorkerThread-6:NIOServerCnxn@156] - Add a buffer to outgoingBuffers, sk sun.nio.ch.SelectionKeyImpl@5be8980 is valid: true\r\n2018-05-25 20:54:55,432 [myid:] - INFO  [NIOWorkerThread-7:NIOServerCnxn@627] - Closed socket connection for client /127.0.0.1:60428 which had sessionid 0x1000169b7970000\r\n{code}\r\nserver finds the session as invalid and closes the connection to the new client abruptly.\r\n\r\nIs this the expected behavior? If so, then the test must be doing wrong assertion, right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanthm","name":"prasanthm","key":"prasanthm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Mathialagan","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-05-26T04:04:52.515+0000","updated":"2018-05-26T04:04:52.515+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964315/comment/16506590","id":"16506590","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanthm","name":"prasanthm","key":"prasanthm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Mathialagan","active":true,"timeZone":"America/Los_Angeles"},"body":"Does anyone have any pointers to help me?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prasanthm","name":"prasanthm","key":"prasanthm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prasanth Mathialagan","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-08T21:34:03.827+0000","updated":"2018-06-08T21:34:03.827+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964315/comment/16507670","id":"16507670","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"body":"[~prasanthm] This is an ancient test so someone who was involved in the project pre-2008 may have to provide some context around it and it's purpose. That's not me but I can say a bit after looking at the SessionTest file.\r\n\r\nSession id reuse as such is not allowed in current ZooKeeper. There are two ways that this test could now go. One is to make sure that the second client can *not* use that session id, that there is no state retained server-side that allows a reuse after close. The second is to change it to a session moved style test but I think this scenario is already covered in testSession and testSessionMove.\r\n\r\nIf you don't see a useful way of reintroducing the test after a bit of poking, I'd say to put up a pull request removing it entirely and see if it gets accepted - it simply may no longer be meaningful.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"created":"2018-06-11T04:43:31.530+0000","updated":"2018-06-11T04:43:31.530+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964315/comment/16509180","id":"16509180","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"{quote}If we close a client, won't the session be expired by the server\r\n{quote}\r\nThis is correct. \r\n{quote}If so, then the test must be doing wrong assertion, right?\r\n{quote}\r\nYes, that test was not correct in today's ZooKeeper, because close() a zk handle will expire the session. My guess is when the test was written, the semantic of zk.close is a soft close where the client was only disconnected from server instead of doing a hard close where the session will be expired. My another guess is this testSessionReuse case was trying to cover the case where a client application crashes (soft close) and then restarts, and then it should try use the old session to reconnect to server. If that's the purpose, then as Brian pointed out, the testSession should cover this case. \r\n\r\nSo it sounds good to me to just remove this test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2018-06-12T04:41:31.594+0000","updated":"2018-06-12T04:41:31.594+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964315/comment/16509181","id":"16509181","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"A side note is the test was commented out as part of ZOOKEEPER-111. In case someone is interested to dig the history from 10 years back :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2018-06-12T04:43:33.078+0000","updated":"2018-06-12T04:43:33.078+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2421/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2x1lr:"}}