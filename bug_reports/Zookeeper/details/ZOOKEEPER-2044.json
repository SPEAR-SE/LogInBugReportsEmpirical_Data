{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12743135","self":"https://issues.apache.org/jira/rest/api/2/issue/12743135","key":"ZOOKEEPER-2044","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338036","id":"12338036","description":"Fix release against 3.4 branch","name":"3.4.10","archived":false,"released":true,"releaseDate":"2017-03-30"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-10-12T13:53:33.069+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sun Feb 05 06:01:29 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_2_*:*_37722294388_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_2_*:*_36777503941","customfield_12312321":null,"resolutiondate":"2017-01-31T16:40:19.460+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2044/watchers","watchCount":20,"isWatching":false},"created":"2014-09-22T10:17:01.215+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"}],"issuelinks":[{"id":"12492165","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12492165","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12527972","key":"ZOOKEEPER-1237","self":"https://issues.apache.org/jira/rest/api/2/issue/12527972","fields":{"summary":"ERRORs being logged when queued responses are sent after socket has closed.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12493085","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12493085","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13038033","key":"ZOOKEEPER-2677","self":"https://issues.apache.org/jira/rest/api/2/issue/13038033","fields":{"summary":"Verify the occurrence of CancelledKeyException in zookeeper branch-3.5 and above","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/3","id":"3","description":"A task that needs to be done.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21148&avatarType=issuetype","name":"Task","subtask":false,"avatarId":21148}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-31T00:14:58.319+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"I am getting cancelled key exception in zookeeper (version 3.4.5). Please see the log below. When this error is thrown, the connected solr shard is going down by giving the error \"Failed to index metadata in Solr,StackTrace=SolrError: HTTP status 503.Reason: {\"responseHeader\":{\"status\":503,\"QTime\":204},\"error\":{\"msg\":\"ClusterState says we are the leader, but locally we don't think so\",\"code\":503\"  and ultimately the current activity is going down. Could you please give a solution for this ?\n\n\nZookeper log \n----------------------------------------------------------\n2014-09-16 02:58:47,799 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:ZooKeeperServer@832] - Client attempting to renew session 0x24868e7ca980003 at /172.22.0.5:58587\n2014-09-16 02:58:47,800 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:Learner@107] - Revalidating client: 0x24868e7ca980003\n2014-09-16 02:58:47,802 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:ZooKeeperServer@588] - Invalid session 0x24868e7ca980003 for client /172.22.0.5:58587, probably expired\n2014-09-16 02:58:47,803 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1001] - Closed socket connection for client /172.22.0.5:58587 which had sessionid 0x24868e7ca980003\n2014-09-16 02:58:47,810 [myid:1] - ERROR [CommitProcessor:1:NIOServerCnxn@180] - Unexpected Exception:\njava.nio.channels.CancelledKeyException\n        at sun.nio.ch.SelectionKeyImpl.ensureValid(SelectionKeyImpl.java:55)\n        at sun.nio.ch.SelectionKeyImpl.interestOps(SelectionKeyImpl.java:59)\n        at org.apache.zookeeper.server.NIOServerCnxn.sendBuffer(NIOServerCnxn.java:153)\n        at org.apache.zookeeper.server.NIOServerCnxn.sendResponse(NIOServerCnxn.java:1076)\n        at org.apache.zookeeper.server.NIOServerCnxn.process(NIOServerCnxn.java:1113)\n        at org.apache.zookeeper.server.DataTree.setWatches(DataTree.java:1327)\n        at org.apache.zookeeper.server.ZKDatabase.setWatches(ZKDatabase.java:384)\n        at org.apache.zookeeper.server.FinalRequestProcessor.processRequest(FinalRequestProcessor.java:304)\n        at org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:74)\n\n\n ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12791627","id":"12791627","filename":"ZOOKEEPER-2044.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-03-05T16:34:50.466+0000","size":5782,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12791627/ZOOKEEPER-2044.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12774760","id":"12774760","filename":"ZOOKEEPER-2044.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2015-11-29T22:53:41.578+0000","size":832,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12774760/ZOOKEEPER-2044.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"CancelledKeyException in zookeeper branch-3.4","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shamjith.antholi","name":"shamjith.antholi","key":"shamjith.antholi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"shamjith antholi","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shamjith.antholi","name":"shamjith.antholi","key":"shamjith.antholi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"shamjith antholi","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Red Hat Enterprise Linux Server release 6.2","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/14953141","id":"14953141","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sumit.nigam","name":"sumit.nigam","key":"sumit.nigam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sumit Nigam","active":true,"timeZone":"Asia/Kolkata"},"body":"i am noticing similar issues in my set up where YARN Resource Mgr and HDFS Name Node HA components failover due to ZooKeeper exception stated above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sumit.nigam","name":"sumit.nigam","key":"sumit.nigam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sumit Nigam","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-10-12T13:53:33.069+0000","updated":"2015-10-12T13:53:33.069+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15024611","id":"15024611","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"This is also visible in 3.4.6.\nThe fix seems quite straightforward. In NIOServerCnxn.java there seems to be a missing \"sk.isValid()\" before \"sk.interestOps()\":\n{code:title=NIOServerCnxn.java|borderStyle=solid}\n          if (bb != ServerCnxnFactory.closeConn) {\n                 // We check if write interest here because if it is NOT set,\n                 // nothing is queued, so we can try to send the buffer right\n                 // away without waking up the selector\n                 if ((sk.interestOps() & SelectionKey.OP_WRITE) == 0) { // <= SHOULD BE HERE\n                    try \\{\n                        sock.write(bb);\n                     } catch (IOException e) {\n                         // we are just doing best effort right now\n                     }\n                 }\n                 // if there is nothing left to send, we are done\n                 if (bb.remaining() == 0) {\n                     packetSent();\n                     return;\n                 }\n             }\n \n             synchronized(this.factory){\n                 sk.selector().wakeup();\n                 if (LOG.isTraceEnabled()) {\n                     LOG.trace(\"Add a buffer to outgoingBuffers, sk \" + sk\n                             + \" is valid: \" + sk.isValid());\n                 }\n                 outgoingBuffers.add(bb);\n                 if (sk.isValid()) {// <= AS IT IS IN HERE\n                     sk.interestOps(sk.interestOps() | SelectionKey.OP_WRITE);\n                 }\n             }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2015-11-24T14:41:09.230+0000","updated":"2015-11-24T14:41:09.230+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15024616","id":"15024616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"I am changing this issue to minor since it seems to happen when the client closes the socket at a certain point of time. It is more of a false reporting of an error than a problem in the server.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2015-11-24T14:46:55.703+0000","updated":"2015-11-24T14:46:55.703+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15031195","id":"15031195","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"In order to reproduce this problem, I inserted a \"Thread.sleep(100)\" in the line just before the one that needs to be modified. Otherwise, I just didn't get this error.\nWith that line modified, the problem was solved even with the delay.\nI have no idea of how to make a test case for this problem, so I will just submit the extremely simple patch without a test case.\nIf anybody wants to reproduce the problem, I created a program that watches in a znode (receives any event and then subscribes again), and a program that writes continuously in that znode. The error occurs when the program that watches is killed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2015-11-29T22:23:29.830+0000","updated":"2015-11-29T22:23:29.830+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15031201","id":"15031201","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"The patch is for branch-3.4. It does not apply to trunk correctly.\nThis problem doesn't seem to be present in trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2015-11-29T22:53:41.606+0000","updated":"2015-11-29T22:53:41.606+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15031204","id":"15031204","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12774760/ZOOKEEPER-2044.patch\n  against trunk revision 1715590.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2968//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2015-11-29T23:00:02.560+0000","updated":"2015-11-29T23:00:02.560+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15135491","id":"15135491","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"[~abranzyck] - thanks for the patch and sorry for the lack of review. Given we are running late with 3.4.8, lets get to this in 3.4.9. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-02-06T02:45:06.496+0000","updated":"2016-02-06T02:45:06.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15181768","id":"15181768","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Here is a patch with a test case. [~abranzyck] [~rgs] Let me know what you think.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-03-05T16:34:50.474+0000","updated":"2016-03-05T16:34:50.474+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15185520","id":"15185520","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12791627/ZOOKEEPER-2044.patch\n  against trunk revision 1733679.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3092//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-03-08T19:02:52.868+0000","updated":"2016-03-08T19:02:52.868+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15188397","id":"15188397","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"I get bugged about this issue quite a bit, but it's really just cosmetic. Are you sure the risk outweighs the reward wrt 3.4, vs fixing in 3.5/trunk only?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-03-10T00:43:05.824+0000","updated":"2016-03-10T00:43:05.824+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15192369","id":"15192369","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"The patch works perfectly for me. Thank you for requesting my opinion.\nIn my personal opinion, the risk is very low and confusing messages in the logs will be disturbing for system administrators. But as stated, is not a big issue.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2016-03-13T14:37:30.103+0000","updated":"2016-03-13T14:37:30.103+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15192378","id":"15192378","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I think it is very low risk, but I also don't think it is strictly necessary to have it in 3.4. If you're uneasy about having this one in 3.4 because it is mostly an improvement, I won't oppose [~phunt].\n  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-03-13T15:02:03.842+0000","updated":"2016-03-13T15:02:03.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15192575","id":"15192575","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm not saying I'm against it per se. I agree it is a bug. I just want to make sure you folks feel strongly that the risk/reward is there. :-) \n\nGiven the feedback I don't see why we shouldn't include it. Up to you all.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-03-13T23:49:52.945+0000","updated":"2016-03-13T23:49:52.945+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15341497","id":"15341497","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ericzundel","name":"ericzundel","key":"ericzundel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Ayers","active":true,"timeZone":"America/New_York"},"body":"Having been woken up for this and finding its a false alarm, I'd like to see it in 3.4.x branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ericzundel","name":"ericzundel","key":"ericzundel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Ayers","active":true,"timeZone":"America/New_York"},"created":"2016-06-21T10:11:04.814+0000","updated":"2016-06-21T10:11:04.814+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15341514","id":"15341514","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12791627/ZOOKEEPER-2044.patch\n  against trunk revision 1748630.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3195//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-21T10:19:23.904+0000","updated":"2016-06-21T10:19:23.904+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15766536","id":"15766536","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=DEvil0000","name":"DEvil0000","key":"devil0000","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Binzberger","active":true,"timeZone":"Europe/Berlin"},"body":"looks similar to ZOOKEEPER-1237 - could this be the same thing?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=DEvil0000","name":"DEvil0000","key":"devil0000","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Binzberger","active":true,"timeZone":"Europe/Berlin"},"created":"2016-12-21T09:08:19.166+0000","updated":"2016-12-21T09:08:19.166+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15766562","id":"15766562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12791627/ZOOKEEPER-2044.patch\n  against trunk revision 8616a9ec8ce4bc8ac2987b7417a6f0c4b7333658.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3551//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-21T09:19:15.241+0000","updated":"2016-12-21T09:19:15.241+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15836893","id":"15836893","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"This patch does not apply to master / 3.5 - due to work in ZOOKEEPER-1504. Not sure if master / 3.5 is impacted by this issue. I'll see if I can take a stab and reproduce on master / 3.5 and provide a rebased patch.\n\nIn any case, should we get this in before cutting a 3.4.10 RC build? This seems to be a low risk and high impact fix (we've seen this a lot in our 3.4.x product env too) / cc [~rakeshr].","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-01-25T00:04:55.161+0000","updated":"2017-01-25T00:04:55.161+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15837153","id":"15837153","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"[~hanm], Agreed to include this, considering that, its a long waited issue and I also feel its a low risk fix.\nCould you please create a pull request for the same. I hope folks will help in reviews and push asap. Thanks!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-01-25T04:09:35.767+0000","updated":"2017-01-25T04:09:35.767+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15837183","id":"15837183","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user hanm opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/156\n\n    ZOOKEEPER-2044:CancelledKeyException in zookeeper 3.4.5.\n\n    Patch from Germán Blanco, test case from Flavio.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/hanm/zookeeper ZOOKEEPER-2044\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/156.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #156\n    \n----\ncommit a220d95f2aefd0bf6f72d2757a87dc5480f9891e\nAuthor: Michael Han <hanm@apache.org>\nDate:   2017-01-25T04:35:05Z\n\n    ZOOKEEPER-2044:CancelledKeyException in zookeeper 3.4.5.\n    Patch from Germán Blanco, test case from Flavio.\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-25T04:36:39.550+0000","updated":"2017-01-25T04:36:39.550+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15837275","id":"15837275","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/156#discussion_r97716727\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NIOServerCnxnTest.java ---\n    @@ -18,6 +18,12 @@\n     package org.apache.zookeeper.server;\n     \n     import java.io.IOException;\n    +import java.nio.ByteBuffer;\n    +import java.nio.channels.CancelledKeyException;\n    +import java.nio.channels.SelectionKey;\n    --- End diff --\n    \n    Please remove unused imports.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-25T06:41:20.942+0000","updated":"2017-01-25T06:41:20.942+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15837276","id":"15837276","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/156#discussion_r97716640\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NIOServerCnxnTest.java ---\n    @@ -68,4 +74,38 @@ public void testOperationsAfterCnxnClose() throws IOException,\n                 zk.close();\n             }\n         }\n    +\n    +    /**\n    +     * Mock extension of NIOServerCnxn to test for\n    +     * CancelledKeyException (ZOOKEEPER-2044).\n    +     */\n    +    class MockNIOServerCnxn extends NIOServerCnxn {\n    +        public MockNIOServerCnxn( NIOServerCnxn cnxn )\n    +                throws IOException {\n    +            super( cnxn.zkServer, cnxn.sock, cnxn.sk, cnxn.factory );\n    +        }\n    +\n    +        public void mockSendBuffer(ByteBuffer bb) throws Exception {\n    +            super.internalSendBuffer( bb );\n    +        }\n    +    }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testValidSelectionKey() throws Exception {\n    +        final ZooKeeper zk = createClient();\n    +        try {\n    +            Iterable<ServerCnxn> connections = serverFactory.getConnections();\n    +            for (ServerCnxn serverCnxn : connections) {\n    +                MockNIOServerCnxn mock = new MockNIOServerCnxn((NIOServerCnxn) serverCnxn);\n    +                // Cancel key\n    +                ((NIOServerCnxn) serverCnxn).sock.keyFor(((NIOServerCnxnFactory) serverFactory).selector).cancel();;\n    +                mock.mockSendBuffer( ByteBuffer.allocate(8) );\n    +            }\n    +        } catch (CancelledKeyException e) {\n    +            e.printStackTrace();\n    --- End diff --\n    \n    Instead of printStackTrace, can we use LOG.error(\"Exception while sending bytes!\", e);\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-25T06:41:21.251+0000","updated":"2017-01-25T06:41:21.251+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15837277","id":"15837277","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/156#discussion_r97717262\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NIOServerCnxnTest.java ---\n    @@ -68,4 +74,38 @@ public void testOperationsAfterCnxnClose() throws IOException,\n                 zk.close();\n             }\n         }\n    +\n    +    /**\n    +     * Mock extension of NIOServerCnxn to test for\n    +     * CancelledKeyException (ZOOKEEPER-2044).\n    +     */\n    +    class MockNIOServerCnxn extends NIOServerCnxn {\n    +        public MockNIOServerCnxn( NIOServerCnxn cnxn )\n    +                throws IOException {\n    +            super( cnxn.zkServer, cnxn.sock, cnxn.sk, cnxn.factory );\n    --- End diff --\n    \n    This line has extra spaces and I could see formatting issues in many places. Please remove unwanted spaces and correct it.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-25T06:41:21.324+0000","updated":"2017-01-25T06:41:21.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15837278","id":"15837278","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/156#discussion_r97716986\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NIOServerCnxnTest.java ---\n    @@ -68,4 +74,38 @@ public void testOperationsAfterCnxnClose() throws IOException,\n                 zk.close();\n             }\n         }\n    +\n    +    /**\n    +     * Mock extension of NIOServerCnxn to test for\n    +     * CancelledKeyException (ZOOKEEPER-2044).\n    +     */\n    +    class MockNIOServerCnxn extends NIOServerCnxn {\n    --- End diff --\n    \n    Please make MockNIOServerCnxn class ''private static''\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-25T06:41:21.399+0000","updated":"2017-01-25T06:41:21.399+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15837978","id":"15837978","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"bq. This patch does not apply to master / 3.5 - due to work in ZOOKEEPER-1504. Not sure if master / 3.5 is impacted by this issue. I'll see if I can take a stab and reproduce on master / 3.5 and provide a rebased patch.\n[~hanm], How about creating a separate jira task to do the analysis and fix, if requires. This jira can be used to push code changes only to {{branch-3.4}}, right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-01-25T16:04:03.195+0000","updated":"2017-01-25T16:04:03.195+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15839045","id":"15839045","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/156\n  \n    @rakeshadr thanks for review, patch updated. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-26T02:13:27.785+0000","updated":"2017-01-26T02:13:27.785+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15839311","id":"15839311","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/156#discussion_r97935895\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NIOServerCnxnTest.java ---\n    @@ -68,4 +69,38 @@ public void testOperationsAfterCnxnClose() throws IOException,\n                 zk.close();\n             }\n         }\n    +\n    +    /**\n    +     * Mock extension of NIOServerCnxn to test for\n    +     * CancelledKeyException (ZOOKEEPER-2044).\n    +     */\n    +    private static class MockNIOServerCnxn extends NIOServerCnxn {\n    +        public MockNIOServerCnxn(NIOServerCnxn cnxn)\n    +                throws IOException {\n    +            super(cnxn.zkServer, cnxn.sock, cnxn.sk, cnxn.factory);\n    +        }\n    +\n    +        public void mockSendBuffer(ByteBuffer bb) throws Exception {\n    +            super.internalSendBuffer(bb);\n    +        }\n    +    }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testValidSelectionKey() throws Exception {\n    +        final ZooKeeper zk = createClient();\n    +        try {\n    +            Iterable<ServerCnxn> connections = serverFactory.getConnections();\n    +            for (ServerCnxn serverCnxn : connections) {\n    +                MockNIOServerCnxn mock = new MockNIOServerCnxn((NIOServerCnxn) serverCnxn);\n    +                // Cancel key\n    +                ((NIOServerCnxn) serverCnxn).sock.keyFor(((NIOServerCnxnFactory) serverFactory).selector).cancel();;\n    +                mock.mockSendBuffer(ByteBuffer.allocate(8));\n    +            }\n    +        } catch (CancelledKeyException e) {\n    +            LOG.error(\"Exception while sending bytes!\", e);\n    +            Assert.fail(e.toString());\n    +        } finally {\n    +            zk.close();\n    --- End diff --\n    \n    Thanks @hanm , the latest changes looks good to me. I will leave this pull request for one more day and if there is no more comments then will commit this tomorrow.\n    \n    I've an observation while running the unit test case, \"zk.close()\" call is taking 15-20secs to complete. I think, this delay is due to the previously submitted mocked buffer. Could you please run test in your env and let me know your observation.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-26T06:10:42.908+0000","updated":"2017-01-26T06:10:42.908+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15839323","id":"15839323","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"bq. This patch does not apply to master / 3.5 - due to work in ZOOKEEPER-1504. Not sure if master / 3.5 is impacted by this issue. I'll see if I can take a stab and reproduce on master / 3.5 and provide a rebased patch.\n[~hanm], I've raised separate jira task ZOOKEEPER-2677 to do the analysis in branch-3.5 and master. For now, I've assigned the ZOOKEEPER-2677 jira to you. Please feel free to re-assign. Thanks!\n\nIMHO, this jira can be used to push code changes only in {{branch-3.4}} as I hope we all agree on the fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-01-26T06:23:36.070+0000","updated":"2017-01-26T06:23:36.070+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15840707","id":"15840707","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/156#discussion_r98120457\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NIOServerCnxnTest.java ---\n    @@ -68,4 +69,38 @@ public void testOperationsAfterCnxnClose() throws IOException,\n                 zk.close();\n             }\n         }\n    +\n    +    /**\n    +     * Mock extension of NIOServerCnxn to test for\n    +     * CancelledKeyException (ZOOKEEPER-2044).\n    +     */\n    +    private static class MockNIOServerCnxn extends NIOServerCnxn {\n    +        public MockNIOServerCnxn(NIOServerCnxn cnxn)\n    +                throws IOException {\n    +            super(cnxn.zkServer, cnxn.sock, cnxn.sk, cnxn.factory);\n    +        }\n    +\n    +        public void mockSendBuffer(ByteBuffer bb) throws Exception {\n    +            super.internalSendBuffer(bb);\n    +        }\n    +    }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testValidSelectionKey() throws Exception {\n    +        final ZooKeeper zk = createClient();\n    +        try {\n    +            Iterable<ServerCnxn> connections = serverFactory.getConnections();\n    +            for (ServerCnxn serverCnxn : connections) {\n    +                MockNIOServerCnxn mock = new MockNIOServerCnxn((NIOServerCnxn) serverCnxn);\n    +                // Cancel key\n    +                ((NIOServerCnxn) serverCnxn).sock.keyFor(((NIOServerCnxnFactory) serverFactory).selector).cancel();;\n    +                mock.mockSendBuffer(ByteBuffer.allocate(8));\n    +            }\n    +        } catch (CancelledKeyException e) {\n    +            LOG.error(\"Exception while sending bytes!\", e);\n    +            Assert.fail(e.toString());\n    +        } finally {\n    +            zk.close();\n    --- End diff --\n    \n    @rakeshadr Good observation on the long running of the test. This is definitely something we should fix. The actual delay indeed happens at client close and the root cause is session timeout: when a client closing itself it sends a request to server, and this request packet will stuck forever in our case because server has canceled the selector; so client session will expire eventually and by default, the timeout value between client / server is set as 30 sec and 2/3 about it - which is 20 sec is exactly what it would cost for a heart beat to fail. I fixed this by adjusting the timeout value to 3 sec instead just for this single test. PTAL.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-26T23:57:55.249+0000","updated":"2017-01-26T23:57:55.249+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15841038","id":"15841038","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/156#discussion_r98146418\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NIOServerCnxnTest.java ---\n    @@ -68,4 +69,41 @@ public void testOperationsAfterCnxnClose() throws IOException,\n                 zk.close();\n             }\n         }\n    +\n    +    /**\n    +     * Mock extension of NIOServerCnxn to test for\n    +     * CancelledKeyException (ZOOKEEPER-2044).\n    +     */\n    +    private static class MockNIOServerCnxn extends NIOServerCnxn {\n    +        public MockNIOServerCnxn(NIOServerCnxn cnxn)\n    +                throws IOException {\n    +            super(cnxn.zkServer, cnxn.sock, cnxn.sk, cnxn.factory);\n    +        }\n    +\n    +        public void mockSendBuffer(ByteBuffer bb) throws Exception {\n    +            super.internalSendBuffer(bb);\n    +        }\n    +    }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testValidSelectionKey() throws Exception {\n    +        int oldTimeout = ClientBase.CONNECTION_TIMEOUT;\n    +        ClientBase.CONNECTION_TIMEOUT = 3000;\n    +        final ZooKeeper zk = createClient();\n    --- End diff --\n    \n    Thanks @hanm for the analysis and fixing it. Instead of directly changing the static value, how about simplifying the ZooKeeper client creation like below,\n    \n    ``final ZooKeeper zk = createZKClient(hostPort, 3000);``\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-27T05:26:29.986+0000","updated":"2017-01-27T05:26:29.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15843117","id":"15843117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/156#discussion_r98244348\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NIOServerCnxnTest.java ---\n    @@ -68,4 +69,41 @@ public void testOperationsAfterCnxnClose() throws IOException,\n                 zk.close();\n             }\n         }\n    +\n    +    /**\n    +     * Mock extension of NIOServerCnxn to test for\n    +     * CancelledKeyException (ZOOKEEPER-2044).\n    +     */\n    +    private static class MockNIOServerCnxn extends NIOServerCnxn {\n    +        public MockNIOServerCnxn(NIOServerCnxn cnxn)\n    +                throws IOException {\n    +            super(cnxn.zkServer, cnxn.sock, cnxn.sk, cnxn.factory);\n    +        }\n    +\n    +        public void mockSendBuffer(ByteBuffer bb) throws Exception {\n    +            super.internalSendBuffer(bb);\n    +        }\n    +    }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testValidSelectionKey() throws Exception {\n    +        int oldTimeout = ClientBase.CONNECTION_TIMEOUT;\n    +        ClientBase.CONNECTION_TIMEOUT = 3000;\n    +        final ZooKeeper zk = createClient();\n    --- End diff --\n    \n    @rakeshadr done. I was looking for something similar in createClient - did not find it so ended up using the old approach.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-27T16:57:59.569+0000","updated":"2017-01-27T16:57:59.569+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15844805","id":"15844805","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dknupp","name":"dknupp","key":"dknupp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dknupp&avatarId=31232","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dknupp&avatarId=31232","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dknupp&avatarId=31232","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dknupp&avatarId=31232"},"displayName":"David Knupp","active":true,"timeZone":"Etc/UTC"},"body":"We are seeing similar Zookeeper errors when trying to launch HBase while testing Impala on RHEL7. Is there enough information in the following log output to determine if it's the same bug?\n\n{noformat}\n17/01/04 21:31:35 ERROR server.NIOServerCnxn: Unexpected Exception: \njava.nio.channels.CancelledKeyException\n\tat sun.nio.ch.SelectionKeyImpl.ensureValid(SelectionKeyImpl.java:73)\n\tat sun.nio.ch.SelectionKeyImpl.interestOps(SelectionKeyImpl.java:77)\n\tat org.apache.zookeeper.server.NIOServerCnxn.sendBuffer(NIOServerCnxn.java:153)\n\tat org.apache.zookeeper.server.NIOServerCnxn.sendResponse(NIOServerCnxn.java:1075)\n\tat org.apache.zookeeper.server.FinalRequestProcessor.processRequest(FinalRequestProcessor.java:404)\n\tat org.apache.zookeeper.server.SyncRequestProcessor.run(SyncRequestProcessor.java:138)\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dknupp","name":"dknupp","key":"dknupp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dknupp&avatarId=31232","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dknupp&avatarId=31232","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dknupp&avatarId=31232","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dknupp&avatarId=31232"},"displayName":"David Knupp","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-30T03:38:19.339+0000","updated":"2017-01-30T04:27:05.723+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15844810","id":"15844810","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"Yes from the log it sounds the same issue of what this JIRA is trying to address.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-01-30T04:09:24.522+0000","updated":"2017-01-30T04:09:24.522+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15844821","id":"15844821","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dknupp","name":"dknupp","key":"dknupp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dknupp&avatarId=31232","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dknupp&avatarId=31232","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dknupp&avatarId=31232","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dknupp&avatarId=31232"},"displayName":"David Knupp","active":true,"timeZone":"Etc/UTC"},"body":"Thanks [~hanm].","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dknupp","name":"dknupp","key":"dknupp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dknupp&avatarId=31232","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dknupp&avatarId=31232","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dknupp&avatarId=31232","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dknupp&avatarId=31232"},"displayName":"David Knupp","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-30T04:28:31.421+0000","updated":"2017-01-30T04:28:31.421+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15847047","id":"15847047","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/156\n  \n    Thanks @hanm , I've committed the changes to branch-3.4\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-31T16:31:20.142+0000","updated":"2017-01-31T16:31:20.142+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15847096","id":"15847096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks [~hanm], [~fpj], [~abranzyck] and others for the help in resolving this issue.\n\nCommitted to branch-3.4:\nhttps://git-wip-us.apache.org/repos/asf?p=zookeeper.git;a=commit;h=4b9fe5ea71d73ba26ca722e3919b8d0afe84ab86","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-01-31T16:40:19.515+0000","updated":"2017-01-31T16:40:19.515+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15850291","id":"15850291","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/156\n  \n    @rakeshadr @hanm For whatever reason this PR was not closed. Could you close it Michael?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-02T18:40:53.564+0000","updated":"2017-02-02T18:40:53.564+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15853127","id":"15853127","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/156\n  \n    Closing pull request now it's merged. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-05T06:01:28.531+0000","updated":"2017-02-05T06:01:28.531+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743135/comment/15853128","id":"15853128","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/156\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-05T06:01:29.040+0000","updated":"2017-02-05T06:01:29.040+0000"}],"maxResults":39,"total":39,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2044/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i20brr:"}}