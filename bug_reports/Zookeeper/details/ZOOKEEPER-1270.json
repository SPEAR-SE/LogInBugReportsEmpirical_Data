{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12529326","self":"https://issues.apache.org/jira/rest/api/2/issue/12529326","key":"ZOOKEEPER-1270","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314469","id":"12314469","description":"Kerberos client auth, multi support, deb/rpm pkging.","name":"3.4.0","archived":false,"released":true,"releaseDate":"2011-11-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-11-03T00:12:24.918+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Nov 07 23:20:31 UTC 2011","customfield_12310420":"215186","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_634283593_*|*_5_*:*_2_*:*_8228131_*|*_4_*:*_1_*:*_10318283","customfield_12312321":null,"resolutiondate":"2011-11-05T11:46:06.140+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1270/watchers","watchCount":3,"isWatching":false},"created":"2011-10-28T22:25:36.207+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"15.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12345308","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12345308","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"outwardIssue":{"id":"12523643","key":"ZOOKEEPER-1194","self":"https://issues.apache.org/jira/rest/api/2/issue/12523643","fields":{"summary":"Two possible race conditions during leader establishment","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-23T19:22:04.609+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"Looks pretty serious - quorum is formed but no clients can attach. Will attach logs momentarily.\n\nThis test was introduced in the following commit (all three jira commit at once):\nZOOKEEPER-335. zookeeper servers should commit the new leader txn to their logs.\nZOOKEEPER-1081. modify leader/follower code to correctly deal with new leader\nZOOKEEPER-1082. modify leader election to correctly take into account current","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12501395","id":"12501395","filename":"testEarlyLeaderAbandonment.txt.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-28T22:35:43.470+0000","size":44242,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12501395/testEarlyLeaderAbandonment.txt.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502062","id":"12502062","filename":"testEarlyLeaderAbandonment2.txt.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-02T23:18:02.548+0000","size":49034,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12502062/testEarlyLeaderAbandonment2.txt.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502467","id":"12502467","filename":"testEarlyLeaderAbandonment3.txt.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T16:01:18.742+0000","size":60480,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12502467/testEarlyLeaderAbandonment3.txt.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502521","id":"12502521","filename":"testEarlyLeaderAbandonment4.txt.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T20:22:52.383+0000","size":47956,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12502521/testEarlyLeaderAbandonment4.txt.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502838","id":"12502838","filename":"testEarlyLeaderAbandonment5.txt.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-07T23:20:31.335+0000","size":55620,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12502838/testEarlyLeaderAbandonment5.txt.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502555","id":"12502555","filename":"ZOOKEEPER-1270_br34.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T00:22:07.307+0000","size":6936,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12502555/ZOOKEEPER-1270_br34.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502557","id":"12502557","filename":"ZOOKEEPER-1270.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T00:22:28.294+0000","size":7328,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12502557/ZOOKEEPER-1270.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502538","id":"12502538","filename":"ZOOKEEPER-1270.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-04T22:24:54.492+0000","size":1737,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12502538/ZOOKEEPER-1270.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502580","id":"12502580","filename":"ZOOKEEPER-1270-1194.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T05:39:58.962+0000","size":8437,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12502580/ZOOKEEPER-1270-1194.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502581","id":"12502581","filename":"zookeeper-1270-1194-34.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T05:53:32.537+0000","size":7762,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12502581/zookeeper-1270-1194-34.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502573","id":"12502573","filename":"ZOOKEEPER-1270-and-1194.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T04:05:16.259+0000","size":11270,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12502573/ZOOKEEPER-1270-and-1194.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502572","id":"12502572","filename":"ZOOKEEPER-1270-and-1194.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T03:57:59.537+0000","size":11270,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12502572/ZOOKEEPER-1270-and-1194.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502577","id":"12502577","filename":"ZOOKEEPER-1270-and-1194-branch34.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T05:13:35.695+0000","size":10596,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12502577/ZOOKEEPER-1270-and-1194-branch34.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502223","id":"12502223","filename":"ZOOKEEPER-1270tests.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T21:19:40.009+0000","size":5700,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12502223/ZOOKEEPER-1270tests.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502225","id":"12502225","filename":"ZOOKEEPER-1270tests2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T21:21:22.716+0000","size":5045,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12502225/ZOOKEEPER-1270tests2.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32646","customfield_12312823":null,"summary":"testEarlyLeaderAbandonment failing intermittently, quorum formed, no serving.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13141649","id":"13141649","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"It looks like this issue might be related to Read only mode - after applying the patch from ZOOKEEPER-1268 I could not get this to happen again. I ran the QuorumPeerMain test over 30 times without a single failure, I run the full test suite 3 times without any issues. It's looking like ROM is somehow causing this failure - which seems likely given the logs and the way ROM operates.\n\nI'm moving this out of 3.4.0 now that ZOOKEEPER-1268 is applied there and I can no longer reproduce.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-01T21:53:00.048+0000","updated":"2011-11-01T21:53:00.048+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13142657","id":"13142657","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Looks like this is still hanging around, see time 2011-11-02 22:11:27,124\n\nhttps://builds.apache.org/view/S-Z/view/ZooKeeper/job/ZooKeeper_branch34/49/testReport/junit/org.apache.zookeeper.server.quorum/QuorumPeerMainTest/testEarlyLeaderAbandonment/\n\n{noformat}\n\n2011-11-02 22:11:27,113 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:41413:LearnerHandler@264] - Follower sid: 1 : info : org.apache.zookeeper.server.quorum.QuorumPeer$QuorumServer@166340c\n2011-11-02 22:11:27,113 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:41414:LearnerHandler@264] - Follower sid: 0 : info : org.apache.zookeeper.server.quorum.QuorumPeer$QuorumServer@101ac93\n2011-11-02 22:11:27,123 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:41413:LearnerHandler@319] - Synchronizing with Follower sid: 1 maxCommittedLog =100000003 minCommittedLog = 100000001 peerLastZxid = 100000003\n2011-11-02 22:11:27,123 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:41414:LearnerHandler@319] - Synchronizing with Follower sid: 0 maxCommittedLog =100000003 minCommittedLog = 100000001 peerLastZxid = 100000003\n2011-11-02 22:11:27,123 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:41413:LearnerHandler@407] - Sending snapshot last zxid of peer is 0x100000003  zxid of leader is 0x0sent zxid of db as 0x100000003\n2011-11-02 22:11:27,124 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:41414:LearnerHandler@407] - Sending snapshot last zxid of peer is 0x100000003  zxid of leader is 0x0sent zxid of db as 0x100000003\n2011-11-02 22:11:27,123 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:11230:Learner@323] - Getting a snapshot from leader\n2011-11-02 22:11:27,124 [myid:0] - INFO  [QuorumPeer[myid=0]/0:0:0:0:0:0:0:0:11227:Learner@323] - Getting a snapshot from leader\n2011-11-02 22:11:27,125 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:11230:FileTxnSnapLog@255] - Snapshotting: 100000003\n2011-11-02 22:11:27,125 [myid:0] - INFO  [QuorumPeer[myid=0]/0:0:0:0:0:0:0:0:11227:FileTxnSnapLog@255] - Snapshotting: 100000003\n2011-11-02 22:11:27,373 [myid:] - INFO  [main-SendThread(localhost:11233):ClientCnxn$SendThread@933] - Opening socket connection to server localhost/127.0.0.1:11233\n2011-11-02 22:11:27,373 [myid:] - INFO  [main-SendThread(localhost:11233):ClientCnxn$SendThread@846] - Socket connection established to localhost/127.0.0.1:11233, initiating session\n2011-11-02 22:11:27,373 [myid:2] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:11233:NIOServerCnxnFactory@213] - Accepted socket connection from /127.0.0.1:37239\n2011-11-02 22:11:27,374 [myid:2] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:11233:NIOServerCnxn@354] - Exception causing close of session 0x0 due to java.io.IOException: ZooKeeperServer not running\n2011-11-02 22:11:27,374 [myid:2] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:11233:NIOServerCnxn@1000] - Closed socket connection for client /127.0.0.1:37239 (no session established for client)\n2011-11-02 22:11:27,374 [myid:] - INFO  [main-SendThread(localhost:11233):ClientCnxn$SendThread@1059] - Unable to read additional data from server sessionid 0x233665616f20000, likely server has closed socket, closing socket connection and attempting reconnect\n2011-11-02 22:11:27,714 [myid:] - INFO  [main-SendThread(localhost:11230):ClientCnxn$SendThread@933] - Opening socket connection to server localhost/127.0.0.1:11230\n2011-11-02 22:11:27,714 [myid:] - INFO  [main-SendThread(localhost:11230):ClientCnxn$SendThread@846] - Socket connection established to localhost/127.0.0.1:11230, initiating session\n2011-11-02 22:11:27,714 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:11230:NIOServerCnxnFactory@213] - Accepted socket connection from /127.0.0.1:33215\n2011-11-02 22:11:27,715 [myid:1] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:11230:NIOServerCnxn@354] - Exception causing close of session 0x0 due to java.io.IOException: ZooKeeperServer not running\n2011-11-02 22:11:27,715 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:11230:NIOServerCnxn@1000] - Closed socket connection for client /127.0.0.1:33215 (no session established for client)\n2011-11-02 22:11:27,715 [myid:] - INFO  [main-SendThread(localhost:11230):ClientCnxn$SendThread@1059] - Unable to read additional data from server sessionid 0x133665616f50000, likely server has closed socket, closing socket connection and attempting reconnect\n2011-11-02 22:11:27,843 [myid:] - INFO  [main-SendThread(localhost:11227):ClientCnxn$SendThread@933] - Opening socket connection to server localhost/127.0.0.1:11227\n2011-11-02 22:11:27,843 [myid:] - INFO  [main-SendThread(localhost:11227):ClientCnxn$SendThread@846] - Socket connection established to localhost/127.0.0.1:11227, initiating session\n{noformat}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-02T22:58:49.557+0000","updated":"2011-11-02T22:58:49.557+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13142670","id":"13142670","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"testEarlyLeaderAbandonment2.txt.gz contains the second failure logs - from apache jenkins on branch 34","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-02T23:18:03.884+0000","updated":"2011-11-02T23:18:03.884+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13142709","id":"13142709","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Looks like the zookeeperserver does not start running within the Quorum Peers. There is something really wrong which prevents the Followers/leaders to start running the ZooKeeperServers. I suspect, it has something to do with NEWLeader transaction (could be wrong). Need to look deeper. Another pair of eyes would help!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T00:12:24.918+0000","updated":"2011-11-03T00:12:24.918+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143272","id":"13143272","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"For coordination purposes, I'm having a look at this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-03T16:10:56.412+0000","updated":"2011-11-03T16:10:56.412+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143390","id":"13143390","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Here is my progress so far. Mahadev is right, it sounds like we are not setting the zkServer of ServerCnxFactory, which we do both in Learner and Leader by calling self.cnxnFactory.setZooKeeperServer(zk). We should also be seeing a message like: \n\n{noformat}\nHave quorum of supporters; starting up and setting last processed zxid:\n{noformat}\n\nin the log file Pat posted, but we aren't, which implies that the leader establishment procedure is not completing. Is this a timing issue? I'm skeptical about it being a time issue because we wait 10 seconds for the waitForAll call to complete, but I'm not sure if this completely unrealistic or not assuming that the jenkins machine is overloaded.\n\nIs there anything I'm missing here? I'll keep investigating...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-03T18:04:36.370+0000","updated":"2011-11-03T18:04:36.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143400","id":"13143400","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I forgot to mention that I haven't been able to reproduce it, and I have been running for the past few hours.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-03T18:12:05.696+0000","updated":"2011-11-03T18:12:05.696+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143473","id":"13143473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"You have come to the same conclusion I did. The leader sends snapshots to the followers and they both log that they are taking a snaphsot (implying that we got the NEWLEADER message), but you don't see anything in the log that indicates the leader actually managed to call processAck on either of the responses, where you should see something like:\n2011-11-03 13:07:49,717 [myid:2] - WARN  [LearnerHandler-/127.0.0.1:63083:Leader@506] - Commiting zxid 0x200000000 from /127.0.0.1:11228 not first!\n2011-11-03 13:07:49,717 [myid:2] - WARN  [LearnerHandler-/127.0.0.1:63083:Leader@508] - First is 0\n\nNot sure why yet though.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T19:31:23.538+0000","updated":"2011-11-03T19:31:23.538+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143481","id":"13143481","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"It would be nice if we could get a full stack dump on failure here. It seems like if this is some sort of a deadlock issue that would show it pretty quick. I will see if I can add that to QuorumPeerMainTest, to possibly get some more information.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T19:51:25.413+0000","updated":"2011-11-03T19:51:25.413+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143540","id":"13143540","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"tests that will print the whole stack trace in case of failure to reach client state","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T21:19:40.161+0000","updated":"2011-11-03T21:19:40.161+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143542","id":"13143542","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"There's some extraneous stuff in ClientBase, but if anyone can repro this bug locally and run it with this stack tracing on that would be useful.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T21:22:26.973+0000","updated":"2011-11-03T21:22:26.973+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143567","id":"13143567","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I haven't been able to reproduce the problem, but I'll leave it running in a loop. On your comment about ClientBase, Camille, I was wondering if you have any other insight.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-03T22:28:12.927+0000","updated":"2011-11-03T22:28:12.927+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143602","id":"13143602","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"It seems to me that everything comes up ok, and starts the election process, elects a leader, and gets a snapshot from the leader. But in the logs where you have 2 followers very closely synched in time (never my local box but seems to happen on the build boxes occasionally), after the followers have claimed to write a snapshot to disk (which means they must have gotten the NEWLEADER message) the whole process then stops, and you see no logs from the leader indicating it ran processAck for either follower. It feels to me like it could be a race condition in the leader somewhere, causing it to somehow miss that ACK but I can't seem to find it. Nothing in the diffs from the checkin related to ZAB1.0 seem to be much of a culprit... I'm a bit stumped but going to keep looking.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-03T23:24:31.566+0000","updated":"2011-11-03T23:24:31.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143625","id":"13143625","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Camille - This patch is against trunk, is that true? (fails to apply against 3.4)\n\nNotice that the original traces are against 3.4 branch.\n\nI'm running this patch against my CI infra. will let you know.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-03T23:48:37.684+0000","updated":"2011-11-03T23:48:37.684+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143631","id":"13143631","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"here: (trunk)\n\n{noformat}\n\n2011-11-03 17:03:55,228 [myid:] - ERROR [main:ClientBase@544] - Starting logAllStackTraces()\nThread Sender-/127.0.0.1:48422\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1925)\n\tat java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)\n\tat org.apache.zookeeper.server.quorum.LearnerHandler.sendPackets(LearnerHandler.java:137)\n\tat org.apache.zookeeper.server.quorum.LearnerHandler.access$000(LearnerHandler.java:56)\n\tat org.apache.zookeeper.server.quorum.LearnerHandler$1.run(LearnerHandler.java:425)\nThread Finalizer\n\tat java.lang.Object.wait(Native Method)\n\tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:118)\n\tat java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:134)\n\tat java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:159)\nThread NIOServerCxn.Factory:0.0.0.0/0.0.0.0:11227\n\tat sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)\n\tat sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:210)\n\tat sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:65)\n\tat sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:69)\n\tat sun.nio.ch.SelectorImpl.select(SelectorImpl.java:80)\n\tat org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:194)\n\tat java.lang.Thread.run(Thread.java:619)\nThread QuorumPeer[myid=2]/0:0:0:0:0:0:0:0:11233\n\tat java.lang.Thread.sleep(Native Method)\n\tat org.apache.zookeeper.server.quorum.Leader.lead(Leader.java:361)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:746)\nThread main-EventThread\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1925)\n\tat java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)\n\tat org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:493)\nThread SendWorker:0\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:342)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:829)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.access$500(QuorumCnxManager.java:60)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$SendWorker.run(QuorumCnxManager.java:665)\nThread SendWorker:0\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:342)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:829)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.access$500(QuorumCnxManager.java:60)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$SendWorker.run(QuorumCnxManager.java:665)\nThread Reference Handler\n\tat java.lang.Object.wait(Native Method)\n\tat java.lang.Object.wait(Object.java:485)\n\tat java.lang.ref.Reference$ReferenceHandler.run(Reference.java:116)\nThread LearnerHandler-/127.0.0.1:48421\n\tat java.lang.Object.wait(Native Method)\n\tat org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:450)\nThread Thread-20\n\tat java.lang.Object.wait(Native Method)\n\tat java.lang.Thread.join(Thread.java:1143)\n\tat java.lang.Thread.join(Thread.java:1196)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:151)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:110)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerTestBase$MainThread.run(QuorumPeerTestBase.java:107)\n\tat java.lang.Thread.run(Thread.java:619)\nThread main-EventThread\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1925)\n\tat java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)\n\tat org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:493)\nThread /127.0.0.1:11229\n\tat java.net.PlainSocketImpl.socketAccept(Native Method)\n\tat java.net.PlainSocketImpl.accept(PlainSocketImpl.java:390)\n\tat java.net.ServerSocket.implAccept(ServerSocket.java:453)\n\tat java.net.ServerSocket.accept(ServerSocket.java:421)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$Listener.run(QuorumCnxManager.java:489)\nThread SendWorker:1\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:342)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:829)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.access$500(QuorumCnxManager.java:60)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$SendWorker.run(QuorumCnxManager.java:665)\nThread NIOServerCxn.Factory:0.0.0.0/0.0.0.0:11233\n\tat sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)\n\tat sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:210)\n\tat sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:65)\n\tat sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:69)\n\tat sun.nio.ch.SelectorImpl.select(SelectorImpl.java:80)\n\tat org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:194)\n\tat java.lang.Thread.run(Thread.java:619)\nThread RecvWorker:1\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:129)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:182)\n\tat java.io.DataInputStream.readInt(DataInputStream.java:370)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$RecvWorker.run(QuorumCnxManager.java:745)\nThread Thread-26\n\tat java.net.PlainSocketImpl.socketAccept(Native Method)\n\tat java.net.PlainSocketImpl.accept(PlainSocketImpl.java:390)\n\tat java.net.ServerSocket.implAccept(ServerSocket.java:453)\n\tat java.net.ServerSocket.accept(ServerSocket.java:421)\n\tat org.apache.zookeeper.server.quorum.Leader$LearnerCnxAcceptor.run(Leader.java:250)\nThread /127.0.0.1:11235\n\tat java.net.PlainSocketImpl.socketAccept(Native Method)\n\tat java.net.PlainSocketImpl.accept(PlainSocketImpl.java:390)\n\tat java.net.ServerSocket.implAccept(ServerSocket.java:453)\n\tat java.net.ServerSocket.accept(ServerSocket.java:421)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$Listener.run(QuorumCnxManager.java:489)\nThread SendWorker:2\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:342)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:829)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.access$500(QuorumCnxManager.java:60)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$SendWorker.run(QuorumCnxManager.java:665)\nThread main-SendThread(localhost:11233)\n\tat java.lang.Thread.sleep(Native Method)\n\tat org.apache.zookeeper.ClientCnxn$SendThread.startConnect(ClientCnxn.java:925)\n\tat org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:979)\nThread WorkerReceiver[myid=0]\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:342)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.pollRecvQueue(QuorumCnxManager.java:881)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerReceiver.run(FastLeaderElection.java:205)\n\tat java.lang.Thread.run(Thread.java:619)\nThread /127.0.0.1:11232\n\tat java.net.PlainSocketImpl.socketAccept(Native Method)\n\tat java.net.PlainSocketImpl.accept(PlainSocketImpl.java:390)\n\tat java.net.ServerSocket.implAccept(ServerSocket.java:453)\n\tat java.net.ServerSocket.accept(ServerSocket.java:421)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$Listener.run(QuorumCnxManager.java:489)\nThread WorkerSender[myid=2]\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.LinkedBlockingQueue.poll(LinkedBlockingQueue.java:424)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:362)\n\tat java.lang.Thread.run(Thread.java:619)\nThread SendWorker:2\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:342)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:829)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.access$500(QuorumCnxManager.java:60)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$SendWorker.run(QuorumCnxManager.java:665)\nThread RecvWorker:2\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:129)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:182)\n\tat java.io.DataInputStream.readInt(DataInputStream.java:370)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$RecvWorker.run(QuorumCnxManager.java:745)\nThread Thread-22\n\tat java.lang.Object.wait(Native Method)\n\tat java.lang.Thread.join(Thread.java:1143)\n\tat java.lang.Thread.join(Thread.java:1196)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:151)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:110)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerTestBase$MainThread.run(QuorumPeerTestBase.java:107)\n\tat java.lang.Thread.run(Thread.java:619)\nThread SendWorker:1\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:342)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:829)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.access$500(QuorumCnxManager.java:60)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$SendWorker.run(QuorumCnxManager.java:665)\nThread RecvWorker:0\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:129)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:182)\n\tat java.io.DataInputStream.readInt(DataInputStream.java:370)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$RecvWorker.run(QuorumCnxManager.java:745)\nThread Signal Dispatcher\nThread RecvWorker:0\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:129)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:182)\n\tat java.io.DataInputStream.readInt(DataInputStream.java:370)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$RecvWorker.run(QuorumCnxManager.java:745)\nThread RecvWorker:2\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:129)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:182)\n\tat java.io.DataInputStream.readInt(DataInputStream.java:370)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$RecvWorker.run(QuorumCnxManager.java:745)\nThread LearnerHandler-/127.0.0.1:48422\n\tat java.lang.Object.wait(Native Method)\n\tat org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:450)\nThread WorkerReceiver[myid=2]\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:342)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.pollRecvQueue(QuorumCnxManager.java:881)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerReceiver.run(FastLeaderElection.java:205)\n\tat java.lang.Thread.run(Thread.java:619)\nThread Thread-21\n\tat java.lang.Object.wait(Native Method)\n\tat java.lang.Thread.join(Thread.java:1143)\n\tat java.lang.Thread.join(Thread.java:1196)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:151)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:110)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerTestBase$MainThread.run(QuorumPeerTestBase.java:107)\n\tat java.lang.Thread.run(Thread.java:619)\nThread NIOServerCxn.Factory:0.0.0.0/0.0.0.0:11230\n\tat sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)\n\tat sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:210)\n\tat sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:65)\n\tat sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:69)\n\tat sun.nio.ch.SelectorImpl.select(SelectorImpl.java:80)\n\tat org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:194)\n\tat java.lang.Thread.run(Thread.java:619)\nThread main\n\tat java.lang.Thread.dumpThreads(Native Method)\n\tat java.lang.Thread.getAllStackTraces(Thread.java:1487)\n\tat org.apache.zookeeper.test.ClientBase.logAllStackTraces(ClientBase.java:536)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMainTest.waitForAll(QuorumPeerMainTest.java:319)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMainTest.testEarlyLeaderAbandonment(QuorumPeerMainTest.java:148)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:597)\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)\n\tat org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:52)\n\tat org.junit.rules.TestWatchman$1.evaluate(TestWatchman.java:52)\n\tat org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:263)\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:69)\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:48)\n\tat org.junit.runners.ParentRunner$3.run(ParentRunner.java:231)\n\tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:60)\n\tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:229)\n\tat org.junit.runners.ParentRunner.access$000(ParentRunner.java:50)\n\tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:222)\n\tat org.junit.runners.ParentRunner.run(ParentRunner.java:292)\n\tat junit.framework.JUnit4TestAdapter.run(JUnit4TestAdapter.java:39)\n\tat org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.run(JUnitTestRunner.java:422)\n\tat org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.launch(JUnitTestRunner.java:931)\n\tat org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.main(JUnitTestRunner.java:785)\nThread main-SendThread(localhost:11230)\n\tat java.lang.Thread.sleep(Native Method)\n\tat org.apache.zookeeper.ClientCnxnSocketNIO.cleanup(ClientCnxnSocketNIO.java:161)\n\tat org.apache.zookeeper.ClientCnxn$SendThread.cleanup(ClientCnxn.java:1131)\n\tat org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1071)\nThread main-SendThread(localhost:11227)\n\tat java.lang.Thread.sleep(Native Method)\n\tat org.apache.zookeeper.ClientCnxn$SendThread.startConnect(ClientCnxn.java:925)\n\tat org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:979)\nThread main-EventThread\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1925)\n\tat java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)\n\tat org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:493)\nThread WorkerSender[myid=1]\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.LinkedBlockingQueue.poll(LinkedBlockingQueue.java:424)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:362)\n\tat java.lang.Thread.run(Thread.java:619)\nThread QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:11230\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:129)\n\tat java.io.BufferedInputStream.fill(BufferedInputStream.java:218)\n\tat java.io.BufferedInputStream.read(BufferedInputStream.java:237)\n\tat java.io.DataInputStream.readInt(DataInputStream.java:370)\n\tat org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)\n\tat org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83)\n\tat org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:108)\n\tat org.apache.zookeeper.server.quorum.Learner.readPacket(Learner.java:152)\n\tat org.apache.zookeeper.server.quorum.Learner.syncWithLeader(Learner.java:363)\n\tat org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:80)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:733)\nThread WorkerSender[myid=0]\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.LinkedBlockingQueue.poll(LinkedBlockingQueue.java:424)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:362)\n\tat java.lang.Thread.run(Thread.java:619)\nThread RecvWorker:1\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:129)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:182)\n\tat java.io.DataInputStream.readInt(DataInputStream.java:370)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager$RecvWorker.run(QuorumCnxManager.java:745)\nThread Sender-/127.0.0.1:48421\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1925)\n\tat java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:399)\n\tat org.apache.zookeeper.server.quorum.LearnerHandler.sendPackets(LearnerHandler.java:137)\n\tat org.apache.zookeeper.server.quorum.LearnerHandler.access$000(LearnerHandler.java:56)\n\tat org.apache.zookeeper.server.quorum.LearnerHandler$1.run(LearnerHandler.java:425)\nThread QuorumPeer[myid=0]/0:0:0:0:0:0:0:0:11227\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(SocketInputStream.java:129)\n\tat java.io.BufferedInputStream.fill(BufferedInputStream.java:218)\n\tat java.io.BufferedInputStream.read(BufferedInputStream.java:237)\n\tat java.io.DataInputStream.readInt(DataInputStream.java:370)\n\tat org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)\n\tat org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83)\n\tat org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:108)\n\tat org.apache.zookeeper.server.quorum.Learner.readPacket(Learner.java:152)\n\tat org.apache.zookeeper.server.quorum.Learner.syncWithLeader(Learner.java:363)\n\tat org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:80)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:733)\nThread WorkerReceiver[myid=1]\n\tat sun.misc.Unsafe.park(Native Method)\n\tat java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:1963)\n\tat java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:342)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.pollRecvQueue(QuorumCnxManager.java:881)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerReceiver.run(FastLeaderElection.java:205)\n\tat java.lang.Thread.run(Thread.java:619)\nEnding logAllStackTraces()\n{noformat}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T00:03:54.445+0000","updated":"2011-11-04T00:03:54.445+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13143690","id":"13143690","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Looking at this some more I'm not entirely convinced it isn't a timing issue:\n{quote}\nI'm skeptical about it being a time issue because we wait 10 seconds for the waitForAll call to complete, but I'm not sure if this completely unrealistic or not assuming that the jenkins machine is overloaded.\n{quote}\nI actually have the startup and shutdown running in a loop on my box. The one time I managed to get it to fail was due to 10 seconds not being a long enough wait time. The servers were almost up, in fact, but election just took a little while as did snapshotting etc and it never succeeded. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-04T02:11:39.157+0000","updated":"2011-11-04T02:11:39.157+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144092","id":"13144092","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"There's definitely a problem somewhere. See testEarlyLeaderAbandonment3.txt.gz\n\nLook at time 2011-11-04 03:41:24,779\n\nI modified the test to iterate 30 times (instead of 10) and sleep for 2 sec (rather than 1). I then ran this test continually overnight (300+times). It never failed, however when I looked at some of the console results I saw that it actually is failing, however the test is not catching this.\n\nSo two issues really - 1) it looks like this is a real problem, from the exception it seems the leader has frozen? 2) the test needs to be updated regardless to fail in this case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T16:01:19.604+0000","updated":"2011-11-04T16:01:19.604+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144163","id":"13144163","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Let me dump what I have in mind right now. After checking the logs and the stack trace Pat provided, it looks like the leader is waiting on the loop right before it sets the zookeeper server (Line 361, Leader), as we had observed before. It implies that the leader is not receiving acks from followers. Since the logs say that the followers are snapshotting, one option is that the snapshot is not concluding for some reason. Another alternative is that the acknowledgments to the leader are getting lost. \n\nSince Pat increased the parameter values to have a longer timeout, I'm even more skeptical that this is a timing issue, but I don't think we can rule it out yet. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-04T17:01:52.460+0000","updated":"2011-11-04T17:01:52.460+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144167","id":"13144167","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"If you update the patch with addl debugging, and fix the test to actually fail in this case, I'll be happy to run it again on my cluster.\n\nadd some log detail when the followers complete snapshotting so we can rule this out/in.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T17:08:03.082+0000","updated":"2011-11-04T17:08:03.082+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144171","id":"13144171","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"This is the code snippet for the handling of UPTODATE in Learner.java:\n\n{noformat}\n              case Leader.UPTODATE:\n                    if (!snapshotTaken) {\n                        zk.takeSnapshot();\n                    }\n                    self.cnxnFactory.setZooKeeperServer(zk);                \n                    break outerLoop;\n{noformat} \n\n\nIf the snapshot were completing, then it should be setting the zookeeper server. Given that we see the \"Snapshotting\" message in the logs, I assume that the follower is receiving an UPTODATE message, but it is failing to complete the snapshot.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-04T17:10:28.864+0000","updated":"2011-11-04T17:10:28.864+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144208","id":"13144208","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Ok, here's whats' happening wrt the test not failing. \n\nLook after the time index I provided, notice that the followers fail to hear from the leader, at which point they re-negotiate the quorum, at which point the quorum IS RE-EST SUCCESSFULLY, and the clients are now able to connect to the service and the test continues.\n\nThis is a side-effect of increasing the \"waitForAll\" time that we allow. We are giving time for the quorum to re-establish itself after the \"hang\". \n\nLikely this is why we have not seen this in the past, if it did every happen (in any test) it might have been ignored due to recovery.\n\nso now that we know the test is really failing, perhaps we should just go back to 10 iterations/1sec sleep so that the test will actually fail. (or perhaps there's a better way to address this in the test?)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T17:54:53.922+0000","updated":"2011-11-04T17:54:53.922+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144237","id":"13144237","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Here is some progress. I was actually looking at the wrong snippet. The correct one was the NEWLEADER handler:\n\n{noformat}\n            case Leader.NEWLEADER: // it will be NEWLEADER in v1.0\n                    zk.takeSnapshot();\n                    snapshotTaken = true;\n                    writePacket(new QuorumPacket(Leader.ACK, newLeaderZxid, null, null), true);\n                    break;\n                }\n\n{noformat} \n\nWe also take a snapshot here and by looking at the stack trace that Pat posted, we see that the learner handlers are stuck in the loop right after receiving the ack, which essentially waits for the leader to start. By the same stack trace, the leader is not starting because it is waiting for the followers to acknowledge the NEWLEADER message... but the followers have acknowledged the NEWLEADER message, otherwise the learner handlers wouldn't be executing that loop (Line 450). Unless I'm missing anything, the problem must be in Leader.processAck.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-04T18:25:45.691+0000","updated":"2011-11-04T18:25:45.691+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144244","id":"13144244","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Here are the two cases that would cause the ack not to be added without generating any log message:\n\n{noformat}\n        if (outstandingProposals.size() == 0) {\n            if (LOG.isDebugEnabled()) {\n                LOG.debug(\"outstanding is 0\");\n            }\n            return;\n        }\n        if (lastCommitted >= zxid) {\n            if (LOG.isDebugEnabled()) {\n                LOG.debug(\"proposal has already been committed, pzxid:\"\n                        + lastCommitted\n                        + \" zxid: 0x\" + Long.toHexString(zxid));\n            }\n            // The proposal has already been committed\n            return;\n        }\n\n{noformat}\n\nI'm trying to decide which one is likely to be causing it to return.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-04T18:42:31.451+0000","updated":"2011-11-04T18:42:31.451+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144272","id":"13144272","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"My latest conjecture is that we are getting acks for NEWLEADER before we have a chance to get it into the outstandingProposals queue, which would cause the ack to be dropped and the behavior we are observing. I tried to move the code in lead that adds NEWLEADER to the queue to before the point where we start the cnxAcceptor, but it broke a lot of tests, so I don't think this is the right approach.\n\nPat, if you want to run again, I would suggest to put two info messages for the cases I posted last in Leader.processAck() to determine exactly which case is being triggered and preventing the leader from collecting the ack.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-04T19:36:01.728+0000","updated":"2011-11-04T19:36:01.728+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144292","id":"13144292","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm running that on my cluster now. will report results.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T20:09:32.678+0000","updated":"2011-11-04T20:09:32.678+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144306","id":"13144306","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"This was printed a few times just before the failure:\n\n{noformat}\n    [junit] 2011-11-04 13:23:20,001 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:51057:Leader@478] - PDH outstandingProposals.size() is ZERO\n{noformat}\n\nSee attachment testEarlyLeaderAbandonment4","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T20:22:52.531+0000","updated":"2011-11-04T20:22:52.531+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144310","id":"13144310","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm not sure that's conclusive though, this is the patch, if I apply it on my local system the test passes, but the logs still contain this ZERO outstanding message:\n\n{noformat}\n\ndiff --git a/src/java/main/org/apache/zookeeper/server/quorum/Leader.java b/src/java/main/org/apache/zookeeper/server/quorum/Leader.java\nindex a44f1ee..a4cc127 100644\n--- a/src/java/main/org/apache/zookeeper/server/quorum/Leader.java\n+++ b/src/java/main/org/apache/zookeeper/server/quorum/Leader.java\n@@ -475,12 +475,14 @@ public class Leader {\n         }\n \n         if (outstandingProposals.size() == 0) {\n+            LOG.info(\"PDH outstandingProposals.size() is ZERO\");\n             if (LOG.isDebugEnabled()) {\n                 LOG.debug(\"outstanding is 0\");\n             }\n             return;\n         }\n         if (lastCommitted >= zxid) {\n+            LOG.info(\"PDH lastCommitted = \" + Long.toHexString(lastCommitted) + \" zxid = \" + Long.toHexString(zxid));\n             if (LOG.isDebugEnabled()) {\n                 LOG.debug(\"proposal has already been committed, pzxid:\"\n                         + lastCommitted\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T20:26:31.188+0000","updated":"2011-11-04T20:26:31.188+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144334","id":"13144334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"It is ok to have the zero outstanding message, since the request might have been already acknowledged by a quorum. It is a problem if you get it and it hasn't been acknowledged by a quorum, which corresponds to the case I mentioned above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-04T20:57:44.271+0000","updated":"2011-11-04T20:57:44.271+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144351","id":"13144351","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"why do I see this in my local test log then? (passes) \n\n{noformat}\n2011-11-04 13:33:12,979 [myid:0] - INFO  [QuorumPeer[myid=0]/0:0:0:0:0:0:0:0:11227:FileTxnSnapLog@255] - Snapshotting: 0\n2011-11-04 13:33:12,979 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:43739:Leader@478] - PDH outstandingProposals.size() is ZERO zxid = 100000000 sid = 1\n2011-11-04 13:33:12,981 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:43740:Leader@478] - PDH outstandingProposals.size() is ZERO zxid = 100000000 sid = 0\n2011-11-04 13:33:12,985 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:43740:Leader@478] - PDH outstandingProposals.size() is ZERO zxid = 100000000 sid = 0\n<then immediately a client connects successfully>\n{noformat}\n\nThis is at the same point in the log where we see the crash (but this is a passing version)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T21:24:23.266+0000","updated":"2011-11-04T21:24:23.266+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144372","id":"13144372","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"here's more log information for a passing case. I added a new LOG after the size==0 check to check for the case where we get an ack and there is something outstanding.\n\nNotice each follower is sending 2 acks. ack!\n\n{noformat}\n2011-11-04 14:35:43,549 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:11230:FileTxnSnapLog@255] - Snapshotting: 0\n2011-11-04 14:35:43,549 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:45594:Leader@484] - PDH outstandingProposals.size() is NOT zero zxid = 100000000 sid = 0 followerAddr = /127.0.0.1:11234\n2011-11-04 14:35:43,549 [myid:2] - WARN  [LearnerHandler-/127.0.0.1:45594:Leader@509] - Commiting zxid 0x100000000 from /127.0.0.1:11234 not first!\n2011-11-04 14:35:43,550 [myid:2] - WARN  [LearnerHandler-/127.0.0.1:45594:Leader@511] - First is 0\n2011-11-04 14:35:43,550 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:45594:Leader@535] - Have quorum of supporters; starting up and setting last processed zxid: 4294967296\n2011-11-04 14:35:43,566 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:45595:Leader@478] - PDH outstandingProposals.size() is ZERO zxid = 100000000 sid = 1 followerAddr = /127.0.0.1:11234\n2011-11-04 14:35:43,569 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:45594:Leader@478] - PDH outstandingProposals.size() is ZERO zxid = 100000000 sid = 0 followerAddr = /127.0.0.1:11234\n2011-11-04 14:35:43,570 [myid:2] - INFO  [LearnerHandler-/127.0.0.1:45595:Leader@478] - PDH outstandingProposals.size() is ZERO zxid = 100000000 sid = 1 followerAddr = /127.0.0.1:11234\n{noformat}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T21:43:57.301+0000","updated":"2011-11-04T21:43:57.301+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144378","id":"13144378","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"2 acks is expected. This threw me the first time I saw it in the code, but it's right as far as I could reason looking through follower and leader, the first ack is after NEWLEADER, the second is right before we start the zk server.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-04T21:49:03.711+0000","updated":"2011-11-04T21:49:03.711+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144413","id":"13144413","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"With this patch, we make sure that the newleader message is queued before we process acks to newleader. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-04T22:24:54.628+0000","updated":"2011-11-04T22:24:54.628+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144416","id":"13144416","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Camille, It sounds right that we need multiple acks from the follower, but it sounds awkward that they are acknowledging the same message. Perhaps this is to guarantee a correct implementation and for backward compatibility?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-04T22:29:46.228+0000","updated":"2011-11-04T22:29:46.228+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144426","id":"13144426","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"it's running in my test harness now (both camille's patch and fpj)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-04T22:46:04.808+0000","updated":"2011-11-04T22:46:04.808+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144480","id":"13144480","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Please note that https://issues.apache.org/jira/browse/ZOOKEEPER-1194 fixes the problem of NEWLEADER message not being in outstandingProposals when NEWLEADER acks arrive. \n\nI haven't followed ZK-1270 closely, but just thought you should be aware of ZK-1194","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T00:20:15.601+0000","updated":"2011-11-05T00:20:15.601+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144483","id":"13144483","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Alexander. How does that patch compare to this? Esp wrt risk?\n\nDo you think we should choose 1194 over this change?\n\nFlavio?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T00:24:35.160+0000","updated":"2011-11-05T00:24:35.160+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144492","id":"13144492","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"I think that ZK-1194 risk is very low. It modifies 2 lines of code in Leader.java to make sure that the leader is in connectingFollowers (electingFollowers) before returning from getEpochToPropose (waitForEpochAck). It includes 2 tests for these two changes.\n\nAccording to my understanding, ZK-1194 patch can replace all changes to Leader and LearnerHandler that appear in the patches above for ZK-1270. Specifically with ZK-1194 in it is not necessary to explicitly check that NEWLEADER message got into the outstandingProposals, and to wait for this condition in LeaderHandler. \n\nI'm not sure what was the purpose of the changes to the other files in ZK-1270 but I'm pretty sure ZK-1194 addresses the same issue as the changes to Leader and LearnerHandler made here. Also - ZK-1194 handles another possible race condition not addressed in ZK-1270.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T00:48:42.111+0000","updated":"2011-11-05T00:48:42.111+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144518","id":"13144518","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Alex/Pat,\n I'd really prefer the patch on this jira for now. Alex, I am in the middle of making a release. The patch on ZOOKEEPER-1194 does not apply and I really would not like to wait for consensus on the fix on ZOOKEEEPR-1194. We can definitely put the fix in ZOOKEEPER-1194 in 3.5 or 3.4.1. Fair enough? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T01:56:05.975+0000","updated":"2011-11-05T01:56:05.975+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144530","id":"13144530","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Mahadev,\n\nI understand, I'm only speaking up here because the patches overlap. When ZK-1194 goes in the changes to Leader and LearnerHandler from ZK-1270 become unnecessary.\n\nActually, now that I looked closer on ZK-1270 I realized that the changes to Leader.java and LearnerHandler.java are the only code changes here and the rest are tests. So ZK-1270 is subsumed by ZK-1194.\n\nI think it would be best to adopt the code changes from ZK-1194 (changes to 2 lines of code) and merge the tests in these patches. But this is up to you of course.\n\n\nAlex\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T02:46:14.530+0000","updated":"2011-11-05T02:46:14.530+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144555","id":"13144555","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm attaching an alternative patch to this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T03:57:59.677+0000","updated":"2011-11-05T03:57:59.677+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144556","id":"13144556","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Alex,\n Can you please upload a patch that applies to trunk and 3.4 branch here? I'd like to get this done tonight.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T03:59:31.165+0000","updated":"2011-11-05T03:59:31.165+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144557","id":"13144557","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Alex,\n Please make sure that you grant code changes to Apache. You just have to click on the box that says \"Grant license to Apache\" when attaching the patch.\n\nDo reattach the patch with the grant. thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T04:01:54.057+0000","updated":"2011-11-05T04:01:54.057+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144562","id":"13144562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"If readyToStart becomes unused with this patch can we please go ahead and remove it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T04:17:44.986+0000","updated":"2011-11-05T04:17:44.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144566","id":"13144566","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"note: flavio's patch is causing the following 11 tests to fail consistently:\n\n{noformat}\norg.apache.zookeeper.test.DisconnectedWatcherTest.testChildWatcherAutoResetWithChroot\norg.apache.zookeeper.test.DisconnectedWatcherTest.testDefaultWatcherAutoResetWithChroot\norg.apache.zookeeper.test.DisconnectedWatcherTest.testDeepChildWatcherAutoResetWithChroot\norg.apache.zookeeper.test.WatcherTest.testWatcherAutoResetWithGlobal\norg.apache.zookeeper.test.WatcherTest.testWatcherAutoResetWithLocal\norg.apache.zookeeper.test.WatcherTest.testWatcherAutoResetDisabledWithGlobal\norg.apache.zookeeper.test.WatcherTest.testWatcherAutoResetDisabledWithLocal\norg.apache.zookeeper.test.WatcherTest.testWatcherAutoResetWithGlobal\norg.apache.zookeeper.test.WatcherTest.testWatcherAutoResetWithLocal\norg.apache.zookeeper.test.WatcherTest.testWatcherAutoResetDisabledWithGlobal\norg.apache.zookeeper.test.WatcherTest.testWatcherAutoResetDisabledWithLocal\n{noformat}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T04:25:06.951+0000","updated":"2011-11-05T04:25:06.951+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144588","id":"13144588","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Note: these same tests are failing with the 1270-1194 patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T05:14:07.725+0000","updated":"2011-11-05T05:14:07.725+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144590","id":"13144590","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Camille, we should remove readyToStart, but it is still used in Zab1_0Test, which uses it to check that the leader is ready and able to receive connections. We can most probably check this some other way, but I suggest to leave this for now and fix later.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T05:16:14.938+0000","updated":"2011-11-05T05:16:14.938+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144595","id":"13144595","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"+1 on Alex's suggestion. Lets stick to minimal changes for now :).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T05:20:07.033+0000","updated":"2011-11-05T05:20:07.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144601","id":"13144601","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"without my clientbase junk","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T05:39:59.210+0000","updated":"2011-11-05T05:39:59.210+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144602","id":"13144602","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"branch 3.4 version of clean patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T05:53:32.669+0000","updated":"2011-11-05T05:53:32.669+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144611","id":"13144611","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Just committed Camille's final patch to trunk and 3.4. Thanks to Camille/Flavio/Alex/Pat on this! A true community patch :). ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T06:36:59.699+0000","updated":"2011-11-05T06:36:59.699+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144633","id":"13144633","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Sorry for missing part of the fun.\n\nAlex, Thanks for spotting the duplicate, that was a great catch. I'm not convinced that your patch completely solves the problem, though. LearnerHandler sends NEWLEADER concurrently with the leader adding NEWLEADER to outstandingRequests, so even fixing the barriers as you did does not prevent the race I mentioned above, I think.\n\nI must say that I didn't find my proposed patch very elegant, but I'm not entirely sure that yours covers all cases, so let me know what you think.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-05T08:54:07.897+0000","updated":"2011-11-05T08:54:07.897+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144651","id":"13144651","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in ZooKeeper-trunk #1356 (See [https://builds.apache.org/job/ZooKeeper-trunk/1356/])\n    ZOOKEEPER-1270. testEarlyLeaderAbandonment failing intermittently, quorum formed, no serving. (Flavio, Camille and Alexander Shraer via mahadev)\n\nmahadev : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1197891\nFiles : \n* /zookeeper/trunk/CHANGES.txt\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/Leader.java\n* /zookeeper/trunk/src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java\n* /zookeeper/trunk/src/java/test/org/apache/zookeeper/server/quorum/Zab1_0Test.java\n* /zookeeper/trunk/src/java/test/org/apache/zookeeper/test/ClientBase.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-05T10:56:20.212+0000","updated":"2011-11-05T10:56:20.212+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144658","id":"13144658","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Flavio,\n\nLearnerHandler sends NEWLEADER messages after running waitForEpochAck.\nThe patch makes sure that waitForEpochAck does not return until the leader also runs it. Leader runs waitForEpochAck after inserting NEWLEADER message into the outstandingProposals.\n\nAlex","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-05T11:27:04.037+0000","updated":"2011-11-05T11:27:04.037+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13144662","id":"13144662","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Sounds right, thanks for the clarification.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-05T11:46:06.183+0000","updated":"2011-11-05T11:46:06.183+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12529326/comment/13145929","id":"13145929","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"this is still failing on 3.4 branch (incl this latest patch).\n\nSee testEarlyLeaderAbandonment5.txt.gz (attached).\n\nNotice now that the stat is continually run, without the clients attempting to connect to the server. The test doesn't seem to be cutting over from detecting the service is up to starting the clients.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-07T23:20:31.449+0000","updated":"2011-11-07T23:20:31.449+0000"}],"maxResults":55,"total":55,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1270/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05y8n:"}}