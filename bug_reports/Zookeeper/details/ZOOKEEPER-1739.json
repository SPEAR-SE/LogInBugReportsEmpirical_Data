{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12662781","self":"https://issues.apache.org/jira/rest/api/2/issue/12662781","key":"ZOOKEEPER-1739","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2013-08-09T10:50:16.835+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sun Aug 11 03:00:25 UTC 2013","customfield_12310420":"342783","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1739/watchers","watchCount":4,"isWatching":false},"created":"2013-08-09T04:29:19.800+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321883","id":"12321883","description":"Fix release against 3.4 branch","name":"3.4.5","archived":false,"released":true,"releaseDate":"2012-11-18"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qiaoqingjie","name":"qiaoqingjie","key":"qiaoqingjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"qingjie qiao","active":true,"timeZone":"Asia/Shanghai"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-08-11T03:01:38.096+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312378","id":"12312378","name":"leaderElection","description":"Leader election algorithm for ZooKeeper"}],"timeoriginalestimate":null,"description":"I am reading the trunk source code recently and find a thread-safe problem, but i'm not quite sure.\n\nin FastLeaderElection:\n\n{code}\nclass WorkerSender implements Runnable { \n    volatile boolean stop; \n    QuorumCnxManager manager; \n\n    WorkerSender(QuorumCnxManager manager){ \n        this.stop = false; \n        this.manager = manager; \n    } \n\n    public void run() {\n ...\n    }\n}\n\n...\n\nMessenger(QuorumCnxManager manager) {\n\n    this.ws = new WorkerSender(manager);\n\n    Thread t = new Thread(this.ws,\n            \"WorkerSender[myid=\" + self.getId() + \"]\");\n    t.setDaemon(true);\n    t.start();\n\n    this.wr = new WorkerReceiver(manager);\n\n    t = new Thread(this.wr,\n            \"WorkerReceiver[myid=\" + self.getId() + \"]\");\n    t.setDaemon(true);\n    t.start();\n}\n...\n{code}\n\nThe instance of WorkerSender is constructed in main thread, and its field manager is assigned , and it is used in another thread. The later thread may see that WorkerSender.manager is the default value null. The solution may be:\n(1) change\n{code} \nWorkerSender(QuorumCnxManager manager){ \n        this.stop = false; \n        this.manager = manager; \n} \n{code}\n\nto \n\n{code}\nWorkerSender(QuorumCnxManager manager){ \n\tthis.manager = manager; \n\tthis.stop = false; \n} \n{code}\n\nor(2)\nchange \n\n{code}\nQuorumCnxManager manager; \n{code}\n\nto \n\n{code}\nfinal QuorumCnxManager manager;\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12597320","id":"12597320","filename":"ZOOKEEPER-1739.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qiaoqingjie","name":"qiaoqingjie","key":"qiaoqingjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"qingjie qiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-08-11T03:01:38.094+0000","size":3741,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12597320/ZOOKEEPER-1739.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"343087","customfield_12312823":null,"summary":"thread safe bug in FastLeaderElection: instance of WorkerSender is not safe published, WorkerSender thread may see that WorkerSender.manager is the default value null","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qiaoqingjie","name":"qiaoqingjie","key":"qiaoqingjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"qingjie qiao","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qiaoqingjie","name":"qiaoqingjie","key":"qiaoqingjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"qingjie qiao","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12662781/comment/13734659","id":"13734659","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I'm a bit behind with my reviews, but this change seems trivial. Could you propose a patch, [~qiaoqingjie]?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-08-09T10:50:16.835+0000","updated":"2013-08-09T10:50:16.835+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12662781/comment/13736159","id":"13736159","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qiaoqingjie","name":"qiaoqingjie","key":"qiaoqingjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"qingjie qiao","active":true,"timeZone":"Asia/Shanghai"},"body":"Not sure if this is really a problem or we should just ignore this. If it is, threre are a lot more similar codes. Since I'm new to zk and haven't read all the codes, the patch may not cover all the codes with this problem.\n\nmake the workerPool visible to SelectorThread:\n{code}\nIndex: src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java\n===================================================================\n--- src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java\t(版本 1512570)\n+++ src/java/main/org/apache/zookeeper/server/NIOServerCnxnFactory.java\t(工作副本)\n@@ -722,11 +722,11 @@\n \n     @Override\n     public void start() {\n-        stopped = false;\n         if (workerPool == null) {\n             workerPool = new WorkerService(\n                 \"NIOWorker\", numWorkerThreads, false);\n         }\n+        stopped = false;\n         for(SelectorThread thread : selectorThreads) {\n             if (thread.getState() == Thread.State.NEW) {\n                 thread.start();\n{code}\n\nmake cnxTO visible to QuorumCnxManager.Listener thread, SendWorker's fields visible to SendWorker thread and RecvWorker's fields visible to RecvWorker:\n{code}\nIndex: src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java\n===================================================================\n--- src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java\t(版本 1512570)\n+++ src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java\t(工作副本)\n@@ -85,7 +85,7 @@\n      * Connection time out value in milliseconds \n      */\n     \n-    private int cnxTO = 5000;\n+    private volatile int cnxTO = 5000;\n     \n     /*\n      * Local IP address\n@@ -593,11 +593,11 @@\n      * one.\n      */\n     class SendWorker extends Thread {\n-        Long sid;\n-        Socket sock;\n+        final Long sid;\n+        final Socket sock;\n         RecvWorker recvWorker;\n         volatile boolean running = true;\n-        DataOutputStream dout;\n+        volatile DataOutputStream dout;\n \n         /**\n          * An instance of this thread receives messages to send\n@@ -747,10 +747,10 @@\n      * channel breaks, then removes itself from the pool of receivers.\n      */\n     class RecvWorker extends Thread {\n-        Long sid;\n-        Socket sock;\n+        final Long sid;\n+        final Socket sock;\n         volatile boolean running = true;\n-        DataInputStream din;\n+        volatile DataInputStream din;\n         final SendWorker sw;\n \n         RecvWorker(Socket sock, Long sid, SendWorker sw) {\n{code}\n\nmake manager visible to WorkerReceiver and WorkerSender thread:\n{code}\nIndex: src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java\n===================================================================\n--- src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java\t(版本 1512570)\n+++ src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java\t(工作副本)\n@@ -201,7 +201,7 @@\n \n         class WorkerReceiver implements Runnable {\n             volatile boolean stop;\n-            QuorumCnxManager manager;\n+            final QuorumCnxManager manager;\n \n             WorkerReceiver(QuorumCnxManager manager) {\n                 this.stop = false;\n@@ -410,7 +410,7 @@\n \n         class WorkerSender implements Runnable {\n             volatile boolean stop;\n-            QuorumCnxManager manager;\n+            final QuorumCnxManager manager;\n \n             WorkerSender(QuorumCnxManager manager){\n                 this.stop = false;\n{code}\n\nmake quorumVerifier visible to QuorumPeer thread and all initialized fields visible to QuorumPeer thread\n{code}\nIndex: src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java\n===================================================================\n--- src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java\t(版本 1512570)\n+++ src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java\t(工作副本)\n@@ -342,7 +342,7 @@\n      */\n \n     //last committed quorum verifier\n-    public QuorumVerifier quorumVerifier;\n+    public volatile QuorumVerifier quorumVerifier;\n     \n     //last proposed quorum verifier\n     public QuorumVerifier lastSeenQuorumVerifier = null;\n@@ -603,6 +603,7 @@\n         loadDataBase();\n         cnxnFactory.start();\n         startLeaderElection();\n+        running = true;\n         super.start();\n     }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qiaoqingjie","name":"qiaoqingjie","key":"qiaoqingjie","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"qingjie qiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-08-11T03:00:25.026+0000","updated":"2013-08-11T03:00:25.026+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1739/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1n45r:"}}