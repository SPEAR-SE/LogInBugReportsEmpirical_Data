{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12725531","self":"https://issues.apache.org/jira/rest/api/2/issue/12725531","key":"ZOOKEEPER-1955","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-07-05T01:23:11.996+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Nov 30 15:13:43 UTC 2015","customfield_12310420":"403690","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1955/watchers","watchCount":7,"isWatching":false},"created":"2014-07-04T22:30:02.541+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321883","id":"12321883","description":"Fix release against 3.4 branch","name":"3.4.5","archived":false,"released":true,"releaseDate":"2012-11-18"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-11-30T15:13:43.395+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"We have a 5 node zookeeper cluster that has been operating normally for several months.  Starting a few days ago, the entire cluster crashes a few times per day, all nodes at the exact same time.  We can't track down the exact issue, but deleting the snapshots and logs and restarting allows the cluster to come back up.  \n\nWe are running exhibitor to monitor the cluster.  \n\nIt appears that something bad gets into the logs, causing an EOFException and this cascades through the entire cluster:\n\n\n\n2014-07-04 12:55:26,328 [myid:1] - WARN  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:Follower@89] - Exception when following the leader\njava.io.EOFException\n        at java.io.DataInputStream.readInt(DataInputStream.java:375)\n        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)\n        at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83)\n        at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:108)\n        at org.apache.zookeeper.server.quorum.Learner.readPacket(Learner.java:152)\n        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:85)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:740)\n2014-07-04 12:55:26,328 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2181:Follower@166] - shutdown called\njava.lang.Exception: shutdown Follower\n        at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:166)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:744)\n\n\nThen the server dies, exhibitor tries to restart each node, and they all get stuck trying to replay the bad transaction, logging things like:\n \n\n2014-07-04 12:58:52,734 [myid:1] - INFO  [main:FileSnap@83] - Reading snapshot /var/lib/zookeeper/version-2/snapshot.300011fc0\n2014-07-04 12:58:52,896 [myid:1] - DEBUG [main:FileTxnLog$FileTxnIterator@575] - Created new input stream /var/lib/zookeeper/version-2/log.300000021\n2014-07-04 12:58:52,915 [myid:1] - DEBUG [main:FileTxnLog$FileTxnIterator@578] - Created new input archive /var/lib/zookeeper/version-2/log.300000021\n2014-07-04 12:59:25,870 [myid:1] - DEBUG [main:FileTxnLog$FileTxnIterator@618] - EOF excepton java.io.EOFException: Failed to read /var/lib/zookeeper/version-2/log.300000021\n2014-07-04 12:59:25,871 [myid:1] - DEBUG [main:FileTxnLog$FileTxnIterator@575] - Created new input stream /var/lib/zookeeper/version-2/log.300011fc2\n2014-07-04 12:59:25,872 [myid:1] - DEBUG [main:FileTxnLog$FileTxnIterator@578] - Created new input archive /var/lib/zookeeper/version-2/log.300011fc2\n2014-07-04 12:59:48,722 [myid:1] - DEBUG [main:FileTxnLog$FileTxnIterator@618] - EOF excepton java.io.EOFException: Failed to read /var/lib/zookeeper/version-2/log.300011fc2\n\nAnd the cluster is dead.  The only way we have found to recover is to delete all of the data and restart.\n\n[~fournc] Appreciate any assistance you can offer.  ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12654146","id":"12654146","filename":"snapshot","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=az","name":"az","key":"az","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Zimmerman","active":true,"timeZone":"America/Chicago"},"created":"2014-07-04T22:34:16.111+0000","size":6434165,"mimeType":"text/html","content":"https://issues.apache.org/jira/secure/attachment/12654146/snapshot"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"403733","customfield_12312823":null,"summary":"EOFException on Reading Snapshot","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=az","name":"az","key":"az","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Zimmerman","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=az","name":"az","key":"az","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Zimmerman","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12725531/comment/14052696","id":"14052696","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=az","name":"az","key":"az","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Zimmerman","active":true,"timeZone":"America/Chicago"},"body":"THis is an example of the snapshot file that a node was attempting to read before the EOF exception.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=az","name":"az","key":"az","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Zimmerman","active":true,"timeZone":"America/Chicago"},"created":"2014-07-04T22:34:16.115+0000","updated":"2014-07-04T22:34:16.115+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12725531/comment/14052747","id":"14052747","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"It looks like the problem may actually be in the log file, from your report:\n2014-07-04 12:58:52,896 [myid:1] - DEBUG [main:FileTxnLog$FileTxnIterator@575] - Created new input stream /var/lib/zookeeper/version-2/log.300000021\n2014-07-04 12:58:52,915 [myid:1] - DEBUG [main:FileTxnLog$FileTxnIterator@578] - Created new input archive /var/lib/zookeeper/version-2/log.300000021\n2014-07-04 12:59:25,870 [myid:1] - DEBUG [main:FileTxnLog$FileTxnIterator@618] - EOF excepton java.io.EOFException: Failed to read /var/lib/zookeeper/version-2/log.300000021\n\nI can load a ZK fine with the snapshot you've provided. Do you have the log file or other data?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2014-07-05T01:23:11.996+0000","updated":"2014-07-05T01:23:11.996+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12725531/comment/14055580","id":"14055580","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I've just made this comment on the user list, but we throw the exception at that point because we need to bytes for the crc computation right after:\n\n{noformat}\ntry {\n                long crcValue = ia.readLong(\"crcvalue\");\n                byte[] bytes = Util.readTxnBytes(ia);\n                // Since we preallocate, we define EOF to be an\n                if (bytes == null || bytes.length==0) {\n                    throw new EOFException(\"Failed to read \" + logFile);\n                }\n                // EOF or corrupted record\n                // validate CRC\n                Checksum crc = makeChecksumAlgorithm();\n                crc.update(bytes, 0, bytes.length);\n                if (crcValue != crc.getValue())\n                    throw new IOException(CRC_ERROR);\n                if (bytes == null || bytes.length == 0)\n                    return false;\n                hdr = new TxnHeader();\n                record = SerializeUtils.deserializeTxn(bytes, hdr);\n            } catch (EOFException e) {\n{noformat}\n\nI think one bug there is that we check again \"if (bytes == null || bytes.length == 0)\", but this doesn't seem to be related to you problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2014-07-08T21:43:35.331+0000","updated":"2014-07-08T21:43:35.331+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12725531/comment/15031895","id":"15031895","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyfj","name":"kellyfj","key":"kellyfj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Frank Kelly","active":true,"timeZone":"Etc/UTC"},"body":"I am seeing this too on ZooKeeper 3.4.6\n\n{noformat}\n2015-11-26 18:51:58,514 [myid:3] - ERROR [LearnerHandler-/54.172.221.124:57966:LearnerHandler@633] - Unexpected exception causing shutdown while sock still open\njava.net.SocketTimeoutException: Read timed out\n        at java.net.SocketInputStream.socketRead0(Native Method)\n        at java.net.SocketInputStream.socketRead(Unknown Source)\n        at java.net.SocketInputStream.read(Unknown Source)\n        at java.net.SocketInputStream.read(Unknown Source)\n        at java.io.BufferedInputStream.fill(Unknown Source)\n        at java.io.BufferedInputStream.read(Unknown Source)\n        at java.io.DataInputStream.readInt(Unknown Source)\n        at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)\n        at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83)\n        at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:103)\n        at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:546)\n2015-11-26 18:51:58,514 [myid:3] - WARN  [LearnerHandler-/54.172.221.124:57966:LearnerHandler@646] - ******* GOODBYE /54.172.221.124:57966 ********\n\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyfj","name":"kellyfj","key":"kellyfj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Frank Kelly","active":true,"timeZone":"Etc/UTC"},"created":"2015-11-30T15:00:36.161+0000","updated":"2015-11-30T15:00:36.161+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12725531/comment/15031928","id":"15031928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"[~kellyfj] I don't think it is the same issue, check the stack trace. In your case, it could be that you have a large snapshot to transfer and you need to increase the initLimit parameter.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2015-11-30T15:13:43.395+0000","updated":"2015-11-30T15:13:43.395+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1955/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1xh8f:"}}