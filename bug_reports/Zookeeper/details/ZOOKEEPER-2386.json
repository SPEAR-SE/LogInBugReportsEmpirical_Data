{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12948647","self":"https://issues.apache.org/jira/rest/api/2/issue/12948647","key":"ZOOKEEPER-2386","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-09-14T10:40:14.247+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Sep 14 10:40:14 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2386/watchers","watchCount":4,"isWatching":false},"created":"2016-03-10T03:11:25.889+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-09-14T10:40:14.247+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"Recently, we've observed a curious case where a quorum was not reached for days in a cluster of 3 nodes (zk0, zk1, zk2) and the middle node zk1 is unreachable from network. \n\nThe leader election happens, and both zk0 and zk2 starts the vote. Then each server sends notifications to every other server including itself. The problem is that, zk1 vm is unavailable, so when we are trying to open up a socket to connect to that server with socket timeout of 5 seconds, it delays the notification processing of the vote sent from zk2 to zk2 (itself). The vote eventually comes after 5 sec, but by that time, the follower (zk0) already converted to the follower state. On the follower state, the follower try to connect to leader 5 times with 1 second timeout (5 sec in total). Since the leader does not start its peer port for 5 seconds after the follower starts, the follower always times out connecting to the leader. This cycle is repeating for hours / days even after restarting the servers several times. \n\nI believe this is related to the default timeouts (5 sec socket timeout) and follower to leader connection timeout (5 tries with 1 second timeout). Only after setting the {{zookeeper.cnxTimeout}} to 1 second, the quorum was operating. \n\nMore logs coming shortly. \n\nzoo.cfg: \n{code}\nserver.3=zk2-hostname:2889:3889\nserver.2=zk1-hostname:2889:3889\nserver.1=zk0-hostname:2889:3889\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12792429","id":"12792429","filename":"zklogs.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-03-10T03:44:16.374+0000","size":23362,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12792429/zklogs.tar.gz"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Cannot achieve quorum when middle server (in a q of 3) is unreacable","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12948647/comment/15188620","id":"15188620","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"body":"Attaching relevant logs from two servers that are alive. As you can see, we keep cycling the leader election + timeout loop forever. zk2 is always the leader, and from that servers perspective each cycle of leader election takes 15 secs, while zk0 reports it around 30 sec. \n\nAgain, (I think) the issue is that the vote that the candidate does not send the votes in parallel, but serially. So zk2 as a candidate cannot cast a self vote until the request to zk1 timesouts which takes more than 5 seconds. By that time, the follower zk0 already gives up on the leader, and starts a new round. So there is actually a leader elected every ~30 seconds, but the quorum cannot operate still. \n\nzk0: \n{code}\n2016-01-27 23:30:15,293 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2182:Follower@63] - FOLLOWING - LEADER ELECTION TOOK - 31008\n2016-01-27 23:30:50,417 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2182:Follower@63] - FOLLOWING - LEADER ELECTION TOOK - 31112\n2016-01-27 23:31:25,326 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2182:Follower@63] - FOLLOWING - LEADER ELECTION TOOK - 30898\n2016-01-27 23:32:00,340 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2182:Follower@63] - FOLLOWING - LEADER ELECTION TOOK - 30997\n2016-01-27 23:32:35,365 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2182:Follower@63] - FOLLOWING - LEADER ELECTION TOOK - 31014\n2016-01-27 23:33:10,391 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2182:Follower@63] - FOLLOWING - LEADER ELECTION TOOK - 31014\n2016-01-27 23:33:45,485 [myid:1] - INFO  [QuorumPeer[myid=1]/0:0:0:0:0:0:0:0:2182:Follower@63] - FOLLOWING - LEADER ELECTION TOOK - 31082\n{code}\n\nzk2:\n{code}\n2016-01-27 23:30:20,080 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2182:Leader@358] - LEADING - LEADER ELECTION TOOK - 14816\n2016-01-27 23:30:55,407 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2182:Leader@358] - LEADING - LEADER ELECTION TOOK - 15324\n2016-01-27 23:31:30,314 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2182:Leader@358] - LEADING - LEADER ELECTION TOOK - 14904\n2016-01-27 23:32:05,327 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2182:Leader@358] - LEADING - LEADER ELECTION TOOK - 15010\n2016-01-27 23:32:40,353 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2182:Leader@358] - LEADING - LEADER ELECTION TOOK - 15023\n2016-01-27 23:33:15,179 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2182:Leader@358] - LEADING - LEADER ELECTION TOOK - 14823\n2016-01-27 23:33:50,476 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2182:Leader@358] - LEADING - LEADER ELECTION TOOK - 15294\n2016-01-27 23:34:25,234 [myid:3] - INFO  [QuorumPeer[myid=3]/0:0:0:0:0:0:0:0:2182:Leader@358] - LEADING - LEADER ELECTION TOOK - 14756\n20\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-03-10T03:44:16.380+0000","updated":"2016-03-10T03:44:16.380+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12948647/comment/15490096","id":"15490096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dernasherbrezon","name":"dernasherbrezon","key":"dernasherbrezon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dernasherbrezon&avatarId=23192","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dernasherbrezon&avatarId=23192","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dernasherbrezon&avatarId=23192","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dernasherbrezon&avatarId=23192"},"displayName":"Andrey","active":true,"timeZone":"Europe/London"},"body":"We are able to reproduce this issue on 3.4.6.\n\nSteps to reproduce should include unreachable host in configuration. \"123.123.123.123:1234\" should be fine.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dernasherbrezon","name":"dernasherbrezon","key":"dernasherbrezon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dernasherbrezon&avatarId=23192","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dernasherbrezon&avatarId=23192","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dernasherbrezon&avatarId=23192","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dernasherbrezon&avatarId=23192"},"displayName":"Andrey","active":true,"timeZone":"Europe/London"},"created":"2016-09-14T10:40:14.247+0000","updated":"2016-09-14T10:40:14.247+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2386/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2ufz3:"}}