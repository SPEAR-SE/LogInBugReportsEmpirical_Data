{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13206891","self":"https://issues.apache.org/jira/rest/api/2/issue/13206891","key":"ZOOKEEPER-3231","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2019-01-08T01:15:28.629+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jan 08 12:23:48 UTC 2019","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3231/watchers","watchCount":3,"isWatching":false},"created":"2018-12-29T04:05:28.971+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340141","id":"12340141","description":"Beta release against 3.5 branch","name":"3.5.4","archived":false,"released":true,"releaseDate":"2018-05-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342973","id":"12342973","description":"Fix release against 3.4 branch","name":"3.4.13","archived":false,"released":true,"releaseDate":"2018-07-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2019-01-08T12:32:55.851+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"I read the ZooKeeper source code, and I find the purge task use FileTxnSnapLog#findNRecentSnapshots to find snapshots, but the method does not check whether the snapshots are valid.\r\n\r\nConsider a worse case, a ZooKeeper server may have many invalid snapshots, and when a purge task begins, it will use the zxid in the last snapshot's name to purge old snapshots and transaction logs, then we may lost data. \r\n\r\nI think we should use FileSnap#findNValidSnapshots(int) instead of FileSnap#findNRecentSnapshots in FileTxnSnapLog#findNRecentSnapshots, but I am not sure.\r\n\r\n ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":" Purge task may lost data when we have many invalid snapshots.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13206891/comment/16736548","id":"16736548","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"body":"It might also make sense to more aggressively delete invalid snapshots (in the mode of ZOOKEEPER-3082). If its straightforward to identify and purge such files then we won't have to worry about deleting valid snapshots in order to preserve invalid snapshots.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"created":"2019-01-08T01:15:28.629+0000","updated":"2019-01-08T01:15:28.629+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13206891/comment/16737076","id":"16737076","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maoling","name":"maoling","key":"maoling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maoling&avatarId=32024","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maoling&avatarId=32024","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maoling&avatarId=32024","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maoling&avatarId=32024"},"displayName":"maoling","active":true,"timeZone":"Etc/UTC"},"body":"[~jiangjiafu]\r\n\r\ngood issue.yep!\r\nthe data-loss situation can only happen when the retained count of snapshots were all invalid(very unfortunately，little probability) and at that time,zk server took any new snapshots.\r\nthe specific source codes about the *restore* can be found in:\r\n{code:java}\r\nFileTxnSnapLog#restore--->snapLog.deserialize{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maoling","name":"maoling","key":"maoling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maoling&avatarId=32024","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maoling&avatarId=32024","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maoling&avatarId=32024","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maoling&avatarId=32024"},"displayName":"maoling","active":true,"timeZone":"Etc/UTC"},"created":"2019-01-08T12:23:48.277+0000","updated":"2019-01-08T12:23:48.277+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3231/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|u00du8:"}}