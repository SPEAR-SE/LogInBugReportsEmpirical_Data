{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12755231","self":"https://issues.apache.org/jira/rest/api/2/issue/12755231","key":"ZOOKEEPER-2081","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-10-27T00:33:55.912+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Oct 29 18:33:26 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2081/watchers","watchCount":13,"isWatching":false},"created":"2014-11-14T01:27:51.804+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12320172","id":"12320172","description":"Fix release against 3.3 branch","name":"3.3.6","archived":false,"released":true,"releaseDate":"2012-08-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-10-29T18:33:26.847+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312378","id":"12312378","name":"leaderElection","description":"Leader election algorithm for ZooKeeper"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312379","id":"12312379","name":"quorum","description":"Quorum determination for ZooKeeper"}],"timeoriginalestimate":null,"description":"I noticed a situation when one of our 3-node clusters on RHEL lost a machine due to PSU failure. The remaining two nodes failed to complete leader election and would continually restart the leader election process.\nRestarting the nodes would not help and they would reach the same exact state.\n\nThis was curious so I spent some time and managed to reproduce this on my local machine and found what looks like the main factor:\nWhen a node is unreachable (timeouts), this somehow causes the election process to get out of sync.  Once a leader is decided, the follower tries to connect to the leader only when the leader is not listening.\nThen the follower gives up and the process starts again ad infinitum.\n\nHow to reproduce on a local machine:\n\n1. Setup up a 3 node cluster of ZK.  Note we only need to set up 2 boxes since we'll just make the third unreachable:\n\nMyId 1:\n\nserver.1=MyMachine:2881:3881\nserver.2=<Put any IP that we can block>:2882:3882\nserver.3=MyMachine:2883:3883\n\nMyId 3:\n\nserver.1=MyMachine:2881:3881\nserver.2=<Put any IP that we can block>:2882:3882\nserver.3=MyMachine:2883:3883\n\nNow set up a blackhole route for the IP you choose (Mac OSX, Linux is similar):\n> route add -host <IP you selected> 127.0.0.1 -blackhole\n\nStart your 2 nodes.  They will never reach quorum.\n\nHowever, if I remove the blackhole route and just not start the 3rd instance (but the host is still reachable), it will work fine and quorum will be reached almost immediately.\n\nIt seems the difference between the “timeout” and a \"connection refused” makes all the difference somehow in the election process.\n\nI verified this behavior on 3.4.6 and 3.3.6.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12769588","id":"12769588","filename":"zk-1.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matan_a","name":"matan_a","key":"matan_a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matan","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-10-29T18:15:55.867+0000","size":120284,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12769588/zk-1.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12769589","id":"12769589","filename":"zk-3.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matan_a","name":"matan_a","key":"matan_a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matan","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-10-29T18:15:55.871+0000","size":87060,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12769589/zk-3.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Leader election cannot complete when a node is blackholed (unreachable) even when quorum is possible.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matan_a","name":"matan_a","key":"matan_a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matan","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matan_a","name":"matan_a","key":"matan_a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matan","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Verified on RHEL and Mac OS X.","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12755231/comment/14975427","id":"14975427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmvmware","name":"pmvmware","key":"pmvmware","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Powell Molleti","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Matan,\n\nDo you have logs that you could attach?. \n\nThanks\nPowell.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmvmware","name":"pmvmware","key":"pmvmware","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10432"},"displayName":"Powell Molleti","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-10-27T00:33:55.912+0000","updated":"2015-10-27T00:33:55.912+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12755231/comment/14980951","id":"14980951","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matan_a","name":"matan_a","key":"matan_a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matan","active":true,"timeZone":"America/Los_Angeles"},"body":"It's been a while so I tried this again on ZK 3.4.6 following the same steps I outlined above and it is consistent.  DEBUG logs are attached.\n\nNote that I used 88.198.26.2 as the dummy IP for this test that I blackholed.\n\nI'm interested to know if this is by design or actually an issue.\n\nThanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matan_a","name":"matan_a","key":"matan_a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matan","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-10-29T18:15:55.875+0000","updated":"2015-10-29T18:15:55.875+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12755231/comment/14980999","id":"14980999","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"this isn't surprising given the way we implement connections in QuorumCnxManager. I'd personally love to see a better implementation of that class using selectors and such. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2015-10-29T18:33:26.847+0000","updated":"2015-10-29T18:33:26.847+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2081/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i22cz3:"}}