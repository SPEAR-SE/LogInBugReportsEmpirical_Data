{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12731948","self":"https://issues.apache.org/jira/rest/api/2/issue/12731948","key":"ZOOKEEPER-2003","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-08-05T07:14:23.856+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Aug 05 17:49:35 UTC 2014","customfield_12310420":"409977","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2003/watchers","watchCount":4,"isWatching":false},"created":"2014-08-05T07:04:17.801+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-08-05T17:49:35.490+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"After studying the steps ZooKeeper takes to update the logs we found the following bug. The bug may not manifest in the current file system implementations, but it violates the POSIX recommendations and may be an issue in some file systems.\n\nLooking at the strace of zookeeper we see the following:\nmkdir(v)\ncreate(v/log)\nappend(v/log)\ntrunk(v/log)\nwrite(v/log) \nfdatasync(v/log)\n\nAlthough the data is fdatasynced to the log, the parent directory was never fsynced, consequently in case of a crash, the parent directory or the log file may be lost, as the parent directory and file metadata were never persisted on disk.\nTo be safe, both the log directory, and parent directory of the log directory should be fsynced as well.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"409971","customfield_12312823":null,"summary":"Missing fsync() on the logs parent directory","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=samera","name":"samera","key":"samera","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Samer Al-Kiswany","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=samera","name":"samera","key":"samera","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Samer Al-Kiswany","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12731948/comment/14085916","id":"14085916","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xieliang007","name":"xieliang007","key":"xieliang007","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10434","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10434","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10434","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10434"},"displayName":"Liang Xie","active":true,"timeZone":"Asia/Shanghai"},"body":"nice finding!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xieliang007","name":"xieliang007","key":"xieliang007","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10434","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10434","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10434","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10434"},"displayName":"Liang Xie","active":true,"timeZone":"Asia/Shanghai"},"created":"2014-08-05T07:14:23.856+0000","updated":"2014-08-05T07:14:23.856+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12731948/comment/14086132","id":"14086132","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I suppose this is because we force to disk with the metadata option set to false (FileTxnLog.commit):\n\n{noformat}\nlog.getChannel().force(false);\n{noformat}\n\nAre you suggesting that we force to disk with the metadata option set to true upon creating a new file? We do flush the BufferedOutputStream associated to the FileOutputStream, but that only flushes the buffer of BOS to FOS, my understanding of the documentation is that it doesn't induce a force.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2014-08-05T11:37:15.837+0000","updated":"2014-08-05T11:37:15.837+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12731948/comment/14086179","id":"14086179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xieliang007","name":"xieliang007","key":"xieliang007","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10434","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10434","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10434","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10434"},"displayName":"Liang Xie","active":true,"timeZone":"Asia/Shanghai"},"body":"Seems there's no JAVA api could do this,  one possible solution is JNI.\nps: It's still safe if using XFS:)   but really need a directory fsync w/ ext4, in theory.\n[~fpj], i think you missed Samer's point...\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xieliang007","name":"xieliang007","key":"xieliang007","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10434","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10434","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10434","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10434"},"displayName":"Liang Xie","active":true,"timeZone":"Asia/Shanghai"},"created":"2014-08-05T12:20:26.841+0000","updated":"2014-08-05T12:20:26.841+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12731948/comment/14086388","id":"14086388","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Fair enough, let's go into more detail here. According to the analysis in the description, I read two potential problems:\n\n- The directory data of a newly created directory isn't persisted to disk\n- A newly created log file isn't persisted as a directory entry\n\nBoth cases may lead to the loss of an otherwise persisted log file and they imply that we need to fsync the directory data. There is a third point that I believe is important, which is making sure that the metadata is updated when we pad the log file. \n\nThe fsync documentation says that we need to fsync the directory as well to make sure that the directory change is persisted to disk. You claim that it is not possible to do this in java, but I think that with Java 7 we can fsync directories, no?\n\nIt seems that there are two parts to this discussion. First, we need to understand to what extent this is really a problem in the current code. I must say that I haven't thought about this part of ZK in a while, so I don't have it entirely fresh. Second, assuming there is something to be fixed, we need to determine how to do it in Java.\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2014-08-05T15:38:39.768+0000","updated":"2014-08-05T15:38:39.768+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12731948/comment/14086534","id":"14086534","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. To be safe, both the log directory, and parent directory of the log directory should be fsynced as well.\n\nThat sounds like more than needed. We only need to fsync the parent directory when the logfile has *just been created*, every other append doesn't need an fsync of the parent dir (maybe you meant that, but the last statement seems to be overreaching).\n\nSee: http://www.quora.com/Linux/When-should-you-fsync-the-containing-directory-in-addition-to-the-file-itself","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-05T17:49:35.490+0000","updated":"2014-08-05T17:49:35.490+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2003/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1yjcn:"}}