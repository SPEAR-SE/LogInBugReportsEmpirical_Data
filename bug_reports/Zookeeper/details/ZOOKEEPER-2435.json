{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12973780","self":"https://issues.apache.org/jira/rest/api/2/issue/12973780","key":"ZOOKEEPER-2435","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/10004","id":"10004","description":"Not A Bug","name":"Not A Bug"},"customfield_12312322":null,"customfield_12310220":"2016-05-29T15:05:59.036+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jun 01 01:25:55 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_113077487_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2016-05-30T14:56:59.128+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2435/watchers","watchCount":2,"isWatching":false},"created":"2016-05-29T07:32:21.685+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-06-01T01:25:55.225+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312383","id":"12312383","name":"build","description":"Build issues for ZooKeeper"}],"timeoriginalestimate":null,"description":"Hi All, \n\nIn my projects, I use three ZooKeeper server as an ensemble:\nzk1 as a follower on 192.168.25.221,\nzk2 as a follower on 192.168.25.222,\nzk3 as the leader on 192.168.25.223.\nMy two programs using ZooKeepers C client run on 192.168.25.221 and 192.168.25.222.\n\nWhen watched the ZOO_CONNECTED_STATE, my program will use the zookeeper to obtain a lock do the following:\n1. Create a ZOO_EPHEMERAL | ZOO_SEQUENCE node under '/Lock/'.\n2. Call getChildren( ) on the '/Lock/' node.\n3. If the pathname created in step 1 has the lowest sequence number suffix, the program has the lock and do something,then release the lock simply delete the node created in step 1.\n4. The program calls exists() with the watch flag set on the lowest sequence number node.\n5. if exists( ) returns false, go to step 2. Otherwise, wait for a notification(ZOO_DELETED_EVENT) for the pathname from the previous step before going to step 2.\n\nWhen I stop a follower such as zk1/zk2, everything is ok, my programs on 192.168.25.221 and 192.168.25.222 do its work orderly under the lock's control.\n\nWhen I stop the leader such as zk3(I have restarted zk1/zk2), my program on 192.168.25.221 got the lock and release it normally, and my program on 192.168.25.222 detected existence of the node \ncreated by the program on 192.168.25.221, but keep waiting and can't receive the ZOO_DELETED_EVENT notification.\n\nDoes anyone else see the same problemï¼Ÿ\n\nPS:\n1. The attachment is the log of the zookeeper on 192.168.25.221 and 192.168.25.222 when I stop the leader on 192.168.25.223\n2. Actually I have other more programs using ZooKeepers C client run on 192.168.25.221, 192.168.25.222 and 192.168.25.223.\n3. The system time on 192.168.25.221 is slower 1 minute and 33 seconds than 192.168.25.222 and 192.168.25.223. so when I stop the leader, it's 2016-05-28 22:33:34 on 192.168.25.221 and 2016-05-28 22:35:07 on 192.168.25.222. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12806877","id":"12806877","filename":"zookeeper---221.out","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"created":"2016-05-29T07:35:56.006+0000","size":31644,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12806877/zookeeper---221.out"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12806876","id":"12806876","filename":"zookeeper---222.out","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"created":"2016-05-29T07:35:56.000+0000","size":31400,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12806876/zookeeper---222.out"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"miss event when the leader stop","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973780/comment/15305941","id":"15305941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Hi [~BourneHan], It isn't entirely clear to me what your program is doing. Do you execute steps 1-5 upon every connected event? Can you make sure that 192.168.25.222 is actually watching the correct znode? You can use the zkCli to check the status of znodes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-05-29T15:05:59.036+0000","updated":"2016-05-29T15:05:59.036+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973780/comment/15306160","id":"15306160","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"body":"Hi Flavio,\n\n Do you execute steps 1-5 upon every connected event? \n Yes. I used  zookeeper_init  to set watcher,  then when got a ZOO_SESSION_EVENT-ZOO_CONNECTED_STATE notification, my program will execute steps 1-5.\n\nCan you make sure that 192.168.25.222 is actually watching the correct znode?\nYes, from the log of my program I can see 192.168.25.222 is actually watching the lowest sequence number znode created by 192.168.25.221.\nActually, I use the steps 1-5 to obtain a distributed lock somewhere else, and everything is ok.\n\nYou can use the zkCli to check the status of znodes.\nFrom the zkCli, I can see: the lowest sequence number znode created by 192.168.25.221 have disappeared and the znode created by 192.168.25.222 exists.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"created":"2016-05-30T01:47:01.907+0000","updated":"2016-05-30T01:47:01.907+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973780/comment/15306738","id":"15306738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"body":"From http://www.ngdata.com/so-you-want-to-be-a-zookeeper/, I got:\nEach ZooKeeper handle (= ZooKeeper object instance) has one thread for dispatching the events to all the watchers.\nOne case to watch out for is not to do something which in itself might again wait for a ZooKeeper event. \n\nso this issue is not a bug, I close it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"created":"2016-05-30T14:56:59.159+0000","updated":"2016-05-30T14:56:59.159+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973780/comment/15306818","id":"15306818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"[~BourneHan] Thanks for reporting back. I understand that if you block the dispatcher thread, then you won't receive other events, but just to make sure I understand precisely what you're doing, you're blocking the default watcher upon receiving a sync connected event after the ensemble recovers from the leader crash?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-05-30T17:02:34.470+0000","updated":"2016-05-30T17:02:34.470+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973780/comment/15307124","id":"15307124","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"body":"Hi Flavio,\n\nyou're blocking the default watcher upon receiving a sync connected event after the ensemble recovers from the leader crash?\nyes. now I use a different thread to do the work upon receiving a sync connected event, and everything is ok.\n\nI wonder why all the zookeeper Clients will receive a sync connected event after the ensemble recovers from the leader crash and just some zookeeper Clients will receive a sync connected event after the follower crash?\n\nthank you.\n\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"created":"2016-05-31T02:50:49.982+0000","updated":"2016-05-31T02:50:49.982+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973780/comment/15307449","id":"15307449","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"bq. I wonder why all the zookeeper Clients will receive a sync connected event after the ensemble recovers from the leader crash and just some zookeeper Clients will receive a sync connected event after the follower crash?\n\nWhen the leader crashes, the remaining followers will go into leader election and will drop the existing connections to clients. The idea there is that clients have a chance to go look for another server that is either leading or following rather than being stuck with a server that is looking for a leader. Consequently, a leader crash affects all clients. It is different when a follower crashes, since it only affects the clients that were connected to it. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-05-31T08:41:18.996+0000","updated":"2016-05-31T08:41:18.996+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973780/comment/15309019","id":"15309019","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"body":"OK, I got it, thank you very much!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=BourneHan","name":"BourneHan","key":"bournehan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"BourneHan","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-01T01:25:55.225+0000","updated":"2016-06-01T01:25:55.225+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2435/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2ynvj:"}}