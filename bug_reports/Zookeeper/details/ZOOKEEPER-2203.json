{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12834917","self":"https://issues.apache.org/jira/rest/api/2/issue/12834917","key":"ZOOKEEPER-2203","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2015-06-16T18:16:28.828+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 16 18:16:28 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1176062058_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-06-16T18:17:18.275+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2203/watchers","watchCount":2,"isWatching":false},"created":"2015-06-03T03:36:16.266+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-06-16T18:17:18.315+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312378","id":"12312378","name":"leaderElection","description":"Leader election algorithm for ZooKeeper"}],"timeoriginalestimate":null,"description":"This sequence leads the ensemble to a split-brain state:\n * Start server 1 (config=1:participant, 2:participant, 3:participant)\n * Start server 2 (config=1:participant, 2:participant, 3:participant)\n * 1 and 2 believe 2 is the leader\n * Start server 3 (config=1:observer, 2:observer, 3:participant)\n * 3 believes 3 is the leader, although 1 and 2 still believe 2 is the leader\n\nSuch a split-brain ensemble is very unstable.\nZnodes can be lost easily:\n * Create some znodes on 2\n * Restart 1 and 2\n * 1, 2 and 3 can think 3 is the leader\n * znodes created on 2 are lost, as 1 and 2 sync with 3\n\n\nI consider this behavior as a bug and that ZK should fail gracefully if a participant is listed as an observer in the config.\n\nIn current implementation, ZK cannot detect such an invalid config, as FastLeaderElection.sendNotification() sends notifications to only voting members and hence there is no message from observers(1 and 2) to the new voter (3).\nI think FastLeaderElection.sendNotification() should send notifications to all the members and FastLeaderElection.Messenger.WorkerReceiver.run() should verify acks.\n\nAny thoughts?","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"multiple leaders can be elected when configs conflict","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":"ZOOKEEPER-368","environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12834917/comment/14571964","id":"14571964","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"body":"Comments imported from the former ticket ZOOKEEPER-2189\n\n----\n\n[~shralex] 31/May/15 19:44 GMT\n{panel}\nVerifying acks as proposed in this JIRA will not solve this issue. Acks from observers are not required to elect a leader. If standaloneenabled=false server 3 can be elected without seeing any other messages.\nAlso, suppose you wrote the wrong ports for the other servers ?\nIt seems that to fix such errors one needs some kind of config registry.\n{panel}\n\n----\n\n[~suda] 1/Jun/15 9:27 GMT\n{panel}\nHi [~shralex],\nThank you for the feedback.\nI understood we cannot solve the issue by verifying acks, \nbut could you tell me what config registry stands for?\n(something like \"discovery.etcd.io\" or Consul's Atlas integration?)\n{panel}\n\n----\n\n [~shralex] 3/Jun/15 21:45 GMT\n{panel}\nHi [~suda],\nOn second thought, although its not going to solve the specific scenario you describe, it may still be a good idea to add some check(s). For example, if a server receives a configuration from another server (in FastLeaderElection.java) with the same configuration version, the configuration itself must be identical. The check should only be for non-initial configs (see ZOOKEEPER-1783), so probably (rqv.getVersion() > 0x100000000 and rqv.getVersion() == curQV.getVersion()). \nIf you still think its a good idea, would you like to propose a patch ?\nRegarding the config registry, I didn't have any specific system in mind, perhaps others can advise. [~phunt] [~rgs]\nThanks,\nAlex\n{panel}\n\n----\n\n[~phunt] 3/Jun/15 4:59 GMT\n{panel}\nNot sure re config registry. What would that entail? Git? :)\n{panel}\n\n----\n\n[~hdeng] 3/Jun/15 5:05 GMT\n{panel}\nI think they are talking about a central registry to contain server list. Just like \"discovery.etcd.io\" or DMV...\nHowever, this is like asking the root of root. ZK is the root of knowledge for most distributed systems. Are we expecting a root for ZK too?\nAnyway, JIRA is moved to ZOOKEEPER-2203. Let's move discussion there. Do me a favor and let me clean up the mess caused by my mistake...\n{panel}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-06-04T01:48:16.401+0000","updated":"2015-06-04T01:48:16.401+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12834917/comment/14588500","id":"14588500","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"I propose to close this jira. The described issue is an expected behaviour -- server 3 is the only participant as far as it knows so it cannot wait for any info from the others that may just as well be down. If there is any proposal for a better bootstrapping method this is probably an \"improvement\" and not a bug and should have an appropriate Jira. If anyone objects, feel free to reopen.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-16T18:16:28.828+0000","updated":"2015-06-16T18:16:28.828+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2203/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2fk0f:"}}