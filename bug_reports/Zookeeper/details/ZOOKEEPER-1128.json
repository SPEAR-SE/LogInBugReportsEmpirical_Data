{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12514611","self":"https://issues.apache.org/jira/rest/api/2/issue/12514611","key":"ZOOKEEPER-1128","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-07-22T08:35:43.929+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jul 28 06:53:07 UTC 2011","customfield_12310420":"3988","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_721866509_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-07-28T01:21:03.432+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1128/watchers","watchCount":0,"isWatching":false},"created":"2011-07-19T16:49:56.952+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315482","id":"12315482","description":"Fix release against 3.3 branch","name":"3.3.3","archived":false,"released":true,"releaseDate":"2011-02-27"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yynil","name":"yynil","key":"yynil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yynil","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-03-03T01:35:29.783+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313246","id":"12313246","name":"recipes","description":"recipes implementations that reside in src/recipes. also could be used for recipe docs"}],"timeoriginalestimate":null,"description":"http://zookeeper.apache.org/doc/trunk/recipes.html\nThe current recipe for Lock has the wrong process.\nSpecifically, for the \n\"4. The client calls exists( ) with the watch flag set on the path in the lock directory with the next lowest sequence number.\"\nIt shouldn't be the \"the next lowest sequence number\". It should be the \"current lowest path\". \n\nIf you're gonna use \"the next lowest sequence number\", you'll never wait for the lock possession.\n\nThe following is the test code:\n\n{code:title=LockTest.java|borderStyle=solid}\n        ACL acl = new ACL(Perms.ALL, new Id(\"10.0.0.0/8\", \"1\"));\n        List<ACL> acls = new ArrayList<ACL>();\n        acls.add(acl);\n        String connectStr = \"localhost:2181\";\n        final Semaphore sem = new Semaphore(0);\n        ZooKeeper zooKeeper = new ZooKeeper(connectStr, 1000 * 30, new Watcher() {\n\n            @Override\n            public void process(WatchedEvent event) {\n                System.out.println(\"eventType:\" + event.getType());\n                System.out.println(\"keeperState:\" + event.getState());\n                if (event.getType() == Event.EventType.None) {\n                    if (event.getState() == Event.KeeperState.SyncConnected) {\n                        sem.release();\n                    }\n                }\n            }\n        });\n        System.out.println(\"state:\" + zooKeeper.getState());\n        System.out.println(\"Waiting for the state to be connected\");\n        try {\n            sem.acquire();\n        } catch (InterruptedException ex) {\n            ex.printStackTrace();\n        }\n        System.out.println(\"Now state:\" + zooKeeper.getState());\n\n        String directory = \"/_locknode_\";\n        Stat stat = zooKeeper.exists(directory, false);\n        if (stat == null) {\n            zooKeeper.create(directory, new byte[]{}, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);\n        }\n        String prefix = directory + \"/lock-\";\n        String path = zooKeeper.create(prefix, new byte[]{}, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);\n        System.out.println(\"Create the path for \" + path);\n        while (true) {\n            List<String> children = zooKeeper.getChildren(directory, false);\n            Collections.sort(children);\n            System.out.println(\"The whole lock size is \" + children.size());\n            String lowestPath = children.get(0);\n            DecimalFormat df = new DecimalFormat(\"0000000000\");\n            String currentSuffix = lowestPath.substring(\"lock-\".length());\n            System.out.println(\"CurrentSuffix is \" + currentSuffix);\n            int intIndex = Integer.parseInt(currentSuffix);\n\n            if (path.equals(directory + \"/\" + lowestPath)) {\n                //I've got the lock and release it\n                System.out.println(\"I've got the lock at \" + new Date());\n                System.out.println(\"next index is \" + intIndex);\n                Thread.sleep(10000);\n                System.out.println(\"After sleep 3 seconds, I'm gonna release the lock\");\n                zooKeeper.delete(path, -1);\n                break;\n            }\n            final Semaphore wakeupSem = new Semaphore(0);\n            stat = zooKeeper.exists(directory + \"/\" + lowestPath, new Watcher() {\n\n                @Override\n                public void process(WatchedEvent event) {\n                    System.out.println(\"Event is \" + event.getType());\n                    System.out.println(\"State is \" + event.getState());\n                    if (event.getType() == Event.EventType.NodeDeleted) {\n                        wakeupSem.release();\n                    }\n                }\n            });\n            if (stat != null) {\n                System.out.println(\"Waiting for the delete of \");\n                wakeupSem.acquire();\n            } else {\n                System.out.println(\"Continue to seek\");\n            }\n        }\n{code} ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12541753","id":"12541753","filename":"singulair.html","created":"2012-08-21T14:03:22.981+0000","size":5561,"mimeType":"text/html","content":"https://issues.apache.org/jira/secure/attachment/12541753/singulair.html"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32704","customfield_12312823":null,"summary":"Recipe wrong for Lock process.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yynil","name":"yynil","key":"yynil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yynil","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yynil","name":"yynil","key":"yynil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yynil","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12514611/comment/13069444","id":"13069444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"body":"While implementing the lock recipe, I interpreted \"the next lowest sequence number\" correctly. I feel this phrase is not ambiguous and don't need to correct it.\n\nAny suggestions?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lakshman","name":"lakshman","key":"lakshman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laxman","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-07-22T08:35:43.929+0000","updated":"2011-07-22T08:35:43.929+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12514611/comment/13071888","id":"13071888","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. It shouldn't be the \"the next lowest sequence number\". It should be the \"current lowest path\".\n\nthis seems incorrect to me as the intent is to eliminate a herd effect on write locking. Using the \"current lowest path\" would result in all waiting writers waking up each time the lock is free'd. By using the next lowest this doesn't happen\n\nA creates write-1 and holds lock\nB creates write-2, watches 1 (next lowest to it's own write-2)\nC creates write-3, watches 2\nA releases the lock\nB wakes up\nB releases lock\nC wakes up\n\nIf B drops out before A releases the lock C will wake up and see that A still has the lock.\n\nIs there a particular scenario that you can point out not handled here?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-07-27T17:47:49.127+0000","updated":"2011-07-27T17:47:49.127+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12514611/comment/13072135","id":"13072135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yynil","name":"yynil","key":"yynil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yynil","active":true,"timeZone":"Etc/UTC"},"body":"ops, I got it.\nI just misunderstood the term \"the next lowest sequence number\". \nIt means \"next\" to MY number while is not \"next\" to the current lock number.\nIt solves my problem and it's way better than \"current lock\" solution I'm using now.\n\nBut some more suggestion is to just add your comments here in the tutorial. I don't know if I'm the only one to misunderstand it. \n \n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yynil","name":"yynil","key":"yynil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yynil","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-28T01:15:10.654+0000","updated":"2011-07-28T01:15:10.654+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12514611/comment/13072136","id":"13072136","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yynil","name":"yynil","key":"yynil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yynil","active":true,"timeZone":"Etc/UTC"},"body":"With Hunt's comments, it's clear to me. I feel this issue resolved with the explanation. It will be good to add these comments to the tutorial to help the newbies like me. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yynil","name":"yynil","key":"yynil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yynil","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-28T01:21:03.440+0000","updated":"2011-07-28T01:21:03.440+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12514611/comment/13072213","id":"13072213","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Updating the docs to clarify this sounds reasonable to me. I'd encourage you to create a new jira for this (and a patch would be great too! :-) ). Perhaps as an example similar to what I gave in my comment? thanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-07-28T06:53:07.389+0000","updated":"2011-07-28T06:53:07.389+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1128/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05ylj:"}}