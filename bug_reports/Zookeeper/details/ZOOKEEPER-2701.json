{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13044456","self":"https://issues.apache.org/jira/rest/api/2/issue/13044456","key":"ZOOKEEPER-2701","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-06-26T16:44:35.945+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jul 16 07:56:40 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2701/watchers","watchCount":4,"isWatching":false},"created":"2017-02-20T06:22:56.126+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326517","id":"12326517","description":"Fix release against 3.4 branch","name":"3.4.8","archived":false,"released":true,"releaseDate":"2016-02-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334700","id":"12334700","description":"Fix release against 3.4 branch","name":"3.4.9","archived":false,"released":true,"releaseDate":"2016-09-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12338036","id":"12338036","description":"Fix release against 3.4 branch","name":"3.4.10","archived":false,"released":true,"releaseDate":"2017-03-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12339207","id":"12339207","description":"Fix release against 3.4 branch","name":"3.4.11","archived":false,"released":true,"releaseDate":"2017-11-09"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-07-16T07:56:40.514+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"Environment:\r\n I deploy ZooKeeper in a cluster of three nodes. Each node has three network interfaces(eth0, eth1, eth2).\r\n\r\nHostname is used instead of IP address in zoo.cfg, and quorumListenOnAllIPs=true\r\n\r\nProbleam:\r\n I start three ZooKeeper servers( node A, node B, and node C) one by one, \r\n when the leader election finishes, node B is the leader. \r\n Then I shutdown one network interface of node A by command \"ifdown eth0\". The ZooKeeper server on node A will lost connection to node B and node C. In my test, I will take about 20 minites that the ZooKeepr server of node A realizes the event and try to call the QuorumServer.recreateSocketAddress the resolve the hostname.\r\n\r\nI try to read the source code, and I find the code in\r\n{code:java|title=QuorumCnxManager.java:|borderStyle=solid}\r\n    class RecvWorker extends ZooKeeperThread {\r\n        Long sid;\r\n        Socket sock;\r\n        volatile boolean running = true;\r\n        final DataInputStream din;\r\n        final SendWorker sw;\r\n\r\n        RecvWorker(Socket sock, DataInputStream din, Long sid, SendWorker sw) {\r\n            super(\"RecvWorker:\" + sid);\r\n            this.sid = sid;\r\n            this.sock = sock;\r\n            this.sw = sw;\r\n            this.din = din;\r\n            try {\r\n                // OK to wait until socket disconnects while reading.\r\n                sock.setSoTimeout(0);\r\n            } catch (IOException e) {\r\n                LOG.error(\"Error while accessing socket for \" + sid, e);\r\n                closeSocket(sock);\r\n                running = false;\r\n            }\r\n        }\r\n       ...\r\n     }\r\n{code}\r\nI notice that the soTime is set to 0 in RecvWorker constructor. I think this is reasonable when the IP address of a ZooKeeper server never change, but considering that the IP address of each ZooKeeper server may change, maybe we should better set a timeout here.\r\n\r\nI think this isÂ a problem.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Timeout for RecvWorker is too long","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Centos6.5\nZooKeeper 3.4.8","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13044456/comment/16523964","id":"16523964","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomaslee","name":"thomaslee","key":"thomaslee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tom Lee","active":true,"timeZone":"Etc/GMT+8"},"body":"Not entirely sure our symptoms were exactly the same as [~jiangjiafu], but believe we were bitten by the `setSoTimeout(0)` thing too (we're running 3.4.11). Still trying to work out the exact circumstances that cause the issue to occur, but I suspect it's something like:\r\n # a NIC intermittently drops out & recovers quickly on a follower.\r\n # #1 is enough to cause socket writes to fail in such a way that Linux packet retransmission + exponential backoff foo kicks.\r\n # the follower attempts to rejoin the cluster, but is unable to due to some combination of the above failing write(s) and rejecting new inbound connections from other members of the quorum because \"There is already a connection for server X\".\r\n # roughly 15-16 minutes later, Linux detects the connection is dead after exhausting packet retransmission retries & forces the connections closed.\r\n # #4 allows new inbound connections, socket writes start succeeding, the follower rejoins the quorum and everything is great again.\r\n\r\nThis prevents the follower from rejoining the quorum, which obviously isn't great. Given that, this is a little worse than a \"Minor\" issue when it happens IMO â if you're unlucky this could happen across multiple machines at the same time & easily lead to quorum loss.\r\n\r\nI may not have the exact details down, but it's _something_ like that. This issue has been occurring regularly across multiple clusters we've got running in EC2.\r\n\r\nIf it's useful to anybody playing along at home: we're experimenting with [tcp_retries2|https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt] to work around the issue at a system level. The default behavior in our setup (which from a quick google seems to be pretty standard) is to retry 15 times with up to a 2 minute delay between retries for a total of 15-16 minutes â seems safe to be a bit more aggressive given our ZK hosts are all in the same EC2 region. I've seen some suggestions of folks going with 3 retries, but we're being a bit more conservative & going with 5 for now, which should let us detect dead connections within a few seconds.\r\n\r\nÂ ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomaslee","name":"thomaslee","key":"thomaslee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tom Lee","active":true,"timeZone":"Etc/GMT+8"},"created":"2018-06-26T16:44:35.945+0000","updated":"2018-06-26T16:44:35.945+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13044456/comment/16544897","id":"16544897","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"body":"I remove the following code:\r\n            try {                // OK to wait until socket disconnects while reading.                sock.setSoTimeout(0);\r\n            } catch (IOException e) {\r\n                LOG.error(\"Error while accessing socket for \" + sid, e);\r\n                closeSocket(sock);\r\n                running = false;\r\n            }\r\nÂ \r\n\r\nAnd I find it works fine in my test environment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2018-07-16T07:33:25.347+0000","updated":"2018-07-16T07:33:25.347+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13044456/comment/16544911","id":"16544911","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomaslee","name":"thomaslee","key":"thomaslee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tom Lee","active":true,"timeZone":"Etc/GMT+8"},"body":"I can't speak to whether that solution is correct (suspect it's likely more complicated than simply removing the code that modifies the read timeout for all sorts of reasons), but I can imagine how the read timeout firing may address some of the symptoms by forcing the socket closed & short-circuiting the OS-level retransmission guff.\r\n\r\nWhatever the outcome, thanks for posting this bug! :)Â It was very helpful for tracking down what was going on & helped us nail down our own system-level work-around (the tcp_retries2 thing seems to work great)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomaslee","name":"thomaslee","key":"thomaslee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tom Lee","active":true,"timeZone":"Etc/GMT+8"},"created":"2018-07-16T07:48:47.733+0000","updated":"2018-07-16T07:48:47.733+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13044456/comment/16544918","id":"16544918","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"body":"I read the source code ofÂ  ZooKeeper 3.4.12, and I find the SendWorker or RecvWorker will be finished when an IOExceptionÂ  happends.\r\n\r\nWhen network problems happen, the OS may or may not discover the dead connection in time,Â  especially when the socket timeout is infinity.Â  This will lead to problem thatÂ ZooKeeper take *several*Â  minutes to elect new leader.\r\n\r\nÂ \r\n\r\nÂ ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2018-07-16T07:56:40.514+0000","updated":"2018-07-16T07:56:40.514+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2701/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3ab9r:"}}