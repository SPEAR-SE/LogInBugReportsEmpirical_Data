{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13204989","self":"https://issues.apache.org/jira/rest/api/2/issue/13204989","key":"ZOOKEEPER-3218","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":600,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":600,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-12-24T14:58:17.299+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Dec 26 20:54:26 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3218/watchers","watchCount":3,"isWatching":false},"created":"2018-12-17T20:55:57.277+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["pull-request-available"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2019-01-11T00:08:20.352+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"two participants、one observer，zkclient connect to observer。\r\n\r\nThen，close the two participants，the zookeeper server cloesed\r\n\r\nTen seconds later，reopen the two participants，and leader selected\r\n\r\n----------------------------------------------------------------------------\r\n\r\nBut the observer can't connect to the new leader immediately。Because in lookForLeader, the observer use blockingQueue(recvqueue)  to offer/poll notifications，when the recvqueue is empty，poll from recvqueue will be blocked，and timeout is 200ms，400ms，800ms....60s。\r\n\r\nFor example，09:59:59 observer poll notification，recvqueue was empty and timeout was 60s；10:00:00 two participants reopened and reselected；10:00:59 observer polled notification，connected to the new leader\r\n\r\nBut the maxSessionTimeout default to 40s。The session expired\r\n\r\n-----------------------------------------------------------------------------\r\n\r\nPlease improve it：observer should connect to the new leader as soon as possible","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"10m","remainingEstimateSeconds":0,"timeSpentSeconds":600},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"zk server reopened，the interval for observer connect to the new leader is too long，then session expired","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=q_zero","name":"q_zero","key":"q_zero","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangoofy","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=q_zero","name":"q_zero","key":"q_zero","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"yangoofy","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":600,"total":600,"percent":100},"customfield_12311024":null,"environment":"win7 32bits\r\n\r\nzookeeper 3.4.6、3.4.13","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":600,"total":600,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13204989/comment/16728423","id":"16728423","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maoling","name":"maoling","key":"maoling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maoling&avatarId=32024","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maoling&avatarId=32024","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maoling&avatarId=32024","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maoling&avatarId=32024"},"displayName":"maoling","active":true,"timeZone":"Etc/UTC"},"body":"[~q_zero]\r\n\r\nexcept increasing the *maxSessionTimeout*, Do you hava any good idea?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maoling","name":"maoling","key":"maoling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maoling&avatarId=32024","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maoling&avatarId=32024","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maoling&avatarId=32024","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maoling&avatarId=32024"},"displayName":"maoling","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-24T14:58:17.299+0000","updated":"2018-12-24T14:58:17.299+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13204989/comment/16729186","id":"16729186","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"body":"We had similar issues which we addressed by making the polling interval configurable. Attaching our patch to this issue (it adds \"zookeeper.fastleader.minNotificationInterval\").\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-26T20:54:26.672+0000","updated":"2018-12-26T20:54:26.672+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3218/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":1,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13204989/worklog/184021","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"lvfangmin commented on pull request #747: ZOOKEEPER-3218: zk server reopened，the interval for observer connect …\nURL: https://github.com/apache/zookeeper/pull/747#discussion_r246966748\n \n \n\n ##########\n File path: zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/FastLeaderElection.java\n ##########\n @@ -68,7 +68,34 @@\n      * the system up again after long partitions. Currently 60 seconds.\n      */\n \n-    final static int maxNotificationInterval = 60000;\n+    private static int maxNotificationInterval = 60000;\n+\n+    /**\n+     * Lower bound for notification check. The observer don't need to use\n+     * the same lower bound as participant members\n+     */\n+    private static int minNotificationInterval = finalizeWait;\n+\n+    /**\n+     * Minimum notification interval, default is equal to finalizeWait\n+     */\n+    public static final String MIN_NOTIFICATION_INTERVAL =\n+            \"zookeeper.fastleader.minNotificationInterval\";\n+\n+    /**\n+     * Maximum notification interval, default is 60s\n+     */\n+    public static final String MAX_NOTIFICATION_INTERVAL =\n+            \"zookeeper.fastleader.maxNotificationInterval\";\n+\n+    static {\n+        minNotificationInterval = Integer.getInteger(MIN_NOTIFICATION_INTERVAL,\n+                minNotificationInterval);\n \n Review comment:\n   Please use the {} logging format.\n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n","created":"2019-01-11T00:08:20.349+0000","updated":"2019-01-11T00:08:20.349+0000","started":"2019-01-11T00:08:20.348+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"184021","issueId":"13204989"}]},"customfield_12311820":"0|u002cw:"}}