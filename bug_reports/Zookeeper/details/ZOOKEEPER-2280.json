{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12895299","self":"https://issues.apache.org/jira/rest/api/2/issue/12895299","key":"ZOOKEEPER-2280","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343268","id":"12343268","description":"Beta release against 3.5 branch","name":"3.5.5","archived":false,"released":false}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-09-28T01:11:58.091+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Mar 27 19:31:01 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2280/watchers","watchCount":7,"isWatching":false},"created":"2015-09-22T01:13:24.051+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326786","id":"12326786","description":"Alpha release against 3.5 branch","name":"3.5.1","archived":false,"released":true,"releaseDate":"2015-09-02"}],"issuelinks":[{"id":"12442766","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12442766","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"outwardIssue":{"id":"12851300","key":"ZOOKEEPER-2238","self":"https://issues.apache.org/jira/rest/api/2/issue/12851300","fields":{"summary":"Support limiting the maximum number of connections/clients to a zookeeper server.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12499007","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12499007","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"13059096","key":"ZOOKEEPER-2739","self":"https://issues.apache.org/jira/rest/api/2/issue/13059096","fields":{"summary":"maxClientCnxns not working in NettyServerCnxnFactory","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12477148","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12477148","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"12983431","key":"ZOOKEEPER-2454","self":"https://issues.apache.org/jira/rest/api/2/issue/12983431","fields":{"summary":"Limit Connection Count based on User","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21141&avatarType=issuetype","name":"New Feature","subtask":false,"avatarId":21141}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-10T20:09:03.281+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"Even though NettyServerCnxnFactory has maxClientCnxns (default to 60) it doesn't enforce this limit in the code.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12764119","id":"12764119","filename":"ZOOKEEPER-2280.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"created":"2015-09-28T22:06:24.661+0000","size":8043,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12764119/ZOOKEEPER-2280.2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12762626","id":"12762626","filename":"ZOOKEEPER-2280.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"created":"2015-09-28T00:53:41.438+0000","size":6766,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12762626/ZOOKEEPER-2280.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"NettyServerCnxnFactory doesn't honor maxClientCnxns param","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/14909948","id":"14909948","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"body":"Submitting a first cut to review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"created":"2015-09-28T00:53:41.444+0000","updated":"2015-09-28T00:53:41.444+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/14909955","id":"14909955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12762626/ZOOKEEPER-2280.patch\n  against trunk revision 1705482.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    -1 findbugs.  The patch appears to introduce 2 new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2887//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2887//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2887//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-28T01:11:58.091+0000","updated":"2015-09-28T01:11:58.091+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/14909960","id":"14909960","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the patch [~eribeiro]. A few nits:\n\nIn:\n\n{code}\n+                LOG.error(\"Too many connections from \" + addr + \" - max is \" + maxClientCnxns);\n{code}\n\ncan we please us interpolation ({}) instead of concatenation (+)?\n\nAfter that line, in:\n\n{code}\n+                cnxn.close();\n+                ctx.getChannel().close().awaitUninterruptibly();\n{code}\n\nCan any of that throw anything? If so, should we - silently - catch that and ignore?\n\nIn getClientCnxnCount:\n\n{code}\n+            if (s == null) return 0;\n+                return s.size();\n{code}\n\nyou can do it in one line (or use braces if you want multiple lines):\n\n{code}\nreturn s == null ? 0 : s.size();\n{code}\n\nIn testMaxClientConnections() a small nit:\n\n{code}\n+    @Test(timeout = 40000)\n+         public void testMaxClientConnections() throws Exception {\n{code}\n\nwith indentation.\n\nIn that file as well, lets try not to sleep:\n\n{code}\n+            TestableZooKeeper[] clients = new TestableZooKeeper[CLIENTS];\n+            for (int i = 0; i < CLIENTS; i++) {\n+                clients[i] = new TestableZooKeeper(\"127.0.0.1:\" + CLIENT_PORT, 3000, new CountdownWatcher());\n+            }\n+\n+            Thread.sleep(5000);\n+\n+            assertEquals(MAX_CLIENT_CONN, scf.getNumAliveConnections());\n{code}\n\nI guess you are sleeping to wait for the clients[] to be connnected? Calling waitForConnected for each would a worse, so how about implementing a Watcher that counts the KeeperState.SyncConnected events seen. And then you can wait for that watcher to reach CLIENTS.\n\nSuper nit, in:\n\n{code}\n+        }\n+        finally {\n+            scf.shutdown();\n+            zks.shutdown();\n+        }\n{code}\n\nclosing curly brace and finally in the same line pls (and ditto in testConnections()), i.e.:\n\n{code}\n} finally {\n  scf.shutdown();\n  zks.shutdown();\n}\n{code}\n\nFinally, testConnections() and testMaxConnections() are pretty much the same except one asserts MAX_CLIENT_CONN == connected and the other one asserts CLIENTS == connected. Can we put the body of these tests in a helper (i.e.: testConns) and just call it with the limit we want to check?\n\nThanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-09-28T01:16:00.764+0000","updated":"2015-09-28T01:16:00.764+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/14909975","id":"14909975","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user eribeiro opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/46\n\n    ZOOKEEPER-2280: NettyServerCnxnFactory doesn't honor maxClientCnxns p…\n\n    …aram\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/eribeiro/zookeeper ZOOKEEPER-2280\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/46.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #46\n    \n----\ncommit d430e1c2dbdf774177fcd8f96d014b28435d1a94\nAuthor: Edward Ribeiro <edward.ribeiro@gmail.com>\nDate:   2015-09-28T01:55:36Z\n\n    ZOOKEEPER-2280: NettyServerCnxnFactory doesn't honor maxClientCnxns param\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-28T02:04:08.678+0000","updated":"2015-09-28T02:04:08.678+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/14910000","id":"14910000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"body":"Hi [~rgs], thanks for the review. I addressed your review points.\n\n{quote}\n    cnxn.close();\n   ctx.getChannel().close().awaitUninterruptibly();\n\nCan any of that throw anything? If so, should we - silently - catch that and ignore?\n{quote}\n\n*Afaik, it doesn't throw anything but I am gonna double check that asap!*\n\n{{NIOServerCnxnFactory}} throws an exception when the connection is refused. Throwing an exception in {{NettyServerCnxnFactory}} would still let the connection proceed, so I opted for explicitly close the connection and log the error. _Please_, I would like to hear from you guys ([~phunt]?) if this is the right way of doing so...\n\nI implemented the Watcher to keep track of the connections with a CountDownLatch, but the initial value of this CountDownLatch has to be the max number of accepted connections, because otherwise the Thread will hang (as the patch refuses connections beyond that limit). \n\nFinally, I have solved two Findbugs issues that were created when I changed {{ipMap}} in {{NettyServerCnxnFactory}} from {{Map}} to a  {{ConcurrentMap}}. Please, let me know what you think. You can see all those changes on the github PR above. Cheers!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"created":"2015-09-28T03:40:58.545+0000","updated":"2015-09-28T03:40:58.545+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/14910027","id":"14910027","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"The PR looks great [~eribeiro]! Added just two more nits about style and we are good to go.\n\nCan you squash it all into 1 patch and upload it here so that Jenkins can run? I'll merge it after that passes. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-09-28T04:31:39.168+0000","updated":"2015-09-28T04:31:39.168+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/14934163","id":"14934163","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"body":"Hi [~rgs], addressed your review comments, so I am uploading a new version of the patch. _Please_, Let me know if I miss something. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"created":"2015-09-28T22:06:24.665+0000","updated":"2015-09-28T22:06:24.665+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/14934294","id":"14934294","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12764119/ZOOKEEPER-2280.2.patch\n  against trunk revision 1705482.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2897//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2897//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2897//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-28T23:05:20.710+0000","updated":"2015-09-28T23:05:20.710+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15413224","id":"15413224","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12764119/ZOOKEEPER-2280.2.patch\n  against trunk revision 1755379.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3339//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3339//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3339//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-09T08:51:13.794+0000","updated":"2016-08-09T08:51:13.794+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15416176","id":"15416176","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/46\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-10T23:01:49.266+0000","updated":"2016-08-10T23:01:49.266+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15416368","id":"15416368","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user eribeiro opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/77\n\n    ZOOKEEPER-2280: NettyServerCnxnFactory doesn't honor maxClientCnxns p…\n\n    …aram\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/eribeiro/zookeeper ZOOKEEPER-2280\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/77.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #77\n    \n----\ncommit 59f4d58640190773722d2c6afd56aa60703c934c\nAuthor: Edward Ribeiro <edward.ribeiro@gmail.com>\nDate:   2015-09-28T01:55:36Z\n\n    ZOOKEEPER-2280: NettyServerCnxnFactory doesn't honor maxClientCnxns param\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-11T02:05:05.220+0000","updated":"2016-08-11T02:05:05.220+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15416946","id":"15416946","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"Hi [~eribeiro], I verified the patch https://github.com/apache/zookeeper/pull/77.patch. Basic Functionality works fine, it limits the number of the client connections based on configured value. But there is problem with the default value.\nwhat is the purpose of {{int maxClientCnxns = -1;}}. Do you want to disable maxClientCnxns feature in NettyServerCnxnFactory by default ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-08-11T09:32:13.189+0000","updated":"2016-08-11T09:32:13.189+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15416968","id":"15416968","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"body":"Yup. This was one of my latest changes, but I will  revert it to its previous value (60).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"created":"2016-08-11T09:59:45.695+0000","updated":"2016-08-11T09:59:45.695+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15416980","id":"15416980","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"variable maxClientCnxns is common between  NettyServerCnxnFactory and NIOServerCnxnFactory.\nI think we should move  maxClientCnxns to ServerCnxnFactory from NettyServerCnxnFactory and NIOServerCnxnFactory","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-08-11T10:11:20.335+0000","updated":"2016-08-11T10:11:20.335+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15416983","id":"15416983","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"body":"Agree, sounds very nice to do so.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"created":"2016-08-11T10:14:55.076+0000","updated":"2016-08-11T10:14:55.076+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15512757","id":"15512757","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks for the patch [~eribeiro]. I've left some comments in your PR #77. It also sounds like you need to rebase the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-09-22T09:34:32.837+0000","updated":"2016-09-22T09:34:32.837+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15941557","id":"15941557","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user eribeiro opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/208\n\n    ZOOKEEPER-2280: NettyServerCnxnFactory doesn't implement maxClientCnxns\n\n    \n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/eribeiro/zookeeper ZOOKEEPER-2280\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/208.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #208\n    \n----\ncommit ceaa5a2f0cf851620a6e61a84e597d30d42da131\nAuthor: Edward Ribeiro <edward.ribeiro@gmail.com>\nDate:   2017-03-25T03:59:12Z\n\n    ZOOKEEPER-2280: NettyServerCnxnFactory doesn't implement maxClientCnxns\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-25T04:14:14.847+0000","updated":"2017-03-25T04:14:14.847+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15941558","id":"15941558","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/77\n  \n    Closing this PR as the patch has moved to https://github.com/apache/zookeeper/pull/208 (still needs to address review comments tough). \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-25T04:15:03.213+0000","updated":"2017-03-25T04:15:03.213+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15941559","id":"15941559","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/77\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-25T04:15:03.907+0000","updated":"2017-03-25T04:15:03.907+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15941562","id":"15941562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108027783\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -109,6 +110,20 @@ public void channelConnected(ChannelHandlerContext ctx,\n                         zkServer, NettyServerCnxnFactory.this);\n                 ctx.setAttachment(cnxn);\n     \n    +            InetAddress addr = ((InetSocketAddress)cnxn.channel.getRemoteAddress()).getAddress();\n    +            Set<NettyServerCnxn> s = ipMap.get(addr);\n    +            if (s != null) {\n    +                synchronized (s) {\n    +                    int cnxncount = s.size();\n    +                    if (maxClientCnxns > 0 && cnxncount >= maxClientCnxns) {\n    +                        LOG.warn(\"Closed new connection from address {} ({} connections established) - max is {}\",\n    +                                addr, cnxncount, maxClientCnxns);\n    +                        cnxn.close();\n    +                        ctx.getChannel().close().awaitUninterruptibly();\n    --- End diff --\n    \n    TODO: double-check that this is the right order of closing cnxn and channel\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-25T04:29:56.488+0000","updated":"2017-03-25T04:29:56.488+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15941563","id":"15941563","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108027802\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java ---\n    @@ -100,11 +101,15 @@ public void close() {\n                             + Long.toHexString(sessionId));\n                 }\n     \n    -            synchronized (factory.ipMap) {\n    -                Set<NettyServerCnxn> s =\n    -                    factory.ipMap.get(((InetSocketAddress)channel\n    -                            .getRemoteAddress()).getAddress());\n    -                s.remove(this);\n    +            InetAddress address = ((InetSocketAddress) channel.getRemoteAddress()).getAddress();\n    +            Set<NettyServerCnxn> s = factory.ipMap.get(address);\n    --- End diff --\n    \n    TODO: \"This management of the ipMap looks like something that should be done by the factory, not the connection. should we move this logic to the factory?\"\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-25T04:29:56.498+0000","updated":"2017-03-25T04:29:56.498+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15941565","id":"15941565","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/480//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/480//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/480//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-25T04:33:18.611+0000","updated":"2017-03-25T04:33:18.611+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15941570","id":"15941570","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/481//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/481//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/481//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-25T04:43:33.527+0000","updated":"2017-03-25T04:43:33.527+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15941585","id":"15941585","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user vincentpoon commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108028137\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java ---\n    @@ -100,11 +101,15 @@ public void close() {\n                             + Long.toHexString(sessionId));\n                 }\n     \n    -            synchronized (factory.ipMap) {\n    -                Set<NettyServerCnxn> s =\n    -                    factory.ipMap.get(((InetSocketAddress)channel\n    -                            .getRemoteAddress()).getAddress());\n    -                s.remove(this);\n    +            InetAddress address = ((InetSocketAddress) channel.getRemoteAddress()).getAddress();\n    +            Set<NettyServerCnxn> s = factory.ipMap.get(address);\n    +            if (s != null) {\n    +                synchronized (s) {\n    --- End diff --\n    \n    Do you need the synchronized here if you're using Collections.synchronizedSet already?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-25T05:18:04.275+0000","updated":"2017-03-25T05:18:04.275+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15941586","id":"15941586","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user vincentpoon commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108028293\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -109,6 +110,20 @@ public void channelConnected(ChannelHandlerContext ctx,\n                         zkServer, NettyServerCnxnFactory.this);\n                 ctx.setAttachment(cnxn);\n     \n    +            InetAddress addr = ((InetSocketAddress)cnxn.channel.getRemoteAddress()).getAddress();\n    +            Set<NettyServerCnxn> s = ipMap.get(addr);\n    +            if (s != null) {\n    +                synchronized (s) {\n    --- End diff --\n    \n    Same here - check if synchronized is needed\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-25T05:18:04.279+0000","updated":"2017-03-25T05:18:04.279+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943729","id":"15943729","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108225920\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -170,7 +185,6 @@ public void messageReceived(ChannelHandlerContext ctx, MessageEvent e)\n                     throw ex;\n                 }\n             }\n    -\n    --- End diff --\n    \n    unnecessary line removal\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T17:54:15.896+0000","updated":"2017-03-27T17:54:15.896+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943730","id":"15943730","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108219703\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NettyServerCnxnTest.java ---\n    @@ -51,9 +65,9 @@ public void setUp() throws Exception {\n          * \n          * @see <a href=\"https://issues.jboss.org/browse/NETTY-412\">NETTY-412</a>\n          */\n    -    @Test(timeout = 40000)\n    +    @Test(timeout = 30000)\n    --- End diff --\n    \n    why was this changed?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T17:54:15.947+0000","updated":"2017-03-27T17:54:15.947+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943731","id":"15943731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108229036\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -109,6 +110,20 @@ public void channelConnected(ChannelHandlerContext ctx,\n                         zkServer, NettyServerCnxnFactory.this);\n                 ctx.setAttachment(cnxn);\n     \n    +            InetAddress addr = ((InetSocketAddress)cnxn.channel.getRemoteAddress()).getAddress();\n    +            Set<NettyServerCnxn> s = ipMap.get(addr);\n    --- End diff --\n    \n    Not sure if this is an issue or not, but if multiple connections (from a new address) hit this line before reaching the next one, the maxclientcnxns will never be checked as factory.ipMap.get(address) will return null for all of the connections?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T17:54:16.041+0000","updated":"2017-03-27T17:54:16.041+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943732","id":"15943732","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108230180\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -524,17 +538,14 @@ public InetSocketAddress getLocalAddress() {\n     \n         private void addCnxn(NettyServerCnxn cnxn) {\n             cnxns.add(cnxn);\n    -        synchronized (ipMap){\n    -            InetAddress addr =\n    -                ((InetSocketAddress)cnxn.channel.getRemoteAddress())\n    -                    .getAddress();\n    -            Set<NettyServerCnxn> s = ipMap.get(addr);\n    -            if (s == null) {\n    -                s = new HashSet<NettyServerCnxn>();\n    -            }\n    -            s.add(cnxn);\n    -            ipMap.put(addr,s);\n    +\n    +        InetAddress addr = ((InetSocketAddress)cnxn.channel.getRemoteAddress()).getAddress();\n    --- End diff --\n    \n    I think it may be cleaner to inline this method instead of casting again.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T17:54:16.150+0000","updated":"2017-03-27T17:54:16.150+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943733","id":"15943733","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108230944\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NettyServerCnxnTest.java ---\n    @@ -84,4 +98,78 @@ public void testSendCloseSession() throws Exception {\n                 zk.close();\n             }\n         }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testMaxClientConnectionsReached() throws Exception {\n    +        final int maxClientCnxns = 4;\n    +        final int numClients = 10;\n    +        createAndTestConnections(numClients, maxClientCnxns, maxClientCnxns);\n    +    }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testMaxClientConnectionsDisabled() throws Exception {\n    +        final int maxClientCnxns = 0; // disabled cnxns limit\n    +        final int numClients = 10;\n    +        createAndTestConnections(numClients, maxClientCnxns, numClients);\n    +    }\n    +\n    +    private void createAndTestConnections(int numClients, int maxClientCnxns, int cnxnsAccepted) throws Exception {\n    +\n    +        File tmpDir = ClientBase.createTmpDir();\n    +        final int CLIENT_PORT = PortAssignment.unique();\n    +\n    +        ZooKeeperServer zks = new ZooKeeperServer(tmpDir, tmpDir, 3000);\n    +        ServerCnxnFactory scf = ServerCnxnFactory.createFactory(CLIENT_PORT, maxClientCnxns);\n    +        scf.startup(zks);\n    +\n    +        try {\n    +            assertTrue(\"waiting for server being up\",\n    +                    ClientBase.waitForServerUp(\"127.0.0.1:\" + CLIENT_PORT, CONNECTION_TIMEOUT));\n    +            assertTrue(\"Didn't instantiate ServerCnxnFactory with NettyServerCnxnFactory!\",\n    +                    scf instanceof NettyServerCnxnFactory);\n    +\n    +            assertEquals(0, scf.getNumAliveConnections());\n    +\n    +            assertTrue(cnxnsAccepted <= numClients);\n    +\n    +            final CountDownLatch countDownLatch = new CountDownLatch(cnxnsAccepted);\n    +\n    +            TestableZooKeeper[] clients = new TestableZooKeeper[numClients];\n    +            for (int i = 0; i < numClients; i++) {\n    +                clients[i] = new TestableZooKeeper(\"127.0.0.1:\" + CLIENT_PORT, 3000, new Watcher() {\n    +                    @Override\n    +                    public void process(WatchedEvent event)\n    +                    {\n    +                        if (event.getState() == Event.KeeperState.SyncConnected) {\n    +                           countDownLatch.countDown();\n    +                        }\n    +                    }\n    +                });\n    +            }\n    +\n    +            countDownLatch.await();\n    +\n    +            assertEquals(cnxnsAccepted, scf.getNumAliveConnections());\n    +\n    +            ConcurrentMap<InetAddress, Set<NettyServerCnxn>> ipMap = ((NettyServerCnxnFactory) scf).ipMap;\n    +            assertEquals(1, ipMap.size());\n    +            Set<NettyServerCnxn> set = ipMap.get(ipMap.keySet().toArray()[0]);\n    +            assertEquals(cnxnsAccepted, set.size());\n    +\n    +            int connected = 0;\n    +            for (int i = 0; i < numClients; i++) {\n    +                if (clients[i].getState().isConnected()) connected++;\n    --- End diff --\n    \n    nit: I think we prefer multi-line if statements.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T17:54:16.153+0000","updated":"2017-03-27T17:54:16.153+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943734","id":"15943734","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108229544\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java ---\n    @@ -100,11 +101,15 @@ public void close() {\n                             + Long.toHexString(sessionId));\n                 }\n     \n    -            synchronized (factory.ipMap) {\n    -                Set<NettyServerCnxn> s =\n    -                    factory.ipMap.get(((InetSocketAddress)channel\n    -                            .getRemoteAddress()).getAddress());\n    -                s.remove(this);\n    +            InetAddress address = ((InetSocketAddress) channel.getRemoteAddress()).getAddress();\n    +            Set<NettyServerCnxn> s = factory.ipMap.get(address);\n    --- End diff --\n    \n    I agree that that ipMap management would be cleaner if it was handled in the factory.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T17:54:16.179+0000","updated":"2017-03-27T17:54:16.179+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943735","id":"15943735","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108220399\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NettyServerCnxnTest.java ---\n    @@ -28,6 +32,16 @@\n     import org.slf4j.Logger;\n     import org.slf4j.LoggerFactory;\n     \n    +import java.io.File;\n    +import java.net.InetAddress;\n    +import java.util.Set;\n    +import java.util.concurrent.ConcurrentMap;\n    +import java.util.concurrent.CountDownLatch;\n    +\n    +import static junit.framework.TestCase.assertEquals;\n    +import static junit.framework.TestCase.assertNotNull;\n    --- End diff --\n    \n    i don't believe this import is being used\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T17:54:16.194+0000","updated":"2017-03-27T17:54:16.194+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943736","id":"15943736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108231907\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NettyServerCnxnTest.java ---\n    @@ -84,4 +98,78 @@ public void testSendCloseSession() throws Exception {\n                 zk.close();\n             }\n         }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testMaxClientConnectionsReached() throws Exception {\n    +        final int maxClientCnxns = 4;\n    +        final int numClients = 10;\n    +        createAndTestConnections(numClients, maxClientCnxns, maxClientCnxns);\n    +    }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testMaxClientConnectionsDisabled() throws Exception {\n    +        final int maxClientCnxns = 0; // disabled cnxns limit\n    +        final int numClients = 10;\n    +        createAndTestConnections(numClients, maxClientCnxns, numClients);\n    +    }\n    +\n    +    private void createAndTestConnections(int numClients, int maxClientCnxns, int cnxnsAccepted) throws Exception {\n    +\n    +        File tmpDir = ClientBase.createTmpDir();\n    +        final int CLIENT_PORT = PortAssignment.unique();\n    +\n    +        ZooKeeperServer zks = new ZooKeeperServer(tmpDir, tmpDir, 3000);\n    --- End diff --\n    \n    it seems strange to me to have some tests that start their on zookeeper server and another which uses the one provided by the @before from the superclass. I think we should pick one approach per test class. What do you think?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T17:54:16.239+0000","updated":"2017-03-27T17:54:16.239+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943756","id":"15943756","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108239884\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NettyServerCnxnTest.java ---\n    @@ -51,9 +65,9 @@ public void setUp() throws Exception {\n          * \n          * @see <a href=\"https://issues.jboss.org/browse/NETTY-412\">NETTY-412</a>\n          */\n    -    @Test(timeout = 40000)\n    +    @Test(timeout = 30000)\n    --- End diff --\n    \n    Due to @fpj previous review on previous incarnation this patch: https://github.com/apache/zookeeper/pull/77/files#r80003749 (sorry, should have put the original link).\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T18:10:07.944+0000","updated":"2017-03-27T18:10:07.944+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943757","id":"15943757","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108240078\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -170,7 +185,6 @@ public void messageReceived(ChannelHandlerContext ctx, MessageEvent e)\n                     throw ex;\n                 }\n             }\n    -\n    --- End diff --\n    \n    Ops, again Flavio's previous review comment: https://github.com/apache/zookeeper/pull/77/files#r80004333 (should have put referenced this here).\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T18:10:57.230+0000","updated":"2017-03-27T18:10:57.230+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943769","id":"15943769","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108242052\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java ---\n    @@ -100,11 +101,15 @@ public void close() {\n                             + Long.toHexString(sessionId));\n                 }\n     \n    -            synchronized (factory.ipMap) {\n    -                Set<NettyServerCnxn> s =\n    -                    factory.ipMap.get(((InetSocketAddress)channel\n    -                            .getRemoteAddress()).getAddress());\n    -                s.remove(this);\n    +            InetAddress address = ((InetSocketAddress) channel.getRemoteAddress()).getAddress();\n    +            Set<NettyServerCnxn> s = factory.ipMap.get(address);\n    +            if (s != null) {\n    +                synchronized (s) {\n    --- End diff --\n    \n    Yeah... in the context of this call I think it is not necessary to synchronize here if -- as you said -- we use a synchronized set (**currently it's not**). I would also change `ipMap` to be a `ConcurrentMap` but unsure if it's worth the effort, tbh. :thinking: thoughts?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T18:19:02.959+0000","updated":"2017-03-27T18:19:02.959+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943770","id":"15943770","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108242277\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -109,6 +110,20 @@ public void channelConnected(ChannelHandlerContext ctx,\n                         zkServer, NettyServerCnxnFactory.this);\n                 ctx.setAttachment(cnxn);\n     \n    +            InetAddress addr = ((InetSocketAddress)cnxn.channel.getRemoteAddress()).getAddress();\n    +            Set<NettyServerCnxn> s = ipMap.get(addr);\n    +            if (s != null) {\n    +                synchronized (s) {\n    --- End diff --\n    \n    If we change `s` to be a synchronized set I think we can get rid of this synchronized block. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T18:19:59.782+0000","updated":"2017-03-27T18:19:59.782+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943775","id":"15943775","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108242887\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NettyServerCnxnTest.java ---\n    @@ -84,4 +98,78 @@ public void testSendCloseSession() throws Exception {\n                 zk.close();\n             }\n         }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testMaxClientConnectionsReached() throws Exception {\n    +        final int maxClientCnxns = 4;\n    +        final int numClients = 10;\n    +        createAndTestConnections(numClients, maxClientCnxns, maxClientCnxns);\n    +    }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testMaxClientConnectionsDisabled() throws Exception {\n    +        final int maxClientCnxns = 0; // disabled cnxns limit\n    +        final int numClients = 10;\n    +        createAndTestConnections(numClients, maxClientCnxns, numClients);\n    +    }\n    +\n    +    private void createAndTestConnections(int numClients, int maxClientCnxns, int cnxnsAccepted) throws Exception {\n    +\n    +        File tmpDir = ClientBase.createTmpDir();\n    +        final int CLIENT_PORT = PortAssignment.unique();\n    +\n    +        ZooKeeperServer zks = new ZooKeeperServer(tmpDir, tmpDir, 3000);\n    --- End diff --\n    \n    +1. :+1: \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T18:22:25.760+0000","updated":"2017-03-27T18:22:25.760+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943776","id":"15943776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108242965\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/NettyServerCnxnTest.java ---\n    @@ -84,4 +98,78 @@ public void testSendCloseSession() throws Exception {\n                 zk.close();\n             }\n         }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testMaxClientConnectionsReached() throws Exception {\n    +        final int maxClientCnxns = 4;\n    +        final int numClients = 10;\n    +        createAndTestConnections(numClients, maxClientCnxns, maxClientCnxns);\n    +    }\n    +\n    +    @Test(timeout = 30000)\n    +    public void testMaxClientConnectionsDisabled() throws Exception {\n    +        final int maxClientCnxns = 0; // disabled cnxns limit\n    +        final int numClients = 10;\n    +        createAndTestConnections(numClients, maxClientCnxns, numClients);\n    +    }\n    +\n    +    private void createAndTestConnections(int numClients, int maxClientCnxns, int cnxnsAccepted) throws Exception {\n    +\n    +        File tmpDir = ClientBase.createTmpDir();\n    +        final int CLIENT_PORT = PortAssignment.unique();\n    +\n    +        ZooKeeperServer zks = new ZooKeeperServer(tmpDir, tmpDir, 3000);\n    +        ServerCnxnFactory scf = ServerCnxnFactory.createFactory(CLIENT_PORT, maxClientCnxns);\n    +        scf.startup(zks);\n    +\n    +        try {\n    +            assertTrue(\"waiting for server being up\",\n    +                    ClientBase.waitForServerUp(\"127.0.0.1:\" + CLIENT_PORT, CONNECTION_TIMEOUT));\n    +            assertTrue(\"Didn't instantiate ServerCnxnFactory with NettyServerCnxnFactory!\",\n    +                    scf instanceof NettyServerCnxnFactory);\n    +\n    +            assertEquals(0, scf.getNumAliveConnections());\n    +\n    +            assertTrue(cnxnsAccepted <= numClients);\n    +\n    +            final CountDownLatch countDownLatch = new CountDownLatch(cnxnsAccepted);\n    +\n    +            TestableZooKeeper[] clients = new TestableZooKeeper[numClients];\n    +            for (int i = 0; i < numClients; i++) {\n    +                clients[i] = new TestableZooKeeper(\"127.0.0.1:\" + CLIENT_PORT, 3000, new Watcher() {\n    +                    @Override\n    +                    public void process(WatchedEvent event)\n    +                    {\n    +                        if (event.getState() == Event.KeeperState.SyncConnected) {\n    +                           countDownLatch.countDown();\n    +                        }\n    +                    }\n    +                });\n    +            }\n    +\n    +            countDownLatch.await();\n    +\n    +            assertEquals(cnxnsAccepted, scf.getNumAliveConnections());\n    +\n    +            ConcurrentMap<InetAddress, Set<NettyServerCnxn>> ipMap = ((NettyServerCnxnFactory) scf).ipMap;\n    +            assertEquals(1, ipMap.size());\n    +            Set<NettyServerCnxn> set = ipMap.get(ipMap.keySet().toArray()[0]);\n    +            assertEquals(cnxnsAccepted, set.size());\n    +\n    +            int connected = 0;\n    +            for (int i = 0; i < numClients; i++) {\n    +                if (clients[i].getState().isConnected()) connected++;\n    --- End diff --\n    \n    Oops, indeed! +1.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T18:22:40.981+0000","updated":"2017-03-27T18:22:40.981+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943877","id":"15943877","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108255892\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -109,6 +110,20 @@ public void channelConnected(ChannelHandlerContext ctx,\n                         zkServer, NettyServerCnxnFactory.this);\n                 ctx.setAttachment(cnxn);\n     \n    +            InetAddress addr = ((InetSocketAddress)cnxn.channel.getRemoteAddress()).getAddress();\n    +            Set<NettyServerCnxn> s = ipMap.get(addr);\n    --- End diff --\n    \n    Good catch! Congrats! :smiley:\n    \n    Now, I am a bit unsure if this:\n    \n    * this is a real issue and/or worth fixing;\n    * how to achieve a good compromise without entangling the logic too much.\n    \n    Wdyt?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T19:17:13.631+0000","updated":"2017-03-27T19:17:13.631+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943884","id":"15943884","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user eribeiro commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108256234\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -524,17 +538,14 @@ public InetSocketAddress getLocalAddress() {\n     \n         private void addCnxn(NettyServerCnxn cnxn) {\n             cnxns.add(cnxn);\n    -        synchronized (ipMap){\n    -            InetAddress addr =\n    -                ((InetSocketAddress)cnxn.channel.getRemoteAddress())\n    -                    .getAddress();\n    -            Set<NettyServerCnxn> s = ipMap.get(addr);\n    -            if (s == null) {\n    -                s = new HashSet<NettyServerCnxn>();\n    -            }\n    -            s.add(cnxn);\n    -            ipMap.put(addr,s);\n    +\n    +        InetAddress addr = ((InetSocketAddress)cnxn.channel.getRemoteAddress()).getAddress();\n    --- End diff --\n    \n    Indeed, there's too much call for casting in this class already. Are you suggesting to extract this line into a method?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T19:18:49.028+0000","updated":"2017-03-27T19:18:49.028+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943892","id":"15943892","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108256938\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -524,17 +538,14 @@ public InetSocketAddress getLocalAddress() {\n     \n         private void addCnxn(NettyServerCnxn cnxn) {\n             cnxns.add(cnxn);\n    -        synchronized (ipMap){\n    -            InetAddress addr =\n    -                ((InetSocketAddress)cnxn.channel.getRemoteAddress())\n    -                    .getAddress();\n    -            Set<NettyServerCnxn> s = ipMap.get(addr);\n    -            if (s == null) {\n    -                s = new HashSet<NettyServerCnxn>();\n    -            }\n    -            s.add(cnxn);\n    -            ipMap.put(addr,s);\n    +\n    +        InetAddress addr = ((InetSocketAddress)cnxn.channel.getRemoteAddress()).getAddress();\n    --- End diff --\n    \n    we can pass the InetAddress as a param?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T19:22:08.592+0000","updated":"2017-03-27T19:22:08.592+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12895299/comment/15943908","id":"15943908","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/208#discussion_r108258656\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/NettyServerCnxnFactory.java ---\n    @@ -109,6 +110,20 @@ public void channelConnected(ChannelHandlerContext ctx,\n                         zkServer, NettyServerCnxnFactory.this);\n                 ctx.setAttachment(cnxn);\n     \n    +            InetAddress addr = ((InetSocketAddress)cnxn.channel.getRemoteAddress()).getAddress();\n    +            Set<NettyServerCnxn> s = ipMap.get(addr);\n    --- End diff --\n    \n    So I can't imagine this causing much more than the occasional extra single connection, but I do think it is worth fixing.\n    \n    My feeling here is that if we move the ipMap logic to the factory this should be easier to fix as synchronization in a singleton is much simpler than trying to figure out what Netty does with these CnxnChannelHandler objects.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-03-27T19:31:01.026+0000","updated":"2017-03-27T19:31:01.026+0000"}],"maxResults":43,"total":43,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2280/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2ldjj:"}}