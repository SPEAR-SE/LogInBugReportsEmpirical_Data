{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13148515","self":"https://issues.apache.org/jira/rest/api/2/issue/13148515","key":"ZOOKEEPER-3014","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12342040","id":"12342040","description":"Fix release against 3.4 branch","name":"3.4.12","archived":false,"released":true,"releaseDate":"2018-05-01"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2018-03-28T09:46:54.029+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Mar 29 16:09:22 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_112859207_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2018-03-29T16:09:22.763+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3014/watchers","watchCount":2,"isWatching":false},"created":"2018-03-28T08:48:23.582+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321883","id":"12321883","description":"Fix release against 3.4 branch","name":"3.4.5","archived":false,"released":true,"releaseDate":"2012-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-29T16:09:22.787+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"We have client A which create a znode ,and its path is /zk/lock/100000.  Another client B thread is acquiring for the lock, so it calls the exist command with watch periodically to check if it is available. Then Client A has finished this work, and  delete this znode. Client b still calls exist command with watch. Because the code doesn't check node existence, when the  Watch add operation comes , it will add to non-exist node path.\r\n\r\nThis problem may be cause by the follow code. \r\n{code:java}\r\npublic Stat statNode(String path, Watcher watcher)\r\nthrows KeeperException.NoNodeException {\r\nStat stat = new Stat();\r\nDataNode n = nodes.get(path);\r\nif (watcher != null) {\r\ndataWatches.addWatch(path, watcher);\r\n}\r\nif (n == null) {\r\nthrow new KeeperException.NoNodeException();\r\n}\r\nsynchronized (n) {\r\nn.copyStat(stat);\r\nreturn stat;\r\n}\r\n}\r\n{code}\r\nThe zk version we use is 3.4.5. We meet a problem that is the zk client try to reestablish to zk cluster failed after disconnect for some reason.We find it causes by ZOOKEEPER-706. But we try to know why there are so many watches. Then we find this problem.\r\n\r\n \r\n\r\n \r\n\r\n ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12916624","id":"12916624","filename":"image-2018-03-28-22-51-33-751.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-28T14:51:36.063+0000","size":67319,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12916624/image-2018-03-28-22-51-33-751.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12916839","id":"12916839","filename":"TestCurator.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-29T14:58:19.580+0000","size":2414,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12916839/TestCurator.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"watch can be added to non-existed path by exist command","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16417101","id":"16417101","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"Hi [~tassemble]\r\n\r\nThanks for the bugreport.\r\n\r\nMaybe I'm missing something here, but 2 things are suspicious in your explanation:\r\n # \"it calls the exist command with watch periodically to check if it is available\"\r\n\r\nWhy periodically?\r\n\r\nClient should call the exist() method with a watcher parameter and check the return value:\r\n\r\nif exists() returns null, the node doesn't exist, otherwise the watcher will be triggered whenever the state changes. No need to call this manually.\r\n\r\n      2. \"the code doesn't check node existence\"\r\n\r\nWhich code? \r\n\r\nDataTree.statNode() does it indeed when checks for (n == null).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-28T09:46:54.029+0000","updated":"2018-03-28T09:46:54.029+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16417501","id":"16417501","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"body":"Sorry, \"periodically \" may be misleading. May be some other cases, for example, there are threads continually  to watcher one znode by calling exist(). And during this time, the znode is removed, can these watchers  be added to a path which znode is not exist? \r\n\r\nI am using curator 2.1.0 and zk is 3.4.5. The follow code is my test code. After I run this code ,i wish all the watchers at server should removed, but after all the znode are removed, some watchers stll exist. \r\n{code:java}\r\nfor (int i = 0; i < threadCount; i++) {\r\n    final InterProcessMutex ipm = new InterProcessMutex(this.client, \"/locks\");\r\n    final int seq = i;\r\n    es.submit(new Runnable() {\r\n\r\n        @Override\r\n        public void run() {\r\n            boolean acquire = false;\r\n            try {\r\n                //only one can acquire the locker\r\n                acquire = ipm.acquire(20, TimeUnit.SECONDS);\r\n                if (acquire) {\r\n                    LOG.info(\"i am thread No.:\" + seq);\r\n                    //waiting\r\n                    TimeUnit.SECONDS.sleep(30);\r\n                } else {\r\n                    LOG.info(\"acquired failed!, number:\" + seq);\r\n                }\r\n            } catch (Exception e) {\r\n                e.printStackTrace();\r\n            } finally {\r\n                try {\r\n                    if (acquire) {\r\n                        LOG.info(\"i am released, number:\" + seq);\r\n                        ipm.release();\r\n                    }\r\n                } catch (Exception e) {\r\n                    e.printStackTrace();\r\n                }\r\n            }\r\n        }\r\n    });\r\n\r\n}\r\n{code}\r\nThe following picture shows the watchers are not removed. \r\n\r\n!image-2018-03-28-22-51-33-751.png!\r\n\r\n \r\n\r\n \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-28T15:10:23.239+0000","updated":"2018-03-28T15:10:23.239+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16417582","id":"16417582","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"body":"here is the full code :https://github.com/Tassemble/zk-demo/blob/master/src/test/java/com/netease/edu/mooc/demo/zk/ZkApplicationTests.java","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-28T15:46:19.305+0000","updated":"2018-03-28T15:46:19.305+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16417617","id":"16417617","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"Thanks for the clarification. I'll look into it in more detail.\r\n\r\nIn the meantime, would you please test with the latest stable version of Curator/ZooKeeper to make sure you're not reporting an issue which is fixed already?\r\n\r\nZK 3.4.12 is coming soon you might want to wait for it before doing any test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-28T15:57:37.603+0000","updated":"2018-03-28T15:58:20.949+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16418481","id":"16418481","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"body":"Hi Andor Molnar.\r\n\r\nI have tested these versions:\r\n\r\ncurator-recipes:2.1.0-incubating\r\n\r\nzookeeper:3.4.3, 3.4.5,3.4.11, and the results are in the same. There are still some watchers not removed.\r\n\r\n \r\n\r\nI also test these versions:\r\n\r\ncurator-recipes:4.0.1\r\n\r\nzookeeper:3.5.3-beta\r\n\r\nBut find the problem is resolved.\r\n\r\n \r\n\r\n \r\n\r\n \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-29T05:56:17.584+0000","updated":"2018-03-29T05:56:17.584+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16418510","id":"16418510","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"body":"I see curator 2.5.0 resolve the problem. The cause is that exists() will creates a watch regardless of whether the node exists or not, getData() will only create the watch if node exists.\r\n\r\nhttps://issues.apache.org/jira/browse/CURATOR-107\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-29T06:47:20.217+0000","updated":"2018-03-29T09:03:00.762+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16418665","id":"16418665","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"Thanks [~tassemble]\r\n\r\nSo, CURATOR-107 is basically a workaround for an existing ZK issue, right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-29T09:40:56.889+0000","updated":"2018-03-29T09:40:56.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16419129","id":"16419129","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"I can't repro your issue for some reason.\r\n\r\nTested 3.4.12 with the code snippet your provided, but a few seconds after the execution finished (lock released, proc exited), all watches are removed.\r\n\r\nWill try to compile your ZkApplicationTest.java to see if there's any difference.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-29T14:57:08.623+0000","updated":"2018-03-29T14:57:08.623+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16419135","id":"16419135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"I've attached the console app that I was testing with.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-29T14:58:51.088+0000","updated":"2018-03-29T14:58:51.088+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16419158","id":"16419158","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"Sorry, ignore my previous comments. Now I see your point.\r\n\r\nWhen you talked about exists() method, you were actually referring to Curator's checkExists(), which eventually calls exists(), so it doesn't really matter. Later Curator fixed the issue by calling getData() instead which - as you said - doesn't add watch if the node doesn't exist, so Curator doesn't leak watches anymore.\r\n\r\nAll fine.\r\n\r\nBut that's not an issue with ZooKeeper. You should be able to setup a watch on non-existent node to get notified when it gets created. That's a feature, so I think you can close this Jira as not-an-issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-29T15:10:32.500+0000","updated":"2018-03-29T15:10:32.500+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13148515/comment/16419262","id":"16419262","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"body":"Thank you [~andorm]. \r\n\r\nYes, it is not a issue Of ZK, but a issue of curator before version 2.5.0.\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tassemble","name":"tassemble","key":"tassemble","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34053","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34053","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34053","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34053"},"displayName":"CHQ","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-29T16:09:22.781+0000","updated":"2018-03-29T16:09:22.781+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3014/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3rvqv:"}}