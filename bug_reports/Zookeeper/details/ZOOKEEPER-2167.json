{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12821015","self":"https://issues.apache.org/jira/rest/api/2/issue/12821015","key":"ZOOKEEPER-2167","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-04-15T07:06:08.150+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Apr 16 03:49:53 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2167/watchers","watchCount":2,"isWatching":false},"created":"2015-04-15T00:01:24.928+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-04-16T03:50:06.746+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"I'm seeing an issue where a restart of the current leader node results in a long-term / permanent loss of quorum (I've only waited 30 minutes, but it doesn't look like it's making any progress). Restarting the same instance _again_ seems to resolve the problem.\n\nTo me, this looks a lot like the issue described in https://issues.apache.org/jira/browse/ZOOKEEPER-1026, but I'm filing this separately for the moment in case I am wrong.\n\nNotes on the attached log:\n1) If you search for XXX in the log, you'll see where I've annotated it to include where the process was told to terminate, when it is reported to have completed that, and then the same for the start\n2) To save you the trouble of figuring it out, here's the zkid <=> ip mapping:\nzid=1, ip=10.20.0.19\nzid=2, ip=10.20.0.18\nzid=3, ip=10.20.0.20\nzid=4, ip=10.20.0.21\nzid=5, ip=10.20.0.22\n3) It's important to note that this is log is during the process of a rolling service restart to remove an instance; in this case, zid #2 / 10.20.0.18 is the one being removed, so if you see a conspicuous silence from that service, that's why. \n4) I've been unable to reproduce this problem _except_ during cluster size changes, so I suspect that may be related; it's also important to note that this test is going from 5 -> 4 (which means, since we remove one and then do a rolling restart, we are actually temporarily dropping to 3). I know this is not a recommended thing (this is more of a stress test). We have seen this same problem on larger cluster sizes, it just seems easier to reproduce it on smaller sizes.\n5) The log starts roughly at the point 10.20.0.21 / zid=4 wins the election during the final quorum; zid=4 is the one whose shutdown triggers the problem.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12725429","id":"12725429","filename":"fails-to-rejoin-quorum.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=novas0x2a","name":"novas0x2a","key":"novas0x2a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Lundy","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-15T00:01:52.154+0000","size":612209,"mimeType":"application/gzip","content":"https://issues.apache.org/jira/secure/attachment/12725429/fails-to-rejoin-quorum.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12725775","id":"12725775","filename":"fails-to-rejoin-quorum-longer.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=novas0x2a","name":"novas0x2a","key":"novas0x2a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Lundy","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-16T03:50:06.738+0000","size":956362,"mimeType":"application/gzip","content":"https://issues.apache.org/jira/secure/attachment/12725775/fails-to-rejoin-quorum-longer.gz"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Restarting current leader node sometimes results in a permanent loss of quorum","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=novas0x2a","name":"novas0x2a","key":"novas0x2a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Lundy","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=novas0x2a","name":"novas0x2a","key":"novas0x2a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Lundy","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12821015/comment/14495779","id":"14495779","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Mike, I took a quick look at the log file. What time did node 2 get removed from the cluster? I see that node 3 and 5 keep trying to connect to node 2:\n\n{noformat}\nApr 14 00:09:49.579516 10.20.0.20 warning zookeeper: Cannot open channel to 2 at election address /10.20.0.18:3888 java.net.SocketTimeoutException: connect timed out\nApr 14 00:09:49.644749 10.20.0.22 warning zookeeper: Cannot open channel to 2 at election address /10.20.0.18:3888 java.net.SocketTimeoutException: connect timed out\n{noformat}\n\nWould it be possible that the configuration didn't get updated on these 2 nodes? You might be hitting the same issue as ZOOKEEPER-2164.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-15T07:06:08.150+0000","updated":"2015-04-15T07:06:08.150+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12821015/comment/14495988","id":"14495988","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=novas0x2a","name":"novas0x2a","key":"novas0x2a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Lundy","active":true,"timeZone":"America/Los_Angeles"},"body":"I can't check the full log for 10-12 hours from now (I unfortunately snipped that part of the log out of what I posted here, but I still have the original logs) but it's possible/probable that they haven't been updated yet; this is during a rolling restart of the cluster to permanently remove node 2 from the ensemble. (This cluster is smaller than we usually use, since it's kind of sketchy to resize it with so few nodes since there's no margin for error; as I said above, we've seen this on larger ensembles, too, it's just easier to repro the problem with the smaller cluster).\n\nIt's hard to tell just from the description, but yeah, it's possible that this is the same as https://issues.apache.org/jira/browse/ZOOKEEPER-2164; if my problem is the same, that means that it's not the restart but the stop that causes the problem... hm. It usually takes a few hours to repro the problem, but we do currently have a pretty reliable repro; I plan to run some more experiments tomorrow and hopefully learn something (but if anyone who understands zk better than I do has any insights, they'd be appreciated).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=novas0x2a","name":"novas0x2a","key":"novas0x2a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Lundy","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-15T10:17:58.070+0000","updated":"2015-04-15T10:17:58.070+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12821015/comment/14497517","id":"14497517","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=novas0x2a","name":"novas0x2a","key":"novas0x2a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Lundy","active":true,"timeZone":"America/Los_Angeles"},"body":"I've attached my more complete log, this goes back much further and shows the previous (annotated) node add process as well (we go 3->4->5->4, in each case applying the change in a rolling fashion before moving on)\n\nThis is the same log as before, just more complete and better annotated (again, using XXX to indicate where starts and stops happened, also showing the configured ensemble at the time) so everything I said previous still applies (ZID/IP mapping is the same, etc).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=novas0x2a","name":"novas0x2a","key":"novas0x2a","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Lundy","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-16T03:49:53.048+0000","updated":"2015-04-16T03:49:53.048+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2167/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2d9c7:"}}