{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13205090","self":"https://issues.apache.org/jira/rest/api/2/issue/13205090","key":"ZOOKEEPER-3220","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-12-20T06:36:28.378+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Dec 27 04:08:45 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3220/watchers","watchCount":3,"isWatching":false},"created":"2018-12-18T09:55:22.875+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12342040","id":"12342040","description":"Fix release against 3.4 branch","name":"3.4.12","archived":false,"released":true,"releaseDate":"2018-05-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342973","id":"12342973","description":"Fix release against 3.4 branch","name":"3.4.13","archived":false,"released":true,"releaseDate":"2018-07-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-12-27T04:08:45.139+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"We known that ZooKeeper server will call fsync to make sure that log data has been successfully saved to disk. But ZooKeeper server does not call fsync to make sure that a snapshot has been successfully saved, which may cause potential problems. Since a close to a file description does not make sure that data is written to disk, see [http://man7.org/linux/man-pages/man2/close.2.html#notes] for more details.\r\n\r\n \r\n\r\nIf the snapshot is not successfully  saved to disk, it may lead to data inconsistency. Here is my example, which is also a real problem I have ever met.\r\n\r\n1. I deployed a 3-node ZooKeeper cluster: zk1, zk2, and zk3, zk2 was the leader.\r\n\r\n2. Both zk1 and zk2 had the log records from log1~logX, X was the zxid.\r\n\r\n3. The machine of zk1 restarted, and during the reboot,  log(X+1) ~ log Y are saved to log files of both zk2(leader) and zk3(follower).\r\n\r\n4. After zk1 restarted successfully, it found itself to be a follower, and it began to synchronize data with the leader. The leader sent a snapshot(records from log 1 ~ log Y) to zk1, zk1 then saved the snapshot to local disk by calling the method ZooKeeperServer.takeSnapshot. But unfortunately, when the method returned, the snapshot data was not saved to disk yet. In fact the snapshot file was created, but the size was 0.\r\n\r\n5. zk1 finished the synchronization and began to accept new requests from the leader. Say log records from log(Y + 1) ~ log Z were accepted by zk1 and  saved to log file. With fsync zk1 could make sure log data was not lost.\r\n\r\n6. zk1 restarted again. Since the snapshot's size was 0, it would not be used, therefore zk1 recovered using the log files. But the records from log(X+1) ~ logY were lost ! \r\n\r\n \r\n\r\nSorry for my poor English.\r\n\r\n ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"The snapshot is not saved to disk and may cause data inconsistency.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13205090/comment/16725617","id":"16725617","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maoling","name":"maoling","key":"maoling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maoling&avatarId=32024","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maoling&avatarId=32024","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maoling&avatarId=32024","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maoling&avatarId=32024"},"displayName":"maoling","active":true,"timeZone":"Etc/UTC"},"body":"[~jiangjiafu]\r\nFileTxnSnapLog#save\r\n\r\n{code:java}\r\n    /**\r\n     * save the datatree and the sessions into a snapshot\r\n     * @param dataTree the datatree to be serialized onto disk\r\n     * @param sessionsWithTimeouts the session timeouts to be\r\n     * serialized onto disk\r\n     * @param syncSnap sync the snapshot immediately after write\r\n     * @throws IOException\r\n     */\r\n    public void save(DataTree dataTree,\r\n                     ConcurrentHashMap<Long, Integer> sessionsWithTimeouts,\r\n                     boolean syncSnap)\r\n        throws IOException {\r\n        long lastZxid = dataTree.lastProcessedZxid;\r\n        File snapshotFile = new File(snapDir, Util.makeSnapshotName(lastZxid));\r\n        LOG.info(\"Snapshotting: 0x{} to {}\", Long.toHexString(lastZxid),\r\n                snapshotFile);\r\n        try {\r\n            snapLog.serialize(dataTree, sessionsWithTimeouts, snapshotFile, syncSnap);\r\n        } catch (IOException e) {\r\n            if (snapshotFile.length() == 0) {\r\n                /* This may be caused by a full disk. In such a case, the server\r\n                 * will get stuck in a loop where it tries to write a snapshot\r\n                 * out to disk, and ends up creating an empty file instead.\r\n                 * Doing so will eventually result in valid snapshots being\r\n                 * removed during cleanup. */\r\n                if (snapshotFile.delete()) {\r\n                    LOG.info(\"Deleted empty snapshot file: \" +\r\n                             snapshotFile.getAbsolutePath());\r\n                } else {\r\n                    LOG.warn(\"Could not delete empty snapshot file: \" +\r\n                             snapshotFile.getAbsolutePath());\r\n                }\r\n            } else {\r\n                /* Something else went wrong when writing the snapshot out to\r\n                 * disk. If this snapshot file is invalid, when restarting,\r\n                 * ZooKeeper will skip it, and find the last known good snapshot\r\n                 * instead. */\r\n            }\r\n            throw e;\r\n        }\r\n    }\r\n{code}\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maoling","name":"maoling","key":"maoling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maoling&avatarId=32024","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maoling&avatarId=32024","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maoling&avatarId=32024","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maoling&avatarId=32024"},"displayName":"maoling","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-20T06:36:28.378+0000","updated":"2018-12-20T06:36:28.378+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13205090/comment/16728572","id":"16728572","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"body":"In my environment, the save method returned successfully, that means no exception had been thrown. But, the data was not in disk! That's the problem I want to report!\r\n\r\n \r\n\r\nAnd yes, the snapshot with size 0 was invalid, and was skip when ZooKeeper server restarted again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2018-12-25T02:31:01.492+0000","updated":"2018-12-25T02:31:01.492+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13205090/comment/16729095","id":"16729095","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maoling","name":"maoling","key":"maoling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maoling&avatarId=32024","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maoling&avatarId=32024","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maoling&avatarId=32024","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maoling&avatarId=32024"},"displayName":"maoling","active":true,"timeZone":"Etc/UTC"},"body":"[~jiangjiafu]\r\n\r\n1.---->  \"*In my environment, the save method returned successfully, that means no exception had been thrown. But, the data was not in disk! That's the problem I want to report!*\"\r\n\r\nwhy this situation happend? The disk is full? \r\n snapshot does not call *fsync* may be the answer.\r\n Do you see some logs about *FileTxnSnapLog#save* at that time?\r\n 2.Even if this situation that the size of snapshot is 0 could not cause data inconsistency.\r\n because when ZooKeeper server restarted again,the invalid snapshots will be skiped,if no any valid snapshot,the leader can do *SNAP* to sync with the follower","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maoling","name":"maoling","key":"maoling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maoling&avatarId=32024","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maoling&avatarId=32024","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maoling&avatarId=32024","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maoling&avatarId=32024"},"displayName":"maoling","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-26T16:33:37.516+0000","updated":"2018-12-26T16:36:32.478+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13205090/comment/16729134","id":"16729134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"body":"I believe ZOOKEEPER-2872 addressed the fsyncing part of this issue and ZOOKEEPER-3082 added some nice cleanup around 0 size snapshot file. Neither of these changes were backported to 3.4 so that suggests one potential path forward. Note that backporting ZOOKEEPER-2872 also requires backporting ZOOKEEPER-2870.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"created":"2018-12-26T18:41:51.754+0000","updated":"2018-12-26T18:41:51.754+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13205090/comment/16729308","id":"16729308","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"body":"[~maoling]\r\n\r\n \r\n\r\nwhy this situation happend? The disk is full? \r\n\r\nNo, but the machine restarted.\r\n\r\nDo you see some logs about *FileTxnSnapLog#save* at that time?\r\n\r\nNo any error log, if fact, during the machine reboot, some log of the follower was missing. But from the log of the leader, the follower had received a snapshot and began to received other transaction logs, so the  *FileTxnSnapLog#save of follower must have succeed, but the data is not in disk!*\r\n\r\n \r\n\r\n*2.Even if this situation that the size of snapshot is 0 could not cause data inconsistency.*\r\n\r\nYes, I know. Zookeeper recover it's data from both logs and snapshot.\r\n\r\nIf a ZooKeeper follower believes a snapshot is saved, it believes that the data in the snapshot is all in the disk(but in fact it may be not), it will begin to receive logs that come after the snapshot. If the snapshot is invalid, ZooKeeper server will recover data from logs only, but some data is missing, because the data is only saved in the snapshot.\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2018-12-27T03:59:06.401+0000","updated":"2018-12-27T03:59:06.401+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13205090/comment/16729312","id":"16729312","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"body":"[~nixon] Thanks very much!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2018-12-27T04:08:45.139+0000","updated":"2018-12-27T04:08:45.139+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3220/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|u002zc:"}}