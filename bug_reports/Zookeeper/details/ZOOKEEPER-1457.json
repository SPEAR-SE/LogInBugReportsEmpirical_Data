{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12552934","self":"https://issues.apache.org/jira/rest/api/2/issue/12552934","key":"ZOOKEEPER-1457","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2012-04-29T17:29:23.713+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Apr 30 19:00:34 UTC 2012","customfield_12310420":"236698","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1457/watchers","watchCount":5,"isWatching":false},"created":"2012-04-26T19:25:43.816+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316276","id":"12316276","description":"Fix release against 3.3 branch","name":"3.3.4","archived":false,"released":true,"releaseDate":"2011-11-26"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-04-30T19:00:34.640+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"This week, we saw a potential bug with zookeeper 3.3.4. In an attempt to adding a separate disk for zookeeper transaction logs, our SysOps team threw new disks at all the zookeeper servers in our production cluster at around the same time. Right after this, we saw degraded performance on our zookeeper cluster. And yes, I agree that this degraded behavior is expected and we could've done a better job and upgraded one server at a time. Al though, the observed impact was that ephemeral nodes got deleted without session expiration on the zookeeper clients. \n\nLet me try and describe what I've observed from the Kafka and ZK server logs - Kafka client has a session established with ZK, say Session A, that it has been using successfully. At the time of the degraded ZK performance issue, Session A expires. Kafka's ZkClient tries to establish another session with ZK. After 9 seconds, it establishes a session, say Session B and tries to use it for creating a znode. This operation fails with a NodeExists error since another session, say session C, has created that znode. This is considered OK since ZkClient retries an operation transparently if it gets disconnected and sometimes you can get NodeExists. But then later, session C expires and hence the ephemeral node is deleted from ZK. This leads to unexpected errors in Kafka since its session, Session B, is still valid and hence it expects the znode to be there. The issue is that session C was established, created the znode and expired, without the zookeeper client on Kafka ever knowing about it. \n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32547","customfield_12312823":null,"summary":"Ephemeral node deleted for unexpired sessions","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12552934/comment/13262900","id":"13262900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"body":"I've attempted to serialize the sequence of events according to relevant data from txn and log4j logs below. \n\nZookeeper cluster size is 5 servers - srvr-84.prod, srvr-85.prod, srvr-88.prod, srvr-89.prod, srvr-90.prod\nLeader zookeeper is srvr-90.prod \nSession A = 0x9367a5bd54c9078 \nSession B = 0x8367a5bd75ea01b \nSession C = 0x8367a5bd75e9dd5 \nThe znode being created = /consumers/kafka-DR/ids/kafka-DR_srvr-0193.prod-1334094226781-6a7f1b76 \nZookeeper session timeout is 6 seconds \n\n1. Original session A, 0x9367a5bd54c9078 expired at 20:33:09 with zxid 0x31189e02d8 on the leader. \n\n2. Leader processed session termination for 0x9367a5bd54c9078 at 20:33.09.000. \n\n3. Leader realizes client has closed socket, so it closes NIOServerCnxn for 0x9367a5bd54c9078 at 20:33:09.009 \n\n4. Kafka client gets Expired state at 20:33:09.161 \n\n5. Kafka client starts re-registering its node in ZK at 20:33.09.209 with socket connection established to srvr-89.prod \n\n6. Client session 0x0 times out several times, reconnects to another server and repeats session establishment request. \n\n7. On the leader's txn log, session B 0x8367a5bd75ea01b is created at 20:33.17- \n1. time:4/23/12 20:33:17 PM PDT session:0x8367a5bd75ea01b cxid:0x0 zxid:0x31189e1985 type:createSession timeOut:6000 \n\n8. On zk server srvr-89, session B 0x8367a5bd75ea01b is established - \n1. zk.log4j.2012-04-23-srvr-89.gz: 1. 2012-04-23 20:33:17,987 - INFO [CommitProcessor:8:NIOServerCnxn@1580] - Established session 0x8367a5bd75ea01b with negotiated timeout 6000 for client /172.17.87.173:52865 \n2. 2012/04/23 20:33:18.022 INFO [ZkClient] [main-EventThread] [kafka] zookeeper state changed (SyncConnected) \n\n9. At 20:33:18.022 on Kafka client, session is established with session id 0x8367a5bd75ea01b \n1. 2012/04/23 20:33:18.022 INFO [ClientCnxn] [main-SendThread(srvr-89.prod:12913)] [kafka] Session establishment complete on server srvr-89.prod/172.17.229.105:12913, sessionid = 0x8367a5bd75ea01b, negotiated timeout = 6000 \n\n10. Kafka zookeeper client fails to create znode at 20:33.18.358 with Session B due to NodeExists exception \n1. 2012/04/23 20:33:18.358 INFO [ZkUtils$] [ZkClient-EventThread-81-srvr-85.prod:12913,srvr-88.prod:12913,srvr-84.prod:12913,srvr-89.prod:12913,srvr-90.prod:12913/kafka] [kafka] /consumers/kafka-DR/ids/kafka-DR_srvr-0193.prod-1334094226781-6a7f1b76 exists with value { \"firehoseActivity\": 1,\"firehoseUpdates\": 1,\"GenericSearchEvent\": 1,\"firehoseShares\": 1,\"ProfileViewEvent\": 1 } during connection loss; this is ok\n\n11. Kafka client gets Disconnected and SyncConnected with session B at 20:33:26 \n1. 2012/04/23 20:33:26.669 INFO [ClientCnxn] [main-SendThread(srvr-89.prod:12913)] [kafka] Client session timed out, have not heard from server in 4000ms for sessionid 0x8367a5bd75ea01b, closing socket connection and attempting reconnect \n2. 2012/04/23 20:33:26.769 INFO [ZkClient] [main-EventThread] [kafka] zookeeper state changed (Disconnected) \n3. 2012/04/23 20:33:27.471 INFO [ClientCnxn] [main-SendThread(srvr-89.prod:12913)] [kafka] Opening socket connection to server srvr-88.prod/172.17.229.104:12913 \n4. 2012/04/23 20:33:27.531 INFO [ClientCnxn] [main-SendThread(srvr-88.prod:12913)] [kafka] Socket connection established to srvr-88.prod/172.17.229.104:12913, initiating session \n5. 2012/04/23 20:33:28.419 INFO [ClientCnxn] [main-SendThread(srvr-88.prod:12913)] [kafka] Session establishment complete on server srvr-88.prod/172.17.229.104:12913, sessionid = 0x8367a5bd75ea01b, negotiated timeout = 6000 \n\n12. Kafka client runs into NoNode exception at 20:33:30 2012/04/23 20:33:30.538 INFO [ZookeeperConsumerConnector] [kafka-DR_srvr-0193.prod-1334094226781-6a7f1b76_watcher_executor] [kafka] exception during rebalance \n\nAt around the same time, the session C (0x8367a5bd75e9dd5) gets established and also creates the node and later expires. \n\n1. On leader srvr-90, session C gets created 1. time:4/23/12 20:33:09 PM PDT session:0x8367a5bd75e9dd5 cxid:0x0 zxid:0x31189e0709 type:createSession timeOut:6000 \n\n2. On server srvr-89, session gets created at 20:33.13.930 \n1. zk.log4j.2012-04-23-srvr-89.gz:2012-04-23 20:33:13,930 - INFO [CommitProcessor:8:NIOServerCnxn@1580] - Established session 0x8367a5bd75e9dd5 with negotiated timeout 6000 for client /172.17.87.173:52802 \n2. zk.log4j.2012-04-23-srvr-89.gz:2012-04-23 20:33:17,667 - WARN [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:12913:NIOServerCnxn@634] - EndOfStreamException: Unable to read additional data from client sessionid 0x8367a5bd75e9dd5, likely client has closed socket \n3. zk.log4j.2012-04-23-srvr-89.gz:2012-04-23 20:33:17,668 - INFO [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:12913:NIOServerCnxn@1435] - Closed socket connection for client /172.17.87.173:52802 which had sessionid 0x8367a5bd75e9dd5 \n\n3. Session C creates the znode - \n1. time:4/23/12 20:33:17 PM PDT session:0x8367a5bd75e9dd5 cxid:0x1 zxid:0x31189e1464 type:create acl:[31,s{'world,'anyone}] ephemeral:true path:/kafka/consumers/kafka-DR/ids/kafka-DR_ech3-app0193.prod-1334094226781-6a7f1b76 data:7B202266697265686F73654163746976697479223A20312C2266697265686F736555706461746573223A20312C2247656E657269635365617263684576656E74223A20312C2266697265686F7365536861726573223A20312C2250726F66696C65566965774576656E74223A2031207D \n2. Session B gets closed on the leader\n\n4. Session C expires on leader time:4/23/12 20:33:29 PM PDT session:0x8367a5bd75e9dd5 cxid:0x0 zxid:0x31189e27d0 type:closeSession \n\nSince the leader processes create session and create znode for Session C first, shouldn't it be the session id that gets returned to the client as create session response ? Does this sound like a bug ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-26T19:28:58.242+0000","updated":"2012-04-26T19:28:58.242+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12552934/comment/13262902","id":"13262902","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"body":"Logs are uploaded here - http://people.apache.org/%7Enehanarkhede/kafka-misc/zookeeper-outage-2012-04-23/kafka-zk-bug-2012-04-23.tar.gz","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-26T19:30:47.336+0000","updated":"2012-04-26T19:30:47.336+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12552934/comment/13264585","id":"13264585","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Hi Neha,\n\nI'm trying to dig into this issue a bit, but I'm a little unclear of what the problem is. You have a node that was created by session C. When Session C expires, the node is deleted. You don't expect it to be deleted, but I'm not sure why. Is it because you didn't know about session C? Is it because session B didn't get the right information about the node? \n\nWhat does this mean in the context of the bug?\n{quote}Since the leader processes create session and create znode for Session C first, shouldn't it be the session id that gets returned to the client as create session response ? Does this sound like a bug ?{quote}\n\nSession C seems to be the owner of the node, and you've got a closeSession for C, so is it really deleting the node for an unexpired session?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-29T17:29:23.713+0000","updated":"2012-04-29T17:29:23.713+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12552934/comment/13265113","id":"13265113","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"body":"Camille,\n\nThanks for helping out with this. \n\n>> Is it because you didn't know about session C? \n\nYes. I found out about session C by digging into the leader's txn log and the zookeeper server's log4j logs. The session id that was returned to the client was Session B, which it used to create the znode (which got a NodeExists). Also, session B was not expired, so the client was hoping the znode to be there.\n\n>>>> Since the leader processes create session and create znode for Session C first, shouldn't it be the session id that gets returned to the client as create session response ? Does this sound like a bug ?\n\n>> What does this mean in the context of the bug?\n\nWhen I said that, I was trying to reason about zookeeper behavior here. Since, session C existed on the leader first, and also created the znode, shouldn't it be the session id that is returned to the client. But what the client saw was a different session (session B). \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nehanarkhede","name":"nehanarkhede","key":"nehanarkhede","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Neha Narkhede","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-30T19:00:34.592+0000","updated":"2012-04-30T19:00:34.592+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1457/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05xmn:"}}