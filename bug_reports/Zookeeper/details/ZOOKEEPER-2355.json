{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12932170","self":"https://issues.apache.org/jira/rest/api/2/issue/12932170","key":"ZOOKEEPER-2355","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12339207","id":"12339207","description":"Fix release against 3.4 branch","name":"3.4.11","archived":false,"released":true,"releaseDate":"2017-11-09"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12340141","id":"12340141","description":"Beta release against 3.5 branch","name":"3.5.4","archived":false,"released":true,"releaseDate":"2018-05-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2016-01-18T22:43:40.840+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 03 15:58:24 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_2_*:*_966494824_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_2_*:*_47680540223","customfield_12312321":null,"resolutiondate":"2017-08-03T15:58:24.411+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2355/watchers","watchCount":19,"isWatching":false},"created":"2016-01-18T14:54:29.433+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326517","id":"12326517","description":"Fix release against 3.4 branch","name":"3.4.8","archived":false,"released":true,"releaseDate":"2016-02-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334700","id":"12334700","description":"Fix release against 3.4 branch","name":"3.4.9","archived":false,"released":true,"releaseDate":"2016-09-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12338036","id":"12338036","description":"Fix release against 3.4 branch","name":"3.4.10","archived":false,"released":true,"releaseDate":"2017-03-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326786","id":"12326786","description":"Alpha release against 3.5 branch","name":"3.5.1","archived":false,"released":true,"releaseDate":"2015-09-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12331981","id":"12331981","description":"Alpha release against 3.5 branch","name":"3.5.2","archived":false,"released":true,"releaseDate":"2016-07-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335444","id":"12335444","description":"Beta release against 3.5 branch","name":"3.5.3","archived":false,"released":true,"releaseDate":"2017-04-17"}],"issuelinks":[{"id":"12533770","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12533770","type":{"id":"12310560","name":"Problem/Incident","inward":"is caused by","outward":"causes","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310560"},"outwardIssue":{"id":"13158597","key":"ZOOKEEPER-3040","self":"https://issues.apache.org/jira/rest/api/2/issue/13158597","fields":{"summary":"flaky test EphemeralNodeDeletionTest","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12503713","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12503713","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12922993","key":"ZOOKEEPER-2348","self":"https://issues.apache.org/jira/rest/api/2/issue/12922993","fields":{"summary":"Data between leader and followers are not synchronized.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-10T22:25:19.668+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312379","id":"12312379","name":"quorum","description":"Quorum determination for ZooKeeper"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"ZooKeeper ephemeral node is never deleted if follower fail while reading the proposal packet\nThe scenario is as follows:\n# Configure three node ZooKeeper cluster, lets say nodes are A, B and C, start all, assume A is leader, B and C are follower\n# Connect to any of the server and create ephemeral node /e1\n# Close the session, ephemeral node /e1 will go for deletion\n# While receiving delete proposal make Follower B to fail with {{SocketTimeoutException}}. This we need to do to reproduce the scenario otherwise in production environment it happens because of network fault.\n# Remove the fault, just check that faulted Follower is now connected with quorum\n# Connect to any of the server, create the same ephemeral node /e1, created is success.\n# Close the session,  ephemeral node /e1 will go for deletion\n# {color:red}/e1 is not deleted from the faulted Follower B, It should have been deleted as it was again created with another session{color}\n# {color:green}/e1 is deleted from Leader A and other Follower C{color}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12782889","id":"12782889","filename":"ZOOKEEPER-2355-01.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-01-18T15:17:09.111+0000","size":13186,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12782889/ZOOKEEPER-2355-01.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12785227","id":"12785227","filename":"ZOOKEEPER-2355-02.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-01-29T19:20:46.200+0000","size":14644,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12785227/ZOOKEEPER-2355-02.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12809019","id":"12809019","filename":"ZOOKEEPER-2355-03.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2016-06-08T20:20:04.976+0000","size":14336,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12809019/ZOOKEEPER-2355-03.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12826909","id":"12826909","filename":"ZOOKEEPER-2355-04.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-09-02T18:42:02.609+0000","size":13384,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12826909/ZOOKEEPER-2355-04.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12833189","id":"12833189","filename":"ZOOKEEPER-2355-05.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-10-13T19:39:57.444+0000","size":15354,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12833189/ZOOKEEPER-2355-05.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Ephemeral node is never deleted if follower fails while reading the proposal packet","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"subtasks":[{"id":"13084409","key":"ZOOKEEPER-2834","self":"https://issues.apache.org/jira/rest/api/2/issue/13084409","fields":{"summary":"ZOOKEEPER-2355 fix for branch-3.4","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15105390","id":"15105390","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"At step 6, while creating the ephemeral node /e1  following error is observed at faulted node B but after adjusting the parent c version it continues and user does not get any error\n{code}\n2016-01-18 20:17:47,928 [myid:3] - DEBUG [CommitProcWorkThread-1:DataTree@961] - Failed: 72279218071011328,5,8589934597,1453128465886,1\n:'/e1,,v{s{31,s{'world,'anyone}}},T,2\n\norg.apache.zookeeper.KeeperException$NodeExistsException: KeeperErrorCode = NodeExists\n\tat org.apache.zookeeper.server.DataTree.createNode(DataTree.java:514)\n\tat org.apache.zookeeper.server.DataTree.processTxn(DataTree.java:827)\n\tat org.apache.zookeeper.server.ZKDatabase.processTxn(ZKDatabase.java:401)\n\tat org.apache.zookeeper.server.ZooKeeperServer.processTxn(ZooKeeperServer.java:1216)\n\tat org.apache.zookeeper.server.ZooKeeperServer.processTxn(ZooKeeperServer.java:1207)\n\tat org.apache.zookeeper.server.FinalRequestProcessor.processRequest(FinalRequestProcessor.java:109)\n\tat org.apache.zookeeper.server.quorum.CommitProcessor$CommitWorkRequest.doWork(CommitProcessor.java:296)\n\tat org.apache.zookeeper.server.WorkerService$ScheduledWorkRequest.run(WorkerService.java:162)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:745)\n2016-01-18 20:17:50,378 [myid:3] - DEBUG [CommitProcWorkThread-1:DataTree@1003] - Adjusting parent cversion for Txn: 1 path:/e1 err: -110\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-01-18T14:59:14.831+0000","updated":"2016-01-18T14:59:14.831+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15105413","id":"15105413","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"In think following points to be analysed to figure out the root cause,\n# When faulted server B joins the quorum after recovery, why still it has the extra node /e1, why not synchronized with the current leader.\n# Why only C version updated, why not the other information like ephemeral owner etc.\n\nSubmitting a test patch ZOOKEEPER-2355-01.patch for reproducing the scenario.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-01-18T15:15:33.298+0000","updated":"2016-01-18T15:15:33.298+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15105415","id":"15105415","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"test patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-01-18T15:17:09.121+0000","updated":"2016-01-18T15:17:09.121+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15105914","id":"15105914","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"I wonder if this is the same issue described in https://issues.apache.org/jira/browse/ZOOKEEPER-2145","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2016-01-18T22:43:40.840+0000","updated":"2016-01-18T22:43:40.840+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15106037","id":"15106037","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the patch [~arshad.mohammad] - reviewing it now.\n\n[~fpj], [~rakeshr]: if this bug is confirmed, do we want to include in 3.4.8? (probably yes)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-01-19T00:42:15.577+0000","updated":"2016-01-19T00:42:15.577+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15106050","id":"15106050","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"Well, the bug is apparently confirmed (I read the test case, it makes sense to me). Unclear on what the fix is. I'd definitely like to have this for 3.4.8. \n\n[~arshad.mohammad]: a few nits:\n\n* there's a typo in the filename for EphemralNodeNotDeletedTest.java \n* there are few extra (unneeded) tabs in QuorumPeerTestBase.java (you can see them with git diff)\n\nOther than that, the test looks great - thanks! ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-01-19T00:57:57.724+0000","updated":"2016-01-19T00:57:57.724+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15106060","id":"15106060","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"body":"Very good catch [~arshad.mohammad]! My two cents*:\n\nOther typo:\n\n{code}\nStat firstEphemralNode = new Stat();\n{code}\n\nPS: have been absent for a loooong time, coming back now, cheers! :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"created":"2016-01-19T01:05:46.126+0000","updated":"2016-01-19T01:05:46.126+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15106062","id":"15106062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"body":"oops, in fact, \"{{ephemral}}\" is repeated across the text.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"created":"2016-01-19T01:07:26.011+0000","updated":"2016-01-19T01:07:26.011+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15106073","id":"15106073","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"body":"Also, if the reason to add a {{QuorumPeer#getZkDb()}} is to use it in {{CustomPeer#makeFollower}} then **I** would advise to make this method **protected** instead of **public** as {{CustomPeer}} extends {{QuorumPeer}}. Making it public is too much exposition (imho) just to make a test run. A protected method is more conservative (again, imho).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eribeiro","name":"eribeiro","key":"eribeiro","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=eribeiro&avatarId=16169","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=eribeiro&avatarId=16169","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=eribeiro&avatarId=16169","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=eribeiro&avatarId=16169"},"displayName":"Edward Ribeiro","active":true,"timeZone":"America/Sao_Paulo"},"created":"2016-01-19T01:15:28.522+0000","updated":"2016-01-19T01:15:28.522+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15116752","id":"15116752","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"[~arshad.mohammad] could you have a look at the txn logs (using log formatter) and see what is in there in the situation you describe above?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-01-26T05:59:17.290+0000","updated":"2016-01-26T05:59:17.290+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15116850","id":"15116850","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"Hi [~fpj], I checked the transaction log and snapshot, both do not have entry for the failed transaction.\n# Because actual transaction proposal failed, it is expected that failed transaction will not be in the transaction log\n# While receiving the diff from leader, again proposal got failed, that is why no entry in snapshot also.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-01-26T07:19:22.263+0000","updated":"2016-01-26T07:19:22.263+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15116868","id":"15116868","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"The lastProcessedZxid is getting updated even proposal failed. So next time follower sends this updated zxid and getting blank DIFF. This is the root cause why sync is not happening. \n\nDon't know why lastProcessedZxid is updated here [Learner.java#L398|https://github.com/arshadmohammad/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/quorum/Learner.java#L398].\nas the data received still not presisted in case of DIFF.\n\n[~fpj], what is your thought on this","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-01-26T07:38:30.190+0000","updated":"2016-01-26T07:38:30.190+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15123912","id":"15123912","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"Per discussion in the mailing list, lets punt this to 3.4.9.\n\ncc: [~fpj]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-01-29T18:21:05.926+0000","updated":"2016-01-29T18:21:05.926+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15124029","id":"15124029","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"Thanks [~rgs], [~eribeiro] for your review comments on test code.\nSubmitting the solution. [~fpj] please have a look","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-01-29T19:20:46.211+0000","updated":"2016-01-29T19:20:46.211+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15124088","id":"15124088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12785227/ZOOKEEPER-2355-02.patch\n  against trunk revision 1726354.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 5 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3023//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3023//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3023//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-01-29T19:52:22.120+0000","updated":"2016-01-29T19:52:22.120+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15316819","id":"15316819","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=makuchta","name":"makuchta","key":"makuchta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Kuchta","active":true,"timeZone":"America/Denver"},"body":"[~arshad.mohammad]:\n\nI'm looking into fixing this since I'm seeing the same issue. I understand the reasoning behind your fix, but it seems to be causing some other tests to fail consistently when applied to trunk. The Jenkins build is too old to view, but I'm guessing it failed for similar reasons. Were you seeing these failures and did you look at what was happening? I've only scratched the surface with investigating this bug and your patch, but I wanted to check to avoid repeating any work you had already done. I'll keep investigating to see if I can find a solution.\n\nFailures listed below:\n\nZab1_0Test:\n{noformat}\nTestcase: testNormalFollowerRun took 4.198 sec\n    FAILED\nexpected:<4294967297> but was:<4294967296>\njunit.framework.AssertionFailedError: expected:<4294967297> but was:<4294967296>\n    at org.apache.zookeeper.server.quorum.Zab1_0Test$4.converseWithFollower(Zab1_0Test.java:705)\n    at org.apache.zookeeper.server.quorum.Zab1_0Test.testFollowerConversation(Zab1_0Test.java:511)\n    at org.apache.zookeeper.server.quorum.Zab1_0Test.testNormalFollowerRun(Zab1_0Test.java:643)\n    at org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:79)\n\nTestcase: testNormalFollowerRunWithDiff took 4.073 sec\n    FAILED\nexpected:<4294967298> but was:<4294967296>\njunit.framework.AssertionFailedError: expected:<4294967298> but was:<4294967296>\n    at org.apache.zookeeper.server.quorum.Zab1_0Test$5.converseWithFollower(Zab1_0Test.java:847)\n    at org.apache.zookeeper.server.quorum.Zab1_0Test.testFollowerConversation(Zab1_0Test.java:511)\n    at org.apache.zookeeper.server.quorum.Zab1_0Test.testNormalFollowerRunWithDiff(Zab1_0Test.java:771)\n    at org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:79)\n\nTestcase: testNormalObserverRun took 4.054 sec\n    FAILED\nexpected:<4294967298> but was:<4294967296>\njunit.framework.AssertionFailedError: expected:<4294967298> but was:<4294967296>\n    at org.apache.zookeeper.server.quorum.Zab1_0Test$8.converseWithObserver(Zab1_0Test.java:1072)\n    at org.apache.zookeeper.server.quorum.Zab1_0Test.testObserverConversation(Zab1_0Test.java:562)\n    at org.apache.zookeeper.server.quorum.Zab1_0Test.testNormalObserverRun(Zab1_0Test.java:997)\n    at org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:79)\n\n{noformat}\n\nZxidRolloverTest:\n{noformat}\nTestcase: testRolloverThenFollowerRestart took 23.677 sec\n    Caused an ERROR\nKeeperErrorCode = ConnectionLoss for /foofoofoo-connected\norg.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss for /foofoofoo-connected\n    at org.apache.zookeeper.KeeperException.create(KeeperException.java:99)\n    at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)\n    at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:1846)\n    at org.apache.zookeeper.ZooKeeper.exists(ZooKeeper.java:1874)\n    at org.apache.zookeeper.server.ZxidRolloverTest.checkClientConnected(ZxidRolloverTest.java:119)\n    at org.apache.zookeeper.server.ZxidRolloverTest.checkClientsConnected(ZxidRolloverTest.java:90)\n    at org.apache.zookeeper.server.ZxidRolloverTest.start(ZxidRolloverTest.java:165)\n    at org.apache.zookeeper.server.ZxidRolloverTest.testRolloverThenFollowerRestart(ZxidRolloverTest.java:345)\n    at org.apache.zookeeper.JUnit4ZKTestRunner$LoggedInvokeMethod.evaluate(JUnit4ZKTestRunner.java:79)\n{noformat}\n\nWatchEventWhenAutoResetTest:\n{noformat}\nTestcase: testNodeChildrenChanged took 0.001 sec\n    Caused an ERROR\nTimeout occurred. Please note the time in the report does not reflect the time until the timeout.\njunit.framework.AssertionFailedError: Timeout occurred. Please note the time in the report does not reflect the time until the timeout.\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=makuchta","name":"makuchta","key":"makuchta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Kuchta","active":true,"timeZone":"America/Denver"},"created":"2016-06-06T17:30:42.082+0000","updated":"2016-06-06T17:30:42.082+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15316897","id":"15316897","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12785227/ZOOKEEPER-2355-02.patch\n  against trunk revision 1746511.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 5 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3181//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3181//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3181//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-06T18:04:48.165+0000","updated":"2016-06-06T18:04:48.165+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15321334","id":"15321334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=makuchta","name":"makuchta","key":"makuchta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Kuchta","active":true,"timeZone":"America/Denver"},"body":"I've been playing with some variations on the proposed fix and trying to reason about what's actually going wrong. When syncing with the leader, of the three leader responses (DIFF, SNAP, TRUNC), I think there's only an issue with setting the last processed ZXID the way it's currently done in the DIFF case. In the SNAP and TRUNC cases, we've already deserialized the snapshot or truncated the log by the time setLastProcessedZxid is called. In the DIFF case, the reason it's incorrect is because we're setting the last processed ZXID as if we've already committed all the transactions we're about to receive, so a failure before that actually happens leaves us in an inconsistent state.\n\nThe logic in the patch of moving the call to setLastProcessedZxid to when the follower receives UPTODATE or NEWLEADER makes sense to me, but this isn't consistent with the behavior expected by some of the other unit tests.\n\nI don't think setLastProcessedZxid needs to be explicitly called at all when the follower receives a DIFF message because we will update the last processed ZXID as we commit transactions received from the leader anyway. I do think it needs to be preserved as-is for SNAP and TRUNC to keep the currently expected behavior. Whether there are other problematic scenarios associated with how SNAP and TRUNC are processed can be investigated separately since there may still be cases where the last processed ZXID and the actual transaction log state are out of sync.\n\nI'm submitting a modified version of the patch provided by [~arshad.mohammad]. The patch includes his original unit test which still fails against trunk and passes with the patch, but the changes to Learner.java are the slightly different ones that I'm proposing.\n\n(I do have two unit tests failing locally that are also failing against trunk, so I think it's an unrelated issue with my environment that I'll need to look into when I get time. If that turns out to not be the case based on the Jenkins build, I'll investigate.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=makuchta","name":"makuchta","key":"makuchta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Kuchta","active":true,"timeZone":"America/Denver"},"created":"2016-06-08T19:59:33.276+0000","updated":"2016-06-08T19:59:33.276+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15321366","id":"15321366","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"Martin is unable to attach patches to Jiras for some reason. So I'm going to help him out and cancel the existing patch and upload a new patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2016-06-08T20:18:52.754+0000","updated":"2016-06-08T20:18:52.754+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15321369","id":"15321369","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"Updated patch with Martin's proposed solution.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2016-06-08T20:20:04.981+0000","updated":"2016-06-08T20:20:04.981+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15321401","id":"15321401","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12809019/ZOOKEEPER-2355-03.patch\n  against trunk revision 1747408.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 6 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3185//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3185//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3185//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-08T20:37:27.523+0000","updated":"2016-06-08T20:37:27.523+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15321410","id":"15321410","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"[~makuchta] - I'll leave you to investigate the failure reported above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2016-06-08T20:41:39.125+0000","updated":"2016-06-08T20:43:06.820+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15321459","id":"15321459","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=makuchta","name":"makuchta","key":"makuchta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Kuchta","active":true,"timeZone":"America/Denver"},"body":"A search for the new test failures shows them as known flaky tests (ZOOKEEPER-1806, ZOOKEEPER-1807, ZOOKEEPER-2137), and they seem far removed from anything this patch touches. I haven't seen them at all locally.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=makuchta","name":"makuchta","key":"makuchta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Kuchta","active":true,"timeZone":"America/Denver"},"created":"2016-06-08T21:17:00.618+0000","updated":"2016-06-08T21:17:00.618+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15329621","id":"15329621","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Do we need a patch for 3.5 and trunk as well, or is it an issue only in the 3.4 branch?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-06-14T14:59:35.172+0000","updated":"2016-06-14T14:59:35.172+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15329856","id":"15329856","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I had a look at the latest patch and the solution sounds sensible. The patch doesn't apply to the 3.4, which is the one that this issue to be fixed in. I believe the issue exists in both 3.5 and trunk as well.\n\nI also liked the way the error was injected here. It'd be nice to have a more general and structured way of doing it so that we could use in other scenarios too. It is not a blocker for this patch, but really one of those \"nice to have\" features for my todo list.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-06-14T16:45:53.710+0000","updated":"2016-06-14T16:45:53.710+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15399696","id":"15399696","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks [~arshad.mohammad], [~makuchta] for working on this issue. The patch looks overall good. I've few comments:\n\n# Good test case. I could see an existing {{class MockTestQPMain}} in [RaceConditionTest.java|https://github.com/apache/zookeeper/blob/trunk/src/java/test/org/apache/zookeeper/server/quorum/RaceConditionTest.java#L235], can we reuse the same. One idea is to move MockTestQPMain class to a separate java file.\n# Can we include {{qp.getZxid()}} in the below log message.\n{code}\nLOG.info(\"Getting a snapshot from leader\");\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-07-29T17:09:40.854+0000","updated":"2016-07-29T17:09:40.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15414746","id":"15414746","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"One small nit, these two methods:\n\n{code}\n+    private QuorumPeer getLeader(MainThread[] mt) {\n+        for (int i = mt.length - 1; i >= 0; i--) {\n+            QuorumPeer quorumPeer = mt[i].getQuorumPeer();\n+            if (null != quorumPeer && ServerState.LEADING == quorumPeer.getPeerState()) {\n+                return quorumPeer;\n+            }\n+        }\n+        return null;\n+    }\n+\n+    private QuorumPeer getFollower(MainThread[] mt) {\n+        for (int i = mt.length - 1; i >= 0; i--) {\n+            QuorumPeer quorumPeer = mt[i].getQuorumPeer();\n+            if (null != quorumPeer && ServerState.FOLLOWING == quorumPeer.getPeerState()) {\n+                return quorumPeer;\n+            }\n+        }\n+        return null;\n+    }\n{code}\n\nCan probably be reduced to one more general method:\n\n{code}\n+    private QuorumPeer getByServerState(MainThread[] mt, ServerState state) {\n+        for (int i = mt.length - 1; i >= 0; i--) {\n+            QuorumPeer quorumPeer = mt[i].getQuorumPeer();\n+            if (null != quorumPeer && state == quorumPeer.getPeerState()) {\n+                return quorumPeer;\n+            }\n+        }\n+        return null;\n+    }\n{code}\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-10T05:40:49.742+0000","updated":"2016-08-10T05:40:49.742+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15422903","id":"15422903","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"I am moving this out to 3.4.10 for now. Please feel free to discuss the target version, Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-08-16T15:38:41.726+0000","updated":"2016-08-16T15:38:41.726+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15458720","id":"15458720","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=randgalt","name":"randgalt","key":"randgalt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=randgalt&avatarId=16746","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=randgalt&avatarId=16746","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=randgalt&avatarId=16746","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=randgalt&avatarId=16746"},"displayName":"Jordan Zimmerman","active":true,"timeZone":"America/Panama"},"body":"We've now experienced this at Elasticsearch. This is a Critical issue that should be released sooner rather than later.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=randgalt","name":"randgalt","key":"randgalt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=randgalt&avatarId=16746","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=randgalt&avatarId=16746","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=randgalt&avatarId=16746","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=randgalt&avatarId=16746"},"displayName":"Jordan Zimmerman","active":true,"timeZone":"America/Panama"},"created":"2016-09-02T14:46:03.293+0000","updated":"2016-09-02T14:46:03.293+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15458732","id":"15458732","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12809019/ZOOKEEPER-2355-03.patch\n  against trunk revision 1757584.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 6 new or modified tests.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3384//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-02T14:49:56.203+0000","updated":"2016-09-02T14:49:56.203+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15458926","id":"15458926","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"ping [~arshad.mohammad] [~makuchta].","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-09-02T16:10:03.643+0000","updated":"2016-09-02T16:10:03.643+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15459296","id":"15459296","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"# Submited ZOOKEEPER-2355-04.patch . This patch is for branch-3.5 and trunk, After commit to  branch-3.5 and trunk i will prepare patch for branch-3.4\n# Handled comments by [~rakeshr], I got better way to inject QuorumPeer. Modified RaceConditionTest.java also. Now I think there is no need to move the mock  classed to different class as not much code duplication\n# Handled comments by [~rgs]\n# Reanamed test class and test method and other small improvments","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-09-02T18:54:20.951+0000","updated":"2016-09-02T18:54:20.951+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15459343","id":"15459343","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12826909/ZOOKEEPER-2355-04.patch\n  against trunk revision 1757584.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 5 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3386//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3386//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3386//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-02T19:09:36.616+0000","updated":"2016-09-02T19:09:36.616+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15470796","id":"15470796","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=randgalt","name":"randgalt","key":"randgalt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=randgalt&avatarId=16746","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=randgalt&avatarId=16746","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=randgalt&avatarId=16746","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=randgalt&avatarId=16746"},"displayName":"Jordan Zimmerman","active":true,"timeZone":"America/Panama"},"body":"This is a very serious bug for us at Elasticsearch. Is there any way to get an emergency release out for this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=randgalt","name":"randgalt","key":"randgalt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=randgalt&avatarId=16746","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=randgalt&avatarId=16746","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=randgalt&avatarId=16746","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=randgalt&avatarId=16746"},"displayName":"Jordan Zimmerman","active":true,"timeZone":"America/Panama"},"created":"2016-09-07T14:33:52.282+0000","updated":"2016-09-07T14:33:52.282+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15470862","id":"15470862","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"I agree this is an important bug. Perhaps we could do thorough reviews and push the patch in so that make this fix ready for the next release, hopefully will include this in 3.4.10 version.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-09-07T15:04:10.778+0000","updated":"2016-09-07T15:04:10.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15470968","id":"15470968","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=randgalt","name":"randgalt","key":"randgalt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=randgalt&avatarId=16746","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=randgalt&avatarId=16746","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=randgalt&avatarId=16746","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=randgalt&avatarId=16746"},"displayName":"Jordan Zimmerman","active":true,"timeZone":"America/Panama"},"body":"FYI - We're on 3.5.x so that's needed as well","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=randgalt","name":"randgalt","key":"randgalt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=randgalt&avatarId=16746","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=randgalt&avatarId=16746","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=randgalt&avatarId=16746","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=randgalt&avatarId=16746"},"displayName":"Jordan Zimmerman","active":true,"timeZone":"America/Panama"},"created":"2016-09-07T15:46:38.552+0000","updated":"2016-09-07T15:46:38.552+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15471012","id":"15471012","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"sure, while committing will target branches {{3.4}}, {{3.5}} and trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-09-07T16:04:01.585+0000","updated":"2016-09-07T16:04:01.585+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15568748","id":"15568748","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"[~arshad.mohammad], Can you check 2nd point in the [review comment|https://issues.apache.org/jira/browse/ZOOKEEPER-2355?focusedCommentId=15399696&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15399696]. I think logging {{last processed zxid}} would help in debugging, right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-10-12T13:41:34.679+0000","updated":"2016-10-12T13:41:34.679+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15568820","id":"15568820","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks [~arshad.mohammad] for the patch. Just few comments, apart from this +1 from me.\n# Can you look at the 2nd point in [review comment|https://issues.apache.org/jira/browse/ZOOKEEPER-2355?focusedCommentId=15399696&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15399696]. I think logging {{last processed zxid}} would help in debugging, right?\n# Move {{mt = new MainThread}} this to the object reference like, {code}private MainThread[] mt = new MainThread[SERVER_COUNT];{code}\nThen make the teardown section like, \n{code}\n    @After\n    public void tearDown() {\n        // stop all severs\n        for (int i = 0; i < mt.length; i++) {\n            try {\n                if (mt[i] != null) {\n                    mt[i].shutdown();\n                }\n            } catch (InterruptedException e) {\n                LOG.warn(\"Quorum Peer interrupted while shutting it down\", e);\n            }\n        }\n    }\n{code}\n# Close {{followerZK.close();}} session at the end.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-10-12T14:05:31.471+0000","updated":"2016-10-12T14:05:31.471+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15572954","id":"15572954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"Thanks [~rakeshr],\nAddressed all the comments, submitted new patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-10-13T19:41:18.507+0000","updated":"2016-10-13T19:41:18.507+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15573023","id":"15573023","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12833189/ZOOKEEPER-2355-05.patch\n  against trunk revision f78061aafb19b102c37cb6d744ec6258d5f5b66e.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 5 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3489//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3489//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3489//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-10-13T20:09:11.143+0000","updated":"2016-10-13T20:09:11.143+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15580148","id":"15580148","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"+1, latest patch looks good to me.\n\nping  [~fpj], [~rgs], I will wait to see your votes before commits. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-10-16T15:42:06.651+0000","updated":"2016-10-16T15:42:06.651+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15676303","id":"15676303","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi [~arshad.mohammad],  it is better to open a pull request for wider reviews. Could you make the PR, please?. Since this is a critical issue, it would be good to get one more +1 from a committer.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-11-18T09:34:13.637+0000","updated":"2016-11-18T09:34:13.637+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15684421","id":"15684421","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user arshadmohammad opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/112\n\n    ZOOKEEPER-2355:Ephemeral node is never deleted if follower fails while reading the proposal packet\n\n    ZOOKEEPER-2355:Ephemeral node is never deleted if follower fails while reading the proposal packet\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/arshadmohammad/zookeeper ZOOKEEPER-2355\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/112.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #112\n    \n----\ncommit e8b2b59758c755afedfec8d6ab87d3f7ca0a0ffe\nAuthor: arshadmohammad <arshad.mohammad.k@gmail.com>\nDate:   2016-11-21T18:29:33Z\n\n    Ephemeral node is never deleted if follower fails while reading the proposal packet\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-21T18:59:31.165+0000","updated":"2016-11-21T18:59:31.165+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15684464","id":"15684464","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 5 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    -1 findbugs.  The patch appears to introduce 20 new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/83//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/83//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/83//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-21T19:18:52.006+0000","updated":"2016-11-21T19:18:52.006+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/15837989","id":"15837989","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12833189/ZOOKEEPER-2355-05.patch\n  against trunk revision 8771ffdaacb87126a485ae740558f6a288ab980b.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 5 new or modified tests.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3570//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-25T16:09:34.495+0000","updated":"2017-01-25T16:09:34.495+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16013446","id":"16013446","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fjcyue","name":"fjcyue","key":"fjcyue","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhenghua Chen","active":true,"timeZone":"Asia/Shanghai"},"body":"we saw this bug in 3.4.10, is there any schedule of fixing it in branch 3.4 ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fjcyue","name":"fjcyue","key":"fjcyue","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhenghua Chen","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-05-17T03:02:31.452+0000","updated":"2017-05-17T03:02:31.452+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16044155","id":"16044155","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"body":"Can this bug be fixed in 3.4.11??? As I know the consistency is the most important property of ZooKeeper, so I think this bug has higher priority than many others. \nHope it can be fixed soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiangjiafu","name":"jiangjiafu","key":"jiangjiafu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jiangjiafu&avatarId=31525","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jiangjiafu&avatarId=31525","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jiangjiafu&avatarId=31525","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jiangjiafu&avatarId=31525"},"displayName":"Jiafu Jiang","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2017-06-09T08:40:55.587+0000","updated":"2017-06-09T08:40:55.587+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16044196","id":"16044196","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"bq. Can this bug be fixed in 3.4.11???\nThanks for the interest [~fjcyue], [~jiangjiafu], will include this in 3.4.11, if there is no objection from anyone. Since the priority is critical, I'd like to see one more +1 from a committer.\n\nHi [~hanm], do you have some time to review this pull request and give your vote. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-06-09T09:19:44.963+0000","updated":"2017-06-09T09:19:44.963+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16044197","id":"16044197","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"It does look like a good candidate to be resolved soon. There is a patch available, but it seems to be stale. I also have had a look at it some time back, so I need to refresh my view.\n\nIn any case, help is appreciated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2017-06-09T09:19:55.035+0000","updated":"2017-06-09T09:19:55.035+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16044225","id":"16044225","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"[~fpj], I didn't see your comment, looks like we both commented at the same time:) Thanks for pitches in.\n\nYes, the [PR_112|https://github.com/apache/zookeeper/pull/112] has to be rebased. [~arshad.mohammad], would you mind rebasing the pull req.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-06-09T09:42:33.911+0000","updated":"2017-06-09T09:44:37.284+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16045624","id":"16045624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 2 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/782//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/782//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/782//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-10T17:34:56.656+0000","updated":"2017-06-10T17:34:56.656+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16048391","id":"16048391","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/112#discussion_r121793647\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java ---\n    @@ -390,6 +391,7 @@ else if (qp.getType() == Leader.SNAP) {\n                                 + Long.toHexString(qp.getZxid()));\n                         System.exit(13);\n                     }\n    +                zk.getZKDatabase().setlastProcessedZxid(qp.getZxid());\n    --- End diff --\n    \n    The fix looks good to me.\n    \n    I think we should also set the zxid extracted from the current proposal packet after each proposal is [committed](https://github.com/arshadmohammad/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/Learner.java#L460). Otherwise the follower will have a lagged view of the committed transactions, because with the fix in this patch, we will never do setlastProcessedZxid during a DIFF sync. For example imagine a case like this:\n    * Follower has its latest zxid with value a before DIFF SYNC happens.\n    * Leader send over proposals with zxids value b, c, d. \n    * Follower received and applied proposals b and c. Before follower had a chance to get hands on d, network partition happens.\n    * Now partition healed, follower will do a DIFF think again. Because the zk database would not be reloaded from logs (it's already initialized), follower has a skewed view of the world - it thinks it only has tnx a, but in fact it has a, b, and c. So rather asking b, c, and d, the follower could just ask d.\n    \n    Anyway I think it is an optimization that might worth doing - it is not functional critical because the idempotent nature of applying transactions.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-13T20:52:38.023+0000","updated":"2017-06-13T20:52:38.023+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16048398","id":"16048398","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/112#discussion_r121795494\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java ---\n    @@ -0,0 +1,222 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +package org.apache.zookeeper.server.quorum;\n    +\n    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;\n    +import static org.junit.Assert.assertEquals;\n    +import static org.junit.Assert.assertNotNull;\n    +import static org.junit.Assert.assertNull;\n    +\n    +import java.io.IOException;\n    +import java.net.SocketTimeoutException;\n    +\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.data.Stat;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;\n    +import org.apache.zookeeper.test.ClientBase;\n    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;\n    +import org.junit.After;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {\n    +    private static int SERVER_COUNT = 3;\n    +    private MainThread[] mt = new MainThread[SERVER_COUNT];\n    +\n    +    /**\n    +     * Test case for https://issues.apache.org/jira/browse/ZOOKEEPER-2355.\n    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading\n    +     * the proposal packet.\n    +     */\n    +\n    +    @Test(timeout = 120000)\n    +    public void testEphemeralNodeDeletion() throws Exception {\n    +        final int clientPorts[] = new int[SERVER_COUNT];\n    +        StringBuilder sb = new StringBuilder();\n    +        String server;\n    +\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            clientPorts[i] = PortAssignment.unique();\n    +            server = \"server.\" + i + \"=127.0.0.1:\" + PortAssignment.unique()\n    +                    + \":\" + PortAssignment.unique() + \":participant;127.0.0.1:\"\n    +                    + clientPorts[i];\n    +            sb.append(server + \"\\n\");\n    +        }\n    +        String currentQuorumCfgSection = sb.toString();\n    +        // start all the servers\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            mt[i] = new MainThread(i, clientPorts[i], currentQuorumCfgSection,\n    +                    false) {\n    +                @Override\n    +                public TestQPMain getTestQPMain() {\n    +                    return new MockTestQPMain();\n    +                }\n    +            };\n    +            mt[i].start();\n    +        }\n    +\n    +        // ensure all servers started\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            Assert.assertTrue(\"waiting for server \" + i + \" being up\",\n    +                    ClientBase.waitForServerUp(\"127.0.0.1:\" + clientPorts[i],\n    +                            CONNECTION_TIMEOUT));\n    +        }\n    +\n    +        CountdownWatcher watch = new CountdownWatcher();\n    +        ZooKeeper zk = new ZooKeeper(\"127.0.0.1:\" + clientPorts[1],\n    +                ClientBase.CONNECTION_TIMEOUT, watch);\n    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);\n    +\n    +        /**\n    +         * now the problem scenario starts\n    +         */\n    +\n    +        Stat firstEphemeralNode = new Stat();\n    +\n    +        // 1: create ephemeral node\n    +        String nodePath = \"/e1\";\n    +        zk.create(nodePath, \"1\".getBytes(), Ids.OPEN_ACL_UNSAFE,\n    +                CreateMode.EPHEMERAL, firstEphemeralNode);\n    +        assertEquals(\"Current session and ephemeral owner should be same\",\n    +                zk.getSessionId(), firstEphemeralNode.getEphemeralOwner());\n    +\n    +        // 2: inject network problem in one of the follower\n    +        CustomQuorumPeer follower = (CustomQuorumPeer) getByServerState(mt,\n    +                ServerState.FOLLOWING);\n    +        follower.setInjectError(true);\n    +\n    +        // 3: close the session so that ephemeral node is deleted\n    +        zk.close();\n    +\n    --- End diff --\n    \n    Yes the test case depends on these happened between starting of the partition (injected fault) and ending of the partition. The key invariant I see here is to make sure that during this period, the follower that currently disconnected with the quorum has gone through at least one leader election cycle and also have gone through at least one SYNC cycle. Otherwise the code path that this patch fixes will not be executed - i.e. there will be no errors during syncing the DIFF and everything will just work as expected. We need trigger at least one fault during the first DIFF sync cycle, and currently the test case is not doing this in a fine grained way and potentially due to timing issue we can get flaky behavior.\n    \n    Though, I am not sure how to precisely control this - I think it will be a nice improvement in test case to explicitly control the behavior as i just said, but this should not block this patch landed.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-13T21:00:22.273+0000","updated":"2017-06-13T21:00:22.273+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16048399","id":"16048399","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/112\n  \n    lgtm overall, with one nit on a potential optimization we can do and one potential improvement on test case. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-13T21:01:08.153+0000","updated":"2017-06-13T21:01:08.153+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16048411","id":"16048411","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"Just reviewed the patch, I think the key issue that this patch fixes is that each SYNC type should have transaction semantic around the {{setlastProcessedZxid}} - otherwise we might end up with inconsistent view when errors happen during SYNC phase. Previously TRNC and SNAP has transaction semantic W.R.T {{setlastProcessedZxid}} but DIFF does not. \n\nPatch looks good to me, though I am wondering what do you [~rakeshr], [~arshad.mohammad] [~fpj] think about the optimization I mentioned in the git PR. In addition I had a comment about test case which [~jiangjiafu] also observed similar issue but I don't think that is a blocker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-06-13T21:12:46.513+0000","updated":"2017-06-13T21:12:46.513+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16070800","id":"16070800","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/112\n  \n    If no objection I will commit this one soon given the interests and criticality of the fix.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-30T22:24:59.975+0000","updated":"2017-06-30T22:24:59.975+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16071488","id":"16071488","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/112\n  \n    @hanm, Thanks for the heads up. I will give my feedback soon, in a day or two.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-02T04:15:16.853+0000","updated":"2017-07-02T04:15:16.853+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16072263","id":"16072263","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/112#discussion_r125264767\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java ---\n    @@ -390,6 +391,7 @@ else if (qp.getType() == Leader.SNAP) {\n                                 + Long.toHexString(qp.getZxid()));\n                         System.exit(13);\n                     }\n    +                zk.getZKDatabase().setlastProcessedZxid(qp.getZxid());\n    --- End diff --\n    \n    @hanm, Do we have any issue created to handle this case, if not please create one for tracking this change. Thanks!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-03T11:08:04.416+0000","updated":"2017-07-03T11:08:04.416+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16072266","id":"16072266","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user rakeshadr commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/112\n  \n    Thanks Michael for pushing this long standing issue.\n    \n    +1 from me, I'm OK to commit this patch after creating an issue for the code changes suggested previously.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-03T11:10:23.379+0000","updated":"2017-07-03T11:10:23.379+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16073123","id":"16073123","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/112#discussion_r125391857\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/Learner.java ---\n    @@ -390,6 +391,7 @@ else if (qp.getType() == Leader.SNAP) {\n                                 + Long.toHexString(qp.getZxid()));\n                         System.exit(13);\n                     }\n    +                zk.getZKDatabase().setlastProcessedZxid(qp.getZxid());\n    --- End diff --\n    \n    @rakeshadr Created https://issues.apache.org/jira/browse/ZOOKEEPER-2833 to avoid this gets lost.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-04T05:32:36.983+0000","updated":"2017-07-04T05:32:36.983+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16073124","id":"16073124","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/112\n  \n    @rakeshadr Thanks for double check. Followed your suggestion created ZOOKEEPER-2833 tracking the optimization work. I am merging this now.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-04T05:33:23.384+0000","updated":"2017-07-04T05:33:23.384+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16073129","id":"16073129","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/112\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-04T05:40:26.070+0000","updated":"2017-07-04T05:40:26.070+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16073133","id":"16073133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"Committed to master 69710181042a8c1f0461c1739b96171d88f2b126, 3.5: ca22b3db19371f6b0f5507b7dd80b283cddc7700.\n\nPending resolve JIRA after committing to branch-3.4 - the current pull request has merge conflicts.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-07-04T05:45:33.956+0000","updated":"2017-07-04T05:45:33.956+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16073217","id":"16073217","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Jenkins build ZooKeeper-trunk #3454 (See [https://builds.apache.org/job/ZooKeeper-trunk/3454/])\nZOOKEEPER-2355: Ephemeral node is never deleted if follower fails while (hanm: rev 69710181042a8c1f0461c1739b96171d88f2b126)\n* (edit) src/java/main/org/apache/zookeeper/server/quorum/Learner.java\n* (add) src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-04T07:09:21.554+0000","updated":"2017-07-04T07:09:21.554+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16075797","id":"16075797","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user hanm opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/304\n\n    ZOOKEEPER-2355: Ephemeral node is never deleted if follower fails while reading the proposal packet.\n\n    This commit is a port of the commit ca22b3db19371f6b0f5507b7dd80b283cddc7700 from branch-3.5 to branch-3.4. Changes include a few interfaces that required by the test case. The test case itself is also updated so it works with 3.4 code base.\n    \n    @arshadmohammad @rakeshadr Could you please review this to close the loop of ZOOKEEPER-2355?\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/hanm/zookeeper ZOOKEEPER-2355\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/304.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #304\n    \n----\ncommit 007e2b37f24907c03e4e28547756b91aea4f78d4\nAuthor: Michael Han <hanm@apache.org>\nDate:   2017-07-05T21:23:58Z\n\n    ZOOKEEPER-2355: Ephemeral node is never deleted if follower fails while reading the proposal packet.\n    \n    This commit is a back port of the commit ca22b3db19371f6b0f5507b7dd80b283cddc7700 on branch-3.5. Changes include a few interfaces that required by the test case. The test case itself is also updated so it works with 3.4 code base.\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-06T02:05:44.043+0000","updated":"2017-07-06T02:05:44.043+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16075802","id":"16075802","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asdf2014 commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/304#discussion_r125798526\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java ---\n    @@ -0,0 +1,219 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +package org.apache.zookeeper.server.quorum;\n    +\n    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;\n    +import static org.junit.Assert.assertNotNull;\n    +import static org.junit.Assert.assertNull;\n    +\n    +import java.io.IOException;\n    +import java.net.SocketTimeoutException;\n    +\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.data.Stat;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;\n    +import org.apache.zookeeper.test.ClientBase;\n    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;\n    +import org.junit.After;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +import javax.security.sasl.SaslException;\n    +\n    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {\n    +    private static int SERVER_COUNT = 3;\n    +    private MainThread[] mt = new MainThread[SERVER_COUNT];\n    +\n    +    /**\n    +     * Test case for https://issues.apache.org/jira/browse/ZOOKEEPER-2355.\n    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading\n    +     * the proposal packet.\n    +     */\n    +\n    +    @Test(timeout = 120000)\n    +    public void testEphemeralNodeDeletion() throws Exception {\n    +        final int clientPorts[] = new int[SERVER_COUNT];\n    +        StringBuilder sb = new StringBuilder();\n    +        String server;\n    +\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            clientPorts[i] = PortAssignment.unique();\n    +            server = \"server.\" + i + \"=127.0.0.1:\" + PortAssignment.unique()\n    +                    + \":\" + PortAssignment.unique();\n    +            sb.append(server + \"\\n\");\n    --- End diff --\n    \n    Maybe use the following code style will be better.\n    ```java\n    sb.append(server).append(\"\\n\");\n    ```\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-06T02:13:22.297+0000","updated":"2017-07-06T02:13:22.297+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16075804","id":"16075804","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asdf2014 commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/304#discussion_r125798689\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java ---\n    @@ -0,0 +1,219 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +package org.apache.zookeeper.server.quorum;\n    +\n    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;\n    +import static org.junit.Assert.assertNotNull;\n    +import static org.junit.Assert.assertNull;\n    +\n    +import java.io.IOException;\n    +import java.net.SocketTimeoutException;\n    +\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.data.Stat;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;\n    +import org.apache.zookeeper.test.ClientBase;\n    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;\n    +import org.junit.After;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +import javax.security.sasl.SaslException;\n    +\n    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {\n    +    private static int SERVER_COUNT = 3;\n    +    private MainThread[] mt = new MainThread[SERVER_COUNT];\n    +\n    +    /**\n    +     * Test case for https://issues.apache.org/jira/browse/ZOOKEEPER-2355.\n    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading\n    +     * the proposal packet.\n    +     */\n    +\n    +    @Test(timeout = 120000)\n    +    public void testEphemeralNodeDeletion() throws Exception {\n    +        final int clientPorts[] = new int[SERVER_COUNT];\n    +        StringBuilder sb = new StringBuilder();\n    +        String server;\n    +\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            clientPorts[i] = PortAssignment.unique();\n    +            server = \"server.\" + i + \"=127.0.0.1:\" + PortAssignment.unique()\n    +                    + \":\" + PortAssignment.unique();\n    +            sb.append(server + \"\\n\");\n    +        }\n    +        String currentQuorumCfgSection = sb.toString();\n    +        System.out.println(currentQuorumCfgSection);\n    +        // start all the servers\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            mt[i] = new MainThread(i, clientPorts[i], currentQuorumCfgSection) {\n    +                @Override\n    +                public TestQPMain getTestQPMain() {\n    +                    return new MockTestQPMain();\n    +                }\n    +            };\n    +            mt[i].start();\n    +        }\n    +\n    +        // ensure all servers started\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            Assert.assertTrue(\"waiting for server \" + i + \" being up\",\n    +                    ClientBase.waitForServerUp(\"127.0.0.1:\" + clientPorts[i],\n    +                            CONNECTION_TIMEOUT));\n    +        }\n    +\n    +        CountdownWatcher watch = new CountdownWatcher();\n    +        ZooKeeper zk = new ZooKeeper(\"127.0.0.1:\" + clientPorts[1],\n    +                ClientBase.CONNECTION_TIMEOUT, watch);\n    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);\n    +\n    +        /**\n    +         * now the problem scenario starts\n    +         */\n    +\n    +        // 1: create ephemeral node\n    +        String nodePath = \"/e1\";\n    +        zk.create(nodePath, \"1\".getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n    +\n    +        // 2: inject network problem in one of the follower\n    +        CustomQuorumPeer follower = (CustomQuorumPeer) getByServerState(mt,\n    +                ServerState.FOLLOWING);\n    +        follower.setInjectError(true);\n    +\n    +        // 3: close the session so that ephemeral node is deleted\n    +        zk.close();\n    +\n    +        // remove the error\n    +        follower.setInjectError(false);\n    +\n    +        Assert.assertTrue(\"Faulted Follower should have joined quorum by now\",\n    +                ClientBase.waitForServerUp(\n    +                        \"127.0.0.1:\" + follower.getClientPort(),\n    +                        CONNECTION_TIMEOUT));\n    +\n    +        QuorumPeer leader = getByServerState(mt, ServerState.LEADING);\n    +        assertNotNull(\"Leader should not be null\", leader);\n    +        Assert.assertTrue(\"Leader must be running\", ClientBase.waitForServerUp(\n    +                \"127.0.0.1:\" + leader.getClientPort(), CONNECTION_TIMEOUT));\n    +\n    +        watch = new CountdownWatcher();\n    +        zk = new ZooKeeper(\"127.0.0.1:\" + leader.getClientPort(),\n    +                ClientBase.CONNECTION_TIMEOUT, watch);\n    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);\n    +\n    +        Stat exists = zk.exists(nodePath, false);\n    +        assertNull(\"Node must have been deleted from leader\", exists);\n    +\n    +        CountdownWatcher followerWatch = new CountdownWatcher();\n    +        ZooKeeper followerZK = new ZooKeeper(\n    +                \"127.0.0.1:\" + follower.getClientPort(),\n    +                ClientBase.CONNECTION_TIMEOUT, followerWatch);\n    +        followerWatch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);\n    +        Stat nodeAtFollower = followerZK.exists(nodePath, false);\n    +\n    +        // Problem 1: Follower had one extra ephemeral node /e1\n    +        assertNull(\"ephemeral node must not exist\", nodeAtFollower);\n    +\n    +        // Create the node with another session\n    +        zk.create(nodePath, \"2\".getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n    +\n    +        // close the session and newly created ephemeral node should be deleted\n    +        zk.close();\n    +\n    +        nodeAtFollower = followerZK.exists(nodePath, false);\n    +\n    +        // Problem 2: Before fix, after session close the ephemeral node\n    +        // was not getting deleted. But now after the fix after session close\n    +        // ephemeral node is getting deleted.\n    +        assertNull(\"After session close ephemeral node must be deleted\",\n    +                nodeAtFollower);\n    +        followerZK.close();\n    +    }\n    +\n    +    @After\n    +    public void tearDown() {\n    +        // stop all severs\n    +        for (int i = 0; i < mt.length; i++) {\n    +            try {\n    +                mt[i].shutdown();\n    +            } catch (InterruptedException e) {\n    +                LOG.warn(\"Quorum Peer interrupted while shutting it down\", e);\n    +            }\n    +        }\n    +    }\n    +\n    +    private QuorumPeer getByServerState(MainThread[] mt, ServerState state) {\n    +        for (int i = mt.length - 1; i >= 0; i--) {\n    +            QuorumPeer quorumPeer = mt[i].getQuorumPeer();\n    +            if (null != quorumPeer && state == quorumPeer.getPeerState()) {\n    +                return quorumPeer;\n    +            }\n    +        }\n    +        return null;\n    +    }\n    +\n    +    static class CustomQuorumPeer extends QuorumPeer  {\n    +        private boolean injectError = false;\n    +\n    +        public CustomQuorumPeer() throws SaslException {\n    +        }\n    +\n    +        @Override\n    +        protected Follower makeFollower(FileTxnSnapLog logFactory)\n    +                throws IOException {\n    +            return new Follower(this, new FollowerZooKeeperServer(logFactory,\n    +                    this, null /*DataTreeBuilder is never used*/,\n    +                    this.getZkDb())) {\n    +\n    +                @Override\n    +                void readPacket(QuorumPacket pp) throws IOException {\n    +                    /**\n    +                     * In real scenario got SocketTimeoutException while reading\n    +                     * the packet from leader because of network problem, but\n    +                     * here throwing SocketTimeoutException based on whether\n    +                     * error is injected or not\n    +                     */\n    +                    super.readPacket(pp);\n    +                    if (injectError && pp.getType() == Leader.PROPOSAL) {\n    +                        String type = LearnerHandler.packetToString(pp);\n    +                        throw new SocketTimeoutException(\n    +                                \"Socket timeout while reading the packet for operation \"\n    +                                        + type);\n    +                    }\n    +                }\n    +\n    +            };\n    +        }\n    +\n    +        public void setInjectError(boolean injectError) {\n    +            this.injectError = injectError;\n    +        }\n    +\n    +    }\n    +\n    +    static class MockTestQPMain extends TestQPMain {\n    +        @Override\n    +        protected QuorumPeer getQuorumPeer() throws SaslException {\n    +            return new CustomQuorumPeer();\n    +        }\n    +    }\n    +}\n    --- End diff --\n    \n    Should add a new line for the end of file.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-06T02:15:37.317+0000","updated":"2017-07-06T02:15:37.317+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16075825","id":"16075825","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 5 new or modified tests.\n\n    -1 javadoc.  The javadoc tool appears to have generated 1 warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/861//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/861//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/861//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-06T02:41:29.038+0000","updated":"2017-07-06T02:41:29.038+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16085152","id":"16085152","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/304#discussion_r127123189\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java ---\n    @@ -0,0 +1,219 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +package org.apache.zookeeper.server.quorum;\n    +\n    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;\n    +import static org.junit.Assert.assertNotNull;\n    +import static org.junit.Assert.assertNull;\n    +\n    +import java.io.IOException;\n    +import java.net.SocketTimeoutException;\n    +\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.data.Stat;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;\n    +import org.apache.zookeeper.test.ClientBase;\n    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;\n    +import org.junit.After;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +import javax.security.sasl.SaslException;\n    +\n    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {\n    +    private static int SERVER_COUNT = 3;\n    +    private MainThread[] mt = new MainThread[SERVER_COUNT];\n    +\n    +    /**\n    +     * Test case for https://issues.apache.org/jira/browse/ZOOKEEPER-2355.\n    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading\n    +     * the proposal packet.\n    +     */\n    +\n    +    @Test(timeout = 120000)\n    +    public void testEphemeralNodeDeletion() throws Exception {\n    +        final int clientPorts[] = new int[SERVER_COUNT];\n    +        StringBuilder sb = new StringBuilder();\n    +        String server;\n    +\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            clientPorts[i] = PortAssignment.unique();\n    +            server = \"server.\" + i + \"=127.0.0.1:\" + PortAssignment.unique()\n    +                    + \":\" + PortAssignment.unique();\n    +            sb.append(server + \"\\n\");\n    --- End diff --\n    \n    @asdf2014 Yes, I agree. Though I'd prefer doing this in a separate JIRA as a refactoring task as it's used everywhere in tests. If you have time, you are more than welcome to file a JIRA and do the refactoring work (btw, sorry for lagging on reviewing your refactoring patches, we got many high priority JIRAs in the backlog that we want to get in first.).\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-13T03:58:14.559+0000","updated":"2017-07-13T03:58:14.559+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16085153","id":"16085153","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/304#discussion_r127123221\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java ---\n    @@ -0,0 +1,219 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +package org.apache.zookeeper.server.quorum;\n    +\n    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;\n    +import static org.junit.Assert.assertNotNull;\n    +import static org.junit.Assert.assertNull;\n    +\n    +import java.io.IOException;\n    +import java.net.SocketTimeoutException;\n    +\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.data.Stat;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;\n    +import org.apache.zookeeper.test.ClientBase;\n    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;\n    +import org.junit.After;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +import javax.security.sasl.SaslException;\n    +\n    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {\n    +    private static int SERVER_COUNT = 3;\n    +    private MainThread[] mt = new MainThread[SERVER_COUNT];\n    +\n    +    /**\n    +     * Test case for https://issues.apache.org/jira/browse/ZOOKEEPER-2355.\n    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading\n    +     * the proposal packet.\n    +     */\n    +\n    +    @Test(timeout = 120000)\n    +    public void testEphemeralNodeDeletion() throws Exception {\n    +        final int clientPorts[] = new int[SERVER_COUNT];\n    +        StringBuilder sb = new StringBuilder();\n    +        String server;\n    +\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            clientPorts[i] = PortAssignment.unique();\n    +            server = \"server.\" + i + \"=127.0.0.1:\" + PortAssignment.unique()\n    +                    + \":\" + PortAssignment.unique();\n    +            sb.append(server + \"\\n\");\n    +        }\n    +        String currentQuorumCfgSection = sb.toString();\n    +        System.out.println(currentQuorumCfgSection);\n    +        // start all the servers\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            mt[i] = new MainThread(i, clientPorts[i], currentQuorumCfgSection) {\n    +                @Override\n    +                public TestQPMain getTestQPMain() {\n    +                    return new MockTestQPMain();\n    +                }\n    +            };\n    +            mt[i].start();\n    +        }\n    +\n    +        // ensure all servers started\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            Assert.assertTrue(\"waiting for server \" + i + \" being up\",\n    +                    ClientBase.waitForServerUp(\"127.0.0.1:\" + clientPorts[i],\n    +                            CONNECTION_TIMEOUT));\n    +        }\n    +\n    +        CountdownWatcher watch = new CountdownWatcher();\n    +        ZooKeeper zk = new ZooKeeper(\"127.0.0.1:\" + clientPorts[1],\n    +                ClientBase.CONNECTION_TIMEOUT, watch);\n    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);\n    +\n    +        /**\n    +         * now the problem scenario starts\n    +         */\n    +\n    +        // 1: create ephemeral node\n    +        String nodePath = \"/e1\";\n    +        zk.create(nodePath, \"1\".getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n    +\n    +        // 2: inject network problem in one of the follower\n    +        CustomQuorumPeer follower = (CustomQuorumPeer) getByServerState(mt,\n    +                ServerState.FOLLOWING);\n    +        follower.setInjectError(true);\n    +\n    +        // 3: close the session so that ephemeral node is deleted\n    +        zk.close();\n    +\n    +        // remove the error\n    +        follower.setInjectError(false);\n    +\n    +        Assert.assertTrue(\"Faulted Follower should have joined quorum by now\",\n    +                ClientBase.waitForServerUp(\n    +                        \"127.0.0.1:\" + follower.getClientPort(),\n    +                        CONNECTION_TIMEOUT));\n    +\n    +        QuorumPeer leader = getByServerState(mt, ServerState.LEADING);\n    +        assertNotNull(\"Leader should not be null\", leader);\n    +        Assert.assertTrue(\"Leader must be running\", ClientBase.waitForServerUp(\n    +                \"127.0.0.1:\" + leader.getClientPort(), CONNECTION_TIMEOUT));\n    +\n    +        watch = new CountdownWatcher();\n    +        zk = new ZooKeeper(\"127.0.0.1:\" + leader.getClientPort(),\n    +                ClientBase.CONNECTION_TIMEOUT, watch);\n    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);\n    +\n    +        Stat exists = zk.exists(nodePath, false);\n    +        assertNull(\"Node must have been deleted from leader\", exists);\n    +\n    +        CountdownWatcher followerWatch = new CountdownWatcher();\n    +        ZooKeeper followerZK = new ZooKeeper(\n    +                \"127.0.0.1:\" + follower.getClientPort(),\n    +                ClientBase.CONNECTION_TIMEOUT, followerWatch);\n    +        followerWatch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);\n    +        Stat nodeAtFollower = followerZK.exists(nodePath, false);\n    +\n    +        // Problem 1: Follower had one extra ephemeral node /e1\n    +        assertNull(\"ephemeral node must not exist\", nodeAtFollower);\n    +\n    +        // Create the node with another session\n    +        zk.create(nodePath, \"2\".getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n    +\n    +        // close the session and newly created ephemeral node should be deleted\n    +        zk.close();\n    +\n    +        nodeAtFollower = followerZK.exists(nodePath, false);\n    +\n    +        // Problem 2: Before fix, after session close the ephemeral node\n    +        // was not getting deleted. But now after the fix after session close\n    +        // ephemeral node is getting deleted.\n    +        assertNull(\"After session close ephemeral node must be deleted\",\n    +                nodeAtFollower);\n    +        followerZK.close();\n    +    }\n    +\n    +    @After\n    +    public void tearDown() {\n    +        // stop all severs\n    +        for (int i = 0; i < mt.length; i++) {\n    +            try {\n    +                mt[i].shutdown();\n    +            } catch (InterruptedException e) {\n    +                LOG.warn(\"Quorum Peer interrupted while shutting it down\", e);\n    +            }\n    +        }\n    +    }\n    +\n    +    private QuorumPeer getByServerState(MainThread[] mt, ServerState state) {\n    +        for (int i = mt.length - 1; i >= 0; i--) {\n    +            QuorumPeer quorumPeer = mt[i].getQuorumPeer();\n    +            if (null != quorumPeer && state == quorumPeer.getPeerState()) {\n    +                return quorumPeer;\n    +            }\n    +        }\n    +        return null;\n    +    }\n    +\n    +    static class CustomQuorumPeer extends QuorumPeer  {\n    +        private boolean injectError = false;\n    +\n    +        public CustomQuorumPeer() throws SaslException {\n    +        }\n    +\n    +        @Override\n    +        protected Follower makeFollower(FileTxnSnapLog logFactory)\n    +                throws IOException {\n    +            return new Follower(this, new FollowerZooKeeperServer(logFactory,\n    +                    this, null /*DataTreeBuilder is never used*/,\n    +                    this.getZkDb())) {\n    +\n    +                @Override\n    +                void readPacket(QuorumPacket pp) throws IOException {\n    +                    /**\n    +                     * In real scenario got SocketTimeoutException while reading\n    +                     * the packet from leader because of network problem, but\n    +                     * here throwing SocketTimeoutException based on whether\n    +                     * error is injected or not\n    +                     */\n    +                    super.readPacket(pp);\n    +                    if (injectError && pp.getType() == Leader.PROPOSAL) {\n    +                        String type = LearnerHandler.packetToString(pp);\n    +                        throw new SocketTimeoutException(\n    +                                \"Socket timeout while reading the packet for operation \"\n    +                                        + type);\n    +                    }\n    +                }\n    +\n    +            };\n    +        }\n    +\n    +        public void setInjectError(boolean injectError) {\n    +            this.injectError = injectError;\n    +        }\n    +\n    +    }\n    +\n    +    static class MockTestQPMain extends TestQPMain {\n    +        @Override\n    +        protected QuorumPeer getQuorumPeer() throws SaslException {\n    +            return new CustomQuorumPeer();\n    +        }\n    +    }\n    +}\n    --- End diff --\n    \n    I'll update once I collect all feedbacks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-13T03:58:31.073+0000","updated":"2017-07-13T03:58:31.073+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16085155","id":"16085155","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/304\n  \n    @arshadmohammad @rakeshadr gentle nudge on reviewing this before it's getting stale. We already have this in 3.5 and master, and this is to get same change in 3.4.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-13T03:59:10.537+0000","updated":"2017-07-13T03:59:10.537+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16085239","id":"16085239","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asdf2014 commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/304#discussion_r127135317\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java ---\n    @@ -0,0 +1,219 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +package org.apache.zookeeper.server.quorum;\n    +\n    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;\n    +import static org.junit.Assert.assertNotNull;\n    +import static org.junit.Assert.assertNull;\n    +\n    +import java.io.IOException;\n    +import java.net.SocketTimeoutException;\n    +\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.data.Stat;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;\n    +import org.apache.zookeeper.test.ClientBase;\n    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;\n    +import org.junit.After;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +import javax.security.sasl.SaslException;\n    +\n    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {\n    +    private static int SERVER_COUNT = 3;\n    +    private MainThread[] mt = new MainThread[SERVER_COUNT];\n    +\n    +    /**\n    +     * Test case for https://issues.apache.org/jira/browse/ZOOKEEPER-2355.\n    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading\n    +     * the proposal packet.\n    +     */\n    +\n    +    @Test(timeout = 120000)\n    +    public void testEphemeralNodeDeletion() throws Exception {\n    +        final int clientPorts[] = new int[SERVER_COUNT];\n    +        StringBuilder sb = new StringBuilder();\n    +        String server;\n    +\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            clientPorts[i] = PortAssignment.unique();\n    +            server = \"server.\" + i + \"=127.0.0.1:\" + PortAssignment.unique()\n    +                    + \":\" + PortAssignment.unique();\n    +            sb.append(server + \"\\n\");\n    --- End diff --\n    \n    @hanm Okay, After this patch merged, i will do the refactoring work in a separate `JIRA`. I understand we should put more attentions into the high priority tasks, thank you for explaining this. :D\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-13T06:12:33.299+0000","updated":"2017-07-13T06:12:33.299+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16085241","id":"16085241","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asdf2014 commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/304#discussion_r127135485\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/EphemeralNodeDeletionTest.java ---\n    @@ -0,0 +1,219 @@\n    +/**\n    + * Licensed to the Apache Software Foundation (ASF) under one\n    + * or more contributor license agreements.  See the NOTICE file\n    + * distributed with this work for additional information\n    + * regarding copyright ownership.  The ASF licenses this file\n    + * to you under the Apache License, Version 2.0 (the\n    + * \"License\"); you may not use this file except in compliance\n    + * with the License.  You may obtain a copy of the License at\n    + *\n    + *     http://www.apache.org/licenses/LICENSE-2.0\n    + *\n    + * Unless required by applicable law or agreed to in writing, software\n    + * distributed under the License is distributed on an \"AS IS\" BASIS,\n    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    + * See the License for the specific language governing permissions and\n    + * limitations under the License.\n    + */\n    +package org.apache.zookeeper.server.quorum;\n    +\n    +import static org.apache.zookeeper.test.ClientBase.CONNECTION_TIMEOUT;\n    +import static org.junit.Assert.assertNotNull;\n    +import static org.junit.Assert.assertNull;\n    +\n    +import java.io.IOException;\n    +import java.net.SocketTimeoutException;\n    +\n    +import org.apache.zookeeper.CreateMode;\n    +import org.apache.zookeeper.PortAssignment;\n    +import org.apache.zookeeper.ZooDefs.Ids;\n    +import org.apache.zookeeper.ZooKeeper;\n    +import org.apache.zookeeper.data.Stat;\n    +import org.apache.zookeeper.server.persistence.FileTxnSnapLog;\n    +import org.apache.zookeeper.server.quorum.QuorumPeer.ServerState;\n    +import org.apache.zookeeper.test.ClientBase;\n    +import org.apache.zookeeper.test.ClientBase.CountdownWatcher;\n    +import org.junit.After;\n    +import org.junit.Assert;\n    +import org.junit.Test;\n    +\n    +import javax.security.sasl.SaslException;\n    +\n    +public class EphemeralNodeDeletionTest extends QuorumPeerTestBase {\n    +    private static int SERVER_COUNT = 3;\n    +    private MainThread[] mt = new MainThread[SERVER_COUNT];\n    +\n    +    /**\n    +     * Test case for https://issues.apache.org/jira/browse/ZOOKEEPER-2355.\n    +     * ZooKeeper ephemeral node is never deleted if follower fail while reading\n    +     * the proposal packet.\n    +     */\n    +\n    +    @Test(timeout = 120000)\n    +    public void testEphemeralNodeDeletion() throws Exception {\n    +        final int clientPorts[] = new int[SERVER_COUNT];\n    +        StringBuilder sb = new StringBuilder();\n    +        String server;\n    +\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            clientPorts[i] = PortAssignment.unique();\n    +            server = \"server.\" + i + \"=127.0.0.1:\" + PortAssignment.unique()\n    +                    + \":\" + PortAssignment.unique();\n    +            sb.append(server + \"\\n\");\n    +        }\n    +        String currentQuorumCfgSection = sb.toString();\n    +        System.out.println(currentQuorumCfgSection);\n    +        // start all the servers\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            mt[i] = new MainThread(i, clientPorts[i], currentQuorumCfgSection) {\n    +                @Override\n    +                public TestQPMain getTestQPMain() {\n    +                    return new MockTestQPMain();\n    +                }\n    +            };\n    +            mt[i].start();\n    +        }\n    +\n    +        // ensure all servers started\n    +        for (int i = 0; i < SERVER_COUNT; i++) {\n    +            Assert.assertTrue(\"waiting for server \" + i + \" being up\",\n    +                    ClientBase.waitForServerUp(\"127.0.0.1:\" + clientPorts[i],\n    +                            CONNECTION_TIMEOUT));\n    +        }\n    +\n    +        CountdownWatcher watch = new CountdownWatcher();\n    +        ZooKeeper zk = new ZooKeeper(\"127.0.0.1:\" + clientPorts[1],\n    +                ClientBase.CONNECTION_TIMEOUT, watch);\n    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);\n    +\n    +        /**\n    +         * now the problem scenario starts\n    +         */\n    +\n    +        // 1: create ephemeral node\n    +        String nodePath = \"/e1\";\n    +        zk.create(nodePath, \"1\".getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n    +\n    +        // 2: inject network problem in one of the follower\n    +        CustomQuorumPeer follower = (CustomQuorumPeer) getByServerState(mt,\n    +                ServerState.FOLLOWING);\n    +        follower.setInjectError(true);\n    +\n    +        // 3: close the session so that ephemeral node is deleted\n    +        zk.close();\n    +\n    +        // remove the error\n    +        follower.setInjectError(false);\n    +\n    +        Assert.assertTrue(\"Faulted Follower should have joined quorum by now\",\n    +                ClientBase.waitForServerUp(\n    +                        \"127.0.0.1:\" + follower.getClientPort(),\n    +                        CONNECTION_TIMEOUT));\n    +\n    +        QuorumPeer leader = getByServerState(mt, ServerState.LEADING);\n    +        assertNotNull(\"Leader should not be null\", leader);\n    +        Assert.assertTrue(\"Leader must be running\", ClientBase.waitForServerUp(\n    +                \"127.0.0.1:\" + leader.getClientPort(), CONNECTION_TIMEOUT));\n    +\n    +        watch = new CountdownWatcher();\n    +        zk = new ZooKeeper(\"127.0.0.1:\" + leader.getClientPort(),\n    +                ClientBase.CONNECTION_TIMEOUT, watch);\n    +        watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);\n    +\n    +        Stat exists = zk.exists(nodePath, false);\n    +        assertNull(\"Node must have been deleted from leader\", exists);\n    +\n    +        CountdownWatcher followerWatch = new CountdownWatcher();\n    +        ZooKeeper followerZK = new ZooKeeper(\n    +                \"127.0.0.1:\" + follower.getClientPort(),\n    +                ClientBase.CONNECTION_TIMEOUT, followerWatch);\n    +        followerWatch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);\n    +        Stat nodeAtFollower = followerZK.exists(nodePath, false);\n    +\n    +        // Problem 1: Follower had one extra ephemeral node /e1\n    +        assertNull(\"ephemeral node must not exist\", nodeAtFollower);\n    +\n    +        // Create the node with another session\n    +        zk.create(nodePath, \"2\".getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n    +\n    +        // close the session and newly created ephemeral node should be deleted\n    +        zk.close();\n    +\n    +        nodeAtFollower = followerZK.exists(nodePath, false);\n    +\n    +        // Problem 2: Before fix, after session close the ephemeral node\n    +        // was not getting deleted. But now after the fix after session close\n    +        // ephemeral node is getting deleted.\n    +        assertNull(\"After session close ephemeral node must be deleted\",\n    +                nodeAtFollower);\n    +        followerZK.close();\n    +    }\n    +\n    +    @After\n    +    public void tearDown() {\n    +        // stop all severs\n    +        for (int i = 0; i < mt.length; i++) {\n    +            try {\n    +                mt[i].shutdown();\n    +            } catch (InterruptedException e) {\n    +                LOG.warn(\"Quorum Peer interrupted while shutting it down\", e);\n    +            }\n    +        }\n    +    }\n    +\n    +    private QuorumPeer getByServerState(MainThread[] mt, ServerState state) {\n    +        for (int i = mt.length - 1; i >= 0; i--) {\n    +            QuorumPeer quorumPeer = mt[i].getQuorumPeer();\n    +            if (null != quorumPeer && state == quorumPeer.getPeerState()) {\n    +                return quorumPeer;\n    +            }\n    +        }\n    +        return null;\n    +    }\n    +\n    +    static class CustomQuorumPeer extends QuorumPeer  {\n    +        private boolean injectError = false;\n    +\n    +        public CustomQuorumPeer() throws SaslException {\n    +        }\n    +\n    +        @Override\n    +        protected Follower makeFollower(FileTxnSnapLog logFactory)\n    +                throws IOException {\n    +            return new Follower(this, new FollowerZooKeeperServer(logFactory,\n    +                    this, null /*DataTreeBuilder is never used*/,\n    +                    this.getZkDb())) {\n    +\n    +                @Override\n    +                void readPacket(QuorumPacket pp) throws IOException {\n    +                    /**\n    +                     * In real scenario got SocketTimeoutException while reading\n    +                     * the packet from leader because of network problem, but\n    +                     * here throwing SocketTimeoutException based on whether\n    +                     * error is injected or not\n    +                     */\n    +                    super.readPacket(pp);\n    +                    if (injectError && pp.getType() == Leader.PROPOSAL) {\n    +                        String type = LearnerHandler.packetToString(pp);\n    +                        throw new SocketTimeoutException(\n    +                                \"Socket timeout while reading the packet for operation \"\n    +                                        + type);\n    +                    }\n    +                }\n    +\n    +            };\n    +        }\n    +\n    +        public void setInjectError(boolean injectError) {\n    +            this.injectError = injectError;\n    +        }\n    +\n    +    }\n    +\n    +    static class MockTestQPMain extends TestQPMain {\n    +        @Override\n    +        protected QuorumPeer getQuorumPeer() throws SaslException {\n    +            return new CustomQuorumPeer();\n    +        }\n    +    }\n    +}\n    --- End diff --\n    \n    Thanks a lot! It will be a huge job. Look forward to!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-13T06:14:16.650+0000","updated":"2017-07-13T06:14:16.650+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16110269","id":"16110269","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/304\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-02T04:15:52.616+0000","updated":"2017-08-02T04:15:52.616+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16110270","id":"16110270","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user hanm reopened a pull request:\n\n    https://github.com/apache/zookeeper/pull/304\n\n    ZOOKEEPER-2355: Ephemeral node is never deleted if follower fails while reading the proposal packet.\n\n    This commit is a port of the commit ca22b3db19371f6b0f5507b7dd80b283cddc7700 from branch-3.5 to branch-3.4. Changes include a few interfaces that required by the test case. The test case itself is also updated so it works with 3.4 code base.\n    \n    @arshadmohammad @rakeshadr Could you please review this to close the loop of ZOOKEEPER-2355?\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/hanm/zookeeper ZOOKEEPER-2355\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/304.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #304\n    \n----\ncommit 007e2b37f24907c03e4e28547756b91aea4f78d4\nAuthor: Michael Han <hanm@apache.org>\nDate:   2017-07-05T21:23:58Z\n\n    ZOOKEEPER-2355: Ephemeral node is never deleted if follower fails while reading the proposal packet.\n    \n    This commit is a back port of the commit ca22b3db19371f6b0f5507b7dd80b283cddc7700 on branch-3.5. Changes include a few interfaces that required by the test case. The test case itself is also updated so it works with 3.4 code base.\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-02T04:15:54.423+0000","updated":"2017-08-02T04:15:54.423+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16110301","id":"16110301","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 5 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/915//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/915//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/915//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-02T04:52:31.559+0000","updated":"2017-08-02T04:52:31.559+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16112212","id":"16112212","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user arshadmohammad commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/304\n  \n    LGTM +1\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-03T05:26:44.104+0000","updated":"2017-08-03T05:26:44.104+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16112984","id":"16112984","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/304\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-03T15:55:40.077+0000","updated":"2017-08-03T15:55:40.077+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16112989","id":"16112989","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/304\n  \n    Thanks for reviewing @arshadmohammad. Committed to 3.4: https://github.com/apache/zookeeper/commit/1789e0d6f5d4dd170193f4c13fb381e98597db77\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-03T15:56:15.273+0000","updated":"2017-08-03T15:56:15.273+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12932170/comment/16112991","id":"16112991","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"Resolving issue as Fixed now it's committed to all branches:\nmaster: https://github.com/apache/zookeeper/commit/69710181042a8c1f0461c1739b96171d88f2b126\n3.5: \nhttps://github.com/apache/zookeeper/commit/ca22b3db19371f6b0f5507b7dd80b283cddc7700\n3.4:\nhttps://github.com/apache/zookeeper/commit/1789e0d6f5d4dd170193f4c13fb381e98597db77","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-08-03T15:58:24.455+0000","updated":"2017-08-03T15:58:24.455+0000"}],"maxResults":81,"total":81,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2355/votes","votes":12,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2rn73:"}}