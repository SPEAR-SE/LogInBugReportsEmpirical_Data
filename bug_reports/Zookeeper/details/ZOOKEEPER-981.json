{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12497380","self":"https://issues.apache.org/jira/rest/api/2/issue/12497380","key":"ZOOKEEPER-981","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314469","id":"12314469","description":"Kerberos client auth, multi support, deb/rpm pkging.","name":"3.4.0","archived":false,"released":true,"releaseDate":"2011-11-22"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-02-02T18:48:51.265+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Nov 18 16:55:53 UTC 2011","customfield_12310420":"47522","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_5135199939_*|*_1_*:*_1_*:*_14246455834_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-09-14T04:10:37.237+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-981/watchers","watchCount":6,"isWatching":false},"created":"2011-02-01T20:23:01.578+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315108","id":"12315108","description":"Fix release against 3.3 branch","name":"3.3.2","archived":false,"released":true,"releaseDate":"2010-11-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-23T19:22:00.382+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312380","id":"12312380","name":"c client","description":"The c client interface to ZooKeeper"}],"timeoriginalestimate":null,"description":"I saw a hang once when my C++ application called the zookeeper_close() method of the multi-threaded Zookeeper client library.  The stack trace of the hung thread was the following:\n\n{quote}\nThread 8 (Thread 5644):\n#0  0x00007f5d7bb5bbe4 in __lll_lock_wait () from /lib/libpthread.so.0\n#1  0x00007f5d7bb59ad0 in pthread_cond_broadcast@@GLIBC_2.3.2 () from /lib/libpthread.so.0\n#2  0x00007f5d793628f6 in unlock_completion_list (l=0x32b4d68) at .../zookeeper/src/c/src/mt_adaptor.c:66\n#3  0x00007f5d79354d4b in free_completions (zh=0x32b4c80, callCompletion=1, reason=-116) at .../zookeeper/src/c/src/zookeeper.c:1069\n#4  0x00007f5d79355008 in cleanup_bufs (zh=0x32b4c80, callCompletion=1, rc=-116) at .../thirdparty/zookeeper/src/c/src/zookeeper.c:1125\n#5  0x00007f5d79353200 in destroy (zh=0x32b4c80) at .../thirdparty/zookeeper/src/c/src/zookeeper.c:366\n#6  0x00007f5d79358e0e in zookeeper_close (zh=0x32b4c80) at .../zookeeper/src/c/src/zookeeper.c:2326\n#7  0x00007f5d79356d18 in api_epilog (zh=0x32b4c80, rc=0) at .../zookeeper/src/c/src/zookeeper.c:1661\n#8  0x00007f5d79362f2f in adaptor_finish (zh=0x32b4c80) at .../zookeeper/src/c/src/mt_adaptor.c:205\n#9  0x00007f5d79358c8c in zookeeper_close (zh=0x32b4c80) at .../zookeeper/src/c/src/zookeeper.c:2297 \n...\n{quote}\n\nThe omitted part of the stack trace is entirely within my application, and contains no other calls to/from the Zookeeper client.  In particular, I am not calling zookeeper_close() from within a completion handler or any of the library's threads.\n\nI haven't been able to reproduce this, and when I encountered this I wasn't capturing logging from the client library, so unfortunately I don't have any more information at this time.  But I will update this JIRA if I see it again.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12472730","id":"12472730","filename":"zookeeper-981.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2011-03-05T02:48:02.828+0000","size":1153,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12472730/zookeeper-981.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12471413","id":"12471413","filename":"ZOOKEEPER-981.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsulin","name":"tsulin","key":"tsulin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"tsulin","active":true,"timeZone":"Etc/UTC"},"created":"2011-02-18T16:08:39.095+0000","size":1449,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12471413/ZOOKEEPER-981.tar.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12486732","id":"12486732","filename":"ZOOKEEPER-981-v1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-16T17:43:51.125+0000","size":1167,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12486732/ZOOKEEPER-981-v1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32790","customfield_12312823":null,"summary":"Hang in zookeeper_close() in the multi-threaded C client","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Debian Squeeze, Linux 2.6.32-5, x86_64","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/12989741","id":"12989741","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"we have seen this happen when zookeeper functions, including zookeeper_close(), are called on handles that have already been closed. (aka double free.) is it possible that you had previously called zookeeper_close() on the handle?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-02-02T18:48:51.265+0000","updated":"2011-02-02T18:48:51.265+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/12989752","id":"12989752","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"Not in any way that I can see.  The only code in my app that calls zookeeper_close() looks like this:\n\n{quote}\n  if (_zk_handle != NULL) {\n    // assume for now that there is only a single zookeeper client instance\n    assert(_closing_zh == NULL);\n    _closing_zh = _zk_handle;\n    ...\n    zookeeper_close(_zk_handle);\n    _zk_handle = NULL;\n    ...\n  }\n{quote}\n\nIn order to call zookeeper_close() twice on the same handle, it would have to pass through that assert, which would have failed.  (The app uses non-preemptive cooperative threading, so there shouldn't be any races there.)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2011-02-02T19:07:25.068+0000","updated":"2011-02-02T19:07:25.068+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/12989753","id":"12989753","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"Oops, sorry.  Here's the code again:\n{code}\n  if (_zk_handle != NULL) {\n    assert(_closing_zh == NULL);\n    _closing_zh = _zk_handle;\n    ...\n    zookeeper_close(_zk_handle);\n    _zk_handle = NULL;\n    ...\n  }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2011-02-02T19:09:44.475+0000","updated":"2011-02-02T19:09:44.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/12989773","id":"12989773","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"do you also set _closing_zh to null after the close? is it possible that this block is invoked concurrently by two different threads? or is it protected by a mutex? (i don't mean to pry, just a sanity check :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-02-02T20:09:15.855+0000","updated":"2011-02-02T20:09:15.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/12989776","id":"12989776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"Yes, sorry, _closing_zh is set to NULL after the if block.\n\nAnd I mentioned above that we use cooperative threading, so concurrency races shouldn't be an issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2011-02-02T20:13:36.983+0000","updated":"2011-02-02T20:13:36.983+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/12996260","id":"12996260","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsulin","name":"tsulin","key":"tsulin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"tsulin","active":true,"timeZone":"Etc/UTC"},"body":"I have the same problem.\n\nIt may be reproduced by the following steps:\n1 create two zk handle A and B\n2 use A to create an ephemeral node under path P\n3 use B to getchild of P and set a watcher\n4 in the watcher function, getchild of P and set the watcher\n5 close A\n6 close B\n\nIt will be reproduced in a probability of about 10%.\n\nI found zookeeper_close is called three times when closing B. destroy is called twice, one of which is called from do_completion.\n\nI think there is a race condition in  zookeeper_close.\n\nint zookeeper_close(zhandle_t *zh)\n{\n    int rc=ZOK;\n    if (zh==0)\n        return ZBADARGUMENTS;\n\n    zh->close_requested=1;\n    if (inc_ref_counter(zh,0)!=0) {\n\t/* Signal any syncronous completions before joining the threads */\n        enter_critical(zh);\n        free_completions(zh,1,ZCLOSING);\n        leave_critical(zh);\n\n        adaptor_finish(zh); // If do_completion is finished before here, zookeeper_close will be called twice. Once in do_completion, another in adaptor_finish.\n        return ZOK;\n    }\n    if(zh->state==ZOO_CONNECTED_STATE){\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsulin","name":"tsulin","key":"tsulin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"tsulin","active":true,"timeZone":"Etc/UTC"},"created":"2011-02-18T06:57:45.124+0000","updated":"2011-02-18T06:57:45.124+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/12996265","id":"12996265","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsulin","name":"tsulin","key":"tsulin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"tsulin","active":true,"timeZone":"Etc/UTC"},"body":"sorry, code again\n{code:none}\nint zookeeper_close(zhandle_t *zh)\n{\n    int rc=ZOK;\n    if (zh==0)\n        return ZBADARGUMENTS;\n\n    zh->close_requested=1;\n    if (inc_ref_counter(zh,0)!=0) {\n\t/* Signal any syncronous completions before joining the threads */\n        enter_critical(zh);\n        free_completions(zh,1,ZCLOSING);\n        leave_critical(zh);\n\n        adaptor_finish(zh);// If do_completion is finished before here, zookeeper_close will be called twice. Once in do_completion, another in adaptor_finish.\n        return ZOK;\n    }\n    if(zh->state==ZOO_CONNECTED_STATE){\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsulin","name":"tsulin","key":"tsulin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"tsulin","active":true,"timeZone":"Etc/UTC"},"created":"2011-02-18T07:12:07.554+0000","updated":"2011-02-18T07:12:07.554+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/12996473","id":"12996473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsulin","name":"tsulin","key":"tsulin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"tsulin","active":true,"timeZone":"Etc/UTC"},"body":"test codes to reproduce this bug","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsulin","name":"tsulin","key":"tsulin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"tsulin","active":true,"timeZone":"Etc/UTC"},"created":"2011-02-18T15:54:28.282+0000","updated":"2011-02-18T15:54:28.282+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/12996497","id":"12996497","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsulin","name":"tsulin","key":"tsulin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"tsulin","active":true,"timeZone":"Etc/UTC"},"body":"sorry for upload many times. my network sucks.\n\nstack trace:\n{code:none}\n#1  0x0000003e75a0b0c0 in pthread_cond_broadcast@@GLIBC_2.3.2 () from /lib64/libpthread.so.0\n#2  0x00002ad3f8a504c1 in unlock_completion_list () from /usr/lib/libzookeeper_mt.so.2\n#3  0x00002ad3f8a46f47 in free_completions () from /usr/lib/libzookeeper_mt.so.2\n#4  0x00002ad3f8a47152 in cleanup_bufs () from /usr/lib/libzookeeper_mt.so.2\n#5  0x00002ad3f8a471b5 in destroy () from /usr/lib/libzookeeper_mt.so.2\n#6  0x00002ad3f8a4731c in zookeeper_close () from /usr/lib/libzookeeper_mt.so.2\n#7  0x00002ad3f8a474e8 in api_epilog () from /usr/lib/libzookeeper_mt.so.2\n#8  0x00002ad3f8a47370 in zookeeper_close () from /usr/lib/libzookeeper_mt.so.2\n#9  0x0000000000401aed in zookeeper_client::~zookeeper_client() ()\n#10 0x0000000000401744 in main ()\n{code}\nor\n{code:none}\n#1  0x0000003e75a0b0c0 in pthread_cond_broadcast@@GLIBC_2.3.2 () from /lib64/libpthread.so.0\n#2  0x00002ad98e6a485a in adaptor_finish () from /usr/lib/libzookeeper_mt.so.2\n#3  0x00002ad98e69b370 in zookeeper_close () from /usr/lib/libzookeeper_mt.so.2\n#4  0x0000000000401ae5 in zookeeper_client::~zookeeper_client() ()\n#5  0x000000000040173b in main ()\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsulin","name":"tsulin","key":"tsulin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"tsulin","active":true,"timeZone":"Etc/UTC"},"created":"2011-02-18T16:27:15.159+0000","updated":"2011-02-18T16:27:15.159+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13002911","id":"13002911","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"Attached is an interim patch for this bug that solves the problems exhibited by tsulin's test on my system.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2011-03-05T02:48:02.889+0000","updated":"2011-03-05T02:48:02.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13002912","id":"13002912","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"When I run tsulin's test under valgrind on my system with Zookeeper 3.3.3, after only 5 iterations I see double-free errors of the type\n\n{noformat}\n==10430== Invalid read of size 8\n==10430==    at 0x405823: free_completions (zookeeper.c:1066)\n==10430==    by 0x405B4F: cleanup_bufs (zookeeper.c:1125)\n==10430==    by 0x403D47: destroy (zookeeper.c:366)\n==10430==    by 0x409961: zookeeper_close (zookeeper.c:2327)\n==10430==    by 0x40785F: api_epilog (zookeeper.c:1661)\n==10430==    by 0x413A82: adaptor_finish (mt_adaptor.c:205)\n==10430==    by 0x4097DF: zookeeper_close (zookeeper.c:2298)\n==10430==    by 0x4036AC: zookeeper_client::~zookeeper_client() (ZOOKEEPER-981.cpp:54)\n==10430==    by 0x403325: main (ZOOKEEPER-981.cpp:112)\n==10430==  Address 0x5b5c0e8 is 296 bytes inside a block of size 728 free'd\n==10430==    at 0x4C240FD: free (vg_replace_malloc.c:366)\n==10430==    by 0x409979: zookeeper_close (zookeeper.c:2329)\n==10430==    by 0x40785F: api_epilog (zookeeper.c:1661)\n==10430==    by 0x414083: do_completion (mt_adaptor.c:335)\n==10430==    by 0x4E2F8B9: start_thread (pthread_create.c:300)\n==10430==    by 0x58C002C: clone (clone.S:112)\n{noformat}\n\nHowever, when I run with the above attached patch, I was able to run over 100 times without any valgrind errors.\n\nThe patch itself probably isn't good enough as it is -- it's a mismatch of inc_ref_counter and api_epilog.  But I thought I'd post it here until a more knowledgeable ZK developer can make a proper one.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2011-03-05T02:52:07.282+0000","updated":"2011-03-05T02:52:07.282+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13049624","id":"13049624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Looks like we should get this into 3.4. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-15T05:58:25.269+0000","updated":"2011-06-15T05:58:25.269+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13066474","id":"13066474","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Reuploading to run the patch via hudson.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-16T17:43:51.177+0000","updated":"2011-07-16T17:43:51.177+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13066475","id":"13066475","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Ben, \n  Would you be able to review this patch? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-16T17:44:56.580+0000","updated":"2011-07-16T17:44:56.580+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13066486","id":"13066486","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12486732/ZOOKEEPER-981-v1.patch\n  against trunk revision 1146961.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/399//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/399//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/399//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-16T18:15:46.335+0000","updated":"2011-07-16T18:15:46.335+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13068003","id":"13068003","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"body":"Patrick, sorry if this is a dense question, but why is this issue assigned back to me?  My understanding is that it's waiting for a review from Ben.\n\nFeel free to assign back to me if I'm misunderstanding the assignee protocol.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=strib","name":"strib","key":"strib","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeremy Stribling","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-19T21:49:35.366+0000","updated":"2011-07-19T21:49:35.366+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13082902","id":"13082902","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12486732/ZOOKEEPER-981-v1.patch\n  against trunk revision 1152141.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/442//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/442//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/442//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-11T04:25:51.077+0000","updated":"2011-08-11T04:25:51.077+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13082906","id":"13082906","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Jeremy,\n The jira is usually assigned to the person who uploads the patch and has done work on it. The patch assignment does not change if it needs reviews. Hope that helps.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-11T04:32:46.276+0000","updated":"2011-08-11T04:32:46.276+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13082908","id":"13082908","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"ben,\n Can you review this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-11T04:33:33.768+0000","updated":"2011-08-11T04:33:33.768+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13095525","id":"13095525","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"do you think we could incorporate the test in the tar file into the patch? it should easily convert to a cppunit test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-01T18:49:19.180+0000","updated":"2011-09-01T18:49:19.180+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13095805","id":"13095805","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=helei","name":"helei","key":"helei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"helei","active":true,"timeZone":"Etc/UTC"},"body":"I saw the same problem. Maybe ref_counter should be increased before we free zh","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=helei","name":"helei","key":"helei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"helei","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-02T06:54:09.737+0000","updated":"2011-09-02T06:54:09.737+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13096290","id":"13096290","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"helei are you saying that you see the problem even with this patch applied?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-02T20:50:15.132+0000","updated":"2011-09-02T20:50:15.132+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13104231","id":"13104231","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"I just committed this to trunk. The change looks good to me. Ben we can probably add a testcase in a different jira.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-14T04:10:37.270+0000","updated":"2011-09-14T04:10:37.270+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13105265","id":"13105265","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in ZooKeeper-trunk #1304 (See [https://builds.apache.org/job/ZooKeeper-trunk/1304/])\n    ZOOKEEPER-981. Hang in zookeeper_close() in the multi-threaded C client. (Jeremy Stribling via mahadev)\n\nmahadev : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1170430\nFiles : \n* /zookeeper/trunk/CHANGES.txt\n* /zookeeper/trunk/src/c/src/zookeeper.c\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-15T10:56:35.426+0000","updated":"2011-09-15T10:56:35.426+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13152858","id":"13152858","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=helei","name":"helei","key":"helei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"helei","active":true,"timeZone":"Etc/UTC"},"body":"Sorry for not response in time. I saw another problem with this patch applied. Hang in zookeeper_close() again. here is the stack:\n(gdb) bt\n#0  0x000000302b80adfb in __lll_mutex_lock_wait () from /lib64/tls/libpthread.so.0\n#1  0x000000302b1307a8 in main_arena () from /lib64/tls/libc.so.6\n#2  0x000000302b910230 in stack_used () from /lib64/tls/libpthread.so.0\n#3  0x000000302b808dde in pthread_cond_broadcast@@GLIBC_2.3.2 () from /lib64/tls/libpthread.so.0\n#4  0x00000000006b4ce8 in adaptor_finish (zh=0x6902060) at src/mt_adaptor.c:217\n#5  0x00000000006b0fd0 in zookeeper_close (zh=0x6902060) at src/zookeeper.c:2297\n(gdb) p zh->ref_counter \n$5 = 1\n(gdb) p zh->close_requested \n$6 = 1\n(gdb) p *zh\n$7 = {fd = 110112576, hostname = 0x6903620 \"\", addrs = 0x0, addrs_count = 1, \n  watcher = 0x62e5dc <doris::meta_register_mgr_t::register_mgr_watcher(_zhandle*, int, int, char const*, void*)>, last_recv = {tv_sec = 1321510694, \n    tv_usec = 552835}, last_send = {tv_sec = 1321510694, tv_usec = 552886}, last_ping = {tv_sec = 1321510685, tv_usec = 774869}, next_deadline = {\n    tv_sec = 1321510704, tv_usec = 547831}, recv_timeout = 30000, input_buffer = 0x0, to_process = {head = 0x0, last = 0x0, lock = {__m_reserved = 0, \n      __m_count = 0, __m_owner = 0x0, __m_kind = 0, __m_lock = {__status = 0, __spinlock = 0}}}, to_send = {head = 0x0, last = 0x0, lock = {\n      __m_reserved = 0, __m_count = 0, __m_owner = 0x0, __m_kind = 1, __m_lock = {__status = 0, __spinlock = 0}}}, sent_requests = {head = 0x0, last = 0x0, \n    cond = {__c_lock = {__status = 1, __spinlock = -1}, __c_waiting = 0x0, __padding = '\\0' <repeats 15 times>, __align = 0}, lock = {__m_reserved = 0, \n      __m_count = 0, __m_owner = 0x0, __m_kind = 0, __m_lock = {__status = 0, __spinlock = 0}}}, completions_to_process = {head = 0x2aefbff800, \n    last = 0x2af0e05f40, cond = {__c_lock = {__status = 592705486850, __spinlock = -1}, __c_waiting = 0x45, \n      __padding = \"E\\000\\000\\000\\000\\000\\000\\000\\220\\006\\000\\000\\000\", __align = 296352743424}, lock = {__m_reserved = 1, __m_count = 0, \n      __m_owner = 0x1000026ca, __m_kind = 0, __m_lock = {__status = 0, __spinlock = 0}}}, connect_index = 0, client_id = {client_id = 86551148676999146, \n    passwd = \"G\\233\\213\\f202\\002\\034\"}, last_zxid = 82057372, outstanding_sync = 0, primer_buffer = {buffer = 0x6902290 \"\", len = 40, \n    curr_offset = 44, next = 0x0}, primer_storage = {len = 36, protocolVersion = 0, timeOut = 30000, sessionId = 86551148676999146, passwd_len = 16, \n    passwd = \"G\\233\\213\\f202\\002\\034\"}, \n  primer_storage_buffer = \"\\000\\000\\000$\\000\\000\\000\\000\\000\\000u0\\0013}000\\000\\000\\020G\\233\\213\\f202\\002\\034\", state = 0, context = 0x0, \n  auth_h = {auth = 0x0, lock = {__m_reserved = 0, __m_count = 0, __m_owner = 0x0, __m_kind = 0, __m_lock = {__status = 0, __spinlock = 0}}}, \n  ref_counter = 1, close_requested = 1, adaptor_priv = 0x0, socket_readable = {tv_sec = 0, tv_usec = 0}, active_node_watchers = 0x6901520, \n  active_exist_watchers = 0x69015d0, active_child_watchers = 0x6902ef0, chroot = 0x0}\nI think the ref_counter is suposed to be 2 or 3 here. 1 seems not correct. thanks again","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=helei","name":"helei","key":"helei","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"helei","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-18T13:31:46.986+0000","updated":"2011-11-18T13:31:46.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12497380/comment/13152962","id":"13152962","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"@helei please enter a new JIRA with this issue, reference this jira in your description. thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-18T16:55:53.493+0000","updated":"2011-11-18T16:55:53.493+0000"}],"maxResults":26,"total":26,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-981/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05z4n:"}}