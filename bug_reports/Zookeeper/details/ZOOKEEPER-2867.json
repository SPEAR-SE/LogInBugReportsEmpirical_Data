{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13092638","self":"https://issues.apache.org/jira/rest/api/2/issue/13092638","key":"ZOOKEEPER-2867","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-08-05T23:27:26.972+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu May 31 00:13:57 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2867/watchers","watchCount":3,"isWatching":false},"created":"2017-08-04T23:58:52.875+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"11.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338036","id":"12338036","description":"Fix release against 3.4 branch","name":"3.4.10","archived":false,"released":true,"releaseDate":"2017-03-30"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-31T00:13:57.824+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"Not sure if this is a real bug, but I found an instance when a ZK client seems to be able to renew a session already expired by the ZK server.\n\nFrom ZK server log, session 25cd1e82c110001 was expired at 22:04:39.\n\n{code:java}\nJune 27th 2017, 22:04:39.000\tINFO\torg.apache.zookeeper.server.ZooKeeperServer\tExpiring session 0x25cd1e82c110001, timeout of 12000ms exceeded\nJune 27th 2017, 22:04:39.001\tDEBUG\torg.apache.zookeeper.server.quorum.Leader\tProposing:: sessionid:0x25cd1e82c110001 type:closeSession cxid:0x0 zxid:0x200000fc4 txntype:-11 reqpath:n/a\nJune 27th 2017, 22:04:39.001\tINFO\torg.apache.zookeeper.server.PrepRequestProcessor\tProcessed session termination for sessionid: 0x25cd1e82c110001\nJune 27th 2017, 22:04:39.001\tDEBUG\torg.apache.zookeeper.server.quorum.CommitProcessor\tProcessing request:: sessionid:0x25cd1e82c110001 type:closeSession cxid:0x0 zxid:0x200000fc4 txntype:-11 reqpath:n/a\nJune 27th 2017, 22:05:20.324\tINFO\torg.apache.zookeeper.server.quorum.Learner\tRevalidating client: 0x25cd1e82c110001\nJune 27th 2017, 22:05:20.324\tINFO\torg.apache.zookeeper.server.ZooKeeperServer\tClient attempting to renew session 0x25cd1e82c110001 at /100.96.5.6:47618\nJune 27th 2017, 22:05:20.325\tINFO\torg.apache.zookeeper.server.ZooKeeperServer\tEstablished session 0x25cd1e82c110001 with negotiated timeout 12000 for client /100.96.5.6:47618\n{code}\n\nFrom ZK client's log, it was able to renew the expired session on 22:05:20.\n\n{code:java}\nJune 27th 2017, 22:05:18.590\tINFO\torg.apache.zookeeper.ClientCnxn\tClient session timed out, have not heard from server in 4485ms for sessionid 0x25cd1e82c110001, closing socket connection and attempting reconnect\t0\nJune 27th 2017, 22:05:18.590\tWARN\torg.apache.zookeeper.ClientCnxn\tClient session timed out, have not heard from server in 4485ms for sessionid 0x25cd1e82c110001\t0\nJune 27th 2017, 22:05:19.325\tWARN\torg.apache.zookeeper.ClientCnxn\tSASL configuration failed: javax.security.auth.login.LoginException: No JAAS configuration section named 'Client' was found in specified JAAS configuration file: '/opt/confluent/etc/kafka/server_jaas.conf'. Will continue connection to Zookeeper server without SASL authentication, if Zookeeper server allows it.\t0\nJune 27th 2017, 22:05:19.326\tINFO\torg.apache.zookeeper.ClientCnxn\tOpening socket connection to server 100.65.188.168/100.65.188.168:2181\t0\nJune 27th 2017, 22:05:20.324\tINFO\torg.apache.zookeeper.ClientCnxn\tSocket connection established to 100.65.188.168/100.65.188.168:2181, initiating session\t0\nJune 27th 2017, 22:05:20.327\tINFO\torg.apache.zookeeper.ClientCnxn\tSession establishment complete on server 100.65.188.168/100.65.188.168:2181, sessionid = 0x25cd1e82c110001, negotiated timeout = 12000\t0\n\n{code}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12883012","id":"12883012","filename":"0.parsed_commit_log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-21T23:16:36.721+0000","size":2018994,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12883012/0.parsed_commit_log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12883011","id":"12883011","filename":"1.parsed_commit_log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-21T23:16:47.794+0000","size":1954002,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12883011/1.parsed_commit_log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12883010","id":"12883010","filename":"2.parsed_commit_log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-21T23:16:57.073+0000","size":2183768,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12883010/2.parsed_commit_log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12882055","id":"12882055","filename":"zk.0.08-02","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-16T00:32:22.974+0000","size":863006,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12882055/zk.0.08-02"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12881847","id":"12881847","filename":"zk.0.08-02","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-14T23:30:48.695+0000","size":863006,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12881847/zk.0.08-02"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12880737","id":"12880737","filename":"zk.0.formatted","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-07T23:38:43.306+0000","size":247795,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12880737/zk.0.formatted"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12882054","id":"12882054","filename":"zk.1.08-02","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-16T00:32:22.961+0000","size":785561,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12882054/zk.1.08-02"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12881846","id":"12881846","filename":"zk.1.08-02","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-14T23:30:48.710+0000","size":785561,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12881846/zk.1.08-02"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12880738","id":"12880738","filename":"zk.1.formatted","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-07T23:38:43.399+0000","size":441957,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12880738/zk.1.formatted"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12882056","id":"12882056","filename":"zk.2.08-02","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-16T00:32:22.941+0000","size":592203,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12882056/zk.2.08-02"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12881848","id":"12881848","filename":"zk.2.08-02","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-14T23:30:48.630+0000","size":592203,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12881848/zk.2.08-02"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"an expired ZK session can be re-established","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16115143","id":"16115143","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"Could someone help to see if this is a real issue? Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-05T00:06:05.695+0000","updated":"2017-08-05T00:06:05.695+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16115545","id":"16115545","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"Is this the full server log? Does anything happen between 22:04:39 and 22:05:20? Session expiration requires consensus over the quorum so to perform a session expiration operation, a proposal has to be sent out by leader to the quorum and wait until leader receives ACKs from a quorum of servers. If during this process leader election happens, then client might be able to renew the session at the same (or a different server), which is what the client log shows here.\n\nFor the available server log posted here, in particular:\n* {{ org.apache.zookeeper.server.PrepRequestProcessor\tProcessed session termination for sessionid }} does not mean session is expired. It only implies that the request passed one of the processor stage.\n* Similarly, {{ org.apache.zookeeper.server.quorum.CommitProcessor\tProcessing request:: sessionid:0x25cd1e82c110001 type:closeSession }} does not mean session close is performed. At this stage the commit processor only queued the closing request which will be processed later once the leader receives enough ACKs from a quorum. So if leader dies, then this will not be committed.\n\nIt should be easy to find hard evidence regarding whether or not the session close transaction was finally committed by quorum or not. When DEBUG is enabled, there should be lots of information related to what proposals got committed in different servers. That is also the reason I was asking if the server log is completed or not.\n\nIt will be a bug however if we find out that the close session was committed across quorum yet client was still able to renew the session.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-08-05T23:27:26.972+0000","updated":"2017-08-05T23:27:26.972+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16116361","id":"16116361","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maoling","name":"maoling","key":"maoling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maoling&avatarId=32024","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maoling&avatarId=32024","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maoling&avatarId=32024","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maoling&avatarId=32024"},"displayName":"maoling","active":true,"timeZone":"Etc/UTC"},"body":"These session expiration logs don't exactly represent this session(isClosing is true) has been removed\nmore logs,client and server configuration,ZK's usage scenarios for your kafka cluster would make sure this problem further   \nFor this possible incompleted logs, let's me tell this story:\n  22:05:18.590 the clinet did a request(may be a transaction request) that was sent to the leader,but a leader has broken down(LE happened) between 22:04:39 and 22:05:20, so client had not heard from server in 4485ms \n  22:05:19.326 the clinet reconnected to server who was a follower,activated this session(renew with the same sessionId) and this session moved from leader to one follower\nHaha,I'm kidding seriously!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=maoling","name":"maoling","key":"maoling","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=maoling&avatarId=32024","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=maoling&avatarId=32024","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=maoling&avatarId=32024","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=maoling&avatarId=32024"},"displayName":"maoling","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-07T09:57:12.395+0000","updated":"2017-08-07T09:57:12.395+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16117570","id":"16117570","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hanm], thanks for the reply. I am attaching the log of 2 of the 3 ZK servers around that time. During that window, there was some potential network issue that may prevent ZK servers from talking to each other. The network issue seems to be gone after 22:05:20, when the ZK cluster stabilized again.\n\nAssuming that session 25cd1e82c110001 didn't really get expired at that point, I got a followup question. A month later, the whole ZK cluster was down and was restarted. On restarting, I saw the following logging in ZK server about deleting an ephemeral in that session. \n\n\n{code:java}\nAugust 2nd 2017, 23:41:55.076\tDEBUG\torg.apache.zookeeper.server.DataTree\tDeleting ephemeral node /cp15/brokers/ids/0 for session 0x25cd1e82c110001 \n{code}\n\nI assume that's because ZK server thinks that session is expired? However, in ZK server's commit log, I didn't find any entry about closing that session. Is that normal? Thanks,","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-07T23:49:52.547+0000","updated":"2017-08-07T23:51:33.785+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16117850","id":"16117850","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"In zk.1 log, looks like server 1 (which was leader a.t.m.) was cut off right after it proposing expiring session 25cd1e82c110001:\n\n{noformat}\nJune 27th 2017, 22:04:39.001   DEBUG org.apache.zookeeper.server.quorum.Leader Proposing:: sessionid:0x25cd1e82c110001 type:closeSession cxid:0x0 zxid:0x200000fc4 txntype:-11 reqpath:n/a\n\nJune 27th 2017, 22:04:39.076   ERROR org.apache.zookeeper.server.quorum.LearnerHandler Unexpected exception causing shutdown while sock still open\n{noformat}\n\nAnd then server 1 went into leader election and eventually became a follower. So the session expiring proposal never went through quorum thus the session 25cd1e82c110001 was not expired. A more convincing proof regarding the results of session expiration would be to search all the log for something like \"Committing request:: sessionid:0x25cd1e82c110001\" - if we have a hit then that means the session expiring request reached a consensus and got committed. \n\nRegarding the follow up question, if the session was not expired, then it is possible at least in one case that we will see the \"logging in ZK server about deleting an ephemeral in that session.\". That case is when a server receives session expiration request, it persists the session close request locally to tnx log file, and then got cut off from rest of quorum. When this server restarts, it will load its data tree from persistent log files, then replay session close request which leads to delete ephemerals. Later when this server joins the quorum its state will be synced with leader, which does not have the close session transaction (otherwise the session would be expired already at quorum level), so leader will tell this server to truncate its log by dropping the session close request, and the server will do so by truncate and reloading logs, which eventually bring its data tree on par with rest of quorum. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-08-08T04:48:55.870+0000","updated":"2017-08-08T04:48:55.870+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16119048","id":"16119048","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hanm], thanks for the explanation. The client on session 25cd1e82c110001 actually died around Aug 2, 23:16:11. From ZK server's log, the last ping from that session was around that time. Then ZK server was restarted around 23:41:28.\n\n{code:java}\nAugust 2nd 2017, 23:16:11.086\tDEBUG\torg.apache.zookeeper.server.FinalRequestProcessor\tsessionid:0x25cd1e82c110001 type:ping cxid:0xfffffffffffffffe zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a\nAugust 2nd 2017, 23:16:11.086\tDEBUG\torg.apache.zookeeper.server.quorum.CommitProcessor\tProcessing request:: sessionid:0x25cd1e82c110001 type:ping cxid:0xfffffffffffffffe zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a\nAugust 2nd 2017, 23:41:28.699\tINFO\torg.apache.zookeeper.server.NIOServerCnxnFactory\tbinding to port 0.0.0.0/0.0.0.0:2181\nAugust 2nd 2017, 23:41:29.149\tDEBUG\torg.apache.zookeeper.server.DataTree\tDeleting ephemeral node /cp15/brokers/ids/0 for session 0x25cd1e82c110001\n{code}\n\nHowever, I couldn't find any entry about the closing of that session in ZK commit log around that time. So, it's not clear to me if ZK server ever closed that session. Should every closed session be in the ZK commit log?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-08T21:16:29.557+0000","updated":"2017-08-08T21:16:52.729+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16119431","id":"16119431","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"bq. Should every closed session be in the ZK commit log?\n\nI think so but please give me some time to double check on my side. One quick search is to scan through your log file and if you see any of the (legitimate) session closing got logged as part of CommitProcessor's debug log then that is a positive of the theory.\n\nAnother thing I noticed is that in zk.0 log, there are a few errors, such as {{error: -103}} or {{type:error}}, which might be fine but indicates some issues of the data on this specific server.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-08-09T05:31:55.654+0000","updated":"2017-08-09T05:31:55.654+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16120800","id":"16120800","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hanm], I tried it locally. It seems that every time a session is closed. The log4j log will log the deleting of ephemeral nodes with the session and type:closeSession in FinalRequestProcessor. \n\n{code:java}\n[2017-08-09 16:00:46,325] DEBUG Processing request:: sessionid:0x15dc93a4f1a0000 type:closeSession cxid:0x3f zxid:0x39 txntype:-11 reqpath:n/a (org.apache.zookeeper.server.FinalRequestProcessor)\n[2017-08-09 16:00:46,325] DEBUG Deleting ephemeral node /brokers/ids/0 for session 0x15dc93a4f1a0000 (org.apache.zookeeper.server.DataTree)\n[2017-08-09 16:00:46,326] DEBUG sessionid:0x15dc93a4f1a0000 type:closeSession cxid:0x3f zxid:0x39 txntype:-11 reqpath:n/a (org.apache.zookeeper.server.FinalRequestProcessor)\n{code}\n\nHowever, for the above incident, I didn't find any logging of closeSession in the log4j log.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-09T23:07:48.042+0000","updated":"2017-08-09T23:07:48.042+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16121101","id":"16121101","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"[~junrao] I also did experiments on my side, when a session is closed the {{CommitProcessor}} should log something like:\n{noformat}2017-08-09 22:41:49,824 [myid:2] - DEBUG [SyncThread:2:CommitProcessor@386] - Committing request:: sessionid:0x10000134d2f0000 type:closeSession cxid:0x1 zxid:0x200000002 txntype:-11 reqpath:n/a{noformat}\nBut this is for 3.5, which has changed a lot in terms of how commit works, and I realized you are using 3.4. But, from what you just referred about {{didn't find any logging of closeSession in the log4j log}} I think we can conclude that this specific session was not closed.\n\nTo circle back to original question - assuming this problematic session is not closed (which is what existing evidence demonstrates), does this create any inconsistency or confusions at higher level in your use case? Were you expecting this session got closed based on what you observed at client side?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-08-10T05:52:54.473+0000","updated":"2017-08-10T05:52:54.473+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16121780","id":"16121780","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hanm], in this case, session 25cd1e82c110001 was created by a Kafka broker. The broker registers an ephemeral node in ZK on startup. That Kafka broker went down around Aug 2, 23:16:11. The expectation is that its ZK session will be closed and the registered ephemeral node will be removed. Another Kafka broker (the controller) has a child watcher on the ephemeral node's parent path. It will be notified about the broker change and process it accordingly. The problem is that the controller never received such notification. This led the Kafka cluster to a bad state.\n\nYou were saying that the following entry doesn't necessarily mean that the ephemeral node is actually removed since it could be restored. Is there any logging indicating the restore?\n{code:java}\nAugust 2nd 2017, 23:41:29.149\tDEBUG\torg.apache.zookeeper.server.DataTree\tDeleting ephemeral node /cp15/brokers/ids/0 for session 0x25cd1e82c110001\n{code}\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-10T15:18:10.258+0000","updated":"2017-08-10T15:18:10.258+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16121935","id":"16121935","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"bq. That Kafka broker went down around Aug 2, 23:16:11. The expectation is that its ZK session will be closed and the registered ephemeral node will be removed.\n\nThe expectation will be correct if this Kafka broker really died. But if it was a transient interruption, i.e. network issues between that Kafka broker and ZooKeeper, then the session will be renewed and ephemeral nodes appertain to that session will be intact. From the original log posted, the session {{0x25cd1e82c110001}} was renewed (though the timestamp of the log does not match {{Aug 2, 23:16:11}} so probably we are not talking about same event. In any case, do we have any evidence that indicates the broker in question really died?\n\nbq. the following entry doesn't necessarily mean that the ephemeral node is actually removed since it could be restored.\n\nCorrect, I think this log does not imply the final quorum state W.R.T. the ephemeral nodes, because the logging here was done before a consensus regarding the ephemeral removal proposal was reached. When a server thinks a client is dead and initiates the session closing, it will start removing the ephemerals from its data tree while waiting for the votes of the ephemeral removal proposal, so the ephemeral nodes removal here does not have transactional semantic because it does not consider the proposal results.\n\nbq. Is there any logging indicating the restore?\n\nWhen log level is set to DEBUG, {{FinalRequestPrecessor}} will log all requests it processes, including the ephemeral nodes recreate (which is just normal ephemeral node create since it has no notion of a state). You can probably search {{type:create}} in logs.\n\nThe restore will only happen when a server restarts, or rejoin quorum, and finds out it has out dated state with rest of quorum. Otherwise, the ephemeral nodes will either be removed already at quorum level, or not removed at all (on this specific server) :). In both cases (restarts/rejoin quorum), the server will recover the expected state from rest of quorum by replaying transactions logs. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-08-10T17:21:25.578+0000","updated":"2017-08-10T17:21:25.578+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16122353","id":"16122353","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hanm], that broker stopped logging around Aug 2, 23:16:11, which matches the time when the ping from that session stopped showing in ZK log. If the pinging stops, ZK server should expire that session after the session timeout, right?\n\nI also grepped for all references to /cp15/brokers/ids/0 in the log. After \"Deleting ephemeral node\", the node was recreated later, but for a different session (which is when that broker was restarted). So, there is no indication that session 0x25cd1e82c110001 was restored.\n\n{code:java}\nZK server 2:\nAugust 2nd 2017, 23:41:29.019\tDEBUG\torg.apache.zookeeper.server.DataTree\tDeleting ephemeral node /cp15/brokers/ids/0 for session 0x5cc2b607d10002\nAugust 2nd 2017, 23:41:29.149\tDEBUG\torg.apache.zookeeper.server.DataTree\tDeleting ephemeral node /cp15/brokers/ids/0 for session 0x25cd1e82c110001\nAugust 2nd 2017, 23:42:12.105\tDEBUG\torg.apache.zookeeper.server.FinalRequestProcessor\tProcessing request:: sessionid:0x25ceb96455e0000 type:getData cxid:0x4c4 zxid:0xfffffffffffffffe txntype:unknown reqpath:/cp15/brokers/ids/0\nAugust 2nd 2017, 23:42:12.105\tDEBUG\torg.apache.zookeeper.server.quorum.CommitProcessor\tProcessing request:: sessionid:0x25ceb96455e0000 type:getData cxid:0x4c4 zxid:0xfffffffffffffffe txntype:unknown reqpath:/cp15/brokers/ids/0\nAugust 2nd 2017, 23:42:12.105\tDEBUG\torg.apache.zookeeper.server.FinalRequestProcessor\tsessionid:0x25ceb96455e0000 type:getData cxid:0x4c4 zxid:0xfffffffffffffffe txntype:unknown reqpath:/cp15/brokers/ids/0\nAugust 2nd 2017, 23:42:21.982\tDEBUG\torg.apache.zookeeper.server.FinalRequestProcessor\tsessionid:0x25ceb96455e0000 type:getData cxid:0x4c8 zxid:0xfffffffffffffffe txntype:unknown reqpath:/cp15/brokers/ids/0\nAugust 2nd 2017, 23:42:21.982\tDEBUG\torg.apache.zookeeper.server.FinalRequestProcessor\tProcessing request:: sessionid:0x25ceb96455e0000 type:getData cxid:0x4c8 zxid:0xfffffffffffffffe txntype:unknown reqpath:/cp15/brokers/ids/0\nAugust 2nd 2017, 23:42:21.982\tDEBUG\torg.apache.zookeeper.server.quorum.CommitProcessor\tProcessing request:: sessionid:0x25ceb96455e0000 type:getData cxid:0x4c8 zxid:0xfffffffffffffffe txntype:unknown reqpath:/cp15/brokers/ids/0\n\nZK server 1:\nAugust 2nd 2017, 23:41:54.966\tDEBUG\torg.apache.zookeeper.server.DataTree\tDeleting ephemeral node /cp15/brokers/ids/0 for session 0x5cc2b607d10002\nAugust 2nd 2017, 23:41:55.076\tDEBUG\torg.apache.zookeeper.server.DataTree\tDeleting ephemeral node /cp15/brokers/ids/0 for session 0x25cd1e82c110001\nAugust 2nd 2017, 23:42:12.045\tDEBUG\torg.apache.zookeeper.server.quorum.CommitProcessor\tProcessing request:: sessionid:0x15da553c7ec0000 type:create cxid:0x26 zxid:0xfffffffffffffffe txntype:unknown reqpath:/cp15/brokers/ids/0\nAugust 2nd 2017, 23:42:12.095\tDEBUG\torg.apache.zookeeper.server.FinalRequestProcessor\tProcessing request:: sessionid:0x15da553c7ec0000 type:create cxid:0x26 zxid:0x40000004d txntype:1 reqpath:/cp15/brokers/ids/0\nAugust 2nd 2017, 23:42:12.095\tDEBUG\torg.apache.zookeeper.server.FinalRequestProcessor\n\nZK server 0:\nAugust 2nd 2017, 23:42:12.107\tDEBUG\torg.apache.zookeeper.server.DataTree\tFailed: 98416546127020032,38,17179869261,1501717332053,1\n:'/cp15/brokers/ids/0,#7b226c697374656e65725f73656375726974795f70726f746f636f6c5f6d6170223a7b22494e5445524e414c223a22504c41494e54455854222c225245504c49434154494f4e223a22504c41494e54455854222c2245585445524e414c223a225341534c5f504c41494e54455854227d2c22656e64706f696e7473223a5b22494e5445524e414c3a2f2f62726f6b65722d696e7465726e616c2d302e637031352e7376632e636c75737465722e6c6f63616c3a39303731222c225245504c49434154494f4e3a2f2f62726f6b65722d696e7465726e616c2d302e637031352e7376632e636c75737465722e6c6f63616c3a39303732222c2245585445524e414c3a2f2f72302e6b61666b612e676f73706f74636865636b2e6177732e636f6e666c75656e742e636c6f75643a39303932225d2c227261636b223a227230222c226a6d785f706f7274223a373230332c22686f7374223a2262726f6b65722d696e7465726e616c2d302e637031352e7376632e636c75737465722e6c6f63616c222c2274696d657374616d70223a2231353031373137333332303337222c22706f7274223a393037312c2276657273696f6e223a347d,v{s{31,s{'world,'anyone}}},T,9\nAugust 2nd 2017, 23:42:12.108\tDEBUG\torg.apache.zookeeper.server.DataTree\tAdjusting parent cversion for Txn: 1 path:/cp15/brokers/ids/0 err: -110\n{code}\n\nSo, what do you think happened there? Did the session 0x25cd1e82c110001 ever get closed? Could this be a ZK bug?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-10T21:21:19.965+0000","updated":"2017-08-10T21:21:19.965+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16122553","id":"16122553","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"bq. If the pinging stops, ZK server should expire that session after the session timeout, right?\n\nCorrect. If the client dies ZK server should expire the session, eventually. \n\nbq. Did the session 0x25cd1e82c110001 ever get closed?\n\nBased on what's discussed so far, I don't think this session is closed, because:\n* There is no evidence that closing session proposal was committed.\n* The ephemeral nodes associated with the session were not deleted. That is why later attempts to recreate same node get error {{-110}}, which means nodes already exist: {{DEBUG\torg.apache.zookeeper.server.DataTree\tAdjusting parent cversion for Txn: 1 path:/cp15/brokers/ids/0 err: -110}}.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-08-10T23:49:48.619+0000","updated":"2017-08-10T23:49:48.619+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16122650","id":"16122650","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hanm], from the above server 1's log, the path actually seems to be created successfully on 23:42:12.095 in session 0x15da553c7ec0000. This session matches the ZK session of that Kafka broker after restart. So if session 0x25cd1e82c110001 was never closed, the creation in session 0x15da553c7ec0000 should fail right? It's not clear which session is associated with \"DEBUG org.apache.zookeeper.server.DataTree\tAdjusting parent cversion for Txn: 1 path:/cp15/brokers/ids/0 err: -110\" since the session is not logged.\n\nAlso, do you think not expiring session 0x25cd1e82c110001 after pinging stops is a bug in ZK? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-11T01:21:12.839+0000","updated":"2017-08-11T01:21:12.839+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16122743","id":"16122743","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"Yes, you are correct. The node creation was a success. The error logged ({{Adjusting parent cversion for Txn: 1 path:/cp15/brokers/ids/0 err: -110}}) is not unexpected during recovery process and such log does not imply the node failed to create, after checking the related code.\n\nSo, it seems that the ephemeral nodes associated with the session 0x25cd1e82c110001 were deleted at quorum level, otherwise creation will not succeed. That is a pretty strong evidence that the session *should be* expired already otherwise the ephemeral nodes will not get deleted at quorum level (if we can find other evidence shows that the close session proposal was committed, that's even stronger).\n\nAssuming the session 0x25cd1e82c110001 is closed in this case.. now the problem seems to be about watcher triggering - that is the deletion of the ephemerals should trigger the watcher so controller would receive notification but actually no notifications were received, correct?\n\nbq. do you think not expiring session 0x25cd1e82c110001 after pinging stops is a bug in ZK?\n\nYes it should be a bug, if we prove session 0x25cd1e82c110001 is not closed after client was dead.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-08-11T02:56:06.634+0000","updated":"2017-08-11T02:56:06.634+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16122828","id":"16122828","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"The controller didn't receive any notification between August 2nd 2017, 23:15:21.031 and August 2nd 2017, 23:42:12.109. So, it missed the event of broker going down and only picked up the restarting of the broker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-11T04:37:36.964+0000","updated":"2017-08-11T04:37:36.964+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16126653","id":"16126653","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hanm], I am attaching the log from 3 ZK servers on Aug. 2. What happened was the following.\n\n1. All 3 ZK servers went down around 23:16 and were restarted around 23:41.\n\n2. Kafka controller, which never went down during that window, was able to re-establish its ZK session around 23:41:58.\n\n{code:java}\nAugust 2nd 2017, 23:41:58.499\tINFO\torg.apache.zookeeper.ClientCnxn\tSocket connection established to zookeeper-2.cp14.svc.cluster.local/100.71.124.93:2181, initiating session\n{code}\n\n3. Kafka broker 0 (non-controller) went down on 23:17:18 and was restarted on 23:42:12.\n\nSupposedly, the old ZK session for broker 0 (25cd1e82c110001) should be expired after the ZK servers were restarted (but it didn't seem to happen). When will the clock for session expiration starts when the ZK cluster was restarted? After the ZK cluster has elected a leader?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-15T00:08:29.913+0000","updated":"2017-08-15T00:08:29.913+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16128155","id":"16128155","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hanm], I found some additional info on Jun. 27. I actually do see session 25cd1e82c110001 being closed in the commit log on 2 of the 3 ZK servers.\n\nFirst, I saw the following on ZK server 1's log4j log. It appears that it first expired session 25cd1e82c110001. Then there was some ZK leader election, potentially due to a network issue. Finally, it allowed a client to renew session 25cd1e82c110001.\n\n{code:java}\nZK 1 : \nJune 27th 2017, 22:04:39.000   org.apache.zookeeper.server.ZooKeeperServer Expiring session 0x25cd1e82c110001, timeout of 12000ms exceeded\nJune 27th 2017, 22:04:39.001   org.apache.zookeeper.server.quorum.CommitProcessor Processing request:: sessionid:0x25cd1e82c110008 type:closeSession cxid:0x0 zxid:0x200000fc5 txntype:-11 reqpath:n/a\nJune 27th 2017, 22:04:39.001   org.apache.zookeeper.server.quorum.CommitProcessor Processing request:: sessionid:0x25cd1e82c110001 type:closeSession cxid:0x0 zxid:0x200000fc4 txntype:-11 reqpath:n/a\nJune 27th 2017, 22:04:39.001   org.apache.zookeeper.server.quorum.Leader Proposing:: sessionid:0x25cd1e82c110001 type:closeSession cxid:0x0 zxid:0x200000fc4 txntype:-11 reqpath:n/a\nJune 27th 2017, 22:04:39.001   org.apache.zookeeper.server.quorum.Leader Proposing:: sessionid:0x25cd1e82c110008 type:closeSession cxid:0x0 zxid:0x200000fc5 txntype:-11 reqpath:n/a\nJune 27th 2017, 22:04:39.001   org.apache.zookeeper.server.PrepRequestProcessor Processed session termination for sessionid: 0x25cd1e82c110008\nJune 27th 2017, 22:04:39.001   org.apache.zookeeper.server.PrepRequestProcessor Processed session termination for sessionid: 0x25cd1e82c110001\n...\nJune 27th 2017, 22:04:42.064   org.apache.zookeeper.server.quorum.QuorumPeer LOOKING\n...\nJune 27th 2017, 22:04:45.824   org.apache.zookeeper.server.quorum.Learner FOLLOWING - LEADER ELECTION TOOK - 3760\n...\nJune 27th 2017, 22:05:20.324   org.apache.zookeeper.server.ZooKeeperServer Client attempting to renew session 0x25cd1e82c110001 at /100.96.5.6:47618\nJune 27th 2017, 22:05:20.324   org.apache.zookeeper.server.quorum.Learner Revalidating client: 0x25cd1e82c110001\nJune 27th 2017, 22:05:20.324   org.apache.zookeeper.server.ZooKeeperServer Session establishment request from client /100.96.5.6:47618 client's lastZxid is 0x2000003af\nJune 27th 2017, 22:05:20.325   org.apache.zookeeper.server.ZooKeeperServer Established session 0x25cd1e82c110001 with negotiated timeout 12000 for client /100.96.5.6:47618\n{code}\n\nIn ZK server 1's commit log, I saw the following, which indicates that session 25cd1e82c110001 was closed.\n{code:java}\n6/27/17 22:04:39 session 0x25cd1e82c110001 cxid 0x0 zxid 0x200000fc4 closeSession null\n{code}\n\nI saw the same session close in ZK server 2's commit log.\n{code:java}\n6/27/17 22:04:39 session 0x25cd1e82c110001 cxid 0x0 zxid 0x200000fc4 closeSession null\n{code}\n\nHowever, I don't see the same session close in ZK server 0's commit log.\n\nAlso, in ZK server 2 and 0's log4j log, there was no logging for session 25cd1e82c110001 from 22:04:39.000 (when server 1 expired the session) to 22:05:20.325 (when server 1 renewed the session). \n\nSo, my questions are \n(1) Does the presence of closeSession indicate that session 25cd1e82c110001 was indeed expired on 6/27/17 22:04:39?\n(2) Why the closeSession for 25cd1e82c110001 didn't show up in the commit log of ZK server 0?\n\nI am also attaching the log around that time in case you need them. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-16T00:35:33.421+0000","updated":"2017-08-16T00:35:33.421+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16134630","id":"16134630","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"bq. the old ZK session for broker 0 (25cd1e82c110001) should be expired after the ZK servers were restarted (but it didn't seem to happen). \n\nThe expected behavior in this case is actually opposite: when ZK servers restarts, as long as clients, including broker 0 can reconnect to ZK within the configured time limits, the session will be renewed. This is because when ZK server restarts (or when it loses quorum during LE), the clock used for session timeout stops ticking until a new quorum is formed. In this case the ZK servers were down (23:16) before broker 0 is down (23:17) so it's totally possible for broker 0 to renew the session.\n\nbq. In ZK server 1's commit log, I saw the following, which indicates that session 25cd1e82c110001 was closed.\n\nCould you please point to me the file name of the attached log that appertains to this? I don't find the file (the latest attached log file has dates as 8/02 instead of 6/27).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-08-21T02:10:11.046+0000","updated":"2017-08-21T02:10:11.046+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16136002","id":"16136002","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hanm], attached please find the parsed commit log from ZK server 0, 1 and 2. If you grep for close on session 0x25cd1e82c110001, you will see it in broker 1 and 2's commit log, but not on broker 0. Note that the timestamp in the commit log is PDT, which is 7 hours ahead of UTC time. All the log4j logs in this jira are using UTC time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-21T23:22:03.855+0000","updated":"2017-08-21T23:22:03.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16157268","id":"16157268","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"body":"[~hanm], were you able to find any new info from the log?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=junrao","name":"junrao","key":"junrao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jun Rao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-09-07T17:20:52.994+0000","updated":"2017-09-07T17:20:52.994+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16157359","id":"16157359","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"[~junrao] sorry was on vacation thus apologize for being slow on this. Will have another look during weekend. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2017-09-07T18:05:12.239+0000","updated":"2017-09-07T18:05:12.239+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13092638/comment/16495919","id":"16495919","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"[~junrao] - ok, finally get back to this :=).\r\n\r\nI checked the broker 1 and 2's commit log, session{{0x25cd1e82c110001}} was referenced after the \"session close\" log statement. For example, in server 1's log file, the first reference of the session0x25cd1e82c110001 after it's \"closed\" is:\r\n{quote}6/27/17 3:05:20 PM PDT session 0x25cd1e82c110001 cxid 0xdc zxid 0x30000047b setData '/cp15/brokers/topics/xxxx/state,#7b22636f6e74726f6c6c65725f65706f6368223a312c226c6561646572223a302c2276657273696f6e223a312c226c65616465725f65706f6368223a352c22697372223a5b302c315d7d,10\r\n{quote}\r\nSimilarly for server 2's commit log session0x25cd1e82c110001 is referenced after the \"closed\" statement as well.\r\n\r\nI think in this case session0x25cd1e82c110001 is not get closed. It could be that the close requests were sent to server 1 and 2 and then something happened so the close requests never committed. Note the \"close session\" entry in the commit log is missing some context so I can't really tell where this log statement was from - if we have more detailed log such to indicate where this log statement was coming from, I might be able to tell the state of the server at that time.\r\n\r\nOne way to make sure the close session proposal really gets committed across the quorum is to looking for this log statement (need to enable debug logging): [https://github.com/apache/zookeeper/blob/branch-3.4/src/java/main/org/apache/zookeeper/server/quorum/CommitProcessor.java#L164]\r\n\r\nAt this point, the proposal reached consensus and is persistent across a quorum of nodes (the state change might not yet applied to the data tree, but as long as the proposal is persistent we are fine).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2018-05-31T00:13:57.824+0000","updated":"2018-05-31T00:13:57.824+0000"}],"maxResults":23,"total":23,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2867/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3ig7z:"}}