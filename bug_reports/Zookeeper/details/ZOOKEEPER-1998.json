{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12730581","self":"https://issues.apache.org/jira/rest/api/2/issue/12730581","key":"ZOOKEEPER-1998","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343268","id":"12343268","description":"Beta release against 3.5 branch","name":"3.5.5","archived":false,"released":false}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-07-29T19:39:21.328+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Jun 11 00:13:29 UTC 2016","customfield_12310420":"408654","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1998/watchers","watchCount":11,"isWatching":false},"created":"2014-07-29T19:27:17.682+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"issuelinks":[{"id":"12423259","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12423259","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"outwardIssue":{"id":"12826402","key":"MESOS-2681","self":"https://issues.apache.org/jira/rest/api/2/issue/12826402","fields":{"summary":"Slave process must restart to update ensemble members","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-10T20:09:32.595+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312380","id":"12312380","name":"c client","description":"The c client interface to ZooKeeper"}],"timeoriginalestimate":null,"description":"(commented this on ZOOKEEPER-338)\n\nI've just noticed that we call getaddrinfo from zookeeper_interest... on every call. So from zookeeper_interest we always call update_addrs:\n\nhttps://github.com/apache/zookeeper/blob/trunk/src/c/src/zookeeper.c#L2082\n\nwhich in turns unconditionally calls resolve_hosts:\n\nhttps://github.com/apache/zookeeper/blob/trunk/src/c/src/zookeeper.c#L787\n\nwhich does the unconditional calls to getaddrinfo:\n\nhttps://github.com/apache/zookeeper/blob/trunk/src/c/src/zookeeper.c#L648\n\nWe should fix this since it'll make 3.5.0 slower for people relying on DNS. I think this is happened as part of ZOOKEEPER-107 in which the list of servers can be updated. \n\ncc: [~shralex], [~phunt], [~fpj]","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"408652","customfield_12312823":null,"summary":"C library calls getaddrinfo unconditionally from zookeeper_interest","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730581/comment/14078237","id":"14078237","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"[~rgs] - yep, you're right. I added that code as part of ZOOKEEPER-107 working with [~shralex]. But if I recall correctly, the original code also unconditionally called resolve_hosts. Though I'd have to go look at the original code to confirm that. I'm guessing you've done that already and that it did not do that? \n\nDo you have thoughts on how we could avoid this? I suppose we could easily just check if the addrvec is the same and if it is bypass resolving the hosts. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-07-29T19:39:21.328+0000","updated":"2014-07-29T19:39:21.328+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730581/comment/14078246","id":"14078246","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"I actually didn't look at 3.4! Since the code looked new, I just guessed. But, it turns out the that getaddrs is only called from zookeeper_init in 3.4 (unless I am overlooking something):\n\nhttps://github.com/apache/zookeeper/blob/branch-3.4/src/c/src/zookeeper.c#L836\n\nbq. Do you have thoughts on how we could avoid this? I suppose we could easily just check if the addrvec is the same and if it is bypass resolving the hosts. \n\nWell, but lookups should only happen upon reconnects right? When things are healthy (i.e.: connected), it doesn't matter if we have (even new) unresolved hosts. So I'd say we only call resolve_hosts() when a new connection is needed.. Thoughts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-07-29T19:48:23.561+0000","updated":"2014-07-29T19:48:23.561+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730581/comment/14078406","id":"14078406","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"[~rgs] - Looking at the 3.4 code I agree with you. It seems like we should only do the lookup when we are connecting.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-07-29T21:30:38.504+0000","updated":"2014-07-29T21:30:38.504+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730581/comment/14078426","id":"14078426","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"body":"hey [~rgs].\nOne suggestion -- when pointing Github link don't use \"trunk\" use specific commit hash in the URL. This would make it point to where you meant when trunk commits change. :)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-07-29T21:40:57.505+0000","updated":"2014-07-29T21:40:57.505+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730581/comment/14522078","id":"14522078","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yasumoto","name":"yasumoto","key":"yasumoto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yasumoto&avatarId=15887","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yasumoto&avatarId=15887","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yasumoto&avatarId=15887","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yasumoto&avatarId=15887"},"displayName":"Joe Smith","active":true,"timeZone":"America/Los_Angeles"},"body":"I've filed MESOS-2681 which tracks Apache Mesos being affected by this as well in the 3.4.x branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yasumoto","name":"yasumoto","key":"yasumoto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yasumoto&avatarId=15887","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yasumoto&avatarId=15887","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yasumoto&avatarId=15887","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yasumoto&avatarId=15887"},"displayName":"Joe Smith","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-30T19:11:51.555+0000","updated":"2015-04-30T19:11:51.555+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730581/comment/15278509","id":"15278509","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfield","name":"jfield","key":"jfield","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jfield&avatarId=23388","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jfield&avatarId=23388","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jfield&avatarId=23388","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jfield&avatarId=23388"},"displayName":"Jeff Field","active":true,"timeZone":"America/Los_Angeles"},"body":"We've got a few hundred ZooKeeper clients per datacenter that are doing ~30 lookups a minute each that they don't need to be doing any as far as I can tell, which I think is because of this issue. Is there active work on a fix for this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfield","name":"jfield","key":"jfield","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jfield&avatarId=23388","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jfield&avatarId=23388","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jfield&avatarId=23388","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jfield&avatarId=23388"},"displayName":"Jeff Field","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-10T17:25:25.285+0000","updated":"2016-05-10T17:25:25.285+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730581/comment/15325543","id":"15325543","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"I think MESOS-2681 is not directly affected by this issue (ZOOKEEPER-1998). The problematic code path we are talking about here in ZOOKEEPER-1998 is a different code path: *zookeeper_interest* is the entry point instead of *zookeeper_init*. \n\nWhat Mesos experienced was caused by *Mesos forcefully expires session (locally) if it is disconnected from ZK for >10s.* according to the comment made in MESOS-2681, and when ZK client in Mesos tried to re-establish the session it was the *zookeeper_init()* code gets called (which, would call resolve_hosts). I tend to think the proper fix on Mesos side would be to try avoid frequent session expiration if possible, which would reduce the attempts to re-establishment of sessions and thus reduces the DNS lookup.\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2016-06-11T00:13:29.850+0000","updated":"2016-06-11T00:13:29.850+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1998/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1ybc7:"}}