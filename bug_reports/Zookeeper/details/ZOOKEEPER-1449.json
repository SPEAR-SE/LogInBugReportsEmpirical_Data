{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12551281","self":"https://issues.apache.org/jira/rest/api/2/issue/12551281","key":"ZOOKEEPER-1449","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2012-04-17T19:02:27.799+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Oct 02 09:58:43 UTC 2013","customfield_12310420":"236145","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1130584465_*|*_5_*:*_2_*:*_44789646251_*|*_4_*:*_1_*:*_100497966","customfield_12312321":null,"resolutiondate":"2013-10-02T09:58:42.999+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1449/watchers","watchCount":2,"isWatching":false},"created":"2012-04-17T18:26:34.334+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12376296","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12376296","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12671758","key":"ZOOKEEPER-1777","self":"https://issues.apache.org/jira/rest/api/2/issue/12671758","fields":{"summary":"Missing ephemeral nodes in one of the members of the ensemble","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-10-02T16:16:46.096+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"I've been running in to this situation in our labs fairly regularly where we'll get a single follower that will be in an inconsistent state with dangling ephemeral znodes.  Here is all of the information that I have right now.  Please ask if there is anything else that is useful.\n\nHere is a quick snapshot of the state of the ensemble where you can see it is out of sync across several znodes: \n\n-bash-3.2$ echo srvr | nc il23n04sa-zk001 2181\nZookeeper version: 3.3.3-cdh3u2--1, built on 10/14/2011 05:17 GMT\nLatency min/avg/max: 0/7/25802\nReceived: 64002\nSent: 63985\nOutstanding: 0\nZxid: 0x500000a41\nMode: follower\nNode count: 497\n\n-bash-3.2$ echo srvr | nc il23n04sa-zk002 2181\nZookeeper version: 3.3.3-cdh3u2--1, built on 10/14/2011 05:17 GMT\nLatency min/avg/max: 0/13/79032\nReceived: 74320\nSent: 74276\nOutstanding: 0\nZxid: 0x500000a41\nMode: leader\nNode count: 493\n\n-bash-3.2$ echo srvr | nc il23n04sa-zk003 2181\nZookeeper version: 3.3.3-cdh3u2--1, built on 10/14/2011 05:17 GMT\nLatency min/avg/max: 0/2/25234\nReceived: 187310\nSent: 187320\nOutstanding: 0\nZxid: 0x500000a41\nMode: follower\nNode count: 493\n\nAll of the zxids match up just fine but zk001 has 4 more nodes in its node count than the other two (including the leader..).  When I use a zookeeper client connect to connect directly to zk001 I can see the following znode that should no longer exist: \n\n[zk: localhost:2181(CONNECTED) 0] stat /siri/Douroucouli/clients/il23n04sa-app004.siri.apple.com:38096\ncZxid = 0x40000001a\nctime = Mon Apr 16 11:00:47 PDT 2012\nmZxid = 0x40000001a\nmtime = Mon Apr 16 11:00:47 PDT 2012\npZxid = 0x40000001a\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x236bc504cb50002\ndataLength = 0\nnumChildren = 0\n\nThis node does not exist using the client to connect to either of the other two members of the ensemble.\n\nI searched through the logs for that session id and it looks like it was established and closed cleanly.  There were several leadership/quorum problems during the course of the session but it looks like it should have been shut down properly.  Neither the session nor the znode show up in the \"dump\" on the leader but the problem znode does show up in the \"dump\" on zk001.\n\n2012-04-16 11:00:47,637 - INFO  [CommitProcessor:2:NIOServerCnxn@1580] - Established session 0x236bc504cb50002 with negotiated timeout 15000 for client /17.202.71.201:38971\n2012-04-16 11:20:59,341 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@770] - Client attempting to renew session 0x236bc504cb50002 at /17.202.71.201:50841\n2012-04-16 11:20:59,342 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1580] - Established session 0x236bc504cb50002 with negotiated timeout 15000 for client /17.202.71.201:50841\n2012-04-16 11:21:09,343 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@634] - EndOfStreamException: Unable to read additional data from client sessionid 0x236bc504cb50002, likely client has closed socket\n2012-04-16 11:21:09,343 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1435] - Closed socket connection for client /17.202.71.201:50841 which had sessionid 0x236bc504cb50002\n2012-04-16 11:21:20,352 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:NIOServerCnxn@1435] - Closed socket connection for client /17.202.71.201:38971 which had sessionid 0x236bc504cb50002\n2012-04-16 11:21:22,151 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@770] - Client attempting to renew session 0x236bc504cb50002 at /17.202.71.201:38166\n2012-04-16 11:21:22,152 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:NIOServerCnxn@1580] - Established session 0x236bc504cb50002 with negotiated timeout 15000 for client /17.202.71.201:38166\n2012-04-16 11:27:17,902 - INFO  [ProcessThread:-1:PrepRequestProcessor@387] - Processed session termination for sessionid: 0x236bc504cb50002\n2012-04-16 11:27:17,904 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1435] - Closed socket connection for client /17.202.71.201:38166 which had sessionid 0x236bc504cb50002\n\nThe only way I've been able to recover from this situation is to shut down the problem follower, delete its snapshots and let it resync with the leader.\n\nI'll attach the full log4j logs, the txn logs, the snapshots and the conf files for each member of the ensemble.  Please let me know what other information is useful.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12606062","id":"12606062","filename":"snaps.tar","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-01T08:10:09.927+0000","size":51200,"mimeType":"application/x-tar","content":"https://issues.apache.org/jira/secure/attachment/12606062/snaps.tar"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32552","customfield_12312823":null,"summary":"Ephemeral znode not deleted after session has expired on one follower (quorum is in an inconsistent state) ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13255811","id":"13255811","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"body":"Log4j logs, txn logs, snapshots, etc.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-17T18:27:25.152+0000","updated":"2012-04-17T18:27:25.152+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13255836","id":"13255836","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Can you reproduce it with a more recent release? 3.3.3 is a bit old at this point and we've fixed a few things between that and 3.3.5.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-17T19:02:27.799+0000","updated":"2012-04-17T19:02:27.799+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13255882","id":"13255882","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"body":"It's not something I know how to reproduce at the moment.  I'm going to see if we can upgrade to something newer in our labs.  The prime suspects look to be 1208 and 1367.  It doesn't look to me like it's 1208 but I'm not positive its not another corner case for that.  It seems like it could be 1367 or close to it but I'm not sure.\n\nI'll try and upgrade and if it recreates I'll attach more logs/traces.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-17T20:01:42.004+0000","updated":"2012-04-17T20:01:42.004+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13255886","id":"13255886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"body":"Oh, one other thing that might be worth noting.  These are virtualized machines.  Each of these VMs is only responsible for hosting zookeeper but is it possible that the virtualization is causing problems? I don't have many details on the virtualization layer but if it's something worth looking in to I can dig further.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-17T20:05:01.455+0000","updated":"2012-04-17T20:05:01.455+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13255902","id":"13255902","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Virtualization shouldn't be a problem. It's probably one of those bugs listed above, but if not we'll definitely want to track it down.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-17T20:15:13.908+0000","updated":"2012-04-17T20:15:13.908+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13261060","id":"13261060","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"I've looked into this issue and I believe with high confidence that this is ZOOKEEPER-1156 \"Log truncation truncating log too much - can cause data loss\", which is fixed in 3.3.4 and beyond.\n\nZOOKEEPER-1156 can lead to over-truncation of the txnlog, which is what I'm seeing in the logs provided by Danny, here's a corrupted record, which when I look the binary directly I can see that is likely a result of file truncation:\n\nOutput from LogFormatter (dumps the txnlog in ascii form):\n\n4/16/12 11:00:54 AM PDT session 0x236bc504cb50005 cxid 0x1e zxid 0x40000009b create \n4/16/12 11:00:54 AM PDT session 0x36bc50622f0002 cxid 0x19 zxid 0x40000009c create \n4/16/12 11:00:54 AM PDT session 0x36bc50622f0004 cxid 0x19 zxid 0x40000009d create \nCRC doesn't match 3908382071 vs 1875708430 skipping to next entry \nSkipped 181778 bytes \n4/17/12 12:03:30 AM PDT session 0x236bc633856000f cxid 0x0 zxid 0x500000330 closeSession \n4/17/12 12:03:30 AM PDT session 0x236bc6338560005 cxid 0x0 zxid 0x500000331 closeSession \n4/17/12 12:03:32 AM PDT session 0x236bc6338560004 cxid 0x0 zxid 0x500000332 closeSession\n\nwhich corresponds to this in the server log:\n\n2012-04-17 00:03:47,077 - WARN [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Learner@306] - Truncating log to get in sync with the leader 0x50000032f \n2012-04-17 00:03:47,166 - INFO [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FileSnap@82] - Reading snapshot /data1/zookeeper/version-2/snapshot.400000156\n\nI also applied the same code that's fixed in ZOOKEEPER-1156, in it's unfixed state (ie what's in 3.3.3) to one of the log files from one of the other servers. When I do this, applying the same flawed truncation operation, I see that the calculated offset is very close to the location above (in terms of the zxid that has been chopped/corrupted). This further convinces me that ZOOKEEPER-1156 is at fault here.\n\nAs a result of this over-truncation we are missing a number of records, including the session close record which would normally cause the ephemeral node identified by Danny to be removed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-04-24T21:50:35.252+0000","updated":"2012-04-24T21:50:35.252+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13261071","id":"13261071","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"That said, there is a second problem I uncovered while diagnosing this issue. \n\nThe reason why no errors are in the log4j log (vs the LogFormatter which does it's own iterating and crc checks) is due to some buggy error handling in the FileTxnIterator. The \"next\" method catches EOF exceptions, in some cases this means we've read all there is to read, however in this case the readTxnBytes is returning null due to the record being truncated. So we never get to the crc check, there is no \"next log\" (given there is only one txnlog). At this point next has cleared out a number of variables, but not \"logStream\". As a result the server fails to notice it had a corrupted log, and it has a logStream that will append to the original end of the file (see my previous comment - the corrupted record, then we pick up again after ~180k bytes with zxid 0x500000330).\n\nWe should fix this issue so that corrupted logs are detected correctly, I've opened ZOOKEEPER-1453 to track this issue.\n\nDanny, if this fixes your problem please close this jira. Thanks for the report!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-04-24T22:05:50.950+0000","updated":"2012-04-24T22:05:50.950+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13261074","id":"13261074","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"body":"I'm running 3.3.5 in a few of our labs now.  I haven't had time to check on their log files to see if there are similar numbers of quorum events in the past and that the issue doesn't reproduce at all.  I'll check the logs and let things run a few more days to see if the issue goes away.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-24T22:08:46.840+0000","updated":"2012-04-24T22:08:46.840+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13265181","id":"13265181","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"body":"The ops team has stabilized our labs and so I haven't had any leader election events in about a week.  Pat is confident that we're looking at the same issue as the log truncation jira and that sounds reasonable to me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-30T20:29:38.701+0000","updated":"2012-04-30T20:29:38.701+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13265494","id":"13265494","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Famous last words. ;-) Please reopen if you do see it again. Thx.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-04-30T23:14:29.361+0000","updated":"2012-04-30T23:14:29.361+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13782658","id":"13782658","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"I would really like to see the logs for this JIRA.\nI have run into a very similar problem recently with zookeeper 3.4.5, but all I have now are the snapshot files. Transaction logs and log files have been removed automatically.\nI will dump the snapshots to a text file and change a few ids and post them here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-01T06:07:46.318+0000","updated":"2013-10-01T06:07:46.318+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13782707","id":"13782707","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"Snapshots of the three members of the ZooKeeper ensemble.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-01T08:10:09.930+0000","updated":"2013-10-01T08:10:09.930+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13782766","id":"13782766","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"The 8 missing nodes in \"the follower that is not ok\" were created in the end of epoch 1:\n<   cZxid = 0x0000010000007d\n...\n<   cZxid = 0x000001000000a9\nwhile the complete list is:\n...\n  cZxid = 0x0000010000007b\n  cZxid = 0x0000010000007d\n...\n  cZxid = 0x000001000000a9\n  cZxid = 0x00000200000004\n...\n4 of the 6 ephemeral owners of these nodes have made modifications during epoch 2, which makes me think that this problem might not be related with session expiration, but more likely with synchronization after leader election.\nEven though some of the missing znodes were modified in epoch 2, \"the follower that is not ok\" didn't use this event to notice that something was wrong and e.g. restart and synchronize via snapshot.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-01T09:50:59.017+0000","updated":"2013-10-01T09:50:59.017+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13783349","id":"13783349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"[~abranzyck] please close this and open a new issue. It's fine to link back to this item, but really we should use a clean slate for new investigations/fixes/etc... Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-10-01T21:07:06.960+0000","updated":"2013-10-01T21:07:06.960+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551281/comment/13783781","id":"13783781","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"Wrongly reopened. creating a new issue instead.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-02T09:58:43.012+0000","updated":"2013-10-02T09:58:43.012+0000"}],"maxResults":15,"total":15,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1449/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05xnr:"}}