{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13170332","self":"https://issues.apache.org/jira/rest/api/2/issue/13170332","key":"ZOOKEEPER-3082","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":4800,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false}],"aggregatetimespent":4800,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-07-05T19:16:47.445+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 09 13:08:35 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2107821243_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2018-07-30T04:23:22.268+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3082/watchers","watchCount":5,"isWatching":false},"created":"2018-07-05T18:53:01.060+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":["pull-request-available"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342040","id":"12342040","description":"Fix release against 3.4 branch","name":"3.4.12","archived":false,"released":true,"releaseDate":"2018-05-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343268","id":"12343268","description":"Beta release against 3.5 branch","name":"3.5.5","archived":false,"released":false}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-08-09T13:08:35.672+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"When the ZK server tries to make a snapshot and the machine is out of disk space, the snapshot creation fails and throws an IOException. An empty snapshot file is created, (probably because the server is able to create an entry in the dir) but is not able to write to the file.\r\n \r\nIf snapshot creation fails, the server commits suicide. When it restarts, it will do so from the last known good snapshot. However, when it tries to make a snapshot again, the same thing happens. This results in lots of empty snapshot files being created. If eventually the DataDirCleanupManager garbage collects the good snapshot files then only the empty files remain. At this point, the server is well and truly screwed.","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"1h 20m","remainingEstimateSeconds":0,"timeSpentSeconds":4800},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Fix server snapshot behavior when out of disk space","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":4800,"total":4800,"percent":100},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":4800,"total":4800,"percent":100},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/comment/16534038","id":"16534038","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 2 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1896//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1896//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1896//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-05T19:16:47.445+0000","updated":"2018-07-05T19:16:47.445+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/comment/16561414","id":"16561414","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"body":"Committed to 3.6. Merge conflicts with branch-3.5, need a separate pull request to get this in 3.5.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hanm","name":"hanm","key":"hanm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hanm&avatarId=26946","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hanm&avatarId=26946","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hanm&avatarId=26946","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hanm&avatarId=26946"},"displayName":"Michael Han","active":true,"timeZone":"America/Vancouver"},"created":"2018-07-30T04:24:27.441+0000","updated":"2018-07-30T04:24:27.441+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/comment/16561475","id":"16561475","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #128 (See [https://builds.apache.org/job/ZooKeeper-trunk/128/])\nZOOKEEPER-3082: Fix server snapshot behavior when out of disk space (hanm: rev 78e4a1047c701006dd4ec8d09065eda0e7adedb5)\n* (edit) src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java\n* (add) src/java/test/org/apache/zookeeper/server/persistence/EmptySnapshotTest.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-30T06:42:36.951+0000","updated":"2018-07-30T06:42:36.951+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/comment/16562430","id":"16562430","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"[~nixon] [~hanm]\r\n\r\nThanks for sorting this out. Do you think it fixes ZOOKEEPER-1621?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-07-30T20:09:22.142+0000","updated":"2018-07-30T20:09:22.142+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/comment/16565860","id":"16565860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"body":"[~andorm] my (possibly incorrect) read on ZOOKEEPER-1621 is that the issue is related to this one but not strictly a subset. Here we've removed the possibility of the snapshot side of recovery being lost during a disk-full event. There, the issue seems to be in ensuring the transaction log side of recovery is not corrupted by writing empty/incomplete log files. That issue will continue to be present even with the patch from this file applied.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nixon","name":"nixon","key":"nixon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Nixon","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-01T19:27:38.891+0000","updated":"2018-08-01T19:27:38.891+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/comment/16574818","id":"16574818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"Thanks [~nixon]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-08-09T13:08:35.672+0000","updated":"2018-08-09T13:08:35.672+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3082/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":8,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/worklog/119532","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"GitHub user enixon opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/560\n\n    ZOOKEEPER-3082: Fix server snapshot behavior when out of disk space\n\n    \n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/enixon/zookeeper ZOOKEEPER-3082\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/560.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #560\n    \n----\ncommit 7b6d575c92a076f8f2cb48510f82e3ab840d7c35\nAuthor: Brian Nixon <nixon@...>\nDate:   2018-07-05T18:55:42Z\n\n    ZOOKEEPER-3082: Fix server snapshot behavior when out of disk space\n\n----\n","created":"2018-07-05T18:56:53.272+0000","updated":"2018-07-05T18:56:53.272+0000","started":"2018-07-05T18:56:53.271+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119532","issueId":"13170332"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/worklog/119927","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user breed commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/560#discussion_r200716591\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java ---\n    @@ -399,8 +399,30 @@ public void save(DataTree dataTree,\n             File snapshotFile = new File(snapDir, Util.makeSnapshotName(lastZxid));\n             LOG.info(\"Snapshotting: 0x{} to {}\", Long.toHexString(lastZxid),\n                     snapshotFile);\n    -        snapLog.serialize(dataTree, sessionsWithTimeouts, snapshotFile, syncSnap);\n    -\n    +        try {\n    +            snapLog.serialize(dataTree, sessionsWithTimeouts, snapshotFile, syncSnap);\n    +        } catch (IOException e) {\n    +            if (snapshotFile.length() == 0) {\n    --- End diff --\n    \n    this seems extra safe. i'm wondering if perhaps we should always delete the snapshot file on an exception. the snapshot file probably will not be valid if an exception occurred. right?\n","created":"2018-07-06T17:15:02.890+0000","updated":"2018-07-06T17:15:02.890+0000","started":"2018-07-06T17:15:02.890+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"119927","issueId":"13170332"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/worklog/124531","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user enixon commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/560#discussion_r203474532\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java ---\n    @@ -399,8 +399,30 @@ public void save(DataTree dataTree,\n             File snapshotFile = new File(snapDir, Util.makeSnapshotName(lastZxid));\n             LOG.info(\"Snapshotting: 0x{} to {}\", Long.toHexString(lastZxid),\n                     snapshotFile);\n    -        snapLog.serialize(dataTree, sessionsWithTimeouts, snapshotFile, syncSnap);\n    -\n    +        try {\n    +            snapLog.serialize(dataTree, sessionsWithTimeouts, snapshotFile, syncSnap);\n    +        } catch (IOException e) {\n    +            if (snapshotFile.length() == 0) {\n    --- End diff --\n    \n    I really like the idea! \r\n    \r\n    Clearly this patch is aimed at closing one very particular kind of error case around snapshot writing and the idea generalizes to many more errors. My only concern with \"always delete\" is that I do not know how wide a net that casts and whether we might end up deleting a legitimately useful snapshot under some circumstances. Unfortunately, I don't have time to do the testing required to validate the safety of the more general approach.\r\n    \r\n    If that sounds reasonable, I'd propose that we commit on this patch and close the hole created from this particular issue (snapshot problems on no disk space) and I'll open a separate JIRA with details about extending the solution so someone can pick up the issue and do the necessary testing.\n","created":"2018-07-18T17:59:23.462+0000","updated":"2018-07-18T17:59:23.462+0000","started":"2018-07-18T17:59:23.461+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"124531","issueId":"13170332"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/worklog/128016","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hanm commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/560#discussion_r205659448\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java ---\n    @@ -399,8 +399,30 @@ public void save(DataTree dataTree,\n             File snapshotFile = new File(snapDir, Util.makeSnapshotName(lastZxid));\n             LOG.info(\"Snapshotting: 0x{} to {}\", Long.toHexString(lastZxid),\n                     snapshotFile);\n    -        snapLog.serialize(dataTree, sessionsWithTimeouts, snapshotFile, syncSnap);\n    -\n    +        try {\n    +            snapLog.serialize(dataTree, sessionsWithTimeouts, snapshotFile, syncSnap);\n    +        } catch (IOException e) {\n    +            if (snapshotFile.length() == 0) {\n    --- End diff --\n    \n    >> If that sounds reasonable, I'd propose that we commit on this patch and close the hole created from this particular issue\r\n    \r\n    SGTM. @breed - ok with you? If so I'll commit this.\n","created":"2018-07-27T03:35:53.550+0000","updated":"2018-07-27T03:35:53.550+0000","started":"2018-07-27T03:35:53.549+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"128016","issueId":"13170332"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/worklog/128053","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user breed commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/560\n  \n    +1 i approve. thanx for handling the commit @hanm !\n","created":"2018-07-27T05:11:49.751+0000","updated":"2018-07-27T05:11:49.751+0000","started":"2018-07-27T05:11:49.751+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"128053","issueId":"13170332"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/worklog/128640","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/560\n","created":"2018-07-30T04:22:56.807+0000","updated":"2018-07-30T04:22:56.807+0000","started":"2018-07-30T04:22:56.807+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"128640","issueId":"13170332"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/worklog/128641","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user hanm commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/560\n  \n    committed to master. thanks @enixon !\n","created":"2018-07-30T04:24:45.415+0000","updated":"2018-07-30T04:24:45.415+0000","started":"2018-07-30T04:24:45.415+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"128641","issueId":"13170332"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13170332/worklog/132803","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"Github user enixon commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/560#discussion_r208781421\n  \n    --- Diff: src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java ---\n    @@ -399,8 +399,30 @@ public void save(DataTree dataTree,\n             File snapshotFile = new File(snapDir, Util.makeSnapshotName(lastZxid));\n             LOG.info(\"Snapshotting: 0x{} to {}\", Long.toHexString(lastZxid),\n                     snapshotFile);\n    -        snapLog.serialize(dataTree, sessionsWithTimeouts, snapshotFile, syncSnap);\n    -\n    +        try {\n    +            snapLog.serialize(dataTree, sessionsWithTimeouts, snapshotFile, syncSnap);\n    +        } catch (IOException e) {\n    +            if (snapshotFile.length() == 0) {\n    --- End diff --\n    \n    Created https://issues.apache.org/jira/browse/ZOOKEEPER-3115 to record this idea of deleting the snapshot file on general IOException's and we can continue the conversation there.\n","created":"2018-08-09T01:13:14.986+0000","updated":"2018-08-09T01:13:14.986+0000","started":"2018-08-09T01:13:14.985+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"132803","issueId":"13170332"}]},"customfield_12311820":"0|i3vl5b:"}}