{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12718740","self":"https://issues.apache.org/jira/rest/api/2/issue/12718740","key":"ZOOKEEPER-1934","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-06-10T04:51:53.880+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Sep 16 16:04:42 UTC 2014","customfield_12310420":"396939","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1934/watchers","watchCount":5,"isWatching":false},"created":"2014-06-05T23:01:06.935+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-09-16T16:04:42.674+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"In our regression testing we encountered an error wherein we were caching a value we read from zookeeper and then experienced session loss. We subsequently got reconnected to a different zookeeper server. When we tried to read the same path from this new zookeeper server we are getting a stale value.\n\nSpecifically, we are reading \"/binchanges\" and originally got back a value of \"3\" from the first server. After we lost connection and reconnected before the session timeout, we then read \"/binchanges\" from the new server and got back a value of \"2\". In our code path we never set this value from 3 to 2. We throw an assertion if the value ever goes backwards. Which is how we caught this error. \n\nIt's my understanding of the single system image guarantee that this should never be allowed. I realize that the single system image guarantee is still quorum based and it's certainly possible that a minority of the ensemble may have stale data. However, I also believe that each client has to send the highest zxid it's seen as part of its connection request to the server. And if the server it's connecting to has a smaller zxid than the value the client sends, then the connection request should be refused.\n\nAssuming I have all of that correct, then I'm at a loss for how this happened. \n\nThe failure happened around Jun  4 08:13:44. Just before that, at June  4 08:13:30 there was a round of leader election. During that round of leader election we voted server with id=4 and zxid=0x300001c4c. This then led to a new zxid=0x400000001. The new leader sends a diff to all the servers including the one we will soon read the stale data from (id=2). Server with ID=2's log files also reflect that as of 08:13:43 it was up to date and current with an UPTODATE message.\n\nI'm going to attach log files from all 5 ensemble nodes. I also used zktreeutil to dump the database out for the 5 ensemble nodes. I diff'd those, and compared them all for correctness. 1 of the nodes (id=2) has a massively divergent zktreeutil dump than the other 4 nodes even though it received the diff from the new leader.\n\nIn the attachments there are 5 nodes. I will number each log file by it's zookeeper id, e.g. node4.log.\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12648557","id":"12648557","filename":"node1.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-06-05T23:02:12.750+0000","size":1058701,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12648557/node1.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12648558","id":"12648558","filename":"node2.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-06-05T23:02:12.755+0000","size":319072,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12648558/node2.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12648559","id":"12648559","filename":"node3.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-06-05T23:02:12.759+0000","size":1009237,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12648559/node3.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12648560","id":"12648560","filename":"node4.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-06-05T23:02:12.762+0000","size":7190708,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12648560/node4.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12648561","id":"12648561","filename":"node5.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-06-05T23:02:12.769+0000","size":3651372,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12648561/node5.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"397057","customfield_12312823":null,"summary":"Stale data received from sync'd ensemble peer","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718740/comment/14019386","id":"14019386","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"Log files from all 5 ensemble nodes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-06-05T23:02:12.774+0000","updated":"2014-06-05T23:02:12.774+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718740/comment/14019389","id":"14019389","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"Diffing the zktreeutil dumps of each server is also interesting. There are a few minor differences with local sessions:\n\ndiff -a node1.zktree node3.zktree \n8933,8934d8932\n<         |--[144115323715452941]\n<         |   \n9162,9163d9159\n<         |   \n<         |--[72058779056865292]\n\ndiff -a node1.zktree node4.zktree \n8933,8934d8932\n<         |--[144115323715452941]\n<         |   \n9005,9006d9002\n<         |--[216173168961912851]\n<         |   \n9162,9163d9157\n<         |   \n<         |--[72058779056865292]\n\ndiff -a node1.zktree node5.zktree \n8933,8934d8932\n<         |--[144115323715452941]\n<         |   \n9005,9006d9002\n<         |--[216173168961912851]\n<         |   \n9065,9066d9060\n<         |--[288230547757793293]\n<         |   \n9162,9163d9155\n<         |   \n<         |--[72058779056865292]\n\nWhereas node2 is MASSIVELY different.\n\nIn particular, the /binchanges value is different:\n\n|--[binchanges]                                                 |--[binchanges]\n|   |                                                           |   |   \n|   |--[version => 3]                                         | |   |--[version => 2]\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-06-05T23:04:58.135+0000","updated":"2014-06-05T23:04:58.135+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718740/comment/14019392","id":"14019392","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"Yet before we grabbed this data, the offending node (nodeid=2, myid=2) stated this:\n\n1723 Jun  4 08:13:30 zookeeper - INFO  [QuorumPeer[myid=2]/10.26.65.47:2181:ZooKeeperServer@156] - Created server with tickTime 2000 minSessionTimeout 4000 maxSessionTimeout 40000 datadir /sf/data/zoo\n1724 Jun  4 08:13:30 zookeeper - INFO  [QuorumPeer[myid=2]/10.26.65.47:2181:Follower@66] - FOLLOWING - LEADER ELECTION TOOK - -1401867542249\n1725 Jun  4 08:13:30 zookeeper - WARN  [QuorumPeer[myid=2]/10.26.65.47:2181:Learner@240] - Unexpected exception, tries=0, connecting to /10.26.65.103:2182\n1726 Jun  4 08:13:30 localhost     at org.apache.zookeeper.server.quorum.Learner.connectToLeader(Learner.java:232)\n1727 Jun  4 08:13:30 localhost     at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:74)\n1728 Jun  4 08:13:30 localhost     at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:967)\n1729 Jun  4 08:13:30 zookeeper - INFO  [NIOServerCxnFactory.AcceptThread:/10.26.65.47:2181:NIOServerCnxnFactory$AcceptThread@296] - Accepted socket connection from /10.26.65.103:35987\n1730 Jun  4 08:13:30 zookeeper - WARN  [NIOWorkerThread-37:NIOServerCnxn@365] - Exception causing close of session 0x0: ZooKeeperServer not running\n1731 Jun  4 08:13:30 zookeeper - INFO  [NIOWorkerThread-37:NIOServerCnxn@999] - Closed socket connection for client /10.26.65.103:35987 (no session established for client)\n1732 Jun  4 08:13:31 zookeeper - INFO  [NIOServerCxnFactory.AcceptThread:/10.26.65.47:2181:NIOServerCnxnFactory$AcceptThread@296] - Accepted socket connection from /10.26.65.103:59764\n1733 Jun  4 08:13:31 zookeeper - WARN  [NIOWorkerThread-38:NIOServerCnxn@365] - Exception causing close of session 0x0: ZooKeeperServer not running\n1734 Jun  4 08:13:31 zookeeper - INFO  [NIOWorkerThread-38:NIOServerCnxn@999] - Closed socket connection for client /10.26.65.103:59764 (no session established for client)\n1735 Jun  4 08:13:31 zookeeper - INFO  [NIOServerCxnFactory.AcceptThread:/10.26.65.47:2181:NIOServerCnxnFactory$AcceptThread@296] - Accepted socket connection from /10.26.65.103:51005\n1736 Jun  4 08:13:31 zookeeper - WARN  [NIOWorkerThread-39:NIOServerCnxn@365] - Exception causing close of session 0x0: ZooKeeperServer not running\n1737 Jun  4 08:13:31 zookeeper - INFO  [NIOWorkerThread-39:NIOServerCnxn@999] - Closed socket connection for client /10.26.65.103:51005 (no session established for client)\n1738 Jun  4 08:13:31 zookeeper - INFO  [NIOServerCxnFactory.AcceptThread:/10.26.65.47:2181:NIOServerCnxnFactory$AcceptThread@296] - Accepted socket connection from /10.26.65.3:39628\n1739 Jun  4 08:13:31 zookeeper - WARN  [NIOWorkerThread-40:NIOServerCnxn@365] - Exception causing close of session 0x0: ZooKeeperServer not running\n1740 Jun  4 08:13:31 zookeeper - INFO  [NIOWorkerThread-40:NIOServerCnxn@999] - Closed socket connection for client /10.26.65.3:39628 (no session established for client)\n1741 Jun  4 08:13:31 zookeeper - INFO  [NIOServerCxnFactory.AcceptThread:/10.26.65.47:2181:NIOServerCnxnFactory$AcceptThread@296] - Accepted socket connection from /10.26.65.3:47705\n1742 Jun  4 08:13:31 zookeeper - WARN  [NIOWorkerThread-41:NIOServerCnxn@365] - Exception causing close of session 0x0: ZooKeeperServer not running\n1743 Jun  4 08:13:31 zookeeper - INFO  [NIOWorkerThread-41:NIOServerCnxn@999] - Closed socket connection for client /10.26.65.3:47705 (no session established for client)\n1744 Jun  4 08:13:31 zookeeper - INFO  [NIOServerCxnFactory.AcceptThread:/10.26.65.47:2181:NIOServerCnxnFactory$AcceptThread@296] - Accepted socket connection from /10.26.65.3:34353\n1745 Jun  4 08:13:31 zookeeper - WARN  [NIOWorkerThread-42:NIOServerCnxn@365] - Exception causing close of session 0x0: ZooKeeperServer not running\n1746 Jun  4 08:13:31 zookeeper - INFO  [NIOWorkerThread-42:NIOServerCnxn@999] - Closed socket connection for client /10.26.65.3:34353 (no session established for client)\n1747 Jun  4 08:13:31 zookeeper - INFO  [QuorumPeer[myid=2]/10.26.65.47:2181:Learner@332] - Getting a diff from the leader 0x300001c4c\n1748 Jun  4 08:13:31 zookeeper - INFO  [QuorumPeer[myid=2]/10.26.65.47:2181:Learner@475] - Learner received NEWLEADER message\n1749 Jun  4 08:13:31 zookeeper - WARN  [QuorumPeer[myid=2]/10.26.65.47:2181:QuorumPeer@1271] - setLastSeenQuorumVerifier called with stale config 4294967296. Current version: 4294967296\n1750 Jun  4 08:13:31 zookeeper - INFO  [QuorumPeer[myid=2]/10.26.65.47:2181:FileTxnSnapLog@297] - Snapshotting: 0x300001c4c to /sf/data/zookeeper/10.26.65.47/version-2/snapshot.300001c4c\n1751 Jun  4 08:13:31 zookeeper - INFO  [QuorumPeer[myid=2]/10.26.65.47:2181:Learner@460] - Learner received UPTODATE message","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-06-05T23:10:06.067+0000","updated":"2014-06-05T23:10:06.067+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718740/comment/14026112","id":"14026112","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Marshall,\n\nYes, the server is supposed to refuse the client connection if the client has seen a higher zxid than the server.\n\nhttps://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java#L825\n\nDoes /binchanges on node2 eventually become 3, or is it stuck at 2?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-06-10T04:51:53.880+0000","updated":"2014-06-10T04:51:53.880+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718740/comment/14028178","id":"14028178","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"[~michim] - thanks for looking at this issue. I saw the same code you linked to and agree on the intended behavior. The log message in that block of code is NOT present. \n\nWe did not see /binchanges update to the correct value of 3. It looked to be stuck at 2. Which really defies explanation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-06-11T18:33:55.560+0000","updated":"2014-06-11T18:33:55.560+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718740/comment/14034553","id":"14034553","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"Well, but you are using local sessions right? Which means that upon a ConnectionLoss and moving to a new server you *will* get a SessionExpired (if your session was local), right? After your session expires, your new client won't know anything about your last highest seen zxid?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-06-17T23:00:16.617+0000","updated":"2014-06-17T23:00:16.617+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718740/comment/14037586","id":"14037586","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"[~rgs] - No, we are not using local sessions. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2014-06-19T17:47:49.246+0000","updated":"2014-06-19T17:47:49.246+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12718740/comment/14135644","id":"14135644","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaredc","name":"jaredc","key":"jaredc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jared Cantwell","active":true,"timeZone":"Etc/UTC"},"body":"I am working with Marshall on this issue.  Upon investigating more, I noticed that all of our processes that had problems had just re-established a connection to node2 immediately before getting stale state from that ZK (through node2).  This seems to match with Marshall's observation that dumping state with zktreeutil on node2 shows a state that is out of date.  It was even stale some time afterward.\n\nSo right now I am investigating how node2 could think its local database was at zxid N+1 (hence why it accepted the connection from the client), but somehow the state of the database is reflecting zxid <= N.  Leader election happened about 15 seconds prior to this, but connections were just getting session connected events.  I'm still digging through the leader election logs, but nothing stands out as suspicious to me yet.\n\nAny help or ideas for things to look for would be much appreciated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaredc","name":"jaredc","key":"jaredc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jared Cantwell","active":true,"timeZone":"Etc/UTC"},"created":"2014-09-16T16:04:42.674+0000","updated":"2014-09-16T16:04:42.674+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1934/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1wc6f:"}}