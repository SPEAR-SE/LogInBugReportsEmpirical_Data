{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13173822","self":"https://issues.apache.org/jira/rest/api/2/issue/13173822","key":"ZOOKEEPER-3100","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-07-23T14:55:36.388+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jul 27 19:24:33 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3100/watchers","watchCount":7,"isWatching":false},"created":"2018-07-23T14:13:21.827+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12342973","id":"12342973","description":"Fix release against 3.4 branch","name":"3.4.13","archived":false,"released":true,"releaseDate":"2018-07-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-07-27T19:24:33.295+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312381","id":"12312381","name":"java client","description":"The java client interface for ZooKeeper"}],"timeoriginalestimate":null,"description":"The changes to ZooKeeper clients to re-resolve hosts made under ZOOKEEPER-2184 results in delays when only a subset of the addresses that a host resolves to are actually reachable. This can result in connection timeouts on the client.\r\n\r\nFor example, when running tests with a single ZooKeeper server accepting connections on 127.0.0.1 on a host that has both IPv4 and IPv6, we have seen connection timeouts in tests if client connects using `localhost` rather than `127.0.0.1`. ZooKeeper client resolves `localhost` to both the IPv4 and IPv6 addresses and chooses a random one. If IPv6 was chosen, a fixed one second backoff is applied before retry since there is only one hostname specified. After backoff, 'localhost' is resolved again and a random address chosen, which could also be the unconnectable IPv6 address.\r\n\r\nFor the list of host names specified for connection, the clients do round-robin without backoffs until connections to all hostnames are attempted. Can we also do the same for addresses that each of the hosts resolves to, so that backoffs are only applied after connection to each address is attempted once and every address is connected to once using round-robin rather than random selection? This will avoid delays in cases where at least one address can be connected to.\r\n\r\n ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ZooKeeper client times out due to random choice of resolved addresses","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsivaram","name":"rsivaram","key":"rsivaram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajini Sivaram","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsivaram","name":"rsivaram","key":"rsivaram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajini Sivaram","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13173822/comment/16552955","id":"16552955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ijuma","name":"ijuma","key":"ijuma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ismael Juma","active":true,"timeZone":"Europe/London"},"body":"The relevant Kafka ticket for reference https://issues.apache.org/jira/browse/KAFKA-7193","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ijuma","name":"ijuma","key":"ijuma","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ismael Juma","active":true,"timeZone":"Europe/London"},"created":"2018-07-23T14:55:36.388+0000","updated":"2018-07-23T14:55:36.388+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13173822/comment/16553025","id":"16553025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"[~rsivaram]\r\n\r\nThanks for testing the new version so quickly and accurately. This is very useful.\r\n\r\nIn theory a server should answer on all addresses that it resolves to, so if the client is unable to connect to the chosen address, host is considered to be down. That was one the reasons why I was against choosing randomly from the resolved addresses. The other one is random behaviour is a code smell.\r\n\r\nAnyway. \r\n\r\nWhy is the server not connectable on the IPv6 address? ZooKeeper usually binds client port (2181) on the wildcard address, which means it listens on all network interfaces and all protocols. (I'll double check this to make sure.)\r\n\r\nWhat's your server configuration look like?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-07-23T15:54:42.954+0000","updated":"2018-07-23T15:54:42.954+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13173822/comment/16553039","id":"16553039","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsivaram","name":"rsivaram","key":"rsivaram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajini Sivaram","active":true,"timeZone":"Etc/UTC"},"body":"[~andorm] In the failing tests, ZooKeeper was being started on `127.0.0.1` explicitly ([https://github.com/apache/kafka/blob/trunk/core/src/test/scala/unit/kafka/zk/EmbeddedZookeeper.scala).] Clients were connecting using `localhost`. We are fixing this for now in the tests by changing the clients to use `127.0.0.1`, but it used to work fine before upgrading ZK clients.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsivaram","name":"rsivaram","key":"rsivaram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajini Sivaram","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-23T16:12:43.022+0000","updated":"2018-07-23T16:12:43.022+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13173822/comment/16553067","id":"16553067","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"Got it.\r\n\r\nI've run a quick test with the standalone ZooKeeper and it looks like \"wildcard\" address means IPv6, if it's enabled and IPv4 otherwise. Server don't listen on both protocols.\r\n\r\nWe might want the client to follow the same behaviour and prefer IPv6 addresses, if the protocol is enabled in the system and fallback to IPv4, if not.\r\n\r\nLet's wait for other people's thoughts.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-07-23T16:21:45.621+0000","updated":"2018-07-23T16:21:45.621+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13173822/comment/16553071","id":"16553071","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"Btw. Regarding the embedded ZooKeeper: this might not be a bug exactly, because you should follow the same configuration convention on both sides: e.g. if you configure your server to listen on 127.0.0.1, you should set up your client exactly the same way.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-07-23T16:24:32.031+0000","updated":"2018-07-23T16:25:16.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13173822/comment/16559776","id":"16559776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"[~rsivaram]\r\n\r\nI've run a few tests with current 3.4 and 3.5 versions of ZooKeeper and I got the same results:\r\n\r\nI spoke a little bit soon regarding the wildcard address, because ZooKeeper opens a unified socket this way. Although netstat shows that Zk is listening only on v6 socket, clients are able to connect with both protocols:\r\n{noformat}\r\nandor@andor-centos zkconf]$ sudo netstat -plnt | grep 2181\r\ntcp6 0 0 :::2181 :::* LISTEN 9249/java \r\n\r\n[andor@andor-centos zkconf]$ echo \"stat\" | nc -4 -v localhost 2181\r\nNcat: Version 7.50 ( https://nmap.org/ncat )\r\nNcat: Connected to 127.0.0.1:2181.\r\nstat is not executed because it is not in the whitelist.\r\nNcat: 5 bytes sent, 57 bytes received in 0.01 seconds.\r\n\r\n[andor@andor-centos zkconf]$ echo \"stat\" | nc -6 -v localhost 2181\r\nNcat: Version 7.50 ( https://nmap.org/ncat )\r\nNcat: Connected to ::1:2181.\r\nstat is not executed because it is not in the whitelist.\r\nNcat: 5 bytes sent, 57 bytes received in 0.01 seconds.{noformat}\r\nSo back to your original issue, I'm not able to repro it. CLI also works perfectly for me.\r\n\r\nI need to look into the Kafka ticket, it must be something specific to that client.\r\n\r\n \r\n\r\n \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-07-27T13:42:23.702+0000","updated":"2018-07-27T13:42:23.702+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13173822/comment/16559837","id":"16559837","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsivaram","name":"rsivaram","key":"rsivaram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajini Sivaram","active":true,"timeZone":"Etc/UTC"},"body":"[~andorm] In the failing Kafka test, ZooKeeper was not listening on the wilcard address, it was listening specifically on 127.0.0.1 (([https://github.com/apache/kafka/blob/trunk/core/src/test/scala/unit/kafka/zk/EmbeddedZookeeper.scala)|https://github.com/apache/kafka/blob/trunk/core/src/test/scala/unit/kafka/zk/EmbeddedZookeeper.scala).]. Hence the connection to the IPv6 address was failing. I think in the example above, you were running ZooKeeper on the wildcard address and hence it worked for both IPv4 and IPv6.\r\n\r\nWe have fixed the Kafka tests by changing clients to connect to `127.0.0.1` instead of `localhost` and that is a reasonable workaround since the server is bound explicitly to that address. But since this used to work before, perhaps it would be better to guarantee that all the possible addresses are attempted before applying backoff as large as a second?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rsivaram","name":"rsivaram","key":"rsivaram","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajini Sivaram","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-27T14:25:54.655+0000","updated":"2018-07-27T14:25:54.655+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13173822/comment/16560168","id":"16560168","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"Got it. Sorry, I keep forgetting about this is with embedded ZooKeeper.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-07-27T19:24:33.295+0000","updated":"2018-07-27T19:24:33.295+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-3100/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3w6dj:"}}