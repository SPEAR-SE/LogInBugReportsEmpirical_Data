{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12474695","self":"https://issues.apache.org/jira/rest/api/2/issue/12474695","key":"ZOOKEEPER-876","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-11-02T21:49:46.720+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jul 01 17:28:50 UTC 2013","customfield_12310420":"67885","customfield_12312320":null,"customfield_12310222":"10002_*:*_4_*:*_6618313108_*|*_1_*:*_5_*:*_81005156367_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-07-01T17:28:50.743+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-876/watchers","watchCount":2,"isWatching":false},"created":"2010-09-21T13:37:41.281+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314469","id":"12314469","description":"Kerberos client auth, multi support, deb/rpm pkging.","name":"3.4.0","archived":false,"released":true,"releaseDate":"2011-11-22"}],"issuelinks":[{"id":"12369408","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12369408","type":{"id":"12310060","name":"Container","inward":"Is contained by","outward":"contains","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310060"},"inwardIssue":{"id":"12546312","key":"ZOOKEEPER-1413","self":"https://issues.apache.org/jira/rest/api/2/issue/12546312","fields":{"summary":"Use on-disk transaction log for learner sync up","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12333999","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12333999","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"outwardIssue":{"id":"12474397","key":"ZOOKEEPER-874","self":"https://issues.apache.org/jira/rest/api/2/issue/12474397","fields":{"summary":"FileTxnSnapLog.restore does not call listener","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/5","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/trivial.svg","name":"Trivial","id":"5"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-07-01T17:28:50.756+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"When starting a new leadership, unnecessary snapshot transfers happen between new leader and followers. This is so because of multiple small bugs. \n\n1) the comparison of zxids is done based on a new proposal, instead of the last logged zxid. (LearnerHandler.java ~ 297)\n2) if follower is one zxid behind, the check of the interval of committed logs excludes the follower. (LearnerHandler.java ~ 277)\n3) the bug reported in ZOOKEEPER-874 (commitLogs are empty after recover).","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12483555","id":"12483555","filename":"second_case.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-23T08:13:01.997+0000","size":4742,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12483555/second_case.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12483554","id":"12483554","filename":"second_case.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-23T08:12:29.241+0000","size":31530,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12483554/second_case.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12483047","id":"12483047","filename":"TEST-org.apache.zookeeper.test.FollowerResyncConcurrencyTest.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-06-18T15:49:11.812+0000","size":667202,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12483047/TEST-org.apache.zookeeper.test.FollowerResyncConcurrencyTest.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12476319","id":"12476319","filename":"ZOOKEEPER-876.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-14T10:54:19.154+0000","size":9584,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12476319/ZOOKEEPER-876.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32835","customfield_12312823":null,"summary":"Unnecessary snapshot transfers between new leader and followers","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/12912979","id":"12912979","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"body":"If follower is one zxid behind, the check of the interval of committed logs excludes the follower in LearnerFollower.java:269. For example, if follower has snapshot-1000 and no logs, and leader has snapshot-1000, log-1001, and so on. The check in that line would force the follower receive again a snapshot. I think the condition should consider minCommittedLog - 1 as lower bound in the test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-21T13:41:18.441+0000","updated":"2010-09-21T13:41:18.441+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/12912994","id":"12912994","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"body":"Depends on the patch ZOOKEEPER-874. (Applied in any order)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-21T14:10:33.347+0000","updated":"2010-09-21T14:10:33.347+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/12912995","id":"12912995","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"body":"Some fixes and a unit test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-21T14:11:32.613+0000","updated":"2010-09-21T14:11:32.613+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/12927631","id":"12927631","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"This is a nice catch, Diogo, and the patch looks good to me. I have a few very quick comments:\n\n# Instead of returning a pair of longs in startForwarding, we could simply return maxZxid and read lastProposed directly from the leader object. Doesn't it work?\n# The first comment of startForwarding is not saying much. Could you please expand it?\n# Could you please explain in the beginning of the test case what it is supposed to be testing? It is for later remembering what the test does.\n\nGood job!\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-11-02T21:49:46.720+0000","updated":"2010-11-02T21:49:46.720+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/12988135","id":"12988135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Diogo, What's the status of this patch? Should we submit it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-01-28T16:36:21.357+0000","updated":"2011-01-28T16:36:21.357+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13019776","id":"13019776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"body":"Fix of item 2 in description + test case","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-14T10:54:19.193+0000","updated":"2011-04-14T10:54:19.193+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13019780","id":"13019780","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"body":"I provided a new patch for this issue. It works in current trunk. The patch fixes only issue 2 in the list above because the effects of issue 1 are minimal. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-14T10:56:47.433+0000","updated":"2011-04-14T10:56:47.433+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13024620","id":"13024620","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Diogo, I believe you meant to submit this patch for review, correct?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-04-24T12:49:19.965+0000","updated":"2011-04-24T12:49:19.965+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13024621","id":"13024621","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12476319/ZOOKEEPER-876.patch\n  against trunk revision 1091841.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/230//testReport/\nFindbugs warnings: https://builds.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/230//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/hudson/job/PreCommit-ZOOKEEPER-Build/230//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-24T13:13:38.885+0000","updated":"2011-04-24T13:13:38.885+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13038670","id":"13038670","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Diogo, Could you please upload the patch again and resubmit?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-05-24T17:17:09.339+0000","updated":"2011-05-24T17:17:09.339+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13051539","id":"13051539","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"One test is failing for me with this patch: FollowerResyncConcurrencyTest.\n\nI'm also not convinced that the predicate of the if block in LearnerHandler will work in all cases. The last proposal before minProposal might not be minProposal - 1. Using \"- 1\" seems to capture the case in which the two zxids are from the same epoch, but does not cover cases in which they are from different epochs. Actually, I wonder if ignoring the epoch value can lead to incorrect behavior, since it is possible that the predicate evaluates to true while the peer last zxid is not the last before minCommittedLog. Is this observation right?\n\nAny comment, Diogo?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-06-18T15:32:03.905+0000","updated":"2011-06-18T15:32:03.905+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13051542","id":"13051542","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Log file of failed test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-06-18T15:49:11.829+0000","updated":"2011-06-18T15:49:11.829+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13051698","id":"13051698","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"FollowerResyncConcurrencyTest won't fail with just the changes to LearnerHandler (which seem to directly address the bug), but the changes in Learner cause it to fail. I notice that you commented out   \n// zk.getZKDatabase().processTxn(pif.hdr, pif.rec);\n\nDid you intend to do this? Adding the transaction to the committed log alone won't suffice for actually applying it to the data tree.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-19T15:31:14.566+0000","updated":"2011-06-19T15:31:14.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13051899","id":"13051899","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"body":"You are both right.\n\n@Camille: true, this line should not be commented. The idea was to do exactly what was done before, and to add the proposal of the leader to the committedLog.\n\n@Flavio: yes, it seems the patch is not taking all cases into account.\n\nI am uploading a log and a patch with a test case that shows two problems:\n\n(1) 3 processes out of 5 are started (look for string RESTART QUORUM): p3, p4 and p5. Process p3 is just some zxids behind the other processes, so it should receive a DIFF from leader p5, but instead if receives a SNAP. \n\n(2) After they are synchronized I stop them, and start them again (look for RESTART QUORUM AGAIN). There was no request processed by the quorum, so p3 and p4 should receive an empty DIFF from leader p5, but both receive a SNAP.\n\nThese problems seem to be caused by a couple of issues in the way the epochs are compared and because the committedLog (which should contain the committed proposals) is sometimes incomplete. I will update the patch later on based on the current trunk and check the issues Flavio mentioned.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-20T10:13:45.963+0000","updated":"2011-06-20T10:13:45.963+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13051900","id":"13051900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"body":"DiffOnRecover shows the two problems mentioned in the comment","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-20T10:14:53.589+0000","updated":"2011-06-20T10:14:53.589+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13051902","id":"13051902","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"body":"Log of DiffOnRecover","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-20T10:16:01.439+0000","updated":"2011-06-20T10:16:01.439+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13053696","id":"13053696","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"body":"Let me first focus on the second case above. The scenario is very simple:\n\n1 - The servers are in sync, all of them are stopped.\n2 - When they are restarted, they elect a new leader and a DIFF is sent. \n3 - If they are stopped and restarted again, then a snapshot will be sent. \n\nThere is however no difference in their state, so there is absolutely no need to transfer a snapshot. The problem seems to be that after the restart the followers have the same zxid of the last accepted update (at step 1), ie, they somehow forgot the NEWLEADER of step 2.\n\nI am uploading a log that shows that. I used grep to show only the output of QuorumPeer. That is enough to see the problem. The patch I am sending can produce such log (ant test-core-java -Dtestcase=\"DiffOn*\").\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dioog","name":"dioog","key":"dioog","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diogo","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-23T08:11:35.320+0000","updated":"2011-06-23T08:11:35.320+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13066510","id":"13066510","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"This is not a blocker. MOving this out to 3.5.0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-16T19:25:49.702+0000","updated":"2011-07-16T19:25:49.702+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12474695/comment/13696990","id":"13696990","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"ZOOKEEPER-1413 address all of the issues mentioned in the description. However, there is one corner case (used by the unit test in this patch) which is not covered by ZOOKEEPER-1413 where the learner tries to sync with leader with no txnlog. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-07-01T17:28:50.754+0000","updated":"2013-07-01T17:28:50.754+0000"}],"maxResults":19,"total":19,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-876/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05zen:"}}