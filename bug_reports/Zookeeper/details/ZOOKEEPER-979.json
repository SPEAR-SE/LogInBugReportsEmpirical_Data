{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12496958","self":"https://issues.apache.org/jira/rest/api/2/issue/12496958","key":"ZOOKEEPER-979","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jan 28 14:10:16 UTC 2011","customfield_12310420":"36638","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-979/watchers","watchCount":3,"isWatching":false},"created":"2011-01-27T16:44:00.764+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315108","id":"12315108","description":"Fix release against 3.3 branch","name":"3.3.2","archived":false,"released":true,"releaseDate":"2010-11-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-01-28T14:10:16.155+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"I'm using zk 3.3.2 and I'm seeing this in my logs around startup:\n\n2011-01-27 10:16:21,513 [WorkerSender Thread] WARN  org.apache.zookeeper.server.quorum.QuorumCnxManager - Cannot open channel to 0 at election address xxx.yyy.com/10.2.131.19:3888\njava.net.UnknownHostException\n\tat sun.nio.ch.Net.translateException(Net.java:100)\n\tat sun.nio.ch.SocketAdaptor.connect(SocketAdaptor.java:140)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:366)\n\tat org.apache.zookeeper.server.quorum.QuorumCnxManager.toSend(QuorumCnxManager.java:335)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.process(FastLeaderElection.java:360)\n\tat org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:333)\n\tat java.lang.Thread.run(Thread.java:636)\n\nAnd all subsequent zk ops give {{ConnectionLossException}}.\n\nI've just explained this to breed_zk on IRC, and he asked me to file a ticket, mentioning that UnknownHostException may sometimes be thrown for reasons other than host resolution. While I'm reasonably certain that the hostname is correct and should be contactable, I need to put some more time into checking our network setup to be absolutely sure. However, two observations arose while looking into this:\n\n* At the top of QuorumCnxManager.connectOne(), we set electionAddr (or fail and return). But then a few lines later we don't actually use this local variable in the call to connect(). This seems like a minor programming mistake (although AFAICT it doesn't change the behaviour).\n* In the subsequent catch block, the UnknownHostException that's thrown doesn't contain the address that we were trying to connect to (though if you capture WARN log messages, you can see what it was).","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32791","customfield_12312823":null,"summary":"UnknownHostException in QuorumCnxManager","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hugh%40acunu.com","name":"hugh@acunu.com","key":"hugh@acunu.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hugh Warrington","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hugh%40acunu.com","name":"hugh@acunu.com","key":"hugh@acunu.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hugh Warrington","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12496958/comment/12988088","id":"12988088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hugh%40acunu.com","name":"hugh@acunu.com","key":"hugh@acunu.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hugh Warrington","active":true,"timeZone":"Etc/UTC"},"body":"Ok, I think I've got to the bottom of this. We were programmatically building a java.util.Properties object, using\n\nfor (InetAddress host : hosts) {\n    properties.put(String.format(\"server.%d\", i++), String.format(\"%s:2888:3888\", host.toString()));\n}\n\nThis was building properties of the form\n\n/10.0.0.1:2888:3888\n\nNotice the leading slash. We then passed the Properties object into QuorumPeerConfig.parseProperties(), which duly constructs an InetSocketAddress with hostname '/10.0.0.1' and port 3888. Note that since the hostname contains the bogus character at the start, the resulting electionAddr.isUnresolved() will be true, since the attempt to resolve the hostname will have failed.\n\nEverything then continues until the first attempt is made to do Socket.connect() with that InetSocketAddress. At this point, some undocumented behaviour in the Socket class comes into play. In sun.nio.ch.SocketAdaptor.connect() (line 140 in openjdk 1.6.0_17 that I'm using) it calls Net.translateException(), which takes the UnresolvedAddressException and instead throws an UnknownHostException. The rationale behind this seems to be that UnresolvedHostException is an unchecked exception, and they want to throw an IOException (\"Throw UnknownHostException from here since it cannot be thrown as a SocketException\"). So instead they just obscure the true source of the problem, and the developer is none the wiser. It doesn't seem to be stated anywhere, but apparently you may only call Socket.connect() with a resolved InetSocketAddress.\n\nAnyway, it seems to me the thing to do here would be to try to resolve the provided server addresses much earlier. Perhaps even in QuorumPeerConfig, via InetAddress.getByName().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hugh%40acunu.com","name":"hugh@acunu.com","key":"hugh@acunu.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hugh Warrington","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-28T14:10:16.111+0000","updated":"2011-01-28T14:10:16.111+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-979/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05z4v:"}}