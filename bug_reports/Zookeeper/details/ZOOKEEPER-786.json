{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12466224","self":"https://issues.apache.org/jira/rest/api/2/issue/12466224","key":"ZOOKEEPER-786","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-10-18T19:01:22.430+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Sep 29 10:50:23 UTC 2011","customfield_12310420":"19329","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_804153843_*|*_1_*:*_1_*:*_39549764069_*|*_5_*:*_2_*:*_1116035909_*|*_4_*:*_1_*:*_1656552625","customfield_12312321":null,"resolutiondate":"2011-10-17T01:00:39.310+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-786/watchers","watchCount":1,"isWatching":false},"created":"2010-06-04T21:25:32.946+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314846","id":"12314846","description":"Fix release against 3.3 branch","name":"3.3.1","archived":false,"released":true,"releaseDate":"2010-05-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thkoch","name":"thkoch","key":"thkoch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thkoch&avatarId=11540","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thkoch&avatarId=11540","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thkoch&avatarId=11540","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thkoch&avatarId=11540"},"displayName":"Thomas Koch","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-10-17T01:00:39.355+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312381","id":"12312381","name":"java client","description":"The java client interface for ZooKeeper"}],"timeoriginalestimate":null,"description":"When trying to call ZooKeeper.toString during client disconnections, an exception can be generated:\n\n\n[04/06/10 15:39:57.744] ERROR Error while calling watcher \njava.lang.Error: java.net.SocketException: Socket operation on non-socket\n\tat sun.nio.ch.Net.localAddress(Net.java:128)\n\tat sun.nio.ch.SocketChannelImpl.localAddress(SocketChannelImpl.java:430)\n\tat sun.nio.ch.SocketAdaptor.getLocalAddress(SocketAdaptor.java:147)\n\tat java.net.Socket.getLocalSocketAddress(Socket.java:717)\n\tat org.apache.zookeeper.ClientCnxn.getLocalSocketAddress(ClientCnxn.java:227)\n\tat org.apache.zookeeper.ClientCnxn.toString(ClientCnxn.java:183)\n\tat java.lang.String.valueOf(String.java:2826)\n\tat java.lang.StringBuilder.append(StringBuilder.java:115)\n\tat org.apache.zookeeper.ZooKeeper.toString(ZooKeeper.java:1486)\n\tat java.util.Formatter$FormatSpecifier.printString(Formatter.java:2794)\n\tat java.util.Formatter$FormatSpecifier.print(Formatter.java:2677)\n\tat java.util.Formatter.format(Formatter.java:2433)\n\tat java.util.Formatter.format(Formatter.java:2367)\n\tat java.lang.String.format(String.java:2769)\n\tat com.echonest.cluster.ZooContainer.process(ZooContainer.java:544)\n\tat org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:488)\nCaused by: java.net.SocketException: Socket operation on non-socket\n\tat sun.nio.ch.Net.localInetAddress(Native Method)\n\tat sun.nio.ch.Net.localAddress(Net.java:125)\n\t... 15 more\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12493035","id":"12493035","filename":"ZOOKEEPER-786.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thkoch","name":"thkoch","key":"thkoch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thkoch&avatarId=11540","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thkoch&avatarId=11540","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thkoch&avatarId=11540","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thkoch&avatarId=11540"},"displayName":"Thomas Koch","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-05T15:27:54.789+0000","size":3122,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12493035/ZOOKEEPER-786.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32870","customfield_12312823":null,"summary":"Exception in ZooKeeper.toString","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eelstretching","name":"eelstretching","key":"eelstretching","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen Green","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eelstretching","name":"eelstretching","key":"eelstretching","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephen Green","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Mac OS X, x86","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/12922216","id":"12922216","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Since this seems to be a minor issue and to avoid further delays with 3.3.2, I propose we move it to 3.4.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-10-18T19:01:22.430+0000","updated":"2010-10-18T19:01:22.430+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13097177","id":"13097177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thkoch","name":"thkoch","key":"thkoch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thkoch&avatarId=11540","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thkoch&avatarId=11540","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thkoch&avatarId=11540","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thkoch&avatarId=11540"},"displayName":"Thomas Koch","active":true,"timeZone":"Etc/UTC"},"body":"This patch introduces caching of (local|remote)SocketAddress in the ClientCnxnNio class. The addresses are read only once immediately after connection establishment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thkoch","name":"thkoch","key":"thkoch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thkoch&avatarId=11540","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thkoch&avatarId=11540","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thkoch&avatarId=11540","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thkoch&avatarId=11540"},"displayName":"Thomas Koch","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-05T15:27:54.836+0000","updated":"2011-09-05T15:27:54.836+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13097179","id":"13097179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/\n-----------------------------------------------------------\n\nReview request for zookeeper.\n\n\nSummary\n-------\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-05T15:30:10.284+0000","updated":"2011-09-05T15:30:10.284+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13097185","id":"13097185","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12493035/ZOOKEEPER-786.patch\n  against trunk revision 1164758.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/500//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/500//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/500//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-05T15:54:10.912+0000","updated":"2011-09-05T15:54:10.912+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13104942","id":"13104942","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/\n-----------------------------------------------------------\n\n(Updated 2011-09-14 22:18:24.072279)\n\n\nReview request for zookeeper.\n\n\nSummary (updated)\n-------\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-14T22:20:08.607+0000","updated":"2011-09-14T22:20:08.607+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13104968","id":"13104968","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"committed to trunk (3.5.0) thanks Thomas!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-14T22:50:50.840+0000","updated":"2011-09-14T22:50:50.840+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13105272","id":"13105272","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in ZooKeeper-trunk #1304 (See [https://builds.apache.org/job/ZooKeeper-trunk/1304/])\n    ZOOKEEPER-786. Exception in ZooKeeper.toString (Thomas Koch via phunt)\n\nphunt : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1170882\nFiles : \n* /zookeeper/trunk/CHANGES.txt\n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-15T10:56:36.475+0000","updated":"2011-09-15T10:56:36.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115509","id":"13115509","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"I'm confused about this patch. As per ted's comments on 1174, why did we remove the lines\n        if (sock.connect(addr)) {            \n          sendThread.primeConnection();\n       }\n\nFrom ClientCnxnSocketNIO? We had a long chat on ZOOKEEPER-1174 as to why you need to check for this conditional. What does this have to do at all with the bug at hand?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T13:55:49.784+0000","updated":"2011-09-27T13:55:49.784+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115516","id":"13115516","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/#review2090\n-----------------------------------------------------------\n\n\n\nsrc/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java\n<https://reviews.apache.org/r/1714/#comment4735>\n\n    Why was this removed? It is not germane to the patch at hand.\n\n\n- Camille\n\n\nOn 2011-09-14 22:18:24, Thomas Koch wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/1714/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-09-14 22:18:24)\nbq.  \nbq.  \nbq.  Review request for zookeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  .\nbq.  \nbq.  \nbq.  This addresses bug ZOOKEEPER-786.\nbq.      https://issues.apache.org/jira/browse/ZOOKEEPER-786\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java 626da04 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/1714/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Thomas\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T14:01:11.878+0000","updated":"2011-09-27T14:01:11.878+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115734","id":"13115734","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-09-27 13:59:22, Camille Fournier wrote:\nbq.  > src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java, line 195\nbq.  > <https://reviews.apache.org/r/1714/diff/1/?file=37950#file37950line195>\nbq.  >\nbq.  >     Why was this removed? It is not germane to the patch at hand.\n\nYou're right, the removal had nothing to do with the issue, but it was the right thing to do, once I've been there. It may happen in rare cases, that connect returns true already there, but primeConnection() is called anyways later from doTransport(). Having to possible call origins only adds to uncertainty.\nDid you observe any problems with this?\n\n\n- Thomas\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/#review2090\n-----------------------------------------------------------\n\n\nOn 2011-09-14 22:18:24, Thomas Koch wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/1714/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-09-14 22:18:24)\nbq.  \nbq.  \nbq.  Review request for zookeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  .\nbq.  \nbq.  \nbq.  This addresses bug ZOOKEEPER-786.\nbq.      https://issues.apache.org/jira/browse/ZOOKEEPER-786\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java 626da04 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/1714/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Thomas\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T17:33:45.696+0000","updated":"2011-09-27T17:33:45.696+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115831","id":"13115831","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-09-27 13:59:22, Camille Fournier wrote:\nbq.  > src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java, line 195\nbq.  > <https://reviews.apache.org/r/1714/diff/1/?file=37950#file37950line195>\nbq.  >\nbq.  >     Why was this removed? It is not germane to the patch at hand.\nbq.  \nbq.  Thomas Koch wrote:\nbq.      You're right, the removal had nothing to do with the issue, but it was the right thing to do, once I've been there. It may happen in rare cases, that connect returns true already there, but primeConnection() is called anyways later from doTransport(). Having to possible call origins only adds to uncertainty.\nbq.      Did you observe any problems with this?\n\nAre you sure that the lines in doTransport() will be called and executed if the socket connects immediately? I don't personally know whether that is the case or not. You didn't write any tests to show that this would happen, and you shouldn't have made the change for purposes of removing uncertainty without explicitly calling out what you were doing. If you are quite sure that even in the case of an immediate connection, OP_CONNECT will be set and we will hit that in doTransport, I'm fine with this change. But I don't like having changes like this snuck in under the radar, because if this is not the case and it causes a bug, it will be a massive pain to find.\n\n\n- Camille\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/#review2090\n-----------------------------------------------------------\n\n\nOn 2011-09-14 22:18:24, Thomas Koch wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/1714/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-09-14 22:18:24)\nbq.  \nbq.  \nbq.  Review request for zookeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  .\nbq.  \nbq.  \nbq.  This addresses bug ZOOKEEPER-786.\nbq.      https://issues.apache.org/jira/browse/ZOOKEEPER-786\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java 626da04 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/1714/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Thomas\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T19:23:45.718+0000","updated":"2011-09-27T19:23:45.718+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115841","id":"13115841","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-09-27 13:59:22, Camille Fournier wrote:\nbq.  > src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java, line 195\nbq.  > <https://reviews.apache.org/r/1714/diff/1/?file=37950#file37950line195>\nbq.  >\nbq.  >     Why was this removed? It is not germane to the patch at hand.\nbq.  \nbq.  Thomas Koch wrote:\nbq.      You're right, the removal had nothing to do with the issue, but it was the right thing to do, once I've been there. It may happen in rare cases, that connect returns true already there, but primeConnection() is called anyways later from doTransport(). Having to possible call origins only adds to uncertainty.\nbq.      Did you observe any problems with this?\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Are you sure that the lines in doTransport() will be called and executed if the socket connects immediately? I don't personally know whether that is the case or not. You didn't write any tests to show that this would happen, and you shouldn't have made the change for purposes of removing uncertainty without explicitly calling out what you were doing. If you are quite sure that even in the case of an immediate connection, OP_CONNECT will be set and we will hit that in doTransport, I'm fine with this change. But I don't like having changes like this snuck in under the radar, because if this is not the case and it causes a bug, it will be a massive pain to find.\n\nIt seems to me, by the by, that if a socket is immediately connected it will NOT set the selection key for OP_CONNECT, because state will be set to ST_CONNECTED (see the source for SocketChannelImpl, specifically connect:\n\nhttp://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.connect%28java.net.SocketAddress%29\n\nand translateReadyOps:\n\nhttp://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.translateReadyOps%28int%2Cint%2Csun.nio.ch.SelectionKeyImpl%29\n\nSo, I'm not sure that this is a safe change to make, and you should always, always, always, be careful when changing anything to do with our NIO code unless you are really sure of the consequences.\n\n\n- Camille\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/#review2090\n-----------------------------------------------------------\n\n\nOn 2011-09-14 22:18:24, Thomas Koch wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/1714/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-09-14 22:18:24)\nbq.  \nbq.  \nbq.  Review request for zookeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  .\nbq.  \nbq.  \nbq.  This addresses bug ZOOKEEPER-786.\nbq.      https://issues.apache.org/jira/browse/ZOOKEEPER-786\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java 626da04 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/1714/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Thomas\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T19:37:45.724+0000","updated":"2011-09-27T19:37:45.724+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115904","id":"13115904","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-09-27 13:59:22, Camille Fournier wrote:\nbq.  > src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java, line 195\nbq.  > <https://reviews.apache.org/r/1714/diff/1/?file=37950#file37950line195>\nbq.  >\nbq.  >     Why was this removed? It is not germane to the patch at hand.\nbq.  \nbq.  Thomas Koch wrote:\nbq.      You're right, the removal had nothing to do with the issue, but it was the right thing to do, once I've been there. It may happen in rare cases, that connect returns true already there, but primeConnection() is called anyways later from doTransport(). Having to possible call origins only adds to uncertainty.\nbq.      Did you observe any problems with this?\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Are you sure that the lines in doTransport() will be called and executed if the socket connects immediately? I don't personally know whether that is the case or not. You didn't write any tests to show that this would happen, and you shouldn't have made the change for purposes of removing uncertainty without explicitly calling out what you were doing. If you are quite sure that even in the case of an immediate connection, OP_CONNECT will be set and we will hit that in doTransport, I'm fine with this change. But I don't like having changes like this snuck in under the radar, because if this is not the case and it causes a bug, it will be a massive pain to find.\nbq.  \nbq.  Camille Fournier wrote:\nbq.      It seems to me, by the by, that if a socket is immediately connected it will NOT set the selection key for OP_CONNECT, because state will be set to ST_CONNECTED (see the source for SocketChannelImpl, specifically connect:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.connect%28java.net.SocketAddress%29\nbq.      \nbq.      and translateReadyOps:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.translateReadyOps%28int%2Cint%2Csun.nio.ch.SelectionKeyImpl%29\nbq.      \nbq.      So, I'm not sure that this is a safe change to make, and you should always, always, always, be careful when changing anything to do with our NIO code unless you are really sure of the consequences.\n\nCamille, you're right, I missed this change. Thanks.\n\nThere is definitely a reason for this! The connect call can return immediately with a connected indication, in which case we need to run the primeConnection code, if you don't OP_CONNECT will never be indicated (because the connection already took place) and primeConnection will therefore never be called in doTransport.\n\nI believe we saw this with Solaris (there was a bug on this but I can't find it either on apache nor sourceforge).\n\n\n- Patrick\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/#review2090\n-----------------------------------------------------------\n\n\nOn 2011-09-14 22:18:24, Thomas Koch wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/1714/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-09-14 22:18:24)\nbq.  \nbq.  \nbq.  Review request for zookeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  .\nbq.  \nbq.  \nbq.  This addresses bug ZOOKEEPER-786.\nbq.      https://issues.apache.org/jira/browse/ZOOKEEPER-786\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java 626da04 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/1714/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Thomas\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T20:45:45.674+0000","updated":"2011-09-27T20:45:45.674+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115909","id":"13115909","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"We need to add back the primeConnection call. \n\nThomas, please add a second patch to this jira that adds that condition/call back to connect().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-27T20:51:26.752+0000","updated":"2011-09-27T20:51:26.752+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115911","id":"13115911","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-09-27 13:59:22, Camille Fournier wrote:\nbq.  > src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java, line 195\nbq.  > <https://reviews.apache.org/r/1714/diff/1/?file=37950#file37950line195>\nbq.  >\nbq.  >     Why was this removed? It is not germane to the patch at hand.\nbq.  \nbq.  Thomas Koch wrote:\nbq.      You're right, the removal had nothing to do with the issue, but it was the right thing to do, once I've been there. It may happen in rare cases, that connect returns true already there, but primeConnection() is called anyways later from doTransport(). Having to possible call origins only adds to uncertainty.\nbq.      Did you observe any problems with this?\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Are you sure that the lines in doTransport() will be called and executed if the socket connects immediately? I don't personally know whether that is the case or not. You didn't write any tests to show that this would happen, and you shouldn't have made the change for purposes of removing uncertainty without explicitly calling out what you were doing. If you are quite sure that even in the case of an immediate connection, OP_CONNECT will be set and we will hit that in doTransport, I'm fine with this change. But I don't like having changes like this snuck in under the radar, because if this is not the case and it causes a bug, it will be a massive pain to find.\nbq.  \nbq.  Camille Fournier wrote:\nbq.      It seems to me, by the by, that if a socket is immediately connected it will NOT set the selection key for OP_CONNECT, because state will be set to ST_CONNECTED (see the source for SocketChannelImpl, specifically connect:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.connect%28java.net.SocketAddress%29\nbq.      \nbq.      and translateReadyOps:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.translateReadyOps%28int%2Cint%2Csun.nio.ch.SelectionKeyImpl%29\nbq.      \nbq.      So, I'm not sure that this is a safe change to make, and you should always, always, always, be careful when changing anything to do with our NIO code unless you are really sure of the consequences.\nbq.  \nbq.  Patrick Hunt wrote:\nbq.      Camille, you're right, I missed this change. Thanks.\nbq.      \nbq.      There is definitely a reason for this! The connect call can return immediately with a connected indication, in which case we need to run the primeConnection code, if you don't OP_CONNECT will never be indicated (because the connection already took place) and primeConnection will therefore never be called in doTransport.\nbq.      \nbq.      I believe we saw this with Solaris (there was a bug on this but I can't find it either on apache nor sourceforge).\nbq.      \nbq.\n\nTed deserves the credit, he pointed it out as part of 1174. If you don't mind, I will pull this bit out of the change in trunk when I check in 1174 there.\n\n\n- Camille\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/#review2090\n-----------------------------------------------------------\n\n\nOn 2011-09-14 22:18:24, Thomas Koch wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/1714/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-09-14 22:18:24)\nbq.  \nbq.  \nbq.  Review request for zookeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  .\nbq.  \nbq.  \nbq.  This addresses bug ZOOKEEPER-786.\nbq.      https://issues.apache.org/jira/browse/ZOOKEEPER-786\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java 626da04 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/1714/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Thomas\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T20:51:45.686+0000","updated":"2011-09-27T20:51:45.686+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115925","id":"13115925","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-09-27 13:59:22, Camille Fournier wrote:\nbq.  > src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java, line 195\nbq.  > <https://reviews.apache.org/r/1714/diff/1/?file=37950#file37950line195>\nbq.  >\nbq.  >     Why was this removed? It is not germane to the patch at hand.\nbq.  \nbq.  Thomas Koch wrote:\nbq.      You're right, the removal had nothing to do with the issue, but it was the right thing to do, once I've been there. It may happen in rare cases, that connect returns true already there, but primeConnection() is called anyways later from doTransport(). Having to possible call origins only adds to uncertainty.\nbq.      Did you observe any problems with this?\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Are you sure that the lines in doTransport() will be called and executed if the socket connects immediately? I don't personally know whether that is the case or not. You didn't write any tests to show that this would happen, and you shouldn't have made the change for purposes of removing uncertainty without explicitly calling out what you were doing. If you are quite sure that even in the case of an immediate connection, OP_CONNECT will be set and we will hit that in doTransport, I'm fine with this change. But I don't like having changes like this snuck in under the radar, because if this is not the case and it causes a bug, it will be a massive pain to find.\nbq.  \nbq.  Camille Fournier wrote:\nbq.      It seems to me, by the by, that if a socket is immediately connected it will NOT set the selection key for OP_CONNECT, because state will be set to ST_CONNECTED (see the source for SocketChannelImpl, specifically connect:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.connect%28java.net.SocketAddress%29\nbq.      \nbq.      and translateReadyOps:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.translateReadyOps%28int%2Cint%2Csun.nio.ch.SelectionKeyImpl%29\nbq.      \nbq.      So, I'm not sure that this is a safe change to make, and you should always, always, always, be careful when changing anything to do with our NIO code unless you are really sure of the consequences.\nbq.  \nbq.  Patrick Hunt wrote:\nbq.      Camille, you're right, I missed this change. Thanks.\nbq.      \nbq.      There is definitely a reason for this! The connect call can return immediately with a connected indication, in which case we need to run the primeConnection code, if you don't OP_CONNECT will never be indicated (because the connection already took place) and primeConnection will therefore never be called in doTransport.\nbq.      \nbq.      I believe we saw this with Solaris (there was a bug on this but I can't find it either on apache nor sourceforge).\nbq.      \nbq.\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Ted deserves the credit, he pointed it out as part of 1174. If you don't mind, I will pull this bit out of the change in trunk when I check in 1174 there.\n\nIt would be better to keep the changes distinct. Would you mind committing this snippet first, as a second patch for 786, then apply 1174? Or I/you can entirely roll back this change from trunk, you can commit 1174, and then Thomas can update this patch and reapply. Which would you prefer?\n\n\n- Patrick\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/#review2090\n-----------------------------------------------------------\n\n\nOn 2011-09-14 22:18:24, Thomas Koch wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/1714/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-09-14 22:18:24)\nbq.  \nbq.  \nbq.  Review request for zookeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  .\nbq.  \nbq.  \nbq.  This addresses bug ZOOKEEPER-786.\nbq.      https://issues.apache.org/jira/browse/ZOOKEEPER-786\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java 626da04 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/1714/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Thomas\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T21:08:45.697+0000","updated":"2011-09-27T21:08:45.697+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115934","id":"13115934","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-09-27 13:59:22, Camille Fournier wrote:\nbq.  > src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java, line 195\nbq.  > <https://reviews.apache.org/r/1714/diff/1/?file=37950#file37950line195>\nbq.  >\nbq.  >     Why was this removed? It is not germane to the patch at hand.\nbq.  \nbq.  Thomas Koch wrote:\nbq.      You're right, the removal had nothing to do with the issue, but it was the right thing to do, once I've been there. It may happen in rare cases, that connect returns true already there, but primeConnection() is called anyways later from doTransport(). Having to possible call origins only adds to uncertainty.\nbq.      Did you observe any problems with this?\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Are you sure that the lines in doTransport() will be called and executed if the socket connects immediately? I don't personally know whether that is the case or not. You didn't write any tests to show that this would happen, and you shouldn't have made the change for purposes of removing uncertainty without explicitly calling out what you were doing. If you are quite sure that even in the case of an immediate connection, OP_CONNECT will be set and we will hit that in doTransport, I'm fine with this change. But I don't like having changes like this snuck in under the radar, because if this is not the case and it causes a bug, it will be a massive pain to find.\nbq.  \nbq.  Camille Fournier wrote:\nbq.      It seems to me, by the by, that if a socket is immediately connected it will NOT set the selection key for OP_CONNECT, because state will be set to ST_CONNECTED (see the source for SocketChannelImpl, specifically connect:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.connect%28java.net.SocketAddress%29\nbq.      \nbq.      and translateReadyOps:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.translateReadyOps%28int%2Cint%2Csun.nio.ch.SelectionKeyImpl%29\nbq.      \nbq.      So, I'm not sure that this is a safe change to make, and you should always, always, always, be careful when changing anything to do with our NIO code unless you are really sure of the consequences.\nbq.  \nbq.  Patrick Hunt wrote:\nbq.      Camille, you're right, I missed this change. Thanks.\nbq.      \nbq.      There is definitely a reason for this! The connect call can return immediately with a connected indication, in which case we need to run the primeConnection code, if you don't OP_CONNECT will never be indicated (because the connection already took place) and primeConnection will therefore never be called in doTransport.\nbq.      \nbq.      I believe we saw this with Solaris (there was a bug on this but I can't find it either on apache nor sourceforge).\nbq.      \nbq.\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Ted deserves the credit, he pointed it out as part of 1174. If you don't mind, I will pull this bit out of the change in trunk when I check in 1174 there.\nbq.  \nbq.  Patrick Hunt wrote:\nbq.      It would be better to keep the changes distinct. Would you mind committing this snippet first, as a second patch for 786, then apply 1174? Or I/you can entirely roll back this change from trunk, you can commit 1174, and then Thomas can update this patch and reapply. Which would you prefer?\n\nI'll roll back this change as a second patch for 786, then apply 1174. This just went into trunk right?\n\n\n- Camille\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/#review2090\n-----------------------------------------------------------\n\n\nOn 2011-09-14 22:18:24, Thomas Koch wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/1714/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-09-14 22:18:24)\nbq.  \nbq.  \nbq.  Review request for zookeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  .\nbq.  \nbq.  \nbq.  This addresses bug ZOOKEEPER-786.\nbq.      https://issues.apache.org/jira/browse/ZOOKEEPER-786\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java 626da04 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/1714/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Thomas\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T21:12:46.878+0000","updated":"2011-09-27T21:12:46.878+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115941","id":"13115941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-09-27 13:59:22, Camille Fournier wrote:\nbq.  > src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java, line 195\nbq.  > <https://reviews.apache.org/r/1714/diff/1/?file=37950#file37950line195>\nbq.  >\nbq.  >     Why was this removed? It is not germane to the patch at hand.\nbq.  \nbq.  Thomas Koch wrote:\nbq.      You're right, the removal had nothing to do with the issue, but it was the right thing to do, once I've been there. It may happen in rare cases, that connect returns true already there, but primeConnection() is called anyways later from doTransport(). Having to possible call origins only adds to uncertainty.\nbq.      Did you observe any problems with this?\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Are you sure that the lines in doTransport() will be called and executed if the socket connects immediately? I don't personally know whether that is the case or not. You didn't write any tests to show that this would happen, and you shouldn't have made the change for purposes of removing uncertainty without explicitly calling out what you were doing. If you are quite sure that even in the case of an immediate connection, OP_CONNECT will be set and we will hit that in doTransport, I'm fine with this change. But I don't like having changes like this snuck in under the radar, because if this is not the case and it causes a bug, it will be a massive pain to find.\nbq.  \nbq.  Camille Fournier wrote:\nbq.      It seems to me, by the by, that if a socket is immediately connected it will NOT set the selection key for OP_CONNECT, because state will be set to ST_CONNECTED (see the source for SocketChannelImpl, specifically connect:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.connect%28java.net.SocketAddress%29\nbq.      \nbq.      and translateReadyOps:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.translateReadyOps%28int%2Cint%2Csun.nio.ch.SelectionKeyImpl%29\nbq.      \nbq.      So, I'm not sure that this is a safe change to make, and you should always, always, always, be careful when changing anything to do with our NIO code unless you are really sure of the consequences.\nbq.  \nbq.  Patrick Hunt wrote:\nbq.      Camille, you're right, I missed this change. Thanks.\nbq.      \nbq.      There is definitely a reason for this! The connect call can return immediately with a connected indication, in which case we need to run the primeConnection code, if you don't OP_CONNECT will never be indicated (because the connection already took place) and primeConnection will therefore never be called in doTransport.\nbq.      \nbq.      I believe we saw this with Solaris (there was a bug on this but I can't find it either on apache nor sourceforge).\nbq.      \nbq.\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Ted deserves the credit, he pointed it out as part of 1174. If you don't mind, I will pull this bit out of the change in trunk when I check in 1174 there.\nbq.  \nbq.  Patrick Hunt wrote:\nbq.      It would be better to keep the changes distinct. Would you mind committing this snippet first, as a second patch for 786, then apply 1174? Or I/you can entirely roll back this change from trunk, you can commit 1174, and then Thomas can update this patch and reapply. Which would you prefer?\nbq.  \nbq.  Camille Fournier wrote:\nbq.      I'll roll back this change as a second patch for 786, then apply 1174. This just went into trunk right?\n\nIn trunk I see this:\n\n        sockKey = sock.register(selector, SelectionKey.OP_CONNECT);\n        sock.connect(addr);\n\nhowever in branch-3.4 I see this:\n\n            boolean immediateConnect = sock.connect(addr);\n            sockKey = sock.register(selector, SelectionKey.OP_CONNECT);\n            if (immediateConnect) {\n                sendThread.primeConnection();\n            }\n\nso yes, this patch was applied only to trunk, however, isn't this a bug? sock.register is being called after sock.connect.\n\nAlso, why was this patch applied to branch 3.4, but it's not available on trunk?\n\n\n- Patrick\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/#review2090\n-----------------------------------------------------------\n\n\nOn 2011-09-14 22:18:24, Thomas Koch wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/1714/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-09-14 22:18:24)\nbq.  \nbq.  \nbq.  Review request for zookeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  .\nbq.  \nbq.  \nbq.  This addresses bug ZOOKEEPER-786.\nbq.      https://issues.apache.org/jira/browse/ZOOKEEPER-786\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java 626da04 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/1714/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Thomas\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T21:22:45.689+0000","updated":"2011-09-27T21:22:45.689+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13115944","id":"13115944","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-09-27 13:59:22, Camille Fournier wrote:\nbq.  > src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java, line 195\nbq.  > <https://reviews.apache.org/r/1714/diff/1/?file=37950#file37950line195>\nbq.  >\nbq.  >     Why was this removed? It is not germane to the patch at hand.\nbq.  \nbq.  Thomas Koch wrote:\nbq.      You're right, the removal had nothing to do with the issue, but it was the right thing to do, once I've been there. It may happen in rare cases, that connect returns true already there, but primeConnection() is called anyways later from doTransport(). Having to possible call origins only adds to uncertainty.\nbq.      Did you observe any problems with this?\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Are you sure that the lines in doTransport() will be called and executed if the socket connects immediately? I don't personally know whether that is the case or not. You didn't write any tests to show that this would happen, and you shouldn't have made the change for purposes of removing uncertainty without explicitly calling out what you were doing. If you are quite sure that even in the case of an immediate connection, OP_CONNECT will be set and we will hit that in doTransport, I'm fine with this change. But I don't like having changes like this snuck in under the radar, because if this is not the case and it causes a bug, it will be a massive pain to find.\nbq.  \nbq.  Camille Fournier wrote:\nbq.      It seems to me, by the by, that if a socket is immediately connected it will NOT set the selection key for OP_CONNECT, because state will be set to ST_CONNECTED (see the source for SocketChannelImpl, specifically connect:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.connect%28java.net.SocketAddress%29\nbq.      \nbq.      and translateReadyOps:\nbq.      \nbq.      http://grepcode.com/file/repository.grepcode.com/java/root/jdk/openjdk/6-b14/sun/nio/ch/SocketChannelImpl.java#SocketChannelImpl.translateReadyOps%28int%2Cint%2Csun.nio.ch.SelectionKeyImpl%29\nbq.      \nbq.      So, I'm not sure that this is a safe change to make, and you should always, always, always, be careful when changing anything to do with our NIO code unless you are really sure of the consequences.\nbq.  \nbq.  Patrick Hunt wrote:\nbq.      Camille, you're right, I missed this change. Thanks.\nbq.      \nbq.      There is definitely a reason for this! The connect call can return immediately with a connected indication, in which case we need to run the primeConnection code, if you don't OP_CONNECT will never be indicated (because the connection already took place) and primeConnection will therefore never be called in doTransport.\nbq.      \nbq.      I believe we saw this with Solaris (there was a bug on this but I can't find it either on apache nor sourceforge).\nbq.      \nbq.\nbq.  \nbq.  Camille Fournier wrote:\nbq.      Ted deserves the credit, he pointed it out as part of 1174. If you don't mind, I will pull this bit out of the change in trunk when I check in 1174 there.\nbq.  \nbq.  Patrick Hunt wrote:\nbq.      It would be better to keep the changes distinct. Would you mind committing this snippet first, as a second patch for 786, then apply 1174? Or I/you can entirely roll back this change from trunk, you can commit 1174, and then Thomas can update this patch and reapply. Which would you prefer?\nbq.  \nbq.  Camille Fournier wrote:\nbq.      I'll roll back this change as a second patch for 786, then apply 1174. This just went into trunk right?\nbq.  \nbq.  Patrick Hunt wrote:\nbq.      In trunk I see this:\nbq.      \nbq.              sockKey = sock.register(selector, SelectionKey.OP_CONNECT);\nbq.              sock.connect(addr);\nbq.      \nbq.      however in branch-3.4 I see this:\nbq.      \nbq.                  boolean immediateConnect = sock.connect(addr);\nbq.                  sockKey = sock.register(selector, SelectionKey.OP_CONNECT);\nbq.                  if (immediateConnect) {\nbq.                      sendThread.primeConnection();\nbq.                  }\nbq.      \nbq.      so yes, this patch was applied only to trunk, however, isn't this a bug? sock.register is being called after sock.connect.\nbq.      \nbq.      Also, why was this patch applied to branch 3.4, but it's not available on trunk?\nbq.\n\nI see. 1174 was committed to branch-3.4 but this change caused a conflict for trunk.\n\nIsn't this a timing issue then? registering after connecting?\n\n\n- Patrick\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/1714/#review2090\n-----------------------------------------------------------\n\n\nOn 2011-09-14 22:18:24, Thomas Koch wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/1714/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-09-14 22:18:24)\nbq.  \nbq.  \nbq.  Review request for zookeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  .\nbq.  \nbq.  \nbq.  This addresses bug ZOOKEEPER-786.\nbq.      https://issues.apache.org/jira/browse/ZOOKEEPER-786\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java 626da04 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/1714/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Thomas\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-27T21:26:45.674+0000","updated":"2011-09-27T21:26:45.674+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12466224/comment/13117210","id":"13117210","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in ZooKeeper-trunk #1318 (See [https://builds.apache.org/job/ZooKeeper-trunk/1318/])\n    ZOOKEEPER-786. Reverting a bad line of this checkin\n\ncamille : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1176903\nFiles : \n* /zookeeper/trunk/src/java/main/org/apache/zookeeper/ClientCnxnSocketNIO.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-29T10:50:23.495+0000","updated":"2011-09-29T10:50:23.495+0000"}],"maxResults":20,"total":20,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-786/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05zmf:"}}