{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13140250","self":"https://issues.apache.org/jira/rest/api/2/issue/13140250","key":"ZOOKEEPER-2985","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-03-06T07:43:35.344+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Mar 06 16:41:28 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2985/watchers","watchCount":9,"isWatching":false},"created":"2018-02-22T16:59:02.654+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335444","id":"12335444","description":"Beta release against 3.5 branch","name":"3.5.3","archived":false,"released":true,"releaseDate":"2017-04-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12339207","id":"12339207","description":"Fix release against 3.4 branch","name":"3.4.11","archived":false,"released":true,"releaseDate":"2017-11-09"}],"issuelinks":[{"id":"12527772","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12527772","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13140261","key":"KAFKA-6584","self":"https://issues.apache.org/jira/rest/api/2/issue/13140261","fields":{"summary":"Session expiration concurrent with ZooKeeper leadership failover may lead to broker registration failure","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-06T16:41:28.590+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"We recently observed an inconsistency in our Kafka cluster which we tracked down to ZooKeeper sessions expiring and then re-appearing after a ZooKeeper leadership failover. The Kafka nodes received session \"Expired\" events, leading to them starting new sessions and attempting to re-create some ephemeral nodes (broker ID nodes in kafka/brokers/ids specifically). However, between receiving the session Expired event and establishing a new session a leadership failover occurred within the ZooKeeper cluster which resulted in the expired session re-appearing. When Kafka attempted to re-create the ephemeral nodes mentioned above it (unexpectedly) received NODEEXISTS errors.\r\n\r\nThis behavior is a result of how session expiration is handled by the leader. Specifically, the expired session is marked as \"closing\" immediately upon expiration (in SessionTrackerImpl) and _before_ the corresponding \"closeSession\" entry is committed. A client can therefore receive a session Expired event before its session is fully closed. A leadership failover which results in the loss of the (uncommitted) closeSession entry thus leads to the sessions' ephemeral nodes \"re-appearing\" until another expiration of the old session on the new leader takes place.\r\n\r\nI'm not certain if this should be considered a bug or an edge case that client are expected to handle. If it is the latter then I think it would be good to include this in the Programmer's Guide in the documentation.\r\n\r\nIf it's helpful I have code to reproduce this on an in-process cluster running 3.4.11 or 3.5.3-beta.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Expired session may unexpired after leader failover","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cthunes","name":"cthunes","key":"cthunes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Thunes","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cthunes","name":"cthunes","key":"cthunes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Thunes","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13140250/comment/16387429","id":"16387429","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Sean+Lee","name":"Sean Lee","key":"sean lee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sean.Lee.","active":true,"timeZone":"Etc/UTC"},"body":"Hi. Chris Thunes. We have met this bug in our product. But we didn't find out the cause then. We  deleted the ephemeral node that should have been expired and let the bug go.\r\n\r\nMay you tell me how to find out the detail cause? by debug log ? or something else?\r\n\r\nthanks a lot.\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Sean+Lee","name":"Sean Lee","key":"sean lee","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sean.Lee.","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-06T07:43:35.344+0000","updated":"2018-03-06T07:43:35.344+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13140250/comment/16387978","id":"16387978","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"[~cthunes]\r\n\r\nThanks for reporting this.\r\n\r\nI think this is related to https://issues.apache.org/jira/browse/ZOOKEEPER-1208 which has intentionally introduced the closing state for events which have been expired, but `closeSession` has not been acknowledged by the quorum.\r\n\r\nWill the ephemerals be removed eventually once the quorum established or they survive forever because of the race condition?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-06T15:44:02.030+0000","updated":"2018-03-06T15:44:02.030+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13140250/comment/16388077","id":"16388077","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cthunes","name":"cthunes","key":"cthunes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Thunes","active":true,"timeZone":"America/New_York"},"body":"The ephemeral nodes do eventually get removed once the new ZK leader marks the session as expired and performs the associated session tear down.\r\n\r\nOne fix may be to have the server close the client connection, _without_ sending the Expired event, if it finds the session is in the closing state with an uncommitted closeSession entry. Alternatively, session re-validation could be blocked for \"closing\" sessions until their corresponding closeSession entry is committed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cthunes","name":"cthunes","key":"cthunes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Thunes","active":true,"timeZone":"America/New_York"},"created":"2018-03-06T16:41:28.590+0000","updated":"2018-03-06T16:41:28.590+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2985/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3qhav:"}}