{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12658066","self":"https://issues.apache.org/jira/rest/api/2/issue/12658066","key":"ZOOKEEPER-1731","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-07-29T16:42:11.486+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Mar 13 18:17:13 UTC 2014","customfield_12310420":"338260","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_349761876_*|*_1_*:*_1_*:*_1118163561_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-08-02T17:45:21.663+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1731/watchers","watchCount":7,"isWatching":false},"created":"2013-07-16T17:59:56.250+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davelatham","name":"davelatham","key":"davelatham","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Latham","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-03-03T01:33:04.542+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"We had a cluster of 3 peers (running 3.4.3) fail after we took down 1 peer briefly for maintenance.  A second peer became unresponsive and the leader lost quorum.  Thread dumps on the second peer showed two threads consistently stuck in these states:\n\n{noformat}\n\"QuorumPeer[myid=0]/0.0.0.0:2181\" prio=10 tid=0x00002aaab8d20800 nid=0x598a runnable [0x000000004335d000]\n   java.lang.Thread.State: RUNNABLE\n        at java.util.HashMap.put(HashMap.java:405)\n        at org.apache.zookeeper.server.ServerCnxnFactory.registerConnection(ServerCnxnFactory.java:131)\n        at org.apache.zookeeper.server.ZooKeeperServer.finishSessionInit(ZooKeeperServer.java:572)\n        at org.apache.zookeeper.server.quorum.Learner.revalidate(Learner.java:444)\n        at org.apache.zookeeper.server.quorum.Follower.processPacket(Follower.java:133)\n        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:86)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:740)\n\n\n\"NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181\" daemon prio=10 tid=0x00002aaab84b0800 nid=0x5986 runnable [0x0000000040878000]\n   java.lang.Thread.State: RUNNABLE\n        at java.util.HashMap.removeEntryForKey(HashMap.java:614)\n        at java.util.HashMap.remove(HashMap.java:581)\n        at org.apache.zookeeper.server.ServerCnxnFactory.unregisterConnection(ServerCnxnFactory.java:120)\n        at org.apache.zookeeper.server.NIOServerCnxn.close(NIOServerCnxn.java:971)\n        - locked <0x000000078d8a51f0> (a java.util.HashSet)\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.closeSessionWithoutWakeup(NIOServerCnxnFactory.java:307)\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.closeSession(NIOServerCnxnFactory.java:294)\n        - locked <0x000000078d82c750> (a org.apache.zookeeper.server.NIOServerCnxnFactory)\n        at org.apache.zookeeper.server.ZooKeeperServer.processConnectRequest(ZooKeeperServer.java:834)\n        at org.apache.zookeeper.server.NIOServerCnxn.readConnectRequest(NIOServerCnxn.java:410)\n        at org.apache.zookeeper.server.NIOServerCnxn.readPayload(NIOServerCnxn.java:200)\n        at org.apache.zookeeper.server.NIOServerCnxn.doIO(NIOServerCnxn.java:236)\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:224)\n        at java.lang.Thread.run(Thread.java:662)\n{noformat}\n\nIt shows both threads concurrently modifying ServerCnxnFactory.connectionBeans which is a java.util.HashMap.\n\nThis cluster was serving thousands of clients, which seems to make this condition more likely as it appears to occur when one client connects and another disconnects at about the same time.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12594725","id":"12594725","filename":"ZOOKEEPER-1731.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davelatham","name":"davelatham","key":"davelatham","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Latham","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-07-29T16:35:42.072+0000","size":1196,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12594725/ZOOKEEPER-1731.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"338580","customfield_12312823":null,"summary":"Unsynchronized access to ServerCnxnFactory.connectionBeans results in deadlock","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davelatham","name":"davelatham","key":"davelatham","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Latham","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davelatham","name":"davelatham","key":"davelatham","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Latham","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12658066/comment/13722600","id":"13722600","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davelatham","name":"davelatham","key":"davelatham","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Latham","active":true,"timeZone":"America/Los_Angeles"},"body":"Here's a simple patch that merely changes ServerCnxnFactory.connectionBeans to use a ConcurrentHashMap rather than a plain HashMap.  [~fournc] pointed out that this same fix was already done in 3.5 as part of ZOOKEEPER-1505.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davelatham","name":"davelatham","key":"davelatham","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Latham","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-07-29T16:35:42.075+0000","updated":"2013-07-29T16:35:42.075+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12658066/comment/13722611","id":"13722611","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12594725/ZOOKEEPER-1731.patch\n  against trunk revision 1503101.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    -1 patch.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1525//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-07-29T16:42:11.486+0000","updated":"2013-07-29T16:42:11.486+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12658066/comment/13722640","id":"13722640","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davelatham","name":"davelatham","key":"davelatham","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Latham","active":true,"timeZone":"America/Los_Angeles"},"body":"Note this patch is for branch-3.4 and so doesn't apply to trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davelatham","name":"davelatham","key":"davelatham","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Latham","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-07-29T17:03:10.823+0000","updated":"2013-07-29T17:03:10.823+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12658066/comment/13727807","id":"13727807","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Looks good checking in","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2013-08-02T17:03:37.719+0000","updated":"2013-08-02T17:03:37.719+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12658066/comment/13933789","id":"13933789","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Closing issues after releasing 3.4.6.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2014-03-13T18:17:13.193+0000","updated":"2014-03-13T18:17:13.193+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1731/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1mcdz:"}}