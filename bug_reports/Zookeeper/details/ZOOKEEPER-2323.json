{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12914242","self":"https://issues.apache.org/jira/rest/api/2/issue/12914242","key":"ZOOKEEPER-2323","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12331981","id":"12331981","description":"Alpha release against 3.5 branch","name":"3.5.2","archived":false,"released":true,"releaseDate":"2016-07-21"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-11-18T22:26:00.544+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 11 20:00:24 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_2_*:*_23009156788_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_57874268","customfield_12312321":null,"resolutiondate":"2016-08-11T20:00:24.022+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2323/watchers","watchCount":4,"isWatching":false},"created":"2015-11-18T20:29:53.338+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325149","id":"12325149","description":"Fix release against 3.4 branch","name":"3.4.7","archived":false,"released":true,"releaseDate":"2015-12-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326786","id":"12326786","description":"Alpha release against 3.5 branch","name":"3.5.1","archived":false,"released":true,"releaseDate":"2015-09-02"}],"issuelinks":[{"id":"12477444","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12477444","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12781714","key":"ZOOKEEPER-2139","self":"https://issues.apache.org/jira/rest/api/2/issue/12781714","fields":{"summary":"Support multiple ZooKeeper client, with different configurations, in a single JVM","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-08-11T20:00:24.280+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312381","id":"12312381","name":"java client","description":"The java client interface for ZooKeeper"}],"timeoriginalestimate":null,"description":"ZooKeeper client enters into infinite AuthFailedException cycle. For every operation its throws AuthFailedException\nHere is the create operation exception\n{code}\norg.apache.zookeeper.KeeperException$AuthFailedException: KeeperErrorCode = AuthFailed for /continuousRunningZKClient\n\tat org.apache.zookeeper.KeeperException.create(KeeperException.java:127)\n\tat org.apache.zookeeper.KeeperException.create(KeeperException.java:51)\n\tat org.apache.zookeeper.ZooKeeper.getData(ZooKeeper.java:1753)\n{code}\n\nThis can be reproduced easily with the following steps:\n\n# Reduce the ZooKeeper client principal max life for example set 2 min.  use command {color:blue} modprinc -maxlife 2min zkcli  {color} in kadmin. (This is done to reduce the issue reproduce time)\n# Connect Client to ZooKeeper quorum,let it gets connected and some operations are done successfully\n# Disconnect the Client's network, by pulling out the Ethernet cable or by any way. Now the Client is in disconnected state, no operation is expected,Client tries to reconnect to different-different servers in the ZooKeeper quorum.\n# After two minutes Client tries to get new Keberos ticket and it fails.\n# Connect the Client to network. Client comes in connected state but AuthFailedException for every operation.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12773091","id":"12773091","filename":"ZOOKEEPER-2323-01.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2015-11-18T22:06:35.473+0000","size":2682,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12773091/ZOOKEEPER-2323-01.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ZooKeeper client enters into infinite AuthFailedException cycle if its unable to recreate Kerberos ticket","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15011953","id":"15011953","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"As per my analysis following is the sequence of events which cause the problem\n#  After two minutes from network disconnect, Client automatically switched to DIGEST-MD5 authentication mechanism\nCode reference in {{org.apache.zookeeper.client.ZooKeeperSaslClient.createSaslClient(String, String)}}\n{code}\nif (subject.getPrincipals().isEmpty()) {\n    // no principals: must not be GSSAPI: use DIGEST-MD5 mechanism instead.\n    LOG.info(\"Client will use DIGEST-MD5 as SASL mechanism.\");\n    String[] mechs = {\"DIGEST-MD5\"};\n    String username = (String)(subject.getPublicCredentials().toArray()[0]);\n    String password = (String)(subject.getPrivateCredentials().toArray()[0]);\n    // \"zk-sasl-md5\" is a hard-wired 'domain' parameter shared with zookeeper server code (see ServerCnxnFactory.java)\n    saslClient = Sasl.createSaslClient(mechs, username, \"zookeeper\", \"zk-sasl-md5\", null, new ClientCallbackHandler(password));\n    return saslClient;\n}\n{code}\n{{subject.getPrincipals().isEmpty()}} is true because Kerberos ticket is already expired\n#  Code {{(String)(subject.getPublicCredentials().toArray()\\[0\\]);}} throws {{java.lang.ArrayIndexOutOfBoundsException}} and finally null is returned instead of {{SaslClient}} object\n# Because SaslClient is null Client enters into {{States.AUTH_FAILED}} state\nCode reference in {{org.apache.zookeeper.ClientCnxn.SendThread.run()}}\n{code}\ntry {\n      zooKeeperSaslClient.initialize(ClientCnxn.this);\n  } catch (SaslException e) {\n     LOG.error(\"SASL authentication with Zooeeper Quorum member failed: \" + e);\n      state = States.AUTH_FAILED;\n      sendAuthEvent = true;\n  }\n{code}\n{{zooKeeperSaslClient.initialize}} throws SaslException as SaslClient is null","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2015-11-18T20:59:40.451+0000","updated":"2015-11-18T20:59:40.451+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15012117","id":"15012117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"# This issue gets fixed if re-throw LoginException instead of eating the exceptions while creating the {{javax.security.sasl.SaslClient}}. \n# We should do array size check before using the its elements\n\nPoint 1 alone will solve the problem. But is good to have point 2 as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2015-11-18T21:58:33.149+0000","updated":"2015-11-18T21:58:33.149+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15012135","id":"15012135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"{noformat}\n2015-11-18 23:46:39,045 [myid:] - INFO  [main-SendThread(192.168.1.3:2183):ClientCnxn$SendThread@1138] - Opening socket connection to server 192.168.1.3/192.168.1.3:2183. Will attempt to SASL-authenticate using Login Context section 'Client'\n2015-11-18 23:46:40,387 [myid:] - WARN  [main-SendThread(192.168.1.3:2183):ClientCnxn$SendThread@1206] - Client session timed out, have not heard from server in 1499ms for sessionid 0x200009eb6510002\n2015-11-18 23:46:40,387 [myid:] - INFO  [main-SendThread(192.168.1.3:2183):ClientCnxn$SendThread@1254] - Client session timed out, have not heard from server in 1499ms for sessionid 0x200009eb6510002, closing socket connection and attempting reconnect\n2015-11-18 23:46:41,323 [myid:] - INFO  [main-SendThread(192.168.1.3:2181):ZooKeeperSaslClient@235] - Client will use DIGEST-MD5 as SASL mechanism.\n2015-11-18 23:46:41,323 [myid:] - ERROR [main-SendThread(192.168.1.3:2181):ZooKeeperSaslClient@305] - Exception while trying to create SASL client: java.lang.ArrayIndexOutOfBoundsException: 0\n2015-11-18 23:46:41,323 [myid:] - INFO  [main-SendThread(192.168.1.3:2181):ClientCnxn$SendThread@1138] - Opening socket connection to server 192.168.1.3/192.168.1.3:2181. Will attempt to SASL-authenticate using Login Context section 'Client'\n2015-11-18 23:46:42,666 [myid:] - WARN  [main-SendThread(192.168.1.3:2181):ClientCnxn$SendThread@1206] - Client session timed out, have not heard from server in 2169ms for sessionid 0x200009eb6510002\n2015-11-18 23:46:42,666 [myid:] - INFO  [main-SendThread(192.168.1.3:2181):ClientCnxn$SendThread@1254] - Client session timed out, have not heard from server in 2169ms for sessionid 0x200009eb6510002, closing socket connection and attempting reconnect\n2015-11-18 23:46:44,365 [myid:] - INFO  [main-SendThread(192.168.1.3:2182):ZooKeeperSaslClient@235] - Client will use DIGEST-MD5 as SASL mechanism.\n2015-11-18 23:46:44,365 [myid:] - ERROR [main-SendThread(192.168.1.3:2182):ZooKeeperSaslClient@305] - Exception while trying to create SASL client: java.lang.ArrayIndexOutOfBoundsException: 0\n2015-11-18 23:46:44,365 [myid:] - INFO  [main-SendThread(192.168.1.3:2182):ClientCnxn$SendThread@1138] - Opening socket connection to server 192.168.1.3/192.168.1.3:2182. Will attempt to SASL-authenticate using Login Context section 'Client'\n2015-11-18 23:46:44,365 [myid:] - INFO  [main-SendThread(192.168.1.3:2182):ClientCnxn$SendThread@980] - Socket connection established, initiating session, client: /192.168.1.2:51072, server: 192.168.1.3/192.168.1.3:2182\n2015-11-18 23:46:44,396 [myid:] - WARN  [main-SendThread(192.168.1.3:2182):ClientCnxn$SendThread@1392] - Unable to reconnect to ZooKeeper service, session 0x200009eb6510002 has expired\n2015-11-18 23:46:44,396 [myid:] - INFO  [main-SendThread(192.168.1.3:2182):ClientCnxn$SendThread@1252] - Unable to reconnect to ZooKeeper service, session 0x200009eb6510002 has expired, closing socket connection\n2015-11-18 23:46:44,396 [myid:] - INFO  [main-EventThread:ZooKeeper@716] - Initiating client connection, connectString=192.168.1.3:2181,192.168.1.3:2182,192.168.1.3:2183 sessionTimeout=4000 watcher=com.mycom.bds.zk.ContinuousRunningZKClient@15fa2b3e\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2015-11-18T22:05:42.087+0000","updated":"2015-11-18T22:05:42.087+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15012151","id":"15012151","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"Another concern is authentication mechanism should not automatically change Or at-least it should be conferable. I will handle this as part of ZOOKEEPER-2324 ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2015-11-18T22:09:07.519+0000","updated":"2015-11-18T22:09:07.519+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15012187","id":"15012187","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12773091/ZOOKEEPER-2323-01.patch\n  against trunk revision 1713774.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    -1 javadoc.  The javadoc tool appears to have generated 1 warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2957//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2957//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2957//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2015-11-18T22:26:00.544+0000","updated":"2015-11-18T22:26:00.544+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15013566","id":"15013566","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jobo","name":"Jobo","key":"jobo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bob.zhao","active":true,"timeZone":"Etc/UTC"},"body":"Hi, [~arshad.mohammad]\n     I just test with your patch , found that it can not fixed auth failed issue in below scenarios:\nset TGT expire in 2 mins, session expire in 3 mins\n1. Start zk client to connect kerberos zk cluster, and some operations can be done successfully\n2. Disconnect the Client's network\n3. TGT expired \n4. session expried\nIf, Between 3 and 4 step, we recovery network. \nBut we will got exception :\n{code}\njava.security.PrivilegedActionException: javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]\nat java.security.AccessController.doPrivileged(Native Method)\nat javax.security.auth.Subject.doAs(Unknown Source)\nat org.apache.zookeeper.client.ZooKeeperSaslClient.createSaslToken(ZooKeeperSaslClient.java:394)\nat org.apache.zookeeper.client.ZooKeeperSaslClient.createSaslToken(ZooKeeperSaslClient.java:379)\nat org.apache.zookeeper.client.ZooKeeperSaslClient.sendSaslPacket(ZooKeeperSaslClient.java:451)\nat org.apache.zookeeper.client.ZooKeeperSaslClient.initialize(ZooKeeperSaslClient.java:489)\nat org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1243)\nCaused by: javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]\nat com.sun.security.sasl.gsskerb.GssKrb5Client.evaluateChallenge(Unknown Source)\nat org.apache.zookeeper.client.ZooKeeperSaslClient$2.run(ZooKeeperSaslClient.java:397)\nat org.apache.zookeeper.client.ZooKeeperSaslClient$2.run(ZooKeeperSaslClient.java:\n{code}\nAbove exception result in client got authfailed state:\n{code}\n2015-11-19-18:58:26  [ERROR]  main-SendThread(9.91.8.212:24002)  org.apache.zookeeper.client.ZooKeeperSaslClient.createSaslToken(ZooKeeperSaslClient.java:415)  An error: (java.security.PrivilegedActionException: javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]) occurred when evaluating Zookeeper Quorum Member's  received SASL token. Zookeeper Client will go to AUTH_FAILED state.\n2015-11-19-18:58:26  [ERROR]  main-SendThread(9.91.8.212:24002)  org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1245)  SASL authentication with Zookeeper Quorum member failed: javax.security.sasl.SaslException: An error: (java.security.PrivilegedActionException: javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]) occurred when evaluating Zookeeper Quorum Member's  received SASL token. Zookeeper Client will go to AUTH_FAILED state.\n{code}\nFinally, even TGT are renewed in the next cycle loop. This Client would alway got authfailed for every operation forever.\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jobo","name":"Jobo","key":"jobo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bob.zhao","active":true,"timeZone":"Etc/UTC"},"created":"2015-11-19T13:51:43.280+0000","updated":"2015-11-19T13:51:43.280+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15013594","id":"15013594","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Canceling patch until issues raised is resolved.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2015-11-19T14:11:20.958+0000","updated":"2015-11-19T14:11:20.958+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15013605","id":"15013605","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jobo","name":"Jobo","key":"jobo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bob.zhao","active":true,"timeZone":"Etc/UTC"},"body":"    From the code flow, I can see the ZooKeeperSaslClient throw exception in above scenarios is caused by below reason:\nDuring network disconnection, relogin happened which clear the content of subject object , and after network recovery,  when client try to setup connection, it will check the TGT firstly, TGT will not be avaliable until next relogin operator happened.\nSo , I thinks when try to setup connection when network recovery , in this flow we can do relogin firstly if relogin happened during network disconnected. \n[~arshad.mohammad], Any thought?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jobo","name":"Jobo","key":"jobo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bob.zhao","active":true,"timeZone":"Etc/UTC"},"created":"2015-11-19T14:26:44.465+0000","updated":"2015-11-19T14:26:44.465+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15013675","id":"15013675","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jobo","name":"Jobo","key":"jobo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bob.zhao","active":true,"timeZone":"Etc/UTC"},"body":"With below modify, the auth issue can be solved, pls refer to :\n\n1) Modify Login.java： add one public relogin method for setupconnection\n{noformat}\n     /**\n     * Re-login method, just for the client setup connection when network recovery.\n     * Note: This method is just for Internal used. Be carefully when call it.\n     * @throws LoginException\n     */\n    public void reLoginForSetupConnection()\n            throws LoginException {\n        if (!isKrbTicket) {\n            return;\n        }\n        LoginContext login = getLogin();\n        if (login  == null) {\n            throw new LoginException(\"login must be done first\");\n        }\n        LOG.info(\"Initiating logout for \" + principal);\n        synchronized (Login.class) {\n            //clear up the kerberos state. But the tokens are not cleared! As per\n            //the Java kerberos login module code, only the kerberos credentials\n            //are cleared\n            login.logout();\n            //login and also update the subject field of this instance to\n            //have the new credentials (pass it to the LoginContext constructor)\n            login = new LoginContext(loginContextName, getSubject());\n            LOG.info(\"Initiating re-login for \" + principal);\n            login.login();\n            setLogin(login);\n        }\n    }\n{noformat}\n\n2) Modify ZooKeeperSaslClient.java : add relogin logic before do auth check.\n{noformat}\n    synchronized private SaslClient createSaslClient(final String servicePrincipal,\n                                                     final String loginContext) throws LoginException {\n        try {\n            if (login == null) {\n                if (LOG.isDebugEnabled()) {\n                    LOG.debug(\"JAAS loginContext is: \" + loginContext);\n                }\n                // note that the login object is static: it's shared amongst all zookeeper-related connections.\n                // createSaslClient() must be declared synchronized so that login is initialized only once.\n                login = new Login(loginContext, new ClientCallbackHandler(null));\n                login.startThreadIfNeeded();\n            }\n   +        if (login.getSubject().getPrincipals().isEmpty()) {\n   +         LOG.info(\"Begin to reLogin once for this Connection Setup.\");\n   +         login.reLoginForSetupConnection();\n   +        }\n            Subject subject = login.getSubject();\n            SaslClient saslClient;\n            ....\n{noformat}\n\nIf any idea , pls let me know, thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jobo","name":"Jobo","key":"jobo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bob.zhao","active":true,"timeZone":"Etc/UTC"},"created":"2015-11-19T15:13:26.821+0000","updated":"2015-11-19T15:13:26.821+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15135492","id":"15135492","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"[~fpj], [~Jobo], [~arshad.mohammad]: punting for 3.4.9. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-02-06T02:47:30.164+0000","updated":"2016-02-06T02:47:30.164+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12914242/comment/15417840","id":"15417840","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"This defect got fixed with ZOOKEEPER-2139 fix.\nAfter ZOOKEEPER-2139 fix Login object is created while connecting to each zookeeper server in the quorum, this way Zookeeper client gets chance to refresh the kerberos ticket while connecting to any of the zookeeper server. \nVerified in the 3.5.2-alpha release the issue is fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-08-11T20:00:24.166+0000","updated":"2016-08-11T20:00:24.166+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2323/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2olnj:"}}