{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12677722","self":"https://issues.apache.org/jira/rest/api/2/issue/12677722","key":"ZOOKEEPER-1809","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2013-11-06T08:31:22.875+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Nov 12 00:49:12 UTC 2013","customfield_12310420":"357097","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_82080988_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-11-07T03:54:43.021+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1809/watchers","watchCount":4,"isWatching":false},"created":"2013-11-06T05:06:42.062+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321883","id":"12321883","description":"Fix release against 3.4 branch","name":"3.4.5","archived":false,"released":true,"releaseDate":"2012-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"issuelinks":[{"id":"12378042","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12378042","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12663897","key":"ZOOKEEPER-1740","self":"https://issues.apache.org/jira/rest/api/2/issue/12663897","fields":{"summary":"Zookeeper 3.3.4 loses ephemeral nodes under stress","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-12-06T21:32:15.518+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"We have been running into a situation where we attempt to recreate our ephemeral nodes after a session expiry, only to find that the node already exists.   Admittedly, this is only happening when we are aggresively killing and recreating sessions in a tight loop, but I thought it might point to a larger issue which may need to be addressed.\n\nAttached is a small app which demonstrates the issue, and a log file (client and server in the same log) which shows the issue as it occured.  Reproducing the bug is a tedious process of rerunning the test over and over again, but I have typically been able to reproduce it within 15mins of trying.  The test app is using Curator, however, I think the issue is occuring at the ZK level since the logs clearly indicate the ephermal node is deleted after the session expiry.\n\nInteresting bits from the log\n{noformat}\n...\n2013/11/06 13:46:03,065 INFO  [ConnectionStateManager-0] Recreating node: /test\n...\n2013/11/06 13:46:03,070 DEBUG [SyncThread:0] Processing request:: sessionid:0x1422bbb36d10002 type:create cxid:0x2 zxid:0x8 txntype:1 reqpath:n/a\n...\n2013/11/06 13:46:03,071 DEBUG [main] Closing client for session: 0x1422bbb36d10002\n2013/11/06 13:46:03,075 INFO  [ProcessThread(sid:0 cport:-1):] Processed session termination for sessionid: 0x1422bbb36d10002\n2013/11/06 13:46:03,079 DEBUG [SyncThread:0] Processing request:: sessionid:0x1422bbb36d10002 type:closeSession cxid:0x1 zxid:0x9 txntype:-11 reqpath:n/a\n2013/11/06 13:46:03,080 DEBUG [SyncThread:0] Deleting ephemeral node /test for session 0x1422bbb36d10002\n2013/11/06 13:46:03,080 DEBUG [SyncThread:0] sessionid:0x1422bbb36d10002 type:closeSession cxid:0x1 zxid:0x9 txntype:-11 reqpath:n/a\n...\n2013/11/06 13:46:04,459 INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:43462] Client attempting to renew session 0x1422bbb36d10002 at /127.0.0.1:59559\n2013/11/06 13:46:04,459 INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:43462] Invalid session 0x1422bbb36d10002 for client /127.0.0.1:59559, probably expired\n2013/11/06 13:46:04,460 INFO  [main-SendThread(localhost:43462)] Unable to reconnect to ZooKeeper service, session 0x1422bbb36d10002 has expired, closing socket connection\n2013/11/06 13:46:04,460 DEBUG [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:43462] Dropping request: No session with sessionid 0x1422bbb36d10002 exists, probably expired and removed\n...\n2013/11/06 13:46:04,463 INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:43462] Client attempting to establish new session at /127.0.0.1:59560\n2013/11/06 13:46:04,466 DEBUG [SyncThread:0] Processing request:: sessionid:0x1422bbb36d10003 type:createSession cxid:0x0 zxid:0xa txntype:-10 reqpath:n/a\n2013/11/06 13:46:04,466 DEBUG [SyncThread:0] sessionid:0x1422bbb36d10003 type:createSession cxid:0x0 zxid:0xa txntype:-10 reqpath:n/a\n2013/11/06 13:46:04,467 INFO  [SyncThread:0] Established session 0x1422bbb36d10003 with negotiated timeout 30000 for client /127.0.0.1:59560\n...\n2013/11/06 13:46:04,473 INFO  [ConnectionStateManager-0] Recreating node: /test\n2013/11/06 13:46:04,474 DEBUG [SyncThread:0] Processing request:: sessionid:0x1422bbb36d10003 type:exists cxid:0x2 zxid:0xfffffffffffffffe txntype:unknown reqpath:/___CURATOR_KILL_SESSION___15970538640754\n2013/11/06 13:46:04,474 DEBUG [SyncThread:0] sessionid:0x1422bbb36d10003 type:exists cxid:0x2 zxid:0xfffffffffffffffe txntype:unknown reqpath:/___CURATOR_KILL_SESSION___15970538640754\n2013/11/06 13:46:04,475 INFO  [ProcessThread(sid:0 cport:-1):] Got user-level KeeperException when processing sessionid:0x1422bbb36d10003 type:create cxid:0x3 zxid:0xc txntype:-1 reqpath:n/a Error Path:/test Error:KeeperErrorCode = NodeExists for /test\n2013/11/06 13:46:04,475 DEBUG [main-SendThread(localhost:43462)] Reading reply sessionid:0x1422bbb36d10003, packet:: clientPath:null serverPath:null finished:false header:: 2,3  replyHeader:: 2,11,-101  request:: '/___CURATOR_KILL_SESSION___15970538640754,T  response::  \n2013/11/06 13:46:04,476 INFO  [main] Initiating client connection, connectString=127.0.0.1:43462 sessionTimeout=10000 watcher=com.netflix.curator.test.KillSession$2@4067d00a sessionId=1422bbb36d10003 sessionPasswd=<hidden>\n...\n2013/11/06 13:46:04,479 ERROR [ConnectionStateManager-0] Failed to recreate ephemeral node\norg.apache.zookeeper.KeeperException$NodeExistsException: KeeperErrorCode = NodeExists for /test\n\tat org.apache.zookeeper.KeeperException.create(KeeperException.java:119)\n\tat org.apache.zookeeper.KeeperException.create(KeeperException.java:51)\n\tat org.apache.zookeeper.ZooKeeper.create(ZooKeeper.java:783)\n\tat com.netflix.curator.framework.imps.CreateBuilderImpl$10.call(CreateBuilderImpl.java:625)\n\tat com.netflix.curator.framework.imps.CreateBuilderImpl$10.call(CreateBuilderImpl.java:609)\n\tat com.netflix.curator.RetryLoop.callWithRetry(RetryLoop.java:106)\n\tat com.netflix.curator.framework.imps.CreateBuilderImpl.pathInForeground(CreateBuilderImpl.java:605)\n\tat com.netflix.curator.framework.imps.CreateBuilderImpl.forPath(CreateBuilderImpl.java:428)\n\tat com.netflix.curator.framework.imps.CreateBuilderImpl.forPath(CreateBuilderImpl.java:408)\n\tat com.netflix.curator.framework.imps.CreateBuilderImpl.forPath(CreateBuilderImpl.java:41)\n\tat com.rakuten.sandbox.sessionexpiry.nodeexists.SessionExpiryTest$2.stateChanged(SessionExpiryTest.java:72)\n\tat com.netflix.curator.framework.state.ConnectionStateManager$2.apply(ConnectionStateManager.java:184)\n\tat com.netflix.curator.framework.state.ConnectionStateManager$2.apply(ConnectionStateManager.java:180)\n\tat com.netflix.curator.framework.listen.ListenerContainer$1.run(ListenerContainer.java:92)\n\tat com.google.common.util.concurrent.MoreExecutors$SameThreadExecutorService.execute(MoreExecutors.java:262)\n\tat com.netflix.curator.framework.listen.ListenerContainer.forEach(ListenerContainer.java:83)\n\tat com.netflix.curator.framework.state.ConnectionStateManager.processEvents(ConnectionStateManager.java:177)\n\tat com.netflix.curator.framework.state.ConnectionStateManager.access$000(ConnectionStateManager.java:40)\n\tat com.netflix.curator.framework.state.ConnectionStateManager$1.call(ConnectionStateManager.java:104)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:262)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n...\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12612321","id":"12612321","filename":"SessionExpiryTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-06T05:10:57.834+0000","size":3848,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12612321/SessionExpiryTest.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12612325","id":"12612325","filename":"testapp.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-06T05:22:44.459+0000","size":46858,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12612325/testapp.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12612342","id":"12612342","filename":"testapp-3.5.0.log.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-06T09:02:01.184+0000","size":9616,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12612342/testapp-3.5.0.log.gz"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"357387","customfield_12312823":null,"summary":"ephemeral node not deleted (or recreated?) after session expiry","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677722/comment/13814606","id":"13814606","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"body":"Small testapp which demonstates the issue.  Depends on Curator (v1.3.3) and SLF4J (1.6+).  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-06T05:10:57.839+0000","updated":"2013-11-06T05:10:57.839+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677722/comment/13814615","id":"13814615","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"body":"complete log file (client and server in the same file) showing a run of the attached testapp when the problem occurred.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-06T05:22:44.463+0000","updated":"2013-11-06T05:22:44.463+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677722/comment/13814702","id":"13814702","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"body":"This could be related or even a duplicate of ZOOKEEPER-1740. Could you please check?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abranzyck","name":"abranzyck","key":"abranzyck","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=abranzyck&avatarId=16792","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=abranzyck&avatarId=16792","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=abranzyck&avatarId=16792","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=abranzyck&avatarId=16792"},"displayName":"Germán Blanco","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-06T08:31:22.875+0000","updated":"2013-11-06T08:31:22.875+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677722/comment/13814716","id":"13814716","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"body":"The bug seems identical, execpt that ZOOKEEPER-1740 was targeted to the 3.3 branch.  This is occurring on 3.4.5.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-06T08:45:32.149+0000","updated":"2013-11-06T08:45:32.149+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677722/comment/13814725","id":"13814725","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"body":"After re-running the app for 15mins, I was able to reproduce the issue against a build of 3.5.0 I made from the latest trunk source","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-06T09:02:01.189+0000","updated":"2013-11-06T09:02:01.189+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677722/comment/13814800","id":"13814800","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I'm confused, the description says that the ephemeral is deleted after the session expiration. Is that a typo or the ephemeral is eventually deleted?\n\nIn any case, I remember having a discussion not too far back on the list and it might be related to this. I believe that expiring a session and deleting the ephemerals are not done atomically. The contract is that the ephemeral won't be deleted while the session is expired, not that it will be deleted at the exact time the session expires. So it is possible that you find the ephemeral still there for some short period of time. This is safe. \n\nWe have a problem if it never goes away.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-06T11:23:46.793+0000","updated":"2013-11-06T11:23:46.793+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677722/comment/13815506","id":"13815506","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"body":"No, its not a typo, but it may be a bit misleading.  The ZK log indicates that the ephemeral node has been deleted, then at a later point in time the app tries to recreate the node but gets a \"NodeExists\".  This can been seen in the logs from these lines\n\n{noformat}\n...\n2013/11/06 13:46:03,080 DEBUG [SyncThread:0] Deleting ephemeral node /test for session 0x1422bbb36d10002\n...\n2013/11/06 13:46:04,475 INFO  [ProcessThread(sid:0 cport:-1):] Got user-level KeeperException when processing sessionid:0x1422bbb36d10003 type:create cxid:0x3 zxid:0xc txntype:-1 reqpath:n/a Error Path:/test Error:KeeperErrorCode = NodeExists for /test\n{noformat}\n\nBecause of the ordering of these messages, I would assume the request should have succeeded.  Currently, the testapp exits as soon as the NodeExits exception is thrown so I dont know if the node eventually is deleted or not.  I suspect that it is though.\n\nIf I cannot be guarnateed that my ephemeral nodes will be deleted after a session expiry, what is the recommended practice for recreating ephemeral nodes?  Should I just keep polling the server until all of those nodes go away?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-07T00:42:55.423+0000","updated":"2013-11-07T00:42:55.423+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677722/comment/13815623","id":"13815623","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"body":"Sorry everyone, this is my bad.  I took a closer look at the ZK logs and noticed that a \"create\" request is made immediately after being reconnected to the ZK cluster.  My RetryPolicy is causing a recovery attempt from a previous session to create the ephemeral node immediately after reconnecting to ZK, but before the new recovery attempt is made.  I will just have to change my code to handle session expiry while in the middle of a recovery.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-07T03:52:56.195+0000","updated":"2013-11-07T03:52:56.195+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677722/comment/13815624","id":"13815624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"body":"As indicated previously, this was a problem with the way the testapp was handling reconnect and not a problem with ZK.  Closing the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shauns","name":"shauns","key":"shauns","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shaun Senecal","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-07T03:54:43.043+0000","updated":"2013-11-07T03:54:43.043+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677722/comment/13819673","id":"13819673","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"No problem [~shauns] - for future reference (and others looking at this jira) I've found it helpful to use the LogFormatter tool to dump the logs when attempting to debug such issues. It will give insight into the operations being performed. log4j logs are great, but this can often be even better.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-11-12T00:49:12.524+0000","updated":"2013-11-12T00:49:12.524+0000"}],"maxResults":10,"total":10,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1809/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1pk6n:"}}