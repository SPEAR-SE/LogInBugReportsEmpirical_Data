{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12479098","self":"https://issues.apache.org/jira/rest/api/2/issue/12479098","key":"ZOOKEEPER-919","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315482","id":"12315482","description":"Fix release against 3.3 branch","name":"3.3.3","archived":false,"released":true,"releaseDate":"2011-02-27"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314469","id":"12314469","description":"Kerberos client auth, multi support, deb/rpm pkging.","name":"3.4.0","archived":false,"released":true,"releaseDate":"2011-11-22"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2010-12-07T09:19:29.789+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jan 26 18:16:37 UTC 2011","customfield_12310420":"47548","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_7187595957_*|*_5_*:*_2_*:*_25599269001_*|*_4_*:*_1_*:*_49064","customfield_12312321":null,"resolutiondate":"2011-11-19T01:11:55.277+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-919/watchers","watchCount":2,"isWatching":false},"created":"2010-11-04T13:43:21.307+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314846","id":"12314846","description":"Fix release against 3.3 branch","name":"3.3.1","archived":false,"released":true,"releaseDate":"2010-05-17"}],"issuelinks":[{"id":"12336523","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12336523","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12493781","key":"ZOOKEEPER-962","self":"https://issues.apache.org/jira/rest/api/2/issue/12493781","fields":{"summary":"leader/follower coherence issue when follower is receiving a DIFF","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-23T19:22:22.523+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"I was testing stability of Zookeeper ensemble for production deployment. Three node ensemble cluster configuration.\nIn a loop, I kill/restart three Zookeeper clients that created one ephemeral node each, and at the same time,\nI killed Java process on one of ensemble (dont' know if it was a leader or not). Then I restarted Zookeeper on the server,\n\nIt turns out that on two zookeeper ensemble servers, all the ephemeral nodes are gone (it should), but on the newly started\nZookeeper server, the two old ephemeral nodes stayed.  The zookeeper didn't restart in standalone mode since new ephemeral\nnodes gets created on all ensemble servers. \nI captured the log.\n\n\n2010-11-04 17:48:50,201 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:17288:NIOServerCnxn$Factory@250] - Accepted socket connection from /10.25.131.21:11191\n2010-11-04 17:48:50,202 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:17288:NIOServerCnxn@776] - Client attempting to establish new session at /10.25.131.21:11191\n2010-11-04 17:48:50,203 - INFO  [CommitProcessor:1:NIOServerCnxn@1579] - Established session 0x12c160c31fc000b with negotiated timeout 30000 for client /10.25.131.21:11191\n2010-11-04 17:48:50,206 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:17288:NIOServerCnxn@633] - EndOfStreamException: Unable to read additional data from client sessionid 0x12c160c31fc000b, likely client has closed socket\n2010-11-04 17:48:50,207 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:17288:NIOServerCnxn@1434] - Closed socket connection for client /10.25.131.21:11191 which had sessionid 0x12c160c31fc000b\n2010-11-04 17:48:50,207 - ERROR [CommitProcessor:1:NIOServerCnxn@444] - Unexpected Exception:\njava.nio.channels.CancelledKeyException\n        at sun.nio.ch.SelectionKeyImpl.ensureValid(SelectionKeyImpl.java:55)\n        at sun.nio.ch.SelectionKeyImpl.interestOps(SelectionKeyImpl.java:59)\n        at org.apache.zookeeper.server.NIOServerCnxn.sendBuffer(NIOServerCnxn.java:417)\n        at org.apache.zookeeper.server.NIOServerCnxn.sendResponse(NIOServerCnxn.java:1508)\n        at org.apache.zookeeper.server.FinalRequestProcessor.processRequest(FinalRequestProcessor.java:367)\n        at org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:73)\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12465675","id":"12465675","filename":"logs.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-07T09:19:29.603+0000","size":522253,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12465675/logs.tar.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12465888","id":"12465888","filename":"logs2.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-09T08:59:06.093+0000","size":131503,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12465888/logs2.tar.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12466298","id":"12466298","filename":"logs3.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-15T09:06:19.971+0000","size":63975,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12466298/logs3.tar.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12466312","id":"12466312","filename":"zk.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-15T12:21:01.856+0000","size":2509,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12466312/zk.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32810","customfield_12312823":null,"summary":"Ephemeral nodes remains in one of ensemble after deliberate SIGKILL","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux CentOS 5.3 64bit, JDK 1.6.0-22\nSLES 11","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12968638","id":"12968638","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"\n1. Create 3 node cluster\n#Tue Dec 07 03:08:43 UTC 2010\nserver.2=10.150.27.112\\:2888\\:3888\nserver.1=10.150.27.111\\:2888\\:3888\nserver.0=10.150.27.110\\:2888\\:3888\ninitLimit=5\nsyncLimit=2\nsnapCount=10000\nclientPort=2181\ntickTime=2000\ndataDir=/var/zookeeper\n\n2. run attached test.sh\n\nzkmgtserver.jar in test.sh is our jar file that starts ZkServer. On\n10.150.27.112 we made zkmgtserver also start a client that creates\nznode /Online. I was able to repro the problem after a few reboots of\nzkmgmtserver on .112. Reboot of zkmgmtserver results in rebooting\nzkserver and the client.\n\nFile stat.out displays output of stat on /Online. We can see that\nafter rebooting zkmgmtserver (which reboots zkserver and zkclient),\nold /Online znode reappeared.\n\nlog4j:WARN No appenders could be found for logger (org.apache.zookeeper.ZooKeeper).\nlog4j:WARN Please initialize the log4j system properly.\ncZxid = 0x50000054a\nctime = Tue Dec 07 03:07:59 UTC 2010\nmZxid = 0x50000054a\nmtime = Tue Dec 07 03:07:59 UTC 2010\npZxid = 0x50000054a\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x22cbeccc7900000\ndataLength = 54\nnumChildren = 0\n\nlog4j:WARN No appenders could be found for logger (org.apache.zookeeper.ZooKeeper).\nlog4j:WARN Please initialize the log4j system properly.\ncZxid = 0x500000557\nctime = Tue Dec 07 03:08:21 UTC 2010\nmZxid = 0x500000557\nmtime = Tue Dec 07 03:08:21 UTC 2010\npZxid = 0x500000557\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x22cbecd1bb60000\ndataLength = 54\nnumChildren = 0\n\nlog4j:WARN No appenders could be found for logger (org.apache.zookeeper.ZooKeeper).\nlog4j:WARN Please initialize the log4j system properly.\ncZxid = 0x50000054a   <==================== OLD zxid\nctime = Tue Dec 07 03:07:59 UTC 2010\nmZxid = 0x50000054a\nmtime = Tue Dec 07 03:07:59 UTC 2010\npZxid = 0x50000054a\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x22cbeccc7900000\ndataLength = 54\nnumChildren = 0\n\n\nSimilarly, we can see from ZK-10.150.27.112-zookeeper.log that\n10.150.27.112 reapplied an old transaction to create znode.\n\nZK-10.150.27.110-zookeeper.log:2010-12-07 03:07:59,434 - DEBUG [QuorumPeer:/0.0.0.0:2181:CommitProcessor@159] - Committing request:: sessionid:0x22cbeccc7900000 type:create cxid:0x3 zxid:0x50000054a txntype:1 reqpath:n/a\nZK-10.150.27.110-zookeeper.log:2010-12-07 03:07:59,434 - DEBUG [CommitProcessor:0:FinalRequestProcessor@78] - Processing request:: sessionid:0x22cbeccc7900000 type:create cxid:0x3 zxid:0x50000054a txntype:1 reqpath:n/a\nZK-10.150.27.111-zookeeper.log:2010-12-07 03:07:59,881 - DEBUG [ProcessThread:-1:CommitProcessor@169] - Processing request:: sessionid:0x22cbeccc7900000 type:create cxid:0x3 zxid:0x50000054a txntype:1 reqpath:n/a\nZK-10.150.27.111-zookeeper.log:2010-12-07 03:07:59,881 - DEBUG [ProcessThread:-1:Leader@647] - Proposing:: sessionid:0x22cbeccc7900000 type:create cxid:0x3 zxid:0x50000054a txntype:1 reqpath:n/a\nZK-10.150.27.111-zookeeper.log:2010-12-07 03:07:59,883 - DEBUG [LearnerHandler-/10.150.27.112:56606:CommitProcessor@159] - Committing request:: sessionid:0x22cbeccc7900000 type:create cxid:0x3 zxid:0x50000054a txntype:1 reqpath:n/a\nZK-10.150.27.111-zookeeper.log:2010-12-07 03:07:59,883 - DEBUG [CommitProcessor:1:FinalRequestProcessor@78] - Processing request:: sessionid:0x22cbeccc7900000 type:create cxid:0x3 zxid:0x50000054a txntype:1 reqpath:n/a\nZK-10.150.27.112-zookeeper.log:2010-12-07 03:08:00,481 - DEBUG [QuorumPeer:/0.0.0.0:2181:CommitProcessor@159] - Committing request:: sessionid:0x22cbeccc7900000 type:create cxid:0x3 zxid:0x50000054a txntype:1 reqpath:n/a\nZK-10.150.27.112-zookeeper.log:2010-12-07 03:08:00,481 - DEBUG [CommitProcessor:2:FinalRequestProcessor@78] - Processing request:: sessionid:0x22cbeccc7900000 type:create cxid:0x3 zxid:0x50000054a txntype:1 reqpath:/Online\nZK-10.150.27.112-zookeeper.log:2010-12-07 03:08:00,481 - DEBUG [CommitProcessor:2:FinalRequestProcessor@160] - sessionid:0x22cbeccc7900000 type:create cxid:0x3 zxid:0x50000054a txntype:1 reqpath:/Online      <===================== OLD transaction\n\nThe client used in the test was simple: - On .112 opens a connection\nto local ZkServer and creates a /Online znode if it does not exist or\nif the znode is deleted. It creates a new session to the local ZK\nserver after it is rebooted (session ID is not reused).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-07T09:19:29.789+0000","updated":"2010-12-07T09:19:29.789+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12968658","id":"12968658","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Forgot to mention that /Online is present only on .112.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-07T10:04:33.807+0000","updated":"2010-12-07T10:04:33.807+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12968693","id":"12968693","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Please ignore my comment about \"10.150.27.112 reapplied an old transaction to create znode\". Looking at the code the messages are seen as expected.  \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-07T11:52:40.469+0000","updated":"2010-12-07T11:52:40.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12969667","id":"12969667","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"The default debug messages are not good enough to debug this bug.\nAttaching more debug logs. I added more debug messages (starting with VK DEBUG).\n\nWhat I am seeing is that after restart, while loading snapshot, the server is still able to find an old znode in the snapshot. This is happening even if the snapshot is taken after the transaction that deletes the session (and ephemeral znode) from the ZooKeeper data tree.\n\nFor example, we can see that ephemeral znode (/fooOnline) is deleted during transaction 0xf0000001a. See faulty-zookeeper.log.\n\n2010-12-09 03:11:50,609 - TRACE [CommitProcessor:2:ZooTrace@89] - :Esessionid:0x22cc91caece0000 type:closeSession cxid:0x0 zxid:0xf0000001a txntype:-11 reqpath:n/a\n2010-12-09 03:11:50,609 - DEBUG [CommitProcessor:2:FinalRequestProcessor@103] - VK DEBUG: sessionid:0x22cc91caece0000 type:closeSession cxid:0x0 zxid:0xf0000001a txntype:-11 reqpath:n/a\n2010-12-09 03:11:50,609 - DEBUG [CommitProcessor:2:DataTree@751] - VK DEBUG: header 156721212080128000,0,64424509466,1291864306011,-11\n2010-12-09 03:11:50,618 - DEBUG [CommitProcessor:2:DataTree@825] - VK DEBUG: Found ephemeral node /fooOnline for session 0x22cc91caece0000\n2010-12-09 03:11:50,619 - DEBUG [CommitProcessor:2:DataTree@839] - Deleting ephemeral node /fooOnline for session 0x22cc91caece0000\n\nHowever, after several reboots, the znode still lingers in the data tree.\n\n2010-12-09 03:12:11,762 - INFO [Thread-2:FileSnap@82] - Reading snapshot /var/zookeeper/version-2/snapshot.f0000001d (zxid f0000001d)\n[...]\n2010-12-09 03:12:11,768 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 22cc91caece0000 with timeout: 9000\n2010-12-09 03:12:11,771 - DEBUG [Thread-2:DataTree@1088] - VK DEBUG Adding path /fooOnline for 22cc91caece0000\n\n\n2010-12-09 03:13:22,573 - INFO [QuorumPeer:/0.0.0.0:2181:FileSnap@82] - Reading snapshot /var/zookeeper/version-2/snapshot.f0000002a (zxid f0000002a)\n[...]\n2010-12-09 03:13:22,579 - TRACE [QuorumPeer:/0.0.0.0:2181:ZooTrace@70] - loadData --- session in archive: 22cc91caece0000 with timeout: 9000\n[...]\n2010-12-09 03:13:22,581 - DEBUG [QuorumPeer:/0.0.0.0:2181:DataTree@1088] - VK DEBUG Adding path /fooOnline for 22cc91caece0000\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-09T08:59:06.176+0000","updated":"2010-12-09T08:59:06.176+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12969668","id":"12969668","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Forgot to attach output of stat. The session ids are useful for debugging.\n\nmZxid = 0xf0000000a\nmtime = Thu Dec 09 03:11:05 UTC 2010\npZxid = 0xf0000000a\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x22cc91c5a700000\ndataLength = 54\nnumChildren = 0\n\nlog4j:WARN No appenders could be found for logger (org.apache.zookeeper.ZooKeeper).\nlog4j:WARN Please initialize the log4j system properly.\ncZxid = 0xf00000012\nctime = Thu Dec 09 03:11:27 UTC 2010\nmZxid = 0xf00000012\nmtime = Thu Dec 09 03:11:27 UTC 2010\npZxid = 0xf00000012\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x22cc91caece0000\ndataLength = 54\nnumChildren = 0\n\nlog4j:WARN No appenders could be found for logger (org.apache.zookeeper.ZooKeeper).\nlog4j:WARN Please initialize the log4j system properly.\ncZxid = 0xf0000001f\nctime = Thu Dec 09 03:11:48 UTC 2010\nmZxid = 0xf0000001f\nmtime = Thu Dec 09 03:11:48 UTC 2010\npZxid = 0xf0000001f\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x22cc91d033c0000\ndataLength = 54\nnumChildren = 0\n\nlog4j:WARN No appenders could be found for logger (org.apache.zookeeper.ZooKeeper).\nlog4j:WARN Please initialize the log4j system properly.\ncZxid = 0xf00000012\nctime = Thu Dec 09 03:11:27 UTC 2010\nmZxid = 0xf00000012\nmtime = Thu Dec 09 03:11:27 UTC 2010\npZxid = 0xf00000012\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x22cc91caece0000\ndataLength = 54\nnumChildren = 0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-09T09:00:44.063+0000","updated":"2010-12-09T09:00:44.063+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12969669","id":"12969669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Question:\n- Does snapshot.f0000001d contain all committed changes to data tree prior to f0000001d? I know that the snapshot can contain incomplete changes, but I expect it to contain incomplete changes of transactions after f0000001d.\n\nNote that this bug also introduces a \"fork\" in ZK data tree. If I re-create the ephemeral znode that is not getting deleted from the faulty ZK server, then the faulty ZK server keeps seeing old znode even if rest of the servers see the new znode.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-09T09:05:12.999+0000","updated":"2010-12-09T09:05:12.999+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12970332","id":"12970332","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"yes, snapshot.f0000001d has all changes f0000001d and some subset of subsequent changes.\n\nthe snapshots do have perfect snapshots of the session table.\n\ni think what is going on is that you have a follower with the old ephemeral node associated to session X. if the leader doesn't believe that X is a valid session, it will never get expired and the follower will forever think that X is active. the thing i don't get is if you create the znode again on the leader and then delete the znode, it should disappear from all servers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-12-10T23:05:22.540+0000","updated":"2010-12-10T23:05:22.540+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12970706","id":"12970706","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi Ben,\n\nThe leader already issued a closesesion transaction (see below) for the session in question. All servers (including the faulty one) processed this transaction. The messages shown below are from the faulty node. Thats why I think this is realted to datatree / snapshot management. Let me know if you think otherwise. Thanks.\n\n2010-12-09 03:11:50,609 - DEBUG [CommitProcessor:2:FinalRequestProcessor@78] - Processing request:: sessionid:0x22cc91caece0000 type:closeSession cxid:0x0 zxid:0xf0000001a txntype:-11 reqpath:n/a\n2010-12-09 03:11:50,609 - TRACE [CommitProcessor:2:ZooTrace@89] - :Esessionid:0x22cc91caece0000 type:closeSession cxid:0x0 zxid:0xf0000001a txntype:-11 reqpath:n/a\n2010-12-09 03:11:50,609 - DEBUG [CommitProcessor:2:FinalRequestProcessor@103] - VK DEBUG: sessionid:0x22cc91caece0000 type:closeSession cxid:0x0 zxid:0xf0000001a txntype:-11 reqpath:n/a\n2010-12-09 03:11:50,609 - DEBUG [CommitProcessor:2:DataTree@751] - VK DEBUG: header 156721212080128000,0,64424509466,1291864306011,-11\ntxn null zxid=f0000001a\n2010-12-09 03:11:50,610 - DEBUG [CommitProcessor:2:DataTree@1217] - VK DEBUG: Stack trace java.lang.Thread.getStackTrace(Thread.java:1436)org.apache.zookeeper.server.DataTree.logStack(DataTree.java:1212)org.apache.zookeeper.server.DataTree.processTxn(DataTree.java:752)org.apache.zookeeper.server.ZKDatabase.processTxn(ZKDatabase.java:299)org.apache.zookeeper.server.FinalRequestProcessor.processRequest(FinalRequestProcessor.java:104)org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:73)\n2010-12-09 03:11:50,618 - DEBUG [CommitProcessor:2:DataTree@820] - VK DEBUG: in killSession 22cc91caece0000 zxid f0000001a\n2010-12-09 03:11:50,618 - DEBUG [CommitProcessor:2:DataTree@1217] - VK DEBUG: Stack trace java.lang.Thread.getStackTrace(Thread.java:1436)org.apache.zookeeper.server.DataTree.logStack(DataTree.java:1212)org.apache.zookeeper.server.DataTree.killSession(DataTree.java:821)org.apache.zookeeper.server.DataTree.processTxn(DataTree.java:796)org.apache.zookeeper.server.ZKDatabase.processTxn(ZKDatabase.java:299)org.apache.zookeeper.server.FinalRequestProcessor.processRequest(FinalRequestProcessor.java:104)org.apache.zookeeper.server.quorum.CommitProcessor.run(CommitProcessor.java:73)\n2010-12-09 03:11:50,618 - DEBUG [CommitProcessor:2:DataTree@825] - VK DEBUG: Found ephemeral node /fooOnline for session 0x22cc91caece0000\n2010-12-09 03:11:50,619 - DEBUG [CommitProcessor:2:DataTree@839] - Deleting ephemeral node /fooOnline for session 0x22cc91caece0000\n2","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-13T05:34:38.940+0000","updated":"2010-12-13T05:34:38.940+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12971584","id":"12971584","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi Ben,\n\nI think the ZooKeeper server is dropping multiple transactions after\nit rejoins the cluster.  As a result, it drops the transaction that\ndelets the ephemeral znode (and many more transactions).\n\nI have attached the logs. It would good to track the\ncreatesession/deletessesion/create transactions for all sessions in\nsessions.txt file.\n\nLog entries that shows the fact that the server is dropping transaction:\n\n2010-12-14 05:59:19,144 - INFO [Thread-2:FileSnap@82] - Reading snapshot /var/zookeeper/version-2/snapshot.200000016 ===> ***** THIS DOES NOT CONTAIN DT till 200000016 ****\n2010-12-14 05:59:19,147 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 12ce374d71f0001 with timeout: 30000\n2010-12-14 05:59:19,148 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 22ce37526bd0001 with timeout: 30000\n2010-12-14 05:59:19,148 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 12ce374d71f0000 with timeout: 30000\n2010-12-14 05:59:19,148 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 22ce37526bd0002 with timeout: 30000\n2010-12-14 05:59:19,148 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 22ce37526bd0003 with timeout: 30000\n2010-12-14 05:59:19,149 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 22ce3757b780003 with timeout: 30000\n2010-12-14 05:59:19,149 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 22ce3757b780002 with timeout: 30000\n2010-12-14 05:59:19,149 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 22ce3757b780001 with timeout: 30000\n2010-12-14 05:59:19,150 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 22ce3757b780000 with timeout: 9000\n2010-12-14 05:59:19,150 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 2ce374f6b80000 with timeout: 30000\n2010-12-14 05:59:19,150 - TRACE [Thread-2:ZooTrace@70] - loadData --- session in archive: 2ce374f6b80001 with timeout: 30000\n2010-12-14 05:59:19,156 - DEBUG [Thread-2:DataTree@1072] - VK DEBUG: in desrialize\n2010-12-14 05:59:19,156 - DEBUG [Thread-2:DataTree@1096] - VK DEBUG Adding path /Online for 22ce3757b780000\n2010-12-14 05:59:19,157 - DEBUG [Thread-2:DataTree@1226] - VK DEBUG: Stack trace java.lang.Thread.getStackTrace(Thread.java:1436)org.apache.zookeeper.server.DataTree.logStack(DataTree.java:1221)org.apache.zookeeper.server.DataTree.deserialize(DataTree.java:1097)org.apache.zookeeper.server.util.SerializeUtils.deserializeSnapshot(SerializeUtils.java:95)org.apache.zookeeper.server.persistence.FileSnap.deserialize(FileSnap.java:126)org.apache.zookeeper.server.persistence.FileSnap.deserialize(FileSnap.java:86)org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:124)org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:197)org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:397)org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:143)org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:103)com.vmware.sva.zkmgmtserver.ZkQuorumPeer.access$200(ZkQuorumPeer.java:26)com.vmware.sva.zkmgmtserver.ZkQuorumPeer$ZooKeeperInstance.run(ZkQuorumPeer.java:78)\n2010-12-14 05:59:19,157 - DEBUG [Thread-2:DataTree@1230] - Printing DataTree\n2010-12-14 05:59:19,158 - DEBUG [Thread-2:DataTree@1232] - Path=/ Node=org.apache.zookeeper.server.DataNode@3ba42792\n2010-12-14 05:59:19,158 - DEBUG [Thread-2:DataTree@1232] - Path=/Online Node=org.apache.zookeeper.server.DataNode@162200d5\n2010-12-14 05:59:19,158 - DEBUG [Thread-2:DataTree@1232] - Path= Node=org.apache.zookeeper.server.DataNode@3ba42792\n2010-12-14 05:59:19,158 - DEBUG [Thread-2:DataTree@1232] - Path=/zookeeper Node=org.apache.zookeeper.server.DataNode@1264ab4d\n2010-12-14 05:59:19,159 - DEBUG [Thread-2:DataTree@1232] - Path=/zookeeper/quota Node=org.apache.zookeeper.server.DataNode@f2a55aa\n2010-12-14 05:59:19,162 - DEBUG [Thread-2:FileTxnLog$FileTxnIterator@527] - Created new input stream /var/zookeeper/version-2/log.200000011 ==> ****** THIS DOES NOT CONTAIN TX FROM 200000011 - 200000016 *********\n2010-12-14 05:59:19,167 - DEBUG [Thread-2:FileTxnLog$FileTxnIterator@530] - Created new input archive /var/zookeeper/version-2/log.200000011\n2010-12-14 05:59:19,168 - DEBUG [Thread-2:FileTxnSnapLog@178] - VK debug: 156750179351724034,0,8589934614,1292306326006,-11\n\n\nThe problem is that snapshot snapshot.200000016 does not contain all\ntransactions till snapshot.200000016. Log log.200000011 will contain\ntransactions 200000011 - 200000015, but the server will ignore them\nsince it thinks snapshot.200000016 has those transactions. As a\nresult, it will drop those transactions.\n\n\nI think the zxid management during startup is buggy. Possibly one or\nmore of the following issues is causing trouble:\n\n1. Race conditions/ incorrect zxid received from leader at two places\na) newLeaderZxid different from zxid received on qp in Learner.syncWithLeader()\n\nzk.getZKDatabase().setlastProcessedZxid(newLeaderZxid); \n\nThe dataTree.lastProcessedZxid is probably getting set incorrectly\n(higher than the correct zxid).  This is causing transactions from the\ncorrect zxid to lastProcessed to be dropped during log replay in\nFileTxnSnapLog.java. I think this is the main cause.\n\nb) Learner does not wait until it receives the entire snapshot from\nthe leader (see snapshot.200000016)\n\n-Vishal","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-15T09:06:20.029+0000","updated":"2010-12-15T09:06:20.029+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12971656","id":"12971656","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nI am attaching a diff that gets around this bug. I don't think this is a real fix. Hopefully, it will help to identify the final fix.\n\n-Vishal\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-15T12:21:01.905+0000","updated":"2010-12-15T12:21:01.905+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12972535","id":"12972535","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Ok I managed to figure out what is going on here, at least one thing that could be wrong.\nBasically, when a follower starts up, it reads the latest snap file and sets the dataTree.lastProcessedZxid to be the Zxid specified by that file. This is not the right thing to do. When you call snapLog.restore (before you connect to the leader), you both deserialize the latest snap log, AND play through the transaction logs. While playing through the transaction logs, you find the actual last transaction you have recorded which could be less than the snapLog's zxid (will explain below). That zxid is returned by the call to restore, but we don't actually use it, you always use the Zxid from the chose snap file (see FileSnap.deserialize). \n\nSo, follower crashes at zxid N-5, starts back up, replays state to N-5, and connects to the leader. \n\nWhen it connects to the leader, it gets the leader's zxid of N. In Learner.syncWithLeader, it sees that it will get a diff, and sets its lastProcessedZxid to N, then acks the leader and starts up. The leader queues up the transactions N-4...N and sends those to the follower, followed finally by the UPTODATE message.\n\nSo what does the Follower now see? Well it sees the transactions in order, PROPOSAL, then COMMIT, for all of N-4 to N, followed by the UPTODATE. However, the Follower processes the PROPOSAL and COMMIT packets *in separate threads*, so it pulls those messages off the wire fast, queues them to be processed by the Sync/Commit processor threads, and keeps going until it hits the UPTODATE message. At this point, it writes a snapshot with Zxid N. We have NO GUARANTEE that we have actually processed transactions N-4 to N, and as Vishal has seen, sometimes the thread that writes the snapshot gets executed before any or all of the commit processor threads have actually run.\n\nBut generally, this is ok, because you are also writing a transaction log of transactions N-4 to N, so you still process them, write them to your transaction log, and as long as you have processed all of them before your Follower goes down again when you recover they will be applied to the snapshot and you will be fine. HOWEVER, if you kill the Follower after it has written snapshot.N and before it has processed transactions N-4 to N and written them to its log, when you restore the Follower it will believe that it is at Zxid N, it won't ever see those transactions, and it will never delete those nodes.\n\nI believe one solution might be, when you are restoring the database on startup to set the lastProcessedZxid to the zxid of the last transaction in your actual tx log, NOT the zxid of the snapshot file. However, that might make restoring from copied snapshots break, so I think we should consider other solution options. But setting the zxid of the follower to be the server's zxid before it processes all the missing transactions is definitely the wrong thing to do.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-17T16:12:11.577+0000","updated":"2010-12-17T16:12:11.577+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12972547","id":"12972547","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Is ZOOKEEPER-882 related? To me it sounds like...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-12-17T17:18:47.075+0000","updated":"2010-12-17T17:18:47.075+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12972582","id":"12972582","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"I don't think so, correct me if I am wrong:\nStarting the log from the last txn in the snapshot (which is set in this case by the actual file name of the snapshot, not the last transaction it actually contains)  will definitely not fix this problem since the snapshot does not contain the missing transactions. In fact, if you did this, you would end up even worse off since you would expand the window in which the follower could crash and lose those transactions (not only before they are logged, but any time before a snapshot that actually contains a record of the missing transactions is taken).\nIn the patch submitted on 882, we still don't actually use that log file last transaction id anywhere, so that fix is pretty meaningless for the actual functioning of the system so far as I can tell. If we were using it, we probably wouldn't have this problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-17T18:34:58.819+0000","updated":"2010-12-17T18:34:58.819+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12972601","id":"12972601","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"camille, you are brilliant! excellent catch.\n\ni think main problem is zk.getZKDatabase().setlastProcessedZxid(newLeaderZxid) in syncWithLeader(). \n\nwe need to fix that code. we also have the problem that we are adding transactions to the log without having the respective snapshot on disk.\n\ni think we need to process the requests we get between the snapshot and UPTODATE in that method in the same thread. so that we get a consistent snapshot on disk tagged with the right transaction id.\n\nthe tricky part is to build a test case for this :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-12-17T19:11:27.016+0000","updated":"2010-12-17T19:11:27.016+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12972748","id":"12972748","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Were you guys following the comments that I posted earlier? Any comments on the attached patch?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-18T06:20:04.545+0000","updated":"2010-12-18T06:20:04.545+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12972832","id":"12972832","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nJust to clarify, the patch that I had attached earlier (zk.patch) sets the zxid right. I have tested it by repeating my test (mentioned above) 100 times.\nHowever, I am not 100% sure if this is the final patch. I think the patch may not be optimal. It might cause reapplying some extra transactions. It will be nice if someone can look at it.\n\n\nThanks\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-18T17:33:35.502+0000","updated":"2010-12-18T17:33:35.502+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12973233","id":"12973233","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"where is the patch vishal?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-12-20T15:55:05.007+0000","updated":"2010-12-20T15:55:05.007+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12973288","id":"12973288","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi Ben,\n\nSince I wasn't sure, I had submitted the diff (zk.patch)as an attachment (please see my comments on 15/Dec/10 04).  Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-20T18:23:14.148+0000","updated":"2010-12-20T18:23:14.148+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12973317","id":"12973317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Vishal, I think your patch is ok, but given that we know what is likely to cause this issue, can you think of a test to verify the fix?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-20T19:24:29.142+0000","updated":"2010-12-20T19:24:29.142+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12974067","id":"12974067","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"vishal your patch is a start, but i think the issue identified by camille is a bit more profound.\n\ni'm going to work on the test case for this issue and the other that camille identified. in the meantime it would be interesting to see if just doing what you have in the patch makes your problem go away.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-12-22T06:16:04.949+0000","updated":"2010-12-22T06:16:04.949+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12974632","id":"12974632","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"thank you very much, first of all\nI am in the process of testing Vishal's patch\nI will report back the result soon\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-23T14:48:45.611+0000","updated":"2010-12-23T14:48:45.611+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12976668","id":"12976668","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi Camille,\n\nI forgot to mention about this earlier. In your description above you\nmentioned \"But generally, this is ok, because you are also writing a\ntransaction log of transactions N-4 to N, so you still process them,\nwrite them to your transaction log, and as long as you have processed\nall of them before your Follower goes down again when you recover they\nwill be applied to the snapshot and you will be fine. HOWEVER, if you\nkill the Follower after it has written snapshot.N and before it has\nprocessed transactions N-4 to N and written them to its log, when you\nrestore the Follower it will believe that it is at Zxid N, it won't\never see those transactions, and it will never delete those nodes.\"\n\nI don't think this is true. I don't think that we need to kill the\nfollower after creating snapshot.N file and before writing N to the\nlog. We have a bug even without this failure (and my test was not\nfailing the Follower during this window). FileTxnSnapLog.restore()\ndoes not replay transactions that are < zxid of the snapshot. As a\nresult, we have this bug even without the failure that you\nmentioned. Let me know if you think otherwise.\n\nMy change takes a safe approach and ensures that the zxid of the\nsnapshot file at the follower is equal to the zxid of the last\ntransaction processed by the follower.\n\nIdeally, I think we need to change Follower.processPacket() to make\nsure that while handling UPTODATE before taking snapshot all the\nnecessary transactions are committed locally.\n\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-03T09:49:10.202+0000","updated":"2011-01-03T09:49:10.202+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12976669","id":"12976669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Ben,\n\nI think the patch does address my scenario.\nI have tested it by repeating my test (mentioned above) 100 times.\nYou are right, this patch does not address the problem Camille pointed \nout in https://issues.apache.org/jira/browse/ZOOKEEPER-962.\nThese are independent problems.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-03T09:53:32.497+0000","updated":"2011-01-03T09:53:32.497+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12976771","id":"12976771","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Where in the code do you think we are not processing transactions that are < zxid of the snapshot? FileTxnSnapLog.restore() will grab the tran logs with zxid greater than or equal to the zxid of the highest snapshot, and the last file with a zxid less than the zxid of the highest snapshot, and process transactions on those zxids whether or not they are higher than the highestZxid. Specifically, that if/else in restore line 137 does not break out if the hdr.getZxid < highestZxid, it just logs that the occurrence, and process transaction will still run on those lower zxid logs.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-03T15:09:48.898+0000","updated":"2011-01-03T15:09:48.898+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12976783","id":"12976783","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Sorry, the explanation wasn't right. I meant to say that restore() starts from txnLog.read(dt.lastProcessedZxid). So if lastProcessZxid is set higher (as in this bug), then even if the right transactions are in the log they won't get replayed.\nI was seeing this during debugging and I didn't have to crash the follower in that window (after creating snapshot.N file and before writing N to the log).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-03T15:49:30.889+0000","updated":"2011-01-03T15:49:30.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12976807","id":"12976807","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi Chang,\n\nCan you please see which bug you are running into by trying out the patch? Thanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-03T16:41:28.881+0000","updated":"2011-01-03T16:41:28.881+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12977031","id":"12977031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"Vishal\nI have been too busy and couldn't find a chance to try out the patch due to our staging ZK ensemble should be up 100%\nI will possible get a chance this or next week to try out the patch, and I will definitely report back the result. \nthank you very very much \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-04T00:12:05.847+0000","updated":"2011-01-04T00:12:05.847+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12978722","id":"12978722","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Ignore the attached patch. It fixes the znode inconsistency problem, but causes a server to reject connections from clients.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-07T10:30:53.254+0000","updated":"2011-01-07T10:30:53.254+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12978800","id":"12978800","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Can you try the patch submitted for ZOOKEEPER-962? It should fix these issues.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-07T14:53:22.468+0000","updated":"2011-01-07T14:53:22.468+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12984130","id":"12984130","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"body":"We are not able to reproduce this original scenario with the patch.\nWe will update this bug once we have final result.\n\nThank you very much.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tru64ufs","name":"tru64ufs","key":"tru64ufs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chang Song","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-20T10:45:34.287+0000","updated":"2011-01-20T10:45:34.287+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12479098/comment/12987137","id":"12987137","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"fix included in ZOOKEEPER-962","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-01-26T18:16:37.214+0000","updated":"2011-01-26T18:16:37.214+0000"}],"maxResults":31,"total":31,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-919/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05z93:"}}