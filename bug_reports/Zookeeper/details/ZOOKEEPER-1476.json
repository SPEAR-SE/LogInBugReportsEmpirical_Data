{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12558949","self":"https://issues.apache.org/jira/rest/api/2/issue/12558949","key":"ZOOKEEPER-1476","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2012-06-01T13:33:32.039+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jul 03 22:34:33 UTC 2014","customfield_12310420":"242223","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1476/watchers","watchCount":5,"isWatching":false},"created":"2012-06-01T13:01:28.024+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12365497","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12365497","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12635893","key":"ZOOKEEPER-1661","self":"https://issues.apache.org/jira/rest/api/2/issue/12635893","fields":{"summary":"Random (?) 5s delay when establishing connection","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12390894","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12390894","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12725375","key":"ZOOKEEPER-1954","self":"https://issues.apache.org/jira/rest/api/2/issue/12725375","fields":{"summary":"StaticHostProvider loses IPv6 scope ID when resolving server addresses","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/3","description":"This issue is being actively worked on at the moment by the assignee.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/inprogress.png","name":"In Progress","id":"3","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-07-03T22:34:33.902+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"We observed a weird, random issue trying to create zookeeper client connections on osx. Sometimes it would work and sometimes it would fail. Also it is randomly very slow. It turns out both issues have the same cause.\n\nMy hosts file on osx (which is an unmodified default one), lists three entries for localhost:\n\n127.0.0.1\tlocalhost\n::1             localhost \nfe80::1%lo0\tlocalhost\n\nWe saw zookeeper trying to connect to fe80:0:0:0:0:0:0:1%1 sometimes, which is not listed (actually one in four times, it seems to round robin over the addresses). \n\nWhenever that happens, it sometimes works and sometimes fails. In both cases it's very slow. Reason: the reverse lookup for fe80:0:0:0:0:0:0:1%1 can't be resolved using the hosts file and it falls back to actually using the dns. Sometimes it actually works but other times it fails/times out after about 5 seconds. Probably a platform specific settings with dns setup hide this problem on linux. \n\nAs a workaround, we preresolve localhost now: Inet4Address.getByName(\"localhost\"). This always resolves to 127.0.0.1 on my machine and works fast.\n\nThis fixes the issue for us. We're not sure where the fe80:0:0:0:0:0:0:1%1 address comes from though. I don't recall having this issue with other server side software so this might be a mix of platform setup, osx specific defaults, and zookeeper behavior.\n\nI've seen one ticket that relates to ipv6 in zookeeper that might be related: ZOOKEEPER-667. Perhaps the workaround for that ticket introduced this problem? \n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"12770","customfield_12312823":null,"summary":"ipv6 reverse dns related timeouts on OSX connecting to localhost","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jillesvangurp","name":"jillesvangurp","key":"jillesvangurp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jilles van Gurp","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jillesvangurp","name":"jillesvangurp","key":"jillesvangurp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jilles van Gurp","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12558949/comment/13287397","id":"13287397","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"We've experienced this identical problem where reverse name lookup prevents zookeeper leader election from ever completing successfully. In our case this was failing on Linux with IPv4 not IPv6. As it turns out, there is a lot of code in zookeeper server that calls GetHostName which does a reverse dns lookup. I've patched the code in question to use GetHostString instead which does not do a reverse name lookup. Eventually it does perform a lookup but it uses getByName to do a normal dns lookup if necessary (if it's not an IP address already). \n\nI'm happy to upload the patch we use, but I can only vouch for it compiling properly on openjdk7. The function I had to use (GetHostString) was wrongly private in openjdk6 and made public in openjdk7. I don't know whether that function is public or private in Sun or IBM or any other flavor of java.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2012-06-01T13:33:32.039+0000","updated":"2012-06-01T13:33:32.039+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12558949/comment/13287406","id":"13287406","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"I should have mentioned that in our restricted environment we do not have DNS and cannot have DNS. So we only ever use IP Addresses and never hostnames.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2012-06-01T13:53:20.160+0000","updated":"2012-06-01T13:53:20.160+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12558949/comment/13287488","id":"13287488","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"body":"Update... I just compiled our patched version with Sun's java6 and it compiles just fine. It must have been a bug specific to openjdk6. If there's interest in my patch, let me know.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marshall","name":"marshall","key":"marshall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall McMullen","active":true,"timeZone":"America/Denver"},"created":"2012-06-01T15:45:51.194+0000","updated":"2012-06-01T15:45:51.194+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12558949/comment/13291634","id":"13291634","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jillesvangurp","name":"jillesvangurp","key":"jillesvangurp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jilles van Gurp","active":true,"timeZone":"Europe/Berlin"},"body":"Here's a small program that replicates the problem. If I execute it, I get the following output:\n\n/etc/hosts:\n##\n# Host Database\n#\n# localhost is used to configure the loopback interface\n# when the system is booting.  Do not change this entry.\n##\n127.0.0.1\tlocalhost\n255.255.255.255\tbroadcasthost\n::1             localhost \nfe80::1%lo0\tlocalhost\n\nlocalhost resolved in 1ms. to localhost\nlocalhost resolved in 1ms. to localhost\nfe80:0:0:0:0:0:0:1%1 resolved in 5002ms. to fe80:0:0:0:0:0:0:1%1\njava.lang.IllegalStateException: localhost resolves to fe80:0:0:0:0:0:0:1%1 but reverse dns lookup takes too long 5002 resolved back to fe80:0:0:0:0:0:0:1%1\n\tat com.nokia.search.test.LocalhostLookupTest.main(LocalhostLookupTest.java:28)\n\nIf I preresolve localhost to 127.0.0.1, the exception never gets thrown.\n\n\nimport java.io.BufferedReader;\nimport java.io.FileReader;\nimport java.net.InetAddress;\n\npublic class LocalhostLookupTest {\n    public static void main(String[] args) {\n        try {\n            InetAddress[] addresses = InetAddress.getAllByName(\"localhost\");\n            \n            BufferedReader br = null;\n            try {\n                br = new BufferedReader(new FileReader(\"/etc/hosts\"));\n                StringBuilder buf = new StringBuilder();\n                String line;\n                while((line = br.readLine()) != null) {\n                    buf.append(line + '\\n');\n                }\n                String hostsFile = buf.toString();\n                System.out.println(\"/etc/hosts:\\n\"+hostsFile);\n                for (InetAddress inetAddress : addresses) {\n                    long now = System.currentTimeMillis();\n                    String hostName = inetAddress.getCanonicalHostName();\n                    long duration = System.currentTimeMillis() - now;\n                    System.out.println(hostName + \" resolved in \" + duration + \"ms. to \" + hostName);\n                    if(duration > 50) {\n                        throw new IllegalStateException(\"localhost resolves to \" + inetAddress.getHostAddress() + \" but reverse dns lookup takes too long \" + duration + \" resolved back to \" + hostName);\n                    }\n                }\n            } finally {\n                br.close();\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n        } finally {\n            System.exit(0);\n        }\n    }\n}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jillesvangurp","name":"jillesvangurp","key":"jillesvangurp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jilles van Gurp","active":true,"timeZone":"Europe/Berlin"},"created":"2012-06-08T08:52:04.948+0000","updated":"2012-06-08T08:52:04.948+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12558949/comment/13291636","id":"13291636","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jillesvangurp","name":"jillesvangurp","key":"jillesvangurp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jilles van Gurp","active":true,"timeZone":"Europe/Berlin"},"body":"To be clear, the problematic zookeeper class is org.apache.zookeeper.client.StaticHostProvider, which does a InetAddress resolvedAddresses[] = InetAddress.getAllByName(address.getHostName()); \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jillesvangurp","name":"jillesvangurp","key":"jillesvangurp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jilles van Gurp","active":true,"timeZone":"Europe/Berlin"},"created":"2012-06-08T08:55:49.616+0000","updated":"2012-06-08T08:55:49.616+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12558949/comment/14051982","id":"14051982","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"hi [~jillesvangurp], it is better if you upload repro code as attachments to the jira rather than posting as a comment, just a hint. given that you spotted the culprit, I was wondering if you want to propose a patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2014-07-03T22:34:33.902+0000","updated":"2014-07-03T22:34:33.902+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1476/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i02jk7:"}}