{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12503307","self":"https://issues.apache.org/jira/rest/api/2/issue/12503307","key":"ZOOKEEPER-1043","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2011-04-04T17:17:02.163+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Aug 28 20:03:45 UTC 2015","customfield_12310420":"2449","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1043/watchers","watchCount":8,"isWatching":false},"created":"2011-04-04T15:34:27.637+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315482","id":"12315482","description":"Fix release against 3.3 branch","name":"3.3.3","archived":false,"released":true,"releaseDate":"2011-02-27"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-08-28T20:03:45.172+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"I'm sorry but I only have this log (which belongs to a \"follower\" node) and a previous message [Unexpected NodeCreated event after a reconnection.|http://mail-archives.apache.org/mod_mbox/zookeeper-user/201103.mbox/%3CAANLkTi=vmZ5v4W6FMhWg4XO6rJT89eGozGUE840bku0_@mail.gmail.com%3E] where I describe a potential side-effect at client side.\n\n{noformat}\n2011-04-04 09:31:09,608 - INFO  [Snapshot Thread:FileTxnSnapLog@208][] - Snapshotting: 1700527e36\n2011-04-04 09:31:09,653 - INFO  [SyncThread:1:FileTxnLog@197][] - Creating new log file: log.1700527e38\n2011-04-04 10:13:39,287 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@251][] - Accepted socket connection from /XXX.XXX.XXX.69:1093\n2011-04-04 10:13:39,371 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn@777][] - Client attempting to establish new session at /XXX.XXX.XXX.69:1093\n2011-04-04 10:13:39,376 - INFO  [CommitProcessor:1:NIOServerCnxn@1580][] - Established session 0x12ee79c4a720022 with negotiated timeout 20000 for client /XXX.XXX.XXX.69:1093\n2011-04-04 12:04:11,131 - INFO  [SyncThread:1:FileTxnLog@197][] - Creating new log file: log.170053bf15\n2011-04-04 12:04:11,131 - INFO  [Snapshot Thread:FileTxnSnapLog@208][] - Snapshotting: 170053bf17\n2011-04-04 12:13:10,779 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@251][] - Accepted socket connection from /XXX.XXX.XXX.63:1817\n2011-04-04 12:13:10,790 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn@777][] - Client attempting to establish new session at /XXX.XXX.XXX.63:1817\n2011-04-04 12:13:10,794 - INFO  [CommitProcessor:1:NIOServerCnxn@1580][] - Established session 0x12ee79c4a720023 with negotiated timeout 20000 for client /XXX.XXX.XXX.63:1817\n2011-04-04 12:13:10,814 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn@634][] - EndOfStreamException: Unable to read additional data from client sessionid 0x12ee79c4a720023, likely client has closed socket\n2011-04-04 12:13:10,816 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn@1435][] - Closed socket connection for client /XXX.XXX.XXX.63:1817 which had sessionid 0x12ee79c4a720023\n2011-04-04 12:13:10,839 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@251][] - Accepted socket connection from /XXX.XXX.XXX.63:1814\n2011-04-04 12:13:10,840 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@274][] - Ignoring exception\njava.net.SocketException: Invalid argument\n        at sun.nio.ch.Net.setIntOption0(Native Method)\n        at sun.nio.ch.Net.setIntOption(Unknown Source)\n        at sun.nio.ch.SocketChannelImpl$1.setInt(Unknown Source)\n        at sun.nio.ch.SocketOptsImpl.setBoolean(Unknown Source)\n        at sun.nio.ch.SocketOptsImpl$IP$TCP.noDelay(Unknown Source)\n        at sun.nio.ch.OptionAdaptor.setTcpNoDelay(Unknown Source)\n        at sun.nio.ch.SocketAdaptor.setTcpNoDelay(Unknown Source)\n        at org.apache.zookeeper.server.NIOServerCnxn.<init>(NIOServerCnxn.java:1367)\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.createConnection(NIOServerCnxn.java:215)\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:256)\n2011-04-04 12:13:10,841 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)\n2011-04-04 12:13:10,841 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)\n2011-04-04 12:13:10,842 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)\n...\n...\n...\n2011-04-04 16:49:23,101 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)\n{noformat}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12725680","id":"12725680","filename":"looped-npe-redacted-stack-dump.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cconroy","name":"cconroy","key":"cconroy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Conroy","active":true,"timeZone":"America/New_York"},"created":"2015-04-15T20:40:31.417+0000","size":6889,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12725680/looped-npe-redacted-stack-dump.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12670442","id":"12670442","filename":"ZOOKEEPER_1043-logfile.new","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-22T17:12:12.636+0000","size":152975,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12670442/ZOOKEEPER_1043-logfile.new"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12515214","id":"12515214","filename":"ZOOKEEPER-1043.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sammychen","name":"sammychen","key":"sammychen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J Ch","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-20T05:11:58.249+0000","size":3271,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12515214/ZOOKEEPER-1043.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32758","customfield_12312823":null,"summary":"Looped NPE at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=calvarez","name":"calvarez","key":"calvarez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"César Álvarez Núñez","active":true,"timeZone":"Europe/London"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=calvarez","name":"calvarez","key":"calvarez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"César Álvarez Núñez","active":true,"timeZone":"Europe/London"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Sparc Solaris 10 and 11\nJava 6u17 64 bits\n5 nodes ensemble","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/13015506","id":"13015506","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Cesar,\n  I see the logs have nullpointer exceptions, I did read through your link that you specified but I am still unclear on what happened. Can you please provide a detailed view of what happened on the client/server (or the logs). You mentioned that you get a node created event even though you are just using getchildren and getdata? Can you please make sure you are not using exists in your code? \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-04T17:17:02.163+0000","updated":"2011-04-04T17:17:02.163+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/13015550","id":"13015550","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=calvarez","name":"calvarez","key":"calvarez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"César Álvarez Núñez","active":true,"timeZone":"Europe/London"},"body":"Hi Mahadev,\n\nI apologize for my poor description. I will try to do it better this time.\n\nThe bug has two parts: Server-side and Client-side.\n\nFew days ago (Mon, Mar 14, 2011) one of our production \"Zookeeper server\" was restarted because it was consuming too much CPU and flooding log files with millions of lines like the following.\n\n{noformat}\n2011-04-04 12:13:10,841 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)\n{noformat}\n\nUnfortunately I was not able to recover the log content previous to the NPE.\nBut it responds fine to an \"ruok\" and \"stat\".\n\nA few hours later, the content of one ZNode was modified resulting on the behavior described in the email.\nI've reviewed the code that makes use of the affected ZNodes and I'm sure that it does not invoke any \"exists\" method.\n\nToday the \"Zookeeper server\" on the same physical server than before start again to flooding log files.\nFortunately this time I have recovered the log entries (which are included on bug description) previous to the NPE loop.\nThe \"Zookeeper server\" was shutdown at 16:19+- and restarted at 16:23:50\n\nFrom the \"zookeeper client\" side:\n\n- Only one client shows a reconnection following by unexpected NodeCreated.\n\n{noformat}\n2011-04-04 16:19:58,307 I [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:Disconnected type:None path:null)\n2011-04-04 16:19:58,864 I [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:None path:null)\n2011-04-04 16:19:58,870 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/AP/subscriptionLegalConditions)\n2011-04-04 16:19:58,871 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/Certification/fileTemp)\n2011-04-04 16:19:58,871 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/Pdf/urlFont)\n2011-04-04 16:19:58,872 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/ActiveX/classid)\n2011-04-04 16:19:58,872 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/Signature/timeOut)\n2011-04-04 16:19:58,873 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/Locale/locales)\n2011-04-04 16:19:58,873 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/pc/locales)\n2011-04-04 16:19:58,874 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/Deh/aceptarNotComLegalConditions)\n2011-04-04 16:19:58,874 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/pc/pathImagenIssuingEntity)\n2011-04-04 16:19:58,875 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/pc/context)\n2011-04-04 16:19:58,875 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/ActiveX/xadesActivex)\n2011-04-04 16:19:58,876 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/pc/maxMostReadedFaqs)\n2011-04-04 16:19:58,876 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/Deh/createUserLegalConditions)\n2011-04-04 16:19:58,877 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/pc/hostAlternative)\n2011-04-04 16:19:58,877 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/Deh/modificationUserLegalConditions)\n2011-04-04 16:19:58,878 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/Pdf/imageLogo)\n2011-04-04 16:19:58,879 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/Pdf/font)\n2011-04-04 16:19:58,879 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/pc/host)\n2011-04-04 16:19:58,880 D [main-EventThread] e.z.ReadOnlyConfiguration@bc794cc - process(WatchedEvent state:SyncConnected type:NodeCreated path:/path/Configuration/Avisos/fechaFin)\n{noformat}\n\n- The above log belongs to a client which was restarted at 13:06.\n- The \"/path/Configuration/Avisos/fechaFin\" has as ctime \"10-nov-2010 18:00:53\" and as mtime \"11-mar-2011 14:07:14\"\n- I've modified one ZNode which should have triggered a NodeDataChanged on the tree \"zookeeper client\" instances; but no one has received any WatchedEvent.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=calvarez","name":"calvarez","key":"calvarez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"César Álvarez Núñez","active":true,"timeZone":"Europe/London"},"created":"2011-04-04T19:00:52.808+0000","updated":"2011-04-04T19:00:52.808+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/13059501","id":"13059501","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=calvarez","name":"calvarez","key":"calvarez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"César Álvarez Núñez","active":true,"timeZone":"Europe/London"},"body":"Today we have had the same problem and the origin seems to be the followin exception:\n\n{noformat}\n2011-07-04 10:39:55,515 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@251][] - Accepted socket connection from /YYY.YYY.YYY.67:1500\n2011-07-04 10:39:55,581 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@274][] - Ignoring exception\njava.net.SocketException: Invalid argument\n        at sun.nio.ch.Net.setIntOption0(Native Method)\n        at sun.nio.ch.Net.setIntOption(Unknown Source)\n        at sun.nio.ch.SocketChannelImpl$1.setInt(Unknown Source)\n        at sun.nio.ch.SocketOptsImpl.setBoolean(Unknown Source)\n        at sun.nio.ch.SocketOptsImpl$IP$TCP.noDelay(Unknown Source)\n        at sun.nio.ch.OptionAdaptor.setTcpNoDelay(Unknown Source)\n        at sun.nio.ch.SocketAdaptor.setTcpNoDelay(Unknown Source)\n        at org.apache.zookeeper.server.NIOServerCnxn.<init>(NIOServerCnxn.java:1367)\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.createConnection(NIOServerCnxn.java:215)\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:256)\n{noformat}\n\nAs you can see, it seems to exist some correlation between the SocketException and the looped NPE.\n\n{noformat}\n2011-07-04 02:48:07,663 - INFO  [Snapshot Thread:FileTxnSnapLog@208][] - Snapshotting: 1801267fa2\n2011-07-04 02:48:07,674 - INFO  [SyncThread:2:FileTxnLog@197][] - Creating new log file: log.1801267fa4\n2011-07-04 08:30:43,812 - INFO  [Snapshot Thread:FileTxnSnapLog@208][] - Snapshotting: 18012774dd\n2011-07-04 08:30:43,815 - INFO  [SyncThread:2:FileTxnLog@197][] - Creating new log file: log.18012774df\n2011-07-04 09:23:40,586 - INFO  [Snapshot Thread:FileTxnSnapLog@208][] - Snapshotting: 180128bb4d\n2011-07-04 09:23:40,596 - INFO  [SyncThread:2:FileTxnLog@197][] - Creating new log file: log.180128bb4f\n2011-07-04 10:09:23,753 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@251][] - Accepted socket connection from /XXX.XXX.XXX.245:49993\n2011-07-04 10:09:23,754 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn@1237][] - Processing stat command from /XXX.XXX.XXX.245:49993\n2011-07-04 10:09:23,755 - INFO  [Thread-15:NIOServerCnxn$StatCommand@1153][] - Stat command output\n2011-07-04 10:09:23,758 - INFO  [Thread-15:NIOServerCnxn@1435][] - Closed socket connection for client /XXX.XXX.XXX.245:49993 (no session established for client)\n2011-07-04 10:20:03,391 - INFO  [Snapshot Thread:FileTxnSnapLog@208][] - Snapshotting: 180129e6b4\n2011-07-04 10:20:03,397 - INFO  [SyncThread:2:FileTxnLog@197][] - Creating new log file: log.180129e6b6\n2011-07-04 10:24:34,042 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@251][] - Accepted socket connection from /YYY.YYY.YYY.69:1093\n2011-07-04 10:24:34,044 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn@1237][] - Processing stat command from /YYY.YYY.YYY.69:1093\n2011-07-04 10:24:34,045 - INFO  [Thread-16:NIOServerCnxn$StatCommand@1153][] - Stat command output\n2011-07-04 10:24:34,048 - INFO  [Thread-16:NIOServerCnxn@1435][] - Closed socket connection for client /YYY.YYY.YYY.69:1093 (no session established for client)\n2011-07-04 10:39:55,515 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@251][] - Accepted socket connection from /YYY.YYY.YYY.67:1500\n2011-07-04 10:39:55,581 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@274][] - Ignoring exception\njava.net.SocketException: Invalid argument\n        at sun.nio.ch.Net.setIntOption0(Native Method)\n        at sun.nio.ch.Net.setIntOption(Unknown Source)\n        at sun.nio.ch.SocketChannelImpl$1.setInt(Unknown Source)\n        at sun.nio.ch.SocketOptsImpl.setBoolean(Unknown Source)\n        at sun.nio.ch.SocketOptsImpl$IP$TCP.noDelay(Unknown Source)\n        at sun.nio.ch.OptionAdaptor.setTcpNoDelay(Unknown Source)\n        at sun.nio.ch.SocketAdaptor.setTcpNoDelay(Unknown Source)\n        at org.apache.zookeeper.server.NIOServerCnxn.<init>(NIOServerCnxn.java:1367)\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.createConnection(NIOServerCnxn.java:215)\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:256)\n2011-07-04 10:39:55,601 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:262)\n2011-07-04 10:39:55,602 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:262)\n2011-07-04 10:39:55,602 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)\n2011-07-04 10:39:55,603 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)\n2011-07-04 10:39:55,603 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)\n2011-07-04 10:39:55,604 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)\n2011-07-04 10:39:55,604 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:244)\n2011-07-04 10:39:55,605 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:262)\n2011-07-04 10:39:55,605 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2301:NIOServerCnxn$Factory@272][] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n...\n{noformat}\n\nAny help,\n/César.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=calvarez","name":"calvarez","key":"calvarez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"César Álvarez Núñez","active":true,"timeZone":"Europe/London"},"created":"2011-07-04T16:16:53.382+0000","updated":"2011-07-04T16:16:53.382+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/13059514","id":"13059514","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=calvarez","name":"calvarez","key":"calvarez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"César Álvarez Núñez","active":true,"timeZone":"Europe/London"},"body":"Helful link: http://java.net/jira/browse/GLASSFISH-5342\n\nReviewing \"org.apache.zookeeper.server.NIOServerCnxn\" source code, the exception is thrown at line 256 which is captured at line 274, starting the while loop.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=calvarez","name":"calvarez","key":"calvarez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"César Álvarez Núñez","active":true,"timeZone":"Europe/London"},"created":"2011-07-04T16:55:27.560+0000","updated":"2011-07-04T16:55:27.560+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/13113317","id":"13113317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi, we have had the similar problem in very high load. Unforunately I couldn't able to re-produce it.\n\n{noformat}\n2011-09-22 04:17:30,396 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:65170:NIOServerCnxn@1585] - Established session 0x1328c8973a9003e with negotiated timeout 20000 for client /10.18.52.253:44857\n2011-09-22 04:17:30,405 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:65170:NIOServerCnxn$Factory@253] - Accepted socket connection from /10.18.52.108:19351\n2011-09-22 04:17:30,412 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:65170:NIOServerCnxn$Factory@274] - Ignoring unexpected runtime exception\njava.nio.channels.CancelledKeyException\n\tat sun.nio.ch.SelectionKeyImpl.ensureValid(SelectionKeyImpl.java:55)\n\tat sun.nio.ch.SelectionKeyImpl.readyOps(SelectionKeyImpl.java:69)\n\tat org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:242)\n2011-09-22 04:17:30,470 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:65170:NIOServerCnxn$Factory@274] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n\tat org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:245)\n2011-09-22 04:17:30,518 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:65170:NIOServerCnxn$Factory@274] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n\tat org.apache.zookeeper.server.NIOServerCnxn$Factory.run(NIOServerCnxn.java:245)\n\n{noformat}\n\n\nMy observation is evenif we have the registered OP_ACCEPT  'ss.register(selector, SelectionKey.OP_ACCEPT);' there is a chance of returning null by the accept() api in very high load. (Also free swap space was very less).\n\n\nThanks,\nRakesh","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-09-23T10:45:38.762+0000","updated":"2011-09-23T10:45:38.762+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/13211655","id":"13211655","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sammychen","name":"sammychen","key":"sammychen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J Ch","active":true,"timeZone":"Etc/UTC"},"body":"you got a java.net.SocketException: Invalid argument when try to set options to a closed socket.\nhttp://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6378870\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sammychen","name":"sammychen","key":"sammychen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J Ch","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-20T03:50:28.326+0000","updated":"2012-02-20T03:50:28.326+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/13211673","id":"13211673","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sammychen","name":"sammychen","key":"sammychen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J Ch","active":true,"timeZone":"Etc/UTC"},"body":"Looped NPE because of a bug in NIOServerCnxn.java::run();\n\nif any exception raised inside the ACCPET event handle block(for example, exception on createConnection(sc, sk);), the event will not be removed from the SelectionKeySet, which resulted looped NPE.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sammychen","name":"sammychen","key":"sammychen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J Ch","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-20T05:11:58.318+0000","updated":"2012-02-20T05:11:58.318+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/13643588","id":"13643588","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=evolvah","name":"evolvah","key":"evolvah","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=evolvah&avatarId=26976","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=evolvah&avatarId=26976","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=evolvah&avatarId=26976","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=evolvah&avatarId=26976"},"displayName":"Sergey Maslyakov","active":true,"timeZone":"America/Chicago"},"body":"I observe very similar symptoms on a *3.4.5* Zookeeper that runs on Solaris10/x86 and JRE 1.6.0_27-b07. Please see the log below. The explanation that I found is same as what \"J Ch\" is talking about. First, Socket.setTcpNodelay() throws an exception that is not properly handled, which results in not attaching a socket to a selector, and then a flood of log messages caused by an NPE.\n\nI would say it is a critical problem as I have not seen Zookeeper to leave this state on its own.\n\n{code:none|title=Sample log}\n2013-04-24 03:07:04,480 [myid:] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:12181:NIOServerCnxnFactory@197] - Accepted socket connection from /10.64.133.196:54055\n2013-04-24 03:07:04,481 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:12181:NIOServerCnxnFactory@220] - Ignoring exception\njava.net.SocketException: Invalid argument\n        at sun.nio.ch.Net.setIntOption0(Native Method)\n        at sun.nio.ch.Net.setIntOption(Net.java:157)\n        at sun.nio.ch.SocketChannelImpl$1.setInt(SocketChannelImpl.java:406)\n        at sun.nio.ch.SocketOptsImpl.setBoolean(SocketOptsImpl.java:38)\n        at sun.nio.ch.SocketOptsImpl$IP$TCP.noDelay(SocketOptsImpl.java:284)\n        at sun.nio.ch.OptionAdaptor.setTcpNoDelay(OptionAdaptor.java:48)\n        at sun.nio.ch.SocketAdaptor.setTcpNoDelay(SocketAdaptor.java:268)\n        at org.apache.zookeeper.server.NIOServerCnxn.<init>(NIOServerCnxn.java:107)\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.createConnection(NIOServerCnxnFactory.java:161)\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:202)\n        at java.lang.Thread.run(Thread.java:619)\n2013-04-24 03:07:04,482 [myid:] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:12181:NIOServerCnxnFactory@218] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:190)\n        at java.lang.Thread.run(Thread.java:619) \n{code}\n\nThe fix seems to be pretty simple, however, it is very difficult to reproduce the problem for testing purposes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=evolvah","name":"evolvah","key":"evolvah","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=evolvah&avatarId=26976","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=evolvah&avatarId=26976","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=evolvah&avatarId=26976","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=evolvah&avatarId=26976"},"displayName":"Sergey Maslyakov","active":true,"timeZone":"America/Chicago"},"created":"2013-04-27T07:44:39.402+0000","updated":"2013-04-27T07:44:39.402+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14141523","id":"14141523","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"body":"We are seeing this same issue on Solaris 5.11 using zookeeper 3.4.6.  This happened on a VERY lightly loaded server we are using in qa.  This is our first zookeeper deployment.\n\n014-09-15 15:44:14,111 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:4181:NIOServerCnxnFactory@197] - Accepted socket connection from /172.20.0.91:54606\n2014-09-15 15:44:14,129 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:4181:NIOServerCnxn@827] - Processing ruok command from /172.20.0.91:54606\n2014-09-15 15:44:14,138 [myid:1] - INFO  [Thread-2:NIOServerCnxn@1007] - Closed socket connection for client /172.20.0.91:54606 (no session established for client)\n2014-09-15 15:44:22,833 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:4181:NIOServerCnxnFactory@197] - Accepted socket connection from /172.20.0.91:54608\n2014-09-15 15:44:22,834 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:4181:NIOServerCnxn@827] - Processing stat command from /172.20.0.91:54608\n...skipping...\n        at sun.nio.ch.SocketAdaptor.setTcpNoDelay(SocketAdaptor.java:330)\n        at org.apache.zookeeper.server.NIOServerCnxn.<init>(NIOServerCnxn.java:105)\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.createConnection(NIOServerCnxnFactory.java:161)\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:202)\n        at java.lang.Thread.run(Thread.java:745)\n2014-09-19 00:00:41,265 [myid:1] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:4181:NIOServerCnxnFactory@218] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:208)\n        at java.lang.Thread.run(Thread.java:745)\n2014-09-19 00:00:41,266 [myid:1] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:4181:NIOServerCnxnFactory@218] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:208)\n        at java.lang.Thread.run(Thread.java:745)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-19T23:16:16.001+0000","updated":"2014-09-19T23:16:16.001+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14141565","id":"14141565","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"body":"*sigh* I attached the wrong log out put to my comment above and cannot for the life of me figure out how to delete/edit it.\n\nHere's the real deal: Solaris 5.11, zookeeper 3.4.6. One node of a 3-node ensemble.\n\n...\n2014-09-19 00:00:41,261 [myid:1] - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:4181:NIOServerCnxnFactory@197] - Accepted socket connection from /172.20.0.91:52454\n2014-09-19 00:00:41,263 [myid:1] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:4181:NIOServerCnxnFactory@220] - Ignoring exception\njava.net.SocketException: Invalid argument\n        at sun.nio.ch.Net.setIntOption0(Native Method)\n        at sun.nio.ch.Net.setSocketOption(Net.java:373)\n        at sun.nio.ch.SocketChannelImpl.setOption(SocketChannelImpl.java:189)\n        at sun.nio.ch.SocketAdaptor.setBooleanOption(SocketAdaptor.java:295)\n        at sun.nio.ch.SocketAdaptor.setTcpNoDelay(SocketAdaptor.java:330)\n        at org.apache.zookeeper.server.NIOServerCnxn.<init>(NIOServerCnxn.java:105)\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.createConnection(NIOServerCnxnFactory.java:161)\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:202)\n        at java.lang.Thread.run(Thread.java:745)\n2014-09-19 00:00:41,265 [myid:1] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:4181:NIOServerCnxnFactory@218] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:208)\n        at java.lang.Thread.run(Thread.java:745)\n2014-09-19 00:00:41,266 [myid:1] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:4181:NIOServerCnxnFactory@218] - Ignoring unexpected runtime exception\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:208)\n        at java.lang.Thread.run(Thread.java:745)\n...\n<forever>\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-19T23:41:47.607+0000","updated":"2014-09-19T23:41:47.607+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14141673","id":"14141673","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~jlindwall].\nWould you mind to attach your log if it's not large or otherwise use pastebin.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-20T01:59:19.643+0000","updated":"2014-09-20T01:59:19.643+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14142572","id":"14142572","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"body":"I will send the log file tomorrow. The log file is quite large, however I imagine you really only want to see the log content from the time the server started up to the point where it experiences the problem, correct?  I'll plan to truncate the log somewhat and provide that information along with some reasonable amount of content from after the error occurs.\n\nThank you.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-21T19:08:10.740+0000","updated":"2014-09-21T19:08:10.740+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14143439","id":"14143439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"body":"Log file showing issue ZOOKEEPER-1043.  Suspectedr oot cause occurs at line 1059.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-22T17:12:12.662+0000","updated":"2014-09-22T17:12:12.662+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14143440","id":"14143440","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"body":"I'll attempt to attach the log file here.  This is the first 1200 lines of the log.  The error occurs on line 1059.\n\nFor security reasons I have search & replaced ip addresses, user names, machine names in the log.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-22T17:12:32.608+0000","updated":"2014-09-22T17:12:32.608+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14143526","id":"14143526","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"body":"I believe that the looped NPE was caused by unremoved selection keys on connection exception.\n\nIt looks like branch-3.4, branch-3.5 have already fixed this with ZOOKEEPER-1504.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-22T17:52:27.480+0000","updated":"2014-09-22T17:52:27.480+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14144031","id":"14144031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"body":"That is interesting news regarding ZOOKEEPER-1504. I see though, that issue 1504 is currently marked as \"Unresolved\".  I am not sure about the timing of the 3.5.0 release; is there a chance this fix could make it into 3.5.0?  Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-22T23:32:49.311+0000","updated":"2014-09-22T23:32:49.311+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14144036","id":"14144036","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"body":"1. ZK-1504 is already been fixed and merged.\n2. 3.5.0-alpha is already released.\n3. I think it's also fixed in 3.4.X. Maybe somewhere later than 3.4.6.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-09-22T23:35:33.854+0000","updated":"2014-09-22T23:35:33.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14304466","id":"14304466","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cconroy","name":"cconroy","key":"cconroy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Conroy","active":true,"timeZone":"America/New_York"},"body":"We are seeing this fairly regularly on 3.4.6. Luckily we haven't seen it in production yet. However, this does appear to be fairly common for our developer environments (osx).\n\nThis bug is still marked unresolved (and unassigned). I don't see any mention of this bug in ZOOKEEPER-1504 and it too is marked unresolved. What is the real current status of this issue? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cconroy","name":"cconroy","key":"cconroy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Conroy","active":true,"timeZone":"America/New_York"},"created":"2015-02-04T01:37:11.375+0000","updated":"2015-02-04T01:37:11.375+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14496902","id":"14496902","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cconroy","name":"cconroy","key":"cconroy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Conroy","active":true,"timeZone":"America/New_York"},"body":"Attaching a stack dump of all the zookeeper threads from a process that hit the looped NPE bug on OSX.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cconroy","name":"cconroy","key":"cconroy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Conroy","active":true,"timeZone":"America/New_York"},"created":"2015-04-15T20:40:31.437+0000","updated":"2015-04-15T20:40:31.437+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503307/comment/14720484","id":"14720484","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cconroy","name":"cconroy","key":"cconroy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Conroy","active":true,"timeZone":"America/New_York"},"body":"FWIW: I've had folks running 3.5.1-alpha in development for a couple of weeks now, and so far I have not received any reports of this issue after the upgrade.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cconroy","name":"cconroy","key":"cconroy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Conroy","active":true,"timeZone":"America/New_York"},"created":"2015-08-28T20:03:45.172+0000","updated":"2015-08-28T20:03:45.172+0000"}],"maxResults":20,"total":20,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1043/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05yxj:"}}