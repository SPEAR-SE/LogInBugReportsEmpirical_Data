{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12445600","self":"https://issues.apache.org/jira/rest/api/2/issue/12445600","key":"ZOOKEEPER-645","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2010-01-15T18:26:41.455+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon May 07 16:22:18 UTC 2018","customfield_12310420":"70799","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-645/watchers","watchCount":13,"isWatching":false},"created":"2010-01-15T05:19:32.474+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314335","id":"12314335","description":"Fix release against 3.2 branch","name":"3.2.2","archived":false,"released":true,"releaseDate":"2009-12-14"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-07T16:27:09.309+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313246","id":"12313246","name":"recipes","description":"recipes implementations that reside in src/recipes. also could be used for recipe docs"}],"timeoriginalestimate":null,"description":"Not sure, but there seem to be two issues in the example WriteLock:\n\n(1) ZNodeName is sorted according to session ID first, and then according to znode sequence number. This might cause starvation as lower session IDs always get priority. WriteLock is not thread-safe in the first place, so having session ID involved in compare operation does not seem to make sense.\n\n(2) if findPrefixInChildren finds previous ID, it should add dir in front of the ID","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12430357","id":"12430357","filename":"645-fix-findPrefixInChildren.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","key":"jaakko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-15T05:22:07.271+0000","size":740,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12430357/645-fix-findPrefixInChildren.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12548196","id":"12548196","filename":"ZOOKEEPER-645.3.patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matt.martin","name":"matt.martin","key":"matt.martin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Martin","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-08T06:17:13.053+0000","size":13894,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12548196/ZOOKEEPER-645.3.patch.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12476744","id":"12476744","filename":"ZOOKEEPER-645-compareTo.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreesteve","name":"andreesteve","key":"andreesteve","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andre Esteve","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T16:16:13.431+0000","size":744,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12476744/ZOOKEEPER-645-compareTo.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32949","customfield_12312823":null,"summary":"Bug in WriteLock recipe implementation?","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","key":"jaakko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","key":"jaakko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"3.2.2 java 1.6.0_12","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/12800549","id":"12800549","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","key":"jaakko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true,"timeZone":"Etc/UTC"},"body":"Attached patch addresses issue 2 above.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jaakko","name":"jaakko","key":"jaakko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaakko Laine","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-15T05:22:07.282+0000","updated":"2010-01-15T05:22:07.282+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/12800817","id":"12800817","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Mahadev can you review this one?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-01-15T18:26:41.455+0000","updated":"2010-01-15T18:26:41.455+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/12800862","id":"12800862","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"sure am doing it right now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-15T19:31:54.236+0000","updated":"2010-01-15T19:31:54.236+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/12800888","id":"12800888","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12430357/645-fix-findPrefixInChildren.patch\n  against trunk revision 899383.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no tests are needed for this patch.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/103/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/103/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h8.grid.sp2.yahoo.net/103/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-15T20:05:53.040+0000","updated":"2010-01-15T20:05:53.040+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/12800891","id":"12800891","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"We should add tests to this to verify the change.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-01-15T20:20:05.086+0000","updated":"2010-01-15T20:20:05.086+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/12805736","id":"12805736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rcrocomb","name":"rcrocomb","key":"rcrocomb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Crocombe","active":true,"timeZone":"Etc/UTC"},"body":"I can address point (1) in the original comment: having the session ID breaks the lock recipe.  It looks like the session ID was added per:\n\nhttps://issues.apache.org/jira/browse/ZOOKEEPER-78?focusedCommentId=12615305&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12615305\n\nbut the sorting via ZNodeName is worse than starvation: it causes clients with low session IDs not to see that clients with higher session IDs have acquired the lock which causes the function to return true: so you could theoretically have as many lock owners as clients as long as they acquire the lock in descending session ID order.\n\nI fixed this in a local branch by replacing ZNodeName with a different class that ignores the session ID when sorting.  My test for WriteLockTest became:\n{noformat}\n/*\n        * Test that the bug which makes it possible to acquire a lock in two\n        * different sessions simultaneously is fixed. Bug occurs because including\n        * session ID in node name results in sorting in\n        * LockZooKeeperOperation.execute() such that low session ID clients do not\n        * see that higher session ID clients already have the lock.\n        */\n       @Test\n       public void testSessionOrderingBugFix() throws Exception {\n               // session IDs are presumably assigned in order, but perform some checks\n               final ZooKeeper zooA = createClient();\n               final ZooKeeper zooB = createClient();\n\n               final ZooKeeper lowZoo = zooA.getSessionId() < zooB.getSessionId() ? zooA\n                               : zooB;\n               final ZooKeeper highZoo = zooA.getSessionId() < zooB.getSessionId() ? zooB\n                               : zooA;\n\n               final WriteLock highLock = new WriteLock(highZoo, dir, null);\n               final WriteLock lowLock = new WriteLock(lowZoo, dir, null);\n\n               boolean highLocked = highLock.lock();\n               assertTrue(highLocked);\n\n               // If the bug is present, this attempt to lock will succeed.\n               boolean lowLocked = lowLock.lock();\n               assertFalse(lowLocked);\n\n               assertTrue(highLock.isOwner());\n               assertFalse(lowLock.isOwner());\n       }\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rcrocomb","name":"rcrocomb","key":"rcrocomb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Crocombe","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-28T01:15:00.509+0000","updated":"2010-01-28T01:15:00.509+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/12843623","id":"12843623","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"not a blocker. moving it to 3.4.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-10T16:52:33.438+0000","updated":"2010-03-10T16:52:33.438+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/12907331","id":"12907331","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timrobertson100","name":"timrobertson100","key":"timrobertson100","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Robertson","active":true,"timeZone":"Etc/UTC"},"body":"I have applied the patch but still see that locks generated by subsequent clients are not respected by the first client and it is always able to get the lock  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timrobertson100","name":"timrobertson100","key":"timrobertson100","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Robertson","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-08T17:35:11.584+0000","updated":"2010-09-08T17:35:11.584+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/13013844","id":"13013844","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oicqemote","name":"oicqemote","key":"oicqemote","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"wxbhlj","active":true,"timeZone":"Etc/UTC"},"body":"around line 245, seems need to set id = null to continue the loop as the watcher not be setup corrently.\n\nStat stat = zookeeper.exists(lastChildId, new LockWatcher());\n                            if (stat != null) {\n                                return Boolean.FALSE;\n                            } else {\n                                LOG.warn(\"Could not find the\" +\n                                \t\t\" stats for less than me: \" + lastChildName.getName());\n                                id = null; //2011.3.31 set id to null to continue the loop                            }","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oicqemote","name":"oicqemote","key":"oicqemote","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"wxbhlj","active":true,"timeZone":"Etc/UTC"},"created":"2011-03-31T06:03:52.156+0000","updated":"2011-03-31T06:03:52.156+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/13021637","id":"13021637","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreesteve","name":"andreesteve","key":"andreesteve","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andre Esteve","active":true,"timeZone":"Etc/UTC"},"body":"compareTo.patch aims to correct ordering of ZNodeName objects used to validate lock ownership.\n\nThe code at WriteLock gets a list of znodes and for each znode creates a ZNodeName object which is added to a sorted list. \nThe sorting was based on the full znode name, i.e. x-sessionID-ephemeral_number. As earlier connected clients appear to have lower sessionID values than those which connected latter, who connects first gets the lock disregarding anyone who has already the lock.\n\nThis patch simply changes compareTo overload at ZNodeName to just consider the sequence number instead of the full znode name, as this class' objects are used only for this purpose, this seems to have done the trick =)\n\nHowever, getSessionID not being thread-safe is still an issue.\n\nCould someone try it out and post the results?\n\n[A discussion about this bug and some other issues on lock recipe, as well as this patch contributors, can be found here (in Portuguese) http://www.lsd.ic.unicamp.br/mc715-1s2011/index.php/Grupo01]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreesteve","name":"andreesteve","key":"andreesteve","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andre Esteve","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-19T16:16:13.455+0000","updated":"2011-04-19T16:16:13.455+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/13038141","id":"13038141","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi, has anyone tried this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-23T19:04:08.965+0000","updated":"2011-05-23T19:04:08.965+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/13041311","id":"13041311","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abramsm51","name":"abramsm51","key":"abramsm51","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Abrams","active":true,"timeZone":"America/New_York"},"body":"I've tried it.  I did see the starvation behavior with the original compareTo method from ZNodeName.  When I applied the compareTo patch the starvation issue went away.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abramsm51","name":"abramsm51","key":"abramsm51","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Abrams","active":true,"timeZone":"America/New_York"},"created":"2011-05-30T22:09:06.478+0000","updated":"2011-05-30T22:09:06.478+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/13471418","id":"13471418","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matt.martin","name":"matt.martin","key":"matt.martin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Martin","active":true,"timeZone":"America/Los_Angeles"},"body":"It seems as though both of the patches uploaded to date address real issues.  I've combined both patches and added a couple small changes:\n\n- session ID is always padded out to the maximum number of digits in a long (this is purely an esthetic change, but I added a test case to make sure that the previous format and the current format could be intermingled).\n\n- using a regex to extract the sequence ID from the znode.  I'm doing this based on the assumption that sequence numbers will always be padded to 10 digits (as stated on the wiki).  This seemed a little more robust than simply looking for the last index of '-' if, for example, somebody exactly creates a znode in the directory where you only expect lock-related paths.  On a related note: is there no way to tell if a znode was created as a sequential node from the Stat object.  I see \"ephemeralOwner\", but no equivalent for checking if the node was created as a sequential node.\n\nAfter writing that last bullet point, I'm realizing that it would probably be best to use \"ephemeralOwner\" instead of explicitly adding the session ID to the path... I'll try to change that in a future patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matt.martin","name":"matt.martin","key":"matt.martin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Martin","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-08T06:17:13.068+0000","updated":"2012-10-08T06:17:13.068+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/14197475","id":"14197475","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rudysysu%40qq.com","name":"rudysysu@qq.com","key":"rudysysu@qq.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rudy","active":true,"timeZone":"Etc/UTC"},"body":"follow this and it seems work.\n\n1、ZNodeName\npublic int compareTo(ZNodeName that) {\n    int s1 = this.sequence;\n    int s2 = that.sequence;\n    if (s1 == -1 && s2 == -1) {\n        return this.name.compareTo(that.name);\n    }\n    return s1 == -1 ? 1 : s2 == -1 ? -1 : s1 - s2;\n}\n\n2、WriteLock\nchange “id = name;” to “id = dir + \"/\" + name;”\n\n3、WriteLock\nif (stat != null) {\n    return Boolean.FALSE;\n} else {\n    LOG.warn(\"Could not find the\" + \" stats for less than me: \" + lastChildName.getName());\n    return execute(); // add this\n}\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rudysysu%40qq.com","name":"rudysysu@qq.com","key":"rudysysu@qq.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"rudy","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-05T04:35:31.456+0000","updated":"2014-11-05T04:35:31.456+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/16254414","id":"16254414","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user phunt commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/413\n  \n    Did you guys see https://issues.apache.org/jira/browse/ZOOKEEPER-645 - it's from long back. Not sure if it's interesting to you @javicacheiro but FYI. If someone is interested to get that one over the line as well please speak up. thx.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-15T23:10:50.473+0000","updated":"2017-11-15T23:10:50.473+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/16363174","id":"16363174","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=khogg","name":"khogg","key":"khogg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34046","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34046","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34046","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34046"},"displayName":"Kathryn Hogg","active":true,"timeZone":"Etc/UTC"},"body":"I'm getting WriteLocks never being granted on 3.4.11 and initially brought it up on the user email list.  I'm working with ZookeeperNetEx on C# but have verified the code behaves the same on Java.\r\n\r\nI've encountered two issues:\r\n # When setting the watch on the predecessor, its possible that the predecessor has been deleted between the time we acquired the children and set the watch.  If this happens, there is no watch and we exit out of the loop.  We should set id to null in this case to ensure the loop doesn't terminate.\r\n # Still need the change to ensure the dir name is prepended to the name returned from getChildren call in findPrefixInChildren.\r\n\r\n#1 change\r\n{code:java}\r\nStat stat = zookeeper.exists(lastChildId, new LockWatcher());\r\nif (stat != null) {\r\n   return Boolean.FALSE;\r\n} else {\r\n    LOG.warn(\"Could not find the\" +\r\n\" stats for less than me: \" + lastChildName.getName());\r\n}\r\n{code}\r\nto\r\n{code:java}\r\nStat stat = zookeeper.exists(lastChildId, new LockWatcher());\r\nif (stat != null) {\r\n    return Boolean.FALSE;\r\n} else {\r\n    LOG.warn(\"Could not find the\" +\r\n\" stats for less than me: \" + lastChildName.getName());\r\n    id = null;\r\n}\r\n{code}\r\n \r\n\r\nI've been running with these changes on 3.4.11 with two processes contending for 3 different locks and so far no hangs like I was seeing consistently without them.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=khogg","name":"khogg","key":"khogg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34046","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34046","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34046","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34046"},"displayName":"Kathryn Hogg","active":true,"timeZone":"Etc/UTC"},"created":"2018-02-13T22:44:13.261+0000","updated":"2018-02-13T22:47:48.645+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12445600/comment/16466098","id":"16466098","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=appodictic","name":"appodictic","key":"appodictic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Edward Capriolo","active":true,"timeZone":"Etc/UTC"},"body":"I am going to suggest removing the code. It seems clear that\r\n # The implementation has bugs\r\n # Willingness to fix them is near 0\r\n # The implementation is not even a good academic example\r\n # If anyone attempts to fix it gets stalled by adding integration testing that is not in place\r\n # There are other mature lock over zk libraries in the wild","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=appodictic","name":"appodictic","key":"appodictic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Edward Capriolo","active":true,"timeZone":"Etc/UTC"},"created":"2018-05-07T16:22:18.208+0000","updated":"2018-05-07T16:27:09.302+0000"}],"maxResults":17,"total":17,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-645/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0603z:"}}