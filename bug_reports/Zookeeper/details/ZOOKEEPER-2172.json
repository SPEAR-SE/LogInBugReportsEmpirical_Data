{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12822558","self":"https://issues.apache.org/jira/rest/api/2/issue/12822558","key":"ZOOKEEPER-2172","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335444","id":"12335444","description":"Beta release against 3.5 branch","name":"3.5.3","archived":false,"released":true,"releaseDate":"2017-04-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-05-16T22:43:40.258+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 07 14:37:08 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_39750920485_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_4027921963","customfield_12312321":null,"resolutiondate":"2016-09-08T21:01:46.061+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2172/watchers","watchCount":14,"isWatching":false},"created":"2015-04-21T04:14:24.152+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"34.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"issuelinks":[{"id":"12510122","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12510122","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13089692","key":"ZOOKEEPER-2855","self":"https://issues.apache.org/jira/rest/api/2/issue/13089692","fields":{"summary":"Rebooting a Joined Node Failed Due The Joined Node Previously Failed to Update Its Configuration Correctly","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12479530","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12479530","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"12997163","key":"ZOOKEEPER-2513","self":"https://issues.apache.org/jira/rest/api/2/issue/12997163","fields":{"summary":"majorChange exceptions during leader sync","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-07T14:37:08.773+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312378","id":"12312378","name":"leaderElection","description":"Leader election algorithm for ZooKeeper"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312379","id":"12312379","name":"quorum","description":"Quorum determination for ZooKeeper"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"The operations are quite simple: start three zk servers one by one, then reconfig the cluster to add the new one as a participant. When I add the  third one, the zk cluster may enter a weird state and cannot recover.\n \n      I found “2015-04-20 12:53:48,236 [myid:1] - INFO  [ProcessThread(sid:1 cport:-1)::PrepRequestProcessor@547] - Incremental reconfig” in node-1 log. So the first node received the reconfig cmd at 12:53:48. Latter, it logged “2015-04-20  12:53:52,230 [myid:1] - ERROR [LearnerHandler-/10.0.0.2:55890:LearnerHandler@580] - Unexpected exception causing shutdown while sock still open” and “2015-04-20 12:53:52,231 [myid:1] - WARN  [LearnerHandler-/10.0.0.2:55890:LearnerHandler@595] - ******* GOODBYE  /10.0.0.2:55890 ********”. From then on, the first node and second node rejected all client connections and the third node didn’t join the cluster as a participant. The whole cluster was done.\n \n     When the problem happened, all three nodes just used the same dynamic config file zoo.cfg.dynamic.10000005d which only contained the first two nodes. But there was another unused dynamic config file in node-1 directory zoo.cfg.dynamic.next  which already contained three nodes.\n \n     When I extended the waiting time between starting the third node and reconfiguring the cluster, the problem didn’t show again. So it should be a race condition problem.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746313","id":"12746313","filename":"history.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-21T10:07:02.576+0000","size":64819,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12746313/history.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12726778","id":"12726778","filename":"node-1.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-21T04:16:19.231+0000","size":175329,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12726778/node-1.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12726779","id":"12726779","filename":"node-2.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-21T04:16:19.237+0000","size":110773,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12726779/node-2.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12726780","id":"12726780","filename":"node-3.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-21T04:16:19.243+0000","size":20101,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12726780/node-3.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12726781","id":"12726781","filename":"zoo.cfg.dynamic.10000005d","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-21T04:16:19.247+0000","size":181,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12726781/zoo.cfg.dynamic.10000005d"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12726782","id":"12726782","filename":"zoo.cfg.dynamic.next","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-21T04:16:19.251+0000","size":181,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12726782/zoo.cfg.dynamic.next"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12736571","id":"12736571","filename":"zoo-1.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-01T14:34:50.233+0000","size":1625062,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12736571/zoo-1.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12736572","id":"12736572","filename":"zoo-2.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-01T14:34:50.241+0000","size":507235,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12736572/zoo-2.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12736729","id":"12736729","filename":"zoo-2-1.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-02T04:48:24.309+0000","size":1681893,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12736729/zoo-2-1.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12736730","id":"12736730","filename":"zoo-2-2.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-02T04:48:24.321+0000","size":445019,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12736730/zoo-2-2.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12740083","id":"12740083","filename":"zoo-2212-1.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-17T10:34:58.809+0000","size":4107098,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12740083/zoo-2212-1.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12740084","id":"12740084","filename":"zoo-2212-2.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-17T10:34:58.827+0000","size":3248193,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12740084/zoo-2212-2.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12740085","id":"12740085","filename":"zoo-2212-3.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-17T10:34:58.844+0000","size":122714,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12740085/zoo-2212-3.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12736731","id":"12736731","filename":"zoo-2-3.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-02T04:48:24.328+0000","size":61607,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12736731/zoo-2-3.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12736573","id":"12736573","filename":"zoo-3.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-01T14:34:50.247+0000","size":58292,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12736573/zoo-3.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12737136","id":"12737136","filename":"zoo-3-1.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-03T09:25:30.199+0000","size":1849645,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12737136/zoo-3-1.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12737137","id":"12737137","filename":"zoo-3-2.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-03T09:25:30.361+0000","size":880313,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12737137/zoo-3-2.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12737138","id":"12737138","filename":"zoo-3-3.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-03T09:25:30.372+0000","size":69558,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12737138/zoo-3-3.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12741219","id":"12741219","filename":"zoo-4-1.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-23T05:38:55.563+0000","size":1452933,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12741219/zoo-4-1.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12741220","id":"12741220","filename":"zoo-4-2.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-23T05:38:55.572+0000","size":450117,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12741220/zoo-4-2.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12741221","id":"12741221","filename":"zoo-4-3.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-23T05:38:55.578+0000","size":61149,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12741221/zoo-4-3.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12735115","id":"12735115","filename":"zookeeper-1.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-25T04:45:11.040+0000","size":1376680,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12735115/zookeeper-1.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746314","id":"12746314","filename":"zookeeper-1.out","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-21T10:07:02.579+0000","size":51717,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12746314/zookeeper-1.out"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12735116","id":"12735116","filename":"zookeeper-2.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-25T04:45:11.050+0000","size":259399,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12735116/zookeeper-2.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746315","id":"12746315","filename":"zookeeper-2.out","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-21T10:07:02.582+0000","size":33860,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12746315/zookeeper-2.out"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12747504","id":"12747504","filename":"ZOOKEEPER-2172.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-28T06:56:35.520+0000","size":680,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12747504/ZOOKEEPER-2172.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12819814","id":"12819814","filename":"ZOOKEEPER-2172-02.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-07-24T06:04:01.815+0000","size":2557,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12819814/ZOOKEEPER-2172-02.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12822094","id":"12822094","filename":"ZOOKEEPER-2172-03.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-08-04T15:23:46.951+0000","size":12024,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12822094/ZOOKEEPER-2172-03.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12823593","id":"12823593","filename":"ZOOKEEPER-2172-04.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-08-13T20:17:51.944+0000","size":12977,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12823593/ZOOKEEPER-2172-04.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12823602","id":"12823602","filename":"ZOOKEEPER-2172-06.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-14T00:38:33.775+0000","size":13890,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12823602/ZOOKEEPER-2172-06.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12823615","id":"12823615","filename":"ZOOKEEPER-2172-07.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-08-14T06:16:48.963+0000","size":13148,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12823615/ZOOKEEPER-2172-07.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12735117","id":"12735117","filename":"zookeeper-3.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-25T04:45:11.057+0000","size":63128,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12735117/zookeeper-3.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746316","id":"12746316","filename":"zookeeper-3.out","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-21T10:07:02.585+0000","size":60142,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12746316/zookeeper-3.out"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12823597","id":"12823597","filename":"ZOOKEPER-2172-05.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-13T22:59:43.991+0000","size":16606,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12823597/ZOOKEPER-2172-05.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Cluster crashes when reconfig a new node as a participant","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Ubuntu 12.04 + java 7","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14504287","id":"14504287","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Error log when this bug happened.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-21T04:16:19.255+0000","updated":"2015-04-21T04:16:19.255+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14546965","id":"14546965","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"body":"[~ziyouw] could you also post the initial configuration files for all the nodes? [~shralex] could you take a look at these log files when you get a chance?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-16T22:43:40.258+0000","updated":"2015-05-16T22:43:40.258+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14546968","id":"14546968","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Michi for the pointer, I'll take a look, but may not have time today.\n\nIn general the .next file is created when a server acks a reconfig request and deleted when it commits the request.\nWe check that a quorum is synced before starting the reconfig but once someone knows about a reconfig proposal and can talk to a quorum of nodes, there is no going back -- if a quorum of the new config isn't available the system will get stuck (just like without reconfig the system will get stuck if there's no quorum). \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-16T22:50:28.390+0000","updated":"2015-05-16T22:50:28.390+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14546972","id":"14546972","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"body":"Would it be possible that this is hitting the case described in http://zookeeper.apache.org/doc/trunk/zookeeperReconfig.html#sc_reconfig_general :\n\nbq. Finally, note that once connected to the leader, a joiner adopts the last committed configuration, in which it is absent (the initial config of the joiner is backed up before being rewritten). If the joiner restarts in this state, it will not be able to boot since it is absent from its configuration file. In order to start it you’ll once again have to specify an initial configuration.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-16T22:56:15.059+0000","updated":"2015-05-16T22:56:15.059+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14546973","id":"14546973","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"quite possible. the question is why weren't 1 and 2 enough to form a quorum. 3 doesn't need to be up if both 1 and 2 are participants in the last committed config.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-16T22:59:21.765+0000","updated":"2015-05-16T22:59:21.765+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14546974","id":"14546974","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"looks like the config here is using the patch of ZOOKEEPER-2031","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-16T23:02:57.212+0000","updated":"2015-05-16T23:02:57.212+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14547023","id":"14547023","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"body":"node1 doesn't seem to receive the vote from itself. it receives votes from node2 and node3:\n\n{noformat}\nnode-1.log:2015-04-20 12:55:03,358 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@698] - Notification: 2 (message format version), 2 (n.leader), 0x100000084 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x1 (n.peerEPoch), LEADING (my state)10000005d (n.config version)\nnode-1.log:2015-04-20 12:55:51,547 [myid:1] - INFO  [WorkerReceiver[myid=1]:FastLeaderElection@698] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x1 (n.peerEPoch), LEADING (my state)10000005d (n.config version)\n{noformat}\n\nnode2 receives votes from node1 and itself:\n\n{noformat}\nnode-2.log:2015-04-20 12:55:03,361 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@698] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0xffffffffffffffff (n.round), LEADING (n.state), 1 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)10000005d (n.config version)\nnode-2.log:2015-04-20 12:55:54,564 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@698] - Notification: 2 (message format version), 2 (n.leader), 0x100000084 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)10000005d (n.config version)\n{noformat}\n\nIs node3's vote somehow confusing node1?\n\nYes, I think this cluster is using the patch from ZOOKEEPER-2031. Do you think that might be related to this issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-17T02:32:22.341+0000","updated":"2015-05-17T02:32:22.341+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14547490","id":"14547490","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Server 1 continues to be leading till the end of the execution. It is able to push its version to server 3 but for some reason its leader election messages have round 0xffffffffffffffff so I think this is why servers 2 and 3 don't adopt it as leader. It also doesnt timeout for some reason.\n\n[~fpj], this looks related to ZOOKEEPER-1732 and ZOOKEEPER-1805, any thoughts ?\n\nUnlike what the description says, the .next file provided here is identical to the other config file and contains a config with servers 1 and 2, so it probably resulted from the reconfiguration adding server 2. Which server is this coming from ? server 2 probably ? That may happen if server 1 committed the reconfig but server 2 hasn't learned the commit yet (but its other config file has to be different in this case). \n\nIt would be helpful if you can reproduce the scenario without using the ZK-2031 patch and provide all the config files, including the initial ones, from the servers and all the reconfig commands you run and when.\n\nI can see from the logs that there were many attempts to reconfigure (probably add server 2) before it was synced with server 1 so they failed, which is normal. Then a reconfig succeeds at time 12:51:48, then more reconfig commands are invoked (like minute 12:51:56), which is before server 3 even starts. Is this intentional ? What do these commands attempt to do ? \n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-18T03:15:16.641+0000","updated":"2015-05-18T03:15:16.641+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14549742","id":"14549742","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"body":"[~ziyouw] would it be possible to reproduce it without zk-2031? If not, could you try reproducing this with debug log enabled? Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-19T03:58:45.323+0000","updated":"2015-05-19T03:58:45.323+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14555672","id":"14555672","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Hi Alexander and Michi,\n\nThanks a lot for looking at this bug. The zk-2031 is developed as a part of our system. So I cannot remove this patch away to reproduce this problem. I will try to reproduce this problem with debug log enabled.\n\nBTW. we hit this problems many time after reporting this issue. If we move to a slower environment, e.g. a nested host, it need more time between start and reconfig to avoid it. So I suspect it may be caused when the node 3 doesn't finish sync latest data from leader, the reconfig comes and breaks some thing. Do you have some idea about this?\n\nFor Alexander's quesitons, our system had a bug in such case when reporting this jira. It just retried to do the reconfig to add node2 even the node 2 is already in the list. I already fixed it, but we still hit this jira problem again now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-22T06:33:53.259+0000","updated":"2015-05-22T06:33:53.259+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14557965","id":"14557965","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"I open the zookeeper debug log and reproduce the problem again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-25T04:45:11.064+0000","updated":"2015-05-25T04:45:11.064+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14557967","id":"14557967","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"No, it is just a bug in previous system. It just will try to reconfig the second node even it already join the cluster. So it also just use \"reconfig -add\" to add the second node to the participant list. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-25T04:47:18.299+0000","updated":"2015-05-25T04:47:18.299+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14557968","id":"14557968","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"No, it is just a bug in previous system. It just will try to reconfig the second node even it already join the cluster. So it also just use \"reconfig -add\" to add the second node to the participant list. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-25T04:47:21.250+0000","updated":"2015-05-25T04:47:21.250+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14557969","id":"14557969","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Hi [~michim] and [~alemayo],\n\nI opened the debug log for zookeeper and reproduce this problem. Could you help to check the problem again? Thanks a lot.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-25T04:50:06.239+0000","updated":"2015-05-25T04:50:06.239+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14558059","id":"14558059","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Ziyou.\n\n[~fpj] [~shralex] it looks like node1 and node2 are not forming a quorum because node2 has seen zxid 0x100000059 but node1 keeps sending 0x0 as its zxid. Isn't node1 supposed send the highest zxid it has seen?\n\nFrom zookeeper-1.log:\n\n{noformat}\n2015-05-25 12:34:36,920 [myid:1] - DEBUG [WorkerReceiver[myid=1]:FastLeaderElection$Messenger$WorkerReceiver@423] - Sending new notification. My id =1 recipient=2 zxid=0x0 leader=1 config version = 100000049\n2015-05-25 12:34:39,090 [myid:1] - DEBUG [WorkerReceiver[myid=1]:FastLeaderElection$Messenger$WorkerReceiver@423] - Sending new notification. My id =1 recipient=3 zxid=0x0 leader=1 config version = 100000049\n2015-05-25 12:35:28,128 [myid:1] - DEBUG [WorkerReceiver[myid=1]:FastLeaderElection$Messenger$WorkerReceiver@423] - Sending new notification. My id =1 recipient=2 zxid=0x0 leader=1 config version = 100000049\n2015-05-25 12:35:30,301 [myid:1] - DEBUG [WorkerReceiver[myid=1]:FastLeaderElection$Messenger$WorkerReceiver@423] - Sending new notification. My id =1 recipient=3 zxid=0x0 leader=1 config version = 100000049\n{noformat}\n\nFrom zookeeper-2.log:\n\n{noformat}\n2015-05-25 12:34:36,918 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@698] - Notification: 2 (message format version), 2 (n.leader), 0x100000059 (n.zxid), 0x1 (n.round), LOOKING (n.state), 2 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)100000049 (n.config version)\n2015-05-25 12:34:36,923 [myid:2] - INFO  [WorkerReceiver[myid=2]:FastLeaderElection@698] - Notification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0xffffffffffffffff (n.round), LEADING (n.state), 1 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)100000049 (n.config version)\n2015-05-25 12:35:28,124 [myid:2] - DEBUG [QuorumPeer[myid=2]/10.0.0.2:1300:FastLeaderElection@688] - Sending Notification: 2 (n.leader), 0x100000059 (n.zxid), 0x1 (n.round), 1 (recipient), 2 (myid), 0x1 (n.peerEpoch)\n2015-05-25 12:35:28,125 [myid:2] - DEBUG [QuorumPeer[myid=2]/10.0.0.2:1300:FastLeaderElection@688] - Sending Notification: 2 (n.leader), 0x100000059 (n.zxid), 0x1 (n.round), 2 (recipient), 2 (myid), 0x1 (n.peerEpoch)\n{noformat}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-25T09:20:30.646+0000","updated":"2015-05-25T09:20:30.646+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14558594","id":"14558594","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Michi, I agree that its weird, and again I see this 0xffffffffffffffff round number which I think causes the other server to ignore the leader's messages and continue looking even though server 1 is leading (without timing out for some reason).  This looks related to ZOOKEEPER-1732 and ZOOKEEPER-1805. [~fpj] could you take a look ?\n\nIt also seems like there are a lot of client sessions being established and destroyed (clients connect and disconnect).\nAnd in particular when the reconfig adding server 3 happens (12:33:21,797 on server 1) the client session 0x14d8b08424a0014 (this is the client that submitted the reconfig) gets closed in the middle of the operation. Then, the connection to server 2 is suddenly closed with the error (on server 2)\n\n2015-05-25 12:33:25,786 [myid:2] - WARN  [QuorumPeer[myid=2]/10.0.0.2:1300:Follower@92] - Exception when following the leader java.net.SocketTimeoutException: Read timed out\n\nCould it be that the termination of a client session in the middle of an op messes up server-to-server connections ?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-26T00:18:08.454+0000","updated":"2015-05-26T00:18:08.454+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14558632","id":"14558632","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"The reason why there are many clients connect and disconnect is we use zk cli to do the operations. So the cli just create a client, do the operation and shutdown it.\n\nFrom our tests, I think it should be a race condition problem and may not have relationship with the cli. When the cluster is running in a faster environment, we just need to wait a small interval between starting the node3 and reconfiguring it to join cluster, then we almost can avoid this problem. But when we move to a slower environment, it can be reproduced consistently again. So the temp solution is extending the waiting time and we can avoid it again.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-26T02:50:04.224+0000","updated":"2015-05-26T02:50:04.224+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14558641","id":"14558641","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"when you run in the slower environment does server 2 still disconnect like in the logs when you add server 3 ? \n\nCan you please provide your initial configs for all 3 servers ? and the reconfig commands you run ? I'd like to try to reproduce this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-26T03:04:04.010+0000","updated":"2015-05-26T03:04:04.010+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14558698","id":"14558698","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Yes, it has the same problem.\n\nThe step is:\n1. Start server 1, its zoo.cfg contains:\nstandaloneEnabled=false\nsyncLimit=2\ntickTime=2000\ninitLimit=5\n\nant its dynamic config file just contains itself.\n\n2. Start server 2, its zoo.cfg is the same and its init dynamic config file contains 1 and itself. Then reconfig itself as a participant after it sync data from 1 (need to try a few time until the reconfig can be finished).\n\n3. Start server 3, use the same zoo.cfg and its init dynamic config file contains 1, 2 and itself. Then reconfig itself as the third participant (where we hit the bug).\n\nSince it is a race condition, it may be not easy to be reproduced in your environment. In my dev, the zk server is running in a docker-in-VM \nenvironment. If I change the script to just wait 5 secs after starting the server 3, the problem can be reproduced every time. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-26T05:18:02.064+0000","updated":"2015-05-26T05:18:02.064+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14558709","id":"14558709","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks. The basic scenario you described works for me, but you're right of course - there may be a race condition.\n\nIt would be great if you could help investigate this further. For example, why does server 2 disconnect when you add server 3 ? BTW, server 3 doesn't even have to be up in order for you to add it to the ensemble since you have 2 out of 3 servers without it. \n\nI also wonder if the problem has anything to do with the client shutting off right after -- does it happen if you don't close the connection on the client ? \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-26T05:45:34.205+0000","updated":"2015-05-26T05:45:34.205+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14558958","id":"14558958","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"BTW, all the reconfigs are sent to server1 to finish.\n\nI can check the problem, but I am not familiar with the state machine in zookeeper. And you are right, we can config server 3 even before it starts. But we need to deploy a cluster automatically, it is weird to config server 2 after it starts and config server 3 before it starts.\n\nAs I mentioned, we just use CLI to do the reconfig. So I need to change the cli to test this. I think the client should already get the result from the server before it shutdown.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-26T10:29:55.616+0000","updated":"2015-05-26T10:29:55.616+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14559062","id":"14559062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"I was just suggesting this to see if we can minimize the scenario causing the race condition. For example what happens when you don't start server 3 at all. I also really doubt that the problem is at the client. ZK should work whether or not the client disconnects in the middle of an operation. I'm just trying to think how we could track down the bug.\n\nI'd try to understand whether the client's shut down is somehow not handled well in the server.\nCould you see if the problem is still there when you a) not shutting down the client after reconfig ? if the problem goes away can you try b) have a write after the reconfig and shut it down the client only after the write completes ?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-26T12:42:09.029+0000","updated":"2015-05-26T12:42:09.029+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14559143","id":"14559143","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"OK, I see. I will try this.\n\nFor debug purpose, do you want to add more log to related code? You can point out the places and I can add them. Right now, even with debug log, I still don't see much important log in the bug moment.\n\nFor the server 2 disconnect problem, since all the servers are running in one os (different containers), they use exactly the same system clock. The server 2 got a read timeout first and the server 1 shutdown the connection latter. So I think the server 1's state machine may enter some error state first.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-26T14:12:35.055+0000","updated":"2015-05-26T14:12:35.055+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14560424","id":"14560424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm not sure where to add the debug messages yet, but happy to point you to the relevant places once we determine where they are. Is it possible that servers 2 and 3 are using the same resources somehow ? Ports, data directory or something else ? this may explain why one joining messes up the connection to the other.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-27T05:18:20.263+0000","updated":"2015-05-27T05:18:20.263+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14564347","id":"14564347","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"No, they are in totally independent docker containers (then isolate ip, port, file system), so they don't share any resources directly.\n\nI changed the client issue, but the problem is still there. I also tried the same reconfig steps in a faster environment (outside of docker container). It cannot be reproduced any more. So the slow environment just extends the bug window and makes it can be reproduced consistently. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-29T07:35:42.904+0000","updated":"2015-05-29T07:35:42.904+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14565874","id":"14565874","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"can you post the logs from the run you mention where the client doesn't disconnect ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-30T07:29:16.374+0000","updated":"2015-05-30T07:29:16.374+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14566031","id":"14566031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"There are a few really weird things here. Check these notifications:\n\n{noformat}\nNotification: 2 (message format version), -9223372036854775808 (n.leader), 0x0 (n.zxid), 0x1 (n.round), LOOKING (n.state), 3 (n.sid), 0x0 (n.peerEPoch), LEADING (my state)100000049 (n.config version)\n{noformat}\n\nI checked the logs of 3 and does sound like it sent this notification. \n\n{noformat}\nSending Notification: -9223372036854775808 (n.leader), 0x0 (n.zxid), 0x1 (n.round), 1 (recipient), 3 (myid), 0x0 (n.peerEpoch)\n{noformat}\n\nThe initialization of leader election here doesn't sound right.  And, as [~shralex] has pointed out, 2 and 3 apparently received notifications with 0xffffffffffffffff as the round of the sender.\n\n{noformat}\nNotification: 2 (message format version), 1 (n.leader), 0x0 (n.zxid), 0xffffffffffffffff (n.round), LEADING (n.state), 1 (n.sid), 0x1 (n.peerEPoch), LOOKING (my state)100000049 (n.config version)\n{noformat} \n\nI found no evidence in the log of 1 that it has actually set or sent such a value. \n\nThe values I'm seeing in the notification across logs look a bit strange.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2015-05-30T14:58:58.747+0000","updated":"2015-05-30T14:58:58.747+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14566340","id":"14566340","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm guessing node1 is hitting this case?\n\nhttps://github.com/apache/zookeeper/blob/76bb6747c8250f28157636cf4011b78e7569727a/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java#L332\n\nIn this case we don't log the message that gets sent out.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michim","name":"michim","key":"michim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michi Mutsuzaki","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-05-31T04:35:18.226+0000","updated":"2015-05-31T04:35:18.226+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14567362","id":"14567362","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"In this test, the ReconfigCommand class is changed to stay after finishing the reconfig request. The client connection for reconfiguring node 2 stays about extra 5 secs there. But the client connection for reconfiguring node 3 still fails immediately.  So it means client connection is broken by something in server side.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-01T14:34:50.252+0000","updated":"2015-06-01T14:34:50.252+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14568511","id":"14568511","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Hi [~shralex],\n\nI tried this and upload the logs. Seems the bug itself will break the client connection. In the client side, after it issues the request, I just get an exception: KeeperErrorCode = ConnectionLoss. So even we don't close the session, the server does.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-02T04:42:04.991+0000","updated":"2015-06-02T04:42:04.991+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14568514","id":"14568514","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"When the bug is triggered, the client connection which is used to issue the reconfig request also will be broken. The client will get a ConnectionLoss error as the reconfig result.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-02T04:48:24.336+0000","updated":"2015-06-02T04:48:24.336+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14569805","id":"14569805","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"That's expected right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-02T21:39:37.769+0000","updated":"2015-06-02T21:39:37.769+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14569823","id":"14569823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"Slightly related: ZOOKEEPER-2202.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-02T21:45:23.634+0000","updated":"2015-06-02T21:45:23.634+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14570213","id":"14570213","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"[~shralex]thought the bug may be caused when the client connection is closed. But the result shows that the server will close the connection before the client. In correct case, the connection should be kept until the client receives the new config status.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-03T03:26:54.689+0000","updated":"2015-06-03T03:26:54.689+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14570229","id":"14570229","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"In zoo-2-3.log you can see server 3 processing requests till the end of the run. The other servers seem ok too, the only thing is the connection being closed right after the reconfig, but this is expected -  the leader election algorithm is being reset. Server 2 should still be connected to server 1 through the leader port and can continue processing requests. So the last logs seem quite ok. \n\nCan we conclude that the bug happens when the client disconnects before getting a response ?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-03T03:52:25.704+0000","updated":"2015-06-03T03:52:25.704+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14570531","id":"14570531","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"The bug shows again with the same code change in last change.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-03T09:25:30.380+0000","updated":"2015-06-03T09:25:30.380+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14570539","id":"14570539","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"The bug just was not triggered in that run. Please check the new log. I use the same code to try again and hit the bug this time. I really doubt that it is caused by client connections, because it is hard to explain why we cannot hit this bug with the same client after waiting some time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-03T09:38:03.713+0000","updated":"2015-06-03T09:38:03.713+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14571772","id":"14571772","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"body":"[~ziyouw]: it might be helpful to dump the FLE (FastLeaderElection) and ZAB messages when the bug is triggered. You could do this with zktraffic (https://github.com/twitter/zktraffic), i.e.:\n\n{code}\n$ sudo pip install zktraffic\n$ sudo fle-dump --iface=eth0\n# from another terminal\n$ sudo zab-dump --iface=eth0\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rgs","name":"rgs","key":"rgs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rgs&avatarId=18469","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rgs&avatarId=18469","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rgs&avatarId=18469","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rgs&avatarId=18469"},"displayName":"Raul Gutierrez Segales","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-03T22:41:06.655+0000","updated":"2015-06-03T22:41:06.655+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14571946","id":"14571946","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"body":"[~ziyouw]\nFYI this patch for zktraffic might be useful: https://github.com/twitter/zktraffic/pull/30 (Deeper dissection of Quorum packets and Reconfig packets)\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-06-04T01:23:59.830+0000","updated":"2015-06-04T01:23:59.830+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14572133","id":"14572133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Server 1:\n\n2015-06-03 17:15:27,692 [myid:1] - DEBUG [ProcessThread(sid:1 cport:-1)::QuorumCnxManager@365] - Opening channel to server 3\n2015-06-03 17:15:27,710 [myid:1] - DEBUG [ProcessThread(sid:1 cport:-1)::QuorumCnxManager@371] - Connected to server 3\n...\n2015-06-03 17:15:31,649 [myid:1] - ERROR [LearnerHandler-/10.0.0.2:50710:LearnerHandler@580] - Unexpected exception causing shutdown while sock still open\njava.net.SocketTimeoutException: Read timed out\n\tat java.net.SocketInputStream.socketRead0(Native Method)\n\tat java.net.SocketInputStream.read(Unknown Source)\n\tat java.net.SocketInputStream.read(Unknown Source)\n\tat java.io.BufferedInputStream.fill(Unknown Source)\n\tat java.io.BufferedInputStream.read(Unknown Source)\n\tat java.io.DataInputStream.readInt(Unknown Source)\n\tat org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)\n\tat org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83)\n\tat org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:103)\n\tat org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:493)\n2015-06-03 17:15:31,650 [myid:1] - WARN  [LearnerHandler-/10.0.0.2:50710:LearnerHandler@595] - ******* GOODBYE /10.0.0.2:50710 ********\nServer 3:\n\n2015-06-03 17:15:27,702 [myid:3] - INFO  [/10.0.0.3:1200:QuorumCnxManager$Listener@556] - Received connection request /10.0.0.1:39184\n2015-06-03 17:15:31,718 [myid:3] - WARN  [/10.0.0.3:1200:QuorumCnxManager@268] - Exception reading or writing challenge: java.net.SocketTimeoutException: Read timed out\n\nIt seems that server 3 is still in the initial connection phase while server 1 already passed it and wants to start working (fails on the qp = new QuorumPacket() line).\n\nIt may be helpful to log everything server 3 gets from server 1 before it crashes in QuorumCnxnManager receiveConnection, exactly what execution path is taken, etc.  You could also print server 1's side in LearnerHandler.java\n\nAlso, are you sure that the zookeeper distribution on these two servers is the same ?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-04T04:45:31.927+0000","updated":"2015-06-04T04:45:31.927+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14572134","id":"14572134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"btw, sorry for being slow to respond","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-04T04:46:46.803+0000","updated":"2015-06-04T04:46:46.803+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14572346","id":"14572346","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"I might have misread the log - the exception on server 1 may be due to a problem talking with server 2. Would be good to log the server id to which the learnerhandler belongs.\n\nAnother suggestion is to log more things in Follower.java - case Leader.PROPOSAL and Leader.COMMIT.\nIts possible that something happens there that causes the follower to hang and the leader's socket to timeout.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-04T08:13:50.110+0000","updated":"2015-06-04T08:13:50.110+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14572383","id":"14572383","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Yes, I also suspect this is caused when server 3 is still syncing data from server 1 or server 2. So it explains why this bug is easier to be triggered in slow environment and can be avoided by waiting.\n\nSo you mean I need to add extra log in QuorumCnxnManager and LearnerHandler for this case?\n\nYes, the three servers use the same docker image.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-04T08:46:02.381+0000","updated":"2015-06-04T08:46:02.381+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14572425","id":"14572425","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Hi, [~rgs]and [~suda]\n\nThanks a lot for this info. I can try this when I try to reproduce it next time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-04T09:17:14.104+0000","updated":"2015-06-04T09:17:14.104+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14572900","id":"14572900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Yeah, just add a lot of logging statements if you could, in QuorumCnxnManager, LearnerHandler  and Follower.java where proposals and COMMITS are received. I'd actually start from the latter to see if server 2 somehow gets stuck in the middle of processing a reconfig command.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-04T14:44:50.305+0000","updated":"2015-06-04T14:44:50.305+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14587117","id":"14587117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~ziyouw], could you please check if the bug still exists with 2212 patch applied ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-15T23:14:02.879+0000","updated":"2015-06-15T23:14:02.879+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14588049","id":"14588049","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Hi [~shralex], thanks for notifying this. I try the 2212 patch today and find it indeed reduce the chance to reproduce the problem. From the log, I can see this logic:\n\nif (!rqv.equals(curQV)) {\n    LOG.info(\"restarting leader election\");\n    self.shuttingDownLE = true;\n    self.getElectionAlg().shutdown();\n    break;\n}\n\nwill be executed in node 2 once and node 3 twice in success case.\n\nBut I still can hit the problem (although it is hard than before). In the fail case, I find the above logic only is executed once in the node 3.\n\nSorry for updating this jira late, I am busy for some urgent issues before.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-16T13:48:20.123+0000","updated":"2015-06-16T13:48:20.123+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14589603","id":"14589603","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Log files after applying patch 2212. The bug is hard to be reproduced after applying 2212.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-17T10:34:58.849+0000","updated":"2015-06-17T10:34:58.849+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14591101","id":"14591101","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"body":"ZOOKEEPER-2212 seems not directly related to this bug.\n\nIf ZK hits a race condition that is resolved in ZOOKEEPER-2212, {{LOG.debug(\"Skip processReconfig(), state: {}\", self.getServerState());}} must be found in log files.\nhttps://github.com/apache/zookeeper/blob/ec056d3c3a18b862d0cd83296b7d4319652b0b1c/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java#L308\n\nPerhaps the bug got hard due to other causes (e.g., network latency gets shorter)?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-06-18T01:45:49.946+0000","updated":"2015-06-18T01:45:49.946+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14591102","id":"14591102","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"body":"ZOOKEEPER-2212 seems not directly related to this bug.\n\nIf ZK hits a race condition that is resolved in ZOOKEEPER-2212, {{LOG.debug(\"Skip processReconfig(), state: {}\", self.getServerState());}} must be found in log files.\nhttps://github.com/apache/zookeeper/blob/ec056d3c3a18b862d0cd83296b7d4319652b0b1c/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java#L308\n\nPerhaps the bug got hard due to other causes (e.g., network latency gets shorter)?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-06-18T01:45:53.551+0000","updated":"2015-06-18T01:45:53.551+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14591132","id":"14591132","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Just check the patch again. Yes, we should not hit 2212 here. But it is really weird to find the affection in our case. I just use three docker containers to run the nodes in the same host. So I don't think the network latency will change, but I am not sure the disk latency changes or not.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-18T02:20:33.291+0000","updated":"2015-06-18T02:20:33.291+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14593156","id":"14593156","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"body":"Hi,\n\nIt is so interesting that both of servers 1 and 2 timeout at 15:55:08,439 after reconfig has begun at 15:55:04.\nAfter these timeouts, both {{ZooKeeperServer}} cannot be revived and the ensemble gets weird.\n(However in zoo-3-2.log (Jun 3), server 2 raises {{EOFException}}, not {{SocketTimeoutException}} at 17:15:31).\n\nThese timeouts are raised by [this while loop|https://github.com/apache/zookeeper/blob/77e46cad03d64530ea53be53f5e38e8f1e7e8eee/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java#L515] in server 1 and [this while loop|https://github.com/apache/zookeeper/blob/77e46cad03d64530ea53be53f5e38e8f1e7e8eee/src/java/main/org/apache/zookeeper/server/quorum/Follower.java#L89] in server 2.\n\nUnfortunately, we are not sure which types of QuorumPacket are triggering these timeouts.\nSo I think it might be helpful to add {{LOG.debug(qp.getType())}} at [this switch|https://github.com/apache/zookeeper/blob/77e46cad03d64530ea53be53f5e38e8f1e7e8eee/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java#L532] for server 1 and [this switch|https://github.com/apache/zookeeper/blob/77e46cad03d64530ea53be53f5e38e8f1e7e8eee/src/java/main/org/apache/zookeeper/server/quorum/Follower.java#L114] for server 2.\n\nPerhaps they are not pinging each other?\n[This|https://github.com/apache/zookeeper/blob/77e46cad03d64530ea53be53f5e38e8f1e7e8eee/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java#L924-925] comment in {{LearnerHandler.ping()}} seems interesting.\n{panel}\n// If learner hasn't sync properly yet, don't send ping packet\n// otherwise, the learner will crash\n{panel}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-06-19T07:56:29.143+0000","updated":"2015-06-19T07:56:29.143+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14597197","id":"14597197","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Add log to record quorum packet types.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-23T05:38:55.583+0000","updated":"2015-06-23T05:38:55.583+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14597203","id":"14597203","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for looking on this. I always suspect this problem may has relationship with the sync. Because I need to wait more time to avoid it when the cluster is running with a slow disk.\n\nI upload the log files after I add the log to record the quorum packet type.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-23T05:44:18.413+0000","updated":"2015-06-23T05:44:18.413+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14597439","id":"14597439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"body":"Hi,[~ziyouw]\n\nThank you for logging.\n\nFrom the latest logs, we can confirm that:\n * server 1 is not [pinging(packet type=5) to server 2|https://github.com/apache/zookeeper/blob/09ce56a867002f34bda9257ae8edca4085852169/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L599] after reconfig at 13:30:33,573, and hence server 2 cannot [pong|https://github.com/apache/zookeeper/blob/09ce56a867002f34bda9257ae8edca4085852169/src/java/main/org/apache/zookeeper/server/quorum/Follower.java#L116] to server 1. then server 1 timeouts for pong from server 2 and shutdowns([this|https://github.com/apache/zookeeper/blob/09ce56a867002f34bda9257ae8edca4085852169/src/java/main/org/apache/zookeeper/server/quorum/LearnerHandler.java#L619-622] at 13:30:37,560 and [this|https://github.com/apache/zookeeper/blob/09ce56a867002f34bda9257ae8edca4085852169/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L603] at 13:30:53,638).\n * server 1 is not [proposing(packet type=2) to server 2|https://github.com/apache/zookeeper/blob/09ce56a867002f34bda9257ae8edca4085852169/src/java/main/org/apache/zookeeper/server/quorum/Leader.java#L1066]. {{CommitProcessor}} is working at 13:30:33,575, but {{ProposalRequestProcessor}} seems not.\n\nMaybe {{Leader.lead()}} and {{Leader.propose()}} are racing due to some reasons related to syncing?\nI will check this later.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-06-23T10:12:30.247+0000","updated":"2015-06-23T10:12:30.247+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14598909","id":"14598909","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Can we add more logs to find the race condition here? I guess the problem will happens when server 3 still is syncing data from leader. So if you can slow down this sync process and do the reconfig before it finishes, we may also can reproduce this process in normal environment. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-06-24T05:56:23.239+0000","updated":"2015-06-24T05:56:23.239+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14602661","id":"14602661","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"body":"Yes, as many logs as possible might be helpful.\nPlus some additional information such as the accurate ZK version, workload scripts, or filesystem information might be also helpful.\n\nI am trying to reproduce the bug by injecting some {{Thread.sleep()}}s into syncing-related functions using byteman.\nBut I could not reproduced the bug at this moment, as I am not sure which function should be injected.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=suda","name":"suda","key":"suda","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Akihiro Suda","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-06-26T10:20:01.351+0000","updated":"2015-06-26T10:20:01.351+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14634903","id":"14634903","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"body":"Hi [~ziyouw],\n\nIt seems that I could reproduce this problem. Just adding new servers with reconfig one by one, then the ensemble rejects every client request.\n(Of course there is a possibility of my misunderstanding)\n\nI used our distributed systems debugger named [earthquake|https://github.com/osrg/earthquake]. It uses byteman and inspect execution of debuggee (zookeeper server in this case). It tries to cause corner case situations that is hard to be produced in ordinal testing by reordering inspected method calls and returns.\n\nWe are preparing a docker image for easy reproducing in your environment. Please wait for a while.\n\nI'm analyzing the problem and would like to post the root cause and patch, but it may take a time because I'm new to zookeeper. So I attached logs (zookeeper-123.out) and the history of ensemble (history.txt). The logs seem to be similar to yours.\nThe format of the history is earthquake specific format, so it wouldn't be easy to read. But I think you can interpret the event sequence roughly (it is just a sequence of method calls and returns + their stacktrace). It would be great if I can hear your comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-21T10:12:23.834+0000","updated":"2015-07-21T10:12:23.834+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14636159","id":"14636159","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"It looks like server 2 is crashing before the first reconfig is invoked (18:14:48 is when the reconfig happens).\n\nThis is what happens on server 2:\n\nINFO: paramMap: {quorumPacket=PING 200000001 null}\nquorum packet send in Follower : org.jboss.byteman.rule.exception.ExecuteException: MethodExpression.interpret : exception invoking method packetToString file /earthquake/reconfig-trunk/materials/server.btm line 34\n2015-07-21 18:14:43,735 [myid:2] - ERROR [SyncThread:2:ZooKeeperCriticalThread@48] - Severe unrecoverable error, from thread : SyncThread:2\norg.jboss.byteman.rule.exception.ExecuteException: MethodExpression.interpret : exception invoking method packetToString file /earthquake/reconfig-trunk/materials/server.btm line 34\n\tat org.jboss.byteman.rule.expression.MethodExpression.interpret(MethodExpression.java:347)\n\tat org.jboss.byteman.rule.expression.MethodExpression.interpret(MethodExpression.java:334)\n\tat org.jboss.byteman.rule.Action.interpret(Action.java:144)\n\tat net.osrg.earthquake.PBEQHelper_HelperAdapter_Interpreted_2.fire(server.btm)\n\tat net.osrg.earthquake.PBEQHelper_HelperAdapter_Interpreted_2.execute0(server.btm)\n\tat net.osrg.earthquake.PBEQHelper_HelperAdapter_Interpreted_2.execute(server.btm)\n\tat org.jboss.byteman.rule.Rule.execute(Rule.java:684)\n\tat org.jboss.byteman.rule.Rule.execute(Rule.java:653)\n\tat org.apache.zookeeper.server.quorum.Learner.writePacket(Learner.java)\n\tat org.apache.zookeeper.server.quorum.SendAckRequestProcessor.flush(SendAckRequestProcessor.java:62)\n\tat org.apache.zookeeper.server.SyncRequestProcessor.flush(SyncRequestProcessor.java:186)\n\tat org.apache.zookeeper.server.SyncRequestProcessor.run(SyncRequestProcessor.java:113)\nCaused by: java.lang.NullPointerException\n\tat org.apache.zookeeper.server.quorum.LearnerHandler.packetToString(LearnerHandler.java:261)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:606)\n\tat org.jboss.byteman.rule.expression.MethodExpression.interpret(MethodExpression.java:341)\n\t... 11 more\n2015-07-21 18:14:43,735 [myid:2] - INFO  [SyncThread:2:ZooKeeperServer$ZooKeeperServerListenerImpl@442] - Thread SyncThread:2 exits, error code 1\n2015-07-21 18:14:43,735 [myid:2] - INFO  [SyncThread:2:LearnerZooKeeperServer@165] - Shutting down\n2015-07-21 18:14:43,735 [myid:2] - INFO  [SyncThread:2:ZooKeeperServer@465] - shutting down\n2015-07-21 18:14:43,735 [myid:2] - INFO  [SyncThread:2:FollowerRequestProcessor@138] - Shutting down\n2015-07-21 18:14:43,735 [myid:2] - INFO  [SyncThread:2:CommitProcessor@358] - Shutting down\n2015-07-21 18:14:43,736 [myid:2] - INFO  [FollowerRequestProcessor:2:FollowerRequestProcessor@109] - FollowerRequestProcessor exited loop!\n\n\nthen server 1, the leader, is sending an incremental reconfig and timing out and closing the connection.\n\n2015-07-21 18:14:48,750 [myid:1] - INFO  [ProcessThread(sid:1 cport:-1)::PrepRequestProcessor@512] - Incremental reconfig\nJul 21, 2015 6:14:48 PM net.osrg.earthquake.PBInspector EventFuncReturn\nINFO: paramMap: {quorumPacket=PROPOSAL 200000002 null}\n.....\n2015-07-21 18:15:02,739 [myid:1] - WARN  [QuorumPeer[myid=1](plain=/0:0:0:0:0:0:0:0:2181)(secure=disabled):LearnerHandler@937] - Closing connection to peer due to transaction timeout.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-22T03:36:51.355+0000","updated":"2015-07-22T03:36:51.355+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14636214","id":"14636214","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"I may be wrong, but it looks like the crash on server 2 happens after the sync, when the server tries to respond to the leader's PING. It executes the following:\n\n   protected void processPacket(QuorumPacket qp) throws Exception{\n        switch (qp.getType()) {\n        case Leader.PING:            \n            ping(qp);            \n\nSo just tries to send a PING back. The ping() function in Learner.java sends the same packet back, just changes the data, it doesn't create a new packet. I wonder if its a problem somehow that a new packet is not being created. The exception message is NullPointerException, so maybe somehow the old packet gets deallocated ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-22T04:44:31.321+0000","updated":"2015-07-22T04:44:31.321+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14636344","id":"14636344","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"body":"Hi [~shralex], thanks for your reply.\n\nAs you pointed, the crash is caused in the inspection layer (written in byteman). Sorry for bothering.\n\nBut the NullPointerException is a little bit odd. The exception is caused by the byteman script like this:\nRULE quorum packet receive in Follower\nCLASS Learner\nMETHOD readPacket\nHELPER net.osrg.earthquake.PBEQHelper\nBIND argMap = new java.util.HashMap()\nAT EXIT\nIF $# == 1\nDO\nargMap.put(\"quorumPacket\", org.apache.zookeeper.server.quorum.LearnerHandler.packetToString($1));\neventFuncReturn(\"Learner.readPacket\", argMap);\nENDRULE\n\nIIUC, the quorumpacket will never be null in follower. I'll look at the problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-22T05:54:15.466+0000","updated":"2015-07-22T05:54:15.466+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14642401","id":"14642401","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for watching on this. For this JIRA, I think the problem will happen if we do reconfig before the new node can sync all data from leader. So cloud we use earthquake to simulate this race condition? Currently, this problem only can be hit in VM environment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-07-27T07:42:36.090+0000","updated":"2015-07-27T07:42:36.090+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14642415","id":"14642415","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"body":"Hi [~ziyouw],\n\nCould you check my understanding is correct? IIUC, your situation is like below:\n1. server 1 boot\n2. server 2 boot\n3. client issues reconfig to server 1\n4. server 2 tries to sync with server 1 with Learner.syncWithLeader()\n5. server 3 boot\n6. client issues reconfig to server 1\n\n(reconfig requests in 3 and 6 are overwrapping)\n\nIs this correct, I'll be able to reproduce the situation with earthquake.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-27T08:09:04.696+0000","updated":"2015-07-27T08:09:04.696+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14642435","id":"14642435","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"body":"[~ziyouw] BTW, if it is possible, could you share your dockerfile for your testing?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-27T08:30:16.865+0000","updated":"2015-07-27T08:30:16.865+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14642436","id":"14642436","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"body":"[~ziyouw] BTW, if it is possible, could you share your dockerfile for your testing?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-27T08:30:21.341+0000","updated":"2015-07-27T08:30:21.341+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14642437","id":"14642437","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"body":"[~ziyouw] BTW, if it is possible, could you share your dockerfile for your testing?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-27T08:30:23.721+0000","updated":"2015-07-27T08:30:23.721+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14642439","id":"14642439","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"body":"Sorry for bothering with duplicated replies...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-27T08:31:44.746+0000","updated":"2015-07-27T08:31:44.746+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14643947","id":"14643947","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"body":"Hi [~ziyouw],\n\nI found a little bit strange code path like below:\n1. In the tail of Leader.shutdown(), leader tries to remove all learner handlers with synchronized (learners). The loop calls LearnerHandler.shutdown().\n2. In LearnerHandler.shutdown(), learder.removeLearnerHandler() is called.\n3. In Leader.removeLearnerHandler(), the member of Leader, learners, is also locked by synchronized\n\nSeems that the above sequence can cause deadlock.\n\nI removed synchronized(learners) in removeLearnerHandler in the attached patch. Could you test it on your environment?\n# the targetting version is 3.5.0\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-28T06:56:35.524+0000","updated":"2015-07-28T06:56:35.524+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14643952","id":"14643952","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"body":"Sorry, the synchronized is reentrant, the patch would be wrong... please ignore it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-28T06:58:02.969+0000","updated":"2015-07-28T06:58:02.969+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14643954","id":"14643954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"body":"But the attached logs (with DEBUG level) don't contain messages of QuorumPeer.updateServerState(). Perhaps shutdown process of leader is stopping QuorumPeer main thread?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitake","name":"mitake","key":"mitake","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hitoshi Mitake","active":true,"timeZone":"Asia/Tokyo"},"created":"2015-07-28T07:04:05.587+0000","updated":"2015-07-28T07:04:05.587+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14651669","id":"14651669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Sorry, I had some problems to receive mails from the registered mail address in last week.\n\nThe situation is quite simple: start one zk server, and reconfig in server 1 to add the new server in the cluster, then start and reconfig the next server. But 4 should be finished before 3, because when we increase the node number from 1 to 2, zk must make sure the cluster still in majority after reconfig. When we add the second server into the cluster, then the server 3 is started and reconfigured to be part of the cluster.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-08-03T09:43:44.440+0000","updated":"2015-08-03T09:43:44.440+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/14651679","id":"14651679","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"body":"Sorry, it is commercial code and I don't have the right to share it. But the environment is quite simple, I just run each zk server in one docker container and all the containers are running in the same VM. I think the key problem of this environment is the disk latency should be longer than  normal cases. And this problem will become even serious if all of them are running with a slow disk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ziyouw","name":"ziyouw","key":"ziyouw","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ziyou Wang","active":true,"timeZone":"Etc/UTC"},"created":"2015-08-03T09:50:40.099+0000","updated":"2015-08-03T09:50:40.099+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15390949","id":"15390949","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"We also faced this issue.\nThe problem occurs when reconfig's PROPOSAL and COMMITANDACTIVATE come in between the snapshot and the uptodate\nFollowing steps can followed to reproduce this issue very easily:\n# start three server zookeeper cluster, lets say servers are server-1, server-2, server-3\n# create big data in zookeeper, around 150 MB\n# install the fourth server server-4, add server information of all the four servers in server-4\n{code}\nserver.1=192.168.1.3:2888:3888:participant\nserver.2=192.168.1.3:2889:3889:participant\nserver.3=192.168.1.3:2890:3890:participant\nserver.4=192.168.1.2:2890:3890:participant\n{code}\n# connect to any of the existing servers\n# start server-4, immediately run reconfig command from already connected client.\n{{reconfig -add server.4=192.168.1.2:2890:3890:participant;2181}}\n# open zookeeper/conf folder, you will find zoo.cfg.dynamic.next and existing quorum dynamic configuration file zoo.cfg.dynamic.100000000\nzoo.cfg.dynamic.next --> this has information of all the servers\nzoo.cfg.dynamic.100000000 --> this has information of only existing servers server-1,server-2,server-3\n# Even though server-4 started and joined the quorum, if try to to restart, it will fail with following errors\n{code}\n2016-07-24 11:00:11,689 [myid:4] - ERROR [main:QuorumPeerMain@98] - Unexpected exception, exiting abnormally\njava.lang.RuntimeException: My id 4 not in the peer list\n\t\tat org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:748)\n\t\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:183)\n\t\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:120)\n\t\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:79)\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-07-24T05:39:58.881+0000","updated":"2016-07-24T05:39:58.881+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15390956","id":"15390956","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"The issue occurs when reconfig's PROPOSAL and COMMITANDACTIVATE come in between the snapshot and the uptodate, while syncing with the leader.\nIn the existing code the reconfig commit is not processed as it should be processed for follower. In case of observer the reconfig's commit is processed properly.\nWe can process the reconfig's commit for follower in the same way as it is being processed for observer to fix this issue.\nSubmitting the fix","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-07-24T06:04:01.819+0000","updated":"2016-07-24T06:04:01.819+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15390957","id":"15390957","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Could you please provide the logs ?\n\nThe existence of .next file indicates that there was a failure in the middle of reconfig, and the commitandactivate\nmessage didn't arrive to the server on which you find this file. Which server was it ? just 4 or all of them ?\nThe zoo.cfg.dynamic.100000000 file is the old configuration.\n\nDid the other servers continue to operate normally ? did they reboot ? were they able to serve requests afterwards ? would be helpful if you describe this too.\n\n7) is actually expected if server 4 crashed before it got the commitandactivate message. I described this in the manual:\n\n\"Finally, note that once connected to the leader, a joiner adopts the last committed configuration, in which it is absent (the initial config of the joiner is backed up before being rewritten). If the joiner restarts in this state, it will not be able to boot since it is absent from its configuration file. In order to start it you’ll once again have to specify an initial configuration.\"","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-07-24T06:11:32.921+0000","updated":"2016-07-24T06:11:32.921+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15393388","id":"15393388","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"bq. The existence of .next file indicates that there was a failure in the middle of reconfig, and the commitandactivate message didn't arrive to the server on which you find this file. \n\nFailure may be one of scenarios where .next file is not deleted but not the only scenario. In this scenario .next file exists because of logical problem in the code.\ncommitandactivate message arrives but it is not getting process because of bellow reason:\nsequence of events:\n1) case Leader.NEWLEADER:\nlastSeenQuorumVerifier is updated with 100000000 and .next file created.\n2) case Leader.PROPOSAL(reconfig): \nlastSeenQuorumVerifier is updated with 200000000 and earlier .next file overridden\n3) case Leader.COMMITANDACTIVATE:\nBecause snapshot in taken in step 1 snapshotTaken=true and {{self.processReconfig();}} is not called. This call was supposed to delete .next file and create the updated zoo.cfg.dynamic.200000000 file\ncode reference:\n{code}\nif (!snapshotTaken) {\n----\nboolean majorChange =\n\t   self.processReconfig(qv, ByteBuffer.wrap(qp.getData()).getLong(), qp.getZxid(), true);\n----\n}\n{code}\n4) \ncase Leader.UPTODATE:\nthis calls self.processReconfig but again it is skipped because the lastSeenQuorumVerifier version is higher. it got updated in 2)\n{code}\n public synchronized QuorumVerifier setQuorumVerifier(QuorumVerifier qv, boolean writeToDisk){\n        if ((quorumVerifier != null) && (quorumVerifier.getVersion() >= qv.getVersion())) {\n\n{code}\nbq. Which server was it ? just 4 or all of them ?\njust 4\nbq. is actually expected if server 4 crashed before it got the commitandactivate message. I described this in the manual:\nBut the sever did not crash. It is in normal flow\nbq. Could you please provide the logs ?\nCan you please try to reproduce with the above steps, we can reach to a conclusion fast. Let me know, if not reproducing I will reproduce and share the logs","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-07-26T07:53:02.487+0000","updated":"2016-07-26T07:53:02.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15393954","id":"15393954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Arshad, your patch makes sense to me (as you say - processReconfig should be called and it wasn't when the snapshot flag was on), \nbut we probably shouldn't commit it without a test. Since you have a clear scenario when this fails without the patch, would you be able to add a test ?\nI'm away until Aug 8 but can review when I'm back.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-07-26T15:34:36.085+0000","updated":"2016-07-26T15:34:36.085+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15407936","id":"15407936","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"[~shralex], Please find new patch ZOOKEEPER-2172-03.patch, which includes test case as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-08-04T15:25:33.059+0000","updated":"2016-08-04T15:25:33.059+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15407977","id":"15407977","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12822094/ZOOKEEPER-2172-03.patch\n  against trunk revision 1755100.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 2 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3323//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3323//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3323//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-04T15:47:04.389+0000","updated":"2016-08-04T15:47:04.389+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15414507","id":"15414507","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Arshad Mohammad, thanks for adding the test! \n\nDoes this test consistently fail without your fix ? the reason I'm asking is that you pointed out previously that the issue occurs when a large snapshot is being taken, whereas in the test I don't see that the state is large. How do you make sure that COMMITANDACTIVATE is received while snapshotting ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-10T00:32:26.257+0000","updated":"2016-08-10T00:32:26.257+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15414659","id":"15414659","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"# Without fix, I just run 10 times, 9 times it failed one time it passed.\nAfter fix: 10 times passed out of 10 run\nAt first place, covering this reconfig scenario through test cases is very difficult.\nThis test case has been added to give reviewer a confidence in the fix. Hope the test case serves the purpose.\n# bq. How do you make sure that COMMITANDACTIVATE is received while snapshotting ?\nNot while snapshotting, but in between snapshotting and updtodate message.\nBefore sending Leader.ACK sleep is added which gives a bigger time window for reconfig PROPOSAL and COMMITANDACTIVATE arrival\nand finally packet arrival seqence becomes  Leader.NEWLEADER(snapshotting done here) --> reconfig Leader.PROPOSAL --> reconfig Leader.COMMITANDACTIVATE --> Leader.UPTODATE","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-08-10T03:44:26.762+0000","updated":"2016-08-10T03:44:26.762+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15418102","id":"15418102","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Arshad, I verified that the test fails before the patch and passes afterwards. I realize that the patch is complex, and appreciate you writing it! I was trying to understand the logic.\n\nA few minor comments:\n- Please rename the test so that the name reflects what is being tested. Such as ReconfigDuringLeaderSync / ReconfigDuringSnapshot or something similar.\n- Please don't assume that SERVER_COUNT = 3 (so the extra server can be number 4). You could use a different variable in the test instead of SERVER_COUNT, or just give the new server an id based on SERVER_COUNT instead of 4.\n- The test shuts down the 4th server in one method and the other three in another. Consider doing this in the same place and also closing the client handles.\n- getQP could be static, maybe rename to getCustomQuorumPeer or something like that\n- Please add more comments explaining the logic of the test. For example, in writePacket please add a comment that you're delaying the ACK message a follower sends as response to a NEWLEADER message, so that the leader has a chance to send the reconfig and only then the UPTODATE (basically your comment in this thread above). Without the comment its not clear why you're checking for ACK while setting the newLeaderMessage flag. (I hope I understood the logic correctly). Similarly, when the 4th server is being started, please add a comment saying that this server will delay the response to a NEWLEADER message. Basically, more comments would be helpful :)\n- In the code, shouldn't the condition of the if be \"pif.hdr.getZxid() == qp.getZxid() && qp.getType() == Leader.COMMITANDACTIVATE\" ?\notherwise the logic inside the if may not be correct (the configuration info qv is extracted from pif).\n\nMaybe change to:\n\n                    if (pif.hdr.getZxid() != qp.getZxid()) {\n                        LOG.warn(\"Committing \" + qp.getZxid() + \", but next proposal is \" + pif.hdr.getZxid());\n                    } else if (qp.getType() == Leader.COMMITANDACTIVATE) {\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-11T23:21:39.450+0000","updated":"2016-08-11T23:21:39.450+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15419988","id":"15419988","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"another thing you could add is to check that the quorumverifier was updated e.g., when you start the fourth server do that with only itself and the leader\nand then at the end of the test check that its quorum verifier includes all 4 servers. Checking the file deletion is ok, but its sort of a symptom of the fact\nthat reconfiguration didn't complete on that server, so this is an attempt to check the configuration explicitly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-13T16:26:46.267+0000","updated":"2016-08-13T16:26:46.267+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420065","id":"15420065","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12823593/ZOOKEEPER-2172-04.patch\n  against trunk revision 1756262.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 2 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3363//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3363//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3363//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-13T20:36:04.837+0000","updated":"2016-08-13T20:36:04.837+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420066","id":"15420066","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"Thanks [~shralex], addressed all the comments in the latest patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-08-13T20:39:37.555+0000","updated":"2016-08-13T20:39:37.555+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420112","id":"15420112","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks!\nI made a few more changes:\n- starting the new server with only itself and the leader in the inittial config, so we can know that its config was really updated after reconfig\n- changed the Learner.java logic a bit, to match what was there before ZK-107 (see revision history). Also I noticed that if majorChange = true we often skip important logic when throwing an exception, so I moved the exception part to the end of each code block.\n\nCan another committer take a look before we commit ? [~cnauroth] [~rgs] [~fpj]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-13T22:59:43.997+0000","updated":"2016-08-13T22:59:43.997+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420113","id":"15420113","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"[~arshad.mohammad], please take a look","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-13T23:11:15.429+0000","updated":"2016-08-13T23:11:15.429+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420117","id":"15420117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12823597/ZOOKEPER-2172-05.patch\n  against trunk revision 1756262.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3365//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3365//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3365//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-13T23:26:10.692+0000","updated":"2016-08-13T23:26:10.692+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420144","id":"15420144","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"On second thought, investigating the right way to throw the exception should probably be done in a separate jira, so I reverted some of my changes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-14T00:38:33.781+0000","updated":"2016-08-14T00:38:33.781+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420145","id":"15420145","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"I opened https://issues.apache.org/jira/browse/ZOOKEEPER-2513 as a followup","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-14T00:47:21.638+0000","updated":"2016-08-14T00:47:21.638+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420214","id":"15420214","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12823602/ZOOKEEPER-2172-06.patch\n  against trunk revision 1756262.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 3 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3366//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3366//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3366//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-14T04:49:53.888+0000","updated":"2016-08-14T04:49:53.888+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420233","id":"15420233","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"Thanks [~shralex] for authoring the patch, patch is improved a lot.\nIt is good that the changes you introduced in ZOOKEEPER-2172-05.patch have removed in the latest patch and created new jira to address those concerns.\nI corrected following nits in the ZOOKEEPER-2172-06.patch  and submitted new patch\n{noformat}\nZOOKEEPER-2172-06.patch:10: trailing whitespace.\nZOOKEEPER-2172-06.patch:30: trailing whitespace.\n                        boolean majorChange =\nZOOKEEPER-2172-06.patch:31: space before tab in indent.\n                                        self.processReconfig(qv, ByteBuffer.wrap(qp.getData()).getLong(), qp.getZxid(), true);\nZOOKEEPER-2172-06.patch:35: trailing whitespace.\n                    }\nZOOKEEPER-2172-06.patch:111: trailing whitespace.\n     *\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-08-14T06:16:48.984+0000","updated":"2016-08-14T06:16:48.984+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420241","id":"15420241","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12823615/ZOOKEEPER-2172-07.patch\n  against trunk revision 1756262.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 2 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3368//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3368//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3368//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-14T06:36:14.072+0000","updated":"2016-08-14T06:36:14.072+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15420429","id":"15420429","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"body":"+1 from me. Since I removed most my changes, I feel comfortable committing this but lets wait a week or so to let\nother people comment if they wish. \n\n[~arshad.mohammad] would you like to take a stab at ZOOKEEPER-2513 ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shralex","name":"shralex","key":"shralex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Shraer","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-14T18:29:44.617+0000","updated":"2016-08-14T18:29:44.617+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15474994","id":"15474994","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Given this has signoff by Alex and it's been pending for a while I've committed it to 3.5.3 and trunk. Thanks Arshad (and Alex)!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-09-08T21:01:46.297+0000","updated":"2016-09-08T21:01:46.297+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15475076","id":"15475076","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Jenkins build ZooKeeper-trunk #3070 (See [https://builds.apache.org/job/ZooKeeper-trunk/3070/])\nZOOKEEPER-2172: Cluster crashes when reconfig a new node as a participant (Arshad Mohammad via phunt) (phunt: [http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1759907])\n* (edit) trunk/CHANGES.txt\n* (edit) trunk/src/java/main/org/apache/zookeeper/server/quorum/Learner.java\n* (add) trunk/src/java/test/org/apache/zookeeper/server/quorum/ReconfigDuringLeaderSyncTest.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-08T21:27:37.179+0000","updated":"2016-09-08T21:27:37.179+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/15492587","id":"15492587","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"body":"Thanks [~Bhupendra], [~ajithshetty] for helping me in analysing this issue.\nThanks [~shralex],[~phunt] for reviewing and committing the patch.\nThanks every one for participating in the discussion and providing useful information.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arshad.mohammad","name":"arshad.mohammad","key":"arshad.mohammad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Mohammad Arshad","active":true,"timeZone":"Asia/Singapore"},"created":"2016-09-15T06:59:16.414+0000","updated":"2016-09-15T06:59:16.414+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/16389307","id":"16389307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuvald","name":"yuvald","key":"yuvald","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuval Dori","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\r\n\r\n \r\n\r\nThis issue happens in a few of our customers using 3.4.8 version.\r\n\r\nDuring this days we are upgrading to 3.4.10.\r\n\r\nAs 3.5.3 is in Beta, is it possible to backport this fix?\r\n\r\n \r\n\r\nThanks,\r\n\r\n \r\n\r\nYuval ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuvald","name":"yuvald","key":"yuvald","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuval Dori","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-07T09:29:32.490+0000","updated":"2018-03-07T09:29:32.490+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/16389378","id":"16389378","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"[~yuvald]\r\n\r\nAre you sure about it's the same issue?\r\n\r\nDynamic reconfig is a 3.5+ feature.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-07T10:38:46.615+0000","updated":"2018-03-07T10:38:46.615+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/16389390","id":"16389390","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuvald","name":"yuvald","key":"yuvald","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuval Dori","active":true,"timeZone":"Etc/UTC"},"body":"1. The use case here was adding node to ZK cluster using zookeeper-3.5.jar. It's not the same use case as for our customers. the first use 5 machines with 3 ZK instances. shutdown 2 machine (one with ZK. so 2 ZK left) and got \"java.lang.IllegalStateException: instance must be started before calling this method\". The second customer got this error when deploying the application.\r\n\r\nThis is this issue stack trace: \r\n\r\n2015-04-20 12:53:52,230 [myid:1] - ERROR [LearnerHandler-/10.0.0.2:55890:LearnerHandler@580] - Unexpected exception causing shutdown while sock still open \r\njava.io.EOFException \r\nat java.io.DataInputStream.readInt(Unknown Source) \r\nat org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63) \r\nat org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83) \r\nat org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:103) \r\nat org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:493) \r\n2015-04-20 12:53:52,231 [myid:1] - WARN [LearnerHandler-/10.0.0.2:55890:LearnerHandler@595] - ******* GOODBYE /10.0.0.2:55890 ******** \r\n\r\nAnd this our customers stack trace: \r\n\r\n2018-02-15T09:58:12.094+0100; ERROR; WSOSTSLXWIT01/MANAGER; P3424/T194; [SPACE/LearnerHandler-/10.17.46.142:49336/LearnerHandler]; Unexpected exception causing shutdown while sock still open \r\njava.net.SocketTimeoutException: Read timed out \r\nat java.net.SocketInputStream.socketRead0(Native Method) \r\nat java.net.SocketInputStream.socketRead(SocketInputStream.java:116) \r\nat java.net.SocketInputStream.read(SocketInputStream.java:171) \r\nat java.net.SocketInputStream.read(SocketInputStream.java:141) \r\nat java.io.BufferedInputStream.fill(BufferedInputStream.java:246) \r\nat java.io.BufferedInputStream.read(BufferedInputStream.java:265) \r\nat java.io.DataInputStream.readInt(DataInputStream.java:387) \r\nat org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63) \r\nat org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:83) \r\nat org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:99) \r\nat org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:542) \r\n\r\nAs you can see the row lines for BinaryInputArchive.java and LearnerHandler.java are different but I thought its related to the different versions (3.4.8 vs 3.5). \r\n\r\n \r\n\r\nThe first customer tested it with ZK 3.5.3 and it didn't reproduced!\r\n\r\nWhat is this new feature that was added to 3.5?\r\n\r\nI'll be happy to hear whether do you think if it's related or not.\r\n\r\nThanks,\r\n\r\n \r\n\r\nYuval","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuvald","name":"yuvald","key":"yuvald","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuval Dori","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-07T11:01:01.410+0000","updated":"2018-03-07T11:01:01.410+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/16389444","id":"16389444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"These are 2 totally different errors I believe.\r\n\r\nI'm pretty sure they're not related, because the Jira is about a feature which is available from 3.5 versions only as mentioned.\r\n\r\nWould you please kindly move this discussion to ZooKeeper 'user' mailing list and provide some more information (ensemble topology, config files, log files, step-by-step scenario, etc.)?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-07T11:48:57.228+0000","updated":"2018-03-07T11:48:57.228+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/16389604","id":"16389604","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuvald","name":"yuvald","key":"yuvald","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuval Dori","active":true,"timeZone":"Etc/UTC"},"body":"Thanks Andor.\r\n\r\nDo you think it's another ZK bug or something else?\r\n\r\n \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuvald","name":"yuvald","key":"yuvald","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuval Dori","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-07T14:14:59.392+0000","updated":"2018-03-07T14:14:59.392+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/16389608","id":"16389608","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"Could be.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-07T14:16:59.628+0000","updated":"2018-03-07T14:16:59.628+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/16389619","id":"16389619","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuvald","name":"yuvald","key":"yuvald","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuval Dori","active":true,"timeZone":"Etc/UTC"},"body":"So, in order to further investigate it, do I need to subscribe here:\r\n\r\n[https://zookeeper.apache.org/lists.html] ?\r\n\r\n \r\n\r\nThanks,\r\n\r\n \r\n\r\nYuval\r\n\r\n \r\n\r\n \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuvald","name":"yuvald","key":"yuvald","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuval Dori","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-07T14:27:46.263+0000","updated":"2018-03-07T14:27:46.263+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12822558/comment/16389636","id":"16389636","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"body":"Yes, please subscribe to 'users' list.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andorm","name":"andorm","key":"andorm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andorm&avatarId=32935","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andorm&avatarId=32935","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andorm&avatarId=32935","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andorm&avatarId=32935"},"displayName":"Andor Molnar","active":true,"timeZone":"Europe/Budapest"},"created":"2018-03-07T14:37:08.773+0000","updated":"2018-03-07T14:37:08.773+0000"}],"maxResults":105,"total":105,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2172/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2disv:"}}