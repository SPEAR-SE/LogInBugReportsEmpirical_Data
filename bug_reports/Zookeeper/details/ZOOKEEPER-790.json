{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12467595","self":"https://issues.apache.org/jira/rest/api/2/issue/12467595","key":"ZOOKEEPER-790","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315108","id":"12315108","description":"Fix release against 3.3 branch","name":"3.3.2","archived":false,"released":true,"releaseDate":"2010-11-11"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314469","id":"12314469","description":"Kerberos client auth, multi support, deb/rpm pkging.","name":"3.4.0","archived":false,"released":true,"releaseDate":"2011-11-22"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-06-22T18:21:40.994+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jul 30 10:51:40 UTC 2010","customfield_12310420":"47599","customfield_12312320":null,"customfield_12310222":"10002_*:*_6_*:*_461206296_*|*_1_*:*_5_*:*_2433522616_*|*_5_*:*_2_*:*_316505396_*|*_4_*:*_1_*:*_1406117","customfield_12312321":null,"resolutiondate":"2010-07-29T21:11:57.258+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-790/watchers","watchCount":2,"isWatching":false},"created":"2010-06-22T16:47:56.833+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"14.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314846","id":"12314846","description":"Fix release against 3.3 branch","name":"3.3.1","archived":false,"released":true,"releaseDate":"2010-05-17"}],"issuelinks":[{"id":"12332606","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12332606","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12416126","key":"ZOOKEEPER-335","self":"https://issues.apache.org/jira/rest/api/2/issue/12416126","fields":{"summary":"zookeeper servers should commit the new leader txn to their logs.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-23T19:22:17.505+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312379","id":"12312379","name":"quorum","description":"Quorum determination for ZooKeeper"}],"timeoriginalestimate":null,"description":"The leader code is setting the last processed zxid to the first of the new epoch even before connecting to a quorum of followers. Because the leader code sets this value before connecting to a quorum of followers (Leader.java:281) and the follower code throws an IOException (Follower.java:73) if the leader epoch is smaller, we have that when the false leader drops leadership and becomes a follower, it finds a smaller epoch and kills itself.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450187","id":"12450187","filename":"ZOOKEEPER-790.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-22T16:38:47.862+0000","size":13156,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12450187/ZOOKEEPER-790.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450033","id":"12450033","filename":"ZOOKEEPER-790.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-21T07:11:36.737+0000","size":12969,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12450033/ZOOKEEPER-790.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12449972","id":"12449972","filename":"ZOOKEEPER-790.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-20T20:30:14.146+0000","size":13182,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12449972/ZOOKEEPER-790.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12449676","id":"12449676","filename":"ZOOKEEPER-790.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-16T16:26:30.670+0000","size":3400,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12449676/ZOOKEEPER-790.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12447715","id":"12447715","filename":"ZOOKEEPER-790.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-06-22T16:49:48.473+0000","size":1439,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12447715/ZOOKEEPER-790.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12449533","id":"12449533","filename":"ZOOKEEPER-790.travis.log.bz2","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-15T03:28:31.909+0000","size":44747,"mimeType":"application/x-bzip2","content":"https://issues.apache.org/jira/secure/attachment/12449533/ZOOKEEPER-790.travis.log.bz2"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450762","id":"12450762","filename":"ZOOKEEPER-790.v2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-28T22:13:44.263+0000","size":17727,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12450762/ZOOKEEPER-790.v2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450598","id":"12450598","filename":"ZOOKEEPER-790.v2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-27T13:46:20.778+0000","size":17703,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12450598/ZOOKEEPER-790.v2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450534","id":"12450534","filename":"ZOOKEEPER-790.v2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-26T22:40:23.157+0000","size":4462,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12450534/ZOOKEEPER-790.v2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450186","id":"12450186","filename":"ZOOKEEPER-790-3.3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-22T16:38:25.117+0000","size":12942,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12450186/ZOOKEEPER-790-3.3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12449980","id":"12449980","filename":"ZOOKEEPER-790-3.3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-20T21:44:52.202+0000","size":12765,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12449980/ZOOKEEPER-790-3.3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450761","id":"12450761","filename":"ZOOKEEPER-790-3.3.v2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-28T22:12:45.921+0000","size":17520,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12450761/ZOOKEEPER-790-3.3.v2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450504","id":"12450504","filename":"ZOOKEEPER-790-follower-request-NPE.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-26T19:23:00.714+0000","size":16753,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12450504/ZOOKEEPER-790-follower-request-NPE.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450584","id":"12450584","filename":"ZOOKEEPER-790-test.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-27T10:46:44.535+0000","size":10323,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12450584/ZOOKEEPER-790-test.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32868","customfield_12312823":null,"summary":"Last processed zxid set prematurely while establishing leadership","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12881282","id":"12881282","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"\nI will try out the patch. I will try it out on 3.3.0 since that is the version we are currently using.\n\n-Vishal","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-06-22T18:21:40.994+0000","updated":"2010-06-22T18:21:40.994+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12885738","id":"12885738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"body":"@vishal - How did your test go? I came across this issue while investigating an issue and believe this is the root cause.\n\nIf your test went well I can also help test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-06T23:36:32.387+0000","updated":"2010-07-06T23:36:32.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12887941","id":"12887941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Folks,\n\nSorry to the delay. The patch did not work. Any other ideas? Thanks.\n\n-Vishal","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-13T19:22:07.479+0000","updated":"2010-07-13T19:22:07.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12887969","id":"12887969","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Vishal, What exactly didn't work? Do you get the same error messages with the patch? Do you have a reliable way of reproducing it? In general, it would be useful if you could provide more detail.\n\nThanks!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-13T19:51:40.935+0000","updated":"2010-07-13T19:51:40.935+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888119","id":"12888119","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"copying comments from email to jira.\n\nHi Flavio ,\n\nI got the same error messages. I can reproduce this quite easily. I will capture the logs again. Is there anything else you would like me to provide? Thanks.\n\n-Vishal","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-14T00:10:08.413+0000","updated":"2010-07-14T00:10:08.413+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888121","id":"12888121","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"copying comments from email to jira. \n\nI forgot if you have provided already a description of how you reproduce it. If you could point me out to that, I would appreciate.\n\n-Flavio\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-14T00:10:33.530+0000","updated":"2010-07-14T00:10:33.530+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888122","id":"12888122","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"From ZOOKEEPER-335..\n\nHi,\n\nI enabled tracing and did some more debugging. Looks like the restarted peer (and trying to join the cluster) determines that it is a leader and increments its epoch. However, rest of the nodes don't acknowledge this node as the leader, and hence, have an older epoch. I will attache the log. Unfortunately, I don't have traces from other nodes. I will repeat the experiment later and attache logs from other nodes.\n\nScenario:\n\n    * Form a 3 node cluster. This is not just ZK cluster. It also involves our application cluster that uses ZK.\n    * Kill one of the follower\n    * After a minute or so restart follower\n    * Follower rejects leader with \"Leader epoch y is less than our epoch y + 1\"\n\nFrom logs:\n\na) Peer X restarts and starts leader election.\na) For a small window of time, X thinks that it is the new leader! During this window, for some reason, rest of the nodes tell X that they are also trying to find a leader. I.e., all 3 nodes are in LOOKING state. After seeing that all 3 nodes are in LOOKING state, X decides to be a leader?\n\n155 2010-06-20 23:22:46,421 - DEBUG [WorkerSender Thread:QuorumCnxManager@346] - Opening channel to server 1\n156 2010-06-20 23:22:46,423 - DEBUG [WorkerReceiver Thread:FastLeaderElection$Messenger$WorkerReceiver@214] - Receive new notification message. My id = 0\n157 2010-06-20 23:22:46,424 - INFO [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@689] - Notification: 0, 77309411393, 1, 0, LOOKING, LOOKING, 0\n158 2010-06-20 23:22:46,424 - DEBUG [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@495] - id: 0, proposed id: 0, zxid: 77309411393, proposed zxid: 77309411393\n159 2010-06-20 23:22:46,424 - DEBUG [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@717] - Adding vote: From = 0, Proposed leader = 0, Porposed zxid = 77309411393, Proposed epoch = 1\n160 2010-06-20 23:22:46,426 - INFO [WorkerSender Thread:QuorumCnxManager@162] - Have smaller server identifier, so dropping the connection: (1, 0)\n161 2010-06-20 23:22:46,426 - DEBUG [WorkerSender Thread:QuorumCnxManager@346] - Opening channel to server 2\n162 2010-06-20 23:22:46,427 - DEBUG [Thread-1:QuorumCnxManager$Listener@445] - Connection request /192.168.1.182:46701\n163 2010-06-20 23:22:46,427 - DEBUG [Thread-1:QuorumCnxManager$Listener@448] - Connection request: 0\n164 2010-06-20 23:22:46,428 - DEBUG [Thread-1:QuorumCnxManager$SendWorker@504] - Address of remote peer: 1\n165 2010-06-20 23:22:46,428 - INFO [WorkerSender Thread:QuorumCnxManager@162] - Have smaller server identifier, so dropping the connection: (2, 0)\n166 2010-06-20 23:22:46,431 - DEBUG [WorkerReceiver Thread:FastLeaderElection$Messenger$WorkerReceiver@214] - Receive new notification message. My id = 0\n167 2010-06-20 23:22:46,432 - INFO [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@689] - Notification: 1, 77309411372, 1, 0, LOOKING, LOOKING, 1\n168 2010-06-20 23:22:46,432 - DEBUG [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@495] - id: 1, proposed id: 0, zxid: 77309411372, proposed zxid: 77309411393\n169 2010-06-20 23:22:46,432 - DEBUG [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@717] - Adding vote: From = 1, Proposed leader = 1, Porposed zxid = 77309411372, Proposed epoch = 1\n170 2010-06-20 23:22:46,436 - DEBUG [Thread-1:QuorumCnxManager$Listener@445] - Connection request /192.168.1.183:44310\n171 2010-06-20 23:22:46,436 - DEBUG [Thread-1:QuorumCnxManager$Listener@448] - Connection request: 0\n172 2010-06-20 23:22:46,436 - DEBUG [Thread-1:QuorumCnxManager$SendWorker@504] - Address of remote peer: 2\n173 2010-06-20 23:22:46,440 - DEBUG [WorkerReceiver Thread:FastLeaderElection$Messenger$WorkerReceiver@214] - Receive new notification message. My id = 0\n174 2010-06-20 23:22:46,440 - INFO [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@689] - Notification: 2, 73014444097, 1, 0, LOOKING, LOOKING, 2\n175 2010-06-20 23:22:46,440 - DEBUG [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@495] - id: 2, proposed id: 0, zxid: 73014444097, proposed zxid: 77309411393\n176 2010-06-20 23:22:46,441 - DEBUG [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@717] - Adding vote: From = 2, Proposed leader = 2, Porposed zxid = 73014444097, Proposed epoch = 1\n177 2010-06-20 23:22:46,441 - INFO [QuorumPeer:/0.0.0.0:2181:QuorumPeer@647] - LEADING\n\nb) As a result X increments its epoch. Worse, since this node decided to be a leader, it starts doing transactions. The first set of transactions start removing all ephemeral nodes. But these transactions are only done locally. Other peers do not ack these transactions since they know that this peer is not the leader.\n\nc) After a few seconds (8 secs), X relinquishes leadership since it does not receive any ack from rest of the peers\nd) It starts leader election again. This time, rests of the peers respond correctly informing X that a leader already exists.\ne) X determines that it should now follow the leader and starts handshake with the leader. However, X has incremented its epoch in the mean time. X thinks that the epoch sent by the leader during handshake is older than the epoch it has noticed before. X aborts connection with the leader.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-14T00:13:38.383+0000","updated":"2010-07-14T00:13:38.383+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888123","id":"12888123","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi Flavio,\n\nI think there are two additional related problems:\n\n1. Why are the other two nodes that have formed the cluster in LOOKING state? Both should reply with FOLLOWING\n174 2010-06-20 23:22:46,440 - INFO [QuorumPeer:/0.0.0.0:2181:FastLeaderElection@689] - Notification: 2, 73014444097, 1, 0, LOOKING, LOOKING, 2\n\n2. The node attempting to join goes in an infinite loop of join fails. We should add a delay.\n\nThanks,\nVishal","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-14T00:16:26.050+0000","updated":"2010-07-14T00:16:26.050+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888304","id":"12888304","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Vishal, Thanks for all the information. I haven't been able to reproduce it yet, but here are some thoughts after looking over your logs again:\n\n1- It is not a problem that server 0 is declaring itself leader, even though there is another leader running. Server 0 will be ignored by the others and eventually will drop its leadership as you have observed;\n2- The notifications of 1 and 2 say looking because they have been queued at the time 1 and 2 were looking for a leader. That's not an issue;\n3- I don't understand why the patch doesn't work. Let me tell you how I'm interpreting your run. Server 0 is receiving the notifications from 1 and 2, and deciding that it should be the leader. Because in the current trunk code we set the first zxid for the new epoch before hearing from a quorum, once server 0 drops leadership, it has a higher zxid than everyone else. Consequently, it correctly refuses to talk to the current leader. Now, setting the first epoch zxid prematurely is a problem, and the patch I have uploaded should fix it. The bottom line is that I can't understand why the patch I uploaded does not fix it. Have you made sure to apply it before running your new tests? Either way, I would appreciate if you could upload logs out of a run with the current 790 patch.\n\nThanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-14T11:49:56.513+0000","updated":"2010-07-14T11:49:56.513+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888330","id":"12888330","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi Flavio,\n\nI am going to retry again with the patch. Thanks.\n\n-Vishal","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-14T13:38:08.872+0000","updated":"2010-07-14T13:38:08.872+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888409","id":"12888409","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Vishal, you might add some sort of log message to the code (in addition to the patch) to verify that the code you're running is the patched version.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-14T16:08:26.304+0000","updated":"2010-07-14T16:08:26.304+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888443","id":"12888443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi Patrick,\n\nI had done that earlier. I will do it again to reconfirm. I would also help if Travis or Charity  can also try to verify the patch, if possible.\n\n-Vishal","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-14T17:31:33.852+0000","updated":"2010-07-14T17:31:33.852+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888576","id":"12888576","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"body":"Sure, I'll help test this too.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-14T22:20:49.004+0000","updated":"2010-07-14T22:20:49.004+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888688","id":"12888688","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"body":"I accidentally posted this in ZOOKEEPER-335 -- reposting here. Sorry for the posting mixup -- the content is correct though :)\n\n\nUnfortunately I still observed the \"Leader epoch\" issue and needed to manually force a leader election for the cluster to recover. This test was performed with the following base+patches, applied in the order listed.\n\nZookeeper 3.3.1\nZOOKEEPER-744\nZOOKEEPER-790\n\n{code}\n2010-07-15 02:43:57,181 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FileSnap@82] - Reading snapshot /data/zookeeper/version-2/snapshot.2300001ac2\n2010-07-15 02:43:57,384 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@649] - New election. My id =  1, Proposed zxid = 154618826848\n2010-07-15 02:43:57,385 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@689] - Notification: 1, 154618826848, 4, 1, LOOKING, LOOKING, 1\n2010-07-15 02:43:57,385 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@799] - Notification: 2, 146030952153, 3, 1, LOOKING, LEADING, 2\n2010-07-15 02:43:57,385 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@799] - Notification: 2, 146030952153, 3, 1, LOOKING, FOLLOWING, 3\n2010-07-15 02:43:57,385 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:QuorumPeer@642] - FOLLOWING\n2010-07-15 02:43:57,385 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:ZooKeeperServer@151] - Created server with tickTime 2000 minSessionTimeout 4000 maxSessionTimeout 40000 datadir /data/zookeeper/txlog/version-2 snapdir /data/zookeeper/version-2\n2010-07-15 02:43:57,387 - FATAL [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Follower@71] - Leader epoch 23 is less than our epoch 24\n2010-07-15 02:43:57,387 - WARN  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Follower@82] - Exception when following the leader \njava.io.IOException: Error: Epoch of leader is lower\n        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:73)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:644)\n2010-07-15 02:43:57,387 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Follower@166] - shutdown called \njava.lang.Exception: shutdown Follower\n        at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:166)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:648)\n{code}\n\n\nI followed the recipe @vishal provided for recreating.\n\n(a) Stop one follower in a three node cluster\n(b) Get some tea while it falls behind\n(c) Start the node stopped in (a).\n\nThese timestamps show where the follower was stopped. It also shows when it was turned back on.\n\n{code}\n2010-07-15 02:35:36,398 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:NIOServerCnxn@1661] - Established session 0x229aa13cfc6276b with negotiated timeout 10000 for client /10.209.45.114:34562\n2010-07-15 02:39:18,907 - INFO  [main:QuorumPeerConfig@90] - Reading configuration from: /etc/zookeeper/conf/zoo.cfg\n{code}\n\n\nThis timestamp is the first ``Leader epoch`` line. Everything between these two points will be the interesting bits.\n\n\n{code}\n2010-07-15 02:39:43,339 - FATAL [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Follower@71] - Leader epoch 23 is less than our epoch 24\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-15T03:28:11.204+0000","updated":"2010-07-15T03:28:11.204+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888834","id":"12888834","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Thank you both for all the information. I have been able to reproduce and find the source of the bug, but I don't have a patch yet. The problem is deeper than I thought originally. Let me show you what is going on:\n\nI'm including an excerpt of logs from two runs: one good and one bad. The first run is good (see the excerpt below). I have killed the follower and restarted it as Vishal suggested. When it comes back, it declares itself as leader, also as Vishal and Travis observed.  However, different from what Vishal and Travis observed, it drops leadership and follows happily the leader right after.\n\n{noformat}\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@654] - LEADING\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LEADING (my state)\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Leader@54] - TCP NoDelay set to: true\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:zookeeper.version=3.4.0--1, built on 07/15/2010 10:36 GMT\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:host.name=XXXXXXXXXX.com\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.version=1.6.0_04\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.vendor=Sun Microsystems Inc.\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.home=/usr/java/jdk1.6.0_04/jre\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.class.path=.XXXXXXXXX\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.library.path= XXXXXXXXX\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.io.tmpdir=/tmp\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.compiler=<NA>\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.name=Linux\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.arch=amd64\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.version=2.6.18-53.1.21.el5\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.name=XXXXXXXXX\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.home=XXXXXXXXX\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.dir=XXXXXXXXX\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:ZooKeeperServer@151] - Created server with tickTime 3000 minSessionTimeout 6000 maxSessionTimeout 60000 datadir /XXXXXXXXX/zookeeper/version-2 snapdir /XXXXXXXX/zookeeper/version-2\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXXX/zookeeper/version-2/snapshot.100113340\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXXX/zookeeper/version-2/snapshot.100113340\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileTxnSnapLog@208] - Snapshotting: 10011f748\nINFO  - [SessionTracker:ZooKeeperServer@315] - Expiring session 0x229d6a9e0ca0000, timeout of 10000ms exceeded\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Leader@394] - Shutdown called\njava.lang.Exception: shutdown Leader! reason: Waiting for a quorum of followers, only synced with: 2: \n        at org.apache.zookeeper.server.quorum.Leader.shutdown(Leader.java:394)\n        at org.apache.zookeeper.server.quorum.Leader.lead(Leader.java:317)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:657)\nINFO  - [Thread-10:Leader$LearnerCnxAcceptor@243] - exception while shutting down acceptor: java.net.SocketException: Socket closed\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FinalRequestProcessor@378] - shutdown of request processor complete\nINFO  - [SyncThread:2:SyncRequestProcessor@151] - SyncRequestProcessor exited!\nINFO  - [CommitProcessor:2:CommitProcessor@148] - CommitProcessor exited loop!\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@620] - LOOKING\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXXXX/zookeeper/version-2/snapshot.10011f748\nINFO  - [SessionTracker:SessionTrackerImpl@158] - SessionTrackerImpl exited loop!\nINFO  - [ProcessThread:-1:PrepRequestProcessor@385] - Processed session termination for sessionid: 0x229d6a9e0ca0000\nERROR - [ProcessThread:-1:NIOServerCnxn$Factory$1@87] - Thread Thread[ProcessThread:-1,5,main] died\njava.lang.NullPointerException\n        at org.apache.zookeeper.server.quorum.ProposalRequestProcessor.processRequest(ProposalRequestProcessor.java:71)\n        at org.apache.zookeeper.server.PrepRequestProcessor.pRequest(PrepRequestProcessor.java:435)\n        at org.apache.zookeeper.server.PrepRequestProcessor.run(PrepRequestProcessor.java:114)\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FastLeaderElection@663] - New election. My id =  2, Proposed zxid = 4296144712\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 2 (n.leader), 4296144712 (n.zxid), 2 (n.round), LOOKING (n.state), 2 (n.sid), LOOKING (my state)\nINFO  - [WorkerSender Thread:QuorumCnxManager@162] - Have smaller server identifier, so dropping the connection: (3, 2)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 1 (n.sid), LOOKING (my state)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 1 (n.sid), LOOKING (my state)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 1 (n.sid), LOOKING (my state)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@642] - FOLLOWING\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Learner@72] - TCP NoDelay set to: true\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:ZooKeeperServer@151] - Created server with tickTime 3000 minSessionTimeout 6000 maxSessionTimeout 60000 datadir /XXXXXXXXX/zookeeper/version-2 snapdir /XXXXXXXXX/zookeeper/version-2\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Learner@285] - Getting a snapshot from leader\nFATAL - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Learner@314] - Setting leader epoch 1\nWARN  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Follower@116] - Got zxid 0x100162711 expected 0x1\nWARN  - [SyncThread:2:FileTxnLog@196] - Creating new log file: 100162711\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileTxnSnapLog@208] - Snapshotting: 100164c43\n{noformat}\n\n\nNow, the following run is bad. I followed the same procedure, but this time we get the epoch problem. Looking carefully at the logs, you'll see that the main difference is that this time the zookeeper server created a new log file: log.200000001. This is bad because the zookeeper server will use the zxid in the latest txn log file to determine its last epoch. Given that the current leader is in epoch 1, it will correctly refuse to talk to the leader as we observe below.\n\n{noformat}\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@654] - LEADING\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Leader@54] - TCP NoDelay set to: true\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:zookeeper.version=3.4.0--1, built on 07/15/2010 10:36 GMT\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:host.name=XXXXXXXX.com\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.version=1.6.0_05\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.vendor=Sun Microsystems Inc.\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.home=/usr/java/jdk1.6.0_05/jre\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.class.path=XXXXXXXXX\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.library.path=XXXXXXXXX\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.io.tmpdir=/tmp\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:java.compiler=<NA>\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.name=Linux\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.arch= amd64\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:os.version=2.6.18-92.1.13.el5.perfctr.2.6.36\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.name=XXXXXXXXX\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.home=XXXXXXXX\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Environment@97] - Server environment:user.dir=XXXXXXXXX\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:ZooKeeperServer@151] - Created server with tickTime 3000 minSessionTimeout 6000 maxSessionTimeout 60000 datadir /xxxxxxx/zookeeper/version-2 snapdir /XXXXXXX/zookeeper/version-2\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXX/zookeeper/version-2/snapshot.1000469b4\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXX/zookeeper/version-2/snapshot.1000469b4\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileTxnSnapLog@208] - Snapshotting: 100055cec\nINFO  - [SessionTracker:ZooKeeperServer@315] - Expiring session 0x129d6b61b5b0000, timeout of 10000ms exceeded\nINFO  - [ProcessThread:-1:PrepRequestProcessor@385] - Processed session termination for sessionid: 0x129d6b61b5b0000\nWARN  - [SyncThread:1:FileTxnLog@196] - Creating new log file: log.200000001\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Leader@394] - Shutdown called\njava.lang.Exception: shutdown Leader! reason: Waiting for a quorum of followers, only synced with: 1: \n        at org.apache.zookeeper.server.quorum.Leader.shutdown(Leader.java:394)\n        at org.apache.zookeeper.server.quorum.Leader.lead(Leader.java:317)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:657)\nINFO  - [ProcessThread:-1:PrepRequestProcessor@119] - PrepRequestProcessor exited loop!\nINFO  - [CommitProcessor:1:CommitProcessor@148] - CommitProcessor exited loop!\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FinalRequestProcessor@378] - shutdown of request processor complete\nINFO  - [SyncThread:1:SyncRequestProcessor@151] - SyncRequestProcessor exited!\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@620] - LOOKING\nINFO  - [Thread-8:Leader$LearnerCnxAcceptor@243] - exception while shutting down acceptor: java.net.SocketException: Socket closed\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FileSnap@82] - Reading snapshot /XXXXXXXX/zookeeper/version-2/snapshot.100055cec\nINFO  - [SessionTracker:SessionTrackerImpl@158] - SessionTrackerImpl exited loop!\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:FastLeaderElection@663] - New election. My id =  1, Proposed zxid = 8589934593\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 1 (n.leader), 8589934593 (n.zxid), 2 (n.round), LOOKING (n.state), 1 (n.sid), LOOKING (my state)\nINFO  - [WorkerSender Thread:QuorumCnxManager@162] - Have smaller server identifier, so dropping the connection: (2, 1)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 2 (n.sid), LOOKING (my state)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), LEADING (n.state), 3 (n.sid), LOOKING (my state)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 2 (n.sid), LOOKING (my state)\nINFO  - [WorkerReceiver Thread:FastLeaderElection@496] - Notification: 3 (n.leader), 0 (n.zxid), 1 (n.round), FOLLOWING (n.state), 2 (n.sid), LOOKING (my state)\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:QuorumPeer@642] - FOLLOWING\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Learner@72] - TCP NoDelay set to: true\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:ZooKeeperServer@151] - Created server with tickTime 3000 minSessionTimeout 6000 maxSessionTimeout 60000 datadir /xxxxxxx/zookeeper/version-2 snapdir /xxxxxxx/zookeeper/version-2\nFATAL - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Follower@71] - Leader epoch 1 is less than our epoch 2\nWARN  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Follower@82] - Exception when following the leader\njava.io.IOException: Error: Epoch of leader is lower\n        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:73)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:644)\nINFO  - [QuorumPeer:/0:0:0:0:0:0:0:0:10218:Follower@166] - shutdown called\njava.lang.Exception: shutdown Follower\n        at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:166)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:648)\n{noformat}\n\nFixing it is not as simple as setting the current zxid to 200000001 after we hear from a quorum because the request processor pipeline starts complaining about an attempt to commit a future proposal.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-15T15:52:59.134+0000","updated":"2010-07-15T15:52:59.134+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888842","id":"12888842","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"body":"Good find! I can certainly help test a patch, or collect more info if needed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-15T16:12:22.789+0000","updated":"2010-07-15T16:12:22.789+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12888843","id":"12888843","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Likewise.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-15T16:19:15.986+0000","updated":"2010-07-15T16:19:15.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12889072","id":"12889072","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Some additional information. We create a new transaction log when we try to append a transaction and there is no log file open. Consequently, we only create it when there is something to write. For the bad run above, here is the content of the log:\n\n{noformat}\nZooKeeper Transactional Log File with dbid 0 txnlog format version 2\n7/15/10 5:27:45 PM CEST session 0x129d6b61b5b0000 cxid 0x0 zxid 0x200000001 closeSession\nEOF reached after 1 txns.\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-16T08:59:07.849+0000","updated":"2010-07-16T08:59:07.849+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12889218","id":"12889218","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Hi! I'm attaching a patch that works for my setup (and passes the unit tests as well), so I would appreciate if you could give it a try.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-16T16:26:30.738+0000","updated":"2010-07-16T16:26:30.738+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12889225","id":"12889225","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"great! I will give it a try. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-16T16:50:22.397+0000","updated":"2010-07-16T16:50:22.397+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12890427","id":"12890427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"This patch is very simple: it moves two function calls such that a leader only starts up and sets the the last processed zxid after it has a quorum of supporters. It also includes a unit test. I had to make a few modifications here and there to be able to write this test. I tried to minimize changes as much as possible.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-20T20:30:14.823+0000","updated":"2010-07-20T20:30:14.823+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12890451","id":"12890451","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12449972/ZOOKEEPER-790.patch\n  against trunk revision 963957.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 6 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/150/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/150/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-h1.grid.sp2.yahoo.net/150/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-20T21:20:47.088+0000","updated":"2010-07-20T21:20:47.088+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12890469","id":"12890469","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Uploading patch for the 3.3 branch. I have also checked the results of Hudson, and I couldn't find any java test failure. The -1 on core tests seems to be unrelated to this patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-20T21:44:52.286+0000","updated":"2010-07-20T21:44:52.286+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12890512","id":"12890512","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"body":"I tested this patch on a build with the following, applied in the listed order: 3.3.1 release + ZOOKEEPER-744.patch + ZOOKEEPER-790-3.3.patch\n\nLooks good!\n\n{code}\n2010-07-20 23:43:34,229 - INFO  [Thread-2545:NIOServerCnxn@1516] - Closed socket connection for client /10.209.21.181:53743 (no session established for client)\n2010-07-20 23:43:34,659 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@639] - EndOfStreamException: Unable to read additional data from client sessionid 0x129d3fcb5a6f60d, likely client has closed socket\n2010-07-20 23:43:34,660 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1516] - Closed socket connection for client /10.209.21.204:59727 which had sessionid 0x129d3fcb5a6f60d\n2010-07-20 23:43:34,684 - INFO  [ProcessThread:-1:PrepRequestProcessor@385] - Processed session termination for sessionid: 0x329d3fcb6594e53\n2010-07-20 23:52:14,522 - INFO  [main:QuorumPeerConfig@90] - Reading configuration from: /etc/zookeeper/conf/zoo.cfg\n2010-07-20 23:52:14,529 - INFO  [main:QuorumPeerConfig@287] - Defaulting to majority quorums\n2010-07-20 23:52:14,540 - INFO  [main:QuorumPeerMain@119] - Starting quorum peer\n2010-07-20 23:52:14,562 - INFO  [main:NIOServerCnxn$Factory@149] - binding to port 0.0.0.0/0.0.0.0:2181\n2010-07-20 23:52:14,578 - INFO  [main:QuorumPeer@818] - tickTime set to 2000\n2010-07-20 23:52:14,579 - INFO  [main:QuorumPeer@829] - minSessionTimeout set to -1\n2010-07-20 23:52:14,579 - INFO  [main:QuorumPeer@840] - maxSessionTimeout set to -1\n2010-07-20 23:52:14,579 - INFO  [main:QuorumPeer@855] - initLimit set to 10\n2010-07-20 23:52:14,798 - INFO  [main:FileSnap@82] - Reading snapshot /data/zookeeper/version-2/snapshot.2500197ee5\n2010-07-20 23:52:15,660 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.45.76:57030\n2010-07-20 23:52:15,661 - INFO  [Thread-1:QuorumCnxManager$Listener@436] - My election bind port: 3888\n2010-07-20 23:52:15,663 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@644] - Exception causing close of session 0x0 due to java.io.IOException: ZooKeeperServer not running\n2010-07-20 23:52:15,664 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1516] - Closed socket connection for client /10.209.45.76:57030 (no session established for client)\n2010-07-20 23:52:15,670 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:QuorumPeer@620] - LOOKING\n2010-07-20 23:52:15,672 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@649] - New election. My id =  1, Proposed zxid = 158915472832\n2010-07-20 23:52:15,674 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@689] - Notification: 1, 158915472832, 1, 1, LOOKING, LOOKING, 1\n2010-07-20 23:52:15,674 - INFO  [WorkerSender Thread:QuorumCnxManager@162] - Have smaller server identifier, so dropping the connection: (2, 1)\n2010-07-20 23:52:15,675 - INFO  [WorkerSender Thread:QuorumCnxManager@162] - Have smaller server identifier, so dropping the connection: (3, 1)\n2010-07-20 23:52:15,676 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@689] - Notification: 2, 158915472832, 5, 1, LOOKING, LOOKING, 2\n2010-07-20 23:52:15,676 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@689] - Notification: 3, 158915472832, 5, 1, LOOKING, LOOKING, 2\n2010-07-20 23:52:15,676 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@711] - Updating proposal\n2010-07-20 23:52:15,677 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@799] - Notification: 3, 158915472832, 5, 1, LOOKING, FOLLOWING, 2\n2010-07-20 23:52:15,677 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FastLeaderElection@689] - Notification: 3, 158915472832, 5, 1, LOOKING, LOOKING, 3\n2010-07-20 23:52:15,879 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:QuorumPeer@642] - FOLLOWING\n2010-07-20 23:52:15,885 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Learner@72] - TCP NoDelay set to: true\n2010-07-20 23:52:15,893 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:zookeeper.version=3.3.1-942149, built on 05/07/2010 17:14 GMT\n2010-07-20 23:52:15,893 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:host.name=sjc1k029.twitter.com\n2010-07-20 23:52:15,894 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.version=1.6.0_16\n2010-07-20 23:52:15,894 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.vendor=Sun Microsystems Inc.\n2010-07-20 23:52:15,894 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.home=/usr/java/jdk1.6.0_16/jre\n2010-07-20 23:52:15,894 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.class.path=/etc/zookeeper/conf::/usr/local/zookeeper/../zookeeper-*.jar:/usr/local/zookeeper/../lib/*.jar:/usr/local/zookeeper/../src/java/lib/*.jar:/usr/local/zookeeper/jline-0.9.94.jar:/usr/local/zookeeper/log4j-1.2.15.jar:/usr/local/zookeeper/zookeeper-3.3.2-dev.jar\n2010-07-20 23:52:15,895 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.library.path=/usr/java/jdk1.6.0_16/jre/lib/amd64/server:/usr/java/jdk1.6.0_16/jre/lib/amd64:/usr/java/jdk1.6.0_16/jre/../lib/amd64:/usr/java/packages/lib/amd64:/lib:/usr/lib\n2010-07-20 23:52:15,895 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.io.tmpdir=/tmp\n2010-07-20 23:52:15,895 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:java.compiler=<NA>\n2010-07-20 23:52:15,896 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:os.name=Linux\n2010-07-20 23:52:15,896 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:os.arch=amd64\n2010-07-20 23:52:15,896 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:os.version=2.6.18-164.6.1.el5\n2010-07-20 23:52:15,897 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:user.name=root\n2010-07-20 23:52:15,897 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:user.home=/root\n2010-07-20 23:52:15,897 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:user.dir=/\n2010-07-20 23:52:15,899 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:ZooKeeperServer@151] - Created server with tickTime 2000 minSessionTimeout 4000 maxSessionTimeout 40000 datadir /data/zookeeper/txlog/version-2 snapdir /data/zookeeper/version-2\n2010-07-20 23:52:15,911 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Learner@285] - Getting a snapshot from leader\n2010-07-20 23:52:16,152 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Learner@315] - Setting leader epoch 26\n2010-07-20 23:52:16,166 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:FileTxnSnapLog@208] - Snapshotting: 260000195d\n2010-07-20 23:52:16,200 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.21.181:49189\n2010-07-20 23:52:16,200 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1314] - Processing stat command from /10.209.21.181:49189\n2010-07-20 23:52:16,203 - INFO  [Thread-6:NIOServerCnxn@1516] - Closed socket connection for client /10.209.21.181:49189 (no session established for client)\n2010-07-20 23:52:16,446 - WARN  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Follower@116] - Got zxid 0x260000195e expected 0x1\n2010-07-20 23:52:16,446 - INFO  [SyncThread:1:FileTxnLog@197] - Creating new log file: log.260000195e\n2010-07-20 23:52:19,205 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.21.181:49192\n2010-07-20 23:52:19,205 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1314] - Processing stat command from /10.209.21.181:49192\n2010-07-20 23:52:19,206 - INFO  [Thread-7:NIOServerCnxn$StatCommand@1167] - Stat command output\n2010-07-20 23:52:19,208 - INFO  [Thread-7:NIOServerCnxn@1516] - Closed socket connection for client /10.209.21.181:49192 (no session established for client)\n2010-07-20 23:52:20,562 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.44.180:47281\n2010-07-20 23:52:20,564 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@782] - Client attempting to establish new session at /10.209.44.180:47281\n2010-07-20 23:52:20,574 - INFO  [CommitProcessor:1:NIOServerCnxn@1661] - Established session 0x129f245a01c0000 with negotiated timeout 10000 for client /10.209.44.180:47281\n2010-07-20 23:52:20,581 - INFO  [CommitProcessor:1:PrepRequestProcessor@69] - zookeeper.skipACL==\"yes\", ACL checks will be skipped\n2010-07-20 23:52:20,586 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@639] - EndOfStreamException: Unable to read additional data from client sessionid 0x129f245a01c0000, likely client has closed socket\n2010-07-20 23:52:20,587 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1516] - Closed socket connection for client /10.209.44.180:47281 which had sessionid 0x129f245a01c0000\n2010-07-20 23:52:20,826 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.48.78:52838\n2010-07-20 23:52:20,827 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@782] - Client attempting to establish new session at /10.209.48.78:52838\n2010-07-20 23:52:20,829 - INFO  [CommitProcessor:1:NIOServerCnxn@1661] - Established session 0x129f245a01c0001 with negotiated timeout 10000 for client /10.209.48.78:52838\n2010-07-20 23:52:20,832 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@639] - EndOfStreamException: Unable to read additional data from client sessionid 0x129f245a01c0001, likely client has closed socket\n2010-07-20 23:52:20,833 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1516] - Closed socket connection for client /10.209.48.78:52838 which had sessionid 0x129f245a01c0001\n2010-07-20 23:52:22,210 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.21.181:49197\n2010-07-20 23:52:22,210 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@1314] - Processing stat command from /10.209.21.181:49197\n2010-07-20 23:52:22,211 - INFO  [Thread-8:NIOServerCnxn$StatCommand@1167] - Stat command output\n2010-07-20 23:52:22,227 - INFO  [Thread-8:NIOServerCnxn@1516] - Closed socket connection for client /10.209.21.181:49197 (no session established for client)\n2010-07-20 23:52:22,551 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn$Factory@256] - Accepted socket connection from /10.209.45.104:42183\n2010-07-20 23:52:22,552 - INFO  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@782] - Client attempting to establish new session at /10.209.45.104:42183\n2010-07-20 23:52:22,554 - INFO  [CommitProcessor:1:NIOServerCnxn@1661] - Established session 0x129f245a01c0002 with negotiated timeout 10000 for client /10.209.45.104:42183\n2010-07-20 23:52:22,560 - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@639] - EndOfStreamException: Unable to read additional data from client sessionid 0x129f245a01c0002, likely client has closed socket\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-21T00:24:58.481+0000","updated":"2010-07-21T00:24:58.481+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12890513","id":"12890513","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"body":"Just to double-check, I'm really really sure the running jar was freshly built. For example, lsof says:\n\njava    4473 root  mem    REG              104,1  1012397  10092999 /usr/local/zookeeper/zookeeper-3.3.2-dev.jar\n\nYes, the version number is 3.3.2, but this was built from the 3.3.1 release.\n\nLooking in the log we see:\n\n2010-07-20 23:52:15,893 - INFO  [QuorumPeer:/0:0:0:0:0:0:0:0:2181:Environment@97] - Server environment:zookeeper.version=3.3.1-942149, built on 05/07/2010 17:14 GMT\n\nShould that say built this afternoon? I've double & tripled checked and believe this is a newly built jar. Looking in the tarball we don't see zookeeper-3.3.2-dev.jar until after building.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=traviscrawford","name":"traviscrawford","key":"traviscrawford","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=traviscrawford&avatarId=26745","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=traviscrawford&avatarId=26745","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=traviscrawford&avatarId=26745","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=traviscrawford&avatarId=26745"},"displayName":"Travis Crawford","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-21T00:36:31.140+0000","updated":"2010-07-21T00:36:31.140+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12890587","id":"12890587","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I realized that while working on the patch I removed a private modifier and forgot to add it back for the trunk patch, so I'm uploading an new patch. There is no other significant modification to the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-21T07:11:36.830+0000","updated":"2010-07-21T07:11:36.830+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12890588","id":"12890588","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Just in case will cancel and resubmit.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-21T07:12:09.547+0000","updated":"2010-07-21T07:12:09.547+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12891210","id":"12891210","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"looks great flavio! the only nit i have is that the test case assumes that s1 is not the leader. you might want to check that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-22T15:14:10.140+0000","updated":"2010-07-22T15:14:10.140+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12891236","id":"12891236","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Thank for reviewing, Ben. Resubmitting with the proposed fix.\n\nThanks for testing the patch, Travis. I don't really know why you're observing the wrong dates, though. Anyone else?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-22T16:40:51.046+0000","updated":"2010-07-22T16:40:51.046+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12891245","id":"12891245","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"+1 great job flavio! thanx for your help travis and vishal.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-22T17:08:05.987+0000","updated":"2010-07-22T17:08:05.987+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12891332","id":"12891332","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"I believe the problem found by Travis is a bug in the build for 3.3.1. If you d/l the latest release, patch it, and run \"ant jar\" this is included into the output:\n\nversion-info:\n     [java] All version-related parameters must be valid integers!\n     [java] Exception in thread \"main\" java.lang.NumberFormatException: For input string: \"2-dev\"\n     [java] \tat java.lang.NumberFormatException.forInputString(NumberFormatException.java:48)\n     [java] \tat java.lang.Integer.parseInt(Integer.java:458)\n     [java] \tat java.lang.Integer.parseInt(Integer.java:499)\n     [java] \tat org.apache.zookeeper.version.util.VerGen.main(VerGen.java:131)\n     [java] Java Result: 1\n\nthe build doesn't fail as the generated Version.java exists in the release, as a result you get the original Version.java, and therefore the old date.\n\nYou can see this better by doing a \"ant clean jar\", which will fail as the Version.java is cleaned by running ant clean. You can get around this\nproblem by running \"ant -Dversion=3.3.2 clean jar\" (a valid version string), after which you should see the current date in the log.\n\nI'll fix this in the next rel.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-22T21:05:53.311+0000","updated":"2010-07-22T21:05:53.311+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12891492","id":"12891492","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"Committed revision 966960.\nCommitted revision 966984.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-23T06:33:44.001+0000","updated":"2010-07-23T06:33:44.001+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12891559","id":"12891559","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in ZooKeeper-trunk #884 (See [http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/884/])\n    ZOOKEEPER-790. Last processed zxid set prematurely while establishing leadership (fpj via breed)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-23T11:23:24.293+0000","updated":"2010-07-23T11:23:24.293+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892421","id":"12892421","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"body":"It seems this patch introduces a bug: followers get synchronized with leader and start serving clients before leader startups its own zk instance. \nAs the result, when a follower forward request to the leader, for example session revalidation request, it fails because leader's sessionTracker is null.\n\nPreviously this was not the case because leader started its zk immediately after quorum peer is switched to LEADING state.\n\nSee attached log.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-26T19:23:00.812+0000","updated":"2010-07-26T19:23:00.812+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892442","id":"12892442","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"body":"Easy way to reproduce: \n* start 2 out of 3 peers\n* connect to the ensemble by zkCli.sh\n* shutdown a peer, wait a bit\n* start the peer\nDue to NPE (which is not seen in logs however) servers can't form a quorum, and client is unable to reconnect.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-26T20:01:52.033+0000","updated":"2010-07-26T20:01:52.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892478","id":"12892478","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi Flavio,\n\nApologies for not trying the patch sooner. I will  try out the patch soon (altough Sergey has pointed out a potential problem).\n\nI am still not conviced why the other two nodes that have formed the cluster are in LOOKING state? \nYou mentioned that - \"The notifications of 1 and 2 say looking because they have been queued at the time 1 and 2 were looking for a leader. That's not an issue\".\n\nHowever, in this case, we have failed a follower and not a leader. Why would failure of a follower cause the other two nodes (including the leader) to start looking for a leader?\nAm I missing something?\n\nThanks.\n-Vishal\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-26T21:26:54.051+0000","updated":"2010-07-26T21:26:54.051+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892516","id":"12892516","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks for pointing this issue out, Sergei. It sounds like the previous patch solved the issue discussed without making sure that the leader was ready to process messages when learner handlers started to read them in. This v2 patch does a number of things:\n\n# It moves the startup method to processAck. This way we make sure that start up the leader as soon as we have a quorum of acks for the newleader message;\n# It moves the initialization of the database in startup to a method startdata. There are two reasons for doing it. First, it didn't sound like a good idea to throw exceptions or catch exceptions in processAck, and they were only necessary because of the call to startup(). Second, the method startup() in ZooKeeperServer throws these exceptions because of loadData(), which is called separately in Leader.lead(), so it is not necessary to call it in processAck after hearing from a quorum; \n# It waits in LearnerHandler.run() until the leader ready before it starts the while(true) loop. I also had to receive an ack before executing the code to wait, otherwise the leader would never receive acks and form a quorum, thus causing the system to halt.\n\nTo get some feedback on the changes implemented in this patch, I have discussed them with Ben. Thanks, Ben! \n\nSergei, I would appreciate if you could give it a try, and if you could tell me if it works for you. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-26T22:40:23.242+0000","updated":"2010-07-26T22:40:23.242+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892520","id":"12892520","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Hi VIshal, Thanks for testing as well. The issue you mention about the LOOKING state, if I understand correctly, is not about the state of the server, but the state reported in the notification. \nIf so, then it happens because we always repeat the last message sent. Such duplicate messages cause what you have observed, but they are supposed to be harmless, in the sense that\nI do not expect them to lead to any inconsistency in the ZooKeeper service. Instead, it may only cause some periods in which some process believes incorrectly to be the leader, but again, \nthe service is robust to such scenarios. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-26T22:47:43.881+0000","updated":"2010-07-26T22:47:43.881+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892524","id":"12892524","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"The latest patch applies to both trunk and 3.3.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-26T22:52:15.514+0000","updated":"2010-07-26T22:52:15.514+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892526","id":"12892526","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Great catch Sergei, thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-26T22:53:26.924+0000","updated":"2010-07-26T22:53:26.924+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892528","id":"12892528","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Would be great to have a test for this latest change.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-26T23:00:31.045+0000","updated":"2010-07-26T23:00:31.045+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892536","id":"12892536","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"body":"Hey Flavio,\nPatch works ok: passes both manual testing and my unit test which was previously failing.\nIt looks conceptually correct, I'd give it +1 if I'd have such authority :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-26T23:15:50.189+0000","updated":"2010-07-26T23:15:50.189+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892542","id":"12892542","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"sergey,\n your +1 does count :). Also, can you please upload the testcase that was failing? It would be good to include the testcase with the patch as pat mentioned above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-26T23:32:14.734+0000","updated":"2010-07-26T23:32:14.734+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892715","id":"12892715","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"body":"The test that was failing was the test for r/o mode, so it wouldn't apply here.\n\nI've extracted necessary code from it and made it a test case in QuorumTest. It fails against current trunk but passes against latest patch. \n\nThis test case uses QuorumUtil which I also extracted from my r/o mode patch. I made it for convenient quorum testing, it's more handy than current QuorumBase, and I plan to make QuorumBase a special case of it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-27T10:46:44.613+0000","updated":"2010-07-27T10:46:44.613+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892721","id":"12892721","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"body":"btw, Flavio, there are a few lines with trailing whitespaces in your patch, fix them","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dorserg","name":"dorserg","key":"dorserg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey Doroshenko","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-27T10:57:24.913+0000","updated":"2010-07-27T10:57:24.913+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892763","id":"12892763","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Submitting a new patch right after.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-27T13:39:50.248+0000","updated":"2010-07-27T13:39:50.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892776","id":"12892776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks for providing a code base for the test, Sergey. I liked QuorumUtil so much that I have reimplemented the previous test to use it. This is in fact aligned with a discussion Ben and I had the other day about refactoring QuorumBase. You have introduced pretty much all functionality I was looking for, which simplified the test code. \n\nI hope you don't mind that I have made some modifications to your original test. My proposed modifications are to make sure that we induce the right set of events. In the modified version, I have made sure that we have a client connecting to a follower and that we kill the leader so that we force a new election. In fact, the test was not always reliable for me in its original form.\n\nThe patch works for me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-27T13:46:21.017+0000","updated":"2010-07-27T13:46:21.017+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892777","id":"12892777","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Need to generate a version for 3.3, but the one uploaded is ready to be reviewed for me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-27T13:47:51.051+0000","updated":"2010-07-27T13:47:51.051+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12892816","id":"12892816","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"body":"+1 excellent work you guys. i also like QuorumUtil sergey! thanx for implementing it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=breed","name":"breed","key":"breed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Benjamin Reed","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-07-27T15:16:23.033+0000","updated":"2010-07-27T15:16:23.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12893219","id":"12893219","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"flavio, the patch looks good. Any reason you have this code in learnerhandler?\n\n{code}\n@@ -475,6 +497,7 @@\n         } catch (IOException e) {\n             LOG.warn(\"Ignoring unexpected exception during socket close\", e);\n         }\n+        this.interrupt();\n         leader.removeLearnerHandler(this);\n     }\n \n{code}\n\nThe interrupt? Why is this necessary?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-28T15:53:18.314+0000","updated":"2010-07-28T15:54:20.548+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12893236","id":"12893236","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks for reviewing, Mahadev. The interrupt is necessary to guarantee that we will break this loop:\n\n{noformat}\n+            /*\n+             * Wait until leader starts up\n+             */\n+            synchronized(leader.zk){\n+                while(!leader.zk.isRunning()){\n+                    leader.zk.wait(500);\n+                }\n+            }\n{noformat}\n\nwhen shutting down the learner handler.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-28T16:24:46.280+0000","updated":"2010-07-28T16:24:46.280+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12893392","id":"12893392","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Fixed issue pointed out by Mahadev. Submitting patch for 3.3 first.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-28T22:12:45.983+0000","updated":"2010-07-28T22:12:45.983+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12893393","id":"12893393","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Now uploading trunk version.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2010-07-28T22:13:44.325+0000","updated":"2010-07-28T22:13:44.325+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12893776","id":"12893776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nI tested the patch and it works really well. I have a test that fails and restarts zookeeper server in a loop. I kept it going for 150 rounds and found no issues.\nThanks a lot.\n\n-Vishal","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-29T19:06:13.271+0000","updated":"2010-07-29T19:06:13.271+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12893816","id":"12893816","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"+1 the patch looks good. I will go ahead and commit it.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-29T21:01:54.728+0000","updated":"2010-07-29T21:01:54.728+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12893826","id":"12893826","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"I just committed this. thanks flavio and others!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-29T21:11:57.226+0000","updated":"2010-07-29T21:11:57.226+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467595/comment/12894000","id":"12894000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in ZooKeeper-trunk #890 (See [http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/890/])\n    ZOOKEEPER-790.  Last processed zxid set prematurely while establishing leadership (flavio via mahadev)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-30T10:51:40.026+0000","updated":"2010-07-30T10:51:40.026+0000"}],"maxResults":57,"total":57,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-790/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05zlz:"}}