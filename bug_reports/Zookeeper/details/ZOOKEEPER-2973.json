{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13135021","self":"https://issues.apache.org/jira/rest/api/2/issue/13135021","key":"ZOOKEEPER-2973","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-01-31T10:03:43.668+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Feb 02 07:59:29 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2973/watchers","watchCount":3,"isWatching":false},"created":"2018-01-31T08:45:14.390+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323310","id":"12323310","description":"Fix release against 3.4 branch","name":"3.4.6","archived":false,"released":true,"releaseDate":"2014-03-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-02-02T07:59:29.317+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"I am running a three node ZooKeeper cluster. At 2018-01-28 17:56:30,leader node has error log:\r\n\r\n2018-01-28 17:56:30 [UTC:20180128T175630+0800]|ERROR||LearnerHandler-/118.123.180.23:44836hread|Coordination > Unexpected exception causing shutdown while sock still open (LearnerHandler.java:633)\r\njava.io.IOException: Unreasonable length = 1885430131\r\n at org.apache.jute.BinaryInputArchive.readBuffer(BinaryInputArchive.java:95)\r\n at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:85)\r\n at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:103)\r\n at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:546)\r\n2018-01-28 17:56:30 [UTC:20180128T175630+0800]|WARN ||LearnerHandler-/118.123.180.23:44836hread|Coordination > ******* GOODBYE /118.123.180.23:44836 ******** (LearnerHandler.java:646)\r\n2018-01-28 17:56:30 [UTC:20180128T175630+0800]|INFO ||ProcessThread(sid:2 cport:-1):hread|Coordination > Got user-level KeeperException when processing sessionid:0x16138593ad43cf9 type:delete cxid:0x5 zxid:0xc104b59e9 txntype:-1 reqpath:n/a Error Path:/VSP/Leader/syncScore-0/_c_9101a3d6-f431-4792-b71d-a493e938895d-latch-0000093037 Error:KeeperErrorCode = NoNode for /VSP/Leader/syncScore-0/_c_9101a3d6-f431-4792-b71d-a493e938895d-latch-0000093037 (PrepRequestProcessor.java:645)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"\"Unreasonable length\" exception ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wanggang_123","name":"wanggang_123","key":"wanggang_123","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34043","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34043","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34043","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34043"},"displayName":"wanggang_123","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wanggang_123","name":"wanggang_123","key":"wanggang_123","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34043","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34043","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34043","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34043"},"displayName":"wanggang_123","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13135021/comment/16346522","id":"16346522","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuyiyun","name":"wuyiyun","key":"wuyiyun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"wuyiyun","active":true,"timeZone":"Asia/Shanghai"},"body":"I met this problem too, while i use open ssl capability on zookeeper server and zookeeper client. while i close ssl capability and will not cause this problem.\r\n\r\nyou can modify source of BinaryInputArchive like below and find what\r\n\r\npublic String readString(String tag) throws IOException {\r\n int len = in.readInt();\r\n if (len == -1) return null; \r\n \r\n checkLength(len);\r\n byte b[] = new byte[len];\r\n in.readFully(b); \r\n String tobeReturnString = new String(b, \"UTF8\");\r\n LOG.info(\"####################Just readString String's lengh=\"+len+\" and this string is:\"+tobeReturnString);\r\n \r\n return tobeReturnString;\r\n }\r\n \r\n static public final int maxBuffer = Integer.getInteger(\"jute.maxbuffer\", 0xfffff);\r\n\r\npublic byte[] readBuffer(String tag) throws IOException {\r\n int len = readInt(tag);\r\n if (len == -1) return null;\r\n checkLength(len);\r\n byte[] arr = new byte[len];\r\n in.readFully(arr); \r\n String tobeReturnString = new String(arr, \"UTF8\");\r\n LOG.info(\"####################Just readBuffer String's lengh=\"+len+\" and this string is:\"+tobeReturnString);\r\n return arr;\r\n }","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuyiyun","name":"wuyiyun","key":"wuyiyun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"wuyiyun","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-01-31T10:03:43.668+0000","updated":"2018-01-31T10:03:43.668+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13135021/comment/16346549","id":"16346549","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wanggang_123","name":"wanggang_123","key":"wanggang_123","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34043","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34043","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34043","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34043"},"displayName":"wanggang_123","active":true,"timeZone":"Etc/UTC"},"body":"你好，我这边的zookeeper，是偶现shutdown，你遇到的也是吗？\r\n\r\n这个问题的触发条件是什么啊？如何能够复现？","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wanggang_123","name":"wanggang_123","key":"wanggang_123","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34043","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34043","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34043","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34043"},"displayName":"wanggang_123","active":true,"timeZone":"Etc/UTC"},"created":"2018-01-31T10:18:43.466+0000","updated":"2018-01-31T10:18:43.466+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13135021/comment/16347842","id":"16347842","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuyiyun","name":"wuyiyun","key":"wuyiyun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"wuyiyun","active":true,"timeZone":"Asia/Shanghai"},"body":"Me too!. I met OutOfMemory error cause zookeeper shutdown. but you can add crontab task to restart zookeeper to resolve this issue. \r\n\r\nOf course, you should insure that zookeeper client jar has same version with zookeeper server firstly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuyiyun","name":"wuyiyun","key":"wuyiyun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"wuyiyun","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-01T01:01:14.114+0000","updated":"2018-02-01T01:01:14.114+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13135021/comment/16349900","id":"16349900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=beeflyme","name":"beeflyme","key":"beeflyme","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"caixiaofeng","active":true,"timeZone":"Etc/UTC"},"body":" I met OutOfMemory error cause zookeeper shutdown. and restart not ok.\r\n\r\n   1.   Maybe the client write too much too the ZooKeeper, which bigger than the  jute.maxbuffer\r\n\r\n  \r\n\r\nhttps://issues.apache.org/jira/browse/ZOOKEEPER-2101    Transaction larger than max buffer of jute makes zookeeper unavailable\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=beeflyme","name":"beeflyme","key":"beeflyme","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"caixiaofeng","active":true,"timeZone":"Etc/UTC"},"created":"2018-02-02T07:17:33.311+0000","updated":"2018-02-02T07:17:33.311+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13135021/comment/16349931","id":"16349931","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuyiyun","name":"wuyiyun","key":"wuyiyun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"wuyiyun","active":true,"timeZone":"Asia/Shanghai"},"body":"Yes, that is one reason and easy to resolve. But i know that even if i send  length of data just no more than one hundred byte, once enabled ssl capability, several hours later, just zookeeper leader node will get this exception.\r\n\r\n I met OutOfMemory error cause zookeeper shutdown. and restart not ok.\r\n\r\n   1.   Maybe the client write too much too the ZooKeeper, which bigger than the  jute.maxbuffer","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuyiyun","name":"wuyiyun","key":"wuyiyun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"wuyiyun","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-02T07:59:29.317+0000","updated":"2018-02-02T07:59:29.317+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2973/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3pl2n:"}}