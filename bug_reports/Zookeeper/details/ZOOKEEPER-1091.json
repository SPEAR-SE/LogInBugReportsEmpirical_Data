{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12509786","self":"https://issues.apache.org/jira/rest/api/2/issue/12509786","key":"ZOOKEEPER-1091","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314469","id":"12314469","description":"Kerberos client auth, multi support, deb/rpm pkging.","name":"3.4.0","archived":false,"released":true,"releaseDate":"2011-11-22"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2011-07-13T01:23:57.144+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Sep 23 01:17:10 UTC 2011","customfield_12310420":"2428","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_11113198849_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-10-16T18:21:22.624+0000","workratio":0,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1091/watchers","watchCount":3,"isWatching":false},"created":"2011-06-10T03:21:23.876+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":3600,"aggregatetimeoriginalestimate":3600,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315482","id":"12315482","description":"Fix release against 3.3 branch","name":"3.3.3","archived":false,"released":true,"releaseDate":"2011-02-27"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-23T19:22:30.401+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312381","id":"12312381","name":"java client","description":"The java client interface for ZooKeeper"}],"timeoriginalestimate":3600,"description":"if the chrootPath of ClientCnxn is not null and the Watches of zooKeeper is not null; and then for some reason(like zookeeper server stop and start), the zookeeper client will primeConnection to server again and tell server the watcher path,but the path is wrong,it show be serverpath but not clientpath;if the wrong watcher clientPath is sended to server,\nthe exception will occurr, the exceptions:\n\n2011-06-10 04:33:16,935 [pool-2-thread-30-SendThread(DB1-6:2181)] WARN  org.apache.zookeeper.ClientCnxn - Session 0x5302c4403a30232 for server DB1-6/192.168.1.6:2181, unexpected error, closing socket connection and attempting reconnect\njava.lang.StringIndexOutOfBoundsException: String index out of range: -6\n\tat java.lang.String.substring(String.java:1937)\n\tat java.lang.String.substring(String.java:1904)\n\tat org.apache.zookeeper.ClientCnxn$SendThread.readResponse(ClientCnxn.java:794)\n\tat org.apache.zookeeper.ClientCnxn$SendThread.doIO(ClientCnxn.java:881)\n\tat org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1130)\n ","customfield_10010":null,"timetracking":{"originalEstimate":"1h","remainingEstimate":"1h","originalEstimateSeconds":3600,"remainingEstimateSeconds":3600},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":3600,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32724","customfield_12312823":null,"summary":"when the chrootPath of ClientCnxn is not null and the Watches of zooKeeper is not null and the method primeConnection(SelectionKey k) of ClientCnxn Occurred again for some reason ,then the wrong watcher clientPath is sended to server","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=youming","name":"youming","key":"youming","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"zhangyouming","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=youming","name":"youming","key":"youming","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"zhangyouming","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":3600,"percent":0},"customfield_12311024":null,"environment":"Linux version 2.6.18-194.el5 (mockbuild@builder10.centos.org) (gcc version 4.1.2 20080704 (Red Hat 4.1.2-48)) #1 SMP Fri Apr 2 14:58:14 EDT 2010","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":3600,"percent":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12509786/comment/13064277","id":"13064277","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"body":"I am running in to this issue now as well.  It appears to me as though this is only a problem when running more than one zookeeper client per application instance where they have a chroot path that is multiple znodes deep.  Normally that is not a problem since I share the zookeeper client across many threads/services in the application.  However, I do have one use case where there is an administrative task that needs to span multiple zookeeper \"clusters\" that are partitioned by chroot.\n\nFor example I have two clusters of application nodes running under different zookeeper chroots -- say \"/blah/version1\" and \"/blah/version2\".  There are many application nodes in the \"version1\" cluster and many in the \"version2\" cluster.  These each use chroot to logically partition themselves and it works great.  Each application node holds a single zookeeper client.\n\nI also have an administrative node that is responsible for monitoring both of these clusters.  This node has two zookeeper clients one for each chroot'd cluster.  This works perfectly so long as I am not disconnected from the ensemble.  As soon as I get disconnected I start getting a flood of this StringIndexOutOfBoundsException.\n\nI can easily cause this to happen by having more than one zookeeper client in a single process where both zookeeper clients are using a chroot path that is multiple levels deep.  If I connect to a locally running standalone zookeeper server as soon as I stop and restart the zookeeper server I get this exception.  I have no problems with this test if I run only a single zookeeper client or I run with chroot paths that are only a single znode.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-13T01:23:57.144+0000","updated":"2011-07-13T01:23:57.144+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12509786/comment/13064292","id":"13064292","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thkoch","name":"thkoch","key":"thkoch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thkoch&avatarId=11540","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thkoch&avatarId=11540","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thkoch&avatarId=11540","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thkoch&avatarId=11540"},"displayName":"Thomas Koch","active":true,"timeZone":"Etc/UTC"},"body":"This sounds like a duplicate of ZOOKEEPER-961.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thkoch","name":"thkoch","key":"thkoch","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thkoch&avatarId=11540","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thkoch&avatarId=11540","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thkoch&avatarId=11540","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thkoch&avatarId=11540"},"displayName":"Thomas Koch","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-13T02:22:37.490+0000","updated":"2011-07-13T02:22:37.490+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12509786/comment/13064309","id":"13064309","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"body":"Ooof been a long day.  The fact that there are multiple znodes in the chroot is inconsequential.  The StringIndexOutOfBounds exception went away because my chroot string got shorter than the full path returned in the event.\n\nIn any case I believe the rest of my test is valid.  If there is a single instance that has multiple zookeeper clients connected to the same ensemble if they are completely disconnected then the paths in events can be messed up.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dlord","name":"dlord","key":"dlord","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Lord","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-13T02:55:22.069+0000","updated":"2011-07-13T02:55:22.069+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12509786/comment/13113092","id":"13113092","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mspycher","name":"mspycher","key":"mspycher","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthias Spycher","active":true,"timeZone":"America/Los_Angeles"},"body":"Thomas is right. One of the unit tests in the patch to ZOOKEEPER-961 verifies that the StringIndexOutOfBounds no longer occurs. Also, if any path from the server is too short for the current chroot, we no longer throw the exception. Instead a warning is issued and the raw path passed in the event.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mspycher","name":"mspycher","key":"mspycher","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthias Spycher","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-23T01:17:10.606+0000","updated":"2011-09-23T01:17:10.606+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1091/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05ypz:"}}