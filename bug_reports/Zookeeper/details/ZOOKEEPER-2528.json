{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12999795","self":"https://issues.apache.org/jira/rest/api/2/issue/12999795","key":"ZOOKEEPER-2528","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-08-24T21:58:57.778+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Aug 24 22:34:07 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2528/watchers","watchCount":2,"isWatching":false},"created":"2016-08-24T20:45:01.389+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326517","id":"12326517","description":"Fix release against 3.4 branch","name":"3.4.8","archived":false,"released":true,"releaseDate":"2016-02-22"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-03-09T20:39:38.031+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"ZooKeeper cluster can become unavailable if power failures happen at certain specific points in time. \n\nDetails:\n\nI am running a three-node ZooKeeper cluster. I perform a simple update from a client machine. \n\nWhen I try to update a value, ZooKeeper creates a new log file (for example, when the current log is fully utilized). First, it creates the file and appends some header information to the newly created log. The system call sequence looks like below:\n\ncreat(log.200000001)\nappend(log.200000001, offset=0,  count=16)\n\nNow, if a power failure happens just after the creat of the log file but before the append of the header information, the node simply crashes with an EOF exception. If the same problem occurs at two or more nodes in my three-node cluster, the entire cluster becomes unavailable as the majority of servers have crashed because of the above problem.  \n\nA power failure at the same time across multiple nodes may be possible in single data center or single rack deployment scenarios. \n\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ZooKeeper cluster can become unavailable due to power failures","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ramanala","name":"ramanala","key":"ramanala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ramnatthan Alagappan","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ramanala","name":"ramanala","key":"ramanala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ramnatthan Alagappan","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"A normal ZooKeeper cluster of 3 nodes running on 3 Linux machines. ","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12999795/comment/15435785","id":"15435785","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the report - do you have the stack trace from the EOF? That would simplify tracking this one down.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-24T21:58:57.778+0000","updated":"2016-08-24T21:58:57.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12999795/comment/15435844","id":"15435844","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ramanala","name":"ramanala","key":"ramanala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ramnatthan Alagappan","active":true,"timeZone":"Etc/UTC"},"body":"Hi Patrick,\nHere is the log of one server when it restarts from the crash I have mentioned in the initial description. I have slightly anonymized the actual directory names and actual server ips. \n\n2016-04-14 20:30:10,350 [myid:] - INFO  [main:QuorumPeerConfig@103] - Reading configuration from: /tmp/zoo2.cfg\n2016-04-14 20:30:10,364 [myid:] - INFO  [main:QuorumPeer$QuorumServer@149] - Resolved hostname: ip1 to address: /ip1\n2016-04-14 20:30:10,364 [myid:] - INFO  [main:QuorumPeer$QuorumServer@149] - Resolved hostname: ip3 to address: /ip3\n2016-04-14 20:30:10,364 [myid:] - INFO  [main:QuorumPeer$QuorumServer@149] - Resolved hostname: ip2 to address: /ip2\n2016-04-14 20:30:10,364 [myid:] - INFO  [main:QuorumPeerConfig@331] - Defaulting to majority quorums\n2016-04-14 20:30:10,367 [myid:1] - INFO  [main:DatadirCleanupManager@78] - autopurge.snapRetainCount set to 3\n2016-04-14 20:30:10,367 [myid:1] - INFO  [main:DatadirCleanupManager@79] - autopurge.purgeInterval set to 0\n2016-04-14 20:30:10,367 [myid:1] - INFO  [main:DatadirCleanupManager@101] - Purge task is not scheduled.\n2016-04-14 20:30:10,376 [myid:1] - INFO  [main:QuorumPeerMain@127] - Starting quorum peer\n2016-04-14 20:30:10,384 [myid:1] - INFO  [main:NIOServerCnxnFactory@89] - binding to port 0.0.0.0/0.0.0.0:2182\n2016-04-14 20:30:10,389 [myid:1] - INFO  [main:QuorumPeer@1019] - tickTime set to 2000\n2016-04-14 20:30:10,389 [myid:1] - INFO  [main:QuorumPeer@1039] - minSessionTimeout set to -1\n2016-04-14 20:30:10,389 [myid:1] - INFO  [main:QuorumPeer@1050] - maxSessionTimeout set to -1\n2016-04-14 20:30:10,389 [myid:1] - INFO  [main:QuorumPeer@1065] - initLimit set to 5\n2016-04-14 20:30:10,398 [myid:1] - INFO  [main:FileSnap@83] - Reading snapshot data_dir/version-2/snapshot.100000002\n2016-04-14 20:30:10,404 [myid:1] - ERROR [main:QuorumPeer@557] - Unable to load database on disk\njava.io.EOFException\n\tat java.io.DataInputStream.readInt(DataInputStream.java:392)\n\tat org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)\n\tat org.apache.zookeeper.server.persistence.FileHeader.deserialize(FileHeader.java:64)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.inStreamCreated(FileTxnLog.java:581)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.createInputArchive(FileTxnLog.java:600)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.goToNextLog(FileTxnLog.java:566)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:648)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.init(FileTxnLog.java:552)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.<init>(FileTxnLog.java:527)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog.read(FileTxnLog.java:354)\n\tat org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:132)\n\tat org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:223)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:510)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:500)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:153)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:111)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)\n2016-04-14 20:30:10,406 [myid:1] - ERROR [main:QuorumPeerMain@89] - Unexpected exception, exiting abnormally\njava.lang.RuntimeException: Unable to run quorum server \n\tat org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:558)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:500)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:153)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:111)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)\nCaused by: java.io.EOFException\n\tat java.io.DataInputStream.readInt(DataInputStream.java:392)\n\tat org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:63)\n\tat org.apache.zookeeper.server.persistence.FileHeader.deserialize(FileHeader.java:64)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.inStreamCreated(FileTxnLog.java:581)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.createInputArchive(FileTxnLog.java:600)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.goToNextLog(FileTxnLog.java:566)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:648)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.init(FileTxnLog.java:552)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.<init>(FileTxnLog.java:527)\n\tat org.apache.zookeeper.server.persistence.FileTxnLog.read(FileTxnLog.java:354)\n\tat org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:132)\n\tat org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:223)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:510)\n\t... 4 more\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ramanala","name":"ramanala","key":"ramanala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ramnatthan Alagappan","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-24T22:26:51.756+0000","updated":"2016-08-24T22:26:51.756+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12999795/comment/15435858","id":"15435858","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Hm, very interesting. Thanks [~ramanala]. Please take a look at ZOOKEEPER-1621 - iiuc based on the stack trace you just provided a patch is pending. Note it's slated for 3.5+ and not 3.4 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-08-24T22:34:07.609+0000","updated":"2016-08-24T22:35:40.023+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2528/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i32qxb:"}}