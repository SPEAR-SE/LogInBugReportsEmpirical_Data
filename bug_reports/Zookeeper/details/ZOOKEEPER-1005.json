{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12500063","self":"https://issues.apache.org/jira/rest/api/2/issue/12500063","key":"ZOOKEEPER-1005","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343268","id":"12343268","description":"Beta release against 3.5 branch","name":"3.5.5","archived":false,"released":false}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2011-03-01T20:31:52.548+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jun 15 06:58:42 UTC 2011","customfield_12310420":"2467","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1005/watchers","watchCount":3,"isWatching":false},"created":"2011-03-01T16:00:18.948+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314335","id":"12314335","description":"Fix release against 3.2 branch","name":"3.2.2","archived":false,"released":true,"releaseDate":"2009-12-14"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-10T20:09:07.533+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312379","id":"12312379","name":"quorum","description":"Quorum determination for ZooKeeper"}],"timeoriginalestimate":null,"description":"We were running 3 zookeeper servers, and simulated a failure on one of the servers. \n\nThe one zookeeper node follows the other, but has trouble connecting. It looks like the following exception is the cause:\n{noformat}\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 INFO [zookeeper] --  [org.apache.zookeeper.server.quorum.QuorumPeer] FOLLOWING\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 INFO [zookeeper] --  [org.apache.zookeeper.server.ZooKeeperServer] Created server\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 INFO [zookeeper] --  [org.apache.zookeeper.server.quorum.Follower] Following zookeeper3/192.168.131.11:2888\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 WARNING [zookeeper] --  [org.apache.zookeeper.server.quorum.Follower] Unexpected exception, tries=0\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 WARNING java.net.ConnectException: --  Connection refused\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 WARNING  --     at java.net.PlainSocketImpl.socketConnect(Native Method)\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 WARNING  --     at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:310)\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 WARNING  --     at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:176)\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 WARNING  --     at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:163)\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 WARNING  --     at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:384)\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 WARNING  --     at java.net.Socket.connect(Socket.java:546)\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 WARNING  --     at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:156)\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-60 WARNING  --     at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:549)\n{noformat}\nThe last exception while connecting was:\n{noformat}\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 ERR [zookeeper] --  [org.apache.zookeeper.server.quorum.Follower] Unexpected exception\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 ERR java.net.ConnectException: --  Connection refused\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 ERR  --     at java.net.PlainSocketImpl.socketConnect(Native Method)\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 ERR  --     at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:310)\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 ERR  --     at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:176)\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 ERR  --     at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:163)\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 ERR  --     at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:384)\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 ERR  --     at java.net.Socket.connect(Socket.java:546)\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 ERR  --     at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:156)\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 ERR  --     at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:549)\n2011-03-01T14:02:33+02:00 e0-cb-4e-65-4d-60 WARNING [zookeeper] --  [org.apache.zookeeper.server.quorum.Follower] Exception when following the leader\n{noformat}\n\nThe leader started leading a bit later \n{noformat}\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.quorum.FastLeaderElection] Notification: 0, 94489312534, 25, 2, LOOKING, LOOKING, 0\n2011-03-01T14:02:29+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.quorum.FastLeaderElection] Adding vote\n2011-03-01T14:02:32+02:00 e0-cb-4e-65-4d-7d WARNING [zookeeper] --  [org.apache.zookeeper.server.quorum.QuorumCnxManager] Cannot open channel to 1 at election address zookeeper2/192.168.132.10:3888\n2011-03-01T14:02:32+02:00 e0-cb-4e-65-4d-7d WARNING  --     at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:323)\n2011-03-01T14:02:50+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.quorum.QuorumPeer] LEADING\n{noformat}\n\nBut at that time the follower had already terminated and started a new election, so the leader failed:\n{noformat}\n2011-03-01T14:02:50+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.ZooKeeperServer] Created server\n2011-03-01T14:02:50+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.persistence.FileSnap] Reading snapshot /var/lib/zookeeper/version-2/snapshot.1600007d16\n2011-03-01T14:02:50+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.persistence.FileTxnSnapLog] Snapshotting: 1600007d16\n2011-03-01T14:02:53+02:00 e0-cb-4e-65-4d-7d WARNING [zookeeper] --  [org.apache.zookeeper.server.quorum.QuorumCnxManager] Cannot open channel to 1 at election address zookeeper2/192.168.132.10:3888\n2011-03-01T14:02:53+02:00 e0-cb-4e-65-4d-7d WARNING  --     at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:323)\n2011-03-01T14:02:53+02:00 e0-cb-4e-65-4d-7d WARNING  --     at org.apache.zookeeper.server.quorum.QuorumCnxManager.toSend(QuorumCnxManager.java:302)\n2011-03-01T14:02:53+02:00 e0-cb-4e-65-4d-7d WARNING  --     at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.process(FastLeaderElection.java:323)\n2011-03-01T14:02:53+02:00 e0-cb-4e-65-4d-7d WARNING  --     at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:296)\n2011-03-01T14:02:53+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.quorum.FastLeaderElection] Sending new notification.\n2011-03-01T14:03:11+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.quorum.FastLeaderElection] Sending new notification.\n2011-03-01T14:03:14+02:00 e0-cb-4e-65-4d-7d WARNING [zookeeper] --  [org.apache.zookeeper.server.quorum.QuorumCnxManager] Cannot open channel to 1 at election address zookeeper2/192.168.132.10:3888\n2011-03-01T14:03:14+02:00 e0-cb-4e-65-4d-7d WARNING  --     at org.apache.zookeeper.server.quorum.QuorumCnxManager.connectOne(QuorumCnxManager.java:323)\n2011-03-01T14:03:14+02:00 e0-cb-4e-65-4d-7d WARNING  --     at org.apache.zookeeper.server.quorum.QuorumCnxManager.toSend(QuorumCnxManager.java:302)\n2011-03-01T14:03:14+02:00 e0-cb-4e-65-4d-7d WARNING  --     at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.process(FastLeaderElection.java:323)\n2011-03-01T14:03:14+02:00 e0-cb-4e-65-4d-7d WARNING  --     at org.apache.zookeeper.server.quorum.FastLeaderElection$Messenger$WorkerSender.run(FastLeaderElection.java:296)\n2011-03-01T14:03:14+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.quorum.FastLeaderElection] Sending new notification.\n2011-03-01T14:03:32+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.quorum.FastLeaderElection] Sending new notification.\n2011-03-01T14:03:34+02:00 e0-cb-4e-65-4d-7d INFO [zookeeper] --  [org.apache.zookeeper.server.quorum.Leader] Shutdown called\n2011-03-01T14:03:34+02:00 e0-cb-4e-65-4d-7d INFO  --     at org.apache.zookeeper.server.quorum.Leader.shutdown(Leader.java:371)\n2011-03-01T14:03:34+02:00 e0-cb-4e-65-4d-7d INFO  --     at org.apache.zookeeper.server.quorum.Leader.lead(Leader.java:297)\n2011-03-01T14:03:34+02:00 e0-cb-4e-65-4d-7d INFO  --     at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:562)\n{noformat}\n\nFrom http://zookeeper.apache.org/doc/r3.2.2/zookeeperStarted.html:\n{quote}\nThe new entry, initLimit is timeouts ZooKeeper uses to limit the length of time the ZooKeeper servers in quorum have to connect to a leader\n{quote}\n\nSince we have initLimit=10 and tickTime=4000, we should have 40 seconds for a zookeeper server to contact the leader.\n\nHowever, in the source code src/java/main/org/apache/zookeeper/server/quorum/Follower.java:\n\n{noformat}\n152                 for (int tries = 0; tries < 5; tries++) {\n153                     try {\n154                         //sock = new Socket();\n155                         //sock.setSoTimeout(self.tickTime * self.initLimit);\n156                         sock.connect(addr, self.tickTime * self.syncLimit);\n157                         sock.setTcpNoDelay(nodelay);\n158                         break;\n159                     } catch (IOException e) {\n160                         if (tries == 4) {\n161                             LOG.error(\"Unexpected exception\",e);\n162                             throw e;\n163                         } else {\n164                             LOG.warn(\"Unexpected exception, tries=\"+tries,e);\n165                             sock = new Socket();\n166                             sock.setSoTimeout(self.tickTime * self.initLimit);\n167                         }\n168                     }\n169                     Thread.sleep(1000);\n170                 }\n{noformat}\n\nIt appears as if we only have 4 seconds to contact the leader. The timeouts are applied to the socket, but do not take into account that the zookeeper leader may not have started its zookeeper service yet. \n\nIs this the expected behaviour? Or is the expected behaviour that followers should always be able to connect to the leader?","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32775","customfield_12312823":null,"summary":"Zookeeper servers fail to elect a leader succesfully.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ahardy","name":"ahardy","key":"ahardy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexandre Hardy","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ahardy","name":"ahardy","key":"ahardy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexandre Hardy","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"zookeeper-3.2.2; debian","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500063/comment/13000928","id":"13000928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ahardy","name":"ahardy","key":"ahardy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexandre Hardy","active":true,"timeZone":"Etc/UTC"},"body":"I should note that several other failures were also simulated, with nodes replaced from time to time. But this particular issue seems to have prevented the zookeeper service from becoming available for a period of 2 hours. After 2 hours the quorum was reestablished and zookeeper recovered gracefully (at first glance).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ahardy","name":"ahardy","key":"ahardy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexandre Hardy","active":true,"timeZone":"Etc/UTC"},"created":"2011-03-01T16:01:52.459+0000","updated":"2011-03-01T16:01:52.459+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500063/comment/13001101","id":"13001101","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"Hi Alexandre,\n\nCan you attach the zookeeper logs and zoo.cfg files? Also, please describe your test in detail.\n\nI am not 100% sure whether it is a good idea to wait for 40 seconds as you suggested. Heres a scenario to think about:\nAssume that we have a slow follower instead of a slow leader. Before the follower enters the for loop in question, there is a change in leader. Now, when the follower attempts to connect to the peer that it thinks is a leader (the old leader), it will fail with the same error as you are seeing. In this case, it is not worth asking the follower to wait for 40 seconds in that loop. Currently, ZK does not  preempt a peer once it has exited leader election (and is either trying to be a leader or a follower).\n\nNote that there have been many fixes in leader election since ZK 3.2.2.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2011-03-01T20:31:52.548+0000","updated":"2011-03-01T20:31:52.548+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500063/comment/13001228","id":"13001228","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Alexandre, We do not assume that a follower must be able to connect to an elected leader. Since a process might crash at any time, there is the possibility that a process crashes right after being elected, so we don't want a follower waiting indefinitely on such leader.\n\nI don't understand how this problem of a follower timing out before the leader exercises its role leads to a 2-hour delay. If a connection from a leader to a follower times out, then the follower goes back to leader election, and a new leader is supposed to arise in a few seconds. \n\nAs Vishal pointed out, there has been some fixes to leader election and to the logic that connects a leader and it followers since 3.2.2. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-03-02T01:18:10.258+0000","updated":"2011-03-02T01:18:10.258+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500063/comment/13001305","id":"13001305","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ahardy","name":"ahardy","key":"ahardy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexandre Hardy","active":true,"timeZone":"Etc/UTC"},"body":"Hi Vishal,\n\n{quote}\nCan you attach the zookeeper logs and zoo.cfg files? Also, please describe your test in detail.\n{quote}\nUnfortunately our auto-installer process has reinstalled the nodes before I could get complete logs off the machines. I will attach the zoo.cfg shortly. \n\n{quote}\nI am not 100% sure whether it is a good idea to wait for 40 seconds as you suggested. Heres a scenario to think about:\nAssume that we have a slow follower instead of a slow leader. Before the follower enters the for loop in question, there is a change in leader. Now, when the follower attempts to connect to the peer that it thinks is a leader (the old leader), it will fail with the same error as you are seeing. In this case, it is not worth asking the follower to wait for 40 seconds in that loop. Currently, ZK does not preempt a peer once it has exited leader election (and is either trying to be a leader or a follower).\n{quote}\nI agree that the follower should not wait forever, and 40 seconds may be too long. But these settings can be configure in zoo.cfg. I also think that the fact that the leader takes so long to actually start the leader process is a problem (which should be addressed separately, and may be related to our particular failure simulation) and is a definite contributing factor to this issue. \n\nI am just surprised that the documentation indicates that follower should continue to attempt to connect to the leader for the time specified by {{initLimit}}, but that does not happen in this case. So the choice of initLimit is a worthy debate, but does not seem to change the fact that a follower should be trying to connect to leader until the initLimit time has elapsed (according to documentation). The timeout on the socket is set to {{self.tickTime * self.initLimit}} so this seems to indicate that the initLimit time is adhered to, but only in certain classes of failures.\n\n{quote}\nNote that there have been many fixes in leader election since ZK 3.2.2.\n{quote}\nWe are committed to zookeeper 3.2.2 for the moment, since we do not have sufficient resources to test a later zookeeper in time for inclusion in our next product release. We will be implementing other workarounds for the moment, but it seemed like a good idea to raise the issue and see whether this is the desired behavior.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ahardy","name":"ahardy","key":"ahardy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexandre Hardy","active":true,"timeZone":"Etc/UTC"},"created":"2011-03-02T06:35:00.898+0000","updated":"2011-03-02T06:35:00.898+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500063/comment/13001307","id":"13001307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ahardy","name":"ahardy","key":"ahardy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexandre Hardy","active":true,"timeZone":"Etc/UTC"},"body":"Hi Flavio,\n\n{quote}\nHi Alexandre, We do not assume that a follower must be able to connect to an elected leader. Since a process might crash at any time, there is the possibility that a process crashes right after being elected, so we don't want a follower waiting indefinitely on such leader.\n{quote}\nYes, I agree with that. My question in this case is not whether the follower should be waiting, but rather how long should the follower wait. It seems to me that the follower may be waiting for a shorter period of time than the documentation seems to indicate it should. Please see my response to Vishal's comment for details.\n\n{quote}\nI don't understand how this problem of a follower timing out before the leader exercises its role leads to a 2-hour delay. If a connection from a leader to a follower times out, then the follower goes back to leader election, and a new leader is supposed to arise in a few seconds.\n\n{quote}\nOnly two of the three zookeeper nodes were up. The follower did go back to leader election after which a new leader was elected with the same conditions as listed in the log entries above. So this cycle of election starts, leader chosen, follower fails to contact leader, leader terminates, election start ... repeated for a very long period of time until the leader eventually started its service in time for the follower to connect.\n\nI have no doubt that some other factor was influencing the leader, and preventing the leader from starting the leader service in a timely fashion. And yes, that has to be sorted out. I think we will be able to work around our problem, so an immediate fix is not the prime concern. At this point I am more interested in determining if this is the correct behavior.\n{quote}\n\n{quote}\nAs Vishal pointed out, there has been some fixes to leader election and to the logic that connects a leader and it followers since 3.2.2.\n{quote}\nUnfortunately we are committed to zookeeper 3.2.2 for the moment, due to our product release dates and available resources.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ahardy","name":"ahardy","key":"ahardy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexandre Hardy","active":true,"timeZone":"Etc/UTC"},"created":"2011-03-02T06:44:29.151+0000","updated":"2011-03-02T06:44:29.151+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500063/comment/13001460","id":"13001460","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"body":"{quote}\nI agree that the follower should not wait forever, and 40 seconds may be too long. But these settings can be configure in zoo.cfg. I also think that the fact that the leader takes so long to actually start the leader process is a problem (which should be addressed separately, and may be related to our particular failure simulation) and is a definite contributing factor to this issue.\n\nI am just surprised that the documentation indicates that follower should continue to attempt to connect to the leader for the time specified by initLimit, but that does not happen in this case. So the choice of initLimit is a worthy debate, but does not seem to change the fact that a follower should be trying to connect to leader until the initLimit time has elapsed (according to documentation). The timeout on the socket is set to self.tickTime * self.initLimit so this seems to indicate that the initLimit time is adhered to, but only in certain classes of failures.\n{quote}\n\nPer my understanding, the leader waits for tickTime * initLimit and gives up leadership if a majority of followers do not join the leader in that time. So I think the text is written from leader's perspective. The follower does not wait for that amount of time, but keeps trying to run leader election and then joins the leader. In your case, the follower was not able to join the leader after 5 attempts. The follower will start new a leader election, but that will not result in a new leader election round at the leader. The leader will wait for 40 seconds before giving up leadership. In the meantime, the follower will complete the second round of election, elect the same leader and again try to join the leader. I would expect that this process should complete soon (at least within 40 seconds of leader wait time).\n\nWithout logs it will be hard to pinpoint the problem. Can you also take a stack trace at the leader and the follower?\n\nCan you give details about your experiment (you mentioned you also replaced a node). Also, what is your SyncLimit? There have been some fixes in the code path in question (ZOOKEEPER-822 and ZOOKEEPER-900). Higher syncLimit values or failure of a node during leader election can cause significant delays without these fixes.\n\n\n\n    Note that there have been many fixes in leader election since ZK 3.2.2.\n\nWe are committed to zookeeper 3.2.2 for the moment, since we do not have sufficient resources to test a later zookeeper in time for inclusion in our next product release. We will be implementing other workarounds for the moment, but it seemed like a good idea to raise the issue and see whether this is the desired behavior.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vishalmlst","name":"vishalmlst","key":"vishalmlst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vishal Kher","active":true,"timeZone":"Etc/UTC"},"created":"2011-03-02T15:50:23.198+0000","updated":"2011-03-02T15:50:23.198+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500063/comment/13049657","id":"13049657","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"not a blocker. Moving it out of 3.4 release.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-15T06:58:42.119+0000","updated":"2011-06-15T06:58:42.119+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1005/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05z1b:"}}