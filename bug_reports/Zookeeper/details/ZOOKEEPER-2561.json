{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13003331","self":"https://issues.apache.org/jira/rest/api/2/issue/13003331","key":"ZOOKEEPER-2561","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326517","id":"12326517","description":"Fix release against 3.4 branch","name":"3.4.8","archived":false,"released":true,"releaseDate":"2016-02-22"}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2016-09-07 17:40:38.698","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2561/watchers","watchCount":1,"isWatching":false},"created":"2016-09-07T17:40:38.698+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12479693","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12479693","type":{"id":"10020","name":"Cloners","inward":"is cloned by","outward":"is a clone of","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10020"},"outwardIssue":{"id":"13003275","key":"ZOOKEEPER-2560","self":"https://issues.apache.org/jira/rest/api/2/issue/13003275","fields":{"summary":"Possible Cluster Unavailability","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-09-07T17:40:41.029+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"Possible Cluster Unvailability\n\nI am running a three node ZooKeeper cluster. Each node runs Linux. \n\nI see the below sequence of system calls when ZooKeeper appends a user data item to the log file.\n\n1 write(\"/data/version-2/log.200000001\", offset=65, count=12)\n2 write(\"/data/version-2/log.200000001\", offset=77, count=16323)\n3 write(\"/data/version-2/log.200000001\", offset=16400, count=4209)\n4 write(\"/data/version-2/log.200000001\", offset=20609, count=1)\n5 fdatasync(\"/data//version-2/log.200000001\")\n\nNow, a crash could happen just after operation 4 but before the final fdatasync. In this situation, the file system could persist the 4th operation and fail to persist the 3rd operation because of the crash and there is fsync in between them. In such cases, ZooKeeper server fails to start with the following messages in its log file:\n\n[myid:] - INFO  [main:QuorumPeerConfig@103] - Reading configuration from: /tmp/zoo2.cfg\n[myid:] - INFO  [main:QuorumPeer$QuorumServer@149] - Resolved hostname: 127.0.0.2 to address: /127.0.0.2\n[myid:] - INFO  [main:QuorumPeer$QuorumServer@149] - Resolved hostname: 127.0.0.4 to address: /127.0.0.4\n[myid:] - INFO  [main:QuorumPeer$QuorumServer@149] - Resolved hostname: 127.0.0.3 to address: /127.0.0.3\n[myid:] - INFO  [main:QuorumPeerConfig@331] - Defaulting to majority quorums\n[myid:1] - INFO  [main:DatadirCleanupManager@78] - autopurge.snapRetainCount set to 3\n[myid:1] - INFO  [main:DatadirCleanupManager@79] - autopurge.purgeInterval set to 0\n[myid:1] - INFO  [main:DatadirCleanupManager@101] - Purge task is not scheduled.\n[myid:1] - INFO  [main:QuorumPeerMain@127] - Starting quorum peer\n[myid:1] - INFO  [main:NIOServerCnxnFactory@89] - binding to port 0.0.0.0/0.0.0.0:2182\n[myid:1] - INFO  [main:QuorumPeer@1019] - tickTime set to 2000\n[myid:1] - INFO  [main:QuorumPeer@1039] - minSessionTimeout set to -1\n[myid:1] - INFO  [main:QuorumPeer@1050] - maxSessionTimeout set to -1\n[myid:1] - INFO  [main:QuorumPeer@1065] - initLimit set to 5\n[myid:1] - INFO  [main:FileSnap@83] - Reading snapshot /data/version-2/snapshot.100000002\n[myid:1] - ERROR [main:QuorumPeer@557] - Unable to load database on disk\njava.io.IOException: CRC check failed\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:635)\n\tat org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:158)\n\tat org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:223)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:510)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:500)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:153)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:111)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)\n2016-04-15 04:00:32,795 [myid:1] - ERROR [main:QuorumPeerMain@89] - Unexpected exception, exiting abnormally\njava.lang.RuntimeException: Unable to run quorum server \n\tat org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:558)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:500)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:153)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:111)\n\tat org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:78)\nCaused by: java.io.IOException: CRC check failed\n\tat org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:635)\n\tat org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:158)\n\tat org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:223)\n\tat org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:510)\n\t... 4 more\n\nThe same happens when the 3rd and 4th writes hit the disk but the 2nd operation does not. \n\nNow, two nodes of a three node cluster can easily reach this state, rendering the entire cluster unavailable. ZooKeeper, on recovery should be able to handle such checksum mismatches gracefully to maintain cluster availability.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"CLONE - Possible Cluster Unavailability","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=athy360","name":"athy360","key":"athy360","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Athyab Ameer","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=athy360","name":"athy360","key":"athy360","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Athyab Ameer","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Three node linux cluster","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2561/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i33cpz:"}}