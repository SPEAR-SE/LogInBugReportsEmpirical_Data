{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12606827","self":"https://issues.apache.org/jira/rest/api/2/issue/12606827","key":"ZOOKEEPER-1549","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343268","id":"12343268","description":"Beta release against 3.5 branch","name":"3.5.5","archived":false,"released":false}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2012-09-12T14:51:15.339+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Aug 08 20:54:37 UTC 2017","customfield_12310420":"242161","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1549/watchers","watchCount":20,"isWatching":false},"created":"2012-09-10T07:58:55.731+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12319288","id":"12319288","description":"Fix release against 3.4 branch","name":"3.4.3","archived":false,"released":true,"releaseDate":"2012-02-13"}],"issuelinks":[{"id":"12363692","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12363692","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12401266","key":"ZOOKEEPER-107","self":"https://issues.apache.org/jira/rest/api/2/issue/12401266","fields":{"summary":"Allow dynamic changes to server cluster membership","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-10T20:12:04.458+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312379","id":"12312379","name":"quorum","description":"Quorum determination for ZooKeeper"}],"timeoriginalestimate":null,"description":"the trunc code (from ZOOKEEPER-1154?) cannot work correct if the snapshot is not correct.\nhere is scenario(similar to 1154):\nInitial Condition\n1.\tLets say there are three nodes in the ensemble A,B,C with A being the leader\n2.\tThe current epoch is 7. \n3.\tFor simplicity of the example, lets say zxid is a two digit number, with epoch being the first digit.\n4.\tThe zxid is 73\n5.\tAll the nodes have seen the change 73 and have persistently logged it.\nStep 1\nRequest with zxid 74 is issued. The leader A writes it to the log but there is a crash of the entire ensemble and B,C never write the change 74 to their log.\nStep 2\nA,B restart, A is elected as the new leader,  and A will load data and take a clean snapshot(change 74 is in it), then send diff to B, but B died before sync with A. A died later.\nStep 3\nB,C restart, A is still down\nB,C form the quorum\nB is the new leader. Lets say B minCommitLog is 71 and maxCommitLog is 73\nepoch is now 8, zxid is 80\nRequest with zxid 81 is successful. On B, minCommitLog is now 71, maxCommitLog is 81\nStep 4\nA starts up. It applies the change in request with zxid 74 to its in-memory data tree\nA contacts B to registerAsFollower and provides 74 as its ZxId\nSince 71<=74<=81, B decides to send A the diff. \nProblem:\nThe problem with the above sequence is that after truncate the log, A will load the snapshot again which is not correct.\n\nIn 3.3 branch, FileTxnSnapLog.restore does not call listener(ZOOKEEPER-874), the leader will send a snapshot to follower, it will not be a problem.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12544953","id":"12544953","filename":"case.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-09-13T08:12:43.760+0000","size":5932,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12544953/case.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12567109","id":"12567109","filename":"ZOOKEEPER-1549-3.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-01-30T05:56:26.223+0000","size":136969,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12567109/ZOOKEEPER-1549-3.4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12563506","id":"12563506","filename":"ZOOKEEPER-1549-learner.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-06T23:27:43.098+0000","size":7721,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12563506/ZOOKEEPER-1549-learner.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"12708","customfield_12312823":null,"summary":"Data inconsistency when follower is receiving a DIFF with a dirty snapshot","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[{"id":"12610705","key":"ZOOKEEPER-1558","self":"https://issues.apache.org/jira/rest/api/2/issue/12610705","fields":{"summary":"Leader should not snapshot uncommitted state","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}},{"id":"12610706","key":"ZOOKEEPER-1559","self":"https://issues.apache.org/jira/rest/api/2/issue/12610706","fields":{"summary":"Learner should not snapshot uncommitted state","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}},{"id":"12736363","key":"ZOOKEEPER-2020","self":"https://issues.apache.org/jira/rest/api/2/issue/12736363","fields":{"summary":"Change TRUNC to SNAP in sync phase for safety guarantee ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13453882","id":"13453882","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"I've written a test case to reproduce it. I think we could delete the snapshot larger than the truncate zxid to solve the problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-09-12T10:16:23.072+0000","updated":"2012-09-12T10:16:23.072+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13454043","id":"13454043","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks for reporting this issue. I'm not sure your assessment is correct, though. If the problem you're mentioning really exists, then it seems wrong to me that A takes a snapshot including 74 without getting an acknowledgment from B. A needs to make sure that B has 74 before making the state final, and A is essentially committing 74 (without a quorum) by generating a snapshot that contains it. \n\nDeleting a snapshot sounds wrong to me, and I'd rather not do it even if it turns out to be a valid solution.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-09-12T14:51:15.339+0000","updated":"2012-09-12T14:51:15.339+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13454682","id":"13454682","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"Thanks for Falvio to comment. I agree with Falvio, deleting a snapshot is too dangerous to be an optional. There should be another solution.\nStep 1\n74 is in A's transaction logs.\nStep 2\nA is the new leader, and it will execute the following code.\n{noformat}\nvoid lead() throws IOException, InterruptedException {\n        self.end_fle = System.currentTimeMillis();\n        LOG.info(\"LEADING - LEADER ELECTION TOOK - \" +\n              (self.end_fle - self.start_fle));\n        self.start_fle = 0;\n        self.end_fle = 0;\n\n        zk.registerJMX(new LeaderBean(this, zk), self.jmxLocalPeerBean);\n\n        try {\n            self.tick = 0;\n            zk.loadData();\n{noformat}\nThen A will load its snapshot and committedlog.\n{noformat}\n    public void loadData() throws IOException, InterruptedException {\n        setZxid(zkDb.loadDataBase());\n        // Clean up dead sessions\n        LinkedList<Long> deadSessions = new LinkedList<Long>();\n        for (Long session : zkDb.getSessions()) {\n            if (zkDb.getSessionWithTimeOuts().get(session) == null) {\n                deadSessions.add(session);\n            }\n        }\n        zkDb.setDataTreeInit(true);\n        for (long session : deadSessions) {\n            // XXX: Is lastProcessedZxid really the best thing to use?\n            killSession(session, zkDb.getDataTreeLastProcessedZxid());\n        }\n\n        // Make a clean snapshot\n        takeSnapshot();\n    }\n{noformat}\nwhen A takeSnapshot(), 74 is in it(if A dies after that, B will never know it). When A load database,\n{noformat}\n    public void loadData() throws IOException, InterruptedException {\n        setZxid(zkDb.loadDataBase());\n{noformat}\nit will restore database from snapshots and transaction logs,\n{noformat}\nlong zxid = snapLog.restore(dataTree,sessionsWithTimeouts,listener);\n{noformat}\n{noformat}\n            try {\n                processTransaction(hdr,dt,sessions, itr.getTxn());\n            } catch(KeeperException.NoNodeException e) {\n               throw new IOException(\"Failed to process transaction type: \" +\n                     hdr.getType() + \" error: \" + e.getMessage(), e);\n            }\n            listener.onTxnLoaded(hdr, itr.getTxn());\n{noformat}\nbut 74 is in A's transaction logs. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-09-13T06:22:04.010+0000","updated":"2012-09-13T06:22:04.010+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13454715","id":"13454715","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"a testcase","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-09-13T07:49:42.145+0000","updated":"2012-09-13T07:49:42.145+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13463720","id":"13463720","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"Flavio Junqueira, any suggestion to this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-09-26T11:27:45.053+0000","updated":"2012-09-26T11:27:45.053+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13463725","id":"13463725","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Jacky007, I'm sorry, I missed your comment. I'll have a look at it shortly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-09-26T11:41:51.375+0000","updated":"2012-09-26T11:41:51.375+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13464264","id":"13464264","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I'm not done with my analysis yet, but my understanding is that B (leader) should be sending a TRUNC message to A (prospective follower), since this predicate (prevProposalZxid < peerLastZxid) in LearnerHandler holds for the scenario described. Process A however should fail because it can't truncate. \n\nTaking a snapshot this early in the lead() method does not sound like the right thing to do, since the leader does not have quorum support yet.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-09-26T22:58:34.294+0000","updated":"2012-09-26T22:58:34.294+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13464555","id":"13464555","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"Proposal which have quorum support will be wrote to memory database normally. When a server start, all proposals will be write to memory(this may be the root of the problem), correctness is based on the hypothesis that those proposals don't have quorum support will be truncated before the server provides service.\n\nIf we can not guarantee that all data in memory has quorum support in the start-up procedure, we should guarantee that taking a dirty snapshot will never happen.\n\nWhich means taking a snapshot when the prospective follower receiving a UPTODATE message is also wrong.\n\nWhen the prospective leader has a quorum set ACK for UPTODATE, it can take a snapshot. But the prospective follow will never know such things in the start-up procedure.\n\nSo the prospective follower can not take a snapshot here.\n\n{noformat}\n                case Leader.UPTODATE:\n                    zk.takeSnapshot();\n{noformat}\n\n Is it really indispensability here?\n\nWhat is the motivation of taking a snapshot in the lead() method?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-09-27T08:45:15.067+0000","updated":"2012-09-27T08:45:15.067+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13464558","id":"13464558","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"bq. If we can not guarantee that all data in memory has quorum support in the start-up procedure, we should guarantee that taking a dirty snapshot will never happen.\n\nAgreed, that's the point I tried to make before. Taking a snapshot over state that includes uncommitted transactions does not sound right. \n\nbq. Which means taking a snapshot when the prospective follower receiving a UPTODATE message is also wrong.\n\nA follower can only take a snapshot once it learns that it has all been committed.\n\nbq. What is the motivation of taking a snapshot in the lead() method?\n\nI don't think it is there for correctness. Frequent snapshots are good to reduce the time to recover and it sounds reasonable to take a snapshot when starting a new epoch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-09-27T09:02:08.816+0000","updated":"2012-09-27T09:02:08.816+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13465725","id":"13465725","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I was thinking that it would be ok to remove that takeSnapshot() call from loadData(). It is incorrect as we have been discussing, and it doesn't seem to break anything, although a couple of tests failed when I gave it a try. I haven't looked at the reasons for the tests to fail; I'll do it next.\n\n[~fanster.z] Which version of ZooKeeper are you using? The case I see in trunk looks like this:\n\n{noformat}\ncase Leader.UPTODATE:\n                    if (!snapshotTaken) { // true for the pre v1.0 case\n                        zk.takeSnapshot();\n                        self.setCurrentEpoch(newEpoch);\n                    }\n{noformat} \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-09-28T16:48:02.995+0000","updated":"2012-09-28T17:00:53.359+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13466111","id":"13466111","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"Sorry, the code is from 3.3.x branch. Could you tell me which jira is for the above change?\n\nIn 3.4.3, taking snapshot when the prospective follower receives a NEWLEADER message sounds not right.\nI think we should do that the prospective follower receives a UPTODATE message, since data has quorum support yet.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-09-29T04:54:35.272+0000","updated":"2012-09-29T04:54:35.272+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13468815","id":"13468815","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"bq. Could you tell me which jira is for the above change?\n\nI believe it was in the patch for this jira ZOOKEEPER-1282.\n\nbq. I think we should do that the prospective follower receives a UPTODATE message, since data has quorum support yet.\n\nI'm no sure what you're proposing here. My proposal is still that we remove the call to takeSnapshot in loadData. Do you see a problem with doing it?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-10-03T20:43:05.651+0000","updated":"2012-10-03T20:43:05.651+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13471397","id":"13471397","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi Flavio Junqueira, I'm sorry, I had a long holiday and didn't reply. https://issues.apache.org/jira/browse/ZOOKEEPER-1558 looks good to me.\nBut https://issues.apache.org/jira/browse/ZOOKEEPER-1559 seems rather complicated. If we move the zk.takeSnapshot() method to UPTODATE, it will break Zab1.0 Phase2.4. \n\nLearner should not snapshot uncommitted state before it have a  quorum support, but if Learner does not snapshot, the uncommitted state will never have a quorum support since it does not have persistent storage. If Learner does, then it need some features as deleting snapshot unwanted, then we go back to the origin.\n\nAny ideas?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-10-08T04:39:34.345+0000","updated":"2012-10-08T04:39:34.345+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13473751","id":"13473751","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"If we let the leader know what zxid is considered committed by the majority of the quorum (we have this information as part of the leader election process). Then, we just need to truncate the leader's txn log to that zxid before starting it.  \n\nIn this case, we don't have to worry that we might have uncommitted txns in the snapshot in both the leader and the follower.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-11T01:09:16.482+0000","updated":"2012-10-11T01:09:16.482+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13473912","id":"13473912","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"{quote}\nThen, we just need to truncate the leader's txn log to that zxid before starting it.\n{quote}\nWe can not do that for consistency issues.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-10-11T07:32:20.676+0000","updated":"2012-10-11T07:32:20.676+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13473917","id":"13473917","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"bq. Then, we just need to truncate the leader's txn log to that zxid before starting it.\n\nAlso, we can't truncate a snapshot. We only truncate a suffix of the transaction log.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-10-11T07:42:44.086+0000","updated":"2012-10-11T07:42:44.086+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13474438","id":"13474438","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Can you explain a bit more about consistency issue? If we taking the snapshot correctly, the uncommitted txn should never be in the snapshot when a participant is elected as a leader, so we can truncate uncommitted txns from its txnlog.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-11T19:03:27.669+0000","updated":"2012-10-11T19:03:27.669+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13474737","id":"13474737","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"A B C D E, A propose v, B C accept it, then A B died. C is elected as the new leader. We cannot discard the proposal v.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-10-12T02:27:05.621+0000","updated":"2012-10-12T02:27:05.621+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13474756","id":"13474756","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the explanation. Since, we cannot differentiate between committed and uncommitted txn, so we have to treat all of them as committed. However, because we don't do quorum voting on these txns, we ran into problem that we are snapshotting with uncommitted state.  \n\nDoes this suggest that we really need is to do another quorum voting on these grey txns? If we don't, then we have to make the current follower sync-up behave like voting. \n\nDuring normal operation, follower vote by writing to txnlog. If the quorum fail, we can truncate the log to abort that txn. However, during sync-up via snapshot, we cannot about the txn unless we remove the snapshot. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-12T03:25:34.095+0000","updated":"2012-10-12T03:25:34.095+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13474893","id":"13474893","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I don't think major changes are needed, at least for the leader case. We simply shouldn't be taking snapshots over uncommitted state. Check ZOOKEEPER-1558 and ZOOKEEPER-1559, subtasks of this jira.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-10-12T08:43:51.925+0000","updated":"2012-10-12T08:44:34.020+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13492075","id":"13492075","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"This may require more changes, but it based on that the 2 ideas\n\n1. We should never let uncommitted changes reach DataTree so we don't have to worry about snapshot have uncommitted stage.\n2. Follower need to log uncommitted txn sent by the leader to its txnlog during synchronization. This mimic quorum voting and guarantee correctness.\n\nHere is how we may implement it:   \n\nBefore leader start serving request, there is no need for the leader to replay its txnlog at all. It only need to know the latest zxid in order to be elected as a leader and synchronize with the follower. The leader need to send uncommitted txns before sending NEWLEADER packet. Even if a follower request a snapshot, it won't get uncommitted txn as part of the snapshot. Then, the follower need to log the steam of txns between DIFF/SNAP and NEWLEADER to disk before sending ACK back to the leader. When the leader receive majority of ACK, then it can apply the uncommitted txn and start serving request. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-11-07T02:31:51.598+0000","updated":"2012-11-07T02:31:51.598+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13492712","id":"13492712","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"[~thawan] If I understand your proposal, it sounds like it works. All we need to guarantee is that a quorum has persisted and acknowledged each transaction the leader has reflected in its initial state. But, I'm not convinced that it is worth changing the way we currently do it. It achieves the same goal and the one thing we need to fix is that we can't snapshot state that contains uncommitted transactions. One particular issue with changing the requests to snapshot during recovery is that we have some code involving snapshots that is there for backward compatibility (see ZOOKEEPER-1559). I haven't been able to look closely at ZOOKEEPER-1559, though.  \n\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-11-07T21:18:41.349+0000","updated":"2012-11-07T21:18:41.349+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13493722","id":"13493722","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"I agree that your current solution works in the leader side, but I am not sure how you plan to fix the problem on the learner side. \n\nEven if we only need to consider Zap1.0 protocol. The learner need to commit its state (and history) when it receive NEWLEADER packet and send ACK back to the LEADER. However, we cannot write take the snapshot now since it may contain uncommitted state. Are we going to take the snapshot after getting UPTODATE from the leader instead?  \n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-11-09T03:57:46.437+0000","updated":"2012-11-09T03:57:46.437+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13531205","id":"13531205","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"[~thawan] I'm sorry for not getting back to this before. I've been investigating this issue on and off, though. After thinking more carefully about the problem, your rough plan seems good to me. The key point there is that no snapshot should contain uncommitted state, but we can't actually avoid having followers saving a snapshot to disk because they need to persist the txns they have accepted. We also can't discard snapshots, since we could be discarding implicitly transactions that the follower has accepted. \n\nTo review how I believe we need to do this, there are now three possibilities for what a follower can get (ignoring requests to truncate):\n\n# A diff of txns;\n# A snapshot of the leader state;\n# A snapshot + a diff.\n\nThe first two are part of the protocol today, but the third is not. One way is to create a new message. Another way, which seems good to me right now, is to collapse 2 and 3. On the follower side, we can save any snapshot it receives right away, since we are assuming that any snapshot contains only committed state. If there are more transactions, then it receives and logs them. It is ok to apply them to the data tree if we guarantee that we won't have snapshots until we receive the UPTODATE message (an acknowledgement that the leader has enough support).\n\nLet me know your thoughts, please.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-12-13T17:19:40.672+0000","updated":"2012-12-13T17:19:40.672+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13537706","id":"13537706","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"The problem is when follower receives a snapshot from leader, it must ack to leader after taks a snapshot(no txnlog).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-12-21T06:09:15.118+0000","updated":"2012-12-21T06:09:15.118+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13537708","id":"13537708","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"{quote}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-12-21T06:14:46.193+0000","updated":"2012-12-21T06:14:46.193+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13537709","id":"13537709","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"I think Flavio says is the same to Thawan Kooburat.\n{quote}\nBefore leader start serving request, there is no need for the leader to replay its txnlog at all. It only need to know the latest zxid in order to be elected as a leader and synchronize with the follower. The leader need to send uncommitted txns before sending NEWLEADER packet. Even if a follower request a snapshot, it won't get uncommitted txn as part of the snapshot. Then, the follower need to log the steam of txns between DIFF/SNAP and NEWLEADER to disk before sending ACK back to the leader. When the leader receive majority of ACK, then it can apply the uncommitted txn and start serving request.\n{quote}\nThe problem is the leader can only send a oold snapshot to the follower, related to snapShot. or we should save lastProcessedZxid.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-12-21T06:25:59.747+0000","updated":"2012-12-21T06:25:59.747+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13538249","id":"13538249","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"\nbq. I think Flavio says is the same to Thawan Kooburat.\n\nI had agreed that [~thawan] was good already and I just added more detail about the changes to the protocol. One important change is that a follower may receive a combination of a snapshot and transactions. Right now in trunk, it is either a snapshot or a diff.\n\nbq. The problem is the leader can only send a oold snapshot to the follower, related to snapShot. or we should save lastProcessedZxid.\n\nThe leader sends the latest snapshot it has and a suffix, potentially not empty, of uncommitted transactions. It doesn't matter if the snapshot is old as long as it only contains committed state. I don't a reason for saving lastProcessedZxid. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-12-21T17:55:11.884+0000","updated":"2012-12-21T17:55:11.884+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13538284","id":"13538284","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm not sure if it's related but I've gotten two reports now from 3.4.4/3.4.5 users that have seen corrupted clusters. \n\nIn one case the user had over 3000 leader elections (virtualized environment), ended up with an ephemeral that was owned by a \"gone\" session on one of the 3 servers. The other 2 servers had the znode but it was owned by an active session.\n\nIn the other case there were around 50 leader elections, ended up with 4 of 5 servers with /foo and the fifth didn't have /foo at all.\n\nIt would be great if we could prioritize this and put out a 3.4.6 release asap.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-12-21T18:37:30.463+0000","updated":"2012-12-21T18:37:30.463+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13538662","id":"13538662","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"I don't think there is a need to create a new message to mark a new type of synchronization (SNAP+DIFF).If the follower sees any proposal between SNAP and NEWLEADER, it just need to log the proposals and only apply them after it see UPTODATE or the leader can explicitly send COMMIT of each of the proposal after it get NEWLEADER_ACK from the follower.  Similar logic is already exists for any txns that comes between SNAP and UPTODATE so it won't be much more work.  \n\nHere is 2 main reasons why I prefer this approach.\n1. The follower should not take a snapshot after UPTODATE.  Since the leader already switch to use syncLimit timeout (+ tick counting) after UPTODATE is sent. In your proposal, the leader may tear down the quorum if syncLimit is not long enough to cover snapshotting time.\n\n2. We have several features (Read-only observer, replacing DataTree with key-value store) that we are planning to push upstream. These features relied on the assumption that any request passed the commit processor or reached the DataTree is considered committed. I will create JIRAs describing these features\n\nWith this approach, I think the more complicate part is on the leader side. Since it need to hold uncommitted txns in memory and only apply them it get NEWLEADER_ACK from the follower. \n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-12-22T04:18:06.903+0000","updated":"2012-12-22T04:18:06.903+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13538933","id":"13538933","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"I wanted to try and look at this but the test case provided doesn't replicate for me in the 3.4 branch. Is this something that will fail regularly or intermittently? I've run it several times now with no luck in replicating.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-22T22:40:38.469+0000","updated":"2012-12-22T22:40:38.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13538952","id":"13538952","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Ok I agree with all the great analysis you guys have done and think the proposed solution makes sense. The devil will be in writing a reproducible test case for this madness. Is anyone working on doing that?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-23T02:22:29.476+0000","updated":"2012-12-23T02:22:29.476+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13539015","id":"13539015","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Two points that are critical here for the correctness of the protocol is that the state is persisted in the right order and that the follower changes its current epoch when it has accepted the state of the leader is proposing. It is fine (and necessary even) to persist the transactions that the follower accepts, but as we have discussed already, they can't be part of a snapshot if they haven't been committed. Note that it is ok for a follower to accept these transactions even if it loses its connection to the prospective leader.\n\n[~thawan]\nbq. In your proposal, the leader may tear down the quorum if syncLimit is not long enough to cover snapshotting time.\n\nI'm not exactly sure of what part of the proposal you're referring to here, but if the follower does not receive a complete snapshot it should throw it away. In the case the snapshot is received fully but the subsequent diff isn't, it is still fine to persist the snapshot as long as the snapshot doesn't contain uncommitted state.\n\n[~fournc]\nbq. I wanted to try and look at this but the test case provided doesn't replicate for me in the 3.4 branch.\n\nInteresting, it does reproduce for me on trunk, reliably.\n\nbq. The devil will be in writing a reproducible test case for this madness.\n\nThere are possibly multiple ways of getting a dirty snapshot. I don't think a single test will cover all possibilities.  \n\nbq. Is anyone working on doing that?\nI have written no code so far, aside from doing a few tests with removing calls to take a snapshot here and there. I don't know if [~thawan] has written any code. \n\n[~thawan] are you interested in working on/providing a patch? Otherwise, I can work on it.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-12-23T10:36:39.850+0000","updated":"2012-12-23T10:36:39.850+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13539047","id":"13539047","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"body":"Yeah just tried it against trunk as well and it doesn't repro there either for me. I think some sort of testing in the Zab1_0Test model would be good. The more reproducible the better.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fournc","name":"fournc","key":"fournc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Camille Fournier","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-23T16:09:10.805+0000","updated":"2012-12-23T16:09:10.805+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13539075","id":"13539075","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I have actually produced a patch to solve the issue initially spotted in this jira and uploaded it to ZOOKEEPER-1558. That patch only partially solves the issue after all the discussion and analysis. In that patch, I have also moved the test to Zab1_0Test. \n\nThe patch was stale, though, so I have just uploaded a new one that applies to trunk. I'm sorry for stating the obvious, but only apply the test changes to make sure that the test fails. It should fail reliably.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-12-23T19:05:31.498+0000","updated":"2012-12-23T19:05:31.498+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13539134","id":"13539134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Regarding the syncLimit, I was referring to this logic in the leader which is not part of Zab protocol but it is used to ensure that failure is detected in a timely fashion. We need to make sure that the follower start communicating within syncLimit after it get UPTODATE packet.   \n{code}\n              if (!tickSkip && !self.getQuorumVerifier().containsQuorum(syncedSet)) {\n                //if (!tickSkip && syncedCount < self.quorumPeers.size() / 2) {\n                    // Lost quorum, shutdown\n                  // TODO: message is wrong unless majority quorums used\n                    shutdown(\"Only \" + syncedSet.size() + \" followers, need \"\n                            + (self.getVotingView().size() / 2));\n                    // make sure the order is the same!\n                    // the leader goes to looking\n                    return;\n              }\n{code}\n\nNot sure if it is reasonable to treat this as a blocker issue given the current release timeline for 3.5.0 and the amount of changes needed to fix this one. I am happy to help on the leader part.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-12-24T00:25:48.240+0000","updated":"2012-12-24T00:25:48.240+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13540043","id":"13540043","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"[~thawan] Ok, I got a better clue of what you're referring to with the syncLimit comment, but I'm not there yet. syncLimit has always been a parameter that limits the amount of time a follower can take to catch up, so I'm not proposing any change to the semantics of syncLimit, just to make it clear.\n\nAbout having it for 3.5.0, I suggest we make it a blocker for 3.5.0. If necessary, I also suggest we delay the release to have it in, although certainly not ideal. \n\nGiven that we will be creating a new branch (3.5), I suppose that we don't need to have some of the backward-compatibility stuff that we currently have in the code to make sure that 3.3 servers talk to 3.4. servers, yes? Perhaps this is a question for [~phunt].\n\nIt would be awesome if you could work on the leader part. I think the only tricky part on the follower side is making sure that everything is persisted at the right time, but I don't think that we will need major code changes. If you can work on both, I'm happy to be the reviewer of your code, and otherwise I can work on the follower part and we review each other's patches. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2012-12-27T17:09:01.106+0000","updated":"2012-12-27T17:09:01.106+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13545524","id":"13545524","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"This is a preliminary patch with the changes I'd like to make on the learner side. It simplifies the code in syncWithLeader a lot, since I assume we are able to remove the whole backward compatibility machinery when moving to 3.5.0. \n\nI have also left code commented out just to illustrate what I have in mind. If it is correct, I can remove them for the final patch.\n\nIt would be great to get some comments on the direction, but keep in mind that this is still preliminary, so I don't recommend anyone to try to run it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-06T23:27:43.101+0000","updated":"2013-01-06T23:27:43.101+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13553314","id":"13553314","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Any update/comments on this? We should really cut a 3.4.6 asap that includes a fix for this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-01-15T00:17:24.449+0000","updated":"2013-01-15T00:17:24.449+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13553378","id":"13553378","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"I will have time to work on it this week. I will try to post an initial version soon. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-01-15T01:19:04.040+0000","updated":"2013-01-15T01:19:04.040+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13553574","id":"13553574","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"body":"Thanks [~thawan]!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mahadev","name":"mahadev","key":"mahadev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mahadev konar","active":true,"timeZone":"Etc/UTC"},"created":"2013-01-15T07:43:11.919+0000","updated":"2013-01-15T07:43:11.919+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13553971","id":"13553971","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"In the spirit of coordination, I have posted a preliminary patch with some changes I believe we should be doing on the learner side. I was waiting for comments and after the last batch of messages, I'm wondering if there is anything you need me to do or if I should just leave it up to you. I'm fine either way, but what I heard a few posts above was that Thawan wanted to work on the leader side.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-15T16:36:41.966+0000","updated":"2013-01-15T16:36:41.966+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13554525","id":"13554525","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Flavio: The patch on the learner side looks good at the moment. I will have more update as I work on the leader side.  \n\nHere is the current implementation plan and thoughts\n\n1. The server now initialize its DB by loading from the snapshot only. In order to get lastLastLoggedZxid(), I have walk through the entire txnlog, not just the last file, so we don't reintroduce bug found in ZOOKEEPER-596\n\n2. When the leader start, it will have empty committedLog (since txnlog is not replayed). However, it will walk through txnlog directly using the same logic it used to walk committedLog. \n\n3. When the leader have sufficient vote for the NEWLEADER, it apply all the txns to the DataTree and also add to the commitedLog.  So any follower that try to synchronize after the quorum is form can use commitedLog for synchronization.\n\n4. On the learner side, the learner can apply the transactions from txnlog and what it gets from the leader after it receives UPTODATE. Potentially, this can be up to 100K txns with the default configuration. I am worry about the time it takes to do perform this, since the leader already switch to use syncLimit at this point and may tear down the quorum. We can add extra stage for this phase by using the unused UPTODATE's ack but it is not part of the protocol.\n\n5. There is a logic that kill dead sessions in the current ZooKeeeperServer.loadData(). I am not entirely sure why we need that clean up logic. \n\n    ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-01-15T23:40:07.985+0000","updated":"2013-01-15T23:40:07.985+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13556031","id":"13556031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"One question about this jira: is there any reason why it is marked for 3.4.6 but not for 3.5.0? It should be marked for 3.5.0 too, right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-17T10:11:49.787+0000","updated":"2013-01-17T10:11:49.787+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13566197","id":"13566197","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"This is a combined patch (included Flavio and Jacky patches) ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-01-30T05:56:26.228+0000","updated":"2013-01-30T05:56:26.228+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13566235","id":"13566235","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"High-level Description.\n\nLeader:\n1. The leader loads the db from snapshot only. If the quorum hasn't formed, it will synchronize with the learner using proposals read directly from txnlog. \n\n2. When the quorum is formed (received sufficient NEWLEADER_ACK). The leader reply its txns and add them to committedLog. Any learner joining after this point will only use committedLog for synchronization. \n\nLearner:\n1. Similar to the leader, the learner loads the db from snapshot only. Since it send lastLoggedZxid to the leader as part of FOLLOWER/OBSERVERINFO it should only get txn that it hasn't seen if it get a DIFF. Otherwise, it will get a SNAP + DIFF\n\n2. During synchronization (after received DIFF or SNAP packet), the learner will get a stream of txns in form of prosposal + commit. The learner logs each txn to txnlog only when it received a corresponding commit.  This is because the learner may receive outstanding proposals before getting UPTODATE if it joins the quorum after it is formed.\n\n3. When the learner received NEWLEADER, it flushes the txnlog to disk before sending NEWLEADER_ACK back to the leader.\n\n4. When the learner received UPTODATE, it flushed the txnlog again (in case it see any more committed txn). Then, it replay txnlog that it originally seen before joining the quorum and apply the committed txns that its received from the leader (and currently in memory) to the db. It then sends UPTODATE_ACK back to the leader but the leader is going to ignore this ACK since it is part of the old protocol. \n\n5. After sending UPTODATE_ACK, the learner starts up the server. For the follower, it will have to process any outstanding proposal that it received during synchronization phase, so that the leader will get ACK from the follower (and the follower don't confuse if it see corresponding commit message from the leader when it start processing request. \n\nDb initialization:\n1. When loading the snapshot, it also capture the snapshot zxid into a separate variable. This is later used to during txn replay. I didn't want to overload lastProcessedZxid since it may have other implication. \n\n2. Last logged zxid is obtained in a way to guarantee that we don't run into ZOOKEEPER-596. \n\n3. I saw the logic that kill dead sessions on db loading. I am not sure why we have this logic and don't know its implication toward data inconsistency.\n\n4. No snapshot is taken (unless the learner get a snapshot) when the new quorum form.  I think we might want to add some logic to trigger snapshot in background soon after the quorum is formed.  \n\nSide Note: \n- One of the major complexity in the existing code on the learner side is due to the fact that the learner may see outstanding proposal before it received UPTODATE. I want to cover this case so that we can do rolling upgrade when pushing this patch/release. The system should behave correctly if rolling upgrade is done by upgrading all the followers first. Zab1_0Test is modified to test this case. \n\n- This patch also fixed ZOOKEEPER-1551\n\n- The actual change on our internal branch is about half the size of the submitted patch. Another half is a result of our refactoring work on learner synchronization logic as part of ZOOKEEPER-1413. Since we currently use this in our production and it has a better unit testing facility, so I use this synchronization logic instead of the current one in trunk.\n\n- Is there away to trigger a unit test run and submit a review request against 3.4 branch? \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-01-30T07:02:43.180+0000","updated":"2013-01-30T07:02:43.180+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13566282","id":"13566282","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Nice work, Thawan! I haven't reviewed the patch yet, but I have two quick points about it:\n\n# Jacky's test case was written on QuorumPeerMainTest and I produced one for Zab1_0Test, which I posted on ZOOKEEPER-1558. We don't have to use my test case, but I'd rather have whatever test case we use in Zab1_0.\n# I was under the impression that we were working towards a 3.5.0 because that way we can remove at least some of the code we have currently in place for backward compatibility. Do you see it differently? It sounds like you're shooting for 3.4 at least.   ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-30T08:19:39.840+0000","updated":"2013-01-30T08:19:39.840+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13566971","id":"13566971","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Ah sorry, I forgot to included your test case in ZOOKEEPER-1558. I can add that one too.  Jacky's test is more like end-to-end test. I think we should have one for this patch, but it would be better if the test don't rely too much on ZooKeeper internals since it will be hard to maintain the code moving forward.\n\nThe reason I create the first version on 3.4 is because we still have pending ZOOKEEPER-107 on trunk which may require major rework if that patch get committed.  \n\nI also am aiming to support rolling upgrade for both 3.4.5 -> 3.4.6 and 3.4.x -> 3.5. I am not sure about 3.3.x -> 3.4.6 since some backward compatibility with respect to Zab Pre 1.0 is removed. However, the backward compatibility stuff that need to be retained is allowing the learner to handle outstanding proposals during synchronization phase. This is not related to the protocol but it just the implementation of the leader. I haven't changed the leader to get rid of this behavior in this patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-01-30T22:11:01.523+0000","updated":"2013-01-30T22:11:01.523+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13567199","id":"13567199","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"My point about the test case is that I feel that such a test should be in Zab1_0Test because it touches that part of the code. I don't find it strictly necessary to have that test case, but it would be great if we had a test case, end-to-end or not, in the right place. \n\nI agree with the point about ZOOKEEPER-107. \n\nbq. I am not sure about 3.3.x -> 3.4.6 since some backward compatibility with respect to Zab Pre 1.0 is removed\n\nThat's one reason I think we should be aiming for 3.5.0. Pat is not going to be happy about not having 3.3.x -> 3.4.6.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-31T01:04:25.257+0000","updated":"2013-01-31T01:04:25.257+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13567348","id":"13567348","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"I guess that this JIRA is considered as blocker for 3.4.6 because it is a data inconsistency bug.  In order to fix this bug, we decided that modification to the protocol is needed in order to support SNAP+DIFF which should be considered as a significant change.  To simplify the implementation, we removed the compatibility with Zab Pre 1.0.\n\nI think we have to decide if we want to retain backward compatibility or fix data inconsistency for 3.4.6 release. But since there a rolling upgrade path (3.3.x -> 3.4.5 -> 3.4.6) , I don't think backward compatibility is a major problem.       ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-01-31T04:33:12.316+0000","updated":"2013-01-31T04:33:12.316+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13567469","id":"13567469","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Agreed, it is marked as a blocker for 3.4.6. Because I'd rather not have to deal with backward compatibility 3.3->3.4, my preference is that we focus on a full-fledged patch for 3.5.0. For 3.4.6, we could commit the patch we have for ZOOKEEPER-1558. It is a partial fix that targets the problem that was originally reported in this jira and doesn't have backward compatibility problems to my knowledge. Is it acceptable?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-31T08:46:45.687+0000","updated":"2013-01-31T08:46:45.687+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13567922","id":"13567922","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Producing a patch for just one branch is definitely less work. So I am fine with the plan.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-01-31T18:44:49.623+0000","updated":"2013-01-31T18:44:49.623+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13571162","id":"13571162","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"[~thawan] It looks great. A question not related to this patch, why zk would choose to clear data base and load snapshot again rather than keep it in memory and reuse again when learner or leader fails?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-02-05T09:00:47.721+0000","updated":"2013-02-05T09:00:47.721+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13571913","id":"13571913","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"[~fanster.z] I think it is a side effect of existing mechanism that recreate Follower/Leader/ObserverZooKeeperServer whenever there is a leader election. I believe that if uncommitted txn never reach DataTree, there is no need to reload the database.  \n\nIn our Read-only Observer (ZOOKEEPER-1607), we could even retain the server and its processing pipeline across leader election. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-02-05T23:31:22.214+0000","updated":"2013-02-05T23:31:22.214+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13572913","id":"13572913","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Since no one objected to my plan, I'm marking this issue for 3.5.0 only. I've also marked ZOOKEEPER-1558 for 3.4.6.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-02-06T22:16:46.981+0000","updated":"2013-02-06T22:16:46.981+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13586350","id":"13586350","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"[~thawan] One question about this patch. It seems that it touches the part of the code that we fix in ZOOKEEPER-1642. Should we incorporate ZOOKEEPER-1642 into this patch? We should still load the database conditionally as in ZOOKEEPER-1642, right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-02-25T22:00:41.941+0000","updated":"2013-02-25T22:00:41.941+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13586470","id":"13586470","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Conditional db loading is already done but at a different location.  You can see ZKDatabase.loadDataBase() in the patch.    ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-02-25T23:40:39.281+0000","updated":"2013-02-25T23:40:39.281+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13586911","id":"13586911","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Sounds right, but one problem I'm seeing is that in loadData() the patch is clearing the database and reloading it, which will cause the leader to load the database twice during recovery, which is the problem described in ZOOKEEPER-1642.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-02-26T07:53:00.499+0000","updated":"2013-02-26T07:53:00.499+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13591162","id":"13591162","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Ah yes, I forgot about that. In our branch we do that since we saw duplicate txn in commitLog. With your diff, that should not happen, so I can remove it. \n\nSince we are no longer need to push this to 3.4.6.  I am thinking of splitting this patch a bit.  About half of the patch is actually a modified version of ZOOKEEPER-1413. If you agree, I can upload a patch for that jira when ZK-107 is committed. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-03-02T00:49:57.809+0000","updated":"2013-03-02T00:49:57.809+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13591597","id":"13591597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"bq. With your diff, that should not happen, so I can remove it. \n\nJust so that I make sure we are on the same page:\n\n# when you say my diff you're referring to the patch in ZOOKEEPER-1642\n# when you say that it is ok to remove it, you're referring to clearing the database in loadData. \n\nIn your latest patch, loadDataBase already loads conditionally, so if we simply don't clear the database in loadData, then we should avoid having the leader loading it twice. Do you agree? If so, then I don't think we need the patch in ZOOKEEPER-1642 at all, your new version of loadDataBase should take care of it.\n\nbq. Since we are no longer need to push this to 3.4.6. I am thinking of splitting this patch a bit. About half of the patch is actually a modified version of ZOOKEEPER-1413. If you agree, I can upload a patch for that jira when ZK-107 is committed. \n\nSounds like a plan.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-03-03T02:04:46.047+0000","updated":"2013-03-03T02:04:46.047+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13608979","id":"13608979","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"[~thawan]  It sounds the right time to fix this.\n\nWith this patch, it should be safe to do [ZOOKEEPER-1674|https://issues.apache.org/jira/browse/ZOOKEEPER-1674]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-03-21T14:28:54.208+0000","updated":"2013-03-21T14:28:54.208+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13608983","id":"13608983","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"body":"By the way, I think we should fix [ZOOKEEPER-1667|https://issues.apache.org/jira/browse/ZOOKEEPER-1667]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fanster.z","name":"fanster.z","key":"fanster.z","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jacky007","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-03-21T14:31:47.595+0000","updated":"2013-03-21T14:31:47.595+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13635854","id":"13635854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"it has been too long, can we try to wrap up this jira?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-04-18T23:46:31.246+0000","updated":"2013-04-18T23:46:31.246+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13650963","id":"13650963","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"We need to discuss the order of patches to get in. I have also asked about the patch I have uploaded to ZOOKEEPER-1642 and how it relates to this one.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-07T15:28:55.189+0000","updated":"2013-05-07T15:28:55.189+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13651346","id":"13651346","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"After having a look at both the patch here and the one in ZOOKEEPER-1642, it sounds like this patch here is not solving that problem. In that jira, I'm trying to avoid loading the database a second time, while the patch here clears the database in loadData before reloading it, so it still loads a second time.\n\n[~thawan], you say that with that patch you can remove the part that clears and reloads the database. It seems right for the case I'm focusing on for ZOOKEEPER-1642, but I wonder if this is right in general. I was also wondering if we could also remove the code in loadDataBase that replays the txn log conditionally. We should be able to do it and to make sure that we don't have duplicates in the commitLog, perhaps we could simply check the highest zxid currently present there, no? It might simplify the code if we don't have those boolean flags around.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-05-07T21:44:01.903+0000","updated":"2013-05-07T21:44:01.903+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13659056","id":"13659056","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Database loading:\nI think we will eventually need to be able to reuse the database instance across leader election round. This is mainly for improving availability since we will have much lower downtime.\n\nReplay txnlog conditionally:\nI think I was trying to mimic the existing code that initialize database conditionally. Ideally, it should have been more of a sanity check because we should only try to replay txnlog once.   \n\nWe should commit ZOOKEEPER-1642 before I revisit this patch again.\n  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-16T00:00:49.395+0000","updated":"2013-05-16T00:00:49.395+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13821515","id":"13821515","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liping","name":"liping","key":"liping","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Liping","active":true,"timeZone":"Etc/UTC"},"body":"Hi \n\nZK-1653 is duplicated with this one which is targeted to 3.5.0 finally.  Obviously it would spend lots of time to deliver 3.5.0.  So could you please help to re-open ZK-1653 and provide a easy patch for 3.4.6 only?  This issue happened several times in our environment.\n\nReally appreciate your help.\n\nBest Regards\nLiping","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liping","name":"liping","key":"liping","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Liping","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-13T16:47:12.143+0000","updated":"2013-11-13T16:47:12.143+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13821698","id":"13821698","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Liping, We have addressed this issue for 3.4.6 in ZOOKEEPER-1558.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-13T19:16:26.368+0000","updated":"2013-11-13T19:16:26.368+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13822521","id":"13822521","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liping","name":"liping","key":"liping","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Liping","active":true,"timeZone":"Etc/UTC"},"body":"Hi Flavio\n\nThanks for your quick response.\n\nBut I do not understand.  The ZK-1558 looks only avoid adding the uncommitted txnlog to snapshot file during leader startup.\nFor ZK-1653, if the leaner crashed b/w takeSnapshot() and setCurrentEpoch() after receiving NEALEADER or UPTODATE qp, the leaner restart seems would still get the 'java.io.IOException: The current epoch, x, is older than the last zxid xxxxx' exception.  Right?\n\nCould you please help to elaborate what I missed? \n\nThanks a lot!\nLiping\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liping","name":"liping","key":"liping","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Liping","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-14T15:34:37.149+0000","updated":"2013-11-14T15:34:37.149+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13822931","id":"13822931","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Here is my train of thought. I marked ZOOKEEPER-1653 as a duplicate because in my understanding the changes proposed here solve the problem described there. ZOOKEEPER-1558 solves the problem originally reported in this issue, but it does not solve all corner cases. We have left it for 3.5.0 for the reasons [~thawan] raised here previously.\n\nSince we are discussing in ZOOKEEPER-1549, I'm referring to the issue reported and discussed here. If you feel that ZOOKEEPER-1653 should be addressed and should be a blocker for 3.4.6, then we should discuss it there. But, please keep in mind that if we make it a blocker, it will delay the release even further.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-14T21:17:46.760+0000","updated":"2013-11-14T21:17:46.760+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/13823018","id":"13823018","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liping","name":"liping","key":"liping","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Liping","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for the clarification, Flavio\nYeah, I would follow ZK-1653 for the related discussion if necessary.  Michi just re-opened it for a 3.4.6 patch.  Thanks for all of your help!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liping","name":"liping","key":"liping","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Liping","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-14T22:17:55.530+0000","updated":"2013-11-14T22:17:55.530+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/14043218","id":"14043218","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"hey [~thawan],\n\nbq. We should commit ZOOKEEPER-1642 before I revisit this patch again.\n\nDone! Despite the delay, can we try to wrap this up?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-25T08:59:31.784+0000","updated":"2014-06-25T08:59:31.784+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/14049515","id":"14049515","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"body":"Here is the recap on the issue, for those who just found this JIRA\n\nProblem:\nWhen the leader started, it will treat every txn in its txnlog as committed and apply all of them into its in-memory data tree even though some of them was only acked by the leader (or the minority). \n\nIf there is a follow that need to synchronize with the leader via snapshot.  The follower will get a snapshot with uncommitted txns in it and take dirty snapshot to disk. If there is a leader failure, it is possible that uncommitted txn is discarded in the next leader election round so this follower will have dirty snapshot on disk and there is no way it can recovered from this. \n\nThe solution so far:\nThe fix on the follower side is to simply not taking snapshot until the quorum switch to broadcast phase. The follower can have dirty snapshot in memory but as long as it doesn’t write to disk, we are ok and part of the issue is addressed\n\nOn the leader side, the proposed patch is to change server startup and synchronization sequence.  Uncommitted txn (any txn after the last snapshot) should never get applied to the data tree until synchronization phase is done.  We use synchronization phase to catchup all follower and imply that all of the follower accepted the txn. Then, we apply these txns before starting broadcast phase.      \n \nI will try to find someone on my team to help on this. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thawan","name":"thawan","key":"thawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thawan Kooburat","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-07-02T01:33:53.949+0000","updated":"2014-07-02T01:33:53.949+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/14050373","id":"14050373","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~thawan],\n\n> The follower can have dirty snapshot in memory but as long as it doesn’t write to disk\n\nDo you mean the following case:\n1. A was the leader for B, C\n2. A partitioned but got a new request. A wrote the request to the log.\n3. A crashed and restarted. But A restore everything in the log including those uncommitted, i.e. the new request in this case.\n4. A joined the quorum that B and C formed (e.g. C is the leader)\n5. Since C is the leader, C truncates A's log.\n6. But A has dirty in-memory tree (plus the new request made in step 3).\n\nCorrect?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-07-02T17:31:18.088+0000","updated":"2014-07-02T17:31:18.088+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/14051688","id":"14051688","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"body":"I think the root of the problem is in this function:\n```\n  public long restore(DataTree dt, Map<Long, Integer> sessions,\n            PlayBackListener listener) throws IOException {\n            ...\n            while (true) {\n                // iterator points to\n                // the first valid txn when initialized\n                hdr = itr.getHeader();\n                ...\n                processTransaction(hdr,dt,sessions, itr.getTxn());\n                ...\n                listener.onTxnLoaded(hdr, itr.getTxn());\n                if (!itr.next())\n                    break;\n            }\n      ...\n```\nInstead of processing all transactions in the log, keeping an index of committedUpTo and processing until that makes more sense. Am I correct??\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-07-03T17:06:20.982+0000","updated":"2014-07-03T17:06:20.982+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/14051690","id":"14051690","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"body":"I don't know how to use the code formatting here.. So paste the link:\n\nhttps://github.com/apache/zookeeper/blob/trunk/src/java/main/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java#L158","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-07-03T17:07:11.406+0000","updated":"2014-07-03T17:07:11.406+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/14107742","id":"14107742","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"body":"[~fpj][~thawan][~fanster.z]\n{quote}\nThe fix on the follower side is to simply not taking snapshot until the quorum switch to broadcast phase. The follower can have dirty snapshot in memory but as long as it doesn’t write to disk, we are ok and part of the issue is addressed.\n\nOn the leader side, the proposed patch is to change server startup and synchronization sequence. Uncommitted txn (any txn after the last snapshot) should never get applied to the data tree until synchronization phase is done. We use synchronization phase to catchup all follower and imply that all of the follower accepted the txn. Then, we apply these txns before starting broadcast phase.\n{quote}\n\nIs this issue fixed yet? Or does anyone have internal patch for this?\nThis issue seems kinda major thing for stability.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hdeng","name":"hdeng","key":"hdeng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hongchao Deng","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-23T00:16:14.136+0000","updated":"2014-08-23T00:16:14.136+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/15281390","id":"15281390","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"I've done some further analysis of this issue after some time (it took me a while to recover all uncached state), and here is what I think needs to happen.\n\nIt is not incorrect that we take snapshots where we are taking. Snapshots are simply compacted versions of the txn log history. The real problem is that we are apparently truncating the txn log appropriately, but are loading a snapshot that does not reflect the state of the txn log. What needs to happen is that once we truncate, we need to make sure that the snapshot we load reflects the right txn log state, which we aren't doing and is causing the problem described here. The solution is to go back to an earlier snapshot and rebuild the state from that snapshot. [~fanster.z] actually proposed early on to delete the snapshot and that is sounding like a viable way to sort this out.\n\nI'll let people chime in and otherwise and I'll mature the idea a bit longer and will start working on a patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-05-12T10:05:58.926+0000","updated":"2016-05-12T10:05:58.926+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/15306472","id":"15306472","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=EdRowe","name":"EdRowe","key":"edrowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ed Rowe","active":true,"timeZone":"America/Los_Angeles"},"body":"[~fpj] I think the approach of deleting snapshots is a good one. Further, I think you hit the nail on the head when you say \"Snapshots are simply compacted versions of the txn log history.\" The previous idea (further up the comment history) in which the log, but not snapshots, would be allowed to contain uncommitted transactions seems fragile. A pedantic update to your definition would be \"Snapshots are simply compacted versions of the txn log history, as applied to the DataTree.\" to recognize that snapshots only ever contain information that has been in a DataTree (though not necessarily a DataTree that was ever visible outside a given Node) while logs can contain information that has never been in a DataTree.\n\nOne issue to account for in the fix is the case where there is no earlier snapshot to rebuild from. This could occur if an operator has deleted older snapshots. I think we'd still want to delete the snapshot being truncated and arrange for the learner node to start over with a blank database.\n\nAnother consideration is that, as I've written in ZOOKEEPER-2436, the learner might receive from the leader a SNAP rather than a TRUNC. In this situation, the snapshot on the learner node that a TRUNC would have deleted will still be present on the learner node, but it will no longer be the newest snapshot. I don't think this will cause any problems but I did want to bring it up.\n\nFinally, there were some concerns raised early in the comment thread that deleting snapshots might be too aggressive. If this is still an issue, we could (perhaps optionally) rename logs and snapshots that we are truncating rather than delete them. The snapshot/log purge code might then clean these up if they are old enough. I'm not convinced that this is worth implementing now.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=EdRowe","name":"EdRowe","key":"edrowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ed Rowe","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-30T10:09:03.739+0000","updated":"2016-05-30T10:09:03.739+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/15306815","id":"15306815","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"bq. \"Snapshots are simply compacted versions of the txn log history, as applied to the DataTree.\"\n\nThis is partially right and I acknowledge that my statement isn't that precise either. The root of the problem is that sometimes we treat snapshots as having only committed data (during the broadcast phase) and other times we produce snapshots that have uncommitted data (during recovery). Whatever fix we have needs to be such either snapshots contain committed data only or we enable snapshots to be deleted. I don't personally like the idea of deleting snapshots because if we don't get it right, then we will be making the zk state inconsistent by losing quorum on some transactions. In fact, one scenario to be aware of is the one in which an earlier snapshot has been committed while a more recent one hasn't. If we wipe out the former snapshot, then we are in trouble.\n\nThe one important thing to keep in mind is that we can't truncate a snapshot, so either we have only committed state in snapshots so that we never fall into this situation of having to truncate a snapshot or we start deleting snapshots as a brute-force way of truncating, but in this latter case, we need to be really careful.\n\nbq. One issue to account for in the fix is the case where there is no earlier snapshot to rebuild from.\n\nI'm not concerned about this case because we want the leader to transfer data to the learner. I'm clearly assuming that if any earlier snapshot has been committed by the same learner, then we aren't going to discard that snapshot.\n\nbq. the snapshot on the learner node that a TRUNC would have deleted will still be present on the learner node, but it will no longer be the newest snapshot.\n\nIf the leaner has a newer valid snapshot, then it shouldn't be a problem. However, if the learner has to load, then it will have to treat it as if it were the latest (which probably is, latest valid)\n.\n\nbq. there were some concerns raised early in the comment thread that deleting snapshots might be too aggressive\n\nOne important issue to keep in mind is that a quorum might commit a snapshot and I'm concern that if we start deleting snapshots, we will end up with bugs where we delete snapshots incorrectly.\n\nMy ideal approach is:\n\n# Snapshots only contain committed data\n# In the case a leader needs to transfer a snapshot, then transfer the latest snapshot containing the committed data and a suffix from the log.\n\nHowever, it is sounding a bit difficult to do it in a backwards compatible manner.\n\n\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2016-05-30T16:53:32.391+0000","updated":"2016-05-30T16:53:32.391+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/15331096","id":"15331096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Shouldn't the fix version also include 3.4? The effects lists 3.4.3 currently.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-06-15T03:53:33.577+0000","updated":"2016-06-15T03:53:33.577+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12606827/comment/16119019","id":"16119019","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lvfangmin","name":"lvfangmin","key":"lvfangmin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lvfangmin&avatarId=24660","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lvfangmin&avatarId=24660","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lvfangmin&avatarId=24660","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lvfangmin&avatarId=24660"},"displayName":"Fangmin Lv","active":true,"timeZone":"Etc/UTC"},"body":"Is this issue still exist? Didn't go through all the comments, but from the Jira description, this is not an issue anymore based on trunk code. \n\nAs a side benefit of ZOOKEEPER-1413, [~thawan] changed the LearnerHandler to check if the learner have a zxid not exist in leader and they're from different Epoch, we will not able to truncate it and instead will send a snap to the learner, although we may still have the dirty snapshot on disk, it's safe as we have a clear snapshot from leader.\n\nBut, I still think we should remove the takeSnapshot when leader loadData, from what I see it doesn't haven't any correctness issue by removing it, but it will decrease the unavailable time during leader election.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lvfangmin","name":"lvfangmin","key":"lvfangmin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=lvfangmin&avatarId=24660","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=lvfangmin&avatarId=24660","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=lvfangmin&avatarId=24660","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=lvfangmin&avatarId=24660"},"displayName":"Fangmin Lv","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-08T20:54:37.578+0000","updated":"2017-08-08T20:54:37.578+0000"}],"maxResults":82,"total":82,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1549/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i02j6f:"}}