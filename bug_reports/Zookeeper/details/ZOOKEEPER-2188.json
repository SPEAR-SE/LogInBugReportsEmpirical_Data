{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12828775","self":"https://issues.apache.org/jira/rest/api/2/issue/12828775","key":"ZOOKEEPER-2188","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-05-13T08:26:08.152+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jul 30 05:31:44 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2188/watchers","watchCount":3,"isWatching":false},"created":"2015-05-11T11:07:00.037+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316644","id":"12316644","description":"Dynamic Reconfig, Remove Watches, Local Session","name":"3.5.0","archived":false,"released":true,"releaseDate":"2014-08-04"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-07-30T05:31:44.301+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312381","id":"12312381","name":"java client","description":"The java client interface for ZooKeeper"}],"timeoriginalestimate":null,"description":"There is something wrong with the client code ClientCnxn.java, it will keep trying to connect to server in a dead loop.\nThis is my test step, shut down zookeeper cluster, exectue zkCli.sh script to connect to zookeeper cluster, it will keep trying to connect to zookeeper server without stop.\n\npublic void run() {\n            clientCnxnSocket.introduce(this, sessionId, outgoingQueue);\n            clientCnxnSocket.updateNow();\n            clientCnxnSocket.updateLastSendAndHeard();\n            int to;\n            long lastPingRwServer = Time.currentElapsedTime();\n            final int MAX_SEND_PING_INTERVAL = 10000; //10 seconds\n            while (state.isAlive()) {\n                try {\n                    if (!clientCnxnSocket.isConnected()) {\n                        // don't re-establish connection if we are closing\n                        if (closing) {\n                            break;\n                        }\n                        startConnect();\n                        clientCnxnSocket.updateLastSendAndHeard();\n                    }\n\npublic boolean isAlive() {\n            return this != CLOSED && this != AUTH_FAILED;\n        }\n\nbecause at the beginning it is CONNECTING so isAlive always returns true, which leads to dead loop.\nwe should add some retry limit to stop this","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"client connection hung up because of  dead loop","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haitao-tony","name":"haitao-tony","key":"haitao-tony","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sunhaitao","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haitao-tony","name":"haitao-tony","key":"haitao-tony","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sunhaitao","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12828775/comment/14537821","id":"14537821","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haitao-tony","name":"haitao-tony","key":"haitao-tony","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sunhaitao","active":true,"timeZone":"Etc/UTC"},"body":"shuting down the cluster is just one case, another case is like in safe authentication failed, the clientCnxn just keeps trying to connect but no feed back.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haitao-tony","name":"haitao-tony","key":"haitao-tony","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sunhaitao","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-11T11:11:21.531+0000","updated":"2015-05-11T11:11:21.531+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12828775/comment/14541588","id":"14541588","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"body":"[~haitao-tony], IIUC {{zkclient#isAlive}} is used to see the client is dead or not. In your case, the cluster is down. Now, when a client tries to connect to the server it fails to get a socket connection and it will continue retrying infinitely to establish a connection. This means the client is alive to establish a connection once the ZK quorum is available. There is a way to get out of this infinite loop, but it should be implemented through an application thread, here this thread would do a connection time out logic using {{zk.getState().isConnected();}} status or a connection watcher event of {{Event#SyncConnected}}/{{Event#SaslAuthenticated}}. Does this satisfy your case?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh R","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-05-13T08:26:08.152+0000","updated":"2015-05-13T08:26:08.152+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12828775/comment/14601080","id":"14601080","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=guy.moshkowich","name":"guy.moshkowich","key":"guy.moshkowich","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=guy.moshkowich&avatarId=24539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=guy.moshkowich&avatarId=24539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=guy.moshkowich&avatarId=24539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=guy.moshkowich&avatarId=24539"},"displayName":"Guy Moshkowich","active":true,"timeZone":"Asia/Jerusalem"},"body":"[~haitao-tony], Can you please clarify why you think the behavior above is a bug?\nWould not you expect that the client will retry to connect to ZooKeeper servers while the cluster is down?\nDo I miss something here?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=guy.moshkowich","name":"guy.moshkowich","key":"guy.moshkowich","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=guy.moshkowich&avatarId=24539","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=guy.moshkowich&avatarId=24539","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=guy.moshkowich&avatarId=24539","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=guy.moshkowich&avatarId=24539"},"displayName":"Guy Moshkowich","active":true,"timeZone":"Asia/Jerusalem"},"created":"2015-06-25T11:53:41.267+0000","updated":"2015-06-25T11:53:41.267+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12828775/comment/14647212","id":"14647212","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haitao-tony","name":"haitao-tony","key":"haitao-tony","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sunhaitao","active":true,"timeZone":"Etc/UTC"},"body":"no, i get yourpoint","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haitao-tony","name":"haitao-tony","key":"haitao-tony","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sunhaitao","active":true,"timeZone":"Etc/UTC"},"created":"2015-07-30T05:30:43.394+0000","updated":"2015-07-30T05:30:43.394+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12828775/comment/14647214","id":"14647214","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haitao-tony","name":"haitao-tony","key":"haitao-tony","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sunhaitao","active":true,"timeZone":"Etc/UTC"},"body":"yes,that's right","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haitao-tony","name":"haitao-tony","key":"haitao-tony","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sunhaitao","active":true,"timeZone":"Etc/UTC"},"created":"2015-07-30T05:31:42.548+0000","updated":"2015-07-30T05:31:42.548+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12828775/comment/14647215","id":"14647215","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haitao-tony","name":"haitao-tony","key":"haitao-tony","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sunhaitao","active":true,"timeZone":"Etc/UTC"},"body":"yes,that's right","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=haitao-tony","name":"haitao-tony","key":"haitao-tony","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sunhaitao","active":true,"timeZone":"Etc/UTC"},"created":"2015-07-30T05:31:44.301+0000","updated":"2015-07-30T05:31:44.301+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2188/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2ejtz:"}}