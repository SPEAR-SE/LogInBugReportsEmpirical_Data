{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12507847","self":"https://issues.apache.org/jira/rest/api/2/issue/12507847","key":"ZOOKEEPER-1065","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":"2011-05-20T17:23:34.980+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri May 20 18:39:30 UTC 2011","customfield_12310420":"214216","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_42227155_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-05-20T18:30:05.905+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1065/watchers","watchCount":0,"isWatching":false},"created":"2011-05-20T06:46:18.784+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315482","id":"12315482","description":"Fix release against 3.3 branch","name":"3.3.3","archived":false,"released":true,"releaseDate":"2011-02-27"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-05-20T18:39:30.239+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312381","id":"12312381","name":"java client","description":"The java client interface for ZooKeeper"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312382","id":"12312382","name":"server","description":"General issues with the ZooKeeper server."}],"timeoriginalestimate":null,"description":"I have an application that uses ZooKeeper. There is an ensemble in\nproduction. But in order to simplify development the application will\nstart an embedded ZooKeeper server when started in development mode. We\nare experiencing a timing issue with ZooKeeper 3.3.3 and I was wondering\nif this is allowed to be happen or if we did something wrong when\nstarting the embedded server.\n\n\nBasically, we have a watch registered using an #exists call and watch\ncode like the following.\n{code}\n@Override\npublic void process(final WatchedEvent event) {\n  switch (event.getType()) {\n    ...\n    case NodeCreated:\n      pathCreated(event.getPath());\n      break;\n    ...\n  }\n}\n\n@Override\nprotected void pathCreated(final String path) {\n  // process events only for this node\n  if (!isMyPath(path))\n    return;\n  try {\n    loadNode(); // calls zk.getData(String, Watcher, Stat)\n  } catch (final Exception e) {\n    // got NoNodeException here (but not when debugging)\n    log(..., e)\n  }\n}\n{code}\n\n\nFrom inspecting the logs we noticed a NoNodeException. When setting\nbreakpoints on #loadNode and stepping through we don't get the\nexception. But when setting a breakpoint on #log only we got a hit and\ncould confirm the issue this way.\n\nThe path is actually some levels deep. All the parent paths don't exist\neither so they are created as well. However, no exception is thrown fro\nthem. The sequence is as follows.\n\n{noformat}\n/l1  --> watch triggered, getData, no exception\n/l1/l2  --> watch triggered, getData, no exception\n/l1/l2/l3  --> watch triggered, getData, no exception\n/l1/l2/l3/l4  --> watch triggered, getData, no exception\n/l1/l2/l3/l4/l5  --> watch triggered, getData, no exception\n/l1/l2/l3/l4/l5/l6  --> watch triggered, getData, NoNodeException\n{noformat}\n\nThe only difference is that all paths up to including l5 do not actually\nhave any data. Only l6 has some data. Could there be some latency issues?\n\nFor completeness, the embedded server is started as follows.\n{code}\n// disable LOG4J JMX stuff\nSystem.setProperty(\"zookeeper.jmx.log4j.disable\", Boolean.TRUE.toString());\n\n// get directories\nfinal File dataDir = new File(config.getDataLogDir());\nfinal File snapDir = new File(config.getDataDir());\n\n// clean old logs\nPurgeTxnLog.purge(dataDir, snapDir, 3);\n\n// create standalone server\nzkServer = new ZooKeeperServer();\nzkServer.setTxnLogFactory(new FileTxnSnapLog(dataDir, snapDir));\nzkServer.setTickTime(config.getTickTime());\nzkServer.setMinSessionTimeout(config.getMinSessionTimeout());\nzkServer.setMaxSessionTimeout(config.getMaxSessionTimeout());\n\nfactory = new NIOServerCnxn.Factory(config.getClientPortAddress(),\nconfig.getMaxClientCnxns());\n\n// start server\nLOG.info(\"Starting ZooKeeper standalone server.\");\ntry {\n  factory.startup(zkServer);\n} catch (final InterruptedException e) {\n  LOG.warn(\"Interrupted during server start.\", e);\n  Thread.currentThread().interrupt();\n}\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12479882","id":"12479882","filename":"zookeeper-nonode-issue.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gunnar","name":"gunnar","key":"gunnar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gunnar Wagenknecht","active":true,"timeZone":"Europe/Berlin"},"created":"2011-05-20T06:53:31.974+0000","size":87451,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12479882/zookeeper-nonode-issue.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"32740","customfield_12312823":null,"summary":"Possible timing issue in embedded server","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gunnar","name":"gunnar","key":"gunnar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gunnar Wagenknecht","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gunnar","name":"gunnar","key":"gunnar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gunnar Wagenknecht","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows 7, 32bit, Core2 Duo T9300, JDK 1.6.0_24, ZooKeeper data on 500GB hybrid Seagate HDD with 4GB SSD cache","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12507847/comment/13036699","id":"13036699","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gunnar","name":"gunnar","key":"gunnar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gunnar Wagenknecht","active":true,"timeZone":"Europe/Berlin"},"body":"I attached the complete DEBUG log of the procedure. This includes the behavior of our application start procedure. The exception is logged in line 190 {{WARN  o.e.g.c.i.p.ZooKeeperBasedPreferences - Error refreshing node ...}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gunnar","name":"gunnar","key":"gunnar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gunnar Wagenknecht","active":true,"timeZone":"Europe/Berlin"},"created":"2011-05-20T06:53:32.027+0000","updated":"2011-05-20T06:53:32.027+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12507847/comment/13036700","id":"13036700","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gunnar","name":"gunnar","key":"gunnar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gunnar Wagenknecht","active":true,"timeZone":"Europe/Berlin"},"body":"{noformat}\nAm 19.05.2011 21:14, schrieb Patrick Hunt:\n> Hi Gunnar this is great detective work. It certainly sounds like it\n> might be some timing issue or possible bug in ZK exposed by this\n> embedded case. A few questions:\n> \n> 1) in this dev/embedded case you only have a single zk server, correct?\n{noformat}\n\nSingle ZK server.\n\n{noformat}\n> 2) you have 2 clients in this case, one creating the znode and one\n> watching (vs say a single client doing both)\n{noformat}\n\nIt's a single client which connects to \"localhost\" single server.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gunnar","name":"gunnar","key":"gunnar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gunnar Wagenknecht","active":true,"timeZone":"Europe/Berlin"},"created":"2011-05-20T06:55:24.247+0000","updated":"2011-05-20T06:55:24.247+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12507847/comment/13036938","id":"13036938","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Gunnar, I believe I see something from the logs:\n\n1) goto line 190 in the log, time index 09:00:59.357\n2) search backward in the log file for the znode you are getting\n\"nonode\" on, this:\n/gyrex/prefs/cloud/org.eclipse.gyrex.http/applications/org.eclipse.gyrex.http.equinoxhttpservice.application\n3) time index is now 09:00:58.968 (the most recent earlier operation\non this znode), notice the operation being performed on the znode -\nit's explicitly being deleted by the client.\n\nThis (3) is the cause of the log message from (1).\n\nSo from what I see in the log it looks like expected behavior from the\nZK view of the world. Does this make sense to you or am I missing\nsomething?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-20T17:23:34.980+0000","updated":"2011-05-20T17:23:34.980+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12507847/comment/13036982","id":"13036982","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gunnar","name":"gunnar","key":"gunnar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gunnar Wagenknecht","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks very much. I didn't understand the logs properly. That help me a lot in setting the right breakpoint and understanding the issue further. It's within my application, well, sort of.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gunnar","name":"gunnar","key":"gunnar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gunnar Wagenknecht","active":true,"timeZone":"Europe/Berlin"},"created":"2011-05-20T18:30:05.915+0000","updated":"2011-05-20T18:30:05.915+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12507847/comment/13036991","id":"13036991","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"No worries (it's overwhelming sometimes, took me a bit to figure it out :-) ). Good hunting and feel free to reach out if you run into another issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-20T18:39:30.222+0000","updated":"2011-05-20T18:39:30.222+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-1065/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05ytj:"}}