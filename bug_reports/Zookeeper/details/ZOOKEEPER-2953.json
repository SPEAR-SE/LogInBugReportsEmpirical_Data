{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13124534","self":"https://issues.apache.org/jira/rest/api/2/issue/13124534","key":"ZOOKEEPER-2953","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310801","id":"12310801","key":"ZOOKEEPER","name":"ZooKeeper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310801&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310801&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310801&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310801&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10484","id":"10484","description":"Apache ZooKeeper related","name":"ZooKeeper"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340141","id":"12340141","description":"Beta release against 3.5 branch","name":"3.5.4","archived":false,"released":true,"releaseDate":"2018-05-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342040","id":"12342040","description":"Fix release against 3.4 branch","name":"3.4.12","archived":false,"released":true,"releaseDate":"2018-05-01"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-12-13T01:11:31.217+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Dec 16 02:05:46 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_260660914_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-12-16T00:49:05.240+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2953/watchers","watchCount":3,"isWatching":false},"created":"2017-12-13T00:24:44.415+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335444","id":"12335444","description":"Beta release against 3.5 branch","name":"3.5.3","archived":false,"released":true,"releaseDate":"2017-04-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12339207","id":"12339207","description":"Fix release against 3.4 branch","name":"3.4.11","archived":false,"released":true,"releaseDate":"2017-11-09"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326518","id":"12326518","name":"3.6.0","archived":false,"released":false}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abrahamfine","name":"abrahamfine","key":"abrahamfine","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abraham Fine","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-12-16T02:05:46.966+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"testNoLogBeforeLeaderEstablishment has been flaky on 3.4, 3.5, and master for quite awhile. My understanding is that the purpose of the test is to make sure that a server receives support from the quorum before changing the epoch and acting as leader. \r\n\r\nThere are a couple issues with the test in its current state. First, the assertions the test makes are not always true. It is possible, if the zookeeper database is not cleared, for a follower to be ahead of a leader when the quorum is shutdown. That follower will then likely become leader when the quorum is restarted. This is the cause of the flaky behavior. Second, the test does not appear to create the conditions it wants to test for. Since, ZOOKEEPER-335 (specifically the ZOOKEEPER-1081 subtask) we take the epoch into consideration in {{FastLeaderElection}} so the test no longer \"believes it is the leader once it recovers\".\r\n\r\nAfter discussing the issue offline with [~phunt] we decided it would still be valuable to test the situation where a server is elected leader without the support of the quorum. So I removed {{testNoLogBeforeLeaderEstablishment}} and created a new test called {{testElectionFraud}}.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Flaky Test: testNoLogBeforeLeaderEstablishment","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abrahamfine","name":"abrahamfine","key":"abrahamfine","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abraham Fine","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abrahamfine","name":"abrahamfine","key":"abrahamfine","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abraham Fine","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16288562","id":"16288562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user afine opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/432\n\n    [WIP] ZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment\n\n    \n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/afine/zookeeper ZOOKEEPER-2953\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/432.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #432\n    \n----\ncommit 68a0382093da1d64583211746ac672ed12f5da5c\nAuthor: Abraham Fine <afine@apache.org>\nDate:   2017-12-13T00:35:50Z\n\n    ZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T01:11:31.217+0000","updated":"2017-12-13T01:11:31.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16288563","id":"16288563","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user afine opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/433\n\n    ZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment\n\n    \n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/afine/zookeeper ZOOKEEPER-2953_3.5\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/433.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #433\n    \n----\ncommit 36abecd0d4389b24e22852cccac50259b2abdb1a\nAuthor: Abraham Fine <afine@apache.org>\nDate:   2017-12-13T00:51:52Z\n\n    ZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T01:11:46.312+0000","updated":"2017-12-13T01:11:46.312+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16288564","id":"16288564","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user afine opened a pull request:\n\n    https://github.com/apache/zookeeper/pull/434\n\n    [WIP] ZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment\n\n    \n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/afine/zookeeper ZOOKEEPER-2953_3.4\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/434.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #434\n    \n----\ncommit 4834ba25b9b0a9f0448675f96ca402120833f54e\nAuthor: Abraham Fine <afine@apache.org>\nDate:   2017-12-13T01:10:21Z\n\n    ZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T01:12:19.383+0000","updated":"2017-12-13T01:12:19.383+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16288837","id":"16288837","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/432\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T07:45:22.115+0000","updated":"2017-12-13T07:45:22.115+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16288838","id":"16288838","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user afine reopened a pull request:\n\n    https://github.com/apache/zookeeper/pull/432\n\n    [WIP] ZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment\n\n    \n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/afine/zookeeper ZOOKEEPER-2953\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/432.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #432\n    \n----\ncommit 68a0382093da1d64583211746ac672ed12f5da5c\nAuthor: Abraham Fine <afine@apache.org>\nDate:   2017-12-13T00:35:50Z\n\n    ZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T07:45:46.133+0000","updated":"2017-12-13T07:45:46.133+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16288925","id":"16288925","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/433\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T09:10:42.003+0000","updated":"2017-12-13T09:10:42.003+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16288926","id":"16288926","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user afine reopened a pull request:\n\n    https://github.com/apache/zookeeper/pull/433\n\n    [WIP] ZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment\n\n    \n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/afine/zookeeper ZOOKEEPER-2953_3.5\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/zookeeper/pull/433.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #433\n    \n----\ncommit 36abecd0d4389b24e22852cccac50259b2abdb1a\nAuthor: Abraham Fine <afine@apache.org>\nDate:   2017-12-13T00:51:52Z\n\n    ZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment\n\ncommit 5e4da2dcf3067008a33ace787c3d78c0bdbee823\nAuthor: Abraham Fine <afine@apache.org>\nDate:   2017-12-13T08:20:56Z\n\n    fix whitespace\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T09:10:43.880+0000","updated":"2017-12-13T09:10:43.880+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16289274","id":"16289274","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user anmolnar commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/432#discussion_r156657072\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    +\n    +        // used for assertions later\n    +        boolean foundLeading = false;\n    +        boolean foundLooking = false;\n    +        boolean foundFollowing = false;\n    +\n    +        try {\n    +          // spin up a quorum, we use a small ticktime to make the test run faster\n    +          Servers servers = LaunchServers(numServers, 500);\n    --- End diff --\n    \n    It'd be useful to utilize the class-wide ```servers``` field which is used to shutdown test servers in the ```tearDown()``` method.\r\n    \r\n    For example ```testHighestZxidJoinLate()``` test does it that way.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T13:43:35.997+0000","updated":"2017-12-13T13:43:35.997+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16289275","id":"16289275","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user anmolnar commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/432#discussion_r156658012\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    +\n    +        // used for assertions later\n    +        boolean foundLeading = false;\n    +        boolean foundLooking = false;\n    +        boolean foundFollowing = false;\n    +\n    +        try {\n    +          // spin up a quorum, we use a small ticktime to make the test run faster\n    +          Servers servers = LaunchServers(numServers, 500);\n    +\n    +          // find the leader\n    +          int trueLeader = -1;\n    +          for (int i = 0; i < numServers; i++) {\n    +            if (servers.mt[i].main.quorumPeer.leader != null) {\n    +              trueLeader = i;\n    +            }\n    +          }\n    +          Assert.assertTrue(\"There should be a leader\", trueLeader >= 0);\n    +\n    +          // find a follower\n    +          int falseLeader = (trueLeader + 1) % numServers;\n    +          Assert.assertTrue(servers.mt[falseLeader].main.quorumPeer.follower != null);\n    --- End diff --\n    \n    Minor: I believe that it's generally a good idea to add a short message to asserts to describe what could be the problem when assertion fails.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T13:43:36.021+0000","updated":"2017-12-13T13:43:36.021+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16289276","id":"16289276","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user anmolnar commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/432#discussion_r156660196\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    +\n    +        // used for assertions later\n    +        boolean foundLeading = false;\n    +        boolean foundLooking = false;\n    +        boolean foundFollowing = false;\n    +\n    +        try {\n    +          // spin up a quorum, we use a small ticktime to make the test run faster\n    +          Servers servers = LaunchServers(numServers, 500);\n    +\n    +          // find the leader\n    +          int trueLeader = -1;\n    +          for (int i = 0; i < numServers; i++) {\n    +            if (servers.mt[i].main.quorumPeer.leader != null) {\n    +              trueLeader = i;\n    +            }\n    +          }\n    +          Assert.assertTrue(\"There should be a leader\", trueLeader >= 0);\n    +\n    +          // find a follower\n    +          int falseLeader = (trueLeader + 1) % numServers;\n    +          Assert.assertTrue(servers.mt[falseLeader].main.quorumPeer.follower != null);\n    +\n    +          // to keep the quorum peer running and force it to go into the looking state, we kill leader election\n    +          // and close the connection to the leader\n    +          servers.mt[falseLeader].main.quorumPeer.electionAlg.shutdown();\n    +          servers.mt[falseLeader].main.quorumPeer.follower.getSocket().close();\n    +\n    +          // wait for the falseLeader to disconnect\n    +          waitForOne(servers.zk[falseLeader], States.CONNECTING);\n    +\n    +          // convince falseLeader that it is the leader\n    +          servers.mt[falseLeader].main.quorumPeer.setPeerState(QuorumPeer.ServerState.LEADING);\n    +\n    +          // provide time for the falseleader to realize no followers have connected\n    +          // (this is twice the timeout used in Leader#getEpochToPropose)\n    +          Thread.sleep(2 * servers.mt[falseLeader].main.quorumPeer.initLimit * servers.mt[falseLeader].main.quorumPeer.tickTime);\n    +\n    +          // Restart leader election\n    +          servers.mt[falseLeader].main.quorumPeer.startLeaderElection();\n    --- End diff --\n    \n    I wonder if this one has to be called explicitly. \r\n    \r\n    The peer should automatically realise that it's no longer the leader, stop leading and start leader election (which is basically looking). That's what this test is intended to validate and shouldn't be started explicitly.\r\n    \r\n    Correct me if I'm wrong.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T13:43:36.105+0000","updated":"2017-12-13T13:43:36.105+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16289277","id":"16289277","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user anmolnar commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/432\n  \n    @afine Generally the new test looks good to me, but would you please elaborate why the old test was flaky and how the new fixes that?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T13:44:54.033+0000","updated":"2017-12-13T13:44:54.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16289894","id":"16289894","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/432#discussion_r156780239\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    +\n    +        // used for assertions later\n    +        boolean foundLeading = false;\n    +        boolean foundLooking = false;\n    +        boolean foundFollowing = false;\n    +\n    +        try {\n    +          // spin up a quorum, we use a small ticktime to make the test run faster\n    +          Servers servers = LaunchServers(numServers, 500);\n    --- End diff --\n    \n    Fixed, forgot to put that in this branch.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T20:57:05.911+0000","updated":"2017-12-13T20:57:05.911+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16289901","id":"16289901","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/432#discussion_r156781040\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    +\n    +        // used for assertions later\n    +        boolean foundLeading = false;\n    +        boolean foundLooking = false;\n    +        boolean foundFollowing = false;\n    +\n    +        try {\n    +          // spin up a quorum, we use a small ticktime to make the test run faster\n    +          Servers servers = LaunchServers(numServers, 500);\n    +\n    +          // find the leader\n    +          int trueLeader = -1;\n    +          for (int i = 0; i < numServers; i++) {\n    +            if (servers.mt[i].main.quorumPeer.leader != null) {\n    +              trueLeader = i;\n    +            }\n    +          }\n    +          Assert.assertTrue(\"There should be a leader\", trueLeader >= 0);\n    +\n    +          // find a follower\n    +          int falseLeader = (trueLeader + 1) % numServers;\n    +          Assert.assertTrue(servers.mt[falseLeader].main.quorumPeer.follower != null);\n    +\n    +          // to keep the quorum peer running and force it to go into the looking state, we kill leader election\n    +          // and close the connection to the leader\n    +          servers.mt[falseLeader].main.quorumPeer.electionAlg.shutdown();\n    +          servers.mt[falseLeader].main.quorumPeer.follower.getSocket().close();\n    +\n    +          // wait for the falseLeader to disconnect\n    +          waitForOne(servers.zk[falseLeader], States.CONNECTING);\n    +\n    +          // convince falseLeader that it is the leader\n    +          servers.mt[falseLeader].main.quorumPeer.setPeerState(QuorumPeer.ServerState.LEADING);\n    +\n    +          // provide time for the falseleader to realize no followers have connected\n    +          // (this is twice the timeout used in Leader#getEpochToPropose)\n    +          Thread.sleep(2 * servers.mt[falseLeader].main.quorumPeer.initLimit * servers.mt[falseLeader].main.quorumPeer.tickTime);\n    +\n    +          // Restart leader election\n    +          servers.mt[falseLeader].main.quorumPeer.startLeaderElection();\n    --- End diff --\n    \n    Stopping and starting leader election is necessary here to prevent a race condition. It is possible that after the server is disconnected from the leader it becomes a follower before the test hits `servers.mt[falseLeader].main.quorumPeer.setPeerState(QuorumPeer.ServerState.LEADING);` and falseLeader will never try to `lead`, defeating the purpose of the test.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T21:00:31.439+0000","updated":"2017-12-13T21:00:31.439+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16289905","id":"16289905","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/432\n  \n    @anmolnar An explanation is coming, please excuse the cruft at this stage. I wanted to run the new test on apache hardware hence the [WIP] in the title.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T21:01:57.229+0000","updated":"2017-12-13T21:01:57.229+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16289943","id":"16289943","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user anmolnar commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/432\n  \n    @afine got it\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T21:31:04.086+0000","updated":"2017-12-13T21:31:04.086+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16289958","id":"16289958","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user anmolnar commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/432#discussion_r156793172\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    +\n    +        // used for assertions later\n    +        boolean foundLeading = false;\n    +        boolean foundLooking = false;\n    +        boolean foundFollowing = false;\n    +\n    +        try {\n    +          // spin up a quorum, we use a small ticktime to make the test run faster\n    +          Servers servers = LaunchServers(numServers, 500);\n    +\n    +          // find the leader\n    +          int trueLeader = -1;\n    +          for (int i = 0; i < numServers; i++) {\n    +            if (servers.mt[i].main.quorumPeer.leader != null) {\n    +              trueLeader = i;\n    +            }\n    +          }\n    +          Assert.assertTrue(\"There should be a leader\", trueLeader >= 0);\n    +\n    +          // find a follower\n    +          int falseLeader = (trueLeader + 1) % numServers;\n    +          Assert.assertTrue(servers.mt[falseLeader].main.quorumPeer.follower != null);\n    +\n    +          // to keep the quorum peer running and force it to go into the looking state, we kill leader election\n    +          // and close the connection to the leader\n    +          servers.mt[falseLeader].main.quorumPeer.electionAlg.shutdown();\n    +          servers.mt[falseLeader].main.quorumPeer.follower.getSocket().close();\n    +\n    +          // wait for the falseLeader to disconnect\n    +          waitForOne(servers.zk[falseLeader], States.CONNECTING);\n    +\n    +          // convince falseLeader that it is the leader\n    +          servers.mt[falseLeader].main.quorumPeer.setPeerState(QuorumPeer.ServerState.LEADING);\n    +\n    +          // provide time for the falseleader to realize no followers have connected\n    +          // (this is twice the timeout used in Leader#getEpochToPropose)\n    +          Thread.sleep(2 * servers.mt[falseLeader].main.quorumPeer.initLimit * servers.mt[falseLeader].main.quorumPeer.tickTime);\n    +\n    +          // Restart leader election\n    +          servers.mt[falseLeader].main.quorumPeer.startLeaderElection();\n    --- End diff --\n    \n    I see. Hence the shutdown() call a few lines before.\r\n    Makes sense.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-13T21:39:50.256+0000","updated":"2017-12-13T21:39:50.256+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16291163","id":"16291163","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/432#discussion_r156999341\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    +\n    +        // used for assertions later\n    +        boolean foundLeading = false;\n    +        boolean foundLooking = false;\n    +        boolean foundFollowing = false;\n    +\n    +        try {\n    +          // spin up a quorum, we use a small ticktime to make the test run faster\n    +          Servers servers = LaunchServers(numServers, 500);\n    +\n    +          // find the leader\n    +          int trueLeader = -1;\n    +          for (int i = 0; i < numServers; i++) {\n    +            if (servers.mt[i].main.quorumPeer.leader != null) {\n    +              trueLeader = i;\n    +            }\n    +          }\n    +          Assert.assertTrue(\"There should be a leader\", trueLeader >= 0);\n    +\n    +          // find a follower\n    +          int falseLeader = (trueLeader + 1) % numServers;\n    +          Assert.assertTrue(servers.mt[falseLeader].main.quorumPeer.follower != null);\n    --- End diff --\n    \n    fixed\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-14T16:49:08.737+0000","updated":"2017-12-14T16:49:08.737+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16291164","id":"16291164","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/432\n  \n    [WIP] removed and I added a description of the issue to the JIRA.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-14T16:49:42.565+0000","updated":"2017-12-14T16:49:42.565+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16291168","id":"16291168","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user anmolnar commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/433#discussion_r157001258\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    --- End diff --\n    \n    Please use the global field.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-14T16:56:11.736+0000","updated":"2017-12-14T16:56:11.736+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16291169","id":"16291169","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user anmolnar commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/433#discussion_r157001279\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    +\n    +        // used for assertions later\n    +        boolean foundLeading = false;\n    +        boolean foundLooking = false;\n    +        boolean foundFollowing = false;\n    +\n    +        try {\n    +          // spin up a quorum, we use a small ticktime to make the test run faster\n    +          Servers servers = LaunchServers(numServers, 500);\n    --- End diff --\n    \n    Here too.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-14T16:56:11.823+0000","updated":"2017-12-14T16:56:11.823+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16291187","id":"16291187","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/433#discussion_r157004899\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    --- End diff --\n    \n    fixed\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-14T17:08:36.635+0000","updated":"2017-12-14T17:08:36.635+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16291188","id":"16291188","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/433#discussion_r157004909\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        int numServers = 3;\n    +\n    +        // used for assertions later\n    +        boolean foundLeading = false;\n    +        boolean foundLooking = false;\n    +        boolean foundFollowing = false;\n    +\n    +        try {\n    +          // spin up a quorum, we use a small ticktime to make the test run faster\n    +          Servers servers = LaunchServers(numServers, 500);\n    --- End diff --\n    \n    fixed\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-14T17:08:38.185+0000","updated":"2017-12-14T17:08:38.185+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16291213","id":"16291213","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  GitHub Pull Request  Build\n      \n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 9 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1373//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1373//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nConsole output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1373//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-14T17:26:54.475+0000","updated":"2017-12-14T17:26:54.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16293475","id":"16293475","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user phunt commented on a diff in the pull request:\n\n    https://github.com/apache/zookeeper/pull/432#discussion_r157326074\n  \n    --- Diff: src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java ---\n    @@ -335,6 +336,100 @@ public void testHighestZxidJoinLate() throws Exception {\n                     output[0], 2);\n         }\n     \n    +    /**\n    +     * This test validates that if a quorum member determines that it is leader without the support of the rest of the\n    +     * quorum (the other members do not believe it to be the leader) it will stop attempting to lead and become a follower.\n    +     *\n    +     * @throws IOException\n    +     * @throws InterruptedException\n    +     */\n    +    @Test\n    +    public void testElectionFraud() throws IOException, InterruptedException {\n    +        // capture QuorumPeer logging\n    +        Layout layout = Logger.getRootLogger().getAppender(\"CONSOLE\").getLayout();\n    +        ByteArrayOutputStream os = new ByteArrayOutputStream();\n    +        WriterAppender appender = new WriterAppender(layout, os);\n    +        appender.setThreshold(Level.INFO);\n    +        Logger qlogger = Logger.getLogger(QuorumPeer.class);\n    +        qlogger.addAppender(appender);\n    +\n    +        numServers = 3;\n    +\n    +        // used for assertions later\n    +        boolean foundLeading = false;\n    +        boolean foundLooking = false;\n    +        boolean foundFollowing = false;\n    +\n    +        try {\n    +          // spin up a quorum, we use a small ticktime to make the test run faster\n    +          servers = LaunchServers(numServers, 500);\n    --- End diff --\n    \n    Note that by reducing this you are also affecting the init and sync limits  in the same proportion... Not a reason not to do it but FYI in case we start seeing this test as flakey down the road. :-)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-16T00:31:55.337+0000","updated":"2017-12-16T00:31:55.337+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16293479","id":"16293479","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/432\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-16T00:36:47.268+0000","updated":"2017-12-16T00:36:47.268+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16293481","id":"16293481","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user phunt commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/432\n  \n    lgtm, +1 thanks @afine \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-16T00:39:01.567+0000","updated":"2017-12-16T00:39:01.567+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16293485","id":"16293485","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user phunt commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/433\n  \n    lgtm. +1 thanks @afine \r\n    \r\n    please close this as it's not the default branch won't be closed automatically.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-16T00:41:39.053+0000","updated":"2017-12-16T00:41:39.053+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16293489","id":"16293489","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user phunt commented on the issue:\n\n    https://github.com/apache/zookeeper/pull/434\n  \n    lgtm +1 thanks @afine \r\n    \r\n    Please close this one as well.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-16T00:48:43.301+0000","updated":"2017-12-16T00:48:43.301+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16293490","id":"16293490","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"body":"lgtm, +1 thanks Abe.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=phunt","name":"phunt","key":"phunt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Hunt","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-12-16T00:49:05.295+0000","updated":"2017-12-16T00:49:05.295+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16293516","id":"16293516","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/433\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-16T01:07:36.901+0000","updated":"2017-12-16T01:07:36.901+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16293517","id":"16293517","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user afine closed the pull request at:\n\n    https://github.com/apache/zookeeper/pull/434\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-16T01:08:03.269+0000","updated":"2017-12-16T01:08:03.269+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13124534/comment/16293562","id":"16293562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #3661 (See [https://builds.apache.org/job/ZooKeeper-trunk/3661/])\nZOOKEEPER-2953: Flaky Test: testNoLogBeforeLeaderEstablishment (phunt: rev f2cbcc7e0d7adff08bd73a27f2193b1198e4c7f7)\n* (edit) src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerTestBase.java\n* (edit) src/java/test/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java\n* (edit) src/java/test/org/apache/zookeeper/test/QuorumTest.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-16T02:05:46.966+0000","updated":"2017-12-16T02:05:46.966+0000"}],"maxResults":32,"total":32,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/ZOOKEEPER-2953/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3nu0f:"}}