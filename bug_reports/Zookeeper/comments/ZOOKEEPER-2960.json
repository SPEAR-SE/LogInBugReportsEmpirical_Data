[Any comments on this? Has anyone been able to confirm it?
, Hi [~danmilon]

I'm taking a look.

Andor
, Hi [~danmilon]

Looks like you're right. QuorumPeerMain mixes the 2 directories and if the server is running in an ensemble, logs are going to be created in dataDir and snapshots are in dataLogDir. What's even more confusing is that it works right in standalone mode. 

QuorumPeerMain@139 (non-standalone mode):
{code:java}
runFromConfig() {
...
          quorumPeer.setTxnFactory(new FileTxnSnapLog(
                  new File(config.getDataDir()),
                  new File(config.getDataLogDir())));
{code}

ZookeeperServerMain@112 (standalone mode):
{code:java}
runFromConfig() {
...
            txnLog = new FileTxnSnapLog(new File(config.dataLogDir), new File(
                    config.dataDir));
{code}

The latter is the right way of doing it: FileTxnSnapLog expects dataLogDir (txn logs) in the 1st and dataDir (snapshots) in the 2nd argument., Looks like a pretty serious one.

This was introduced in branch-3.4 only and released in 3.4.11, because a small refactoring has been made in instantiation of QuorumPeer and now FileTxnSnapLog is created with wrong order of directories.

As part of:
https://issues.apache.org/jira/browse/ZOOKEEPER-2355

Github pull request:
https://github.com/apache/zookeeper/pull/304/files#diff-0b7ebe0e5e2011bb4ba7a9f352f948f7

I believe that users should revert to 3.4.10 and a new release has to be created., GitHub user anmolnar opened a pull request:

    https://github.com/apache/zookeeper/pull/441

    ZOOKEEPER-2960. The dataDir and dataLogDir are used opposingly

    Previously a small refactoring has swapped the usage of dataDir and dataLogDir when QuorumPeerMain instantiates FileTxnSnapLog class.
    
    This PR fixes it + adds unit test for verification.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/anmolnar/zookeeper ZOOKEEPER-2960

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/zookeeper/pull/441.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #441
    
----
commit 516147499541f7eb2b30f7a8cb4f50ed204469bb
Author: Andor Molnar <andor@...>
Date:   2018-01-03T14:47:26Z

    ZOOKEEPER-2960. Fixed usage of dataDir and dataLogDir when instantiating FileTxnSnapLog

----
, +1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1395//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1395//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1395//console

This message is automatically generated., Thanks [~andorm] for submitting your analysis and patch for this issue.
I also will have a look on this issue very soon., Thanks [~danmilon] for reporting this and [~andorm] for submitting a patch.

The fix looks good and I gave it a +1 on GitHub.

I'm wondering if we need to provide a way for users running 3.4.11 to be backwards compatible or we can just push a new release with this change (and hopefully ZOOKEEPER-2249 as well). 

Perhaps we should introduce a check of some kind? If datalogdir is different that datadir and snapshots exist in datalogdir we throw an exception and quit. What do you think?, Github user skamille commented on the issue:

    https://github.com/apache/zookeeper/pull/441
  
    +1 gonna attempt to commit this
, Github user anmolnar closed the pull request at:

    https://github.com/apache/zookeeper/pull/441
, Thank you guys :), Github user anmolnar commented on the issue:

    https://github.com/apache/zookeeper/pull/475
  
    I know what the problem is. 3.4.11 has a bug that swaps dataDir and dataLogDir from config file.
    Sorry, it's only mentioned briefly on the release page:
    http://zookeeper.apache.org/releases.html
    > WARNING: ZOOKEEPER-2960 was recently identified as a regression in 3.4.11 ...
    
    Please wait for 3.4.12 for the fix and in the meantime you can probably workaround it with your fix, but it should not be merged in the codebase.
, ijuma opened a new pull request #4678: MINOR: Revert to ZooKeeper 3.4.10 due to ZOOKEEPER-2960
URL: https://github.com/apache/kafka/pull/4678
 
 
   It's a critical bug that only affects the server, but we
   don't have an easy way to use 3.4.11 for the zookeeper
   client only.
   
   For reference the upgrade to ZooKeeper 3.4.11 was
   done via 2652565d429138c58.
   
   Testing strategy: relying on existing tests and reverted
   a change to a test to pass with 3.4.10.
   
   ### Committer Checklist (excluded from commit message)
   - [ ] Verify design and implementation 
   - [ ] Verify test coverage and CI build status
   - [ ] Verify documentation (including upgrade notes)
   

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org
, ijuma closed pull request #4678: MINOR: Revert to ZooKeeper 3.4.10 due to ZOOKEEPER-2960
URL: https://github.com/apache/kafka/pull/4678
 
 
   

This is a PR merged from a forked repository.
As GitHub hides the original diff on merge, it is displayed below for
the sake of provenance:

As this is a foreign pull request (from a fork), the diff is supplied
below (as it won't show otherwise due to GitHub magic):

diff --git a/core/src/test/scala/unit/kafka/server/ServerShutdownTest.scala b/core/src/test/scala/unit/kafka/server/ServerShutdownTest.scala
index 596c3539f83..5e33816783a 100755
--- a/core/src/test/scala/unit/kafka/server/ServerShutdownTest.scala
+++ b/core/src/test/scala/unit/kafka/server/ServerShutdownTest.scala
@@ -23,6 +23,7 @@ import kafka.utils.TestUtils._
 import kafka.api.FetchRequestBuilder
 import kafka.message.ByteBufferMessageSet
 import java.io.File
+import java.net.UnknownHostException
 
 import kafka.log.LogManager
 import org.apache.kafka.clients.producer.{KafkaProducer, ProducerRecord}
@@ -130,7 +131,7 @@ class ServerShutdownTest extends ZooKeeperTestHarness {
     val newProps = TestUtils.createBrokerConfig(0, zkConnect)
     newProps.setProperty("zookeeper.connect", "some.invalid.hostname.foo.bar.local:65535")
     val newConfig = KafkaConfig.fromProps(newProps)
-    verifyCleanShutdownAfterFailedStartup[IllegalArgumentException](newConfig)
+    verifyCleanShutdownAfterFailedStartup[UnknownHostException](newConfig)
   }
 
   @Test
diff --git a/core/src/test/scala/unit/kafka/zookeeper/ZooKeeperClientTest.scala b/core/src/test/scala/unit/kafka/zookeeper/ZooKeeperClientTest.scala
index 77e11eae716..4eb9e67bf60 100644
--- a/core/src/test/scala/unit/kafka/zookeeper/ZooKeeperClientTest.scala
+++ b/core/src/test/scala/unit/kafka/zookeeper/ZooKeeperClientTest.scala
@@ -16,6 +16,7 @@
  */
 package kafka.zookeeper
 
+import java.net.UnknownHostException
 import java.nio.charset.StandardCharsets
 import java.util.UUID
 import java.util.concurrent.atomic.AtomicBoolean
@@ -57,7 +58,7 @@ class ZooKeeperClientTest extends ZooKeeperTestHarness {
     System.clearProperty(JaasUtils.JAVA_LOGIN_CONFIG_PARAM)
   }
 
-  @Test(expected = classOf[IllegalArgumentException])
+  @Test(expected = classOf[UnknownHostException])
   def testUnresolvableConnectString(): Unit = {
     new ZooKeeperClient("some.invalid.hostname.foo.bar.local", -1, -1, Int.MaxValue, time, "testMetricGroup",
       "testMetricType").close()
diff --git a/gradle/dependencies.gradle b/gradle/dependencies.gradle
index 2ac496b4ca9..b7a03dcd752 100644
--- a/gradle/dependencies.gradle
+++ b/gradle/dependencies.gradle
@@ -71,7 +71,7 @@ versions += [
   slf4j: "1.7.25",
   snappy: "1.1.7.1",
   zkclient: "0.10",
-  zookeeper: "3.4.11",
+  zookeeper: "3.4.10",
   jfreechart: "1.0.0",
   mavenArtifact: "3.5.2"
 ]


 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org
]