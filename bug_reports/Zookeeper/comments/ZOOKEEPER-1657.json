[Note, the profiling was performed on a machine running for >24h. Thus, it's fair to say that the machine has been "warmed", i.e. all classes and stuff should be loaded., Client checks system property {{zookeeper.client.sasl}} before creating SASL authentication object to reduce wasted time later in ClientCnxn$SendThread.clientTunneledAuthenticationInProgress()., Hi Gunnar,
Thanks for providing this profiling data. I wonder if this patch will improve your profiling results?
-Eugene, Eugene, thanks! I'll try to create a custom build and gather some data., The patch does not seem to work:

{noformat}
22:03:12.589 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: 0,4  replyHeader:: 0,0,0  request:: '/gyrex/nodes/all/98e14413-6157-440a-aa49-9c61c70099d9,F  response::  until SASL authentication completes.
22:03:17.899 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: 0,4  replyHeader:: 0,0,0  request:: '/gyrex/nodes/all/98e14413-6157-440a-aa49-9c61c70099d9,F  response::  until SASL authentication completes.
22:03:17.901 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: 0,4  replyHeader:: 0,0,0  request:: '/gyrex/nodes/all/98e14413-6157-440a-aa49-9c61c70099d9,F  response::  until SASL authentication completes.
22:03:17.902 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: -2,11  replyHeader:: null request:: null response:: nulluntil SASL authentication completes.
22:03:27.902 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: 0,4  replyHeader:: 0,0,0  request:: '/gyrex/nodes/all/98e14413-6157-440a-aa49-9c61c70099d9,F  response::  until SASL authentication completes.
22:03:27.904 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: -2,11  replyHeader:: null request:: null response:: nulluntil SASL authentication completes.
22:03:27.905 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: 0,4  replyHeader:: 0,0,0  request:: '/gyrex/nodes/all/98e14413-6157-440a-aa49-9c61c70099d9,F  response::  until SASL authentication completes.
22:03:27.907 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: -2,11  replyHeader:: null request:: null response:: nulluntil SASL authentication completes.
22:03:27.908 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: -2,11  replyHeader:: null request:: null response:: nulluntil SASL authentication completes.
22:03:28.059 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: 0,4  replyHeader:: 0,0,0  request:: '/gyrex/nodes/all/98e14413-6157-440a-aa49-9c61c70099d9,F  response::  until SASL authentication completes.
22:03:28.060 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: -2,11  replyHeader:: null request:: null response:: nulluntil SASL authentication completes.
22:03:28.061 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] DEBUG o.a.zookeeper.ClientCnxnSocketNIO - deferring non-priming packet: clientPath:null serverPath:null finished:false header:: -2,11  replyHeader:: null request:: null response:: nulluntil SASL authentication completes.
22:03:28.062 [ZooKeeper Gate Connect Thread-SendThread(127.0.0.1:2181)] INFO  org.apache.zookeeper.ClientCnxn - Client session timed out, have not heard from server in 20005ms for sessionid 0x13d27c3d5620000, closing socket connection and attempting reconnect
22:03:28.077 [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181] WARN  o.a.zookeeper.server.NIOServerCnxn - caught end of stream exception
org.apache.zookeeper.server.ServerCnxn$EndOfStreamException: Unable to read additional data from client sessionid 0x13d27c3d5620000, likely client has closed socket
	at org.apache.zookeeper.server.NIOServerCnxn.doIO(NIOServerCnxn.java:220)
	at org.apache.zookeeper.server.NIOServerCnxnFactory.run(NIOServerCnxnFactory.java:208) 
	at java.lang.Thread.run(Thread.java:662) [na:1.6.0_26]
22:03:28.079 [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181] INFO  o.a.zookeeper.server.NIOServerCnxn - Closed socket connection for client /127.0.0.1:51730 which had sessionid 0x13d27c3d5620000
{noformat}, I got ZooKeeper running using the following additional changes:

{noformat}
===================================================================
--- src/org/apache/zookeeper/ClientCnxn.java	(first patched version)
+++ src/org/apache/zookeeper/ClientCnxn.java	(working copy)
@@ -939,7 +939,7 @@
 
             setName(getName().replaceAll("\\(.*\\)",
                     "(" + addr.getHostName() + ":" + addr.getPort() + ")"));
-            if (System.getProperty("zookeeper.client.sasl","false") == "true") {
+            if (System.getProperty("zookeeper.client.sasl","false").equals("true")) {
                 try {
                     zooKeeperSaslClient = new ZooKeeperSaslClient("zookeeper/"+addr.getHostName());
                 } catch (LoginException e) {
@@ -1234,9 +1234,10 @@
             }
 
             // 2. SendThread has not created the authenticating object yet,
-            // therefore authentication is (at the earliest stage of being) in progress.
+            // therefore authentication is (at the earliest stage of being) in progress;
+            // but only if SASL is actually in use.
             if (zooKeeperSaslClient == null) {
-                return true;
+                return System.getProperty("zookeeper.client.sasl","false").equals("true");
             }
 
             // 3. authenticating object exists, so ask it for its progress.
{noformat}, Add new zookeeper.sasl.client system property. True by default; set to "false" to disable SASL on client., Incorporate Gunnar's fix : use <string>.equals(<string>), not <string>==<string>., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12571652/ZOOKEEPER-1657.patch
  against trunk revision 1448007.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1413//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1413//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1413//console

This message is automatically generated., After deploying the fix on a separate node and profiling again (similar workload, similar conditions) I can confirm that ZooKeeper is no longer a hot-spot., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12571944/zookeeper-hotspot-gone.png
  against trunk revision 1448007.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1421//console

This message is automatically generated., Thanks for reporting back Gunnar! Good to hear that this patch fixes the hotspot. , Regarding: "Please justify why no new tests are needed for this patch."

This is an optimization that avoids some unnecessary code execution. No bugs are fixed and no new behavior is introduced that would require additional testing., If I am not wrong, this patch also solves the problem of the continuous SecurityException loggging., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12571944/zookeeper-hotspot-gone.png
  against trunk revision 1463329.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1477//console

This message is automatically generated., The patch didn't apply cleanly to trunk, could you upload a new patch, please?, I have taken Eugene's patch and applied it to ZooKeeper trunk (hope this is ok). I moved the logic to check if the SASL client was enabled to a static method, and added a test to verify the behavior (that the SASL client is enabled by default)., Submitting patch to let it run through jenkins., +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12598620/ZOOKEEPER-1657.patch
  against trunk revision 1516126.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1547//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1547//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1547//console

This message is automatically generated., I'd like to propose a small change to the name of the test class. I think it looks nicer to get it clustered with the other SASL test classes. Feel free to disagree, though. I'm uploading a patch with this change., +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12601126/ZOOKEEPER-1657.patch
  against trunk revision 1519515.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1554//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1554//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1554//console

This message is automatically generated., Can I get a +1 here please?, +1 for the patch. Looks good. Thanks Eugene/Flavio., Sorry to pitch in late. Patch looks nice.

Adding few observations about the patch:
# missing apache license headers in SaslClientTest.java
# its good practise to give 'error message while asserting' and would help in analysing failure logs. 
For example:
{code}
Assert.assertTrue("Didn't enabled ZooKeeperSaslClient!", ZooKeeperSaslClient.isEnabled());
{code}, Added missing license header and messages to assert statements., +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12602860/ZOOKEEPER-1657.patch
  against trunk revision 1522079.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1574//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1574//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1574//console

This message is automatically generated., Is this one ready to go? Can I get a +1, please?, [~rakeshr], Could you let me know if you have any other concern here, please? Otherwise, I'm going to get this in, since I have a +1 from [~mahadev] already., I was out of station for few days. Sorry for the delay.

In latest patch I could see the following, is it required?. Otw the patch is ready to go in.
{code}
Index: .project
===================================================================
--- .project	(revision 0)
+++ .project	(revision 0)
@@ -0,0 +1,11 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<projectDescription>
+	<name>zookeeper-1657-trunk</name>
+	<comment></comment>
+	<projects>
+	</projects>
+	<buildSpec>
+	</buildSpec>
+	<natures>
+	</natures>
+</projectDescription>
{code}, Thanks, I'll make sure not to add the .project file and upload the committed patch without it., Thanks [~fpj] +1 from me, please go ahead, Just run through QA to make sure., +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12603798/ZOOKEEPER-1657.patch
  against trunk revision 1524275.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1587//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1587//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1587//console

This message is automatically generated., b3.4: Committed revision 1524355., Trunk: Committed revision 1524364., SUCCESS: Integrated in ZooKeeper-trunk #2060 (See [https://builds.apache.org/job/ZooKeeper-trunk/2060/])
ZOOKEEPER-1657. Increased CPU usage by unnecessary SASL checks (Philip K. Warren via fpj) (fpj: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1524364)
* /zookeeper/trunk/CHANGES.txt
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/ClientCnxn.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/client/ZooKeeperSaslClient.java
* /zookeeper/trunk/src/java/test/org/apache/zookeeper/test/SaslClientTest.java
, Closing issues after releasing 3.4.6.]