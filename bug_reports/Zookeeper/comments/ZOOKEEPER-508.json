[this fixes the issue so that we sent the right packets when a follower syncs with the leader. also includes ZOOKEEPER-483., added a testcase for the DIFF problem. still not fixed., i fugured out the reason why it fails on the assertion errors != 0. The whole scenario of 483 fialing with truncate is this

- the test case shutdowns all the followers
- the leader does not realize that its lost the leadership, becasue the time we ping to see if the leader is still the leader (maybe 1 sec) is greater than the time hte followers actually take to shutdown and get back and in sync with the leader
- so the leader never shutsdown any of its stuff (no NIO rejection or nething else)

so in your case, sometimes the client conencts to the leader and will never see errors. On the other hand sometimes it may pas s on connection to other followers and your testcase will pass. So we cannot really say that your test case is fool proof.

, this patch includes fix for ZOOKEEPER-508, ZOOKEEPER-509, ZOOKEEPER-483. It also includes the test cases for each of them.
, I have a patch for the 3.2 branch, will upload is as soon as hudson is done running this patch., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12417189/ZOOKEEPER-508.patch
  against trunk revision 803300.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 9 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs warnings.

    -1 release audit.  The applied patch generated 178 release audit warnings (more than the trunk's current 177 warnings).

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/188/testReport/
Release audit warnings: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/188/artifact/trunk/patchprocess/releaseAuditDiffWarnings.txt
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/188/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/188/console

This message is automatically generated., attached missing header to the file., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12417207/ZOOKEEPER-508.patch
  against trunk revision 803300.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 9 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/189/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/189/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/189/console

This message is automatically generated., patch for 3.2

fixes all the issues, also the new one found by hudson running the tests.
, patch for trunk. 

- fixes all the issues with tests. , +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12417339/ZOOKEEPER-508.patch
  against trunk revision 803300.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 9 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/190/testReport/
Findbugs warnings: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/190/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: http://hudson.zones.apache.org/hudson/job/Zookeeper-Patch-vesta.apache.org/190/console

This message is automatically generated., +1 looks good. simple fix! :), I just committed this., Integrated in ZooKeeper-trunk #426 (See [http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/426/])
    . proposals and commits for DIFF and Truncate messages from the leader to the followers is buggy. (mahadev and ben via mahadev)
]