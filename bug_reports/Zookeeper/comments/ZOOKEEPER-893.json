[ZOOKEEPER-427 fixes only part of the problems and still caused problems for me. This solves all my problems, Thanks for the patch Thijs! It looks pretty good to me - good catch.

Do you think you might be able to write a test case that verifies correct behaviour when you send malformed messages to the control port? , I'll try to write a test case, but not exactly sure yet how to integrate. Need to look at some example unit tests first :), Missing a test., Adding a test and removing an if statement that became unnecessary with this patch from RecvWorker.run(). I'll be adding a patch for the 3.3 branch shortly., Thanks Flavio! I have been too busy to add a testcase and yours looks great!, Thanks, Thijs. Adding 3.3 patch. , +1 Great work, thanks!, Integrated in ZooKeeper-trunk #972 (See [https://hudson.apache.org/hudson/job/ZooKeeper-trunk/972/])
    ZOOKEEPER-893. ZooKeeper high cpu usage when invalid requests
]