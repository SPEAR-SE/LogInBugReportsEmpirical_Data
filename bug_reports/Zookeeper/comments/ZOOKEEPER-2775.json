[This issue has been discussed many times, many places but it was never concluded.
Thanks [~Bhupendra] for analyzing and reporting it.
Are you willing to submit the fix?, Discussed with [~Bhupendra] offline, I will submit the fix, Submitting patch for quick review, later i will raise merge request.
1) Fix has just one line change
2) Moved SaslAuthTest to org.apache.zookeeper package and added test case for this defect scenario, GitHub user arshadmohammad opened a pull request:

    https://github.com/apache/zookeeper/pull/254

    ZOOKEEPER-2775: ZK Client not able to connect with Xid out of order error

    Once client enters into Xid out of order issue, It never comes to normal state. It keeps trying to connect and  fail with the same error.  Recreating/Restarting is the only solution as of now. This happens because of bug in the ZK client code. This MR provides the fix. 

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/arshadmohammad/zookeeper ZOOKEEPER-2775-XidOutOfOrder

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/zookeeper/pull/254.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #254
    
----

----
, +1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 4 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/688//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/688//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/688//console

This message is automatically generated., Github user afine commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116581847
  
    --- Diff: src/java/test/org/apache/zookeeper/SaslAuthTest.java ---
    @@ -0,0 +1,187 @@
    +/**
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *     http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +
    +package org.apache.zookeeper;
    +
    +import java.io.File;
    +import java.io.FileWriter;
    +import java.io.IOException;
    +import java.lang.reflect.Field;
    +import java.util.ArrayList;
    +import java.util.List;
    +import java.util.concurrent.atomic.AtomicInteger;
    +import static org.junit.Assert.assertTrue;
    +
    +import org.apache.zookeeper.ClientCnxn.SendThread;
    +import org.apache.zookeeper.Watcher.Event.KeeperState;
    +import org.apache.zookeeper.ZooDefs.Ids;
    +import org.apache.zookeeper.data.ACL;
    +import org.apache.zookeeper.data.Id;
    +import org.apache.zookeeper.test.ClientBase;
    +import org.junit.AfterClass;
    +import org.junit.Assert;
    +import org.junit.BeforeClass;
    +import org.junit.Test;
    +
    +public class SaslAuthTest extends ClientBase {
    +
    +    @BeforeClass
    +    public static void init() {
    +        System.setProperty("zookeeper.authProvider.1", "org.apache.zookeeper.server.auth.SASLAuthenticationProvider");
    +        try {
    +            File tmpDir = createTmpDir();
    +            File saslConfFile = new File(tmpDir, "jaas.conf");
    +            FileWriter fwriter = new FileWriter(saslConfFile);
    +
    +            fwriter.write("" + "Server {\n" + "          org.apache.zookeeper.server.auth.DigestLoginModule required\n"
    +                    + "          user_super=\"test\";\n" + "};\n" + "Client {\n"
    +                    + "       org.apache.zookeeper.server.auth.DigestLoginModule required\n"
    +                    + "       username=\"super\"\n" + "       password=\"test\";\n" + "};" + "\n");
    +            fwriter.close();
    +            System.setProperty("java.security.auth.login.config", saslConfFile.getAbsolutePath());
    +        } catch (IOException e) {
    +            // could not create tmp directory to hold JAAS conf file : test will
    +            // fail now.
    +        }
    +    }
    +
    +    @AfterClass
    +    public static void clean() {
    +        System.clearProperty("zookeeper.authProvider.1");
    +        System.clearProperty("java.security.auth.login.config");
    +    }
    +
    +    private AtomicInteger authFailed = new AtomicInteger(0);
    +
    +    @Override
    +    protected TestableZooKeeper createClient(String hp) throws IOException, InterruptedException {
    +        MyWatcher watcher = new MyWatcher();
    +        return createClient(watcher, hp);
    +    }
    +
    +    private class MyWatcher extends CountdownWatcher {
    +        @Override
    +        public synchronized void process(WatchedEvent event) {
    +            if (event.getState() == KeeperState.AuthFailed) {
    +                authFailed.incrementAndGet();
    +            } else {
    +                super.process(event);
    +            }
    +        }
    +    }
    +
    +    @Test
    +    public void testAuth() throws Exception {
    +        ZooKeeper zk = createClient();
    +        try {
    +            zk.create("/path1", null, Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);
    +            Thread.sleep(1000);
    +        } finally {
    +            zk.close();
    +        }
    +    }
    +
    +    @Test
    +    public void testValidSaslIds() throws Exception {
    +        ZooKeeper zk = createClient();
    +
    +        List<String> validIds = new ArrayList<String>();
    +        validIds.add("user");
    +        validIds.add("service/host.name.com");
    +        validIds.add("user@KERB.REALM");
    +        validIds.add("service/host.name.com@KERB.REALM");
    +
    +        int i = 0;
    +        for (String validId : validIds) {
    +            List<ACL> aclList = new ArrayList<ACL>();
    +            ACL acl = new ACL(0, new Id("sasl", validId));
    +            aclList.add(acl);
    +            zk.create("/valid" + i, null, aclList, CreateMode.PERSISTENT);
    +            i++;
    +        }
    +    }
    +
    +    @Test
    +    public void testInvalidSaslIds() throws Exception {
    +        ZooKeeper zk = createClient();
    +
    +        List<String> invalidIds = new ArrayList<String>();
    +        invalidIds.add("user@KERB.REALM/server.com");
    +        invalidIds.add("user@KERB.REALM1@KERB.REALM2");
    +
    +        int i = 0;
    +        for (String invalidId : invalidIds) {
    +            List<ACL> aclList = new ArrayList<ACL>();
    +            try {
    +                ACL acl = new ACL(0, new Id("sasl", invalidId));
    +                aclList.add(acl);
    +                zk.create("/invalid" + i, null, aclList, CreateMode.PERSISTENT);
    +                Assert.fail("SASLAuthenticationProvider.isValid() failed to catch invalid Id.");
    +            } catch (KeeperException.InvalidACLException e) {
    +                // ok.
    +            } finally {
    +                i++;
    +            }
    +        }
    +    }
    +
    +    @Test
    +    public void testZKOperationsAfterClientSaslAuthFailure() throws Exception {
    +        CountdownWatcher watcher = new CountdownWatcher();
    +        ZooKeeper zk = new ZooKeeper(hostPort, CONNECTION_TIMEOUT, watcher);
    +        watcher.waitForConnected(CONNECTION_TIMEOUT);
    +        try {
    +            setSaslFailureFlag(zk);
    +
    +            // try node creation for around 15 second,
    +            int totalTry = 10;
    +            int tryCount = 0;
    +
    +            boolean success = false;
    +            while (!success && tryCount++ <= totalTry) {
    +                try {
    +                    zk.create("/saslAuthFail", "data".getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                            CreateMode.PERSISTENT_SEQUENTIAL);
    +                    success = true;
    +                } catch (KeeperException.ConnectionLossException e) {
    +                    Thread.sleep(1000);
    +                    // do nothing
    +                }
    +            }
    +            assertTrue("ZNode creation is failing continusly after Sasl auth failure.", success);
    +
    +        } finally {
    +            zk.close();
    +        }
    +    }
    +
    +    // set saslLoginFailed to true to simulate SASL login failure,
    +    // LoginException
    +    private void setSaslFailureFlag(ZooKeeper zk) throws Exception {
    --- End diff --
    
    would it be possible to inject a mock ZooKeeperSaslClient for the test, it may be cleaner and more maintainable than reflection?
, Github user afine commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116581496
  
    --- Diff: src/java/test/org/apache/zookeeper/SaslAuthTest.java ---
    @@ -0,0 +1,187 @@
    +/**
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *     http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +
    +package org.apache.zookeeper;
    +
    +import java.io.File;
    +import java.io.FileWriter;
    +import java.io.IOException;
    +import java.lang.reflect.Field;
    +import java.util.ArrayList;
    +import java.util.List;
    +import java.util.concurrent.atomic.AtomicInteger;
    +import static org.junit.Assert.assertTrue;
    +
    +import org.apache.zookeeper.ClientCnxn.SendThread;
    +import org.apache.zookeeper.Watcher.Event.KeeperState;
    +import org.apache.zookeeper.ZooDefs.Ids;
    +import org.apache.zookeeper.data.ACL;
    +import org.apache.zookeeper.data.Id;
    +import org.apache.zookeeper.test.ClientBase;
    +import org.junit.AfterClass;
    +import org.junit.Assert;
    +import org.junit.BeforeClass;
    +import org.junit.Test;
    +
    +public class SaslAuthTest extends ClientBase {
    +
    +    @BeforeClass
    +    public static void init() {
    +        System.setProperty("zookeeper.authProvider.1", "org.apache.zookeeper.server.auth.SASLAuthenticationProvider");
    +        try {
    +            File tmpDir = createTmpDir();
    +            File saslConfFile = new File(tmpDir, "jaas.conf");
    +            FileWriter fwriter = new FileWriter(saslConfFile);
    +
    +            fwriter.write("" + "Server {\n" + "          org.apache.zookeeper.server.auth.DigestLoginModule required\n"
    +                    + "          user_super=\"test\";\n" + "};\n" + "Client {\n"
    +                    + "       org.apache.zookeeper.server.auth.DigestLoginModule required\n"
    +                    + "       username=\"super\"\n" + "       password=\"test\";\n" + "};" + "\n");
    +            fwriter.close();
    +            System.setProperty("java.security.auth.login.config", saslConfFile.getAbsolutePath());
    +        } catch (IOException e) {
    +            // could not create tmp directory to hold JAAS conf file : test will
    +            // fail now.
    +        }
    +    }
    +
    +    @AfterClass
    +    public static void clean() {
    +        System.clearProperty("zookeeper.authProvider.1");
    +        System.clearProperty("java.security.auth.login.config");
    +    }
    +
    +    private AtomicInteger authFailed = new AtomicInteger(0);
    +
    +    @Override
    +    protected TestableZooKeeper createClient(String hp) throws IOException, InterruptedException {
    +        MyWatcher watcher = new MyWatcher();
    +        return createClient(watcher, hp);
    +    }
    +
    +    private class MyWatcher extends CountdownWatcher {
    +        @Override
    +        public synchronized void process(WatchedEvent event) {
    +            if (event.getState() == KeeperState.AuthFailed) {
    +                authFailed.incrementAndGet();
    +            } else {
    +                super.process(event);
    +            }
    +        }
    +    }
    +
    +    @Test
    +    public void testAuth() throws Exception {
    +        ZooKeeper zk = createClient();
    +        try {
    +            zk.create("/path1", null, Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);
    +            Thread.sleep(1000);
    +        } finally {
    +            zk.close();
    +        }
    +    }
    +
    +    @Test
    +    public void testValidSaslIds() throws Exception {
    +        ZooKeeper zk = createClient();
    +
    +        List<String> validIds = new ArrayList<String>();
    +        validIds.add("user");
    +        validIds.add("service/host.name.com");
    +        validIds.add("user@KERB.REALM");
    +        validIds.add("service/host.name.com@KERB.REALM");
    +
    +        int i = 0;
    +        for (String validId : validIds) {
    +            List<ACL> aclList = new ArrayList<ACL>();
    +            ACL acl = new ACL(0, new Id("sasl", validId));
    +            aclList.add(acl);
    +            zk.create("/valid" + i, null, aclList, CreateMode.PERSISTENT);
    +            i++;
    +        }
    +    }
    +
    +    @Test
    +    public void testInvalidSaslIds() throws Exception {
    +        ZooKeeper zk = createClient();
    +
    +        List<String> invalidIds = new ArrayList<String>();
    +        invalidIds.add("user@KERB.REALM/server.com");
    +        invalidIds.add("user@KERB.REALM1@KERB.REALM2");
    +
    +        int i = 0;
    +        for (String invalidId : invalidIds) {
    +            List<ACL> aclList = new ArrayList<ACL>();
    +            try {
    +                ACL acl = new ACL(0, new Id("sasl", invalidId));
    +                aclList.add(acl);
    +                zk.create("/invalid" + i, null, aclList, CreateMode.PERSISTENT);
    +                Assert.fail("SASLAuthenticationProvider.isValid() failed to catch invalid Id.");
    +            } catch (KeeperException.InvalidACLException e) {
    +                // ok.
    +            } finally {
    +                i++;
    +            }
    +        }
    +    }
    +
    +    @Test
    +    public void testZKOperationsAfterClientSaslAuthFailure() throws Exception {
    +        CountdownWatcher watcher = new CountdownWatcher();
    +        ZooKeeper zk = new ZooKeeper(hostPort, CONNECTION_TIMEOUT, watcher);
    +        watcher.waitForConnected(CONNECTION_TIMEOUT);
    +        try {
    +            setSaslFailureFlag(zk);
    +
    +            // try node creation for around 15 second,
    +            int totalTry = 10;
    +            int tryCount = 0;
    +
    +            boolean success = false;
    +            while (!success && tryCount++ <= totalTry) {
    +                try {
    +                    zk.create("/saslAuthFail", "data".getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                            CreateMode.PERSISTENT_SEQUENTIAL);
    +                    success = true;
    +                } catch (KeeperException.ConnectionLossException e) {
    +                    Thread.sleep(1000);
    +                    // do nothing
    +                }
    +            }
    +            assertTrue("ZNode creation is failing continusly after Sasl auth failure.", success);
    --- End diff --
    
    typo: continuously
, Github user afine commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116565952
  
    --- Diff: src/java/test/org/apache/zookeeper/SaslAuthTest.java ---
    @@ -0,0 +1,187 @@
    +/**
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *     http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +
    +package org.apache.zookeeper;
    +
    +import java.io.File;
    +import java.io.FileWriter;
    +import java.io.IOException;
    +import java.lang.reflect.Field;
    +import java.util.ArrayList;
    +import java.util.List;
    +import java.util.concurrent.atomic.AtomicInteger;
    +import static org.junit.Assert.assertTrue;
    +
    +import org.apache.zookeeper.ClientCnxn.SendThread;
    +import org.apache.zookeeper.Watcher.Event.KeeperState;
    +import org.apache.zookeeper.ZooDefs.Ids;
    +import org.apache.zookeeper.data.ACL;
    +import org.apache.zookeeper.data.Id;
    +import org.apache.zookeeper.test.ClientBase;
    +import org.junit.AfterClass;
    +import org.junit.Assert;
    +import org.junit.BeforeClass;
    +import org.junit.Test;
    +
    +public class SaslAuthTest extends ClientBase {
    --- End diff --
    
    why was this file moved?
, Github user afine commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116570478
  
    --- Diff: src/java/main/org/apache/zookeeper/ClientCnxn.java ---
    @@ -1080,6 +1080,8 @@ private void startConnect() throws IOException {
                             zooKeeperSaslClient.shutdown();
                         }
                         zooKeeperSaslClient = new ZooKeeperSaslClient(getServerPrincipal(addr), clientConfig);
    +                    // SASL login succeeded
    +                    saslLoginFailed = false;
    --- End diff --
    
    I wonder if this will impact `clientTunneledAuthenticationInProgress`? Perhaps we should revert this when a new connection attempt starts?
, Github user afine commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116578675
  
    --- Diff: src/java/test/org/apache/zookeeper/SaslAuthTest.java ---
    @@ -0,0 +1,187 @@
    +/**
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *     http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +
    +package org.apache.zookeeper;
    +
    +import java.io.File;
    +import java.io.FileWriter;
    +import java.io.IOException;
    +import java.lang.reflect.Field;
    +import java.util.ArrayList;
    +import java.util.List;
    +import java.util.concurrent.atomic.AtomicInteger;
    +import static org.junit.Assert.assertTrue;
    +
    +import org.apache.zookeeper.ClientCnxn.SendThread;
    +import org.apache.zookeeper.Watcher.Event.KeeperState;
    +import org.apache.zookeeper.ZooDefs.Ids;
    +import org.apache.zookeeper.data.ACL;
    +import org.apache.zookeeper.data.Id;
    +import org.apache.zookeeper.test.ClientBase;
    +import org.junit.AfterClass;
    +import org.junit.Assert;
    +import org.junit.BeforeClass;
    +import org.junit.Test;
    +
    +public class SaslAuthTest extends ClientBase {
    --- End diff --
    
    and i think the diff would be cleaner if a `git mv` was used instead of adding one file and deleting the other.
, Github user hanm commented on the issue:

    https://github.com/apache/zookeeper/pull/254
  
    How about removing saslLoginFailed and use zooKeeperSaslClient to track the state of sasl login? The invariant would be:
    * sasl login failed: zooKeeperSaslClient == null
    * sasl login succeeded or in progress: zooKeeperSaslClient != null
, Github user arshadmohammad commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116871274
  
    --- Diff: src/java/test/org/apache/zookeeper/SaslAuthTest.java ---
    @@ -0,0 +1,187 @@
    +/**
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *     http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +
    +package org.apache.zookeeper;
    +
    +import java.io.File;
    +import java.io.FileWriter;
    +import java.io.IOException;
    +import java.lang.reflect.Field;
    +import java.util.ArrayList;
    +import java.util.List;
    +import java.util.concurrent.atomic.AtomicInteger;
    +import static org.junit.Assert.assertTrue;
    +
    +import org.apache.zookeeper.ClientCnxn.SendThread;
    +import org.apache.zookeeper.Watcher.Event.KeeperState;
    +import org.apache.zookeeper.ZooDefs.Ids;
    +import org.apache.zookeeper.data.ACL;
    +import org.apache.zookeeper.data.Id;
    +import org.apache.zookeeper.test.ClientBase;
    +import org.junit.AfterClass;
    +import org.junit.Assert;
    +import org.junit.BeforeClass;
    +import org.junit.Test;
    +
    +public class SaslAuthTest extends ClientBase {
    --- End diff --
    
    File was moved to make SendThread accessible in the test case.  Now moved with git mv. This is the right way to move the file
, Github user arshadmohammad commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116871380
  
    --- Diff: src/java/test/org/apache/zookeeper/SaslAuthTest.java ---
    @@ -0,0 +1,187 @@
    +/**
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *     http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +
    +package org.apache.zookeeper;
    +
    +import java.io.File;
    +import java.io.FileWriter;
    +import java.io.IOException;
    +import java.lang.reflect.Field;
    +import java.util.ArrayList;
    +import java.util.List;
    +import java.util.concurrent.atomic.AtomicInteger;
    +import static org.junit.Assert.assertTrue;
    +
    +import org.apache.zookeeper.ClientCnxn.SendThread;
    +import org.apache.zookeeper.Watcher.Event.KeeperState;
    +import org.apache.zookeeper.ZooDefs.Ids;
    +import org.apache.zookeeper.data.ACL;
    +import org.apache.zookeeper.data.Id;
    +import org.apache.zookeeper.test.ClientBase;
    +import org.junit.AfterClass;
    +import org.junit.Assert;
    +import org.junit.BeforeClass;
    +import org.junit.Test;
    +
    +public class SaslAuthTest extends ClientBase {
    +
    +    @BeforeClass
    +    public static void init() {
    +        System.setProperty("zookeeper.authProvider.1", "org.apache.zookeeper.server.auth.SASLAuthenticationProvider");
    +        try {
    +            File tmpDir = createTmpDir();
    +            File saslConfFile = new File(tmpDir, "jaas.conf");
    +            FileWriter fwriter = new FileWriter(saslConfFile);
    +
    +            fwriter.write("" + "Server {\n" + "          org.apache.zookeeper.server.auth.DigestLoginModule required\n"
    +                    + "          user_super=\"test\";\n" + "};\n" + "Client {\n"
    +                    + "       org.apache.zookeeper.server.auth.DigestLoginModule required\n"
    +                    + "       username=\"super\"\n" + "       password=\"test\";\n" + "};" + "\n");
    +            fwriter.close();
    +            System.setProperty("java.security.auth.login.config", saslConfFile.getAbsolutePath());
    +        } catch (IOException e) {
    +            // could not create tmp directory to hold JAAS conf file : test will
    +            // fail now.
    +        }
    +    }
    +
    +    @AfterClass
    +    public static void clean() {
    +        System.clearProperty("zookeeper.authProvider.1");
    +        System.clearProperty("java.security.auth.login.config");
    +    }
    +
    +    private AtomicInteger authFailed = new AtomicInteger(0);
    +
    +    @Override
    +    protected TestableZooKeeper createClient(String hp) throws IOException, InterruptedException {
    +        MyWatcher watcher = new MyWatcher();
    +        return createClient(watcher, hp);
    +    }
    +
    +    private class MyWatcher extends CountdownWatcher {
    +        @Override
    +        public synchronized void process(WatchedEvent event) {
    +            if (event.getState() == KeeperState.AuthFailed) {
    +                authFailed.incrementAndGet();
    +            } else {
    +                super.process(event);
    +            }
    +        }
    +    }
    +
    +    @Test
    +    public void testAuth() throws Exception {
    +        ZooKeeper zk = createClient();
    +        try {
    +            zk.create("/path1", null, Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);
    +            Thread.sleep(1000);
    +        } finally {
    +            zk.close();
    +        }
    +    }
    +
    +    @Test
    +    public void testValidSaslIds() throws Exception {
    +        ZooKeeper zk = createClient();
    +
    +        List<String> validIds = new ArrayList<String>();
    +        validIds.add("user");
    +        validIds.add("service/host.name.com");
    +        validIds.add("user@KERB.REALM");
    +        validIds.add("service/host.name.com@KERB.REALM");
    +
    +        int i = 0;
    +        for (String validId : validIds) {
    +            List<ACL> aclList = new ArrayList<ACL>();
    +            ACL acl = new ACL(0, new Id("sasl", validId));
    +            aclList.add(acl);
    +            zk.create("/valid" + i, null, aclList, CreateMode.PERSISTENT);
    +            i++;
    +        }
    +    }
    +
    +    @Test
    +    public void testInvalidSaslIds() throws Exception {
    +        ZooKeeper zk = createClient();
    +
    +        List<String> invalidIds = new ArrayList<String>();
    +        invalidIds.add("user@KERB.REALM/server.com");
    +        invalidIds.add("user@KERB.REALM1@KERB.REALM2");
    +
    +        int i = 0;
    +        for (String invalidId : invalidIds) {
    +            List<ACL> aclList = new ArrayList<ACL>();
    +            try {
    +                ACL acl = new ACL(0, new Id("sasl", invalidId));
    +                aclList.add(acl);
    +                zk.create("/invalid" + i, null, aclList, CreateMode.PERSISTENT);
    +                Assert.fail("SASLAuthenticationProvider.isValid() failed to catch invalid Id.");
    +            } catch (KeeperException.InvalidACLException e) {
    +                // ok.
    +            } finally {
    +                i++;
    +            }
    +        }
    +    }
    +
    +    @Test
    +    public void testZKOperationsAfterClientSaslAuthFailure() throws Exception {
    +        CountdownWatcher watcher = new CountdownWatcher();
    +        ZooKeeper zk = new ZooKeeper(hostPort, CONNECTION_TIMEOUT, watcher);
    +        watcher.waitForConnected(CONNECTION_TIMEOUT);
    +        try {
    +            setSaslFailureFlag(zk);
    +
    +            // try node creation for around 15 second,
    +            int totalTry = 10;
    +            int tryCount = 0;
    +
    +            boolean success = false;
    +            while (!success && tryCount++ <= totalTry) {
    +                try {
    +                    zk.create("/saslAuthFail", "data".getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                            CreateMode.PERSISTENT_SEQUENTIAL);
    +                    success = true;
    +                } catch (KeeperException.ConnectionLossException e) {
    +                    Thread.sleep(1000);
    +                    // do nothing
    +                }
    +            }
    +            assertTrue("ZNode creation is failing continusly after Sasl auth failure.", success);
    --- End diff --
    
    corrected
, Github user arshadmohammad commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116871534
  
    --- Diff: src/java/test/org/apache/zookeeper/SaslAuthTest.java ---
    @@ -0,0 +1,187 @@
    +/**
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *     http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +
    +package org.apache.zookeeper;
    +
    +import java.io.File;
    +import java.io.FileWriter;
    +import java.io.IOException;
    +import java.lang.reflect.Field;
    +import java.util.ArrayList;
    +import java.util.List;
    +import java.util.concurrent.atomic.AtomicInteger;
    +import static org.junit.Assert.assertTrue;
    +
    +import org.apache.zookeeper.ClientCnxn.SendThread;
    +import org.apache.zookeeper.Watcher.Event.KeeperState;
    +import org.apache.zookeeper.ZooDefs.Ids;
    +import org.apache.zookeeper.data.ACL;
    +import org.apache.zookeeper.data.Id;
    +import org.apache.zookeeper.test.ClientBase;
    +import org.junit.AfterClass;
    +import org.junit.Assert;
    +import org.junit.BeforeClass;
    +import org.junit.Test;
    +
    +public class SaslAuthTest extends ClientBase {
    +
    +    @BeforeClass
    +    public static void init() {
    +        System.setProperty("zookeeper.authProvider.1", "org.apache.zookeeper.server.auth.SASLAuthenticationProvider");
    +        try {
    +            File tmpDir = createTmpDir();
    +            File saslConfFile = new File(tmpDir, "jaas.conf");
    +            FileWriter fwriter = new FileWriter(saslConfFile);
    +
    +            fwriter.write("" + "Server {\n" + "          org.apache.zookeeper.server.auth.DigestLoginModule required\n"
    +                    + "          user_super=\"test\";\n" + "};\n" + "Client {\n"
    +                    + "       org.apache.zookeeper.server.auth.DigestLoginModule required\n"
    +                    + "       username=\"super\"\n" + "       password=\"test\";\n" + "};" + "\n");
    +            fwriter.close();
    +            System.setProperty("java.security.auth.login.config", saslConfFile.getAbsolutePath());
    +        } catch (IOException e) {
    +            // could not create tmp directory to hold JAAS conf file : test will
    +            // fail now.
    +        }
    +    }
    +
    +    @AfterClass
    +    public static void clean() {
    +        System.clearProperty("zookeeper.authProvider.1");
    +        System.clearProperty("java.security.auth.login.config");
    +    }
    +
    +    private AtomicInteger authFailed = new AtomicInteger(0);
    +
    +    @Override
    +    protected TestableZooKeeper createClient(String hp) throws IOException, InterruptedException {
    +        MyWatcher watcher = new MyWatcher();
    +        return createClient(watcher, hp);
    +    }
    +
    +    private class MyWatcher extends CountdownWatcher {
    +        @Override
    +        public synchronized void process(WatchedEvent event) {
    +            if (event.getState() == KeeperState.AuthFailed) {
    +                authFailed.incrementAndGet();
    +            } else {
    +                super.process(event);
    +            }
    +        }
    +    }
    +
    +    @Test
    +    public void testAuth() throws Exception {
    +        ZooKeeper zk = createClient();
    +        try {
    +            zk.create("/path1", null, Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);
    +            Thread.sleep(1000);
    +        } finally {
    +            zk.close();
    +        }
    +    }
    +
    +    @Test
    +    public void testValidSaslIds() throws Exception {
    +        ZooKeeper zk = createClient();
    +
    +        List<String> validIds = new ArrayList<String>();
    +        validIds.add("user");
    +        validIds.add("service/host.name.com");
    +        validIds.add("user@KERB.REALM");
    +        validIds.add("service/host.name.com@KERB.REALM");
    +
    +        int i = 0;
    +        for (String validId : validIds) {
    +            List<ACL> aclList = new ArrayList<ACL>();
    +            ACL acl = new ACL(0, new Id("sasl", validId));
    +            aclList.add(acl);
    +            zk.create("/valid" + i, null, aclList, CreateMode.PERSISTENT);
    +            i++;
    +        }
    +    }
    +
    +    @Test
    +    public void testInvalidSaslIds() throws Exception {
    +        ZooKeeper zk = createClient();
    +
    +        List<String> invalidIds = new ArrayList<String>();
    +        invalidIds.add("user@KERB.REALM/server.com");
    +        invalidIds.add("user@KERB.REALM1@KERB.REALM2");
    +
    +        int i = 0;
    +        for (String invalidId : invalidIds) {
    +            List<ACL> aclList = new ArrayList<ACL>();
    +            try {
    +                ACL acl = new ACL(0, new Id("sasl", invalidId));
    +                aclList.add(acl);
    +                zk.create("/invalid" + i, null, aclList, CreateMode.PERSISTENT);
    +                Assert.fail("SASLAuthenticationProvider.isValid() failed to catch invalid Id.");
    +            } catch (KeeperException.InvalidACLException e) {
    +                // ok.
    +            } finally {
    +                i++;
    +            }
    +        }
    +    }
    +
    +    @Test
    +    public void testZKOperationsAfterClientSaslAuthFailure() throws Exception {
    +        CountdownWatcher watcher = new CountdownWatcher();
    +        ZooKeeper zk = new ZooKeeper(hostPort, CONNECTION_TIMEOUT, watcher);
    +        watcher.waitForConnected(CONNECTION_TIMEOUT);
    +        try {
    +            setSaslFailureFlag(zk);
    +
    +            // try node creation for around 15 second,
    +            int totalTry = 10;
    +            int tryCount = 0;
    +
    +            boolean success = false;
    +            while (!success && tryCount++ <= totalTry) {
    +                try {
    +                    zk.create("/saslAuthFail", "data".getBytes(), Ids.OPEN_ACL_UNSAFE,
    +                            CreateMode.PERSISTENT_SEQUENTIAL);
    +                    success = true;
    +                } catch (KeeperException.ConnectionLossException e) {
    +                    Thread.sleep(1000);
    +                    // do nothing
    +                }
    +            }
    +            assertTrue("ZNode creation is failing continusly after Sasl auth failure.", success);
    +
    +        } finally {
    +            zk.close();
    +        }
    +    }
    +
    +    // set saslLoginFailed to true to simulate SASL login failure,
    +    // LoginException
    +    private void setSaslFailureFlag(ZooKeeper zk) throws Exception {
    --- End diff --
    
    There will be lot of code change which I want to avoid.
, Github user arshadmohammad commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116872750
  
    --- Diff: src/java/main/org/apache/zookeeper/ClientCnxn.java ---
    @@ -1080,6 +1080,8 @@ private void startConnect() throws IOException {
                             zooKeeperSaslClient.shutdown();
                         }
                         zooKeeperSaslClient = new ZooKeeperSaslClient(getServerPrincipal(addr), clientConfig);
    +                    // SASL login succeeded
    +                    saslLoginFailed = false;
    --- End diff --
    
    this change has impact on tunnelAuthInProgress.  But yes, we should init the variable on new connection start as this is tunnelAuthInProgress logic expects.
, Github user arshadmohammad commented on the issue:

    https://github.com/apache/zookeeper/pull/254
  
     zooKeeperSaslClient == null is already used in tunnelAuthInProgress() which is quite different from saslLoginFailed being false. So I think we can not do above change.
, Github user arshadmohammad commented on the issue:

    https://github.com/apache/zookeeper/pull/254
  
    Thanks @afine @hanm for the reviews. Addressed the comments, Please have a look.
, +1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 5 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/693//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/693//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/693//console

This message is automatically generated., Github user hanm commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116879091
  
    --- Diff: src/java/test/org/apache/zookeeper/SaslAuthTest.java ---
    @@ -16,54 +16,58 @@
      * limitations under the License.
      */
     
    -package org.apache.zookeeper.test;
    +package org.apache.zookeeper;
    +
    +import static org.junit.Assert.assertTrue;
     
     import java.io.File;
     import java.io.FileWriter;
     import java.io.IOException;
    +import java.lang.reflect.Field;
     import java.util.ArrayList;
     import java.util.List;
     import java.util.concurrent.atomic.AtomicInteger;
     
    -import org.apache.zookeeper.CreateMode;
    -import org.apache.zookeeper.KeeperException;
    -import org.apache.zookeeper.TestableZooKeeper;
    -import org.apache.zookeeper.WatchedEvent;
    -import org.apache.zookeeper.ZooKeeper;
    +import org.apache.zookeeper.ClientCnxn.SendThread;
     import org.apache.zookeeper.Watcher.Event.KeeperState;
     import org.apache.zookeeper.ZooDefs.Ids;
     import org.apache.zookeeper.data.ACL;
     import org.apache.zookeeper.data.Id;
    +import org.apache.zookeeper.test.ClientBase;
    +import org.junit.AfterClass;
     import org.junit.Assert;
    +import org.junit.BeforeClass;
     import org.junit.Test;
     
     public class SaslAuthTest extends ClientBase {
    -    static {
    -        System.setProperty("zookeeper.authProvider.1","org.apache.zookeeper.server.auth.SASLAuthenticationProvider");
    -
    +    @BeforeClass
    +    public static void init() {
    +        System.setProperty("zookeeper.authProvider.1",
    +                "org.apache.zookeeper.server.auth.SASLAuthenticationProvider");
             try {
                 File tmpDir = createTmpDir();
                 File saslConfFile = new File(tmpDir, "jaas.conf");
                 FileWriter fwriter = new FileWriter(saslConfFile);
     
    -            fwriter.write("" +
    -                    "Server {\n" +
    -                    "          org.apache.zookeeper.server.auth.DigestLoginModule required\n" +
    -                    "          user_super=\"test\";\n" +
    -                    "};\n" +
    -                    "Client {\n" +
    -                    "       org.apache.zookeeper.server.auth.DigestLoginModule required\n" +
    -                    "       username=\"super\"\n" +
    -                    "       password=\"test\";\n" +
    -                    "};" + "\n");
    +            fwriter.write("" + "Server {\n"
    --- End diff --
    
    Nit: not sure if change is by accident or not, but this made readability worse.
, Github user hanm commented on the issue:

    https://github.com/apache/zookeeper/pull/254
  
    >> So I think we can not do above change.
    
    Correct - I was looking to consolidate unnecessary variables used to encode states but looks like we do need saslLoginFailed.
    
    lgtm just with one nit on the test file readability.
, Github user rakeshadr commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r116976191
  
    --- Diff: src/java/main/org/apache/zookeeper/ClientCnxn.java ---
    @@ -1054,6 +1054,8 @@ private void sendPing() {
             private boolean saslLoginFailed = false;
     
             private void startConnect() throws IOException {
    +            // initializing it for new connection
    +            saslLoginFailed = false;
    --- End diff --
    
    How about setting to false only after client has successfully logged in instead of setting to false at the beginning. 
    ```
    zooKeeperSaslClient = new ZooKeeperSaslClient(getServerPrincipal(addr), clientConfig);
    saslLoginFailed = false;
    ```
    I'm not sure about any concurrency cases between narrow window of resetting the flag to false and the client attempt to do login operation. Since the previous operation was failed, the client should still reflect the status until the login is successful next time, right?

, Github user arshadmohammad commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r117014954
  
    --- Diff: src/java/main/org/apache/zookeeper/ClientCnxn.java ---
    @@ -1054,6 +1054,8 @@ private void sendPing() {
             private boolean saslLoginFailed = false;
     
             private void startConnect() throws IOException {
    +            // initializing it for new connection
    +            saslLoginFailed = false;
    --- End diff --
    
    Only one thread involved in new connection creation. So there will not any chance another thread setting the flag in between.

, Github user arshadmohammad commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r117016986
  
    --- Diff: src/java/main/org/apache/zookeeper/ClientCnxn.java ---
    @@ -1054,6 +1054,8 @@ private void sendPing() {
             private boolean saslLoginFailed = false;
     
             private void startConnect() throws IOException {
    +            // initializing it for new connection
    +            saslLoginFailed = false;
    --- End diff --
    
    Successfull Login is not necessary to successfully connect to ZK Server.  ZK server may allow connection without client login being successful, based on configuration. So it is better to set the flag at the start of the new connection.  
    This change has impact on tunnelAuthInProgress, in this method also same thing is expeted. In this there is a sceanrio where zooKeeperSaslClient can be null
, Github user arshadmohammad commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r117021379
  
    --- Diff: src/java/test/org/apache/zookeeper/SaslAuthTest.java ---
    @@ -16,54 +16,58 @@
      * limitations under the License.
      */
     
    -package org.apache.zookeeper.test;
    +package org.apache.zookeeper;
    +
    +import static org.junit.Assert.assertTrue;
     
     import java.io.File;
     import java.io.FileWriter;
     import java.io.IOException;
    +import java.lang.reflect.Field;
     import java.util.ArrayList;
     import java.util.List;
     import java.util.concurrent.atomic.AtomicInteger;
     
    -import org.apache.zookeeper.CreateMode;
    -import org.apache.zookeeper.KeeperException;
    -import org.apache.zookeeper.TestableZooKeeper;
    -import org.apache.zookeeper.WatchedEvent;
    -import org.apache.zookeeper.ZooKeeper;
    +import org.apache.zookeeper.ClientCnxn.SendThread;
     import org.apache.zookeeper.Watcher.Event.KeeperState;
     import org.apache.zookeeper.ZooDefs.Ids;
     import org.apache.zookeeper.data.ACL;
     import org.apache.zookeeper.data.Id;
    +import org.apache.zookeeper.test.ClientBase;
    +import org.junit.AfterClass;
     import org.junit.Assert;
    +import org.junit.BeforeClass;
     import org.junit.Test;
     
     public class SaslAuthTest extends ClientBase {
    -    static {
    -        System.setProperty("zookeeper.authProvider.1","org.apache.zookeeper.server.auth.SASLAuthenticationProvider");
    -
    +    @BeforeClass
    +    public static void init() {
    +        System.setProperty("zookeeper.authProvider.1",
    +                "org.apache.zookeeper.server.auth.SASLAuthenticationProvider");
             try {
                 File tmpDir = createTmpDir();
                 File saslConfFile = new File(tmpDir, "jaas.conf");
                 FileWriter fwriter = new FileWriter(saslConfFile);
     
    -            fwriter.write("" +
    -                    "Server {\n" +
    -                    "          org.apache.zookeeper.server.auth.DigestLoginModule required\n" +
    -                    "          user_super=\"test\";\n" +
    -                    "};\n" +
    -                    "Client {\n" +
    -                    "       org.apache.zookeeper.server.auth.DigestLoginModule required\n" +
    -                    "       username=\"super\"\n" +
    -                    "       password=\"test\";\n" +
    -                    "};" + "\n");
    +            fwriter.write("" + "Server {\n"
    --- End diff --
    
    Same content was already present, I tried to format it which could not help to clean.
    Now moved jaas config file content generation to new method.
, +1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 5 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/699//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/699//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/699//console

This message is automatically generated., Github user hanm commented on the issue:

    https://github.com/apache/zookeeper/pull/254
  
    lgtm.
, Github user rakeshadr commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/254#discussion_r117207576
  
    --- Diff: src/java/main/org/apache/zookeeper/ClientCnxn.java ---
    @@ -1054,6 +1054,8 @@ private void sendPing() {
             private boolean saslLoginFailed = false;
     
             private void startConnect() throws IOException {
    +            // initializing it for new connection
    +            saslLoginFailed = false;
    --- End diff --
    
    Thanks @arshadmohammad  for the details.
    
    yes, only `SendThread` is updating the flag. But, during sasl login retries period, the flag status will be checked by `tunnelAuthInProgress()` packet processing thread, so multiple threads are accessing the flag. The code looks little tricky and `zooKeeperSaslClient `null value represents auth in progress. I'm almost OK with the change and trying another attempt to avoid any compatibility issues to the users as this would go to stable branches:-). 
    
    Earlier the behavior was, once the flag updated to flase, `tunnelAuthInProgress` function would return false always. Now, with the proposed fix, sometimes it would return false and sometimes it would return true, right? Will this results in any consistency issues later?
    
    Assume  a case, where successful login takes several retries.
    (1) Immediately after the login failure the flag will be false. During this time `tunnelAuthInProgress() ` function returns false to the callers.
    (2) Assume, `startConnect()` retries started. During this time, `tunnelAuthInProgress() ` function returns true to the callers.
    
    My previous suggestion was to avoid this situation and consistently `tunnelAuthInProgress()` function return false until the next successful login. Does this makes sense to you?
    
    @hanm, welcome your thoughts. Thanks!
, Github user hanm commented on the issue:

    https://github.com/apache/zookeeper/pull/254
  
    >> Will this results in any consistency issues later?
    
    I guess the previous behavior was problematic and the fact tunnelAuthInProgress always return false once a login failed (even after a new connection retry attempt) is a bug that this JIRA trying to fix, right? If we keep the old semantic then the bug will not be fixed because of the details described in the JIRA - basically if we keep the old semantic and always return false upon a failed login then the future SASL packet will be treated as normal packet and got ignored - thus SASL login will never succeed..
    
    >> so multiple threads are accessing the flag. 
    
    Yeah this looks like the case - so should we set the flag as volatile?
, In which case multiple threads will be accessing the flag ? As I checked, only sendThread access and modifies the flag. 

During SASL handshake also , the response packet is processed by sendThread itself in readResponse() method.  Also I observed, that the response never gets processed by ServerSaslResponseCallback . ( May be its unused now) ... 

Am I missing anything ? , Github user rakeshrapache commented on the issue:

    https://github.com/apache/zookeeper/pull/254
  
    >> SASL login will never succeed
    
    Yes, agreed. You guys are correct. I got confused with the server behavior of continue connection to Zookeeper server without SASL auth. I was thinking that there is a chance of sending data packets via unauth channel and processing async new connections simultaneously.
    
    Thanks @arshadmohammad, @hanm and @Bhupendra Kumar for the clarifications.
    
    +1 LGTM
, Github user arshadmohammad commented on the issue:

    https://github.com/apache/zookeeper/pull/254
  
    This PR can be merged to master and branch-3.5 only. I  will raise another pull request for branch-3.4
, Github user asfgit closed the pull request at:

    https://github.com/apache/zookeeper/pull/254
, Committed to master
https://github.com/apache/zookeeper/commit/fa1dc109d4c1bb7913fee43170ed6131e3dc1b1f
branch-3.5
https://github.com/apache/zookeeper/commit/0026e27e81f4889816bec162964e2a721cc53db9
branch-3.4
https://github.com/apache/zookeeper/commit/ac5fa3f54fbf47437ed86bd02cd0e9fdb9edf5e6, SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #3419 (See [https://builds.apache.org/job/ZooKeeper-trunk/3419/])
ZOOKEEPER-2775: ZK Client not able to connect with Xid out of order (hanm: rev fa1dc109d4c1bb7913fee43170ed6131e3dc1b1f)
* (edit) src/java/main/org/apache/zookeeper/ClientCnxn.java
* (delete) src/java/test/org/apache/zookeeper/test/SaslAuthTest.java
* (add) src/java/test/org/apache/zookeeper/SaslAuthTest.java
, GitHub user arshadmohammad opened a pull request:

    https://github.com/apache/zookeeper/pull/278

    ZOOKEEPER-2775: ZK Client not able to connect with Xid out of order error

    Same as PR https://github.com/apache/zookeeper/pull/254 but this is for branch-3.4

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/arshadmohammad/zookeeper ZOOKEEPER-2775-branch-3.4

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/zookeeper/pull/278.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #278
    
----
commit 31580024b18d57eff28acb7099bad0606b51efa3
Author: Mohammad Arshad <arshad@apache.org>
Date:   2017-06-10T17:36:34Z

    ZOOKEEPER-2775: ZK Client not able to connect with Xid out of order error

----
, -1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 5 new or modified tests.

    -1 javadoc.  The javadoc tool appears to have generated 1 warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 48 new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/783//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/783//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/783//console

This message is automatically generated., Github user hanm commented on the issue:

    https://github.com/apache/zookeeper/pull/278
  
    lgtm, will merge soon.
, Issue resolved by pull request 278
[https://github.com/apache/zookeeper/pull/278], Github user hanm commented on the issue:

    https://github.com/apache/zookeeper/pull/278
  
    It is merged, please close this @arshadmohammad.
, Github user arshadmohammad closed the pull request at:

    https://github.com/apache/zookeeper/pull/278
, GitHub user jiajunwang opened a pull request:

    https://github.com/apache/helix/pull/131

    Bump up ZOOKEEPER version to 3.4.11.

    There is a zk connection related bug (ZOOKEEPER-2775) fixed in 3.4.11. Bump up version to get the fix.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/jiajunwang/helix master

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/helix/pull/131.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #131
    
----
commit 22cc4a4d4819b211b30094de7b3b0944cb5c033b
Author: jiajunwang <ericwang1985@...>
Date:   2018-01-25T22:04:13Z

    Bump up ZOOKEEPER version to 3.4.11.
    
    There is a zk connection related bug (ZOOKEEPER-2775) fixed in 3.4.11. Bump up version to get the fix.

----
, Github user asfgit closed the pull request at:

    https://github.com/apache/helix/pull/131
]