[Attached an initial patch , where there is a check if JAVA_HOME is set . If not command execution will exit with proper error message.

Please review the patch., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12709168/ZOOKEEPER-2156.1.patch
  against trunk revision 1669825.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2599//console

This message is automatically generated., Updated the patch with latest trunk code. 
Please review., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12709171/ZOOKEEPER-2156.patch
  against trunk revision 1669825.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2600//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2600//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2600//console

This message is automatically generated., Testcase failures are not related to this patch, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12709183/ZOOKEEPER-2156.2.patch
  against trunk revision 1669825.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2601//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2601//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2601//console

This message is automatically generated., Hi [~andreina],

If JAVA_HOME isn't set, we default to whatever is available in $Path. See:

https://github.com/apache/zookeeper/commit/90ef80c0a2593207be5436acf0270c1e160f0c78

Maybe your patch should only error out if JAVA_HOME isn't set *and* there's no java in the $PATH?, Thanks [~rgs] for reviewing and correcting me. 
Have updated the patch as per your suggestion . 
Please review., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12723821/ZOOKEEPER-2156.3.patch
  against trunk revision 1671889.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2604//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2604//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2604//console

This message is automatically generated., Hope there is no need of testcase for this jira .
Please review the patch and give your feedback.
, Thanks [~andreina], patch looks nice.
\\
Just few thoughts. Missed JAVA_HOME checks in few places, 
- cases like, {{start-foreground}}, {{print-cmd}} in zkServer.sh script.
- zkCli.sh and zkCleanup.sh scripts.


Can we try move the verification checks to {{zkEnv.sh}} script to avoid duplicating the logic. If we move outside it will even verify the condition for {{help/usage}} also. But I feel it is ok., Thanks [~rakeshr] for reviewing the patch.

bq. Can we try move the verification checks to zkEnv.sh script to avoid duplicating the logic
I too agree with this point. Updated the patch accordingly . 
Please review., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12724929/ZOOKEEPER-2156.4.patch
  against trunk revision 1672934.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2632//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2632//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2632//console

This message is automatically generated., Testcase failures are not related to this patch., Thanks [~andreina] for taking care of this. +1 latest patch looks good to me., Thanks [~rakeshr] for reviewing the patch.
[~rgs] can you please review and let me know your feedback. , I think this patch is fine but isn't the problem that we had an error that we didn't detect and reported success in starting the server, not that we didn't check JAVA_HOME etc properly? I am not a bash shell script expert but seems like we also need to fix this so that it doesn't claim to have started the process when in fact it couldn't start it due to some failure. , Thanks [~fournc] for your comments.

bq.we had an error that we didn't detect and reported success in starting the server

I agree with you . I came across a scenario where if myid file does not exist , zk startup will return success eventhough startup has failed. I think we can handle startup failure and return proper error message in a seperate jira. (Provide your feedback. If it sounds good ill raise a jira)

In this jira , like description says if JAVA is not set in either JAVA_HOME or PATH , then zk operations will fail with error message.
Have verified the same with the patch , for different combinations of setting java in JAVA_HOME and PATH. 

, Raised a separate jira for handling the startup failure and displaying proper error message. (ZOOKEEPER-2173)
, [~fournc] concerns has been addressed and committed the changes as part of ZOOKEEPER-2173. Now, I think we can take up this jira ahead.

[~rgs] since you had reviewed the patch earlier, would you be interested in reviewing the latest patch again:), lgtm, except for the indentation in this block:

{code}
-  JAVA=java
+echo "Error: JAVA_HOME is not set and java could not be found in PATH." 1>&2
+    exit 1
 fi
{code}

any reason for not indenting that echo statement properly?, lgtm, except for the indentation in this block:

{code}
-  JAVA=java
+echo "Error: JAVA_HOME is not set and java could not be found in PATH." 1>&2
+    exit 1
 fi
{code}

any reason for not indenting that echo statement properly?, lgtm, except for the indentation in this block:

{code}
-  JAVA=java
+echo "Error: JAVA_HOME is not set and java could not be found in PATH." 1>&2
+    exit 1
 fi
{code}

any reason for not indenting that echo statement properly?, Thanks [~rgs] and [~rakeshr] for reviewing the patch .

Have updated the patch as per the comments from [~rgs]
Please review., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12733491/ZOOKEEPER-2156.5.patch
  against trunk revision 1679951.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2701//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2701//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2701//console

This message is automatically generated., Testcase is not required as the patch is to check whether java set or not., Thanks [~andreina] for the contribution.
Thanks [~rgs], [~fournc] for the reviews.

Committed to trunk : http://svn.apache.org/viewvc?view=revision&revision=1680471
Committed to br3.5 : http://svn.apache.org/viewvc?view=revision&revision=1680473

IMO after releasing 3.5.1 version, we may need to update the {{CHANGES.txt}} by moving this entry to 3.5.2 section. Please see the discussion [here|https://issues.apache.org/jira/browse/ZOOKEEPER-1077?focusedCommentId=14548454&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14548454], Thanks [~rakeshr] for the commit.
Thanks [~rgs] and [~fournc] for reviewing., FAILURE: Integrated in ZooKeeper-trunk #2697 (See [https://builds.apache.org/job/ZooKeeper-trunk/2697/])
ZOOKEEPER-2156: If JAVA_HOME is not set zk startup and fetching status command execution result misleads user (J.Andreina via rakeshr) (rakeshr: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1680471)
* /zookeeper/trunk/CHANGES.txt
* /zookeeper/trunk/bin/zkEnv.sh
]