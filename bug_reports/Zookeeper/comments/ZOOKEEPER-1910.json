[In server, its keeping single watcher reference against an znode. Now the difficulty here is server needs to decide when it can remove the watcher reference.
{code}
WatchManager.java

    private final HashMap<String, HashSet<Watcher>> watchTable =
        new HashMap<String, HashSet<Watcher>>();
{code}

For example: 

In my tests I have two watchers defined in the client side "/node1" - w1, w2. As we know in the server it will have only one 'watcher reference' for each client like, '/node1' vs zkClient1. Now if user call removeWatcher("/node1", w1), presently it is removing the 'watcher reference' from the server. Here w2 is not taken into consideration at the server side and later the 'zkClient1' won't get any watch notifications.

Simple way to fix is, server shouldn't remove the 'watcher reference' on RemoveWatch request, remove it only when expiring or triggering time. But this will have the overhead of unnecessarily holding the refernce even after all the watchers are removed successfully for a path.

Second approach is to have a counter at the server side and which will decr it after every RemoveWatch request from the client. When it reaches zero, now server can do the cleanup like,
{code}
    private final HashMap<String, HashMap<Watcher, Integer>> watchTable =
        new HashMap<String, HashMap<Watcher, Integer>>();
{code}
Here I could see an over head of keeping one additional parameter and will increase the memory utilization., Could someone help me to choose a better way to go ahead. Also, welcome fresh ideas. Thanks in advance., Yeah I was thinking about this same thing while implementing RemoveWatches support in Kazoo (see 0 below). My, unpolished, thought is that the current removeWatches() API for the Java impl conflates two distinct actions:

a) removing the watch set on the Server
b) unregister a given watcher or set of watchers

Since 3.5.0 isn't out yet, are we still on time for changing our API? If so, how would you feel about having removeWatches *only* deal with the server-side part (i.e.: unregistering the watch from the data tree) and having something like unregisterWatcher() deal with the watchers known by the client?

So presumably you would have to remove your watch and unregister your watchers in separate steps. More calls, but better defined contracts. And, on top of this, you could always build convenience wrappers. Surely it means expanding the surface of our public API, but I think it might save us from confusing bugs given that as things are now we have weird corner cases.

Thoughts?

0) https://github.com/python-zk/kazoo/pull/189, {quote}
a) removing the watch set on the Server
b) unregister a given watcher or set of watchers

Since 3.5.0 isn't out yet, are we still on time for changing our API? If so, how would you feel about having removeWatches *only* deal with the server-side part (i.e.: unregistering the watch from the data tree) and having something like unregisterWatcher() deal with the watchers known by the client?
{quote}

Thanks [~rgs]. I think  'zk#unregister(watcher)' api name will confuse with the existing zk#register(watcher), which is actually meant for connection watchers. So I've tried to do some refinement, kindly see the below section for more details and would like to know the comments.

# removeWatches - The difference with the earlier api is, 
(1)this won't remove the given watcher from the server set even if the watcher set is empty, but it will remove the reference from the zkclient. This api will invoke a call to server and maintain orderly execution as earlier. IMHO sending to server is required to handle packet in-flight cases.
(2)null watcher is not allowed, client will validate and throw IllegalArgumentException.
# removeAllWatches - This is new api which is meant for clearing all the watchers both client and server set. Will provide both sync & async api versions

{code}
    /**
     * For the given znode path, removes the specified watcher of given
     * watcherType.
     * <p>
     * Watcher shouldn't be null. A successful call guarantees that, the 
     * removed watcher won't be triggered.
     * <p>
     * @param path - the path of the node
     * @param watcher
     *            - a concrete watcher or null to remove all watchers for the
     *            given path and watcherType
     * @param watcherType - the type of watcher to be removed
     * @param local
     *            - whether the watcher can be removed locally when there is no
     *            server connection
     * @throws InterruptedException
     *             if the server transaction is interrupted.
     * @throws KeeperException.NoWatcher
     *             if no watcher exists that match the specified parameters
     * @throws KeeperException
     *             if the server signals an error with a non-zero error code.
     * @throws IllegalArgumentException
     *             if an invalid path is specified
     *             if the watcher is null
     * @since 3.5.0
     */
    public void removeWatches(String path, Watcher watcher, WatcherType watcherType, boolean local)
{code}
{code}
    /**
     * For the given znode path, removes all the watchers of given watcherType.
     * <p>
     * A successful call guarantees that, the removed watcher won't be triggered.
     * <p>
     * @param path - the path of the node
     * @param watcherType  - the type of watcher to be removed
     * @param local
     *            - whether the watcher can be removed locally when there is no
     *            server connection
     * @throws InterruptedException
     *             if the server transaction is interrupted.
     * @throws KeeperException.NoWatcher
     *             if no watcher exists that match the specified parameters
     * @throws KeeperException
     *             if the server signals an error with a non-zero error code.
     * @throws IllegalArgumentException
     *             if an invalid path is specified
     * @since 3.5.0
     */
    public void removeAllWatches(String path, WatcherType watcherType, boolean local)
{code}, [~michim], [~phunt] it would be great to if you can add your thoughts when you get sometime. Actually we have to refine the existing removeWatches api contract. Thanks!, Rakesh, your proposal sounds good to me., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12640611/ZOOKEEPER-1910.patch
  against trunk revision 1588141.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2048//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2048//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2048//console

This message is automatically generated., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12640629/ZOOKEEPER-1910.patch
  against trunk revision 1588141.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2049//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2049//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2049//console

This message is automatically generated., I've attached latest patch, where I have splitted the removeWatches api. Please have a look at it. Thanks
- removeWatches(path, watcher, watcherType, local);
- removeAllWatches(path, watcherType, local);

Review Ticket : https://reviews.apache.org/r/20448/, Hmm, added some nits to the RB but overall I am not convinced about this approach. Why do we need to send a RemoveWatches request to the server with remove=false if that is essentially a no-op? Just to check if the watch stills exists in the server before we remove it on the client? It could still race, so I think that if all we want to do is unregister a watcher locally we should do it without paying a round-trip to the server. 

Also, about the naming, do you think that renaming removeWatches to removeWatchers would still be confusing?
, Thanks [~rgs] for the comments.

{quote}Why do we need to send a RemoveWatches request to the server with remove=false if that is essentially a no-op? Just to check if the watch stills exists in the server before we remove it on the client? It could still race, so I think that if all we want to do is unregister a watcher locally we should do it without paying a round-trip to the server. 
{quote}
IMHO sending request to the server will help to do an orderly execution and will help in handling the packets in-flight cases. Anyway we can't completely avoid server call, so I think better to do a call to server with remove=false rather than having a logic to check watcher exists in server and remove it from the client. In another way if we see removeWatches() api, it is also doing the watcher check in the server right. Does this make sense to you ?

Actually I was thinking to remove the pre-valiadtion check before sending the packet, because we already have server side validation. If agrees, I'll remove this pre-validation when preparing another patch.
{code}
        // Validating the existence of watcher.
        watchManager.containsWatcher(clientPath, watcher, watcherType);
{code}

bq.Also, about the naming, do you think that renaming removeWatches to removeWatchers would still be confusing?
I feel removeWatches api name is OK. I referred https://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html#ch_zkWatches. Probably [~michim] can help us:), Sounds reasonable, thanks [~rakeshr]. , Just to elaborate a bit more on my change of mind â€” even though having a RemoveWatches request with a remove field looks a bit strange at first, I do think that moving the validation to the server is good plan. Specially because it reduces the probability of behavior mismatch between different client implementations. , OK got it. I could see an alternative approach using different opcodes - checkWatches & removeWatches. Any thoughts ?

zk#removeWatches() api will send 'opCode.checkWatches' request to the server and returns errCode, now the client will see errCode and remove watches locally.
zk#removeAllWatches() api will send 'opCode.removeWatches' request to the server, this will remove watches from server and client as well.
{code}
ZooDefs.OpCode.checkWatches // check watches exists in server and return errCode
CheckWatchesRequest implements Record{
     String path
     int type
}

ZooDefs.OpCode.removeWatches // remove watches from server and return errCode
RemoveWatchesRequest implements Record{
      String path
      int type
}
{code}, I like this much better! Thanks [~rakeshr]. , Attaching new patch addressing the comments given in RB. Thanks again [~rgs], [~michim], [~fournc] for the reviews., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12641854/ZOOKEEPER-1910.patch
  against trunk revision 1588584.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2061//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2061//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2061//console

This message is automatically generated., +1, thanks [~rakeshr]. Once we are settled with this I'll get to https://issues.apache.org/jira/browse/ZOOKEEPER-1919. , This failed the TestWatchers c test. [~michim] it looks like this is failing other places, do you think this is unrelated?, To clarify: It looks like that test is failing in other unrelated patch builds, but I'd like someone familiar with the cpp side to take a look before this is committed., I could see ZOOKEEPER-1914 talking about similar scenario. Anything extra requires to do here in this JIRA., +1 The failure doesn't seem related to this patch. , OK I will check it in unless you're on it [~michim], Please go ahead and check it in. Thanks Camille!, FAILURE: Integrated in ZooKeeper-trunk #2305 (See [https://builds.apache.org/job/ZooKeeper-trunk/2305/])
ZOOKEEPER-1910. RemoveWatches wrongly removes the watcher if multiple watches 
  exists on a path (Rakesh R via camille) (camille: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1590850)
* /zookeeper/trunk/CHANGES.txt
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/ZooDefs.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/ZooKeeper.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/cli/RemoveWatchesCommand.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/DataTree.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/FinalRequestProcessor.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/Request.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/WatchManager.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/ZKDatabase.java
* /zookeeper/trunk/src/java/test/org/apache/zookeeper/RemoveWatchesTest.java
* /zookeeper/trunk/src/zookeeper.jute
, -1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1687//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1687//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1687//console

This message is automatically generated., -1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1689//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1689//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1689//console

This message is automatically generated., +1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1695//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1695//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1695//console

This message is automatically generated., -1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1726//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1726//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1726//console

This message is automatically generated., -1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1727//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1727//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1727//console

This message is automatically generated., -1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1728//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1728//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1728//console

This message is automatically generated., +1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1729//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1729//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1729//console

This message is automatically generated.]