[I'm working on a patch, considering the following solution:

I created a wrapper class OSMXBean that implements the methods to get information about system file descriptors (this is actually what the interface com.sun.management.UnixOperatingSystemMXBean does). When calling one of those methods in OSMXBean, it will identify which java vendor the system is using. 

If it's Sun, it uses reflections to load the sun interface and it calls the methods as it does in the code today.

However, if it's IBM java, the OSMXBean execute runtime system calls to get the information needed (number of open file descriptors or maximum allowed). Since i'm using system calls, the commands are Linux specific, so the class also checks the OS.

I'm adding the patch soon, but I wanted to check beforehand if there are any concerns with that implementation., Sounds reasonable to me Adalberto., Dear colleagues, 
The same error also happens under the IBM Java s390x platform: 
mvn assembly:assembly -DskipTests -Prelease
hbase source build fails - error missing com.sunmanagement package 
                                         class UnixOperatingSystemMXBean

 package com.sun.management does not exist
cannot find symbol
[ERROR] symbol  : class UnixOperatingSystemMXBean
[ERROR] location: class org.apache.hadoop.hbase.ResourceChecker.ResourceAnalyzer

A build from source is needed to fix the authentication run-time error
which currently loads the LinuxPrincipal (defered) class in place of the newer UsernamePrincipal class. This happens on Power64 and s390x machine architecture, for components zookeeper and hbase.  
, Worked with Adalberto in this issue, that is also affecting version 3.4.4 and trunk. 
Will submit a patch that adds a wrapper class and modifies zookeeper.server.NIOServerCnxn and zookeeper.server.NettyServerCnxn to execute the idea from Adalberto., Wrapper class OSMXBean to solve IBM Java build error., Wrapper class OSMXBean to solve build error when using IBM Java., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12549189/zookeeper-1474.patch
  against trunk revision 1391526.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 2 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1233//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1233//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1233//console

This message is automatically generated., Wrapper class OSMXBean to solve IBM Java build error. 2nd version with changes after last build error., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12549366/zookeeper-1474-v2.patch
  against trunk revision 1391526.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1234//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1234//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1234//console

This message is automatically generated., -1 tests included. The patch doesn't appear to include any new or modified tests.
Please justify why no new tests are needed for this patch.
Also please list what manual steps were performed to verify this patch.

The patch was tested with Sun Java and compiled with IBM Java. 
The patches for each test case that uses com.sun.management.UnixOperatingSystemMXBean will be submitted in different issues, once there are differences between zookeeper-3.4.4 repository and trunk repository, and can effect the submission of each one. , New version of same patch but now including a new JUnit test case to test the new OSMXBean class., Dear colleagues,

When doing any platform adjustment in the Hadoop ecosystem, please beside 
adding the support for the IBM Power 7 computers "ppc64", also add the 
support for the system z "legacy" platform, better known as OS 
architecture "s390x", 

 All another concerns regarding support of IBM Java 7 also apply to the 
IBM mainframe world, so whatever fix you add to Hadoop components, as 
mentioned below, will also work on our larger IBM platform.  Yes, we are 
building an open version of Apache Hadoop on system z and our pilot works 
fine. 

Regards, 
Claude 

Claude Falbriard 
Certified IT Specialist L2 - Middleware
AMS Hortol√¢ndia / SP - Brazil
phone:    +55 19 9837 0789
cell:         +55 13 8117 3316
e-mail:    claudef@br.ibm.com




From:   "Paulo Ricardo Paz Vital (JIRA)" <jira@apache.org>
To:     claudef@br.ibm.com
Date:   25/10/2012 09:57
Subject:        [jira] [Updated] (ZOOKEEPER-1474) Cannot build Zookeeper 
with IBM Java: use of Sun MXBean classes




     [ 
https://issues.apache.org/jira/browse/ZOOKEEPER-1474?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel 
]

Paulo Ricardo Paz Vital updated ZOOKEEPER-1474:
-----------------------------------------------

    Attachment: zookeeper-1474-v3.patch

New version of same patch but now including a new JUnit test case to test 
the new OSMXBean class.
 
https://issues.apache.org/jira/browse/ZOOKEEPER-1474
zookeeper-1474-v3.patch
imports com.sun.management.UnixOperatingSystemMXBean . This 
OperatingSystemMXBean class is not implemented by IBM or open java. 
servers.

--
This message is automatically generated by JIRA.
If you think it was sent incorrectly, please contact your JIRA 
administrators
For more information on JIRA, see: http://www.atlassian.com/software/jira


, +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12550770/zookeeper-1474-v3.patch
  against trunk revision 1391526.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1239//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1239//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1239//console

This message is automatically generated., This looks good, a few small comments/questions on the patch:

1) "//only works on Unix" this is confusing, I think you mean these params are only available on unix? would be good to update the comment and move into the top of the block (if I'm interpreting that right)

2) remove the commented out code in src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java

3) what systems and jvms have you tested this on?

4) can you verify the compilation and that your tests pass on Windows? I see that you have a test that explicitly fails except on unix. We have users running on windows systems.

FYI: I will add an IBM JDK specific job to jenkins when this goes in: https://builds.apache.org//view/S-Z/view/ZooKeeper/ Notice we have windows jobs there already.



, Patrick,

Regarding the points 1 and 2, I removed the comments and I'm going to upload a new version of the patch.

Regarding question 3, I tested this patch in a RHEL6.3 on x86_64 using IBM Java (6SR11) and Oracle Java (6u35) and in a RHEL6.3 on PPC64 using IBM Java (6SR11).

Regarding the tests in Windows, I haven't tested it, yet. I need set up a system before and then can try the patch using IBM Java (6SR11) and Oracle Java (6u35). However, the portion of code modified is Unix only (the problem is the import of com.sun.management.UnixOperatingSystemMXBean class), so I guess Windows tests will not be impacted with this changes - that maintains the Unix only usage., New version of same patch - removed some unnecessary comments., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12551707/ZOOKEEPER-1474-v4.patch
  against trunk revision 1404288.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1243//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1243//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1243//console

This message is automatically generated., New version of same patch. Forgot to add the new test case on last patch., New version of same patch. Forgot to add the new test case on last patch., +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12551721/ZOOKEEPER-1474-v5.patch
  against trunk revision 1404288.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1245//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1245//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1245//console

This message is automatically generated., +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12551722/ZOOKEEPER-1474-v5.patch
  against trunk revision 1404288.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1246//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1246//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1246//console

This message is automatically generated., Modified the OSMXBeanTest class to work on Windows environment., +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12553147/ZOOKEEPER-1474-v6.patch
  against trunk revision 1404288.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1259//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1259//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1259//console

This message is automatically generated., This problem still happens on new release 3.4.5. Tested the last patch (v6) on 3.4.5 release and all test-cases worked., Thanks Adalberto!, Sorry, I mis-attributed this - should be thanking Paulo Ricardo Paz Vital. Thanks Paulo, sorry for the mixup!, Integrated in ZooKeeper-trunk #1757 (See [https://builds.apache.org/job/ZooKeeper-trunk/1757/])
    ZOOKEEPER-1474. Cannot build Zookeeper with IBM Java: use of Sun MXBean classes (Adalberto Medeiros via phunt) (Revision 1414566)

     Result = SUCCESS
phunt : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1414566
Files : 
* /zookeeper/trunk/CHANGES.txt
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/NIOServerCnxn.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/NettyServerCnxn.java
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/util/OSMXBean.java
* /zookeeper/trunk/src/java/test/org/apache/zookeeper/test/OSMXBeanTest.java
, Took a look at this one and came with a better implementation.
Spawning new {{bash}} process is a heavyweight operation (compared to a few fs system calls) especially if it's a huge server process:
* although linux uses copy-on-write during {{fork}} it's still an expensive operation because it needs to create new process and walk through all memory pages to mark them as readonly
* despite of linux overcommit feature we can receive {{ENOMEM}} if host is running out of RAM

I'm attaching new patch, which is simplier. Please, take a look. Maybe it lacks comments, but works., Updated version - uses Scanner to parse limits file., Can someone take a look at this ticket?, Patch works, even with the missing tests., Closing issues after releasing 3.4.6.]