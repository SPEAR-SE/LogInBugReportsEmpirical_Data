[GitHub user lvfangmin opened a pull request:

    https://github.com/apache/zookeeper/pull/447

    [ZOOKEEPER-2926] Fix potential data consistency issue due to the session management bug

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/lvfangmin/zookeeper ZOOKEEPER-2926

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/zookeeper/pull/447.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #447
    
----
commit 04ec15841c5d164f1212eea9cdfd02e10aa4478e
Author: Fangmin Lyu <allenlyu@...>
Date:   2018-01-09T06:58:32Z

    fix potential data consistency issue due to global session added too early

----
, -1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 26 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1403//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1403//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1403//console

This message is automatically generated., Github user anmolnar commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/447#discussion_r160972325
  
    --- Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java ---
    @@ -1187,13 +1187,8 @@ private ProcessTxnResult processTxn(Request request, TxnHeader hdr,
             if (opCode == OpCode.createSession) {
                 if (hdr != null && txn instanceof CreateSessionTxn) {
                     CreateSessionTxn cst = (CreateSessionTxn) txn;
    -                sessionTracker.addGlobalSession(sessionId, cst.getTimeOut());
    -            } else if (request != null && request.isLocalSession()) {
    -                request.request.rewind();
    -                int timeout = request.request.getInt();
    -                request.request.rewind();
    -                sessionTracker.addSession(request.sessionId, timeout);
    -            } else {
    +                sessionTracker.commitSession(sessionId, cst.getTimeOut());
    +            } else if (request == null || !request.isLocalSession()) {
    --- End diff --
    
    Do you need this check here?
    Basically you removed the part of requesting localSession creation, because it has already happened in PrepRequestProcessor and it's safe to leave the default 'else' handler as it was.
, Github user anmolnar commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/447#discussion_r160970304
  
    --- Diff: src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java ---
    @@ -579,13 +579,8 @@ protected void pRequest2Txn(int type, long zxid, Request request,
                     int to = request.request.getInt();
                     request.setTxn(new CreateSessionTxn(to));
                     request.request.rewind();
    -                if (request.isLocalSession()) {
    -                    // This will add to local session tracker if it is enabled
    -                    zks.sessionTracker.addSession(request.sessionId, to);
    -                } else {
    -                    // Explicitly add to global session if the flag is not set
    -                    zks.sessionTracker.addGlobalSession(request.sessionId, to);
    -                }
    +                // only add the global session tracker but not to ZKDb
    +                zks.sessionTracker.addGlobalSession(request.sessionId, to);
    --- End diff --
    
    You could remove this check safely, because effectively there was no difference between `addSession()` and `addGlobalSession()` calls.
, Github user anmolnar commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/447#discussion_r160971106
  
    --- Diff: src/java/main/org/apache/zookeeper/server/SessionTrackerImpl.java ---
    @@ -280,6 +278,12 @@ public synchronized boolean addSession(long id, int sessionTimeout) {
             return added;
         }
     
    +    public synchronized boolean commitSession(long id, int sessionTimeout) {
    --- End diff --
    
    `sessionsWithTimeout` is a Map within ZKdb, so adding sessions to it is equivalent to persisting them.
    
    I think you could also remove the `addGlobalSession()` method completely, because it doesn't do anything special than forwarding the call to `addSession()`.
, Github user anmolnar commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/447#discussion_r160976160
  
    --- Diff: src/java/main/org/apache/zookeeper/server/quorum/LearnerSessionTracker.java ---
    @@ -102,32 +101,42 @@ public boolean isGlobalSession(long sessionId) {
         }
     
         public boolean addGlobalSession(long sessionId, int sessionTimeout) {
    +        // no global session tracker, do nothing
    +        return false;
    --- End diff --
    
    Is it possible to throw UnsupportedOperationException instead?
, Github user lvfangmin commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/447#discussion_r161296493
  
    --- Diff: src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java ---
    @@ -579,13 +579,8 @@ protected void pRequest2Txn(int type, long zxid, Request request,
                     int to = request.request.getInt();
                     request.setTxn(new CreateSessionTxn(to));
                     request.request.rewind();
    -                if (request.isLocalSession()) {
    -                    // This will add to local session tracker if it is enabled
    -                    zks.sessionTracker.addSession(request.sessionId, to);
    -                } else {
    -                    // Explicitly add to global session if the flag is not set
    -                    zks.sessionTracker.addGlobalSession(request.sessionId, to);
    -                }
    +                // only add the global session tracker but not to ZKDb
    +                zks.sessionTracker.addGlobalSession(request.sessionId, to);
    --- End diff --
    
    On LeaderSessionTracker, we need to differentiate add local session or global session, but since we only call createSession when add local session, I think I can simplify the interface more by removing addGlobalSession and rename addSession to trackSession.
, Github user lvfangmin commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/447#discussion_r161300774
  
    --- Diff: src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java ---
    @@ -1187,13 +1187,8 @@ private ProcessTxnResult processTxn(Request request, TxnHeader hdr,
             if (opCode == OpCode.createSession) {
                 if (hdr != null && txn instanceof CreateSessionTxn) {
                     CreateSessionTxn cst = (CreateSessionTxn) txn;
    -                sessionTracker.addGlobalSession(sessionId, cst.getTimeOut());
    -            } else if (request != null && request.isLocalSession()) {
    -                request.request.rewind();
    -                int timeout = request.request.getInt();
    -                request.request.rewind();
    -                sessionTracker.addSession(request.sessionId, timeout);
    -            } else {
    +                sessionTracker.commitSession(sessionId, cst.getTimeOut());
    +            } else if (request == null || !request.isLocalSession()) {
    --- End diff --
    
    Local session creation is happened in ZooKeeperServer when the when processing connection request, PrepRequestProcessor only deals with the global sessions.
    
    Local session creation will also send a createSession op into the processor pipeline, so if we remove the else check, a lot of warning log will show for local session createSession op, that's not what we wanted.
, Github user lvfangmin commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/447#discussion_r161296695
  
    --- Diff: src/java/main/org/apache/zookeeper/server/SessionTrackerImpl.java ---
    @@ -280,6 +278,12 @@ public synchronized boolean addSession(long id, int sessionTimeout) {
             return added;
         }
     
    +    public synchronized boolean commitSession(long id, int sessionTimeout) {
    --- End diff --
    
    Yes, that's kind of commit changes to ZkDB, like the usual txns commit to DataTree in ZkDB.
, -1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 26 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1411//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1411//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1411//console

This message is automatically generated., Github user anmolnar commented on the issue:

    https://github.com/apache/zookeeper/pull/447
  
    @lvfangmin Have you amended your commit?
    I see a lot of changes since I last reviewed this PR.
, Github user lvfangmin commented on the issue:

    https://github.com/apache/zookeeper/pull/447
  
    @anmolnar I changed the code based on your comments and did amend, is this the right process?
, Github user anmolnar commented on the issue:

    https://github.com/apache/zookeeper/pull/447
  
    @lvfangmin Got it. Recently we talked about why multiple commits are better for review over squashing. Now I see why.
, Github user anmolnar commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/447#discussion_r161405611
  
    --- Diff: src/java/test/org/apache/zookeeper/test/SessionTrackerCheckTest.java ---
    @@ -185,8 +182,8 @@ public void testLeaderSessionTracker() throws Exception {
                     TICK_TIME, expirer.sid, false, testZKSListener());
     
             // Global session
    -        sessionId = 0xdeadbeef;
    -        tracker.addSession(sessionId, CONNECTION_TIMEOUT);
    +        sessionId = 0xdeadbef0;
    --- End diff --
    
    Why have you changed this? :)
, Github user lvfangmin commented on a diff in the pull request:

    https://github.com/apache/zookeeper/pull/447#discussion_r161855408
  
    --- Diff: src/java/test/org/apache/zookeeper/test/SessionTrackerCheckTest.java ---
    @@ -185,8 +182,8 @@ public void testLeaderSessionTracker() throws Exception {
                     TICK_TIME, expirer.sid, false, testZKSListener());
     
             // Global session
    -        sessionId = 0xdeadbeef;
    -        tracker.addSession(sessionId, CONNECTION_TIMEOUT);
    +        sessionId = 0xdeadbef0;
    --- End diff --
    
    I think this is not changed by intention, might happen when merge patch, I'll get this fixed.
, Github user lvfangmin commented on the issue:

    https://github.com/apache/zookeeper/pull/447
  
    @anmolnar I also find it's hard to track when using overwriting the commit, I'll use stack instead.
    
    For the tests, I need to inject some failure in the Quorum being set up, that's why I need the customized way I'm doing in my code, I think I prefer to create a separate test class.
, +1 overall.  GitHub Pull Request  Build
      

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 20 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1974//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1974//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-github-pr-build/1974//console

This message is automatically generated., Issue resolved by pull request 447
[https://github.com/apache/zookeeper/pull/447], SUCCESS: Integrated in Jenkins build ZooKeeper-trunk #143 (See [https://builds.apache.org/job/ZooKeeper-trunk/143/])
ZOOKEEPER-2926: Fix potential data consistency issue due to the session (hanm: rev cd209456b67cde5aba771b1a240ebe5607398459)
* (edit) src/java/test/org/apache/zookeeper/test/ClientBase.java
* (edit) src/java/main/org/apache/zookeeper/server/SessionTrackerImpl.java
* (edit) src/java/test/org/apache/zookeeper/server/MockServerCnxn.java
* (edit) src/java/main/org/apache/zookeeper/server/SessionTracker.java
* (edit) src/java/main/org/apache/zookeeper/server/quorum/LearnerSessionTracker.java
* (edit) src/java/test/org/apache/zookeeper/server/PrepRequestProcessorTest.java
* (add) src/java/test/org/apache/zookeeper/server/quorum/SessionUpgradeQuorumTest.java
* (edit) src/java/test/org/apache/zookeeper/test/QuorumBase.java
* (edit) src/java/main/org/apache/zookeeper/server/ZooKeeperServer.java
* (edit) src/java/test/org/apache/zookeeper/server/SessionTrackerTest.java
* (edit) src/java/main/org/apache/zookeeper/server/PrepRequestProcessor.java
* (edit) src/java/test/org/apache/zookeeper/test/SessionTrackerCheckTest.java
* (edit) src/java/main/org/apache/zookeeper/server/quorum/LocalSessionTracker.java
* (edit) src/java/main/org/apache/zookeeper/server/ServerCnxn.java
* (edit) src/java/main/org/apache/zookeeper/server/quorum/LeaderSessionTracker.java
* (edit) src/java/main/org/apache/zookeeper/server/quorum/UpgradeableSessionTracker.java
]