[Thanks a lot for finding this!, I'm not sure how to solve this yet, so any suggestions are welcome.

Intuitively, once a server has completed leader election, FLE should not be controlling its configuration. The reason why the code processing new configurations in FLE exists is to allow a server to "catch up" with the right members of an ensemble. If its already connected to the leader (or leading) this is not necessary. Otherwise, for example in case of a configuration change, a server may get an FLE message with a future config version before the reconfiguration commit arrives, which may be problematic similarly to the scenario here with observers. 

So my current thought is perhaps to do config changes in FLE only if the server itself is LOOKING.
 , Hi [~shralex], Thank you for the suggestion.

Your suggestion seems exactly right!
The attached patch that implements your suggestion seems to resolve the bug.


FYI Just in case of other unknown race conditions, I tested this patch with Earthquake for 50 times, and fortunately it looks fine.
{panel}
host$ sudo modprobe openvswitch
host$ docker run --privileged -t -i --rm -v $HOME:/mnt/host osrg/earthquake-zookeeper-2212
guest$ pushd example/zk-found-bug.ether/zk_testbed/zookeeper
guest$ git am /mnt/host/PATCH.patch
guest$ popd
guest$ ./000-prepare.sh
guest$ (for f in $(seq 1 50);do ./100-run-experiment.sh; done) 2>&1 | tee /tmp/log
guest$ grep REPRODUCED /tmp/log | wc -l
0 <--- The bug is resolved
{panel}
, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12739553/0001-ZOOKEEPER-2212-distributed-race-condition-related-to.patch
  against trunk revision 1685200.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2769//console

This message is automatically generated., Thanks a lot, [~suda]. I've marked this as "patch available" to trigger automatic tests.
Since you've already submitted a patch, I'm assigning the issue to you. 
Hope this is ok, otherwise please feel free to assign back to me., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12739558/ZOOKEEPER-2212-v2.patch
  against trunk revision 1685200.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2770//console

This message is automatically generated., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12739562/ZOOKEEPER-2212-v3.patch
  against trunk revision 1685200.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2771//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2771//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2771//console

This message is automatically generated., {{ReconfigRecoveryTest.testCurrentObserverIsParticipantInNewConfig}} failed. I will check this later.
, {{ReconfigRecoveryTest.testCurrentObserverIsParticipantInNewConfig}} failed. I will check this later.
, [~suda]: the 0001-ZOOKEEPER-2212-distributed-race-condition-related-to.patch file is in git-format-patch format, mind creating it with:

{code}
$ git diff --no-prefix HEAD~1.. > ZOOKEEPER-2212.patch
{code}

so that it can be applied? Thanks!
, Raul, the latest patch (ending with v3) was applied correctly., Heh, some how i misread the dates. Sorry about that [~shralex]! If I can get your +1 I'll go ahead and merge it. , +1 Thanks a lot [~suda]!

The failing test has been failing on Hudson intermittently for a while. Locally this test passes for me with the patch.

, thanks, Raul!, [~suda], perhaps your tool can somehow help in debugging ZOOKEEPER-2172 ? , Merged:

trunk https://github.com/apache/zookeeper/commit/ec056d3c3a18b862d0cd83296b7d4319652b0b1c
3.5 https://github.com/apache/zookeeper/commit/87c43f0aac1b01814a86ea135fda50076e1e3432

Thanks [~suda] & [~shralex]!, Thank you a lot for merging!
, Thank you for information!

The failing test seems under discussion in [ZOOKEEPER-2080].

, Thank you a lot for suggestion!

Actually, I found this bug by accident while tackling [ZOOKEEPER-2172].

I'm still trying to refine workload (reconfig + some write ops) so as to reproduce [ZOOKEEPER-2172].
, FAILURE: Integrated in ZooKeeper-trunk #2728 (See [https://builds.apache.org/job/ZooKeeper-trunk/2728/])
ZOOKEEPER-2212: distributed race condition related to QV version
(Akihiro Suda via rgs) (rgs: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1685685)
* /zookeeper/trunk/CHANGES.txt
* /zookeeper/trunk/src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java
, Hi [~suda], any chance your tool can help with the test failure we're seeing here and elsewhere? 

org.apache.zookeeper.server.quorum.ReconfigRecoveryTest.testCurrentObserverIsParticipantInNewConfig

it may be easier than the race condition in ZOOKEEPER-2172 since here you can see all the input state and performed
operations. , Thanks for the proposal!
I will try to apply my tool to testCurrentObserverIsParticipantInNewConfig this week.

, Hi [~shralex], sorry for late reply.

Please refer to [my this comment|https://issues.apache.org/jira/browse/ZOOKEEPER-2080?focusedCommentId=14696437&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14696437] in ZOOKEEPER-2080.
I'm not sure how to resolve the bug yet, but I somehow found out that the bug is related to QCnxM/FLE.
]