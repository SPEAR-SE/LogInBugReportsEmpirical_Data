[Hey [~shralex]: I suspect you've might seen this one before. Any thoughts on handling blocking connect() calls triggered by reconfig commands? I can think of a few things we could do (i.e.: just queue things and don't block, though we'd have to deal with crashes; using non-blocking connects; using very low timeouts;). But maybe you already know how to handle this :-), Hi [~rgs], 

actually I haven't seen one of these. I tried adding servers that are not yet there, but never got one of these.

Looking at the code, I'd expect this exception to be caught in the second catch block, print a warning and return, definitely not crash the whole thing... but this somehow doesn't happen.

Alex, btw, would this not happen if you initially added the same observer to your config ? I mean without reconfig. It just seems that this code runs in both cases., it would be called from a different thread, not from the PrepRequestProcessor so it can't crash the requests pipeline. , [~shralex]: does this make sense to you? I'll add a test a bit later today. Thanks!

cc: [~cnauroth], [~hdeng], Thanks Raul! Why not extend the catch block in ConnectOne to catch the thrown exceptions here ? Is there a case we want the exceptions to be thrown ?, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12764113/ZOOKEEPER-2202.patch
  against trunk revision 1705482.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2899//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2899//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/2899//console

This message is automatically generated., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12764113/ZOOKEEPER-2202.patch
  against trunk revision 1733348.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3060//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3060//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3060//console

This message is automatically generated., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12764113/ZOOKEEPER-2202.patch
  against trunk revision 1748630.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    -1 contrib tests.  The patch failed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3205//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3205//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3205//console

This message is automatically generated., [~hanm], [~phunt], [~shralex]: this is still hurting us in production, could we get it reviewed for 3.5.3 pls? Thanks!, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12764113/ZOOKEEPER-2202.patch
  against trunk revision 73d6bf5353586e49740f77291d1fd98b07f916cc.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 3.0.1) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3539//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3539//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3539//console

This message is automatically generated., Hi Raul,

To reiterate my previous suggestion above - since connectOne already catches UnresolvedAddressException and IOException, 
can we add to connectOne whatever other exception is being thrown or just catch Exception ? Seems not necessary to catch some
of the exceptions inside and some outside of connectOne

Cheers,
Alex

, I agree with what Alex said - I think connectOne could be made to have a strong guarantee that it does not throw given that higher level would retry connection. connectOne would just swallow all type of exception, clean up sockets, and do proper logging. 

Also I am curious on this case as why the processor pipeline was brought down. From the logging posted in the JIRA description, the exception thrown is {noformat}java.net.SocketTimeoutException{noformat}, which is a sub class of {noformat}java.io.IOException{noformat}, and connectOne is already catching java.io.IOException so everything should be just fine.
Cross check with the "Cannot open channel to" in logging I believe the exception get caught [here|https://github.com/apache/zookeeper/blob/master/src/java/main/org/apache/zookeeper/server/quorum/QuorumCnxManager.java#L455]. So, is java.net.SocketTimeoutException is the real culprit in this case that brought down request processor?]