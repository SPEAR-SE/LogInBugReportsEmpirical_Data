[[~tdunning]: thanks for reporting! could we not reuse the test infra that was added with the patch that adds secure mode?, [~rgs] It is possible that would work. I have a working test now that exhibits the problem and the fix, but I don't yet like how I had to get the test system to instantiate a Netty connection factory. What I did was to change the system property controlling this. That is, of course, a recipe for non-deterministic disaster if multiple tests run at the same time.

Once I got the test to run at all, I ran into a java.nio.channels.ClosedChannelException as the server shuts down. That probably indicates something is wrong with the test framework or the netty code itself, but it is very hard to see what.

, This is a fix for the problem along with a unit test., [~rgs] Thanks for the pointer. I got some hints from that other test that helped get rid of some spurious exceptions., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12823150/leak-patch.patch
  against trunk revision 1755857.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    -1 javac.  The patch appears to cause tar ant target to fail.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3356//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3356//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3356//console

This message is automatically generated., Updated patch (which was for 3.5.1) to trunk, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12823357/0001-Updated-patch-for-Netty-leak-testing-to-trunk.patch
  against trunk revision 1755857.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3358//console

This message is automatically generated., Ted - our qabot is still oldschool, it expects svn formatted patches - "--no-prefix" when using git to generate the diff. That's why the patch is failing to apply (well, at least one reason)
https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToContribute, -1

Following line:
{code}
+            zkServer = null;
{code}
is causing NPE later on - race condition is between Netty connection going away and message in the queue getting processed, Updated patch with correct formatting.

[~tdunning] - please review, since it includes removing setting zkServer to null., Updated patch with correct formatting.

[~tdunning] - please review, since it includes removing setting zkServer to null., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12826994/ZOOKEEPER-2509.patch
  against trunk revision 1757584.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 2 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3390//console

This message is automatically generated., Sorry - forgot --no-prefix. Updated one, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12826996/ZOOKPEEPER-2509.patch
  against trunk revision 1757584.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 2 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3391//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3391//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3391//console

This message is automatically generated., Hmmm..., looks like until trunk tests failures are fixed hard to get a clean build, [~hanm] Could you review this JIRA as well, as it actually triggered [JIRA-2549|https://issues.apache.org/jira/browse/ZOOKEEPER-2549], [~yufeldman], latest patch change to NettyServerCnxn.java looks good.

Small issues on test case:
* Would be good to clear properties in tearDown.
* Remove these unrelated comments in test:
{noformat}
// Reset to default value since some test cases set this to true.
// Needed for JDK7 since unit test can run is random order
{noformat}
and 
{noformat}
    /**
     * Verify that we get all of the events we expect to get. This particular
     * case verifies that we see all of the data events on a particular node.
     * There was a bug (ZOOKEEPER-137) that resulted in events being dropped
     * in some cases (timing).
     *
     * @throws IOException
     * @throws InterruptedException
     * @throws KeeperException
     */
{noformat}
I believe these comments were copied from WatherTest and later forgot to be removed., Addressing review comments, Thank you [~hanm] for reviewing it. I have addressed your review comments. Attached updated patch., +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12828777/ZOOKEEPER-2509-1.patch
  against trunk revision b2a484cfe743116d2531fe5d1e1d78b3960c511e.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 2 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed core unit tests.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3433//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3433//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/3433//console

This message is automatically generated., [~hanm] - just wonder if anything else we can do here, or it is good to go?, Hi [~yufeldman], latest patch LGTM. We need +1 from at least one committer for this to be committed., Thank you very much [~hanm] for the review. I thought you are the one :). , [~phunt], [~rgs] - Could you please review the patch, as it seems you are the most familiar with the code in question., Ping again. It has been 6 weeks already

[~phunt], [~rgs] - Could you please review the patch, as it seems you are the most familiar with the code in question., This is duplicate of ZOOKEEPER-2358.]