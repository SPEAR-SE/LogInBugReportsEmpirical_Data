[Code mentioned in description was added in ZOOKEEPER-1437., This was discovered in process of working on ZOOKEEPER-107., Might be duplicate with ZOOKEEPER-1560 that discovered a different problem with the same block of code, I'd like to help with this if I can - first step would be a unit test that exposes it. If I understand from @Jacky007's description, I think that the test would be:

1. Start a client and server
2. Client waits till server comes up.
3. Stop the server.
4. Client sends a packet to the server (e.g. "get /").
5. Restart the server.

Client should hang at step 4. Test should detect the hang somehow and fail the test., I should say in my last sentence above, "client *will* hang, if bug exists" - client should clearly not hang if client code is functioning correctly., Marshall McMullen (@marshall) mentions in ZOOKEEPER-107 (https://issues.apache.org/jira/browse/ZOOKEEPER-107?focusedCommentId=13476346&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13476346) that this test failure:

https://builds.apache.org/job/PreCommit-ZOOKEEPER-Build/1230//testReport/

might be due to ZOOKEEPER-1561 - console output might be useful for creating test case., It's a good time to revisit this now that ZOOKEEPER-1560 is fixed. , It was fixed in ZOOKEEPER-1560.]