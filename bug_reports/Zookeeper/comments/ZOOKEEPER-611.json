[{code}
2009-12-06 21:59:23,352 - ERROR [QuorumPeer with myid:1 and clientPort:3181:QuorumPeerTestBase$MainThread@92] - unexpected exception in run
java.lang.NullPointerException
	at sun.nio.ch.Util.atBugLevel(Util.java:326)
	at sun.nio.ch.SelectorImpl.<init>(SelectorImpl.java:40)
	at sun.nio.ch.EPollSelectorImpl.<init>(EPollSelectorImpl.java:47)
	at sun.nio.ch.EPollSelectorProvider.openSelector(EPollSelectorProvider.java:18)
	at java.nio.channels.Selector.open(Selector.java:209)
	at org.apache.zookeeper.server.NIOServerCnxn$Factory.<init>(NIOServerCnxn.java:98)
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:120)
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:102)
	at org.apache.zookeeper.server.quorum.QuorumPeerTestBase$MainThread.run(QuorumPeerTestBase.java:89)
{quote}

This was the exception in the logs which caused the quorumpeer run method to die. I thought we had fixed the issue in ZOOKEEPER-597 but looks like it isnt fully fixed., looks like similar problem here:
http://hudson.zones.apache.org/hudson/view/ZooKeeper/job/ZooKeeper-trunk/586/, For 588, same problem, but now triggered from the CnxManager test:

{noformat}
java.lang.NullPointerException
	at sun.nio.ch.Util.atBugLevel(Util.java:326)
	at sun.nio.ch.SelectorImpl.<init>(SelectorImpl.java:40)
	at sun.nio.ch.EPollSelectorImpl.<init>(EPollSelectorImpl.java:47)
	at sun.nio.ch.EPollSelectorProvider.openSelector(EPollSelectorProvider.java:18)
	at java.nio.channels.Selector.open(Selector.java:209)
	at org.apache.zookeeper.server.NIOServerCnxn$Factory.<init>(NIOServerCnxn.java:98)
	at org.apache.zookeeper.server.NIOServerCnxn$Factory.<init>(NIOServerCnxn.java:123)
	at org.apache.zookeeper.server.quorum.QuorumPeer.<init>(QuorumPeer.java:414)
	at org.apache.zookeeper.test.CnxManagerTest.testCnxManager(CnxManagerTest.java:152)
{noformat}, this patch fixes this nullpointer exception by setting the system property ""sun.nio.ch.bugLevel" to empty string. It also removes the selector.open().close() that we put in ZOOKEEPER-597 as a solution to the same problem., we should probably check if that property is set before overwriting it we should probably also have a comment pointing out that this is a work around for the sun bug (and point to the bug)
, scratch the point to the bug part. it is already there.
, attached patch with ben's comments., +1, I just committed this. good  catch ben!, Integrated in ZooKeeper-trunk #590 (See [http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/590/])
    .  hudson build failiure (mahadev)
, doesnt looks like its fixed, 

http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/593/

looks like the static block should be in Factory rather than Servercnxn. Thanks pat for pointing out., resubmitting a patch for static block in Factory., attached a wrong file., +1, looks good., I just committed this. , Integrated in ZooKeeper-trunk #596 (See [http://hudson.zones.apache.org/hudson/job/ZooKeeper-trunk/596/])
    . hudson build failure (take 2) (mahadev)
, ill upload a patch for 3.1 and 3.2 branch as soon as ZOOKEEPER-597 gets committed to those branches., reopeneing for 3.1 and 3.2 branches., patch for 3.2 branch. adds the uncaught handler and fixes works around the jvm bug., patch for 3.1. add the thread handler and works arnd the jvm bug., +1 looks good, I just committed this to 3.1 and 3.2 branches.]