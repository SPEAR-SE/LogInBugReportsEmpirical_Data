[Can you provide an example input for which {{calculate_interval()}} returns the wrong value?, Nope, you're right - it's not in {{calculate_interval()}} - I thought it was because I was getting negative ping response numbers in our logs, a lot. But it looks like it's just a minor issue instead: it's in {{zookeeper_process()}} right before the debug log for {{"Got ping response in %d ms"}}. It calls {{gettimeofday(&now, 0);}} instead of {{get_system_time(&now);}}, which on our linux systems results in a different value (making the interval become negative because the 'now' is a smaller value than the last_ping time). So it results in printing negative values for ping response times in logs, but not a problem for actually generating pings.

Sorry for the false alarm.
, Thanks for the report [~Hadriel] - if you believe there is something there to address please do submit a patch. Regards., Also see ZOOKEEPER-1626 - there seems to be quite a bit of discussion on that JIRA wrt this type of change.]