[There's a race condition in the following code
{code}
    MockNM nm1 = rm.registerNode("127.0.0.1:1234", 10000);
    MockNM nm2 = rm.registerNode("127.0.0.2:1234", 10000);
    MockNM nm3 = rm.registerNode("127.0.0.3:1234", 10000);
    MockNM nm4 = rm.registerNode("127.0.0.4:1234", 10000);

    RMApp app1 = rm.submitApp(2000);
{code}

The app will be already put in RM context before the added nodes trigger NODE_USABLE to make it be added in each app's updatedNodes. See the following trace, which shows the app already exists before all NODE_USABLEs. That's why the first allocate will show 4 updated nodes.

{code}
014-04-10 02:04:51,931 INFO  [main] resourcemanager.RMAuditLogger (RMAuditLogger.java:logSuccess(142)) - USER=jenkins	OPERATION=Submit Application Request	TARGET=ClientRMService	RESULT=SUCCESS	APPID=application_1397120691650_0001
App : application_1397120691650_0001 State is : NEW Waiting for state : ACCEPTED
2014-04-10 02:04:51,951 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.rmnode.RMNodeEvent.EventType: STARTED
2014-04-10 02:04:51,951 DEBUG [AsyncDispatcher event handler] rmnode.RMNodeImpl (RMNodeImpl.java:handle(373)) - Processing 127.0.0.1:1234 of type STARTED
2014-04-10 02:04:51,953 INFO  [AsyncDispatcher event handler] rmnode.RMNodeImpl (RMNodeImpl.java:handle(385)) - 127.0.0.1:1234 Node Transitioned from NEW to RUNNING
2014-04-10 02:04:51,954 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.rmnode.RMNodeEvent.EventType: STARTED
2014-04-10 02:04:51,954 DEBUG [AsyncDispatcher event handler] rmnode.RMNodeImpl (RMNodeImpl.java:handle(373)) - Processing 127.0.0.2:1234 of type STARTED
2014-04-10 02:04:51,955 INFO  [AsyncDispatcher event handler] rmnode.RMNodeImpl (RMNodeImpl.java:handle(385)) - 127.0.0.2:1234 Node Transitioned from NEW to RUNNING
2014-04-10 02:04:51,955 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.rmnode.RMNodeEvent.EventType: STARTED
2014-04-10 02:04:51,955 DEBUG [AsyncDispatcher event handler] rmnode.RMNodeImpl (RMNodeImpl.java:handle(373)) - Processing 127.0.0.3:1234 of type STARTED
2014-04-10 02:04:51,955 INFO  [AsyncDispatcher event handler] rmnode.RMNodeImpl (RMNodeImpl.java:handle(385)) - 127.0.0.3:1234 Node Transitioned from NEW to RUNNING
2014-04-10 02:04:51,955 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.rmnode.RMNodeEvent.EventType: STARTED
2014-04-10 02:04:51,955 DEBUG [AsyncDispatcher event handler] rmnode.RMNodeImpl (RMNodeImpl.java:handle(373)) - Processing 127.0.0.4:1234 of type STARTED
2014-04-10 02:04:51,955 INFO  [AsyncDispatcher event handler] rmnode.RMNodeImpl (RMNodeImpl.java:handle(385)) - 127.0.0.4:1234 Node Transitioned from NEW to RUNNING
2014-04-10 02:04:51,955 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppEvent.EventType: START
2014-04-10 02:04:51,957 DEBUG [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:handle(627)) - Processing event for application_1397120691650_0001 of type START
2014-04-10 02:04:51,957 INFO  [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:transition(863)) - Storing application with id application_1397120691650_0001
2014-04-10 02:04:51,959 INFO  [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:handle(639)) - application_1397120691650_0001 State change from NEW to NEW_SAVING
2014-04-10 02:04:51,959 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.scheduler.event.NodeAddedSchedulerEvent.EventType: NODE_ADDED
2014-04-10 02:04:51,961 INFO  [AsyncDispatcher event handler] capacity.CapacityScheduler (CapacityScheduler.java:addNode(936)) - Added node 127.0.0.1:1234 clusterResource: <memory:10000, vCores:9>
2014-04-10 02:04:51,961 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.NodesListManagerEvent.EventType: NODE_USABLE
2014-04-10 02:04:51,963 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.scheduler.event.NodeAddedSchedulerEvent.EventType: NODE_ADDED
2014-04-10 02:04:51,964 INFO  [AsyncDispatcher event handler] capacity.CapacityScheduler (CapacityScheduler.java:addNode(936)) - Added node 127.0.0.2:1234 clusterResource: <memory:20000, vCores:18>
2014-04-10 02:04:51,964 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.NodesListManagerEvent.EventType: NODE_USABLE
2014-04-10 02:04:51,964 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.scheduler.event.NodeAddedSchedulerEvent.EventType: NODE_ADDED
2014-04-10 02:04:51,965 INFO  [AsyncDispatcher event handler] capacity.CapacityScheduler (CapacityScheduler.java:addNode(936)) - Added node 127.0.0.3:1234 clusterResource: <memory:30000, vCores:27>
2014-04-10 02:04:51,965 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.NodesListManagerEvent.EventType: NODE_USABLE
2014-04-10 02:04:51,965 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.scheduler.event.NodeAddedSchedulerEvent.EventType: NODE_ADDED
2014-04-10 02:04:51,965 INFO  [AsyncDispatcher event handler] capacity.CapacityScheduler (CapacityScheduler.java:addNode(936)) - Added node 127.0.0.4:1234 clusterResource: <memory:40000, vCores:36>
2014-04-10 02:04:51,965 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.NodesListManagerEvent.EventType: NODE_USABLE
2014-04-10 02:04:51,965 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppNodeUpdateEvent.EventType: NODE_UPDATE
2014-04-10 02:04:51,965 DEBUG [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:handle(627)) - Processing event for application_1397120691650_0001 of type NODE_UPDATE
2014-04-10 02:04:51,967 DEBUG [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:processNodeUpdate(684)) - Received node update event:NODE_USABLE for node:127.0.0.1:1234 with state:RUNNING
2014-04-10 02:04:51,967 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppNodeUpdateEvent.EventType: NODE_UPDATE
2014-04-10 02:04:51,993 DEBUG [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:handle(627)) - Processing event for application_1397120691650_0001 of type NODE_UPDATE
2014-04-10 02:04:51,993 DEBUG [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:processNodeUpdate(684)) - Received node update event:NODE_USABLE for node:127.0.0.2:1234 with state:RUNNING
2014-04-10 02:04:51,993 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppNodeUpdateEvent.EventType: NODE_UPDATE
2014-04-10 02:04:51,993 DEBUG [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:handle(627)) - Processing event for application_1397120691650_0001 of type NODE_UPDATE
2014-04-10 02:04:51,993 DEBUG [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:processNodeUpdate(684)) - Received node update event:NODE_USABLE for node:127.0.0.3:1234 with state:RUNNING
2014-04-10 02:04:51,993 DEBUG [AsyncDispatcher event handler] event.AsyncDispatcher (AsyncDispatcher.java:dispatch(164)) - Dispatching the event org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppNodeUpdateEvent.EventType: NODE_UPDATE
2014-04-10 02:04:51,993 DEBUG [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:handle(627)) - Processing event for application_1397120691650_0001 of type NODE_UPDATE
2014-04-10 02:04:51,993 DEBUG [AsyncDispatcher event handler] rmapp.RMAppImpl (RMAppImpl.java:processNodeUpdate(684)) - Received node update event:NODE_USABLE for node:127.0.0.4:1234 with state:RUNNING
{code}, Add an "await" before submitting the app, to ensure the added not will not result in the initial NODE_UPATE in this app., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12639748/YARN-1928.1.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/3558//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/3558//console

This message is automatically generated., LGTM., The reasoning and the patch look good to me. +1. Will check this in.

One side note is that on register, AMs are not getting notified of all nodes in the system. That will be taken care of at YARN-435, at which point this test will need to change., Committed this to trunk, branch-2 and branch-2.4. Thanks Zhijie!

Tx for the review, [~ozawa]!, SUCCESS: Integrated in Hadoop-trunk-Commit #5512 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/5512/])
YARN-1928. Fixed a race condition in TestAMRMRPCNodeUpdates which caused it to fail occassionally. Contributed by Zhijie Shen. (vinodkv: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1587114)
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/applicationsmanager/TestAMRMRPCNodeUpdates.java
, FAILURE: Integrated in Hadoop-Yarn-trunk #540 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/540/])
YARN-1928. Fixed a race condition in TestAMRMRPCNodeUpdates which caused it to fail occassionally. Contributed by Zhijie Shen. (vinodkv: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1587114)
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/applicationsmanager/TestAMRMRPCNodeUpdates.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1732 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1732/])
YARN-1928. Fixed a race condition in TestAMRMRPCNodeUpdates which caused it to fail occassionally. Contributed by Zhijie Shen. (vinodkv: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1587114)
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/applicationsmanager/TestAMRMRPCNodeUpdates.java
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk #1757 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1757/])
YARN-1928. Fixed a race condition in TestAMRMRPCNodeUpdates which caused it to fail occassionally. Contributed by Zhijie Shen. (vinodkv: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1587114)
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/applicationsmanager/TestAMRMRPCNodeUpdates.java
]