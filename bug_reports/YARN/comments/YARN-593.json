[This jira tracks a change that originated in MAPREDUCE-4987. The YARN portion of that patch will be attached here.
, Attaching patch with just the YARN changes.  This code has already been reviewed as part of MAPREDUCE-4987., From https://issues.apache.org/jira/browse/MAPREDUCE-4987?focusedCommentId=13636643&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13636643
bq.bq. This logic iterates over multiple distinct localized resources, potentially a mix of file and directories, so we need to check isDirectory for each one.

By definition the key value of the entry set does not need to be checked for isDir for every linkName in the list of values for that key.

{code}
+        for (Map.Entry<Path,List<String>> entry : resources.entrySet()) {
+          for (String linkName : entry.getValue()) {
+            // Append resource.
+            newClassPath.append(File.pathSeparator).append(pwd.toString())
+              .append(Path.SEPARATOR).append(linkName);
+
+            // FileUtil.createJarWithClassPath must use File.toURI to convert
+            // each file to a URI to write into the manifest's classpath.  For
+            // directories, the classpath must have a trailing '/', but
+            // File.toURI only appends the trailing '/' if it is a directory that
+            // already exists.  To resolve this, add the classpath entries with
+            // explicit trailing '/' here for any localized resource that targets
+            // a directory.  Then, FileUtil.createJarWithClassPath will guarantee
+            // that the resulting entry in the manifest's classpath will have a
+            // trailing '/', and thus refer to a directory instead of a file.
+            if (new File(entry.getKey().toUri().getPath()).isDirectory()) {   <-----------
+              newClassPath.append(Path.SEPARATOR);
+            }
+          }
+        }
{code}, I see it now.  I missed this.  Thanks!  I'll put together a new patch that checks isDirectory just once in the outer loop., Attaching patch to check isDirectory once in the outer loop.  Here is the diff since prior:

{code}
diff --git hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/launcher/Container
index c561655..d48a4b7 100644
--- hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/launcher/ContainerLaunch.
+++ hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/launcher/ContainerLaunch.
@@ -609,6 +609,9 @@ public void sanitizeEnv(Map<String, String> environment,
         // To resolve this, append classpath entries explicitly for each
         // resource.
         for (Map.Entry<Path,List<String>> entry : resources.entrySet()) {
+          boolean targetIsDirectory = new File(entry.getKey().toUri().getPath())
+            .isDirectory();
+
           for (String linkName : entry.getValue()) {
             // Append resource.
             newClassPath.append(File.pathSeparator).append(pwd.toString())
@@ -623,7 +626,7 @@ public void sanitizeEnv(Map<String, String> environment,
             // a directory.  Then, FileUtil.createJarWithClassPath will guarantee
             // that the resulting entry in the manifest's classpath will have a
             // trailing '/', and thus refer to a directory instead of a file.
-            if (new File(entry.getKey().toUri().getPath()).isDirectory()) {
+            if (targetIsDirectory) {
               newClassPath.append(Path.SEPARATOR);
             }
           }
{code}
, +1. Committed to trunk., Integrated in Hadoop-trunk-Commit #3636 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3636/])
    YARN-593. container launch on Windows does not correctly populate classpath with new process's environment variables and localized resources (Chris Nauroth via bikas) (Revision 1469998)

     Result = SUCCESS
bikas : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1469998
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/launcher/ContainerLaunch.java
, Integrated in Hadoop-Yarn-trunk #189 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/189/])
    YARN-593. container launch on Windows does not correctly populate classpath with new process's environment variables and localized resources (Chris Nauroth via bikas) (Revision 1469998)

     Result = SUCCESS
bikas : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1469998
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/launcher/ContainerLaunch.java
, Integrated in Hadoop-Hdfs-trunk #1378 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1378/])
    YARN-593. container launch on Windows does not correctly populate classpath with new process's environment variables and localized resources (Chris Nauroth via bikas) (Revision 1469998)

     Result = FAILURE
bikas : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1469998
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/launcher/ContainerLaunch.java
, Integrated in Hadoop-Mapreduce-trunk #1405 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1405/])
    YARN-593. container launch on Windows does not correctly populate classpath with new process's environment variables and localized resources (Chris Nauroth via bikas) (Revision 1469998)

     Result = SUCCESS
bikas : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1469998
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/launcher/ContainerLaunch.java
, I merged the patch to branch-2.]