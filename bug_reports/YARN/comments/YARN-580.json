[Depending on what version you are using MAPREDUCE-4893 helped make this better. Even with that though you probably won't get perfect locality. 

I looked at this with MR and the problem there is in way the AM asks for containers or the lack of ability to tell RM I need only one of these 3 locations (assuming block repl factor is 3). As far as the RM is concerned in my case it was giving perfect locality by what was requested but since the MR AM generally asks for 3 locations per block and the RM doesn't know that by filling one request it negates 2 others, it can give you containers that doesn't get you perfect locality.  In that case the AM would have to be smarter about requesting or about giveng them back and asking again.    , As per my observation for this issue, when we configure delay as more than no of cluster nodes for capacity scheduler it should check each node one time for NODE_LOCAL free resources for assigning. But here it is missing to check the last node for NODE_LOCAL and assgning to last but one node as RACK_LOCAL or OFF_SWITCH. 

We need to to correct it  for this issue.]