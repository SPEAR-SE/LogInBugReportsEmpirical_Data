[The problem is on recovery, if the previous attempt already finished, we are not adding it the scheduler. when scheduler tries to transferStateFromPreviousAttempt for work-presrving AM restart, it throws NPE., Upload a patch to add the previously finished attempt to scheduler, {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12679967/YARN-2823.1.patch
  against trunk revision 75b820c.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/5760//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/5760//console

This message is automatically generated., Good catch. Marking this critical for 2.6 given it can crash RM.

The patch looks good to me, +1.

I think there is more that we can and should do but in the near future. In the non-restart control flow, AMs cannot register till the RM knows about the attempt (obviously), this condition is invalidated after restart. Will file a ticket.

Checking this in now.., Committed this to trunk, branch-2 and branch-2.6. Thanks Jian!, FAILURE: Integrated in Hadoop-trunk-Commit #6479 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6479/])
YARN-2823. Fixed ResourceManager app-attempt state machine to inform schedulers about previous finished attempts of a running appliation to avoid expectation mismatch w.r.t transferred containers. Contributed by Jian He. (vinodkv: rev a5657182a7accebe08cd86e46b4cdeb163d4d1f2)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/rmapp/attempt/RMAppAttemptImpl.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMRestart.java
, bq. I think there is more that we can and should do but in the near future. In the non-restart control flow, AMs cannot register till the RM knows about the attempt (obviously), this condition is invalidated after restart. Will file a ticket.
Filed YARN-2829., FAILURE: Integrated in Hadoop-Yarn-trunk #737 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/737/])
YARN-2823. Fixed ResourceManager app-attempt state machine to inform schedulers about previous finished attempts of a running appliation to avoid expectation mismatch w.r.t transferred containers. Contributed by Jian He. (vinodkv: rev a5657182a7accebe08cd86e46b4cdeb163d4d1f2)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/rmapp/attempt/RMAppAttemptImpl.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMRestart.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1927 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1927/])
YARN-2823. Fixed ResourceManager app-attempt state machine to inform schedulers about previous finished attempts of a running appliation to avoid expectation mismatch w.r.t transferred containers. Contributed by Jian He. (vinodkv: rev a5657182a7accebe08cd86e46b4cdeb163d4d1f2)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMRestart.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/rmapp/attempt/RMAppAttemptImpl.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1951 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1951/])
YARN-2823. Fixed ResourceManager app-attempt state machine to inform schedulers about previous finished attempts of a running appliation to avoid expectation mismatch w.r.t transferred containers. Contributed by Jian He. (vinodkv: rev a5657182a7accebe08cd86e46b4cdeb163d4d1f2)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/rmapp/attempt/RMAppAttemptImpl.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMRestart.java
* hadoop-yarn-project/CHANGES.txt
, IMO, NPE  happened when *transferStateFromPreviousAttempt*  is *true* ,and  the value of *transferStateFromPreviousAttempt*  is depend on *KeepContainersAcrossApplicationAttempts* in *ApplicationSubmissionContext*, i have this NPE,because there is *FLINK* type application running in my cluster, then i saw the default value of *KeepContainersAcrossApplicationAttempts* in flink code is *true*. so, i want to know if *KeepContainersAcrossApplicationAttempts* is *false*, then this NPE can not happened?[~jianhe] thanks]