[Thanks [~peng.zhang] for reporting this issue. I have tried it to reproduce but I donâ€™t think it is a direct scenario to occur.

Could you give the steps to reproduce this issue?
, As YARN-3640, Rohith has encountered the same problem. And we all see leveldb thread in thread stack. 
I think it's probably related with NM recovery. Decommission is not the key matter.

[~devaraj.k] Do you enable NM recovery in your env?, Thanks for reply. I have enabled NM recovery in my env., Marking it as critical for 2.7.1 whichever way we go.., This is very likely a case where the leveldb state store was not closed properly on shutdown.   That was probably triggered by another exception that occurred during shutdown that short-circuited the shutdown of other services (like the state store).  See YARN-3641.

Could you check the NM logs for the case where it hung and see if another exception was logged during shutdown that may explain how the leveldb store failed to close?, bq. Could you check the NM logs for the case where it hung and see if another exception was logged during shutdown that may explain how the leveldb store failed to close?
I have attached the logs of NodeManagerin the YARN-3640.  Does it help?  Yes, during shutdown there is another exception i.e ConnectionException thrown from NodeStatusUpdatorImpl thread. But I did not get much Idea how this exception effecting NodeManger services stop., I am able to reproduce it always, testing of any patch I will do and verify it in real cluster., I think we can invoke System.exit once the NodeManger is shutdown in finally block. For test case execution, bypass using flag. Any thoughts?, [~peng.zhang] / [~rohithsharma], do you think YARN-3641 fixed this? Or we need more patches? If so, one of you willing to put up a patch?, I will test YARN-3641 fix for this JIRA scenario. About the patch, I think calling System.exit() explicitely after shutdown thead exit is one option., I tested locally using YARN-3641 FIX, issue is still exist., Do you have the shutdown logs from the NM that hung?  It seems very likely that somehow we did not close the leveldb state store cleanly, if you're seeing a leveldb non-daemon thread holding up the JVM shutdown., I have attached NM logs and thread dump in YARN-3640. Would get it from YARN-3640?, Ah, my apologies.  I didn't realize it is failing with the exact same logs, even after YARN-3641.  Could you to instrument logs in the state store code to verify the leveldb database is indeed being closed even when it hangs?  Trying to determine if this is a bug in Hadoop code or a bug in the leveldb code., bq. Could you to instrument logs in the state store code to verify the leveldb database is indeed being closed even when it hangs? 
sorry, did not get it exactly what and where should I add logs? Do you mean should I add log after {{NMLeveldbStateStoreService#closeStorage()}} being called?, Yes, the idea is to show whether we successfully closed the database or not when the problem occurs.  Sorry I wasn't clear on that., Tested with patch to log before and after db.close,  but found that db is closed.There were no exception thrown while closing db.close., If the database was successfully closed yet the non-daemon leveldb daemon thread remains in the jstack then it sounds like a bug in the leveldb code.  As mentioned before, we can do an explicit exit when we think everything is shutdown to mitigate these kinds of problems., Another observation is I enabled debug logs for NodeManger. And noticed that occurrence of this issue become relative low. I think it a timing of db close causing issue in LevelDb. And this Issue won't appear always on all the nodes, but in cluster at lease one node in the cluster is going for toss.

I too think it should a level db issue. I think we should report issue in LevelDb. 

 For calling {{adding system.exit}} in NodeManager gracefully shutdown will mask many issues. Given this is acceptable , I will upload a patch., \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:red}-1{color} | pre-patch |  16m 36s | Findbugs (version ) appears to be broken on trunk. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:green}+1{color} | tests included |   0m  0s | The patch appears to include 1 new or modified test files. |
| {color:green}+1{color} | javac |   9m 13s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |  11m  9s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 28s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | checkstyle |   0m 29s | There were no new checkstyle issues. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   2m  9s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   1m  2s | The patch built with eclipse:eclipse. |
| {color:red}-1{color} | findbugs |   1m 35s | The patch appears to introduce 1 new Findbugs (version 3.0.0) warnings. |
| {color:red}-1{color} | yarn tests |   6m 40s | Tests failed in hadoop-yarn-server-nodemanager. |
| | |  49m 27s | |
\\
\\
|| Reason || Tests ||
| FindBugs | module:hadoop-yarn-server-nodemanager |
| Failed unit tests | hadoop.yarn.server.nodemanager.TestNodeStatusUpdaterForLabels |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12735922/YARN-3585.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / 5df1fad |
| Findbugs warnings | https://builds.apache.org/job/PreCommit-YARN-Build/8115/artifact/patchprocess/newPatchFindbugsWarningshadoop-yarn-server-nodemanager.html |
| hadoop-yarn-server-nodemanager test log | https://builds.apache.org/job/PreCommit-YARN-Build/8115/artifact/patchprocess/testrun_hadoop-yarn-server-nodemanager.txt |
| Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/8115/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf904.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/8115/console |


This message was automatically generated., Recently  in our testbed ,  nodemanager jvm did not exit during shutdown event .
Exception is different, stack trace remains same as above

Attaching the exception trace
{code}
2015-05-30 02:11:49,122 WARN org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerImpl: Unable to update state store diagnostics for container_e310_1432817693365_3338_01_000002
java.io.IOException: org.iq80.leveldb.DBException: Closed
        at org.apache.hadoop.yarn.server.nodemanager.recovery.NMLeveldbStateStoreService.storeContainerDiagnostics(NMLeveldbStateStoreService.java:261)
        at org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerImpl$ContainerDiagnosticsUpdateTransition.transition(ContainerImpl.java:1109)
        at org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerImpl$ContainerDiagnosticsUpdateTransition.transition(ContainerImpl.java:1101)
        at org.apache.hadoop.yarn.state.StateMachineFactory$SingleInternalArc.doTransition(StateMachineFactory.java:362)
        at org.apache.hadoop.yarn.state.StateMachineFactory.doTransition(StateMachineFactory.java:302)
        at org.apache.hadoop.yarn.state.StateMachineFactory.access$300(StateMachineFactory.java:46)
        at org.apache.hadoop.yarn.state.StateMachineFactory$InternalStateMachine.doTransition(StateMachineFactory.java:448)
        at org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerImpl.handle(ContainerImpl.java:1129)
        at org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerImpl.handle(ContainerImpl.java:83)
        at org.apache.hadoop.yarn.server.nodemanager.DefaultContainerExecutor.launchContainer(DefaultContainerExecutor.java:246)
        at org.apache.hadoop.yarn.server.nodemanager.containermanager.launcher.ContainerLaunch.call(ContainerLaunch.java:302)
        at org.apache.hadoop.yarn.server.nodemanager.containermanager.launcher.ContainerLaunch.call(ContainerLaunch.java:82)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:745)
Caused by: org.iq80.leveldb.DBException: Closed
        at org.fusesource.leveldbjni.internal.JniDB.put(JniDB.java:123)
        at org.fusesource.leveldbjni.internal.JniDB.put(JniDB.java:106)
        at org.apache.hadoop.yarn.server.nodemanager.recovery.NMLeveldbStateStoreService.storeContainerDiagnostics(NMLeveldbStateStoreService.java:259)
        ... 15 more

{code}, This is race condition when the NodeManager is shutting down and container is launched. By the time container is launched and returned to ContainerImpl, NodeManager closed the DB connection which resulting in {{org.iq80.leveldb.DBException: Closed
}}, Hi [~bibinchundatt] and [~rohithsharma]
This recent exception trace is different from the focus of  this Jira, and the root cause is given by Rohith. I feel you can separate this to another ticket.

For DB Close vs Container Launch, we can add a check whether DB is closed while we move container from ACQUIRED state., Yes, we can raise different Jira. [~bibinchundatt] Can you raise Jira, we can validate the issue there?, -1 for findbug, does not show any error report, but not sure why -1 given.
Test failure is unrelated to this patch.

[~jlowe] Kindly review the patch. , Thanks for the patch, Rohith!

I think it would be safer/simpler to assume we shouldn't be calling Exit unless NodeManager.main() was invoked (i.e.: we're likely running in a JVM whose sole purpose is to be the nodemanager).  In that sense I'm wondering if we should flip the logic to not exit but then have NodeManager.main override that.  This probably precludes the need to update existing tests.

We should be using ExitUtil instead of System.exit directly.

Nit: "setexitOnShutdownEvent" s/b "setExitOnShutdownEvent"
, [~rohithsharma] and [~sunilg] Have added jira YARN-3754 for tracking DB connection close, Thanks [~jlowe] for the review .. 

bq. if we should flip the logic to not exit but then have NodeManager.main override that. This probably precludes the need to update existing tests.
Make sense to me.. Changed the logic to call jvm exit when NodeMananager is instantiated from main function.

bq. We should be using ExitUtil instead of System.exit directly.
Done

bq. Nit: "setexitOnShutdownEvent" s/b "setExitOnShutdownEvent"
This method is not necessary now since patch preassume true when it is called from only main funtion. I have removed this.

Kindly reveiw updated patch, \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  16m 30s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | javac |   7m 51s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 56s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 23s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | checkstyle |   0m 40s | There were no new checkstyle issues. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 37s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 34s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   1m 14s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |
| {color:green}+1{color} | yarn tests |   6m 14s | Tests passed in hadoop-yarn-server-nodemanager. |
| | |  45m  3s | |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12736738/0001-YARN-3585.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / 990078b |
| hadoop-yarn-server-nodemanager test log | https://builds.apache.org/job/PreCommit-YARN-Build/8159/artifact/patchprocess/testrun_hadoop-yarn-server-nodemanager.txt |
| Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/8159/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf903.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/8159/console |


This message was automatically generated., +1 latest patch lgtm.  Will commit this tomorrow if there are no objections., Thanks, Rohith!  I committed this to trunk, branch-2, and branch-2.7., FAILURE: Integrated in Hadoop-trunk-Commit #7953 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/7953/])
YARN-3585. NodeManager cannot exit on SHUTDOWN event triggered and NM recovery is enabled. Contributed by Rohith Sharmaks (jlowe: rev e13b671aa510f553f4a6a232b4694b6a4cce88ae)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
* hadoop-yarn-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #218 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/218/])
YARN-3585. NodeManager cannot exit on SHUTDOWN event triggered and NM recovery is enabled. Contributed by Rohith Sharmaks (jlowe: rev e13b671aa510f553f4a6a232b4694b6a4cce88ae)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
* hadoop-yarn-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Yarn-trunk #948 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/948/])
YARN-3585. NodeManager cannot exit on SHUTDOWN event triggered and NM recovery is enabled. Contributed by Rohith Sharmaks (jlowe: rev e13b671aa510f553f4a6a232b4694b6a4cce88ae)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
, SUCCESS: Integrated in Hadoop-Hdfs-trunk #2146 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2146/])
YARN-3585. NodeManager cannot exit on SHUTDOWN event triggered and NM recovery is enabled. Contributed by Rohith Sharmaks (jlowe: rev e13b671aa510f553f4a6a232b4694b6a4cce88ae)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
, SUCCESS: Integrated in Hadoop-Hdfs-trunk-Java8 #207 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/207/])
YARN-3585. NodeManager cannot exit on SHUTDOWN event triggered and NM recovery is enabled. Contributed by Rohith Sharmaks (jlowe: rev e13b671aa510f553f4a6a232b4694b6a4cce88ae)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #216 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/216/])
YARN-3585. NodeManager cannot exit on SHUTDOWN event triggered and NM recovery is enabled. Contributed by Rohith Sharmaks (jlowe: rev e13b671aa510f553f4a6a232b4694b6a4cce88ae)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
* hadoop-yarn-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #2164 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2164/])
YARN-3585. NodeManager cannot exit on SHUTDOWN event triggered and NM recovery is enabled. Contributed by Rohith Sharmaks (jlowe: rev e13b671aa510f553f4a6a232b4694b6a4cce88ae)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
, Pulled this into 2.6.1. Ran compilation before the push. Patch applied cleanly.]