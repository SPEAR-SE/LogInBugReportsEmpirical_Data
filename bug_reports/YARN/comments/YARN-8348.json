[Before my patch:
[ERROR] Errors: 
[ERROR] TestTimelineReaderWebServicesHBaseStorage.setupBeforeClass:79->AbstractTimelineReaderHBaseTestBase.setup:60 » NoClassDefFound
[ERROR] org.apache.hadoop.yarn.server.timelineservice.storage.TestHBaseTimelineStorageApps.org.apache.hadoop.yarn.server.timelineservice.storage.TestHBaseTimelineStorageApps
[ERROR] Run 1: TestHBaseTimelineStorageApps.setupBeforeClass:97 » NoClassDefFound org/apache/...
[ERROR] Run 2: TestHBaseTimelineStorageApps.tearDownAfterClass:1939 NullPointer
[INFO] 
[ERROR] TestHBaseTimelineStorageDomain.setupBeforeClass:51 » NoClassDefFound org/apach...
[ERROR] org.apache.hadoop.yarn.server.timelineservice.storage.TestHBaseTimelineStorageEntities.org.apache.hadoop.yarn.server.timelineservice.storage.TestHBaseTimelineStorageEntities
[ERROR] Run 1: TestHBaseTimelineStorageEntities.setupBeforeClass:110 » NoClassDefFound org/ap...
[ERROR] Run 2: TestHBaseTimelineStorageEntities.tearDownAfterClass:1882 NullPointer
[INFO] 
[ERROR] TestHBaseTimelineStorageSchema.setupBeforeClass:49 » NoClassDefFound org/apach...
[ERROR] org.apache.hadoop.yarn.server.timelineservice.storage.flow.TestHBaseStorageFlowActivity.org.apache.hadoop.yarn.server.timelineservice.storage.flow.TestHBaseStorageFlowActivity
[ERROR] Run 1: TestHBaseStorageFlowActivity.setupBeforeClass:71 » NoClassDefFound org/apache/...
[ERROR] Run 2: TestHBaseStorageFlowActivity.tearDownAfterClass:495 NullPointer
[INFO] 
[ERROR] org.apache.hadoop.yarn.server.timelineservice.storage.flow.TestHBaseStorageFlowRun.org.apache.hadoop.yarn.server.timelineservice.storage.flow.TestHBaseStorageFlowRun
[ERROR] Run 1: TestHBaseStorageFlowRun.setupBeforeClass:83 » NoClassDefFound org/apache/hadoo...
[ERROR] Run 2: TestHBaseStorageFlowRun.tearDownAfterClass:1078 NullPointer
[INFO] 
[ERROR] org.apache.hadoop.yarn.server.timelineservice.storage.flow.TestHBaseStorageFlowRunCompaction.org.apache.hadoop.yarn.server.timelineservice.storage.flow.TestHBaseStorageFlowRunCompaction
[ERROR] Run 1: TestHBaseStorageFlowRunCompaction.setupBeforeClass:82 » NoClassDefFound org/ap...
[ERROR] Run 2: TestHBaseStorageFlowRunCompaction.tearDownAfterClass:853 NullPointer

After my patch:
[ERROR] Errors: 
[ERROR] TestTimelineReaderWebServicesHBaseStorage.setupBeforeClass:79->AbstractTimelineReaderHBaseTestBase.setup:60 » NoClassDefFound
[ERROR] TestHBaseTimelineStorageApps.setupBeforeClass:97 » NoClassDefFound org/apache/...
[ERROR] TestHBaseTimelineStorageDomain.setupBeforeClass:52 » NoClassDefFound org/apach...
[ERROR] TestHBaseTimelineStorageEntities.setupBeforeClass:110 » NoClassDefFound org/ap...
[ERROR] TestHBaseTimelineStorageSchema.setupBeforeClass:50 » NoClassDefFound org/apach...
[ERROR] TestHBaseStorageFlowActivity.setupBeforeClass:71 » NoClassDefFound org/apache/...
[ERROR] TestHBaseStorageFlowRun.setupBeforeClass:83 » NoClassDefFound org/apache/hadoo...
[ERROR] TestHBaseStorageFlowRunCompaction.setupBeforeClass:82 » NoClassDefFound org/ap..., [^YARN-8348.v1.patch] will bring test failed from 21 to 16.

[Link to failed tests|https://builds.apache.org/view/H-L/view/Hadoop/job/hadoop-qbt-trunk-java8-linux-x86/789/testReport/], Technically the null check in AfterClass shouldn't be needed as a failure in BeforeClass should trigger the error everywhere else.
In any case, is good to not have a NPE if the BeforeClass fails.
So in the output we went from a double NoClassDefFound+NPE to just NoClassDefFound.
I think this is an improvement but we need to figure out the reason for the NoClassDefFound (probably a separate JIRA).

The real fix here would be the one in TestHBaseTimelineStorageDomain which leaves the mini cluster open.
 [^YARN-8348.v1.patch] LGTM.
Let's wait for Yetus., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 29s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 7 new or modified test files. {color} |
|| || || || {color:brown} trunk Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 23m 13s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 21s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 13s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 22s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green}  9m  7s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  0m  0s{color} | {color:blue} Skipped patched modules with no Java source: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  0m  0s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 12s{color} | {color:green} trunk passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 19s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 17s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 17s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 11s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 20s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green}  9m 45s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  0m  0s{color} | {color:blue} Skipped patched modules with no Java source: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  0m  0s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:red}-1{color} | {color:red} unit {color} | {color:red}  0m 27s{color} | {color:red} hadoop-yarn-server-timelineservice-hbase-tests in the patch failed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 19s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 46m  1s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| Failed junit tests | hadoop.yarn.server.timelineservice.storage.TestHBaseTimelineStorageEntities |
|   | hadoop.yarn.server.timelineservice.storage.TestHBaseTimelineStorageSchema |
|   | hadoop.yarn.server.timelineservice.storage.TestHBaseTimelineStorageApps |
|   | hadoop.yarn.server.timelineservice.reader.TestTimelineReaderWebServicesHBaseStorage |
|   | hadoop.yarn.server.timelineservice.storage.flow.TestHBaseStorageFlowActivity |
|   | hadoop.yarn.server.timelineservice.storage.TestHBaseTimelineStorageDomain |
|   | hadoop.yarn.server.timelineservice.storage.flow.TestHBaseStorageFlowRunCompaction |
|   | hadoop.yarn.server.timelineservice.storage.flow.TestHBaseStorageFlowRun |
\\
\\
|| Subsystem || Report/Notes ||
| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:abb62dd |
| JIRA Issue | YARN-8348 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12924811/YARN-8348.v1.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |
| uname | Linux 476d2cf2c0cf 4.4.0-89-generic #112-Ubuntu SMP Mon Jul 31 19:38:41 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / e30938a |
| maven | version: Apache Maven 3.3.9 |
| Default Java | 1.8.0_162 |
| unit | https://builds.apache.org/job/PreCommit-YARN-Build/20843/artifact/out/patch-unit-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-timelineservice-hbase-tests.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/20843/testReport/ |
| Max. process+thread count | 467 (vs. ulimit of 10000) |
| modules | C: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests U: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/20843/console |
| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Good news is that the NPE is gone.
However, the original NoClassDefFoundError surfaces clarly now.
I'm fine committing this as is but I'd like to have a follow-up JIRA on why KeyProviderTokenIssuer is not found., Thanks [~elgoiri] for the review. I will open a follow-up Jira for KeyProviderTokenIssuer. As I said before, this patch will bring the failed test from 21 to 16 in Linux.

As HDFS-13558 that you and [~huanbang1993] fixed by closing the cluster, the patch will fix failures in Windows for TestHBaseTimelineStorageDomain and TestHBaseTimelineStorageSchema., Do you mind updating the description to make clear we leave KeyProviderTokenIssuer open but we fix the NPEs?, Thanks [~giovanni.fumarola].
Committed to trunk.
Do you want to provide patches for branch-3.1 and so on?, SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #14275 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/14275/])
YARN-8348. Incorrect and missing AfterClass in HBase-tests to fix NPE (inigoiri: rev d72615611cfa6bd82756270d4b10136ec1e56741)
* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests/src/test/java/org/apache/hadoop/yarn/server/timelineservice/storage/TestHBaseTimelineStorageEntities.java
* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests/src/test/java/org/apache/hadoop/yarn/server/timelineservice/storage/flow/TestHBaseStorageFlowRun.java
* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests/src/test/java/org/apache/hadoop/yarn/server/timelineservice/storage/TestHBaseTimelineStorageApps.java
* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests/src/test/java/org/apache/hadoop/yarn/server/timelineservice/storage/TestHBaseTimelineStorageDomain.java
* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests/src/test/java/org/apache/hadoop/yarn/server/timelineservice/storage/flow/TestHBaseStorageFlowActivity.java
* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests/src/test/java/org/apache/hadoop/yarn/server/timelineservice/storage/flow/TestHBaseStorageFlowRunCompaction.java
* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-timelineservice-hbase-tests/src/test/java/org/apache/hadoop/yarn/server/timelineservice/storage/TestHBaseTimelineStorageSchema.java
, From the [Linux run daily|https://builds.apache.org/view/H-L/view/Hadoop/job/hadoop-qbt-trunk-java8-linux-x86/790/#showFailuresLink] we removed successfully 5 tests., I took another look at the failed tests due to:

java.lang.NoClassDefFoundError: org/apache/hadoop/crypto/key/KeyProviderTokenIssuer

Right now, HBase-test uses hadoop-common:2.5.1 while KeyProviderTokenIssuer is in 3.0.0
We need to wait until the entire codebase uses the updated version.]