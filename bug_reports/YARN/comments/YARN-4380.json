[[~varun_saxena] could you take a look?, Thanks for reporting this [~ozawa]. I tried running this test several times on branch-2 but could not simulate the failure.
If you are able to simulate, it will be helpful if you can share the logs., [~varun_saxena] attaching a log when the test fails. 

I use this simple script to reproduce some intermittent failures https://github.com/oza/failchecker, Thanks [~ozawa].
InterruptedException indicates that there is a race. Because LocalizerRunner#interrupt has been called while credential file is being written., Check for localizer runner thread to finish should be enough for the test to pass.
But to avoid InterruptedException in logs(due to race), have added check for localization to begin as well before initiating localizer heartbeats in test., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue} 0m 0s {color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green} 0m 0s {color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green} 0m 0s {color} | {color:green} The patch appears to include 1 new or modified test files. {color} |
| {color:red}-1{color} | {color:red} mvninstall {color} | {color:red} 1m 59s {color} | {color:red} root in trunk failed. {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 0m 26s {color} | {color:green} trunk passed with JDK v1.8.0_66 {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 0m 25s {color} | {color:green} trunk passed with JDK v1.7.0_85 {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green} 0m 11s {color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green} 0m 27s {color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green} 0m 10s {color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green} 0m 54s {color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green} 0m 16s {color} | {color:green} trunk passed with JDK v1.8.0_66 {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green} 0m 19s {color} | {color:green} trunk passed with JDK v1.7.0_85 {color} |
| {color:red}-1{color} | {color:red} mvninstall {color} | {color:red} 0m 24s {color} | {color:red} hadoop-yarn-server-nodemanager in the patch failed. {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 0m 24s {color} | {color:green} the patch passed with JDK v1.8.0_66 {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 0m 24s {color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 0m 26s {color} | {color:green} the patch passed with JDK v1.7.0_85 {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 0m 26s {color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green} 0m 11s {color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green} 0m 26s {color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green} 0m 10s {color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green} 0m 0s {color} | {color:green} Patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green} 1m 0s {color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green} 0m 15s {color} | {color:green} the patch passed with JDK v1.8.0_66 {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green} 0m 19s {color} | {color:green} the patch passed with JDK v1.7.0_85 {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green} 8m 22s {color} | {color:green} hadoop-yarn-server-nodemanager in the patch passed with JDK v1.8.0_66. {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green} 8m 51s {color} | {color:green} hadoop-yarn-server-nodemanager in the patch passed with JDK v1.7.0_85. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green} 0m 23s {color} | {color:green} Patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 27m 11s {color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:0ca8df7 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12773897/YARN-4380.01.patch |
| JIRA Issue | YARN-4380 |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux 983711f1122c 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / d36b6e0 |
| mvninstall | https://builds.apache.org/job/PreCommit-YARN-Build/9772/artifact/patchprocess/branch-mvninstall-root.txt |
| findbugs | v3.0.0 |
| mvninstall | https://builds.apache.org/job/PreCommit-YARN-Build/9772/artifact/patchprocess/patch-mvninstall-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-nodemanager.txt |
| JDK v1.7.0_85  Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/9772/testReport/ |
| modules | C: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager U: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager |
| Max memory used | 46MB |
| Powered by | Apache Yetus   http://yetus.apache.org |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/9772/console |


This message was automatically generated.

, [~varun_saxena], thank you for the fix. The fix itself looks good me. 

I got another error though it's rare to happen: 

{quote}
Tests run: 14, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 5.518 sec <<< FAILURE! - in org.apache.hadoop.yarn.server.nodemanager.containermanager.localizer.TestResourceLocalizationService
testFailedDirsResourceRelease(org.apache.hadoop.yarn.server.nodemanager.containermanager.localizer.TestResourceLocalizationService)  Time elapsed: 0.093 sec  <<< FAILURE!
org.mockito.exceptions.verification.junit.ArgumentsAreDifferent:
Argument(s) are different! Wanted:
eventHandler.handle(
    <custom argument matcher>
);
-> at org.apache.hadoop.yarn.server.nodemanager.containermanager.localizer.TestResourceLocalizationService.testFailedDirsResourceRelease(TestResourceLocalizationService.java:2632)
Actual invocation has different arguments:
eventHandler.handle(
    EventType: APPLICATION_INITED
);
-> at org.apache.hadoop.yarn.event.AsyncDispatcher.dispatch(AsyncDispatcher.java:183)

        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
        at java.lang.reflect.Constructor.newInstance(Constructor.java:422)
        at org.apache.hadoop.yarn.server.nodemanager.containermanager.localizer.TestResourceLocalizationService.testFailedDirsResourceRelease(TestResourceLocalizationService.java:2632)
{quote}

Attaching a log for the failure. Could you take a look?, Ok. Will have a look., [~ozawa], checked the test failure.
This issue is coming because we do not have any wait after sending DESTROY_APPLICATION_RESOURCES event. And we are immediately checking for APPLICATION_RESOURCES_CLEANEDUP event being sent by Resource Localization service(upon processing of DESTROY_APPLICATION_RESOURCES).
{code}
      LocalizationEvent destroyApp =
          new ApplicationLocalizationEvent(
            LocalizationEventType.DESTROY_APPLICATION_RESOURCES, app);
      spyService.handle(destroyApp);
      verify(applicationBus).handle(argThat(matchesAppDestroy));
{code}

Adding a {{dispatcher.await()}} statement in between spyService.handle and verify statement will resolve the issue.
This test case is broken by YARN-90 and not YARN-2902. So we should raise another JIRA for it. As you found the issue, you can raise the JIRA and assign it to me. I will update a patch there., [~ozawa], I have filed YARN-4393 for above test case failure, Changed the JIRA title because this test can potentially fail intermittently on all branches., +1, checking this in., FAILURE: Integrated in Hadoop-trunk-Commit #8887 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/8887/])
YARN-4380. (ozawa: rev 0656d2dc83af6a48a8d8d0e37cdf1f813124f366)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/localizer/TestResourceLocalizationService.java
, Committed this to trunk, branch-2, and branch-2.7. Thanks [~varun_saxena] for your contribution., FAILURE: Integrated in Hadoop-Mapreduce-trunk #2664 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2664/])
YARN-4380. (ozawa: rev 0656d2dc83af6a48a8d8d0e37cdf1f813124f366)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/localizer/TestResourceLocalizationService.java
, FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #733 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/733/])
YARN-4380. (ozawa: rev 0656d2dc83af6a48a8d8d0e37cdf1f813124f366)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/localizer/TestResourceLocalizationService.java
* hadoop-yarn-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Yarn-trunk #1454 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/1454/])
YARN-4380. (ozawa: rev 0656d2dc83af6a48a8d8d0e37cdf1f813124f366)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/localizer/TestResourceLocalizationService.java
, ABORTED: Integrated in Hadoop-Hdfs-trunk-Java8 #643 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/643/])
YARN-4380. (ozawa: rev 0656d2dc83af6a48a8d8d0e37cdf1f813124f366)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/localizer/TestResourceLocalizationService.java
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk-Java8 #723 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/723/])
YARN-4380. (ozawa: rev 0656d2dc83af6a48a8d8d0e37cdf1f813124f366)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/localizer/TestResourceLocalizationService.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #2580 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2580/])
YARN-4380. (ozawa: rev 0656d2dc83af6a48a8d8d0e37cdf1f813124f366)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/localizer/TestResourceLocalizationService.java
* hadoop-yarn-project/CHANGES.txt
, Thanks [~ozawa] for the commit, Per Varun's comments in YARN-2902, I have cherry-pick this patch together with YARN-2902 to branch-2.6., Closing the JIRA as part of 2.7.3 release.]