[I have reproduced the issue and it is a timing or locking issue. The failure is simple to reproduce by running the test continuously in the IDE and it fails consistently after a couple of runs. When I introduce a small delay (10ms or more) between the scheduling attempt and loading the container the failure rate drops to less than 1 in 100. Increasing the delay to 20ms the failure rate drops below 1 in 1000.

The failure occurs because the scheduled container map is not updated in time and is empty when we callÂ {{getLastScheduledContainer}}. This then causes the NPE to be thrown when the get is called. The application attempt should be updated by the call to {{getAllowedLocalityLevelByTime}}. That call in the failure case has not been made.

Adding a delay is not the correct solution so trying to find why the code path differs in the failure case.]