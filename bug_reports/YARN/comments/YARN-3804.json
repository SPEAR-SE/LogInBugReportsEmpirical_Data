[Can we  check for AccessControlException in {{ActiveStandbyElector#becomeActive()}} send event to shutdown ? , Seems like a critical issue to me.

Two options
 # Fail correctly and assume that admin adds yarn user explicitly if it needs to work.
 # Allow the daemon user to do the refresh irrespective of what admin configures

I get a feeling (2) is better. Thoughts? /cc [~leftnoteasy], [~jianhe], +1 for 2)
Not too much point having RM to depend on the admin acl to do transition for itself. [~kasha], [~xgong], sounds good ? , I am OK with that. 
In transitionToActive(), we are re-using all the refresh* code, if we choose option 2, we need to re-factory all the refresh* functions., There's a inconsistent check in current code path:
- AdminService.checkAccess uses YarnAuthorizationProvider to do the check. In its default implementation: {{ConfiguredYarnAuthorizer}}, it uses configured {{yarn.admin.acl}}
- ClientRMService.checkAccess uses AdminCLIsManager, it uses configured {{yarn.admin.acl}} + {{daemon_user}}

I think we should fix the inconsistency issue, 2) will be completed with if we make both of them allow {{daemont_user}}., On board with suggestions here. , [~vinodkv] {quote}Allow the daemon user to do the refresh irrespective of what admin configures{quote} sounds better to me., [~varun_saxena] ,[~vinodkv] Also at start up {{getServiceState}} will throw exception

{code}
2015-06-16 16:48:38,246 WARN org.apache.hadoop.yarn.server.resourcemanager.RMAuditLogger: USER=yarn	IP=10.19.92.128	OPERATION=getServiceState	TARGET=AdminService	RESULT=FAILURE	DESCRIPTION=Unauthorized user	PERMISSIONS=
2015-06-16 16:48:38,247 INFO org.apache.hadoop.ipc.Server: IPC Server handler 0 on 45021, call org.apache.hadoop.ha.HAServiceProtocol.getServiceStatus from 10.19.92.128:53773 Call#238 Retry#0
org.apache.hadoop.security.AccessControlException: User yarn doesn't have permission to call 'getServiceState'
	at org.apache.hadoop.yarn.server.resourcemanager.RMServerUtils.verifyAdminAccess(RMServerUtils.java:182)
	at org.apache.hadoop.yarn.server.resourcemanager.RMServerUtils.verifyAdminAccess(RMServerUtils.java:148)
	at org.apache.hadoop.yarn.server.resourcemanager.AdminService.checkAccess(AdminService.java:223)
	at org.apache.hadoop.yarn.server.resourcemanager.AdminService.getServiceStatus(AdminService.java:344)
	at org.apache.hadoop.ha.protocolPB.HAServiceProtocolServerSideTranslatorPB.getServiceStatus(HAServiceProtocolServerSideTranslatorPB.java:131)
	at org.apache.hadoop.ha.proto.HAServiceProtocolProtos$HAServiceProtocolService$2.callBlockingMethod(HAServiceProtocolProtos.java:4464)
	at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:616)
	at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:972)
	at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2088)
	at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2084)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:422)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1672)
	at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2082)
2015-06-16 16:48:38,258 WARN org.apache.hadoop.security.UserGroupInformation: No groups available for user yarn

{code}

Should we handle this too?? , Added the user which daemon starts with, in the list of Admin ACLs', so that it matches., [~bibinchundatt], if yarn is the user daemon started with, this will also be fine with the patch submitted. If this is not same as the daemon user, you will have to configure it., \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  16m 53s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | javac |   7m 47s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 59s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 24s | The applied patch does not increase the total number of release audit warnings. |
| {color:red}-1{color} | checkstyle |   0m 53s | The applied patch generated  2 new checkstyle issues (total was 2, now 4). |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 34s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   1m 34s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |
| {color:red}-1{color} | yarn tests |   1m 58s | Tests failed in hadoop-yarn-common. |
| | |  41m 38s | |
\\
\\
|| Reason || Tests ||
| Failed unit tests | hadoop.yarn.security.TestYARNTokenIdentifier |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12739849/YARN-3804.01.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / b039e69 |
| checkstyle |  https://builds.apache.org/job/PreCommit-YARN-Build/8260/artifact/patchprocess/diffcheckstylehadoop-yarn-common.txt |
| hadoop-yarn-common test log | https://builds.apache.org/job/PreCommit-YARN-Build/8260/artifact/patchprocess/testrun_hadoop-yarn-common.txt |
| Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/8260/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf904.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/8260/console |


This message was automatically generated., [~varun_saxena]
ConfiguredYarnAuthorizer#setAdmins has been called in AdminService.
{code}
  @Override
  public void setAdmins(AccessControlList acls, UserGroupInformation ugi) {
    adminAcl = acls;
  }
{code}
Could we add the logic here ?, \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:red}-1{color} | pre-patch |  15m  5s | Findbugs (version ) appears to be broken on trunk. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | javac |   7m 35s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 35s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 23s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | checkstyle |   0m 29s | There were no new checkstyle issues. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 35s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   1m 33s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |
| {color:green}+1{color} | yarn tests |   1m 58s | Tests passed in hadoop-yarn-common. |
| | |  38m 54s | |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12739897/YARN-3804.02.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / b039e69 |
| hadoop-yarn-common test log | https://builds.apache.org/job/PreCommit-YARN-Build/8263/artifact/patchprocess/testrun_hadoop-yarn-common.txt |
| Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/8263/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf905.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/8263/console |


This message was automatically generated., [~varun_saxena]
Actually, in AdminService#serviceInit, we have
{code}
    authorizer.setAdmins(new AccessControlList(conf.get(
      YarnConfiguration.YARN_ADMIN_ACL,
        YarnConfiguration.DEFAULT_YARN_ADMIN_ACL)), UserGroupInformation
        .getCurrentUser());
{code}
, we could create a common function which will add the Daemon user into the AccessControlList, then pass the modified AccessControlList into this method.
In this case, we do not need to change the code for every YarnAuthorizationProvider, (such as ConfiguredYarnAuthorizer).

Also in AdminService#refreshAdminAcls(), we need similar changes, too
, Oops, sorry for the mistake.
I had tested this in my local setup and removed setAdmins from AdminService. But forgot including changes of AdminService in patch.

Any reason explicitly calling {{setAdmins}} is required by the way ?

Anyways your suggestion makes sense to avoid issues with another auth provider. Will make the change., Ok, got it...Because we reload the configuration. , Refactored the code as per [~xgong]'s suggestion.
Tested the fix locally on trunk code., Anyhow, even that wouldn't have been proper fix because setAdmins is called again on refresh., [~varun_saxena] The patch Looks good. But Could we add some testcases for this ?, ok, [~xgong], added a test case.
Could not find an appropriate test class to add it in so added it in {{TestResourceManager}}., \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  16m 50s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:green}+1{color} | tests included |   0m  0s | The patch appears to include 1 new or modified test files. |
| {color:green}+1{color} | javac |   7m 47s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 45s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 25s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | checkstyle |   0m 47s | There were no new checkstyle issues. |
| {color:red}-1{color} | whitespace |   0m  0s | The patch has 1  line(s) that end in whitespace. Use git apply --whitespace=fix. |
| {color:green}+1{color} | install |   1m 37s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 34s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   1m 26s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |
| {color:red}-1{color} | yarn tests |  49m 32s | Tests failed in hadoop-yarn-server-resourcemanager. |
| | |  88m 48s | |
\\
\\
|| Reason || Tests ||
| Failed unit tests | hadoop.yarn.server.resourcemanager.TestRMAdminService |
|   | hadoop.yarn.server.resourcemanager.TestWorkPreservingRMRestart |
|   | hadoop.yarn.server.resourcemanager.security.TestRMDelegationTokens |
| Timed out tests | org.apache.hadoop.yarn.server.resourcemanager.TestRMRestart |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12739979/YARN-3804.04.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / d4929f4 |
| whitespace | https://builds.apache.org/job/PreCommit-YARN-Build/8267/artifact/patchprocess/whitespace.txt |
| hadoop-yarn-server-resourcemanager test log | https://builds.apache.org/job/PreCommit-YARN-Build/8267/artifact/patchprocess/testrun_hadoop-yarn-server-resourcemanager.txt |
| Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/8267/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf904.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/8267/console |


This message was automatically generated., Test failures are related. Will fix them, Test failures are related. Will fix them, Fixed tests. Moved newly added test case to {{TestRMAdminService}}, \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  21m  9s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:green}+1{color} | tests included |   0m  0s | The patch appears to include 1 new or modified test files. |
| {color:green}+1{color} | javac |  10m 22s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |  11m  3s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 23s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | checkstyle |   0m 53s | There were no new checkstyle issues. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 35s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   1m 29s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |
| {color:red}-1{color} | yarn tests |  50m 56s | Tests failed in hadoop-yarn-server-resourcemanager. |
| | |  98m 28s | |
\\
\\
|| Reason || Tests ||
| Failed unit tests | hadoop.yarn.server.resourcemanager.TestWorkPreservingRMRestart |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12740038/YARN-3804.05.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / 5dbc8c9 |
| hadoop-yarn-server-resourcemanager test log | https://builds.apache.org/job/PreCommit-YARN-Build/8270/artifact/patchprocess/testrun_hadoop-yarn-server-resourcemanager.txt |
| Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/8270/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf904.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/8270/console |


This message was automatically generated., Test failure unrelated. YARN-3790 already filed for it, +1 LGTM. Will commit, [~varun_saxena] Looks like the patch does not apply for 2.7. Could you provide a patch for branch-2.7, please ?, Upload a same patch but can apply to branch-2.7, Committed into trunk/branch-2/branch-2.7. Thanks, [~varun_saxena]., FAILURE: Integrated in Hadoop-trunk-Commit #8035 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/8035/])
YARN-3804. Both RM are on standBy state when kerberos user not in yarn.admin.acl. Contributed by Varun Saxena (xgong: rev a826d432f9b45550cc5ab79ef63ca39b176dabb2)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/AdminService.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMAdminService.java
, [~xgong], thanks for updating branch-2.7 patch. Didn't notice your comment due to time difference. , Thanks for the review and commit [~xgong], FAILURE: Integrated in Hadoop-Yarn-trunk #962 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/962/])
YARN-3804. Both RM are on standBy state when kerberos user not in yarn.admin.acl. Contributed by Varun Saxena (xgong: rev a826d432f9b45550cc5ab79ef63ca39b176dabb2)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMAdminService.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/AdminService.java
, FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #232 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/232/])
YARN-3804. Both RM are on standBy state when kerberos user not in yarn.admin.acl. Contributed by Varun Saxena (xgong: rev a826d432f9b45550cc5ab79ef63ca39b176dabb2)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/AdminService.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMAdminService.java
* hadoop-yarn-project/CHANGES.txt
, SUCCESS: Integrated in Hadoop-Hdfs-trunk #2160 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2160/])
YARN-3804. Both RM are on standBy state when kerberos user not in yarn.admin.acl. Contributed by Varun Saxena (xgong: rev a826d432f9b45550cc5ab79ef63ca39b176dabb2)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/AdminService.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMAdminService.java
, SUCCESS: Integrated in Hadoop-Hdfs-trunk-Java8 #221 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/221/])
YARN-3804. Both RM are on standBy state when kerberos user not in yarn.admin.acl. Contributed by Varun Saxena (xgong: rev a826d432f9b45550cc5ab79ef63ca39b176dabb2)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/AdminService.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMAdminService.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #230 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/230/])
YARN-3804. Both RM are on standBy state when kerberos user not in yarn.admin.acl. Contributed by Varun Saxena (xgong: rev a826d432f9b45550cc5ab79ef63ca39b176dabb2)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/AdminService.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMAdminService.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #2178 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2178/])
YARN-3804. Both RM are on standBy state when kerberos user not in yarn.admin.acl. Contributed by Varun Saxena (xgong: rev a826d432f9b45550cc5ab79ef63ca39b176dabb2)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/AdminService.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/TestRMAdminService.java
]