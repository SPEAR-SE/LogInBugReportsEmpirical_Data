[Kindly review the attached patch, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12685762/0001-YARN-2922.patch
  against trunk revision 8963515.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager:

                  org.apache.hadoop.yarn.server.resourcemanager.TestContainerResourceUsage

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/6034//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/6034//console

This message is automatically generated., Thanks for creating the patch, [~rohithsharma].
{code}
@@ -1887,7 +1887,7 @@ public Resource getTotalResourcePending() {
   }
 
   @Override
-  public void collectSchedulerApplications(
+  public synchronized void collectSchedulerApplications(
{code}
I'm thinking we don't need the synchronization in collectSchedulerApplications, and it's better to use read-write lock for performance. You can use the latest patch in YARN-2910 as reference.
, Thanks [~ajisakaa] for reviewing patch.
I'd prefer to use synchronization rather than using read-write lock mechanism. In LeafQueue, {{pendingApplications}} and {{activeApplications}} are  synchronized on {{this}} in all the methods. There must be consistency lock acros LeafQueue. If I see FSLeafQueue, runningApps and nonrunningApps were not synchronized before. So, it is best approach to use read-write lock in FSLeafQueue., +1 for Rohith's patch. 

[~ajisakaa] it's not for performance but for avoiding deadlock essentially about FSLeafQueue on YARN-2910. , Thanks Rohith and Tsuyoshi. Now I'm +1 for the patch.
bq. org.apache.hadoop.yarn.server.resourcemanager.TestContainerResourceUsage
The failed test in Jenkins did not fail in my environment., Test case failures are unrelated to patch., Given if patch is fine, could it commit please?, Patch LGTM also, +1.

Thanks,
Wangda, looks like {{LeafQueue#getTotalResourcePending}} should be changed too. does it make sense to synchronize on the object itself ?, You are right, it is possible to ocure ConcurrentModificatinException since {{LeafQueue#getTotalResourcePending}} is public interface.

Updated the patch for the same, kindly review, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12689633/0001-YARN-2922.patch
  against trunk revision e2351c7.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager:

                  org.apache.hadoop.yarn.server.resourcemanager.security.TestRMDelegationTokens

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/6222//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/6222//console

This message is automatically generated., Test failure is unrelated to patch, it is passing locally with the patch, +1 for the latest patch., +1, Committed this to trunk and branch-2. Thanks [~rohithsharma] for your contribution and thanks Jian, Wangda, Akira for your reviews., FAILURE: Integrated in Hadoop-trunk-Commit #6803 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6803/])
YARN-2922. ConcurrentModificationException in CapacityScheduler's LeafQueue. Contributed by Rohith Sharmaks. (ozawa: rev ddc5be48fc35868abf7f59088f747c636e76a42a)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/TestLeafQueue.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/LeafQueue.java
, FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #63 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/63/])
YARN-2922. ConcurrentModificationException in CapacityScheduler's LeafQueue. Contributed by Rohith Sharmaks. (ozawa: rev ddc5be48fc35868abf7f59088f747c636e76a42a)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/TestLeafQueue.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/LeafQueue.java
, SUCCESS: Integrated in Hadoop-Yarn-trunk #797 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/797/])
YARN-2922. ConcurrentModificationException in CapacityScheduler's LeafQueue. Contributed by Rohith Sharmaks. (ozawa: rev ddc5be48fc35868abf7f59088f747c636e76a42a)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/LeafQueue.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/TestLeafQueue.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #64 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/64/])
YARN-2922. ConcurrentModificationException in CapacityScheduler's LeafQueue. Contributed by Rohith Sharmaks. (ozawa: rev ddc5be48fc35868abf7f59088f747c636e76a42a)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/TestLeafQueue.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/LeafQueue.java
* hadoop-yarn-project/CHANGES.txt
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk #2014 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2014/])
YARN-2922. ConcurrentModificationException in CapacityScheduler's LeafQueue. Contributed by Rohith Sharmaks. (ozawa: rev ddc5be48fc35868abf7f59088f747c636e76a42a)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/LeafQueue.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/TestLeafQueue.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #60 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/60/])
YARN-2922. ConcurrentModificationException in CapacityScheduler's LeafQueue. Contributed by Rohith Sharmaks. (ozawa: rev ddc5be48fc35868abf7f59088f747c636e76a42a)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/LeafQueue.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/TestLeafQueue.java
, SUCCESS: Integrated in Hadoop-Hdfs-trunk #1995 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1995/])
YARN-2922. ConcurrentModificationException in CapacityScheduler's LeafQueue. Contributed by Rohith Sharmaks. (ozawa: rev ddc5be48fc35868abf7f59088f747c636e76a42a)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/LeafQueue.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/capacity/TestLeafQueue.java
, Thanks [~ozawa] for commiting the patch:-), Pulled this into 2.6.1. Ran compilation and TestLeafQueue before the push. Patch applied cleanly.
]