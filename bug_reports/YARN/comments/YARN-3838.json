[Analysis

{{KerberosAuthenticationHandler#serverSubject}}  initialized with *HTTP/<IP>@HADOOP.COM* because {{HttpServer2#hostname}} is not resolved as hostname in {{HttpServer2#build()}}
{code}

 if (hostName == null) {
        hostName = endpoints.get(0).getHost();
      }

{code}

Since the same is initialized as IP in {{HttpServer2#initSpnego}} "kerberos.principal" will be set as *"HTTP/<IP>@HADOOP.COM"*


, Hoping that the analysis is correct. Please review the patch uploaded , Uploading patch with formatting.  Sorry missed it last time. , \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  16m 31s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | javac |   7m 35s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 41s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 23s | The applied patch does not increase the total number of release audit warnings. |
| {color:red}-1{color} | checkstyle |   1m  6s | The applied patch generated  1 new checkstyle issues (total was 63, now 64). |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 31s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 34s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   1m 51s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |
| {color:red}-1{color} | common tests |  22m 39s | Tests failed in hadoop-common. |
| | |  61m 55s | |
\\
\\
|| Reason || Tests ||
| Failed unit tests | hadoop.fs.shell.TestCount |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12739903/0001-YARN-3810.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / b039e69 |
| checkstyle |  https://builds.apache.org/job/PreCommit-YARN-Build/8264/artifact/patchprocess/diffcheckstylehadoop-common.txt |
| hadoop-common test log | https://builds.apache.org/job/PreCommit-YARN-Build/8264/artifact/patchprocess/testrun_hadoop-common.txt |
| Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/8264/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf906.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/8264/console |


This message was automatically generated., \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  16m 34s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | javac |   7m 36s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 46s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 22s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | checkstyle |   1m  5s | There were no new checkstyle issues. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 34s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   1m 51s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |
| {color:red}-1{color} | common tests |  22m 14s | Tests failed in hadoop-common. |
| | |  61m 38s | |
\\
\\
|| Reason || Tests ||
| Failed unit tests | hadoop.fs.shell.TestCount |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12739913/0002-YARN-3810.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / b039e69 |
| hadoop-common test log | https://builds.apache.org/job/PreCommit-YARN-Build/8265/artifact/patchprocess/testrun_hadoop-common.txt |
| Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/8265/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf907.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/8265/console |


This message was automatically generated., If fix is in {{HttpServer2}}, the issue can be moved to HADOOP common., Any comments on the same ? [~ajisakaa] Should i move to common?, Yes, you should move this jira to common if the fix is in hadoop-common-project., [~ajisakaa] have moved the same to common could you please review the same. , Any comments on the same ? In case of IP based installation this is blocking REST API functionality.
, Test failures are not related to this patch update. Seems another jira the same is already handled, IMO, this is a good failure.  People shouldn't be using IP addresses when using Kerberized services., Allen â€”why not? Especially given on windows that if you do a reverse lookup of 127.0.0.1 you don't get  "localhost' back. For some testing (yarn registry talking to secure ZK) I explicitly had to register user/127.0.0.1@EXAMPLE.COM to get things to work.

regarding the patch, I now think Kerberos is probably the bit of the codebase we have to tread most carefully around. Whoever claims to be the experts in Hadoop, Kerberos and HTTP will need to review it, and then, ideally. it gets some serious testing before patch goes in, Last I knew, properly configured/secured *clients* should properly be canonicalizing the involved principal names.  This is especially important when multiple Kerberos realms are configured so that the client knows which x-realm(s) to use to get there.  There pretty much is no way to map an IP addr to a realm that I can remember.  

There's also the problem of multi-homed hosts.  You really want to use *one name* not lots.  Yes, you can use KDC aliasing mapping, etc to work around some of these problems, but that's really impractical operationally, especially when the KDC isn't owned by the team running Hadoop., [~aw] and [~stevel@apache.org] Thnk you for looking in to the issue. As i know {{HTTP/_HOST@HADOOP.COM}} if we configure its means supposed to resolve to hostname rt? In all cases ? Not just  {{Url.gethost()}} so i am find little bit confusing. In {{KerberosAuthenticationHandler#authenticate}} {code}final String serverName = request.getServerName();{code} its trying to find out the hostname always. so why not in {{HttpServer2}? , Hi All Please provide your valuable comments, way currently hostname is resolved seems wrong to me., {{HttpRequest.getServerName()}} is normally used in webapps as it gives you the name used by the client to talk to the web site, which you can then use in responses. This is important it you have >1 NIC with >1 hostname, or doing multihomed work where >1 hostname maps to the same IP address. 

I think in security we're less concerned about having support for multihoming, and instead having something secure.

AWs comments do make sense; the problem I'd been having with windows and 127.0.0.1 not mapping to localhost was related to MiniKDC tests, where everything was trying to run locally, not part of a domain.

Looking at the HttpServer2 code, there is a way in the builder API to set the hostname. Picking the name of the first listener is explicitly listed as a fallback. 

Looking at your patch you are trying to get IP address and then work out the host, but that's relying on IP DNS lookup working. And while that is something people should have working in a working Hadoop cluster, it's not something we can assume in test setups, VMs &c ... the stuff we use a lot for development.

I think the better way address this is issue is to use {{Builder.setHostname()}} to allow the hostname to be explicitly set. My IDE says that's what Datanodes do, in {{DatanodeHttpServer.getHostnameForSpnegoPrincipal()};

That way: no changes in HttpServer2 which could have consequences elsewhere. Instead, how the RM can be setup is improved.

now, two disclaimers
# I know enough about Keberos to know that I should not be involved in any reviewing of security patches
# I don't know my way round HttpServer2

Which means that if you are going to do patches, I'm not in a position to say "+1, committed" to any of them. , Thnk you Steve for your valuable comments. I tried webhdfs api and is  working even when ip is configured. i check more on why rm rest  is not working will update on the same , As per the discussion till now we should handle in HttpServer2 . Also as per the test result webhdfs is working so should handle in yarn side only., In case of resourcemanager the httpserver is started as below and the url used is just the ip address
{{WebApps#start}}
{code}
     HttpServer2.Builder builder = new HttpServer2.Builder()
            .setName(name)
            .addEndpoint(
                URI.create(httpScheme + bindAddress
                    + ":" + port)).setConf(conf).setFindPort(findPort)
            .setACL(new AccessControlList(conf.get(
              YarnConfiguration.YARN_ADMIN_ACL, 
              YarnConfiguration.DEFAULT_YARN_ADMIN_ACL)))
            .setPathSpec(pathList.toArray(new String[0]));

{code}

Comparing the same to hdfs side for NameNode the URL is formed as below

{{DFSUtil#httpServerTemplateForNNAndJN}} 
{code}
      URI uri = URI.create("http://" + NetUtils.getHostPortString(httpAddr));
{code}

Seems like this is reason why there is a difference in both hdfs and yarn for *REST api functionality when IP is configured in kerberos mode*. In case of hdfs it works but yarn its doesnt.

Can we hange RM HTTPServer2.builder as velow

{code}
  HttpServer2.Builder builder =
            new HttpServer2.Builder()
                .setName(name)
                .addEndpoint(
                    URI.create(httpScheme
                        + NetUtils.getHostPortString(new InetSocketAddress(
                            bindAddress, port))))
                .setConf(conf)
                .setFindPort(findPort)
                .setACL(
                    new AccessControlList(conf.get(
                        YarnConfiguration.YARN_ADMIN_ACL,
                        YarnConfiguration.DEFAULT_YARN_ADMIN_ACL)))
                .setPathSpec(pathList.toArray(new String[0]));
{code}

Please do correct me if i am wrong ., Typo in earlier comments 
{quote}
As per the discussion till now we should handle in HttpServer2
{quote}
As per the discussion till now we should handle in HttpServer2.builder , Added patch for review 0001-YARN-3838. Please do review , \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  17m 52s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | javac |   7m 33s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 41s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 23s | The applied patch does not increase the total number of release audit warnings. |
| {color:red}-1{color} | checkstyle |   1m 34s | The applied patch generated  1 new checkstyle issues (total was 39, now 40). |
| {color:red}-1{color} | whitespace |   0m  0s | The patch has 2  line(s) that end in whitespace. Use git apply --whitespace=fix. |
| {color:green}+1{color} | install |   1m 35s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 32s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   3m 24s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |
| {color:green}+1{color} | common tests |  22m  2s | Tests passed in hadoop-common. |
| {color:green}+1{color} | yarn tests |   1m 56s | Tests passed in hadoop-yarn-common. |
| | |  66m 50s | |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12740917/0001-YARN-3838.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / 99271b7 |
| checkstyle |  https://builds.apache.org/job/PreCommit-YARN-Build/8322/artifact/patchprocess/diffcheckstylehadoop-common.txt |
| whitespace | https://builds.apache.org/job/PreCommit-YARN-Build/8322/artifact/patchprocess/whitespace.txt |
| hadoop-common test log | https://builds.apache.org/job/PreCommit-YARN-Build/8322/artifact/patchprocess/testrun_hadoop-common.txt |
| hadoop-yarn-common test log | https://builds.apache.org/job/PreCommit-YARN-Build/8322/artifact/patchprocess/testrun_hadoop-yarn-common.txt |
| Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/8322/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf905.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/8322/console |


This message was automatically generated., Updated patch since new util is not required to be added. , \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  16m  7s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | javac |   7m 35s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 36s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 23s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | checkstyle |   0m 54s | There were no new checkstyle issues. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 35s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   1m 34s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |
| {color:green}+1{color} | yarn tests |   1m 57s | Tests passed in hadoop-yarn-common. |
| | |  40m 19s | |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12741889/0002-YARN-3838.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / bc43390 |
| hadoop-yarn-common test log | https://builds.apache.org/job/PreCommit-YARN-Build/8348/artifact/patchprocess/testrun_hadoop-yarn-common.txt |
| Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/8348/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf905.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/8348/console |


This message was automatically generated., [~jianhe] Could you please review patch if possible. , Hi [~vinodkv] and [~kasha] could you provide your comments on this., I don't know my way around in this neck of the woods. [~vinodkv], [~xgong] know a thing or two. , Hi [~xgong] any comments on this , This issue looks critical, [~sunilg], [~jianhe] could you look at the patch?]