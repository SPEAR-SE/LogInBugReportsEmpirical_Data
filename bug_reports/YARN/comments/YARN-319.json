[The reason is at FairScheduler#addApplication, if user cannot submit job to the queue, it return directly, we 

should create a RMAppAttemptRejectedEvent and handle.

original:
    // Enforce ACLs
    UserGroupInformation userUgi = UserGroupInformation.createRemoteUser(user);
    if (!queue.hasAccess(QueueACL.SUBMIT_APPLICATIONS, userUgi)) {
      LOG.info("User " + userUgi.getUserName() +
          " cannot submit applications to queue " + queue.getName());
      return;
    }

after modification:

    // Enforce ACLs
    UserGroupInformation userUgi = UserGroupInformation.createRemoteUser(user);
    if (!queue.hasAccess(QueueACL.SUBMIT_APPLICATIONS, userUgi)) {
      String msg = "User " + userUgi.getUserName() +
          " cannot submit applications to queue " + queue.getName();
      LOG.info(msg);
      rmContext.getDispatcher().getEventHandler().handle(
          new RMAppAttemptRejectedEvent(applicationAttemptId, msg));
      return;
    }

I will create a patch to fix it., This patch looks good to me.  Have you done any testing to ensure that it works?, Of course, Our version already includes this patch., Here is the log of yarn client:

13/01/13 13:18:26 ERROR security.UserGroupInformation: PriviledgedActionException as:yuling.sh  cause:java.io.IOException: Failed to run job : User yuling.sh cannot submit applications to queue root.cug-dev-tbdp
java.io.IOException: Failed to run job : User yuling.sh cannot submit applications to queue root.cug-dev-tbdp
	at org.apache.hadoop.mapred.YARNRunner.submitJob(YARNRunner.java:301)
	at org.apache.hadoop.mapreduce.JobSubmitter.submitJobInternal(JobSubmitter.java:391)
	at org.apache.hadoop.mapreduce.Job$11.run(Job.java:1218)
	at org.apache.hadoop.mapreduce.Job$11.run(Job.java:1215)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:396)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1266)
	at org.apache.hadoop.mapreduce.Job.submit(Job.java:1215)
	at org.apache.hadoop.mapreduce.Job.waitForCompletion(Job.java:1236)
	at org.apache.hadoop.mapreduce.SleepJob.run(SleepJob.java:262)
	at org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:69)
	at org.apache.hadoop.mapreduce.SleepJob.main(SleepJob.java:194)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.apache.hadoop.util.ProgramDriver$ProgramDescription.invoke(ProgramDriver.java:72)
	at org.apache.hadoop.util.ProgramDriver.driver(ProgramDriver.java:144)
	at org.apache.hadoop.test.MapredTestDriver.run(MapredTestDriver.java:112)
	at org.apache.hadoop.test.MapredTestDriver.main(MapredTestDriver.java:120)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.apache.hadoop.util.RunJar.main(RunJar.java:208), Here is the log of ResourceManager:

2013-01-13 13:18:26,922 INFO org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.FairScheduler: User yuling
.sh cannot submit applications to queue root.cug-dev-tbdp
2013-01-13 13:18:26,924 INFO org.apache.hadoop.yarn.server.resourcemanager.rmapp.attempt.RMAppAttemptImpl: appattemp
t_1357617565562_0696_000001 State change from SUBMITTED to FAILED
2013-01-13 13:18:26,924 INFO org.apache.hadoop.yarn.server.resourcemanager.rmapp.RMAppImpl: application_135761756556
2_0696 State change from SUBMITTED to FAILED
2013-01-13 13:18:26,924 WARN org.apache.hadoop.yarn.server.resourcemanager.RMAuditLogger: USER=yuling.sh        OPER
ATION=Application Finished - Failed TARGET=RMAppManager     RESULT=FAILURE  DESCRIPTION=App failed with state: FAILE
D       PERMISSIONS=User yuling.sh cannot submit applications to queue root.cug-dev-tbdp        APPID=application_13
57617565562_0696
2013-01-13 13:18:26,924 INFO org.apache.hadoop.yarn.server.resourcemanager.RMAppManager$ApplicationSummary: appId=ap
plication_1357617565562_0696,name=Sleep job,user=yuling.sh,queue=cug-dev-tbdp,state=FAILED,trackingUrl=hdpdevrm:5003
0/proxy/application_1357617565562_0696/,appMasterHost=N/A,startTime=1358054306921,finishTime=1358054306924, Is it possible to write a unit test for this?, It would be difficult to write one that checks things from the client side, but it should be possible to write one that checks that the application ends up in right FAILED state.  Would you like to write the test Shenhong? If not, I can take a stab at it., Soorry, will add a testcase later today., I don't know the commond to run a test like TestFairscheduler, can anybody tell me how., You can run "mvn test -Dtest=TestFairScheduler"

If you want to run a single test in a file, you can run something like "mvn test -Dtest=TestFairScheduler#testSimpleFairShareCalculation" , add a testcast, Thanks for you help, Sandy Ryza., Thanks for writing the test!  It looks great.  A few nitpicks:

* The variable app_id should be named appId.
* System.out.println("ALLOC_FILE:"+ALLOC_FILE); should be removed.
* Is there a reason not to increment ATTEMPT_ID, as is done in createSchedulingRequest.
* There are too many blank lines after the line with putIfAbsent.
* Is the second to last line necessary, as application is already assigned to the correct RMApp?
* It's better not to rely on sleeps to wait for events to occur on other threads, because it can cause running tests to take too long if they're high, and cause tests to fail flakily if they're low.  If I understand correctly, you can remove the need for the first sleep by calling application.handle(...) instead of rmContext.getDispatcher().getEventHandler().handle(...).  When waiting for the final application status to be failed, you can use a smaller sleep inside a loop.  TestNodeManagerShutdown has something like this on line 141. , fix, Thanks, the fix looks good to me., A couple of nits: indentation of annotations for the test @Test is wrong, app_id should be appId. Otherwise looks good. I'm submitting it to Jenkins., > When waiting for the final application status to be failed, you can use a smaller sleep inside a loop. TestNodeManagerShutdown has something like this on line 141.

Would it be possible to use a synchronous event handler in the tests so that we don't have to poll?, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12565732/YARN-319-2.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:red}-1 eclipse:eclipse{color}.  The patch failed to build with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/361//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/361//console

This message is automatically generated., fix indentation of annotations, rename app_id to appId , rename att_id to attId.,  > Would it be possible to use a synchronous event handler in the tests so that we don't have to poll?
 I don't know how to do that., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12566075/YARN-319-3.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/362//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/362//console

This message is automatically generated., +1 I just committed this. Thanks, shenhong!, Integrated in Hadoop-trunk-Commit #3273 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3273/])
    YARN-319. Submitting a job to a fair scheduler queue for which the user does not have permission causes the client to wait forever. Contributed by shenhong. (Revision 1437336)

     Result = SUCCESS
tomwhite : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1437336
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/FairScheduler.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/TestFairScheduler.java
, Integrated in Hadoop-Hdfs-trunk #1294 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1294/])
    YARN-319. Submitting a job to a fair scheduler queue for which the user does not have permission causes the client to wait forever. Contributed by shenhong. (Revision 1437336)

     Result = FAILURE
tomwhite : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1437336
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/FairScheduler.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/TestFairScheduler.java
, Integrated in Hadoop-Mapreduce-trunk #1322 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1322/])
    YARN-319. Submitting a job to a fair scheduler queue for which the user does not have permission causes the client to wait forever. Contributed by shenhong. (Revision 1437336)

     Result = SUCCESS
tomwhite : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1437336
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/FairScheduler.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/TestFairScheduler.java
, Integrated in Hadoop-Yarn-trunk #106 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/106/])
    YARN-319. Submitting a job to a fair scheduler queue for which the user does not have permission causes the client to wait forever. Contributed by shenhong. (Revision 1437336)

     Result = FAILURE
tomwhite : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1437336
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/FairScheduler.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/scheduler/fair/TestFairScheduler.java
, Even though the fix version is set to 2.0.3, it isn't merged into branch-2 at all. I just merged it into 2.0.5-beta, and changing the fix version., Integrated in Hadoop-trunk-Commit #3603 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3603/])
    Fixing CHANGES.txt entry for YARN-319. (Revision 1467133)

     Result = SUCCESS
vinodkv : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1467133
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
, Integrated in Hadoop-Yarn-trunk #181 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/181/])
    Fixing CHANGES.txt entry for YARN-319. (Revision 1467133)

     Result = SUCCESS
vinodkv : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1467133
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
, Integrated in Hadoop-Hdfs-trunk #1370 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1370/])
    Fixing CHANGES.txt entry for YARN-319. (Revision 1467133)

     Result = FAILURE
vinodkv : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1467133
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
, Integrated in Hadoop-Mapreduce-trunk #1397 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1397/])
    Fixing CHANGES.txt entry for YARN-319. (Revision 1467133)

     Result = SUCCESS
vinodkv : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1467133
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
]