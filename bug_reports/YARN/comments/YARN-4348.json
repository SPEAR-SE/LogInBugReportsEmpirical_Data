[Attaching a log file., The issue looks similar to YARN-3753. One workaround is to change the timeout for the sync to zkResyncWaitTime as [~jianhe] changed on YARN-3753. Attaching a patch for this.

If the timeout be increased, the probability of the case will be decreased, but it can still happen. e.g. ZK's server packet for the reply against sync is dropped after the operation itself success.

, TestZKRMStateStore fails because of timeout. Let me survey., upload same patch to kick jenkins
, Found that testZKRootPathAcls fails because of time out with the patch. I will check it more deeper.

{code:title=TestZKRMStateStore-output.txt|}
2015-11-15 02:15:17,324 INFO  [main] zookeeper.JUnit4ZKTestRunner (JUnit4ZKTestRunner.java:evaluate(50)) - RUNNING TEST METHOD testZKRootPathAcls
... ...
2015-11-15 02:30:12,774 DEBUG [SyncThread:0] server.FinalRequestProcessor (FinalRequestProcessor.java:processRequest(88)) - Processing request:: sessionid:0x15108ecd3b20001 type:ping cxid:0xfffffffffffffffe zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a
2015-11-15 02:30:12,774 DEBUG [SyncThread:0] server.FinalRequestProcessor (FinalRequestProcessor.java:processRequest(160)) - sessionid:0x15108ecd3b20001 type:ping cxid:0xfffffffffffffffe zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a
2015-11-15 02:30:12,775 DEBUG [main-SendThread(127.0.0.1:11221)] zookeeper.ClientCnxn (ClientCnxn.java:readResponse(717)) - Got ping response for sessionid: 0x15108ecd3b20001 after 0ms
2015-11-15 02:30:14,776 DEBUG [SyncThread:0] server.FinalRequestProcessor (FinalRequestProcessor.java:processRequest(88)) - Processing request:: sessionid:0x15108ecd3b20001 type:ping cxid:0xfffffffffffffffe zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a
2015-11-15 02:30:14,776 DEBUG [SyncThread:0] server.FinalRequestProcessor (FinalRequestProcessor.java:processRequest(160)) - sessionid:0x15108ecd3b20001 type:ping cxid:0xfffffffffffffffe zxid:0xfffffffffffffffe txntype:unknown reqpath:n/a
2015-11-15 02:30:14,776 DEBUG [main-SendThread(127.0.0.1:11221)] zookeeper.ClientCnxn (ClientCnxn.java:readResponse(717)) - Got ping response for sessionid: 0x15108ecd3b20001 after 0ms
~                            
{code}, The test failure I mentioned is caused by using zkResyncWaitTime as the timeout value of sync operation - the default value of zkResyncWaitTime is smaller than zkSessionTimeout. We should use the timeout value which is larger than zkSessionTimeout, so just changing to use zkSessionTimeout * 3.

In addition to this, we should care about the failure of sync operation at startup time to preventing RM from continuing to run in illegal state - ZK's inconsistent view. 

Attaching a patch to fix the test failure and the error handling at startup time(startInternal). [~jianhe], could you take a look?, | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue} 0m 8s {color} | {color:blue} docker + precommit patch detected. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green} 0m 0s {color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red} 0m 0s {color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:red}-1{color} | {color:red} mvninstall {color} | {color:red} 7m 24s {color} | {color:red} root in branch-2.7 failed. {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 0m 21s {color} | {color:green} branch-2.7 passed with JDK v1.8.0_60 {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 0m 22s {color} | {color:green} branch-2.7 passed with JDK v1.7.0_79 {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green} 0m 18s {color} | {color:green} branch-2.7 passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green} 0m 35s {color} | {color:green} branch-2.7 passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green} 0m 16s {color} | {color:green} branch-2.7 passed {color} |
| {color:red}-1{color} | {color:red} findbugs {color} | {color:red} 1m 20s {color} | {color:red} hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager in branch-2.7 has 1 extant Findbugs warnings. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green} 0m 27s {color} | {color:green} branch-2.7 passed with JDK v1.8.0_60 {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green} 0m 25s {color} | {color:green} branch-2.7 passed with JDK v1.7.0_79 {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 0m 27s {color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 0m 22s {color} | {color:green} the patch passed with JDK v1.8.0_60 {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 0m 22s {color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green} 0m 22s {color} | {color:green} the patch passed with JDK v1.7.0_79 {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green} 0m 22s {color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red} 0m 14s {color} | {color:red} Patch generated 1 new checkstyle issues in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager (total was 229, now 230). {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green} 0m 30s {color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green} 0m 14s {color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} whitespace {color} | {color:red} 0m 2s {color} | {color:red} The patch has 700 line(s) that end in whitespace. Use git apply --whitespace=fix. {color} |
| {color:red}-1{color} | {color:red} whitespace {color} | {color:red} 0m 19s {color} | {color:red} The patch has 95 line(s) with tabs. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green} 1m 21s {color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green} 0m 21s {color} | {color:green} the patch passed with JDK v1.8.0_60 {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green} 0m 27s {color} | {color:green} the patch passed with JDK v1.7.0_79 {color} |
| {color:red}-1{color} | {color:red} unit {color} | {color:red} 52m 48s {color} | {color:red} hadoop-yarn-server-resourcemanager in the patch failed with JDK v1.8.0_60. {color} |
| {color:red}-1{color} | {color:red} unit {color} | {color:red} 53m 7s {color} | {color:red} hadoop-yarn-server-resourcemanager in the patch failed with JDK v1.7.0_79. {color} |
| {color:red}-1{color} | {color:red} asflicense {color} | {color:red} 44m 16s {color} | {color:red} Patch generated 71 ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 167m 48s {color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| JDK v1.8.0_60 Failed junit tests | hadoop.yarn.server.resourcemanager.TestClientRMTokens |
|   | hadoop.yarn.server.resourcemanager.TestRMHAForNodeLabels |
|   | hadoop.yarn.server.resourcemanager.TestKillApplicationWithRMHA |
|   | hadoop.yarn.server.resourcemanager.TestAMAuthorization |
|   | hadoop.yarn.server.resourcemanager.TestResourceTrackerService |
|   | hadoop.yarn.server.resourcemanager.recovery.TestZKRMStateStorePerf |
|   | hadoop.yarn.server.resourcemanager.TestSubmitApplicationWithRMHA |
|   | hadoop.yarn.server.resourcemanager.recovery.TestZKRMStateStore |
| JDK v1.7.0_79 Failed junit tests | hadoop.yarn.server.resourcemanager.TestClientRMTokens |
|   | hadoop.yarn.server.resourcemanager.TestRMHAForNodeLabels |
|   | hadoop.yarn.server.resourcemanager.TestKillApplicationWithRMHA |
|   | hadoop.yarn.server.resourcemanager.TestAMAuthorization |
|   | hadoop.yarn.server.resourcemanager.TestResourceTrackerService |
|   | hadoop.yarn.server.resourcemanager.recovery.TestZKRMStateStorePerf |
|   | hadoop.yarn.server.resourcemanager.TestSubmitApplicationWithRMHA |
|   | hadoop.yarn.server.resourcemanager.recovery.TestZKRMStateStore |
\\
\\
|| Subsystem || Report/Notes ||
| Docker | Client=1.7.1 Server=1.7.1 Image:test-patch-base-hadoop-date2015-11-16 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12772452/YARN-4348-branch-2.7.002.patch |
| JIRA Issue | YARN-4348 |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux 8265c5a7ae9a 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /home/jenkins/jenkins-slave/workspace/PreCommit-YARN-Build/patchprocess/apache-yetus-fa12328/precommit/personality/hadoop.sh |
| git revision | branch-2.7 / 8ea88ab |
| mvninstall | https://builds.apache.org/job/PreCommit-YARN-Build/9694/artifact/patchprocess/branch-mvninstall-root.txt |
| findbugs | v3.0.0 |
| findbugs | https://builds.apache.org/job/PreCommit-YARN-Build/9694/artifact/patchprocess/branch-findbugs-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-resourcemanager-warnings.html |
| checkstyle | https://builds.apache.org/job/PreCommit-YARN-Build/9694/artifact/patchprocess/diff-checkstyle-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-resourcemanager.txt |
| whitespace | https://builds.apache.org/job/PreCommit-YARN-Build/9694/artifact/patchprocess/whitespace-eol.txt |
| whitespace | https://builds.apache.org/job/PreCommit-YARN-Build/9694/artifact/patchprocess/whitespace-tabs.txt |
| unit | https://builds.apache.org/job/PreCommit-YARN-Build/9694/artifact/patchprocess/patch-unit-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-resourcemanager-jdk1.8.0_60.txt |
| unit | https://builds.apache.org/job/PreCommit-YARN-Build/9694/artifact/patchprocess/patch-unit-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-resourcemanager-jdk1.7.0_79.txt |
| unit test logs |  https://builds.apache.org/job/PreCommit-YARN-Build/9694/artifact/patchprocess/patch-unit-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-resourcemanager-jdk1.8.0_60.txt https://builds.apache.org/job/PreCommit-YARN-Build/9694/artifact/patchprocess/patch-unit-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-resourcemanager-jdk1.7.0_79.txt |
| JDK v1.7.0_79  Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/9694/testReport/ |
| asflicense | https://builds.apache.org/job/PreCommit-YARN-Build/9694/artifact/patchprocess/patch-asflicense-problems.txt |
| modules | C: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager U: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager |
| Max memory used | 149MB |
| Powered by | Apache Yetus   http://yetus.apache.org |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/9694/console |


This message was automatically generated.

, YARN-4306 for the assertion error of getProxy.

I'll check related test failure, TestZKRMStateStore., After taking a look deeper, the reply packet against sync operation looks to be pending in blocking list of ClientCnxn#EventTrread. After the thread interrupted, it's processed correctly.

{code}
2015-11-19 07:21:47,955 DEBUG [main-SendThread(127.0.0.1:11221)] zookeeper.ClientCnxn (ClientCnxn.java:readResponse(733)) - Got auth sessionid:0x1511cb079430000
...
2015-11-19 07:21:48,019 DEBUG [SyncThread:0] server.FinalRequestProcessor (FinalRequestProcessor.java:processRequest(88)) - Processing request:: sessionid:0x1511cb079430000 type:sync: cxid:0xb zxid:0xfffffffffffffffe txntype:unknown reqpath:/rmstore/ZKRMStateRoot
...
2015-11-19 07:21:48,013 DEBUG [main-SendThread(127.0.0.1:11221)] zookeeper.ClientCnxn (ClientCnxn.java:readResponse(818)) - Reading reply sessionid:0x1511cb079430000, packet:: clientPath:null serverPath:null finished:false header:: 10,1  replyHeader:: 10,11,0  request:: '/rmstore/ZKRMStateRoot/AMRMTokenSecretManagerRoot,,v{s{31,s{'world,'anyone}}},0  response:: '/rmstore/ZKRMStateRoot/AMRMTokenSecretManagerRoot 
2015-11-19 07:21:48,019 DEBUG [SyncThread:0] server.FinalRequestProcessor (FinalRequestProcessor.java:processRequest(88)) - Processing request:: sessionid:0x1511cb079430000 type:sync: cxid:0xb zxid:0xfffffffffffffffe txntype:unknown reqpath:/rmstore/ZKRMStateRoot
2015-11-19 07:21:48,019 DEBUG [SyncThread:0] server.FinalRequestProcessor (FinalRequestProcessor.java:processRequest(160)) - sessionid:0x1511cb079430000 type:sync: cxid:0xb zxid:0xfffffffffffffffe txntype:unknown reqpath:/rmstore/ZKRMStateRoot
...
2015-11-19 07:22:03,027 INFO  [main] service.AbstractService (AbstractService.java:noteFailure(272)) - Service org.apache.hadoop.yarn.server.resourcemanager.recovery.RMStateStore failed in state STARTED; cause: java.io.IOException: failing to sync operation at starting up RM
java.io.IOException: failing to sync operation at starting up RM
...
2015-11-19 07:22:03,029 INFO  [main] event.AsyncDispatcher (AsyncDispatcher.java:serviceStop(141)) - AsyncDispatcher is draining to stop, igonring any new events.
2015-11-19 07:22:03,030 INFO  [main-EventThread] recovery.ZKRMStateStore (ZKRMStateStore.java:processResult(122)) - ZooKeeper sync operation succeeded. path: /rmstore/ZKRMStateRoot
2015-11-19 07:22:03,030 INFO  [org.apache.hadoop.yarn.server.resourcemanager.recovery.ZKRMStateStore$VerifyActiveStatusThread] recovery.ZKRMStateStore (ZKRMStateStore.java:run(1131)) - org.apache.hadoop.yarn.server.resourcemanager.recovery.ZKRMStateStore$VerifyActiveStatusThread thread interrupted! Exiting!
2015-11-19 07:22:03,030 INFO  [main-EventThread] recovery.ZKRMStateStore (ZKRMStateStore.java:processResult(124)) - ZooKeeper sync operation succeeded. path: /rmstore/ZKRMStateRoot
{code}
, Found that this is caused by the lock ordering.

1. (In main thread of RM) locking ZKRMStateStore(startInternal) -> waiting for lock.await() 
2. ZK's eventThread: Got SyncConnected event from ZK -> Calling ForwardingWatcher#process -> processWatchEvent called, but ZKRMStateStore has been locked since 1
3. (In main thread of RM)  timeout and IOException -> unlocking ZKRMStateStore() -> the callback, processEvent, of sync is fired.

I will attach a patch to address this problem., {quote}
Archiving artifacts
[description-setter] Description set: YARN-4348
Recording test results
ERROR: Publisher 'Publish JUnit test result report' failed: No test report files were found. Configuration error?
Email was triggered for: Failure - Any
Sending email for trigger: Failure - Any
An attempt to send an e-mail to empty list of recipients, ignored.
Finished: FAILURE
{quote}

Hmm, Jenkins looks to be unhealthy. , Kicking Jenkins again., Ran test since last Jenkins failed to launch. 
{quote}
-1 overall.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    -1 javadoc.  The javadoc tool appears to have generated 2079 warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version ) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.
{quote}
, [~ozawa], should below call continue in the end  ?
{code}
          if (shouldRetryWithNewConnection(ke.code()) && retry < numRetries) {
            LOG.info("Retrying operation on ZK with new Connection. " +
                "Retry no. " + retry);
            Thread.sleep(zkRetryInterval);
            createConnection();
            syncInternal(ke.getPath());
          }
{code}, [~jianhe] good catch. Adding missing {{continue}} statement after calling {{syncInternal}} in v4 patch. , Jenkins still fail. Opened YETUS-217 to track the problem. Kicking test-patch.sh on local., Ran test since last Jenkins failed to launch. javadoc seems to be false positive since this patch doesn't include any changes of javadocs.

{quote}
-1 overall.  

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    -1 javadoc.  The javadoc tool appears to have generated 2079 warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version ) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.
{quote}

[~jianhe] could you take a look at latest patch?, Hi [~ozawa] and [~jianhe], is this a blocker bug? Can we move it to 2.6.4?, [~djp] IMHO, this is a blocker ticket of 2.6.3 and 2.7.3 since the problem is more serious than I've thought. please check [this comment|https://issues.apache.org/jira/browse/YARN-4348?focusedCommentId=15018159&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15018159]. This is a unexpected behaviour when RM fails over and it prevents RM fail over correctly., [~zxu] [~jianhe]
I'm rethinking of [this comment|https://issues.apache.org/jira/browse/YARN-3798?focusedCommentId=14609769&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14609769] about sync callback to wait for sync completion: this can cause [the lock problem described here|https://issues.apache.org/jira/browse/YARN-4348?focusedCommentId=15018159&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15018159]. 

To deal with problem easily, we can just remove a barrier by the sync callback. This works well because ZK client's requests are sent to ZK server in order, unless ZK master server fails while recreating ZK connection. Quorum sync, ZOOKEEPER-2136, is good helper to deal with the corner case.

What do you think?, [~jianhe] could you take a look?, lgtm, thanks !, Checking this in., Committed this to branch-2.7. Thanks [~jianhe] for reviewing and reporting!

I will cherrypick this to branch-2.6 after running tests., bq. I will cherrypick this to branch-2.6 after running tests.
Hi [~ozawa], would you check this in 2.6.3 branch as well given we mark this as a blocker for 2.6.3? Thanks!, Ran tests locally and pass tests on branch-2.6. Committing this to branch-2.6., [~djp] I committed this to branch-2.6, which is targeting 2.6.3. Can I push this to branch-2.6.3?, Now I committed this to branch-2.6.3 too. Thanks!, FAILURE: Integrated in Hadoop-trunk-Commit #8938 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/8938/])
Update CHANGES.txt for commit of YARN-4348 to branch-2.7 and branch-2.6. (ozawa: rev d7b3f8dbe818cff5fee4f4c0c70d306776aa318e)
* hadoop-yarn-project/CHANGES.txt
, Sounds good. Thanks!, FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #675 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/675/])
Update CHANGES.txt for commit of YARN-4348 to branch-2.7 and branch-2.6. (ozawa: rev d7b3f8dbe818cff5fee4f4c0c70d306776aa318e)
* hadoop-yarn-project/CHANGES.txt
, Pulled this into 2.7.2 to keep the release up-to-date with 2.6.3. Changing fix-versions to reflect the same., Hi [~jianhe] and [~ozawa], Does this fix need to go to trunk/branch-2/branch-2.8?, No, it doesn't need to. The zkstore implementation has been changed by using curator 2.8 upwards, Got it. Thanks for confirmation here, Jian!, Yes, Jian is correct.]