[OK It actually looks like the NM is trying to get the Master Key, before it ever has set it, which is causing the NPE., This is really odd.  I put in logging in the ResourceTrackerService and in the NodeStatusUpdaterImpl.  The RM sets the secret key in the RegisterNodeManagerResponse, but the NM only sees a null come out for it.  Because of that the heartbeat always fails with the NPE trying to read something that was never set., This issue appears to be cause by a bug in RegisterNodeManagerResponsePBImpl.  I think specifically it was caused by YARN-440. I have a unit test that can reproduce it.  Sid reviewed YARN-440 and he is a really smart guy.  I looked at it thinking that it must be the cause of the issue and I didn't see anything in there that was off.

I just think all this extra code to try and wrap the protocol buffers is just a bad idea.  It makes things difficult to change a .proto file, and it just slows things down.  But it is a lot of work to change it so I am done with my rant now, I'll go find a fix for the issue., Yes the issue is that there is a rebuild flag in the PBImpl that is never set to true, so it will never rebuild the proto., This should fix the issue.  We forgot to tell the wrapper to rebuild after setting some values.

There is a unit test included that shows the problem., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12576077/YARN-515.txt
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/629//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/629//console

This message is automatically generated., +1, Integrated in Hadoop-trunk-Commit #3540 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3540/])
    YARN-515. Node Manager not getting the master key. Contributed by Robert Joseph Evans (Revision 1462632)

     Result = SUCCESS
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1462632
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/main/java/org/apache/hadoop/yarn/server/api/protocolrecords/impl/pb/RegisterNodeManagerResponsePBImpl.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api/protocolrecords
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api/protocolrecords/TestRegisterNodeManagerResponse.java
, Thanks, Bobby.  I committed this to trunk and branch-2., Integrated in Hadoop-Yarn-trunk #170 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/170/])
    YARN-515. Node Manager not getting the master key. Contributed by Robert Joseph Evans (Revision 1462632)

     Result = FAILURE
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1462632
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/main/java/org/apache/hadoop/yarn/server/api/protocolrecords/impl/pb/RegisterNodeManagerResponsePBImpl.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api/protocolrecords
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api/protocolrecords/TestRegisterNodeManagerResponse.java
, Integrated in Hadoop-Hdfs-trunk #1359 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1359/])
    YARN-515. Node Manager not getting the master key. Contributed by Robert Joseph Evans (Revision 1462632)

     Result = FAILURE
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1462632
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/main/java/org/apache/hadoop/yarn/server/api/protocolrecords/impl/pb/RegisterNodeManagerResponsePBImpl.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api/protocolrecords
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api/protocolrecords/TestRegisterNodeManagerResponse.java
, Integrated in Hadoop-Mapreduce-trunk #1387 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1387/])
    YARN-515. Node Manager not getting the master key. Contributed by Robert Joseph Evans (Revision 1462632)

     Result = FAILURE
jlowe : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1462632
Files : 
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/main/java/org/apache/hadoop/yarn/server/api/protocolrecords/impl/pb/RegisterNodeManagerResponsePBImpl.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api/protocolrecords
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-common/src/test/java/org/apache/hadoop/yarn/server/api/protocolrecords/TestRegisterNodeManagerResponse.java
, [~revans2], [~jlowe], thanks for taking care of this. I'll request people to test patches in secure mode from now on., Having people always test the patches in secure mode I think is a bit too high of a barrier for some.  I personally hate having to get it all set up to be able to test a patch.  Registration responses in general were broken.  The NM would never get a reboot signal either.  It was always the default enum value of everything is fine.  I am just glad that we caught it. , Missed this while reviewing YARN-440... also in the second (probably biased) review when this jira was opened. Sorry about that.

bq. I just think all this extra code to try and wrap the protocol buffers is just a bad idea. It makes things difficult to change a .proto file
Agree with this. Seemed useful at the time, but the PBImpl stuff is rather painful to maintain, without adding a whole lot of value.]