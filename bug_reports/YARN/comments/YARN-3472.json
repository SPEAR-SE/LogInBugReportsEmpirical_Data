[I think it also should cancel the token, am i right?
{{cancelToken(dttr);}}, I don't think so, canceling the token will cause existing running applications to fail, this gives a grace period for the new token to be distributed. , I see. You are right. For running applications, RM is requesting for new hdfs token if the token is about to expire. , Updated the patch for removing token from allTokens map., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12724365/0001-YARN-3472.patch
  against trunk revision af9d4fe.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.TestHDFSTrash

                                      The following test timeouts occurred in hadoop-hdfs-project/hadoop-hdfs:

org.apache.hadoop.hdfs.server.datanode.TestDataNodeExit

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/7288//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/7288//console

This message is automatically generated., Test failures are unrelated to patch.. Am able to run both the tests in eclipse., [~rohithsharma], thanks for the patch. Could you add a test case?

In TestDelegationTokenRenwer#testReplaceExpiringDelegationToken, after this check {code}// wait for the initial expiring hdfs token to be removed. {code}, we can add a simple check that the token is removed from allTokens., IIUC the test method {{TestDelegationTokenRenwer#testReplaceExpiringDelegationToken}} , there is already check for token1 from allTokens should be removed. Otherwise the waitFor method throw TimeoutException.
{code}
    // wait for the initial expiring hdfs token to be removed.
    GenericTestUtils.waitFor(new Supplier<Boolean>() {
      public Boolean get() {
        return !rm.getRMContext().getDelegationTokenRenewer()
          .getDelegationTokens().contains(token1);
      }
    }, 1000, 20000);
{code}
But I am surprised why the test were not failing earlier? Am I missing something? 

I was chekcing earlier jenkins result and observed that  jenkins has run only HDFS tests but not RM package tests eventhough RM package tests has changed. , bq. But I am surprised why the test were not failing earlier? Am I missing something? 
Ignore this, I was referring appTokens instead of allTokens, Updated the patch adding test, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12724921/0002-YARN-3472.patch
  against trunk revision f8f5887.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager:

                  org.apache.hadoop.yarn.server.resourcemanager.applicationsmanager.TestAMRestart
                  org.apache.hadoop.yarn.server.resourcemanager.TestRMRestart

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/7314//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/7314//console

This message is automatically generated., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12724921/0002-YARN-3472.patch
  against trunk revision 174d8b3.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager:

                  org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.TestAllocationFileLoaderService

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/7317//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/7317//console

This message is automatically generated., +1, Committed to trunk and branch-2,  thanks Rohith !, FAILURE: Integrated in Hadoop-trunk-Commit #7577 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/7577/])
YARN-3472. Fixed possible leak in DelegationTokenRenewer#allTokens. Contributed by Rohith Sharmaks (jianhe: rev a1afbc48b53f6bdbd30dc8eb56a7621d49c5d6db)
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/security/TestDelegationTokenRenewer.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/security/DelegationTokenRenewer.java
, FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #163 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/163/])
YARN-3472. Fixed possible leak in DelegationTokenRenewer#allTokens. Contributed by Rohith Sharmaks (jianhe: rev a1afbc48b53f6bdbd30dc8eb56a7621d49c5d6db)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/security/DelegationTokenRenewer.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/security/TestDelegationTokenRenewer.java
* hadoop-yarn-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Hdfs-trunk #2095 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2095/])
YARN-3472. Fixed possible leak in DelegationTokenRenewer#allTokens. Contributed by Rohith Sharmaks (jianhe: rev a1afbc48b53f6bdbd30dc8eb56a7621d49c5d6db)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/security/TestDelegationTokenRenewer.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/security/DelegationTokenRenewer.java
, FAILURE: Integrated in Hadoop-Yarn-trunk #897 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/897/])
YARN-3472. Fixed possible leak in DelegationTokenRenewer#allTokens. Contributed by Rohith Sharmaks (jianhe: rev a1afbc48b53f6bdbd30dc8eb56a7621d49c5d6db)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/security/DelegationTokenRenewer.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/security/TestDelegationTokenRenewer.java
* hadoop-yarn-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #154 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/154/])
YARN-3472. Fixed possible leak in DelegationTokenRenewer#allTokens. Contributed by Rohith Sharmaks (jianhe: rev a1afbc48b53f6bdbd30dc8eb56a7621d49c5d6db)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/security/TestDelegationTokenRenewer.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/security/DelegationTokenRenewer.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #164 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/164/])
YARN-3472. Fixed possible leak in DelegationTokenRenewer#allTokens. Contributed by Rohith Sharmaks (jianhe: rev a1afbc48b53f6bdbd30dc8eb56a7621d49c5d6db)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/security/TestDelegationTokenRenewer.java
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/security/DelegationTokenRenewer.java
* hadoop-yarn-project/CHANGES.txt
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk #2113 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2113/])
YARN-3472. Fixed possible leak in DelegationTokenRenewer#allTokens. Contributed by Rohith Sharmaks (jianhe: rev a1afbc48b53f6bdbd30dc8eb56a7621d49c5d6db)
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/main/java/org/apache/hadoop/yarn/server/resourcemanager/security/DelegationTokenRenewer.java
* hadoop-yarn-project/CHANGES.txt
* hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager/src/test/java/org/apache/hadoop/yarn/server/resourcemanager/security/TestDelegationTokenRenewer.java
, This seems like an important fix. I merged this into branch-2.7., FAILURE: Integrated in Hadoop-trunk-Commit #7673 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/7673/])
Moving YARN-3351, YARN-3382, YARN-3472, MAPREDUCE-6238 to the 2.7.1 CHANGES.txt (vinodkv: rev 2f82ae042a6f3110742aaa57c076bb9ebd7888d1)
* hadoop-mapreduce-project/CHANGES.txt
* hadoop-yarn-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #174 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/174/])
Moving YARN-3351, YARN-3382, YARN-3472, MAPREDUCE-6238 to the 2.7.1 CHANGES.txt (vinodkv: rev 2f82ae042a6f3110742aaa57c076bb9ebd7888d1)
* hadoop-mapreduce-project/CHANGES.txt
* hadoop-yarn-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Yarn-trunk #908 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/908/])
Moving YARN-3351, YARN-3382, YARN-3472, MAPREDUCE-6238 to the 2.7.1 CHANGES.txt (vinodkv: rev 2f82ae042a6f3110742aaa57c076bb9ebd7888d1)
* hadoop-yarn-project/CHANGES.txt
* hadoop-mapreduce-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Hdfs-trunk #2106 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2106/])
Moving YARN-3351, YARN-3382, YARN-3472, MAPREDUCE-6238 to the 2.7.1 CHANGES.txt (vinodkv: rev 2f82ae042a6f3110742aaa57c076bb9ebd7888d1)
* hadoop-yarn-project/CHANGES.txt
* hadoop-mapreduce-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #165 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/165/])
Moving YARN-3351, YARN-3382, YARN-3472, MAPREDUCE-6238 to the 2.7.1 CHANGES.txt (vinodkv: rev 2f82ae042a6f3110742aaa57c076bb9ebd7888d1)
* hadoop-yarn-project/CHANGES.txt
* hadoop-mapreduce-project/CHANGES.txt
, FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #175 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/175/])
Moving YARN-3351, YARN-3382, YARN-3472, MAPREDUCE-6238 to the 2.7.1 CHANGES.txt (vinodkv: rev 2f82ae042a6f3110742aaa57c076bb9ebd7888d1)
* hadoop-yarn-project/CHANGES.txt
* hadoop-mapreduce-project/CHANGES.txt
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk #2124 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2124/])
Moving YARN-3351, YARN-3382, YARN-3472, MAPREDUCE-6238 to the 2.7.1 CHANGES.txt (vinodkv: rev 2f82ae042a6f3110742aaa57c076bb9ebd7888d1)
* hadoop-mapreduce-project/CHANGES.txt
* hadoop-yarn-project/CHANGES.txt
]