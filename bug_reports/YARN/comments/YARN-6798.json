[[~kkaranasos], [~subru], [~botong], [~asuresh].  It looks like you guys bumped the NM version twice.  Is this behavior desirable or is it preferable to have more compatible state store versions (i.e. 1.0 -> 1.1 -> 1.2 instead of 1.0 -> 2.0 -> 3.0).

Plus, anyone else who has thoughts about NM rolling upgrade, please chime in., I don't know the full story behind these various version bumps, but we need to stop the habit of bumping the major version in the state store without providing a migration path for older versions.

If we really need to bump the state store major version to support a new feature, my preference would be to do this in a lazy fashion as much as possible, i.e.: the major version should not be updated in the state store until the new feature is enabled/used.  That way we don't lose the ability to rollback the release to the old version if something goes terribly wrong after the upgrade before the new feature is used.  If that's not possible for some reason then the code needs to recognize the older state store versions on startup and either do a one-time pass over the data on startup to migrate it to the new schema or otherwise deal with it on the fly during reading for recovery., I agree with Jason.

To move forward, I suggest we follow YARN-6703 and rollback the version to 1.2 perhaps - since AFAIK, we are just introducing new container states (and the features that need the new states are available only in the new releases) in case of YARN-5049 and the AMRMProxy state, in case of YARN-6127, which is completely new.
, v1 patch uploaded that roll back version to 1.1, with added notes. What do you guys think? , | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 15s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
|| || || || {color:brown} trunk Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 14m 17s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 31s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 19s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 33s{color} | {color:green} trunk passed {color} |
| {color:red}-1{color} | {color:red} findbugs {color} | {color:red}  0m 50s{color} | {color:red} hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager in trunk has 5 extant Findbugs warnings. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 18s{color} | {color:green} trunk passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 27s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 28s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 28s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 16s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 27s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  0m 52s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 19s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:red}-1{color} | {color:red} unit {color} | {color:red} 12m 53s{color} | {color:red} hadoop-yarn-server-nodemanager in the patch failed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 17s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 34m 18s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| Failed junit tests | hadoop.yarn.server.nodemanager.containermanager.logaggregation.TestLogAggregationService |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:14b5c93 |
| JIRA Issue | YARN-6798 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12876737/YARN-6798.v1.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux be6b0927285c 3.13.0-116-generic #163-Ubuntu SMP Fri Mar 31 14:13:22 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / d670c3a |
| Default Java | 1.8.0_131 |
| findbugs | v3.1.0-RC1 |
| findbugs | https://builds.apache.org/job/PreCommit-YARN-Build/16375/artifact/patchprocess/branch-findbugs-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-nodemanager-warnings.html |
| unit | https://builds.apache.org/job/PreCommit-YARN-Build/16375/artifact/patchprocess/patch-unit-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-nodemanager.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/16375/testReport/ |
| modules | C: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager U: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/16375/console |
| Powered by | Apache Yetus 0.6.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, The failed unit test looks like YARN-5857.

I'm okay with this update as it is.  This will be incompatible the previous alphas and anyone running directly from branch-2 builds.  Does anyone have any problems with that?
, Yeah, I guess we need to decide to go with 1.1 or 2.1. , IMHO we should only need to bump the major version if any of the following are true:
* Older NM software will explode when it tries to recover the state store
* Older NM software fails to do something crucial during recovery due to ignoring something in the state store

otherwise we can keep the major version the same and simply bump the minor version.  It looks like the two features added to the state store in a way where we can remain on 1.x, but I haven't dug into it deeply to be sure.  

bq. This will be incompatible the previous alphas and anyone running directly from branch-2 builds.
True, but that's the risk of running on unreleased software (as is the case with branch-2).  Anyone could check in something that isn't backwards-compatible that needs to be subsequently fixed, and that could break users who happened to deploy in-between.  AFAIK we don't make any commitments to compatibility except for official Apache Hadoop releases.

I would argue the same applies to alpha releases.  The whole point of calling it alpha is to convey that APIs may be unstable and could disappear or change in an incompatible way in the next release.  It will be annoying to users who expect to do a rolling upgrade from 3.0-alphaX, but given the "alpha" tag I would not expect anyone to have deployed this in a production environment such that they cannot live with a downtime when upgrading to a subsequent release.

It would be helpful to have a release note that calls out the incompatibility with 3.0-alpha releases and that users who are upgrading from one of those releases will need to erase the NM state store on each node before upgrading., {quote}
It would be helpful to have a release note that calls out the incompatibility with 3.0-alpha releases and that users who are upgrading from one of those releases will need to erase the NM state store on each node before upgrading.
{quote}

Agreed.  I intend to modify the release notes for this JIRA and the previous two to make this versioning issue clear.
, Finally got a bit of time to look at the previous patches.  I see a minor issue.

|| Patch || LevelDBKey(s) || Hadoop Versions || Commit Date ||
| YARN-5049 | queued | 3.0.0-alpha1 | May 11, 2016 |
| YARN-6127 | AMRMProxy/NextMasterKey | (2.9.0, 3.0.0-alpha4) | June 22, 2017 |

So, branch-2 has just YARN-6127, while trunk has YARN-5049 and YARN-6127.  If we label YARN-5049 as 1.1 and YARN-6127 as 1.2, then branch-2's having a 1.2 version won't quite be accurate.  If do the reverse, we'd be chronologically backward (which seems okay to me, but I'd like a second opinion).
, I had rolled back YARN-5049 from branch-2 precisely because of the major version bump. Will cherry-pick and update it today with a minor version bump. You can mark this, Thanks [~asuresh].  That's what I get for relying on JIRA and forgetting to check git., [~rchiang], I've committed YARN-5049 to branch-2 (cherry-picked and set version the version to 1.2), Thanks [~asuresh]!  [~botong], it looks like we'll use 1.2 as our current version., Updating the version table:

|| Patch || LevelDBKey(s) || Hadoop Versions || Commit Date || NM LevelDB Version ||
| YARN-5049 | queued | (2.9.0, 3.0.0-alpha1) | May 11, 2016 | 1.2 |
| YARN-6127 | AMRMProxy/NextMasterKey | (2.9.0, 3.0.0-alpha4) | June 22, 2017 | 1.1 |, Sounds good, thx!, Updated Botong's patch with the newer version organization., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 11s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
|| || || || {color:brown} trunk Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 12m 41s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 28s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 18s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 26s{color} | {color:green} trunk passed {color} |
| {color:red}-1{color} | {color:red} findbugs {color} | {color:red}  0m 41s{color} | {color:red} hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager in trunk has 5 extant Findbugs warnings. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 18s{color} | {color:green} trunk passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 22s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 25s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 25s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 14s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 23s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  0m 44s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 14s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:green}+1{color} | {color:green} unit {color} | {color:green} 12m 53s{color} | {color:green} hadoop-yarn-server-nodemanager in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 17s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 31m 53s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:14b5c93 |
| JIRA Issue | YARN-6798 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12877635/YARN-6798.v2.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux 1a3c587bbb28 4.4.0-43-generic #63-Ubuntu SMP Wed Oct 12 13:48:03 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / b0e78ae |
| Default Java | 1.8.0_131 |
| findbugs | v3.1.0-RC1 |
| findbugs | https://builds.apache.org/job/PreCommit-YARN-Build/16468/artifact/patchprocess/branch-findbugs-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-nodemanager-warnings.html |
|  Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/16468/testReport/ |
| modules | C: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager U: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager |
| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/16468/console |
| Powered by | Apache Yetus 0.6.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, +1

I'm going to commit this tomorrow unless I hear otherwise., Committed to trunk.

Thanks [~botong] for the contribution!  Thanks [~jlowe] and [~asuresh] for the comments!, Thanks [~rchiang]!, Backported this to branch-2 based on [~kasha]'s feedback [here|https://issues.apache.org/jira/browse/YARN-6127?focusedCommentId=16136099] on YARN-6127., Nit pick on the patch: the second line says {{1.2 to 1.2}}. The intention was likely {{1.1 to 1.2}}? , Thanks [~kasha] for catching it. I've created YARN-7074 to fix the typo. ]