[Was this truly running trunk as the Affected Versions field indicates or was this some other version of Hadoop?  Also was this a work-preserving NM restart scenario (i.e.: yarn.nodemanager.recovery.enabled=true) or a typical NM startup?, [~jlowe] Sorry i mentioned the wrong Affected Version. Its branch 2. Work-preserving NM is not enabled, its just plain restart, Ah, then this seems like a case where a client (likely an AM) is connecting to the NM before the NM has finished registering with the RM to get the secret keys.  Trying to block new container requests at the app level probably isn't going to work in practice because the SASL layer in RPC doesn't let the connection get to the point where the app can try to reject the request.

IMHO we should remove the "blocking client requests" code and instead do a delayed server start, sorta like the delay added by YARN-1337 when NM recovery is enabled.  Ideally the RPC layer would support the ability to bind to a server socket but not start accepting requests until later.  That would allow us to register with the RM knowing what our client port is but without trying to let clients through that port until we're really ready.

Shorter term fix might be to have the secret manager throw an exception that can be retried by clients if the master key isn't set yet.]