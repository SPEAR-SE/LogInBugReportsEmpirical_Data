[Attaching trivial patch.., This looks closely related to YARN-5630, although the patch in YARN-5630 doesn't adjust the schema version when the version key needs to be written.  Maybe it needs to do so?, Took a look at the patch. It's removing any support for storing a version key at all for containers rather than conditionally storing it.  Won't that break recovery for containers that have been increased or decreased after they've been started?, Aah... did not notice you had posted a patch for this already.. Thanks!!
will mark this as duplicate.., I think we would need to update the schema version too... In that case, we would have change {{checkVersion}} to not store the dbversion immediately. And move that to inside the new API (storeContainerResourceChange etc), We are still storing the version in the {{storeContinerResourceChange}} method... so if containers have been increased or decreased after they've started, it would be taken care of (but NM rollback wont work), Marking this as duplicate of YARN-5630.
YARN-5630 also handles the case where the AM requests and receives an increased Resource Container BEFORE starting the version 0 Container in the NM.]