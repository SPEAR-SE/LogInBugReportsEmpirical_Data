{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12702152","self":"https://issues.apache.org/jira/rest/api/2/issue/12702152","key":"YARN-1847","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":"2014-03-18T14:25:50.558+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Mar 18 20:55:08 UTC 2014","customfield_12310420":"380492","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_24909742_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-03-18T20:55:17.250+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-1847/watchers","watchCount":3,"isWatching":false},"created":"2014-03-18T14:00:07.545+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325256","id":"12325256","description":"2.3.0 release","name":"2.3.0","archived":false,"released":true,"releaseDate":"2014-02-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-18T20:55:17.280+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12319322","id":"12319322","name":"resourcemanager"}],"timeoriginalestimate":null,"description":"The _RMAppAttemptImpl_ creates an instance of ExpiredTransition which always sets the _finalAttemptState_ to FAILED.\n{code}\nprivate static final ExpiredTransition EXPIRED_TRANSITION =\n      new ExpiredTransition();\n. . .\n    public ExpiredTransition() {\n      super(RMAppAttemptState.FAILED);\n    }\n{code}\nSo, when my container successfully finishes regardless of the state (e.g., CONTAINER_FINISHED in my case), the _RMAppAttemptImpl.transition(..)_ does a switch on the _finalAttemptState_ and transitions to FAILED no matter what.\nHere is the related logs for more info:\n{code}\n21:06:01,615  INFO AsyncDispatcher event handler container.Container:878 - Container container_1395104684413_0001_01_000001 transitioned from RUNNING to EXITED_WITH_SUCCESS\n21:06:01,615  INFO AsyncDispatcher event handler launcher.ContainerLaunch:341 - Cleaning up container container_1395104684413_0001_01_000001\n21:06:01,644  INFO DeletionService #0 nodemanager.DefaultContainerExecutor:369 - Deleting absolute path : /Users/oleg/HADOOP_DEV/yarn-tutorial/target/oz.hadoop.StandAloneWithMiniYarnCluster/oz.hadoop.StandAloneWithMiniYarnCluster-localDir-nm-0_0/usercache/oleg/appcache/application_1395104684413_0001/container_1395104684413_0001_01_000001\n21:06:01,646  INFO AsyncDispatcher event handler nodemanager.NMAuditLogger:89 - USER=oleg\tOPERATION=Container Finished - Succeeded\tTARGET=ContainerImpl\tRESULT=SUCCESS\tAPPID=application_1395104684413_0001\tCONTAINERID=container_1395104684413_0001_01_000001\n21:06:01,649  INFO AsyncDispatcher event handler container.Container:878 - Container container_1395104684413_0001_01_000001 transitioned from EXITED_WITH_SUCCESS to DONE\n21:06:01,649  INFO AsyncDispatcher event handler application.Application:339 - Removing container_1395104684413_0001_01_000001 from application application_1395104684413_0001\n21:06:01,649  INFO AsyncDispatcher event handler monitor.ContainersMonitorImpl:159 - ResourceCalculatorPlugin is unavailable on this system. org.apache.hadoop.yarn.server.nodemanager.containermanager.monitor.ContainersMonitorImpl is disabled.\n21:06:01,649  INFO AsyncDispatcher event handler containermanager.AuxServices:175 - Got event CONTAINER_STOP for appId application_1395104684413_0001\n21:06:02,143  INFO Node Status Updater nodemanager.NodeStatusUpdaterImpl:374 - Removed completed container container_1395104684413_0001_01_000001\n21:06:02,146  INFO ResourceManager Event Processor rmcontainer.RMContainerImpl:220 - container_1395104684413_0001_01_000001 Container Transitioned from ACQUIRED to COMPLETED\n21:06:02,146  INFO ResourceManager Event Processor fica.FiCaSchedulerApp:91 - Completed container: container_1395104684413_0001_01_000001 in state: COMPLETED event:FINISHED\n21:06:02,146  INFO ResourceManager Event Processor resourcemanager.RMAuditLogger:98 - USER=oleg\tOPERATION=AM Released Container\tTARGET=SchedulerApp\tRESULT=SUCCESS\tAPPID=application_1395104684413_0001\tCONTAINERID=container_1395104684413_0001_01_000001\n21:06:02,146  INFO ResourceManager Event Processor fica.FiCaSchedulerNode:164 - Released container container_1395104684413_0001_01_000001 of capacity <memory:1024, vCores:1> on host 192.168.19.1:50787, which currently has 0 containers, <memory:0, vCores:0> used and <memory:4096, vCores:8> available, release resources=true\n21:06:02,146  INFO ResourceManager Event Processor fifo.FifoScheduler:790 - Application appattempt_1395104684413_0001_000001 released container container_1395104684413_0001_01_000001 on node: host: 192.168.19.1:50787 #containers=0 available=4096 used=0 with event: FINISHED\n21:06:02,146  INFO AsyncDispatcher event handler attempt.RMAppAttemptImpl:960 - Updating application attempt appattempt_1395104684413_0001_000001 with final state: FAILED\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"380773","customfield_12312823":null,"summary":"YARN application always exits with FAILED state","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozhurakousky","name":"ozhurakousky","key":"ozhurakousky","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Oleg Zhurakousky","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozhurakousky","name":"ozhurakousky","key":"ozhurakousky","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Oleg Zhurakousky","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12702152/comment/13939271","id":"13939271","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"The expired transition occurs when the application expires, i.e.: is misbehaving and not responding properly with heartbeats.  Are you sure the application is expiring?  If it is then we should see something like a \"Timed out after ## secs\" message in the RM log.  I don't see that in the above log or other evidence that indicates it is expiring, but maybe that occurred earlier in the RM log.\n\nSimilarly I don't see any evidence of the AM unregistering from the RM.  That may have occurred earlier in the RM log than what is shown above, but if it did not then that would explain why the application is marked as failed.  An AM container can exit with a success code for its container, but if it fails to unregister first then the container exit code is irrelevant.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2014-03-18T14:25:50.558+0000","updated":"2014-03-18T14:25:50.558+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12702152/comment/13939294","id":"13939294","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozhurakousky","name":"ozhurakousky","key":"ozhurakousky","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Oleg Zhurakousky","active":true,"timeZone":"America/New_York"},"body":"No, its not expiring. its finishing with CONTAINER_FINISHED event and that is when this transition to FAILED occurs.\nYou can easily reproduce it by modifying one of the existing tests:\n_TestAMRMClient_ – just change command from \"sleep 100' to \"ls -a\" and you'll see the same SUCCESS turning into FAILURE ;)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozhurakousky","name":"ozhurakousky","key":"ozhurakousky","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Oleg Zhurakousky","active":true,"timeZone":"America/New_York"},"created":"2014-03-18T14:44:08.457+0000","updated":"2014-03-18T14:44:08.457+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12702152/comment/13939348","id":"13939348","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"bq. No, its not expiring.\n\nIf it's not expiring, then how is ExpiredTransition entering the picture?  According to the state machine setup, it should only be executing this when the EXPIRE event arrives, and it should only be sending that when it logs the timeout message I indicated earlier.  My apologies if I'm missing something.\n\nAs for TestAMRMClient, \"sleep\" or \"ls\" will make terrible ApplicationMasters since they will neither register nor unregister, and that should never result in a successful application run.  The only reason this test works with \"sleep\" as the AM is because the test relies on the fact that the command launched won't exit before it can emulate the registration/unregistration in the various test cases directly.  By changing the \"sleep\" to \"ls\" the command finishes so quickly that the test method doesn't get a chance to try to emulate a proper AM by registering -- the container is gone too soon.  If you add a testcase that simply waits for the application to complete on its own rather than trying to emulate an AM then you'll find that even sleep, like ls, will always result in failure.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2014-03-18T15:03:33.066+0000","updated":"2014-03-18T15:03:33.066+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12702152/comment/13939562","id":"13939562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozhurakousky","name":"ozhurakousky","key":"ozhurakousky","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Oleg Zhurakousky","active":true,"timeZone":"America/New_York"},"body":"Got it, thanks.\n\nAgain, the real issue is the API which does not help at all. If I could submit any command then I should expect the lifecycle to be handled by the framework. That didn't happen and once again steered me in the wrong direction. Would be much nicer if there was a strategy with default implementation of lifecycle methods while exposing an override. This way even an arbitrary command emulating AM would be managed.\nAnyway, I'll try to compile a more comprehensive feedback, but at the moment I got everything running in both local mini cluster and real cluster and while I still believe its an issue, feel free to change it to feature, enhancement or . . .\nCertainly seems to be far more complex then it really has to be.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ozhurakousky","name":"ozhurakousky","key":"ozhurakousky","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Oleg Zhurakousky","active":true,"timeZone":"America/New_York"},"created":"2014-03-18T18:06:52.729+0000","updated":"2014-03-18T18:06:52.729+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12702152/comment/13939772","id":"13939772","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"bq. Again, the real issue is the API which does not help at all. If I could submit any command then I should expect the lifecycle to be handled by the framework.\n\nWhile the ApplicationSubmissionContext allows an free-form command to be listed to run as the AM, that doesn't mean that just any command listed there will work.  YARN is not a distributed shell capable of running arbitrary shell commands as applications.  (The DistributedShell example application in YARN is closer to this.)   Each application must provide an ApplicationMaster that properly communicates with the RM via the ApplicationMasterProtocol in order to participate within a YARN cluster.\n\nI'm sorry that you expected arbitrary shell commands to work in an ApplicationSubmissionContext, and the TestAMRMClient code is a terrible example of a proper YARN application.  Indeed, it doesn't even run properly without \"help\" from the test methods to emulate what a real AM must do.\n\nResolving this as Invalid since YARN applications do not always exit as FAILED and applications are not normally going through ExpiredTransition within the RM.  If you have followup concrete suggestions for how to make the AM-RM API better beyond what the AMRMClient abstraction already does that would be great.  Feel free to discuss them on the [yarn-dev@|http://hadoop.apache.org/mailing_lists.html#Developers-N10174] list or under a separate JIRA.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2014-03-18T20:55:08.277+0000","updated":"2014-03-18T20:55:08.277+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-1847/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1tk3r:"}}