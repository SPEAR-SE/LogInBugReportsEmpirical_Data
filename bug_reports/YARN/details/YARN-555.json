{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12641337","self":"https://issues.apache.org/jira/rest/api/2/issue/12641337","key":"YARN-555","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2013-04-08T18:08:09.812+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Apr 08 18:11:45 UTC 2013","customfield_12310420":"321753","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_35209051_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-04-08T18:11:45.858+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-555/watchers","watchCount":3,"isWatching":false},"created":"2013-04-08T08:24:56.851+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323272","id":"12323272","description":"2.0.3-alpha release","name":"2.0.3-alpha","archived":false,"released":true,"releaseDate":"2013-02-14"}],"issuelinks":[{"id":"12366997","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12366997","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12637803","key":"YARN-489","self":"https://issues.apache.org/jira/rest/api/2/issue/12637803","fields":{"summary":"Setter of xxxxPBImpl doesn't really set the collection, but append its items to an existing collection","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-04-08T23:02:57.609+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12319416","id":"12319416","name":"api"}],"timeoriginalestimate":null,"description":"If you look at the API of ContainerLaunchContext, its got setter methods, such as for setResource, setCommands, etcâ€¦:\n\nhttp://hadoop.apache.org/docs/current/api/org/apache/hadoop/yarn/api/records/ContainerLaunchContext.html#setCommands(java.util.List)\n\nHowever, there's certain things broken in its use here that am trying to understand. Let me explain with some code context:\n\n1. I initialize a proper CLC for an ApplicationSubmissionContext (appContext).\n\n{code}\nContainerLaunchContext appMasterLaunchContext = Records.newRecord(ContainerLaunchContext.class);\nappContext.setAMContainerSpec(appMasterLaunchContext);\n{code}\n\n2. I create a resource request of 130 MB, as applicationMasterResource, and try to set it into the CLC via:\n\n{code}\nappContext.getAMContainerSpec().setResource(applicationMasterResource);\n{code}\n\n3. This works OK. If I query it back now, it returns 130 for a {{getMemory()}} call.\n\n4. So I attempt to do the same with setCommands/setEnvironment/etc., all of which fail to mutate cause the check in CLC's implementation class disregards whatever I try to set for some reason.\n\nEdit: It seems like the issue is that when I do a appContext.getAMContainerSpec().getLocalResources() or similar call to get existing initialized data structures to populate further on, what I really get underneath is a silently non-mutative data structure that I can call .put or .add on, but it won't really reflect it.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"322098","customfield_12312823":null,"summary":"ContainerLaunchContext is buggy when it comes to setter methods on a new instance","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12641337/comment/13625236","id":"13625236","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"body":"If I do:\n\n{code}\nMap<String, LocalResource> localResources = new HashMap<String, LocalResource>();\nlocalResources.put(\"node-ring-app-master.jar\", appMasterJarResource);\nappContext.getAMContainerSpec().setLocalResources(localResources);\n{code}\n\nThings work fine.\n\nIf I instead do the more \"extending\" form:\n\n{code}\nMap<String, LocalResource> localResources = appContext.getAMContainerSpec().getLocalResources();\nlocalResources.put(\"node-ring-app-master.jar\", appMasterJarResource);\nappContext.getAMContainerSpec().setLocalResources(localResources);\n{code}\n\nThen the mutations don't stick.\n\nWonder if this is somehow a Java oddity?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"created":"2013-04-08T08:53:04.045+0000","updated":"2013-04-08T08:53:04.045+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12641337/comment/13625613","id":"13625613","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zjshen","name":"zjshen","key":"zjshen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Zhijie Shen","active":true,"timeZone":"America/Los_Angeles"},"body":"Check the code in ContainerLaunchContextPBImpl:\n\n{code}\n  @Override\n  public Map<String, LocalResource> getLocalResources() {\n    initLocalResources();\n    return this.localResources;\n  }\n\n  private void initLocalResources() {\n    if (this.localResources != null) {\n      return;\n    }\n    ContainerLaunchContextProtoOrBuilder p = viaProto ? proto : builder;\n    List<StringLocalResourceMapProto> list = p.getLocalResourcesList();\n    this.localResources = new HashMap<String, LocalResource>();\n\n    for (StringLocalResourceMapProto c : list) {\n      this.localResources.put(c.getKey(), convertFromProtoFormat(c.getValue()));\n    }\n  }\n  \n  @Override\n  public void setLocalResources(\n      final Map<String, LocalResource> localResources) {\n    if (localResources == null)\n      return;\n    initLocalResources();\n    this.localResources.clear();\n    this.localResources.putAll(localResources);\n  }\n{code}\n\nIn your second case, localResources is the same object of appContext.getAMContainerSpec().localResources. When setLocalResources is called, the instance is cleaned up first, and then appends itself, which already contains no items.\n\nThe buggy part is that setters don't really set the collections but append them to the existing ones. It's not the only problem with ContainerLaunchContextPBImpl, but with all XXXXPBImpls that set collections (see YARN-489). A special issue with ContainerLaunchContextPBImpl is that appending will be done after cleaning up.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zjshen","name":"zjshen","key":"zjshen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Zhijie Shen","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-04-08T18:08:09.812+0000","updated":"2013-04-08T18:08:09.812+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12641337/comment/13625616","id":"13625616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks! I've resolved this as a dupe of YARN-489, which covers this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"created":"2013-04-08T18:11:45.878+0000","updated":"2013-04-08T18:11:45.878+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-555/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1jijb:"}}