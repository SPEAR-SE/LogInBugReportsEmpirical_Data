{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12771100","self":"https://issues.apache.org/jira/rest/api/2/issue/12771100","key":"YARN-3112","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-01-29T20:47:24.950+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Dec 14 17:20:40 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-3112/watchers","watchCount":11,"isWatching":false},"created":"2015-01-29T19:44:58.241+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12327197","id":"12327197","description":"2.6.0 release","name":"2.6.0","archived":false,"released":true,"releaseDate":"2014-11-18"}],"issuelinks":[{"id":"12495950","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12495950","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13030147","key":"MAPREDUCE-6834","self":"https://issues.apache.org/jira/rest/api/2/issue/13030147","fields":{"summary":"MR application fails with \"No NMToken sent\" exception after MRAppMaster recovery","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-03-01T23:56:52.278+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12319414","id":"12319414","name":"applications"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12319322","id":"12319322","name":"resourcemanager"}],"timeoriginalestimate":null,"description":"This error is very similar to YARN-1795, YARN-1839, but i have check the solution of those jira, the patches are already included in my version. I think this error is caused by the different NMTokens between old and new appattempts. New AM has inherited the old tokens from previous AM according to my configuration (keepContainers=true), so the token for new containers are replaced by the old one in the NMTokenCache.\n\n{noformat}\n206 2015-01-29 10:04:49,603 ERROR [ContainerLauncher #0] org.apache.hadoop.mapreduce.v2.app.launcher.ContainerLauncherImpl: Container launch failed for      container_1422546145900_0001_02_000002 : org.apache.hadoop.security.token.SecretManager$InvalidToken: No NMToken sent for ixk02:47625\n 207 ›   at org.apache.hadoop.yarn.client.api.impl.ContainerManagementProtocolProxy$ContainerManagementProtocolProxyData.newProxy(ContainerManagementProt     ocolProxy.java:256)\n 208 ›   at org.apache.hadoop.yarn.client.api.impl.ContainerManagementProtocolProxy$ContainerManagementProtocolProxyData.<init>(ContainerManagementProtoc     olProxy.java:246)\n 209 ›   at org.apache.hadoop.yarn.client.api.impl.ContainerManagementProtocolProxy.getProxy(ContainerManagementProtocolProxy.java:132)\n 210 ›   at org.apache.hadoop.mapreduce.v2.app.launcher.ContainerLauncherImpl.getCMProxy(ContainerLauncherImpl.java:401)\n 211 ›   at org.apache.hadoop.mapreduce.v2.app.launcher.ContainerLauncherImpl$Container.launch(ContainerLauncherImpl.java:138)\n 212 ›   at org.apache.hadoop.mapreduce.v2.app.launcher.ContainerLauncherImpl$EventProcessor.run(ContainerLauncherImpl.java:367)\n 213 ›   at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n 214 ›   at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n 215 ›   at java.lang.Thread.run(Thread.java:722)\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"AM restart and keep containers from previous attempts, then new container launch failed","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xtchenhui","name":"xtchenhui","key":"xtchenhui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jack Chen","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xtchenhui","name":"xtchenhui","key":"xtchenhui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jack Chen","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"in real linux cluster","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12771100/comment/14297625","id":"14297625","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jianhe","name":"jianhe","key":"jianhe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jian He","active":true,"timeZone":"America/Los_Angeles"},"body":"are you running MapReduce? MapReduce doesn't support AM restart with running containers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jianhe","name":"jianhe","key":"jianhe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jian He","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-01-29T20:47:24.950+0000","updated":"2015-01-29T20:47:24.950+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12771100/comment/14297642","id":"14297642","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xtchenhui","name":"xtchenhui","key":"xtchenhui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jack Chen","active":true,"timeZone":"America/Chicago"},"body":"yes, i'm running mapreduce with the am restart.  So AM restart is supported only for other applications except MR? Whether it's feasible to support AM restart in MR?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xtchenhui","name":"xtchenhui","key":"xtchenhui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jack Chen","active":true,"timeZone":"America/Chicago"},"created":"2015-01-29T20:52:18.256+0000","updated":"2015-01-29T20:52:18.256+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12771100/comment/14297651","id":"14297651","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"The MapReduce AM supports recovery of completed tasks upon restart, but it does not support reacquiring active containers.  Doing so would require the tasks to determine the new address of the subsequent AM attempt so the umbilical connection can be re-established.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2015-01-29T20:56:47.369+0000","updated":"2015-01-29T20:56:47.369+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12771100/comment/14297671","id":"14297671","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xtchenhui","name":"xtchenhui","key":"xtchenhui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jack Chen","active":true,"timeZone":"America/Chicago"},"body":"yeah, i'm trying to find a way to change the umbilical connection in the fly. But before i tackle the real problem, this error comes out, which seems the NMToken are missed for the new appattempt. When i disable the function of keepContainers, there is no problem for the am to restart.  maybe there still exist some problem for previous solution? Is there anybody tried that before in a real cluster?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xtchenhui","name":"xtchenhui","key":"xtchenhui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jack Chen","active":true,"timeZone":"America/Chicago"},"created":"2015-01-29T21:05:50.186+0000","updated":"2015-01-29T21:05:50.186+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12771100/comment/14299003","id":"14299003","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xtchenhui","name":"xtchenhui","key":"xtchenhui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jack Chen","active":true,"timeZone":"America/Chicago"},"body":"I have found the cause for this error: the new launched appattempt will transfer the old containers from previous attempts, so the Nodeset in NMTokenSecretManagerInRM.java will be filled. When the new appattempt to get the allocated containers via  pullNewlyAllocatedContainersAndNMTokens(), it will get \"null\" nmToken because of the full Nodeset in createAndGetNMToken(). The Null nmToken will be returned to the ContainerLauncher, so the new container will fail in the launch. What i have done is clear the nodeset in  pullNewlyAllocatedContainersAndNMTokens() before the creation of container and node tokens. \n\n   public synchronized ContainersAndNMTokensAllocation\n  438       pullNewlyAllocatedContainersAndNMTokens() {                                                          \n  439     List<Container> returnContainerList =\n  440         new ArrayList<Container>(newlyAllocatedContainers.size());\n  441     List<NMToken> nmTokens = new ArrayList<NMToken>();\n+ 442     // clear the nodeset for NMTokens\n+ 443     rmContext.getNMTokenSecretManager().clearNodeSetForAttempt(getApplicationAttemptId());\n  444     for (Iterator<RMContainer> i = newlyAllocatedContainers.iterator(); i\n  445       .hasNext();) {\n  446       RMContainer rmContainer = i.next();\n  447       Container container = rmContainer.getContainer();\n  448       try {\n  449         // create container token and NMToken altogether.\n  450         container.setContainerToken(rmContext.getContainerTokenSecretManager()\n  451           .createContainerToken(container.getId(), container.getNodeId(),\n  452             getUser(), container.getResource(), container.getPriority(),\n  453             rmContainer.getCreationTime(), this.logAggregationContext));\n  454         NMToken nmToken =\n  455             rmContext.getNMTokenSecretManager().createAndGetNMToken(getUser(),\n  456               getApplicationAttemptId(), container);\n+ 457         //check whether nmtoken is null\n+ 458         LOG.info(\"[hchen]NMToken for container \"+container.getId()+\" NMToken:\"+nmToken);\n  459         if (nmToken != null) {\n  460           nmTokens.add(nmToken);\n  461         }\n  462       } catch (IllegalArgumentException e) {\n  463         // DNS might be down, skip returning this container.\n  464         LOG.error(\"Error trying to assign container token and NM token to\" +\n  465             \" an allocated container \" + container.getId(), e);\n  466         continue;\n  467       }\n  468       returnContainerList.add(container);\n  469       i.remove();\n  470       rmContainer.handle(new RMContainerEvent(rmContainer.getContainerId(),\n  471         RMContainerEventType.ACQUIRED));\n  472     }\n  473     return new ContainersAndNMTokensAllocation(returnContainerList, nmTokens);\n  474   }","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xtchenhui","name":"xtchenhui","key":"xtchenhui","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jack Chen","active":true,"timeZone":"America/Chicago"},"created":"2015-01-30T18:22:16.629+0000","updated":"2015-01-30T18:22:16.629+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12771100/comment/15748904","id":"15748904","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ysemenov","name":"ysemenov","key":"ysemenov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yevhenii Semenov","active":true,"timeZone":"Europe/Kiev"},"body":"[~xtchenhui],  thanks for you investigation and fix! \n\nI get a similar issue when I kill AM process by {noformat}kill -9 process_id{noformat} and RM recovers it. Not sure that I'm dealing with the same problem (root cause), but your fix helps me too. However, I would like to clarify one important thing. According to the *\"Apache Hadoop YARN: Moving beyond MapReduce and Batch Processing with Apache Hadoop 2\"*: \n\n{quote}\nAs for network optimization, NMTokens are not sent to the ApplicationMasters for each and every allocated container, but only for the first time or if NMTokens have to be invalidated due to the rollover of the underlying master key\n{quote}\n\nIf you clear node set in _\"pullNewlyAllocatedContainersAndNMTokens\"_ then RM generates new tokens for every allocated container. As for me, the fix may cause a regression for network optimization. What do you think about it? \n\nI'm going to investigate the issue too. I will update the Jira if I find something interesting.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ysemenov","name":"ysemenov","key":"ysemenov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yevhenii Semenov","active":true,"timeZone":"Europe/Kiev"},"created":"2016-12-14T17:20:40.149+0000","updated":"2016-12-14T17:20:40.149+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-3112/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i24ywn:"}}