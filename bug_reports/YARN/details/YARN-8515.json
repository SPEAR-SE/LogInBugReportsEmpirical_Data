{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13171270","self":"https://issues.apache.org/jira/rest/api/2/issue/13171270","key":"YARN-8515","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341684","id":"12341684","description":"2.10.0 release","name":"2.10.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342758","id":"12342758","name":"3.2.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342982","id":"12342982","description":"3.1.1 Release","name":"3.1.1","archived":false,"released":true,"releaseDate":"2018-08-07"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343007","id":"12343007","description":"2.9.2 release","name":"2.9.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343060","id":"12343060","description":"2.8.5 release","name":"2.8.5","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343415","id":"12343415","name":"3.0.4","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-07-12T15:35:16.104+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jul 13 15:21:23 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_145323290_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_90452640","customfield_12312321":null,"resolutiondate":"2018-07-13T15:21:23.969+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-8515/watchers","watchCount":6,"isWatching":false},"created":"2018-07-10T21:51:48.099+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["Docker"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-07-13T15:21:24.002+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"When running with docker on large clusters, we have noticed that sometimes docker containers are not removed - they remain in the exited state, and the corresponding container-executor is no longer running.  Upon investigation, we noticed that this always seemed to happen after a nodemanager restart.   The sequence leading to the stranded docker containers is:\r\n # Nodemanager restarts\r\n # Containers are recovered and then run for a while\r\n # Containers are killed for some (legitimate) reason\r\n # Container-executor exits without removing the docker container.\r\n\r\nAfter reproducing this on a test cluster, we found that the container-executor was exiting due to a SIGPIPE.\r\n\r\nWhat is happening is that the shell command executor that is used to start container-executor has threads reading from c-e's stdout and stderr.  When the NM is restarted, these threads are killed.  Then when the container-executor continues executing after the container exits with error, it tries to write to stderr (ERRORFILE) and gets a SIGPIPE.  Since SIGPIPE is not handled, this crashes the container-executor before it can actually remove the docker container.\r\n\r\nWe ran into this in branch 2.8.  The way docker containers are removed has been completely redesigned in trunk, so I don't think it will lead to this exact failure, but after an NM restart, potentially any write to stderr or stdout in the container-executor could cause it to crash.\r\n\r\n ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12931329","id":"12931329","filename":"YARN-8515.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"created":"2018-07-12T14:13:07.966+0000","size":1130,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12931329/YARN-8515.001.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"container-executor can crash with SIGPIPE after nodemanager restart","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171270/comment/16539286","id":"16539286","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"body":"Here is an example case that we saw:\r\nDocker ps info for this container:\r\n{noformat}\r\n968e4a1a0fca 90188f3d752e \"bash /grid/4/tmp/...\" 6 days ago Exited (143) 6 days ago container_e07_1528760012992_2875921_01_000069\r\n{noformat}\r\nNM Log with some added info from Docker container and journalctl to show where the docker container started/exited:\r\n{noformat}\r\n2018-06-27 16:32:48,779 [IPC Server handler 9 on 8041] INFO containermanager.ContainerManagerImpl: Start request for container_e07_1528760012992_2875921_01_000069 by user p_condor\r\n2018-06-27 16:32:48,782 [AsyncDispatcher event handler] INFO application.ApplicationImpl: Adding container_e07_1528760012992_2875921_01_000069 to application application_1528760012992_2875921\r\n2018-06-27 16:32:48,783 [AsyncDispatcher event handler] INFO container.ContainerImpl: Container container_e07_1528760012992_2875921_01_000069 transitioned from NEW to LOCALIZING\r\n2018-06-27 16:32:48,783 [AsyncDispatcher event handler] INFO yarn.YarnShuffleService: Initializing container container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:32:48,786 [AsyncDispatcher event handler] INFO localizer.ResourceLocalizationService: Created localizer for container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:32:48,786 [LocalizerRunner for container_e07_1528760012992_2875921_01_000069] INFO localizer.ResourceLocalizationService: Writing credentials to the nmPrivate file /grid/4/tmp/yarn-local/nmPrivate/container_e07_1528760012992_2875921_01_000069.tokens. Credentials list: \r\n2018-06-27 16:32:52,654 [AsyncDispatcher event handler] INFO container.ContainerImpl: Container container_e07_1528760012992_2875921_01_000069 transitioned from LOCALIZING to LOCALIZED\r\n2018-06-27 16:32:52,684 [AsyncDispatcher event handler] INFO container.ContainerImpl: Container container_e07_1528760012992_2875921_01_000069 transitioned from LOCALIZED to RUNNING\r\n2018-06-27 16:32:52,684 [AsyncDispatcher event handler] INFO monitor.ContainersMonitorImpl: Starting resource-monitoring for container_e07_1528760012992_2875921_01_000069\r\n\r\n2018-06-27 16:32:53.345 Docker container started\r\n\r\n2018-06-27 16:32:54,429 [Container Monitor] DEBUG ContainersMonitorImpl.audit: Memory usage of ProcessTree 103072 for container-id container_e07_1528760012992_2875921_01_000069: 132.5 MB of 3 GB physical memory used; 4.3 GB of 6.3 GB virtual memory used\r\n\r\n2018-06-27 16:33:25,422 [main] INFO nodemanager.NodeManager: STARTUP_MSG: \r\n/************************************************************\r\nSTARTUP_MSG: Starting NodeManager\r\nSTARTUP_MSG: user = mapred\r\nSTARTUP_MSG: host = gsbl607n22.blue.ygrid.yahoo.com/10.213.59.232\r\nSTARTUP_MSG: args = []\r\nSTARTUP_MSG: version = 2.8.3.2.1806111934\r\n\r\n2018-06-27 16:33:31,140 [main] INFO containermanager.ContainerManagerImpl: Recovering container_e07_1528760012992_2875921_01_000069 in state LAUNCHED with exit code -1000\r\n2018-06-27 16:33:31,140 [main] INFO application.ApplicationImpl: Adding container_e07_1528760012992_2875921_01_000069 to application application_1528760012992_2875921\r\n\r\n2018-06-27 16:33:32,771 [main] INFO containermanager.ContainerManagerImpl: Waiting for containers: \r\n2018-06-27 16:33:33,280 [main] INFO containermanager.ContainerManagerImpl: Waiting for containers: \r\n2018-06-27 16:33:33,178 [main] INFO containermanager.ContainerManagerImpl: Waiting for containers:\r\n\r\n2018-06-27 16:33:33,776 [AsyncDispatcher event handler] INFO container.ContainerImpl: Container container_e07_1528760012992_2875921_01_000069 transitioned from NEW to LOCALIZING\r\n2018-06-27 16:33:34,393 [AsyncDispatcher event handler] INFO yarn.YarnShuffleService: Initializing container container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:33:34,433 [AsyncDispatcher event handler] INFO container.ContainerImpl: Container container_e07_1528760012992_2875921_01_000069 transitioned from LOCALIZING to LOCALIZED\r\n2018-06-27 16:33:34,461 [ContainersLauncher #23] INFO nodemanager.ContainerExecutor: Reacquiring container_e07_1528760012992_2875921_01_000069 with pid 103072\r\n2018-06-27 16:33:34,463 [AsyncDispatcher event handler] INFO container.ContainerImpl: Container container_e07_1528760012992_2875921_01_000069 transitioned from LOCALIZED to RUNNING\r\n2018-06-27 16:33:34,482 [AsyncDispatcher event handler] INFO monitor.ContainersMonitorImpl: Starting resource-monitoring for container_e07_1528760012992_2875921_01_000069\r\n\r\n2018-06-27 16:33:35,304 [main] INFO nodemanager.NodeStatusUpdaterImpl: Sending out 598 NM container statuses: \r\n2018-06-27 16:33:35,356 [main] INFO nodemanager.NodeStatusUpdaterImpl: Registering with RM using containers \r\n2018-06-27 16:33:35,902 [Container Monitor] DEBUG ContainersMonitorImpl.audit: Memory usage of ProcessTree 103072 for container-id container_e07_1528760012992_2875921_01_000069: 1.1 GB of 3 GB physical memory used; 4.5 GB of 6.3 GB virtual memory used\r\n2018-06-27 16:34:22,480 [Container Monitor] DEBUG ContainersMonitorImpl.audit: Memory usage of ProcessTree 103072 for container-id container_e07_1528760012992_2875921_01_000069: 1.1 GB of 3 GB physical memory used; 4.5 GB of 6.3 GB virtual memory us\r\n2018-06-27 16:34:25,738 [IPC Server handler 6 on 8041] INFO containermanager.ContainerManagerImpl: Stopping container with container Id: container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:34:25,739 [AsyncDispatcher event handler] INFO container.ContainerImpl: Container container_e07_1528760012992_2875921_01_000069 transitioned from RUNNING to KILLING\r\n2018-06-27 16:34:25,739 [AsyncDispatcher event handler] INFO launcher.ContainerLaunch: Cleaning up container container_e07_1528760012992_2875921_01_000069\r\n\r\n2018-06-27 16:34:26.276 Docker container exited\r\nJun 27 16:34:26 gsbl607n22.blue.ygrid.yahoo.com dockerd-current[17973]: time=\"2018-06-27T16:34:26.275701908Z\" level=error msg=\"containerd: deleting container\" error=\"exit status 1: \\\"container 968e4a1a0fcafa7e01a6ab688a86a86615369b644061e90939f60542\r\nJun 27 16:34:28 gsbl607n22.blue.ygrid.yahoo.com dockerd-current[17973]: time=\"2018-06-27T16:34:28.470794342Z\" level=warning msg=\"968e4a1a0fcafa7e01a6ab688a86a86615369b644061e90939f60542468dcb1b cleanup: failed to unmount secrets: invalid argument\"\r\n\r\n2018-06-27 16:34:26,516 [Container Monitor] DEBUG ContainersMonitorImpl.audit: Memory usage of ProcessTree 103072 for container-id container_e07_1528760012992_2875921_01_000069: -1B of 3 GB physical memory used; -1B of 6.3 GB virtual memory used\r\n2018-06-27 16:34:26,769 [ContainersLauncher #23] INFO nodemanager.ContainerExecutor: container_e07_1528760012992_2875921_01_000069 was deactivated\r\n2018-06-27 16:34:26,870 [AsyncDispatcher event handler] INFO container.ContainerImpl: Container container_e07_1528760012992_2875921_01_000069 transitioned from KILLING to EXITED_WITH_FAILURE\r\n2018-06-27 16:34:26,872 [DeletionService #1] INFO nodemanager.LinuxContainerExecutor: Deleting absolute path : /grid/3/tmp/yarn-local/usercache/p_condor/appcache/application_1528760012992_2875921/container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:34:26,872 [DeletionService #3] INFO nodemanager.LinuxContainerExecutor: Deleting absolute path : /grid/5/tmp/yarn-local/usercache/p_condor/appcache/application_1528760012992_2875921/container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:34:26,872 [DeletionService #0] INFO nodemanager.LinuxContainerExecutor: Deleting absolute path : /grid/2/tmp/yarn-local/usercache/p_condor/appcache/application_1528760012992_2875921/container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:34:26,873 [AsyncDispatcher event handler] INFO container.ContainerImpl: Container container_e07_1528760012992_2875921_01_000069 transitioned from EXITED_WITH_FAILURE to DONE\r\n2018-06-27 16:34:26,873 [AsyncDispatcher event handler] INFO application.ApplicationImpl: Removing container_e07_1528760012992_2875921_01_000069 from application application_1528760012992_2875921\r\n2018-06-27 16:34:26,873 [AsyncDispatcher event handler] INFO monitor.ContainersMonitorImpl: Stopping resource-monitoring for container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:34:26,873 [AsyncDispatcher event handler] INFO logaggregation.AppLogAggregatorImpl: Considering container container_e07_1528760012992_2875921_01_000069 for log-aggregation\r\n2018-06-27 16:34:26,873 [AsyncDispatcher event handler] INFO containermanager.AuxServices: Got event CONTAINER_STOP for appId application_1528760012992_2875921\r\n2018-06-27 16:34:26,873 [AsyncDispatcher event handler] INFO yarn.YarnShuffleService: Stopping container container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:34:26,875 [DeletionService #0] INFO nodemanager.LinuxContainerExecutor: Deleting absolute path : /grid/4/tmp/yarn-local/usercache/p_condor/appcache/application_1528760012992_2875921/container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:34:26,875 [DeletionService #1] INFO nodemanager.LinuxContainerExecutor: Deleting absolute path : /grid/1/tmp/yarn-local/usercache/p_condor/appcache/application_1528760012992_2875921/container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:34:26,876 [AsyncDispatcher event handler] WARN containermanager.ContainerManagerImpl: couldn't find container container_e07_1528760012992_2875921_01_000069 while processing FINISH_CONTAINERS event\r\n2018-06-27 16:34:26,877 [DeletionService #1] INFO nodemanager.LinuxContainerExecutor: Deleting absolute path : /grid/0/tmp/yarn-local/usercache/p_condor/appcache/application_1528760012992_2875921/container_e07_1528760012992_2875921_01_000069\r\n2018-06-27 16:34:30,557 [Node Status Updater] INFO nodemanager.NodeStatusUpdaterImpl: Removed completed containers from NM context: [container_e07_1528760012992_2875921_01_000069]\r\n{noformat}\r\nDocker state info:\r\n{noformat}\r\n \"State\": {\r\n \"Status\": \"exited\",\r\n \"Running\": false,\r\n \"Paused\": false,\r\n \"Restarting\": false,\r\n \"OOMKilled\": false,\r\n \"Dead\": false,\r\n \"Pid\": 0,\r\n \"ExitCode\": 143,\r\n \"Error\": \"\",\r\n \"StartedAt\": \"2018-06-27T16:32:53.345303052Z\",\r\n \"FinishedAt\": \"2018-06-27T16:34:26.276037261Z\"\r\n },\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"created":"2018-07-10T22:12:49.724+0000","updated":"2018-07-10T22:12:49.724+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171270/comment/16539290","id":"16539290","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"body":"I have been able to repro this reliably on a test cluster.\r\nRepro steps are:\r\n# Start sleep job with a lot of mappers sleeping for 50 seconds\r\n# on one worker node, kill NM after a set of containers starts\r\n# restart the NM\r\n# On the gw, kill the application (before the current containers finish)\r\n\r\nThis will leave the containers on the node where the nodemanager was restarted in the exited state.\r\n\r\ncontainer-executor is not cleaning up the docker containers. Here is an strace of one of the container-executors when the application is killed:\r\n{noformat}\r\n-bash-4.2$ sudo strace -s 4096 -f -p 7176\r\nstrace: Process 7176 attached\r\nread(3, \"143\\n\", 4096) = 4\r\nclose(3) = 0\r\nwait4(7566, [\\{WIFEXITED(s) && WEXITSTATUS(s) == 0}], 0, NULL) = 7566\r\n--- SIGCHLD \\{si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=7566, si_uid=0, si_status=0, si_utime=1, si_stime=0} ---\r\nmunmap(0x7f233bfa4000, 4096) = 0\r\nwrite(2, \"Docker container exit code was not zero: 143\\n\", 45) = -1 EPIPE (Broken pipe)\r\n--- SIGPIPE \\{si_signo=SIGPIPE, si_code=SI_USER, si_pid=7176, si_uid=0} ---\r\n+++ killed by SIGPIPE +++\r\n{noformat}\r\n\r\nThe problem is that when container-executor is started by the NM using the priviledged operation executor, it attaches stream readers to stdout and stderr.\r\nWhen we restart the NM, these threads are killed. Then when the application is killed, it kills the running containers and container-executor returns from waiting for the docker container. When it tries to write an error message to stderr, it generates a SIGPIPE signal, because the other end of the pipe has been killed. Since we are not handling that signal, container-executor crashes and we never remove the docker container.\r\n\r\nI have verified that if I change container-executor to ignore SIGPIPE, the problem does not occur.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"created":"2018-07-10T22:16:06.189+0000","updated":"2018-07-10T22:16:06.189+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171270/comment/16541708","id":"16541708","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"body":"Submitted patch for trunk. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"created":"2018-07-12T14:13:51.370+0000","updated":"2018-07-12T14:13:51.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171270/comment/16541824","id":"16541824","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 35s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 27m 38s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m  1s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 37s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 40m 28s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 36s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 56s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} cc {color} | {color:green}  0m 56s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 56s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 34s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  1s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 12m 27s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:red}-1{color} | {color:red} unit {color} | {color:red} 18m  4s{color} | {color:red} hadoop-yarn-server-nodemanager in the patch failed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 23s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black} 74m 30s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:abb62dd |\r\n| JIRA Issue | YARN-8515 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12931329/YARN-8515.001.patch |\r\n| Optional Tests |  asflicense  compile  cc  mvnsite  javac  unit  |\r\n| uname | Linux c76b663d45d3 3.13.0-153-generic #203-Ubuntu SMP Thu Jun 14 08:52:28 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / b37074b |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_171 |\r\n| unit | https://builds.apache.org/job/PreCommit-YARN-Build/21222/artifact/out/patch-unit-hadoop-yarn-project_hadoop-yarn_hadoop-yarn-server_hadoop-yarn-server-nodemanager.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/21222/testReport/ |\r\n| Max. process+thread count | 301 (vs. ulimit of 10000) |\r\n| modules | C: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager U: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager |\r\n| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/21222/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-12T15:35:16.104+0000","updated":"2018-07-12T15:35:16.104+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171270/comment/16541868","id":"16541868","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"body":"The unit test failure is YARN-8518.  Might want to wait for that one to go through before we continue with this one, just to see that test-container-executor succeeds.\r\n\r\nI tested this manually, running several test jobs and restarting the NM while jobs were running.  Because trunk has [~shanekumpf@gmail.com]'s docker life-cycle changes, I don't see the same failure I saw on branch 2.8, but the patch does not introduce any new problems that I can see.\r\n\r\n \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Jim_Brennan","name":"Jim_Brennan","key":"jim_brennan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10440","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10440","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10440","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10440"},"displayName":"Jim Brennan","active":true,"timeZone":"America/Chicago"},"created":"2018-07-12T16:10:02.381+0000","updated":"2018-07-12T16:10:02.381+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171270/comment/16542176","id":"16542176","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Thanks for the patch!\r\n\r\n+1 lgtm.  I'll commit this tomorrow if there are no objections.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2018-07-12T20:32:19.054+0000","updated":"2018-07-12T20:32:19.054+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171270/comment/16543335","id":"16543335","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Thanks, Jim!  I committed this to trunk, branch-3.1, branch-3.0, branch-2, branch-2.9, and branch-2.8.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2018-07-13T15:21:23.991+0000","updated":"2018-07-13T15:21:23.991+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-8515/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3vqun:"}}