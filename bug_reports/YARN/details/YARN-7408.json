{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13112501","self":"https://issues.apache.org/jira/rest/api/2/issue/13112501","key":"YARN-7408","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-10-27T14:41:32.366+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Nov 02 12:58:38 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-7408/watchers","watchCount":3,"isWatching":false},"created":"2017-10-27T07:59:57.742+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-11-02T12:58:38.338+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"if NM can not afford to allocate a large container request, it will be reserved container.\r\nbut, in a cluster with long running apps, it is not often that running containers are released.\r\nin cases like this, reserved containers will be increased as time goes on. as a result, total capacity could be occupied by reserved resources.\r\nit makes other container requests starve.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"total capacity could be occupied by a large container request","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kyungwan+nam","name":"kyungwan nam","key":"kyungwan nam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"kyungwan nam","active":true,"timeZone":"Asia/Seoul"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kyungwan+nam","name":"kyungwan nam","key":"kyungwan nam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"kyungwan nam","active":true,"timeZone":"Asia/Seoul"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13112501/comment/16221953","id":"16221953","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kyungwan+nam","name":"kyungwan nam","key":"kyungwan nam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"kyungwan nam","active":true,"timeZone":"Asia/Seoul"},"body":"Currently, the number of reserved containers for an application is increased proportionally according to how long it starves.\r\nWhat about limiting maximum reserved resource, which an application can take.\r\nDoes this approach make sense? please correct me know if I am wrong.\r\nAny comments or suggestions are welcome.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kyungwan+nam","name":"kyungwan nam","key":"kyungwan nam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"kyungwan nam","active":true,"timeZone":"Asia/Seoul"},"created":"2017-10-27T08:43:35.128+0000","updated":"2017-10-27T08:43:35.128+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13112501/comment/16222472","id":"16222472","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"I assume you are using CapacityScheduler?  The answers may change for FairScheduler as I am not as familiar with how it handles reservations.\r\n\r\nReservations can increase over time as the allocation request remains unsatisfied, but the amount of space that can be reserved is limited by the user and queue limits.  In other words, the user can't reserve the whole cluster unless they are allowed to use the whole cluster normally.\r\n\r\nAs for other container requests, it depends upon where these requests are coming from.  If these are other requests from the same application then the app needs to change the priority of the other requests.  The RM allocates containers in priority order, so it won't consider the other requests until the reservations are satisifed or the request is cancelled.  If the requests are coming from other apps then it could be the priority of the app relative to the other apps.  Apps ahead in the queue will get first crack at resources or we risk indefinite postponement.  Proposals to artificially limit reservations for an app also risk this same indefinite postponement if the scheduler happened to choose poorly where to place the limited number of reservations.  In a cluster with long running containers, this app may not ever run in a timely manner.\r\n\r\nOne way to achieve something close to what you are proposing is to have the problematic app run in a separate queue where you can explicitly cap the resources associated with that app, reserved or otherwise.  The app will only be able to reserve up to the queue's capacity at most.  This should work quite well, assuming the total resources required by the app is less than you are willing to allow it to reserve in its attempt to get containers.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-27T14:41:32.366+0000","updated":"2017-10-27T14:41:32.366+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13112501/comment/16224542","id":"16224542","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kyungwan+nam","name":"kyungwan nam","key":"kyungwan nam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"kyungwan nam","active":true,"timeZone":"Asia/Seoul"},"body":"Hi [~jlowe].\r\nThank you for your comment and suggestion!\r\nI have a question.\r\n\r\n{quote}\r\nProposals to artificially limit reservations for an app also risk this same indefinite postponement if the scheduler happened to choose poorly where to place the limited number of reservations\r\n{quote}\r\n\r\nif reservation-continue-looking is enabled, does it try to allocate on another nodes within the limited number of reservations?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kyungwan+nam","name":"kyungwan nam","key":"kyungwan nam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"kyungwan nam","active":true,"timeZone":"Asia/Seoul"},"created":"2017-10-30T09:21:30.585+0000","updated":"2017-10-30T09:21:30.585+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13112501/comment/16224965","id":"16224965","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Yes.  reservation-continue-looking simply means the scheduler will consider releasing a reservation in order to acquire free resources to satisfy a container request.  It solves this scenario:\r\n# User has hit their user limit in active containers and container reservations\r\n# A new node comes along with enough free space to satisfy an outstanding container request\r\n# Normally the scheduler cannot grant this container because the user is at their user limit\r\n# reservation-continue-looking will consider releasing existing reservations so the user remains within their limit when allocating the container\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-10-30T13:32:39.998+0000","updated":"2017-10-30T13:32:39.998+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13112501/comment/16235682","id":"16235682","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kyungwan+nam","name":"kyungwan nam","key":"kyungwan nam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"kyungwan nam","active":true,"timeZone":"Asia/Seoul"},"body":"Thanks to your comment, I was able to figure out that limiting reservation for an application is risky.\r\nI had another thought about it.\r\n\r\nCurrently, the number of reserved containers increases proportionally depending on how much re-reservation has occurred.\r\nThe smaller the cluster size, the faster the capacity of the queue is occupied. However, there is no way for the user to control this.\r\nall capacity of the queue has been occupied by reserved containers. since then, small container requests from the other user’s apps are delayed until reserved container is allocated. because, capacity-scheduler does not preempt resources from reserved containers within a queue.\r\nIt looks like this will be resolved in YARN-4945. as workaround, I would like to have an option to adjust the rate at which reserved containers grow. it prevent other apps from starvation even if the app requesting a large container is postponed.\r\n\r\nHere is what i thought to achieve it. the following is part of shouldAllocOrReserveNewContainer\r\n{code}\r\n// Use percentage of node required to bias against large containers...\r\n// Protect against corner case where you need the whole node with\r\n// Math.min(nodeFactor, minimumAllocationFactor)\r\nstarvation = \r\n    (int)((application.getReReservations(priority) / (float)reservedContainers) * \r\n          (1.0f - (Math.min(nodeFactor, getMinimumAllocationFactor())))\r\n         );\r\n{code}\r\nafter starvation is calculated, adjust starvation value by \"reservation-factor” which can be set\r\nstarvation = starvation * reservation-factor\r\nthe lower \"reservation-factor\", the slower the rate at which reserved containers grow.\r\n\r\nAny comments are welcome.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kyungwan+nam","name":"kyungwan nam","key":"kyungwan nam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"kyungwan nam","active":true,"timeZone":"Asia/Seoul"},"created":"2017-11-02T12:58:38.338+0000","updated":"2017-11-02T12:58:38.338+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-7408/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3lrzr:"}}