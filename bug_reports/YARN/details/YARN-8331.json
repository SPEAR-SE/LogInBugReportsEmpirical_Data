{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13160624","self":"https://issues.apache.org/jira/rest/api/2/issue/13160624","key":"YARN-8331","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341684","id":"12341684","description":"2.10.0 release","name":"2.10.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342758","id":"12342758","name":"3.2.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343007","id":"12343007","description":"2.9.2 release","name":"2.9.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343415","id":"12343415","name":"3.0.4","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343433","id":"12343433","description":"","name":"3.1.2","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-08-07T16:01:08.372+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 09 15:45:47 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_6778406503_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_1_*:*_170820740","customfield_12312321":null,"resolutiondate":"2018-08-09T15:40:02.456+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-8331/watchers","watchCount":6,"isWatching":false},"created":"2018-05-21T05:19:35.251+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341436","id":"12341436","description":"3.1.0 release","name":"3.1.0","archived":false,"released":true,"releaseDate":"2018-04-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341762","id":"12341762","description":"2.9.1 release","name":"2.9.1","archived":false,"released":true,"releaseDate":"2018-05-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342731","id":"12342731","description":"3.0.2 release","name":"3.0.2","archived":false,"released":true,"releaseDate":"2018-04-21"}],"issuelinks":[{"id":"12540566","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12540566","type":{"id":"12310560","name":"Problem/Incident","inward":"is caused by","outward":"causes","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310560"},"inwardIssue":{"id":"12931339","key":"YARN-4597","self":"https://issues.apache.org/jira/rest/api/2/issue/12931339","fields":{"summary":"Introduce ContainerScheduler and a SCHEDULED state to NodeManager container lifecycle","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21141&avatarType=issuetype","name":"New Feature","subtask":false,"avatarId":21141}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradeepambati","name":"pradeepambati","key":"pradeepambati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Pradeep Ambati","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-08-09T15:45:47.778+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"When a container is launching, in ContainerLaunch#launchContainer, state is SCHEDULED,\r\nkill event was sent to this container, state : SCHEDULED->KILLING->DONE\r\n Then ContainerLaunch send CONTAINER_LAUNCHED event and start the container processes. These absent container processes will not be cleaned up anymore.\r\n\r\nÂ \r\n{code:java}\r\n2018-05-21 13:11:56,114 INFO  [Thread-11] nodemanager.NMAuditLogger (NMAuditLogger.java:logSuccess(94)) - USER=nobody\tOPERATION=Start Container Request\tTARGET=ContainerManageImpl\tRESULT=SUCCESS\tAPPID=application_0_0000\tCONTAINERID=container_0_0000_01_000000\r\n2018-05-21 13:11:56,114 INFO  [NM ContainerManager dispatcher] application.ApplicationImpl (ApplicationImpl.java:handle(632)) - Application application_0_0000 transitioned from NEW to INITING\r\n2018-05-21 13:11:56,114 INFO  [NM ContainerManager dispatcher] application.ApplicationImpl (ApplicationImpl.java:transition(446)) - Adding container_0_0000_01_000000 to application application_0_0000\r\n2018-05-21 13:11:56,118 INFO  [NM ContainerManager dispatcher] application.ApplicationImpl (ApplicationImpl.java:handle(632)) - Application application_0_0000 transitioned from INITING to RUNNING\r\n2018-05-21 13:11:56,119 INFO  [NM ContainerManager dispatcher] container.ContainerImpl (ContainerImpl.java:handle(2111)) - Container container_0_0000_01_000000 transitioned from NEW to SCHEDULED\r\n2018-05-21 13:11:56,119 INFO  [NM ContainerManager dispatcher] containermanager.AuxServices (AuxServices.java:handle(220)) - Got event CONTAINER_INIT for appId application_0_0000\r\n2018-05-21 13:11:56,119 INFO  [NM ContainerManager dispatcher] scheduler.ContainerScheduler (ContainerScheduler.java:startContainer(504)) - Starting container [container_0_0000_01_000000]\r\n2018-05-21 13:11:56,226 INFO  [NM ContainerManager dispatcher] container.ContainerImpl (ContainerImpl.java:handle(2111)) - Container container_0_0000_01_000000 transitioned from SCHEDULED to KILLING\r\n2018-05-21 13:11:56,227 INFO  [NM ContainerManager dispatcher] containermanager.TestContainerManager (BaseContainerManagerTest.java:delete(287)) - Psuedo delete: user - nobody, type - FILE\r\n2018-05-21 13:11:56,227 INFO  [NM ContainerManager dispatcher] nodemanager.NMAuditLogger (NMAuditLogger.java:logSuccess(94)) - USER=nobody\tOPERATION=Container Finished - Killed\tTARGET=ContainerImpl\tRESULT=SUCCESS\tAPPID=application_0_0000\tCONTAINERID=container_0_0000_01_000000\r\n2018-05-21 13:11:56,238 INFO  [NM ContainerManager dispatcher] container.ContainerImpl (ContainerImpl.java:handle(2111)) - Container container_0_0000_01_000000 transitioned from KILLING to DONE\r\n2018-05-21 13:11:56,238 INFO  [NM ContainerManager dispatcher] application.ApplicationImpl (ApplicationImpl.java:transition(489)) - Removing container_0_0000_01_000000 from application application_0_0000\r\n2018-05-21 13:11:56,239 INFO  [NM ContainerManager dispatcher] monitor.ContainersMonitorImpl (ContainersMonitorImpl.java:onStopMonitoringContainer(932)) - Stopping resource-monitoring for container_0_0000_01_000000\r\n2018-05-21 13:11:56,239 INFO  [NM ContainerManager dispatcher] containermanager.AuxServices (AuxServices.java:handle(220)) - Got event CONTAINER_STOP for appId application_0_0000\r\n2018-05-21 13:11:56,274 WARN  [NM ContainerManager dispatcher] container.ContainerImpl (ContainerImpl.java:handle(2106)) - Can't handle this event at current state: Current: [DONE], eventType: [CONTAINER_LAUNCHED], container: [container_0_0000_01_000000]\r\norg.apache.hadoop.yarn.state.InvalidStateTransitionException: Invalid event: CONTAINER_LAUNCHED at DONE\r\n\tat org.apache.hadoop.yarn.state.StateMachineFactory.doTransition(StateMachineFactory.java:305)\r\n\tat org.apache.hadoop.yarn.state.StateMachineFactory.access$500(StateMachineFactory.java:46)\r\n\tat org.apache.hadoop.yarn.state.StateMachineFactory$InternalStateMachine.doTransition(StateMachineFactory.java:487)\r\n\tat org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerImpl.handle(ContainerImpl.java:2104)\r\n\tat org.apache.hadoop.yarn.server.nodemanager.containermanager.container.ContainerImpl.handle(ContainerImpl.java:104)\r\n\tat org.apache.hadoop.yarn.server.nodemanager.containermanager.ContainerManagerImpl$ContainerEventDispatcher.handle(ContainerManagerImpl.java:1525)\r\n\tat org.apache.hadoop.yarn.server.nodemanager.containermanager.ContainerManagerImpl$ContainerEventDispatcher.handle(ContainerManagerImpl.java:1518)\r\n\tat org.apache.hadoop.yarn.event.AsyncDispatcher.dispatch(AsyncDispatcher.java:197)\r\n\tat org.apache.hadoop.yarn.event.AsyncDispatcher$1.run(AsyncDispatcher.java:126)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341684","id":"12341684","description":"2.10.0 release","name":"2.10.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342758","id":"12342758","name":"3.2.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343007","id":"12343007","description":"2.9.2 release","name":"2.9.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343415","id":"12343415","name":"3.0.4","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343433","id":"12343433","description":"","name":"3.1.2","archived":false,"released":false}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12934671","id":"12934671","filename":"YARN-8331.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradeepambati","name":"pradeepambati","key":"pradeepambati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Pradeep Ambati","active":true,"timeZone":"America/Chicago"},"created":"2018-08-07T15:45:13.764+0000","size":9883,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12934671/YARN-8331.001.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12934881","id":"12934881","filename":"YARN-8331.002.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradeepambati","name":"pradeepambati","key":"pradeepambati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Pradeep Ambati","active":true,"timeZone":"America/Chicago"},"created":"2018-08-08T21:45:27.685+0000","size":11885,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12934881/YARN-8331.002.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Race condition in NM container launched after done","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fly_in_gis","name":"fly_in_gis","key":"fly_in_gis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yang Wang","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fly_in_gis","name":"fly_in_gis","key":"fly_in_gis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yang Wang","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160624/comment/16571886","id":"16571886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradeepambati","name":"pradeepambati","key":"pradeepambati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Pradeep Ambati","active":true,"timeZone":"America/Chicago"},"body":"Uploaded a patch to address this JIRA. Basic idea is to treat \"scheduled\" state as \"running\" state  when a container is killed (CONTAINER_KILL event). If a container is in \"scheduled\" state, then it means that it is not yet launched or container is launched but it didn't yet receive the \"CONTAINER_LAUNCHED\" event from launcher. If a CONTAINER_KILL event is sent to a container in \"scheduled\" state, we handle the following two scenarios:\r\n\r\n1. If the container is not launched yet, then we can catch this in containerslauncher.java and send a CONTAINER_KILLED_ON_REQUEST event to container, which triggers container cleanup (and container will transition to DONE eventually). \r\n\r\n2.On the other hand, if the container is launched and a kill event/signal is sent to container before it receives CONTAINER_LAUNCHED event, then fix will do the right thing by treating the container as running.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradeepambati","name":"pradeepambati","key":"pradeepambati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Pradeep Ambati","active":true,"timeZone":"America/Chicago"},"created":"2018-08-07T16:01:08.372+0000","updated":"2018-08-07T16:01:08.372+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160624/comment/16572032","id":"16572032","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (/) *{color:green}+1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 28s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 29m 25s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m  6s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 13s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 40s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 12m 16s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  0m 55s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 24s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 34s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 56s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 56s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 34s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 12m 40s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m  2s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 24s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:green}+1{color} | {color:green} unit {color} | {color:green} 18m 30s{color} | {color:green} hadoop-yarn-server-nodemanager in the patch passed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 24s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black} 80m 58s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:ba1ab08 |\r\n| JIRA Issue | YARN-8331 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12934671/YARN-8331.001.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux acf05b0a3ecc 3.13.0-153-generic #203-Ubuntu SMP Thu Jun 14 08:52:28 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / 6ed8593 |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_171 |\r\n| findbugs | v3.1.0-RC1 |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/21532/testReport/ |\r\n| Max. process+thread count | 301 (vs. ulimit of 10000) |\r\n| modules | C: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager U: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager |\r\n| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/21532/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-07T17:41:29.670+0000","updated":"2018-08-07T17:41:29.670+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160624/comment/16573432","id":"16573432","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Thanks for the patch, [~pradeepambati]!\r\n\r\nIn ContainersLauncher the exit code of a container that never launched should not be SUCCESS.  It should be treated the same as it is done in ContainerLaunch#validateContainerState when a container is killed before it is launched, and the error message should match as well since it's the same type of scenario.\r\n\r\nNow that ContainersLauncher is sending the killed on request event even when it doesn't think the container is being launched or running at all, do we need to add some event handling for CONTAINER_KILLED_ON_REQUEST to more states following KILLING?  I'm thinking it is now possible for ContainerImpl to receive multiple of these which the state machine does not expect.  For example consider the following scenario:\r\n# Container in SCHEDULED state waiting for LAUNCHED event\r\n# Container receives KILL event and sends kill to launcher\r\n# In the meantime container proceeds to launch a very quick process and LAUNCHED is sent to the container.  Event is ignored because the container is in KILLING state.\r\n# Process runs extremely fast, so launcher sends CONTAINER_EXITED_WITH_SUCCESS event to the container and clears container from ContainersLauncher.\r\n# Container receives exit success event in the KILLING state and moves to the EXITED_WITH_SUCCESS state.\r\n# Launcher now finally receives the request to kill the container, but the container is no longer being tracked.  KILLED_ON_REQUEST is sent to the container as part of this patch.\r\n# Container receives KILLED_ON_REQUEST event in the EXITED_WITH_SUCCESS state which is an invalid transition.  Similarly if it had progressed to the DONE state it also would be an invalid state transition.\r\n\r\nI think we need to add some no-op transitions in states that can occur after KILLING if KILLED_ON_REQUEST is received to cover these race conditions.\r\n\r\nThe event field of LocalizationCleanupMatcher is not used and is not needed.  Checking for an instance of ContainerLocalizationCleanupEvent means we are also verifying the event type is CLEANUP_CONTAINER_RESOURCES.  Alternatively LocalizationCleanupMatcher could check for instanceof ContainerLocalizationEvent and verify the event is CLEANUP_CONTAINER_RESOURCES.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2018-08-08T16:14:32.889+0000","updated":"2018-08-08T16:14:32.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160624/comment/16574013","id":"16574013","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (/) *{color:green}+1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 21s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 24m 24s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 55s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 10s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 34s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m 37s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  0m 51s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 20s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 36s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 51s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 51s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 11s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 31s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m 52s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  0m 59s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 18s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:green}+1{color} | {color:green} unit {color} | {color:green} 18m 34s{color} | {color:green} hadoop-yarn-server-nodemanager in the patch passed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 25s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black} 71m 50s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:ba1ab08 |\r\n| JIRA Issue | YARN-8331 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12934881/YARN-8331.002.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux 0058bc650599 4.4.0-130-generic #156-Ubuntu SMP Thu Jun 14 08:53:28 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / 3214cd7 |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_171 |\r\n| findbugs | v3.1.0-RC1 |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-YARN-Build/21544/testReport/ |\r\n| Max. process+thread count | 409 (vs. ulimit of 10000) |\r\n| modules | C: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager U: hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager |\r\n| Console output | https://builds.apache.org/job/PreCommit-YARN-Build/21544/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-08T23:02:11.913+0000","updated":"2018-08-08T23:02:11.913+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160624/comment/16574190","id":"16574190","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradeepambati","name":"pradeepambati","key":"pradeepambati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Pradeep Ambati","active":true,"timeZone":"America/Chicago"},"body":"Thanks for reviewing the patch, [~jlowe]!\r\n\r\nI have addressed the issues you pointed in the new patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pradeepambati","name":"pradeepambati","key":"pradeepambati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34058"},"displayName":"Pradeep Ambati","active":true,"timeZone":"America/Chicago"},"created":"2018-08-09T02:13:41.728+0000","updated":"2018-08-09T02:13:41.728+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160624/comment/16574989","id":"16574989","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Thanks for updating the patch!  +1 lgtm.  Commiting this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2018-08-09T15:17:13.195+0000","updated":"2018-08-09T15:17:13.195+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160624/comment/16575019","id":"16575019","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Thanks, [~pradeepambati]!  I committed this to trunk, branch-3.1, branch-3.0, branch-2, and branch-2.9.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2018-08-09T15:40:02.473+0000","updated":"2018-08-09T15:40:02.473+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160624/comment/16575031","id":"16575031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #14738 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/14738/])\nYARN-8331. Race condition in NM container launched after done. (jlowe: rev cd04e954d2db27f0a15b7d1c492b7cdb656a51db)\n* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/container/TestContainer.java\n* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/launcher/ContainersLauncher.java\n* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/container/ContainerImpl.java\n* (edit) hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/launcher/ContainerLaunch.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-09T15:45:47.778+0000","updated":"2018-08-09T15:45:47.778+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-8331/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3txnz:"}}