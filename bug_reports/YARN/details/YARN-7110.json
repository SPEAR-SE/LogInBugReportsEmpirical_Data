{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13097907","self":"https://issues.apache.org/jira/rest/api/2/issue/13097907","key":"YARN-7110","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2017-08-28T14:32:36.944+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Aug 28 21:14:43 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_46189622_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-08-28T21:15:09.360+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-7110/watchers","watchCount":4,"isWatching":false},"created":"2017-08-28T08:25:19.779+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12513122","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12513122","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"12688637","key":"YARN-1593","self":"https://issues.apache.org/jira/rest/api/2/issue/12688637","fields":{"summary":"support out-of-proc AuxiliaryServices","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-08-28T21:15:09.397+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12319323","id":"12319323","name":"nodemanager"}],"timeoriginalestimate":null,"description":"NM often crash due to the Spark shuffle service,  I can saw many error log messages before NM crashed:\n\n{noformat}\n2017-08-28 16:14:20,521 ERROR org.apache.spark.network.server.TransportRequestHandler: Error sending result ChunkFetchSuccess{streamChunkId=StreamChunkId{streamId=791888824460, chunkIndex=0}, buffer=FileSegmentManagedBuffer{file=/data11/hadoopdata/nodemanager/local/usercache/map_loc/appcache/application_1502793246072_2171283/blockmgr-11e2d625-8db1-477c-9365-4f6d0a7d1c48/10/shuffle_0_6_0.data, offset=27063401500, length=64785602}} to /10.93.91.17:18958; closing connection\njava.io.IOException: Broken pipe\n        at sun.nio.ch.FileChannelImpl.transferTo0(Native Method)\n        at sun.nio.ch.FileChannelImpl.transferToDirectlyInternal(FileChannelImpl.java:428)\n        at sun.nio.ch.FileChannelImpl.transferToDirectly(FileChannelImpl.java:493)\n        at sun.nio.ch.FileChannelImpl.transferTo(FileChannelImpl.java:608)\n        at org.apache.spark.network.buffer.LazyFileRegion.transferTo(LazyFileRegion.java:96)\n        at org.apache.spark.network.protocol.MessageWithHeader.transferTo(MessageWithHeader.java:92)\n        at io.netty.channel.socket.nio.NioSocketChannel.doWriteFileRegion(NioSocketChannel.java:254)\n        at io.netty.channel.nio.AbstractNioByteChannel.doWrite(AbstractNioByteChannel.java:237)\n        at io.netty.channel.socket.nio.NioSocketChannel.doWrite(NioSocketChannel.java:281)\n        at io.netty.channel.AbstractChannel$AbstractUnsafe.flush0(AbstractChannel.java:761)\n        at io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.forceFlush(AbstractNioChannel.java:317)\n        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:519)\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:468)\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:382)\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:354)\n        at io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:111)\n        at java.lang.Thread.run(Thread.java:745)\n2017-08-28 16:14:20,523 ERROR org.apache.spark.network.server.TransportRequestHandler: Error sending result RpcResponse{requestId=7652091066050104512, body=NioManagedBuffer{buf=java.nio.HeapByteBuffer[pos=0 lim=13 cap=13]}} to /10.93.91.17:18958; closing connection\n{noformat}\n\nFinally, there are too many *Finalizer* objects in the process of *NM* to cause OOM.\n!screenshot-1.png!\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12884014","id":"12884014","filename":"screenshot-1.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-28T08:33:59.696+0000","size":342629,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12884014/screenshot-1.png"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"NodeManager always crash for spark shuffle service out of memory","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13097907/comment/16143834","id":"16143834","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"The Spark shuffle service is not part of Hadoop but rather the Spark project.  This issue should be moved there.  It may be related to SPARK-21501","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-08-28T14:32:36.944+0000","updated":"2017-08-28T14:32:36.944+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13097907/comment/16143894","id":"16143894","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"body":"[~jlowe] Thank Jason.\nI think this is more than just the spark shuffle service, after all, the spark shuffle service runs as an *auxiliary service* for *NM*. So, I think for the YARN, we need to make the *NM* stable enough. We need to separate the *auxiliary services*, as a separate process which is very necessary.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-28T15:26:11.137+0000","updated":"2017-08-28T15:27:09.110+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13097907/comment/16143945","id":"16143945","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"OK, if that's why this was filed in YARN instead of SPARK then this is a duplicate of YARN-1593.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-08-28T16:07:27.448+0000","updated":"2017-08-28T16:07:27.448+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13097907/comment/16143954","id":"16143954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"body":"Thank [~jlowe]. Is there a plan for this issue? It seems like it hasn't been updated for a long time. I think it's an urgent need.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-28T16:13:12.849+0000","updated":"2017-08-28T16:13:12.849+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13097907/comment/16144360","id":"16144360","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Looks like Varun was driving that effort but may be busy with other work.  Feel free to ping him on that JIRA for the current status.  It makes more sense to keep the discussion there where there's already earlier discussion, draft of a proposed design, and many people watching that ticket.  Splitting the discussion across that ticket and here does not make sense.  Closing this as a duplicate.\n\nAs for the urgent need, we ran into something similar and fixed the spark shuffle handler.  That's the urgent fix you need today.  Migrating it out of the NM to a separate process doesn't really solve this particular issue.  If the spark shuffle handler's memory is going to explode, it just changes what explodes with it.  It would be nice if it just destroyed the spark handler instead of the NM process, but a cluster running mostly Spark is still hosed if none of the shuffle handlers are running.  The NM supports a work-preserving restart, so you could also consider placing your NMs under supervision so they are restarted if they crash.  When doing this you will probably want to set yarn.nodemanager.recovery.supervised=true to inform the NM that it can rely on something to restart it in a timely manner if it goes down due to an error.  Not as preferable as fixing the problem in the spark shuffle handler directly, but it is an option to help your situation in the short term.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-08-28T21:14:43.275+0000","updated":"2017-08-28T21:14:43.275+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-7110/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3jcav:"}}