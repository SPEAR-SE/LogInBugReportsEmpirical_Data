{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13079629","self":"https://issues.apache.org/jira/rest/api/2/issue/13079629","key":"YARN-6710","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-06-14T02:55:15.449+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 20 23:24:42 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-6710/watchers","watchCount":3,"isWatching":false},"created":"2017-06-14T02:47:04.321+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12332791","id":"12332791","description":"2.7.2 release","name":"2.7.2","archived":false,"released":true,"releaseDate":"2016-01-25"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-06-20T23:25:39.954+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12322906","id":"12322906","name":"fairscheduler","description":"Fair Scheduler"}],"timeoriginalestimate":null,"description":"There are over three thousand nodes in my hadoop production cluster, and we use fair schedule as my scheduler.\nThough there are many free resource in my resource manager， but there are 46 applications pending. \nThose applications can not run after  several hours, and in the end I have to stop them.\n\nI reproduce the scene in my test environment, and I find a bug in FSLeafQueue. \nIn a extreme scenario it will let the FSLeafQueue#amResourceUsage greater than itself.\nWhen fair scheduler try to assign container to a application attempt,  it will do as follow check:\n\n!screenshot-2.png!\n!screenshot-3.png!\n\nBecause the value of FSLeafQueue#amResourceUsage is invalid, it will greater then it real value.\nSo when the value of amResourceUsage greater than the value of Resources.multiply(getFairShare(), maxAMShare) ,\nand the FSLeafQueue#canRunAppAM function will return false which will let the fair scheduler not assign container\nto the FSAppAttempt. \nIn this scenario， all the application attempt will pending and never get any resource.\n\nI find the reason why so many applications in my leaf queue is pending. I will describe it as follow:\n\nWhen fair scheduler first assign a container to the application attempt, it will do something as blow:\n!screenshot-4.png!\n\nWhen fair scheduler remove the application attempt from the leaf queue, it will do something as blow:\n!screenshot-5.png!\n\nBut when application attempt unregister itself, and all the container in the SchedulerApplicationAttempt#liveContainers \nare complete.  There is a APP_ATTEMPT_REMOVED event will send to fair scheduler, but it is asynchronous.\nBefore the application attempt is removed from FSLeafQueue, and there are pending request in FSAppAttempt.\nThe fair scheduler will assign container to the FSAppAttempt, because the size of the liveContainers will equals to\n1. \nSo the FSLeafQueue will add to container resource to the FSLeafQueue#amResourceUsage,  it will\nlet the value of amResourceUsage greater then itself. \nIn the end, the value of FSLeafQueue#amResourceUsage is preety large although there is no application\nit the queue.\nWhen new application come, and the value of FSLeafQueue#amResourceUsage  greater than the value\nof Resources.multiply(getFairShare(), maxAMShare), it will let the scheduler never assign container to\nthe queue.\nAll of the applications in the queue will always pending.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12332791","id":"12332791","description":"2.7.2 release","name":"2.7.2","archived":false,"released":true,"releaseDate":"2016-01-25"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12872920","id":"12872920","filename":"screenshot-1.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-14T02:53:36.921+0000","size":76703,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12872920/screenshot-1.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12872921","id":"12872921","filename":"screenshot-2.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-14T03:15:27.885+0000","size":28843,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12872921/screenshot-2.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12872922","id":"12872922","filename":"screenshot-3.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-14T03:16:20.128+0000","size":53147,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12872922/screenshot-3.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12872923","id":"12872923","filename":"screenshot-4.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-14T03:29:43.588+0000","size":12757,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12872923/screenshot-4.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12872924","id":"12872924","filename":"screenshot-5.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-14T03:31:20.855+0000","size":16762,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12872924/screenshot-5.png"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"There is a heavy bug in FSLeafQueue#amResourceUsage which will let the fair scheduler not assign container to the queue","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13079629/comment/16048642","id":"16048642","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=templedf","name":"templedf","key":"templedf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=templedf&avatarId=24879","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=templedf&avatarId=24879","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=templedf&avatarId=24879","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=templedf&avatarId=24879"},"displayName":"Daniel Templeton","active":true,"timeZone":"America/Los_Angeles"},"body":"Can you give us more details?  Looking at the screenshot, I see 3600 completed apps, which doesn't tell me much.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=templedf","name":"templedf","key":"templedf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=templedf&avatarId=24879","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=templedf&avatarId=24879","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=templedf&avatarId=24879","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=templedf&avatarId=24879"},"displayName":"Daniel Templeton","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-14T02:55:15.449+0000","updated":"2017-06-14T02:55:15.449+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13079629/comment/16048658","id":"16048658","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"body":"[~daniel@cloudera.com] I am sorry, I am try to express myself. But my english is so poor, so it is very slow\nfor me to express myself.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-14T03:22:51.753+0000","updated":"2017-06-14T03:22:51.753+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13079629/comment/16049393","id":"16049393","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yufeigu","name":"yufeigu","key":"yufeigu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yufeigu&avatarId=31240","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yufeigu&avatarId=31240","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yufeigu&avatarId=31240","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yufeigu&avatarId=31240"},"displayName":"Yufei Gu","active":true,"timeZone":"America/Los_Angeles"},"body":"[~daemon], IIUC, the root cause is APP_ATTEMPT_REMOVED event doesn't unregister AM in time so that delay of AM resource usage decreasing blocks new applications. Is it? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yufeigu","name":"yufeigu","key":"yufeigu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yufeigu&avatarId=31240","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yufeigu&avatarId=31240","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yufeigu&avatarId=31240","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yufeigu&avatarId=31240"},"displayName":"Yufei Gu","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-14T17:17:40.843+0000","updated":"2017-06-14T17:17:40.843+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13079629/comment/16053715","id":"16053715","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"body":"[~yufeigu]  使用中文表述可能更清楚些， 这个问题导致的原因对于YARN端主要是由于\n1. Application attempt运行完成之后，AM 向RM发送unregisterApplicationMaster RPC请求。RM在处理\n这个消息时，做些简单的处理然后就向FairScheduler发送APP_ATTEMPT_REMOVED消息就返回了。 \n而APP_ATTEMPT_REMOVED的处理是异步的，所以在FairScheduler中，对应的FSAppAttempt会过段时间\n才会被remove掉。\n\n这个问题会导致两个比较严重的后果发生：\n1. 在这个时间间隔，FairScheduler还会给FSAppAttempt 分派Container。 并且会在分派Container的时候，如果\nif (getLiveContainers().size() == 1 && !getUnmanagedAM()) 情况满足的话，会继续累加am resource的值到amResourceUsage，使得amResourceUsage的值比实际的值大很多。 在实际的情况中，可能会导致队列中的\n作业一直pending，并且永远得不到资源， 这个就是我在上面描述的情况。  \n对于amResourceUsage统计的值比实际大很多问题，社区已经有patch fix这个问题了。 具体可以查看这个jira：\nhttps://issues.apache.org/jira/browse/YARN-3415。\n\n2. 导致FairScheduler会给已经Finished的Application attempt分派Container， 虽然对应的Container，在NM汇报\n心跳的时候，RM会给NM发送Response，让对应的NM cleanup它。 但是会造成资源的浪费。 并且目前调度速度那么快，\n这种问题会更加明显。\n\n虽然社区版本中已经解决了amResourceUsage的问题，但我觉得它只是解决了问题域中的一部分。 \n上述的问题2也是急需要解决的问题。 虽然我看到YARN-3415对应的也解决了Spark框架中unreigster application attempt之前把对应的pending的申请资源申请都清空了。 \n但是YARN作为一个通用的资源分派框架是需要Cover这些所有可能遇到的情况。对于一个通用的资源分派框架，我们不能限定用户的使用方式。\n不能依赖用户每次unregister application master的时候，会在之前释放所有pending的request。\n\n所以，我们需要在分派container之前就要做对应的判断，这个是急需解决的问题。麻烦yufei根据我所说的，再\n评估下这个问题有没有需要解决。\n\n谢谢，\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daemon","name":"daemon","key":"daemon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"YunFan Zhou","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-19T09:44:18.363+0000","updated":"2017-06-19T09:44:18.363+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13079629/comment/16056662","id":"16056662","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yufeigu","name":"yufeigu","key":"yufeigu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yufeigu&avatarId=31240","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yufeigu&avatarId=31240","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yufeigu&avatarId=31240","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yufeigu&avatarId=31240"},"displayName":"Yufei Gu","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~daemon] for the detailed information.\n\nBasically you are saying the latency of handling APP_ATTEMPT_REMOVED cause some issues: 1) the amResourceUsage issue which has been fixed in YARN-3415, 2) RM shouldn't assign any container to the application if its appAttempt has finished and there are still resource requests. Issue 2 seems a legitimate issue. For me, it is more a design issue in AM(Mapreduce, Spark) instead of an RM issue. I am not sure how the scheduler check the status of application attempt for that situation. If the scheduler already know app attempt has finished, it shouldn't assign any resources to it at all. Better to check if that part is already here before we move on. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yufeigu","name":"yufeigu","key":"yufeigu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yufeigu&avatarId=31240","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yufeigu&avatarId=31240","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yufeigu&avatarId=31240","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yufeigu&avatarId=31240"},"displayName":"Yufei Gu","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-20T23:24:42.370+0000","updated":"2017-06-20T23:25:39.946+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-6710/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3g8mv:"}}