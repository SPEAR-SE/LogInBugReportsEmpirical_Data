{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13145566","self":"https://issues.apache.org/jira/rest/api/2/issue/13145566","key":"YARN-8034","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-03-16T14:08:41.563+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 21 16:28:32 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-8034/watchers","watchCount":3,"isWatching":false},"created":"2018-03-16T03:00:11.618+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-21T16:28:32.941+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"I work on Apache Samza, a stateful stream-processing framework that leverages Yarn for resource management. The Samza AM requests resources on specific hosts to schedule stateful jobs. We set relaxLocality = true in these requests we make to Yarn. Often we have observed that we don't get containers on the hosts that we requested them on and the Yarn RM returns containers on arbitrary hosts. \r\n\r\nDo you know what the behavior of the FairScheduler/CapacityScheduler is when setting \"relaxLocality = true\".I did play around by setting a high value for yarn.scheduler.capacity.node-locality-delay but it did not seem to matter. However, when setting relaxLocality = false, we get resources on the exact hosts we requested on.\r\n\r\nThe behavior I want from Yarn is \"Honor locality to the best possible extent and only return a container on an arbitrary host if the requested host is down\". Is there a way to accomplish this?\r\nIf you can point me to the Scheduler code, I'm happy to look at it as well. For context, we have continuous scheduling enabled in our clusters.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Clarification on preferredHost request with relaxedLocality","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jagadish1989%40gmail.com","name":"jagadish1989@gmail.com","key":"jagadish1989@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jagadish","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jagadish1989%40gmail.com","name":"jagadish1989@gmail.com","key":"jagadish1989@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jagadish","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13145566/comment/16401950","id":"16401950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"If you need a specific host then set relaxLocality=false.  Otherwise there's no guarantee the request will be assigned to the requested host.  The host could be down, full of other containers, unhealthy, etc.  When relaxLocality=true then the RM assumes the application would prefer a container in a somewhat timely manner somewhere else rather than waiting indefinitely for a full node to free up space.  The node locality delay gives admins some control over how patiently the RM will wait for locality.\r\n\r\nbq. The behavior I want from Yarn is \"Honor locality to the best possible extent and only return a container on an arbitrary host if the requested host is down\". Is there a way to accomplish this?\r\n\r\nYes, although it will require some work on the Samza AM's part.  Samza's AM can make requests for specific nodes with relaxLocality=false, but it also should monitor the updatedNodes field of each AllocateResponse.  The RM will notify applications in that response when a node becomes unusable or becomes usable again.  The Samza AM can cancel and resubmit a request (either for a different host or with relaxLocality=true) when a node trying to be allocated becomes unusable.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2018-03-16T14:08:41.563+0000","updated":"2018-03-16T14:08:41.563+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13145566/comment/16402040","id":"16402040","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jagadish1989%40gmail.com","name":"jagadish1989@gmail.com","key":"jagadish1989@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jagadish","active":true,"timeZone":"Etc/UTC"},"body":"Thank you [~jlowe] for your recommendations. Very useful. \r\n\r\n>> The host could be down, full of other containers, unhealthy, etc.\r\n\r\nI did have some follow-up questions so that I understand the behavior of this config better. \r\n\r\n- I setup an experiment with the Samza AM to request 1 container (with 1G memory and 1 vcore, host = our-preferred-host, relaxLocality = true and rack = null.)\r\n- I observed that the Yarn RM immediately returns a container on a different host in the next second after the request was made.\r\n- I am able to repro' this 100% of the time across multiple runs (and across multiple hosts in our cluster) which makes me wonder if the preferredHost is ignored if we set relaxLocality = true? I did verify that all nodes were healthy in the cluster. \r\n- For more context, I'm able to observe this behavior with both the fair-scheduler and the capacity-scheduler with \"continuous scheduling\" enabled in both cases. So, I'm not sure if that matters. \r\n\r\nFWIW, with relaxLocality = false, the RM returns containers on the exact hosts that we requested them on. I'm happy to submit a documentation patch to Hadoop so that we make everyone's life better when using Yarn for stateful apps :-) \r\n\r\n>> The node locality delay gives admins some control over how patiently the RM will wait for locality.\r\n\r\nOur node locality delay is configured to the number of nodes in the cluster. I did try increasing it to an arbitrary high number and it did not seem to affect the results of the above experiment. Are there other knobs at play I'm missing?\r\n\r\n>> Yes, although it will require some work on the Samza AM's part. Samza's AM can make requests for specific nodes with relaxLocality=false, but it also should monitor the updatedNodes field of each AllocateResponse. The RM will notify applications in that response when a node becomes unusable or becomes usable again. The Samza AM can cancel and resubmit a request (either for a different host or with relaxLocality=true) when a node trying to be allocated becomes unusable.\r\n\r\nOur original approach was for the Samza AM re-submit the request with relaxedLocality = true after waiting for some timeout. Thank you for your helpful recommendations.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jagadish1989%40gmail.com","name":"jagadish1989@gmail.com","key":"jagadish1989@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jagadish","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-16T15:17:58.930+0000","updated":"2018-03-16T15:17:58.930+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13145566/comment/16402088","id":"16402088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"{quote}I observed that the Yarn RM immediately returns a container on a different host in the next second after the request was made.\r\n{quote}\r\nI believe something like YARN-6344 is relevant here even though that fix is specific to the CapacittyScheduler. The schedulers have a heuristic where it assumes making a small number of requests relative to the size of the cluster should bias towards responsiveness rather than locality. It's been there a long time. I don't know the full history behind it, but I suspect it derives from assuming a small request is for a small job and interactivity is more important than waiting for locality (since we are allowed to relax). See org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.FSAppAttempt#getLocalityWaitFactor for the equivalent place in the FairScheduler for what is being discussed in YARN-6344.\r\n{quote}The Samza AM can cancel and resubmit a request (either for a different host or with relaxLocality=true) when a node trying to be allocated becomes unusable.\r\n{quote}\r\nYou will want to keep that logic even after updating the AM to monitor the node updates. That will cover the case where the desired node is completely full with long-running containers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2018-03-16T15:54:03.833+0000","updated":"2018-03-16T15:54:03.833+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13145566/comment/16403185","id":"16403185","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kkaranasos","name":"kkaranasos","key":"kkaranasos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kkaranasos&avatarId=21934","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kkaranasos&avatarId=21934","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kkaranasos&avatarId=21934","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kkaranasos&avatarId=21934"},"displayName":"Konstantinos Karanasos","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~jagadish1989@gmail.com],\r\n\r\nAs [~jlowe] mentioned, this is very related to YARN-6344 for the capacity scheduler. What you should look at is the \"yarn.scheduler.capacity.rack-locality-additional-delay\" parameter.\r\n\r\nSince you have only one (or very few) container requests, the current logic (if you let the above parameter to its default value) will lead to relaxing locality almost immediately. If you set that parameter to a positive value, you should achieve your desired behavior.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kkaranasos","name":"kkaranasos","key":"kkaranasos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kkaranasos&avatarId=21934","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kkaranasos&avatarId=21934","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kkaranasos&avatarId=21934","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kkaranasos&avatarId=21934"},"displayName":"Konstantinos Karanasos","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-17T01:21:12.123+0000","updated":"2018-03-17T01:22:26.807+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13145566/comment/16407398","id":"16407398","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jagadish1989%40gmail.com","name":"jagadish1989@gmail.com","key":"jagadish1989@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jagadish","active":true,"timeZone":"Etc/UTC"},"body":"Hey [~jlowe] and [~kkaranasos]:\r\n\r\nThanks for the pointers. It helped me dive-deep into the internals of how the Capacity Scheduler actually works. Currently, our YARN clusters are on version 2.7 - So, we cannot leverage YARN-6344 just yet. Hence, we'll stick to making our app-master request resources with strict locality (by setting relaxLocality = false).\r\n\r\nWhile the \"localityWaitFactor\" is certainly at play when used with the CapacityScheduler, I'd like to understand how it affects the FairScheduler. The code you pointed out: FsAppAttempt#getLocalityWaitFactor appears to be un-used in the 2.7 branch of Hadoop. There's however, FicaSchedulerApp#getLocalityWaitFactor but its usage seems restricted to the capacity scheduler though. Is there something else I am missing?\r\n\r\nHere's the setup: \r\nWe have FairScheduler with \"continuous scheduling\" turned on, with a node-locality delay = 5s, rack-locality-delay = 5s, node-locality-threshold = -1 and rack-locality-threshold = -1.\r\nI requested one container on a preferred host with relaxLocality = true but Yarn appears to return a container on an arbitrary host instantly. Is there some other scheduler tunable I'm missing? Any pointers to the source code are greatly appreciated!\r\n\r\nThanks [~jlowe] and [~kkaranasos] ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jagadish1989%40gmail.com","name":"jagadish1989@gmail.com","key":"jagadish1989@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jagadish","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-21T03:20:06.591+0000","updated":"2018-03-21T03:20:06.591+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13145566/comment/16408190","id":"16408190","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"{quote}The code you pointed out: FsAppAttempt#getLocalityWaitFactor appears to be un-used in the 2.7 branch of Hadoop.\r\n{quote}\r\nMy apologies, I'm not that familiar with the fair scheduler or its continuous scheduling behavior. I just know how small allocations behave in the capacity scheduler and assumed the fair scheduler copied that same logic. Apparently it's different there in practice. To get to the bottom of this, I'd probably have to find some way to reproduce it and step through the scheduler to figure out why it's deciding to allocate when it does. Unfortunately that's time I simply don't have right now.\r\n\r\nI see FsAppAttempt#getAllowedLocalityLevel and FsAppAttempt#getAllowedLocalityLevelByTime are probably more relevant for the fair scheduler. Off the top of my head, I'm wondering about this logic:\r\n{code:java}\r\n    // check waiting time\r\n    long waitTime = currentTimeMs;\r\n    if (lastScheduledContainer.containsKey(priority)) {\r\n      waitTime -= lastScheduledContainer.get(priority);\r\n    } else {\r\n      waitTime -= getStartTime();\r\n    }\r\n\r\n    long thresholdTime = allowed.equals(NodeType.NODE_LOCAL) ?\r\n            nodeLocalityDelayMs : rackLocalityDelayMs;\r\n\r\n    if (waitTime > thresholdTime) {\r\n {code}\r\nIf lastScheduledContainer isn't reset when the new, single container request arrives it will be the last time the app scheduled a container at that priority (which may be a long time ago). In that case it would essentially teleport from NODE_LOCAL to RACK_LOCAL locality, although I would expect it to remain in rack-locality for another 5 seconds based on the configs and code. But again, I'm far from a fair scheduler expert.\r\n{quote}There's however, FicaSchedulerApp#getLocalityWaitFactor but its usage seems restricted to the capacity scheduler though. Is there something else I am missing?\r\n{quote}\r\nFicaSchedulerApp is specific to the FIFO and CapacityScheduler (hence the prefix \"Fica\" for Fifo + capacity scheduler).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2018-03-21T16:28:32.941+0000","updated":"2018-03-21T16:28:32.941+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-8034/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3rdlz:"}}