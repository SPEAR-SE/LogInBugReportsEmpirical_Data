{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12983136","self":"https://issues.apache.org/jira/rest/api/2/issue/12983136","key":"YARN-5295","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-06-27T09:30:07.318+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jul 01 12:39:52 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-5295/watchers","watchCount":5,"isWatching":false},"created":"2016-06-25T12:48:42.584+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12332791","id":"12332791","description":"2.7.2 release","name":"2.7.2","archived":false,"released":true,"releaseDate":"2016-01-25"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Prabhu+Joseph","name":"Prabhu Joseph","key":"prabhu joseph","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prabhu Joseph","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-10-24T17:46:35.738+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12327621","id":"12327621","name":"capacity scheduler"}],"timeoriginalestimate":null,"description":"In yarn Queue-Mappings, Yarn should check if the queue is present before submitting the job. If not present it should go to next mapping available.\n\nFor example if we have\nyarn.scheduler.capacity.queue-mappings=u:%user:%user,g:edw:platform\nand I submit job with user \"test\" and if there is no \"test\" queue then it should check the second mapping (g:edw:platform) in the list and if test is part of edw group it should submit job in platform queue.\n\nBelow Sanity checks has to be done for the mapped queue in the list and if it fails then the the next queue mapping has to be chosen, when there is no queue mapping passing the sanity check, only then the application has to be Rejected.\n\n1. is queue present\n2. is queue not a leaf queue\n3. is user either have ACL Submit_Applications or Administer_Queue of the queue.\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"YARN queue-mappings to check Queue is present before submitting job","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Prabhu+Joseph","name":"Prabhu Joseph","key":"prabhu joseph","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prabhu Joseph","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Prabhu+Joseph","name":"Prabhu Joseph","key":"prabhu joseph","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prabhu Joseph","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12983136/comment/15350703","id":"15350703","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sunilg","name":"sunilg","key":"sunilg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunil Govindan","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi [~Prabhu Joseph]\nThanks for raising this issue. Couple of doubts here,\n\nIf we have {{u:%user:%user}} and {{g:edw:platform}},  and assume *test* is not present in cluster. But *test* user is still a part of *edw* group. So we have to submit to *platform* queue.\nIf *test* queue was present, this app would have got submitted to *test* itself. Am I correct?\n\nBeing said this, we already do a set of checks in CS (I am mentioning 2.7.2 and trunk)\nIn trunk, we have {{PlacementManager}} which will do the check before the app itself is submitted to scheduler. Ref YARN-3635. Also if we use ACLs, we will have that check also done in {{RMAppManager#submitApplication}} itself.\nIn 2.7.2,  this check is done in CS itself. So application was added to scheduler and then we will get an APP_REJECTED event.\n\nSo I think we do check for queue now, but we are not checking whether its a leaf queue. And ACLS are already handled in trunk. Could you pls help to correct if i understood the problem differently.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sunilg","name":"sunilg","key":"sunilg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunil Govindan","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-06-27T09:30:07.318+0000","updated":"2016-06-27T09:30:07.318+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12983136/comment/15351347","id":"15351347","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Prabhu+Joseph","name":"Prabhu Joseph","key":"prabhu joseph","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prabhu Joseph","active":true,"timeZone":"Etc/UTC"},"body":"Hi [~sunilg], Yes, if test queue is present, the application submitted by test user placed into test queue. But if test queue is not present or if test queue is not a leaf queue or if test user does not have either Submit_Applications or Administer_Queue ACL, then the application is rejected. Instead, the getMappedQueue in CapacityScheduler can do the three sanity checks well before and return a valid queue that is platform instead of test. (Assuming test user passes the sanity checks on platform Queue)\n\nCurrently the sanity checks are done separately after deciding the queue to be placed, instead sanity checks can be included in getMappedQueue logic, where once queue mapping is chosen from the list, the sanity checks can be done and if it fails, then move to the next queue mapping in the list.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Prabhu+Joseph","name":"Prabhu Joseph","key":"prabhu joseph","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prabhu Joseph","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-27T16:22:37.519+0000","updated":"2016-06-27T16:25:50.283+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12983136/comment/15351384","id":"15351384","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sunilg","name":"sunilg","key":"sunilg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunil Govindan","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks [~Prabhu Joseph] for the clarification.\nYes, we select a queue and then we do sanity after that. And if sanity check (validations) fails for this selected queue, we will reject the app submission. In this given scenario, may be a group configuration seems valid and the jira is focussing on that point. Got it. +1 for the approach.\n\nInterestingly we need to see how 3rd point is to be handled {{3. is user either have ACL Submit_Applications or Administer_Queue of the queue.}}, we may possibly relax some ACLs here if we do that. If a user (user *test*) is not given permission to queue (queue named *test* in this context), and same user's group (group *edw*) has permission in another queue (queue named *platform* in this context), I think we have to give preference for user than group. So i think current implementation holds good for 3rd point. Thoughts? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sunilg","name":"sunilg","key":"sunilg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunil Govindan","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-06-27T16:45:29.859+0000","updated":"2016-06-27T16:45:29.859+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12983136/comment/15351450","id":"15351450","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Prabhu+Joseph","name":"Prabhu Joseph","key":"prabhu joseph","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prabhu Joseph","active":true,"timeZone":"Etc/UTC"},"body":"Yes, doing Sanity Check 1 and 2 well before in getMappedQueue is suffice to help administrators to configure a default queue to any user or group in case of no valid queue mapping. For example, with this fix, Administrators can allow any new user added and who does not have queue created with same user name can still be placed in default queue through list of queue mappings u:%user:%user,u:%user:default","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Prabhu+Joseph","name":"Prabhu Joseph","key":"prabhu joseph","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prabhu Joseph","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-27T17:33:43.932+0000","updated":"2016-06-27T17:33:43.932+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12983136/comment/15356770","id":"15356770","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sunilg","name":"sunilg","key":"sunilg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunil Govindan","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi [~Prabhu Joseph]\n\nIn YARN-3635, a new {{PlacementManager}} is added. It takes care of queue mappings in general across schedulers. \nCode snippet from {{CS#getUserGroupMappingPlacementRule}},\n{code}\n         if (queue == null || !(queue instanceof LeafQueue)) {\n          throw new IOException(\"mapping contains invalid or non-leaf queue \"\n             + mappingQueue);\n         }\n{code}\nWhile loading queue-mappings from conf, a validation is done for *non-existent* and *non-leafQueues*. And this {{QueueMapping}} is used in {{PlacementManager}} to do the placement activity in RMAppManager.\n\nBut this is not present in branch2.7 against which you raised this ticket. [~leftnoteasy], could we backport YARN-3635 to branch-2.7. Its present in branch-2.8 already. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sunilg","name":"sunilg","key":"sunilg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sunil Govindan","active":true,"timeZone":"Asia/Kolkata"},"created":"2016-06-30T09:00:07.859+0000","updated":"2016-06-30T09:00:07.859+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12983136/comment/15358899","id":"15358899","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Prabhu+Joseph","name":"Prabhu Joseph","key":"prabhu joseph","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prabhu Joseph","active":true,"timeZone":"Etc/UTC"},"body":"Hi [~sunilg], In addition, we also need to include below code snippet in UserGroupMappingPlacementRule#getMappedQueue before returning the mapped queue, which will return a valid queue which is a existent leaf queue. \n\n{code}\n     for (QueueMapping mapping : mappings) {\n         if (queue == null || !(queue instanceof LeafQueue)) {\n                  continue;\n         }\n         return queue;\n    }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Prabhu+Joseph","name":"Prabhu Joseph","key":"prabhu joseph","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Prabhu Joseph","active":true,"timeZone":"Etc/UTC"},"created":"2016-07-01T12:39:52.919+0000","updated":"2016-07-01T12:39:52.919+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-5295/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i303bj:"}}