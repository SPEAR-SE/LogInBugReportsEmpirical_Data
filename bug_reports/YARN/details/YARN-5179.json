{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12973801","self":"https://issues.apache.org/jira/rest/api/2/issue/12973801","key":"YARN-5179","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-05-29T20:04:58.875+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Mar 21 17:43:30 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-5179/watchers","watchCount":15,"isWatching":false},"created":"2016-05-29T15:10:39.317+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12327585","id":"12327585","description":"2.7.0 release","name":"2.7.0","archived":false,"released":true,"releaseDate":"2015-04-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-03-21T17:43:30.234+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12319323","id":"12319323","name":"nodemanager"}],"timeoriginalestimate":null,"description":"// Multiply by 1000 to avoid losing data when converting to int \n       int milliVcoresUsed = (int) (cpuUsageTotalCoresPercentage * 1000 \n              * maxVCoresAllottedForContainers /nodeCpuPercentageForYARN); \n\nThis formula will not get right CPU usage based vcore if vcores != physical cores. \n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12859769","id":"12859769","filename":"YARN-5179.xls","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-03-21T17:42:49.276+0000","size":9216,"mimeType":"application/vnd.ms-excel","content":"https://issues.apache.org/jira/secure/attachment/12859769/YARN-5179.xls"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Issue of CPU usage of containers","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Zhongkai","name":"Zhongkai","key":"zhongkai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhongkai Mi","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Zhongkai","name":"Zhongkai","key":"zhongkai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhongkai Mi","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Both on Windows and Linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15306049","id":"15306049","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"body":"[~Zhongkai], Perhaps the fix for YARN-5117 might be relevant here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-29T20:04:58.875+0000","updated":"2016-05-29T20:04:58.875+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15307144","id":"15307144","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Zhongkai","name":"Zhongkai","key":"zhongkai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhongkai Mi","active":true,"timeZone":"Etc/UTC"},"body":"@Arun, Thanks, I checked it. However, the vcoresUsed may not only be used in resource allocation, but in metrics and monitor too. I think the calculation of milliVcoresUsed should be fixed too : )","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Zhongkai","name":"Zhongkai","key":"zhongkai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhongkai Mi","active":true,"timeZone":"Etc/UTC"},"created":"2016-05-31T03:18:03.392+0000","updated":"2016-05-31T03:18:03.392+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15371957","id":"15371957","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=elgoiri","name":"elgoiri","key":"elgoiri","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Íñigo Goiri","active":true,"timeZone":"Etc/UTC"},"body":"[~asuresh], given that YARN-5117 acknowledges that there is a problem with the way we calculated the CPU usage, I agree with [~Zhongkai] that we should revisit the way that milliVCores is computed in {{ContainersMonitorImpl}}. [~Zhongkai], could you upload a patch with your proposal to see if it makes sense?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=elgoiri","name":"elgoiri","key":"elgoiri","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Íñigo Goiri","active":true,"timeZone":"Etc/UTC"},"created":"2016-07-12T00:20:00.035+0000","updated":"2016-07-12T00:20:00.035+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15850154","id":"15850154","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"body":"I am interested in working on this. Can I take it forward?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-02-02T16:45:55.902+0000","updated":"2017-02-02T16:45:55.902+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15854374","id":"15854374","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nroberts","name":"nroberts","key":"nroberts","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nathan Roberts","active":true,"timeZone":"America/Chicago"},"body":"I think ResourceUtilization.getCPU() has a similar sort of issue (i.e. it's difficult to interpret in cases where physical cores != vcores). Should we fix that here or in separate jira? Thoughts?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nroberts","name":"nroberts","key":"nroberts","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nathan Roberts","active":true,"timeZone":"America/Chicago"},"created":"2017-02-06T17:06:48.733+0000","updated":"2017-02-06T17:06:48.733+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15854387","id":"15854387","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nroberts","name":"nroberts","key":"nroberts","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nathan Roberts","active":true,"timeZone":"America/Chicago"},"body":"bq. I think ResourceUtilization.getCPU() has a similar sort of issue (i.e. it's difficult to interpret in cases where physical cores != vcores). Should we fix that here or in separate jira? Thoughts?\nNevermind. I think physicalResource allows the RM to figure out how to properly interpret getCPU().\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nroberts","name":"nroberts","key":"nroberts","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nathan Roberts","active":true,"timeZone":"America/Chicago"},"created":"2017-02-06T17:15:42.942+0000","updated":"2017-02-06T17:15:42.942+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15866165","id":"15866165","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"body":"[~asuresh]\n\nWhile trying to reproduce this issue, seeing some values for milliVcoresUsed variable in recordUsage() method of ContainersMonitorImpl.java class. Also, I am seeing major code changes as part of https://issues.apache.org/jira/browse/YARN-4597. Hence, thought of confirming with you on this jira. Is this still valid?\n\nKindly let me know on how to proceed with this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-02-14T17:20:43.239+0000","updated":"2017-02-14T17:20:43.239+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15866325","id":"15866325","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"body":"[~manirajv06@gmail.com],\n\nI think the issue is still valid and relevant. YARN-4597 has refactored things a bit, but the recordUsage() still exists in ContainerMonitorImpl, and is called by the MonitorngThread. Although, it is not currently used for scheduling decisions.. yet. Which would change once YARN-1011 lands.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-02-14T18:20:57.845+0000","updated":"2017-02-14T18:20:57.845+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15873308","id":"15873308","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"body":"[~asuresh]\n\n(edited with more details based on investigation)\n\nBased on my understanding, resourceCalculatorPlugin.getNumProcessors() and maxVCoresAllottedForContainers difference cause this millivcores calculation issue. resourceCalculatorPlugin.getNumProcessors() simply holds of logical processors count. If a node has 4 logical cpu's, then getNumProcessors returns 4.\n\nWhen yarn.nodemanager.resource.cpu-vcores is -1,\n\nmaxVCoresAllottedForContainers has values based on yarn.nodemanager.resource.count-logical-processors-as-cores property. If yarn.nodemanager.resource.count-logical-processors-as-cores is true, then maxVCoresAllottedForContainers is equal to resourceCalculatorPlugin.getNumProcessors(), otherwise, it differs. I am assuming yarn.nodemanager.resource.detect-hardware-capabilities has been enabled and yarn.nodemanager.resource.percentage-physical-cpu-limit is 100 in this case.\n\nWhen yarn.nodemanager.resource.cpu-vcores is not equal to -1,\n\nmaxVCoresAllottedForContainers simply holds value of yarn.nodemanager.resource.cpu-vcores property. Since there is no validation in place, it can have any arbitrary no. (for ex, 100 etc)\n\nLike Memory overflow limit, currently containers won't get killed when cpu usage exceeds. A container can use all the logical cores available in the node. Given this situation, I don't think using maxVCoresAllottedForContainers for millivcores calculation is correct as it can either lead to low or high cpu usage with respect to actual cpu usage when maxVCoresAllottedForContainers != resourceCalculatorPlugin.getNumProcessors().\n\nApproach 1: Can we use actual vcores being used?\n\nInstead of \n\n{code}float cpuUsageTotalCoresPercentage = cpuUsagePercentPerCore / resourceCalculatorPlugin.getNumProcessors();\nint milliVcoresUsed = (int) (cpuUsageTotalCoresPercentage * 1000 * maxVCoresAllottedForContainers /nodeCpuPercentageForYARN);{code}\n\nCan we use this?\n\n{code}float cpuUsageTotalCoresPercentage = cpuUsagePercentPerCore / resourceCalculatorPlugin.getNumVcoresUsed();\nint milliVcoresUsed = (int) (cpuUsageTotalCoresPercentage * 1000 * resourceCalculatorPlugin.getNumVcoresUsed()/nodeCpuPercentageForYARN);{code}\n\nApproach 2:\n\nInstead of \n\n{code}float cpuUsageTotalCoresPercentage = cpuUsagePercentPerCore / resourceCalculatorPlugin.getNumProcessors();\nint milliVcoresUsed = (int) (cpuUsageTotalCoresPercentage * 1000 * maxVCoresAllottedForContainers /nodeCpuPercentageForYARN);{code}\n\nCan we use?\n\n{code}float cpuUsageTotalCoresPercentage = cpuUsagePercentPerCore / resourceCalculatorPlugin.getNumProcessors();\nint milliVcoresUsed = (int) ((int) (cpuUsageTotalCoresPercentage * resourceCalculatorPlugin.getNumProcessors() * 1000)/100.0f);{code}\n\nPlease go through these above options and let me know your suggestions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-02-18T19:29:02.329+0000","updated":"2017-03-01T17:36:00.083+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15892624","id":"15892624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"body":"[~asuresh]\n\nI've updated my earlier comment with more details and described the possible solutions. Can you please take a look and provide your inputs?\n\nThanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-03-02T17:10:00.156+0000","updated":"2017-03-02T17:10:00.156+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15892636","id":"15892636","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the clarification, and apologies for the delay..\nI am in favor of approach 1. [~kasha]/[~kkaranasos], thoughts ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-03-02T17:18:48.339+0000","updated":"2017-03-02T17:18:48.339+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15893747","id":"15893747","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks [~asuresh]. Added [~kasha] & [~kkaranasos] as watchers, just in case if they don't receive the email notifications.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-03-03T05:00:28.092+0000","updated":"2017-03-03T05:00:28.092+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15897728","id":"15897728","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"body":"[~kasha]/[~konstantinos], any thoughts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-03-06T17:51:52.595+0000","updated":"2017-03-06T17:51:52.595+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15929307","id":"15929307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kasha","name":"kasha","key":"kasha","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karthik Kambatla","active":true,"timeZone":"America/Los_Angeles"},"body":"[~miklos.szegedi@cloudera.com] was looking into a similar issue very recently. Miklos - can you check if the proposals fix the issue that you were running into? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kasha","name":"kasha","key":"kasha","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Karthik Kambatla","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-03-17T01:48:28.005+0000","updated":"2017-03-17T01:48:28.005+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15931007","id":"15931007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=miklos.szegedi%40cloudera.com","name":"miklos.szegedi@cloudera.com","key":"miklos.szegedi@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=miklos.szegedi%40cloudera.com&avatarId=32342","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=miklos.szegedi%40cloudera.com&avatarId=32342","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=miklos.szegedi%40cloudera.com&avatarId=32342","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=miklos.szegedi%40cloudera.com&avatarId=32342"},"displayName":"Miklos Szegedi","active":true,"timeZone":"America/Los_Angeles"},"body":"[~manirajv06@gmail.com], could you help me, what am I missing?\n\nI ran a test and the numbers look right to me. Here is the code:\n{code}\n      float cpuUsagePercentPerCore = pTree.getCpuUsagePercent();\n      float cpuUsageTotalCoresPercentage = cpuUsagePercentPerCore /\n              resourceCalculatorPlugin.getNumProcessors();\n\n      // Multiply by 1000 to avoid losing data when converting to int\n      int milliVcoresUsed = (int) (cpuUsageTotalCoresPercentage * 1000\n              * maxVCoresAllottedForContainers /nodeCpuPercentageForYARN);\n{code}\nAnd here are the values. I have 4 processors, and we use about 3 processors with our job. This is 75% of total CPU resources, so the first three numbers look right. I chose 8192 vcores in yarn.nodemanager.resource.cpu-vcores to have a very different number than the 4 cores. Then we prorate 75% to 8192 vcores, so we get about 6141 number of vcores, which is 6140747 millivcores. That sounds right. What would you expect in this case?\n{code}\nresourceCalculatorPlugin.getNumProcessors() = 4\ncpuUsagePercentPerCore = 299.84116\ncpuUsageTotalCoresPercentage = 74.96029\nmaxVCoresAllottedForContainers = 8192\nnodeCpuPercentageForYARN = 100\nmilliVcoresUsed = 6140747\n{code}\nApproach #1 above would give us 3000, which is millirealcores. Why would we multiply and then divide by resourceCalculatorPlugin.getNumVcoresUsed()?\nIt is an interesting question though what metric is the most useful and simple from the user point of view. I think I like the 75% the most.\nI think we have a documentation bug in yarn-default.xml, where we mention CPU cores here instead of vcores: \nyarn.nodemanager.resource.cpu-vcores\t8\tNumber of CPU cores that can be allocated for containers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=miklos.szegedi%40cloudera.com","name":"miklos.szegedi@cloudera.com","key":"miklos.szegedi@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=miklos.szegedi%40cloudera.com&avatarId=32342","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=miklos.szegedi%40cloudera.com&avatarId=32342","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=miklos.szegedi%40cloudera.com&avatarId=32342","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=miklos.szegedi%40cloudera.com&avatarId=32342"},"displayName":"Miklos Szegedi","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-03-18T02:15:12.558+0000","updated":"2017-03-18T02:32:02.099+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12973801/comment/15934970","id":"15934970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks [~miklos.szegedi@cloudera.com] for your comments.\n\nAfter my previous comment and proposals, had a offline discussion with [~naganarasimha_gr@apache.org] and was able to correct my understanding of vcores in general and especially by playing around with Default Container Executor & Linux container executor (with cgroups as well). \n\nThen, I ran a test with stress command (stress --cpu  4) to confirm my understanding about vcores with various possible options and compiled results in excel sheet. I've attached the same for reference. My box has 2 pcores and resourceCalculatorPlugin.getNumProcessors() is 4. Various Options are \n\nUsing Linux container executor - \n\n1. Physical cpu limit is 100, Vcores is 2, Strict resource usage is false. cpuUsagePercentPerCore is 320 & Millivcores is 1600\n2. Physical cpu limit is 100, Vcores is 4, Strict resource usage is false. cpuUsagePercentPerCore is 360 & Millivcores is 3600\n3. Physical cpu limit is 50, Vcores is 2, Strict resource usage is false. cpuUsagePercentPerCore is 99 & Millivcores is 990\n4. Physical cpu limit is 50, Vcores is 4, Strict resource usage is false. cpuUsagePercentPerCore is 98 & Millivcores is 1960\n\n5. Physical cpu limit is 100, Vcores is 2, Strict resource usage is true. cpuUsagePercentPerCore is 100 & Millivcores is 500\n6. Physical cpu limit is 100, Vcores is 4, Strict resource usage is true. cpuUsagePercentPerCore is 50  & Millivcores is 500\n7. Physical cpu limit is 50, Vcores is 2, Strict resource usage is true. cpuUsagePercentPerCore is 50 & Millivcores is 500\n8. Physical cpu limit is 50, Vcores is 4, Strict resource usage is true. cpuUsagePercentPerCore is 25 &  Millivcores is 500\n\nUsing Default Linux executor - \n\nPhysical cpu limit is 100, Vcores is 200. cpuUsagePercentPerCore is 380 & Millivcores is 190000\nPhysical cpu limit is 50, Vcores is 200. cpuUsagePercentPerCore is 375 & Millivcores is 375000\n\nVerified O/p of millivcores for each above option and its correctness with [~naganarasimha_gr@apache.org]. Initally, We had a doubt on our own understanding only when physical cpu limit is 50 and thought it should be half of the current millivcores, then we were able to reason it this way - for ex, in option 3, max utilization can go upto 200 because resourceCalculatorPlugin.getNumProcessors() is 2 (50% of 4 processors), but we got 99 as utilization. It means half of vcores should have been utilized, hence millivcores should be 1000 (approx). Based on these test results and our understanding, we don't see any issue with current calculation (like [~miklos.szegedi@cloudera.com] said in his comments).\n\nPlease correct me if you see any gap.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=manirajv06%40gmail.com","name":"manirajv06@gmail.com","key":"manirajv06@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manikandan R","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-03-21T17:43:30.234+0000","updated":"2017-03-21T17:43:30.234+0000"}],"maxResults":16,"total":16,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-5179/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2yo07:"}}