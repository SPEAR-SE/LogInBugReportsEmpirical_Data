{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13096657","self":"https://issues.apache.org/jira/rest/api/2/issue/13096657","key":"YARN-7070","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12313722","id":"12313722","key":"YARN","name":"Hadoop YARN","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12313722&avatarId=15135","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12313722&avatarId=15135","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12313722&avatarId=15135","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12313722&avatarId=15135"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-08-22T14:33:36.455+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Sep 05 13:25:46 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-7070/watchers","watchCount":5,"isWatching":false},"created":"2017-08-22T07:17:04.005+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335742","id":"12335742","description":"2.8.1 release","name":"2.8.1","archived":false,"released":true,"releaseDate":"2017-06-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-09-05T13:25:46.437+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12319323","id":"12319323","name":"nodemanager"}],"timeoriginalestimate":null,"description":"We have found some of cache files(in /tmp/hadoop-yarn/nm-local-dir/usercache/hdfs/appcache) for yarn on nodemanager cannot be deleted properly. The directories are like following(blockmgr***)\n\n=================\n# ls -ltr application_1501810184023_55949\ntotal 120\ndrwx--x---  2 hdfs yarn 4096 Aug 22 04:29 filecache\ndrwxr-s---  2 hdfs yarn 4096 Aug 22 04:56 blockmgr-881fab2c-fba4-4bb1-8dd9-5ab35a512df7\ndrwxr-s--- 10 hdfs yarn 4096 Aug 22 04:56 blockmgr-bf8a19f5-e9ae-4269-a0ef-b27d0f9c17e7\ndrwxr-s--- 11 hdfs yarn 4096 Aug 22 04:58 blockmgr-f3437e8d-9595-4898-8bda-92ebff3ada1d\ndrwxr-s--- 18 hdfs yarn 4096 Aug 22 05:01 blockmgr-930c0cd8-1d31-4cdb-a244-f6ad4bf74bff\ndrwxr-s--- 12 hdfs yarn 4096 Aug 22 05:13 blockmgr-83fc0702-ac40-4743-812a-7d488e92004e\ndrwxr-s---  9 hdfs yarn 4096 Aug 22 05:13 blockmgr-f6cfe045-12c3-41d6-b77e-aa5200daeb6a\ndrwxr-s--- 12 hdfs yarn 4096 Aug 22 05:13 blockmgr-53dcb4ea-ba5d-4b8b-859b-805b9303a149\ndrwxr-s--- 10 hdfs yarn 4096 Aug 22 05:13 blockmgr-0c0c4bb9-ef5e-4ca1-8d23-ce5cd58d0a75\ndrwxr-s---  9 hdfs yarn 4096 Aug 22 05:13 blockmgr-557d0f39-67d2-491a-9307-12fc1d724380\ndrwxr-s--- 10 hdfs yarn 4096 Aug 22 05:13 blockmgr-fbc87680-4df7-498e-bf6d-456a5aea4fc9\ndrwxr-s--- 10 hdfs yarn 4096 Aug 22 05:13 blockmgr-53ee8251-fac1-4f62-82c2-5e970f0d86ec\ndrwxr-s---  9 hdfs yarn 4096 Aug 22 05:14 blockmgr-5a8bc187-abcf-482d-9da5-e8c4647d4731\ndrwxr-s--- 10 hdfs yarn 4096 Aug 22 05:14 blockmgr-251c3a99-cd85-442a-8945-52c344c0d861\ndrwxr-s--- 13 hdfs yarn 4096 Aug 22 05:14 blockmgr-c352c1ad-15dc-456b-8b62-5b83b9950494\ndrwxr-s--- 12 hdfs yarn 4096 Aug 22 05:15 blockmgr-b4f01347-4b51-4b35-8146-2aa840084c2b\ndrwxr-s--- 14 hdfs yarn 4096 Aug 22 05:15 blockmgr-0095d26c-c134-48b4-82a6-e8ae02f0189c\ndrwxr-s--- 13 hdfs yarn 4096 Aug 22 05:15 blockmgr-28a31574-61ae-459f-be3a-8608892246d7\ndrwxr-s--- 16 hdfs yarn 4096 Aug 22 05:15 blockmgr-c0cd0df9-b355-4209-b6aa-b549a1fa36eb\ndrwxr-s--- 11 hdfs yarn 4096 Aug 22 05:15 blockmgr-a2730abb-9517-461e-bedf-d9a2dcef373f\ndrwxr-s--- 14 hdfs yarn 4096 Aug 22 05:15 blockmgr-91dd2e1a-6bc2-4429-8b71-2f4240987159\ndrwxr-s--- 12 hdfs yarn 4096 Aug 22 05:15 blockmgr-f4e3a586-8817-45ea-a197-9fdbb3d91946\ndrwxr-s--- 15 hdfs yarn 4096 Aug 22 05:15 blockmgr-ba2c605e-89d8-4f7c-b42c-6ed4ba6bf4ea\ndrwxr-s--- 16 hdfs yarn 4096 Aug 22 05:15 blockmgr-2ae72383-5f72-4002-84a7-e6335b8c2b6c\ndrwxr-s--- 13 hdfs yarn 4096 Aug 22 05:15 blockmgr-6c5e260f-d3c7-4af6-91c1-168c73343f2d\ndrwxr-s--- 16 hdfs yarn 4096 Aug 22 05:15 blockmgr-2e9923b1-281c-4a9d-8069-6c5430bd5fc3\ndrwxr-s--- 18 hdfs yarn 4096 Aug 22 05:15 blockmgr-cc3f1406-d8a2-4bf5-a276-8f7aed75c513\ndrwxr-s--- 11 hdfs yarn 4096 Aug 22 05:15 blockmgr-975bcce0-84b2-4590-880b-bf182d76e319\ndrwxr-s--- 11 hdfs yarn 4096 Aug 22 05:15 blockmgr-ce82cb63-5998-4227-b85e-77f1c633db43\ndrwxr-s--- 11 hdfs yarn 4096 Aug 22 05:15 blockmgr-592af4aa-3c89-4081-8746-29b99f2220b1\n=================\n\nWe also applied patches YARN-4594, YARN-4731, but nothing changed.\nYARN-4594 https://issues.apache.org/jira/browse/YARN-4594\nYARN-4731 https://issues.apache.org/jira/browse/YARN-4731\n\nAny advice will be greatly appreciated.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12883244","id":"12883244","filename":"application_1501810184023_55949.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-23T02:06:44.022+0000","size":274059,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12883244/application_1501810184023_55949.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12885310","id":"12885310","filename":"warn_logs.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"created":"2017-09-05T06:28:51.011+0000","size":10872,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12885310/warn_logs.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"some of local cache files for yarn can't be deleted","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Hadoop 2.8.1","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13096657/comment/16136866","id":"16136866","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"The clues for this will be in the nodemanager logs.  The first step is to verify the NM believes the application has completed, as it will not clean up anything in an application's appcache until it thinks the application has completed.  Even if the NM is no longer running any containers for an application,  it will continue to host an application's appcache files until the RM tells it the application has completed.\n\nAssuming the NM has been told the application completed, it will then proceed to delete the application's appcache directories.  If that failed for some reason then there should be some evidence in the NM logs for this.  I have a hunch you are seeing the same thing as described in YARN-6846.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-08-22T14:33:36.455+0000","updated":"2017-08-22T14:33:36.455+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13096657/comment/16137740","id":"16137740","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"body":"Hi Lowe\n\nThanks for your comments. I checked the log of the application again. It seems that the application finished successfully without any WARNs and ERRORs.\nI found that those blockmgr*** directories refer to shuffle.ExternalShuffleBlockResolver, maybe something wrong happened during the shuffle process.\n\nI attached the log file and It would be very appreciated if you could take a look at it.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-23T01:40:24.589+0000","updated":"2017-08-23T01:40:24.589+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13096657/comment/16138296","id":"16138296","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shanekumpf%40gmail.com","name":"shanekumpf@gmail.com","key":"shanekumpf@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shane Kumpf","active":true,"timeZone":"America/Denver"},"body":"[~yechangyao] - The lack of clean up may be by design.\n\nFrom the log you provided:\n{code}\n2017-08-22 05:20:01,260 INFO org.apache.spark.network.shuffle.ExternalShuffleBlockResolver: Application application_1501810184023_55949 removed, cleanupLocalDirs = false\n{code}\n\nNote: cleanupLocalDirs = false.\n\nThe comment in the code here seems misleading as the false indicates that the local dirs shouldn't be cleaned up:\nhttps://github.com/apache/spark/blob/master/common/network-yarn/src/main/java/org/apache/spark/network/yarn/YarnShuffleService.java#L275\nhttps://github.com/apache/spark/blob/master/common/network-shuffle/src/main/java/org/apache/spark/network/shuffle/ExternalShuffleBlockResolver.java#L178\n\nAt this point, I don't believe this is a YARN bug. You'll want to reach out on the spark mailing lists to see if there might be away to configure the desired behavior.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shanekumpf%40gmail.com","name":"shanekumpf@gmail.com","key":"shanekumpf@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shane Kumpf","active":true,"timeZone":"America/Denver"},"created":"2017-08-23T12:40:26.514+0000","updated":"2017-08-23T12:40:26.514+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13096657/comment/16138597","id":"16138597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"bq. At this point, I don't believe this is a YARN bug.\n\nI disagree.  Even if the spark shuffle handler doesn't clean anything up, these files are underneath the application's appcache area in YARN.  The nodemanager is supposed to clean this up when the application completes regardless of what the auxiliary services are doing.\n\nFrom the log we see it at least tried to do this:\n{noformat}\n2017-08-22 05:20:01,260 INFO org.apache.hadoop.yarn.server.nodemanager.LinuxContainerExecutor: Deleting absolute path : /tmp/hadoop-yarn/nm-local-dir/usercache/hdfs/appcache/application_1501810184023_55949\n{noformat}\n\nThis looks a lot like the scenario that was fixed in YARN-6846, since the container is getting killed just as the application completes.  Note how close the two deletes are occurring near each other:\n{noformat}\n2017-08-22 05:20:01,260 INFO org.apache.hadoop.yarn.server.nodemanager.LinuxContainerExecutor: Deleting absolute path : /tmp/hadoop-yarn/nm-local-dir/usercache/hdfs/appcache/application_1501810184023_55949/container_e24_1501810184023_55949_01_000079\n2017-08-22 05:20:01,260 INFO org.apache.hadoop.yarn.server.nodemanager.containermanager.AuxServices: Got event APPLICATION_STOP for appId application_1501810184023_55949\n2017-08-22 05:20:01,260 INFO org.apache.spark.network.yarn.YarnShuffleService: Stopping application application_1501810184023_55949\n2017-08-22 05:20:01,260 INFO org.apache.spark.network.shuffle.ExternalShuffleBlockResolver: Application application_1501810184023_55949 removed, cleanupLocalDirs = false\n2017-08-22 05:20:01,260 INFO org.apache.hadoop.yarn.server.nodemanager.LinuxContainerExecutor: Deleting absolute path : /tmp/hadoop-yarn/nm-local-dir/usercache/hdfs/appcache/application_1501810184023_55949\n{noformat}\n\nThese two deletes are probably racing in parallel.  I highly recommend applying the patch from YARN-6846 and see if things improve.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-08-23T16:30:22.798+0000","updated":"2017-08-23T16:30:22.798+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13096657/comment/16139762","id":"16139762","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"body":"[~jlowe] [~shanekumpf@gmail.com]\n\nThank you guys so much.\nI'll try applying the patch from YARN-6846 first and let you know the problem solved or not.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-24T08:36:13.268+0000","updated":"2017-08-24T08:36:13.268+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13096657/comment/16143547","id":"16143547","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"body":"Hi\n\nI applied the patch YARN-6846, unfortunately the problem was not fixed.\nThose directories were not removed properly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-28T09:17:39.359+0000","updated":"2017-08-28T09:18:15.292+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13096657/comment/16143813","id":"16143813","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Hmm, at this point we cannot know for sure what's going on here without more information in the logs.  I'd recommend instrumenting the container-executor binary so it logs somewhere what it's doing during deletes to see if there's a clue why these directories aren't getting cleaned up.  For example, have it log each and every path it is trying to delete to see if there's a clue as to where it stops deleting or if it even tries to delete these paths that remain.  Also emitting a log at the end stating it completed successfully would help if there's some issue where it is actually crashing during deletes but the NM is not recognizing that properly and reporting it.\n\nAlso to clarify -- are these directories always getting left behind or only under certain circumstances (e.g.: only when an application or container is getting killed, etc.)?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-08-28T14:12:32.494+0000","updated":"2017-08-28T14:12:32.494+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13096657/comment/16153149","id":"16153149","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"body":"[~jlowe]\nSorry for the late reply.\nI've checked and compared the logs between successful jobs(which completed successfully and cleared cache dirs) and failed jobs(which completed successfully, but cannot delete cache dirs)  and found that there are WARNs occurred when abnormal cases happened. Just like the attachment file warn_logs.txt. \nI'm not sure this is reference to the problem or not. Please have a check.\n\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yechangyao","name":"yechangyao","key":"yechangyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yechangyao&avatarId=32518","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yechangyao&avatarId=32518","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yechangyao&avatarId=32518","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yechangyao&avatarId=32518"},"displayName":"Changyao Ye","active":true,"timeZone":"Etc/UTC"},"created":"2017-09-05T06:20:27.462+0000","updated":"2017-09-05T07:03:50.444+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13096657/comment/16153633","id":"16153633","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"body":"Those warnings are \"normal\" and are a result of the container being killed by YARN.  Exit code 143 is a result of the bash process being killed by SIGTERM.  SIGTERM is signal 15, and bash returns with an exit code of 128 + signalnum when killed by a signal.  128 + 15 = 143.\n\nSo it sounds like this only happens when a container is getting killed?  Does it always happen when a container is killed or only when a container is killed just as the application completes as well (e.g.: container is getting killed because application was killed)?  I suspect this is only happening when apps are getting killed and the app dir delete is racing with the container delete, but that should have been fixed by YARN-6846.  Are you sure there are no similar container executor warnings in the NM logs regarding the deletion command processing?  If the container executor is failing to cleanup a directory I would expect it to exit with a non-zero exit code which should result in similar WARN logs in the NM as you posted above, although instead of being command 1 (the third argument to the executor) it would be command 3.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlowe","name":"jlowe","key":"jlowe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Lowe","active":true,"timeZone":"America/Chicago"},"created":"2017-09-05T13:25:46.437+0000","updated":"2017-09-05T13:25:46.437+0000"}],"maxResults":9,"total":9,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/YARN-7070/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3j4nj:"}}