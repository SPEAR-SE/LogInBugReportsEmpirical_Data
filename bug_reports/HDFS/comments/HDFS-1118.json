[Great catch, Zheng! I've seen leaked sockets before but never been able to figure out what the cause was., This patch does not have a unit test yet. Not sure what is the best way to write one for this.
, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12443148/HDFS-1118.1.patch
  against trunk revision 939091.

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    -1 patch.  The patch command could not apply the patch.

Console output: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/165/console

This message is automatically generated., +1 good catch. awesome!, Moved the cleanup to finally section., Hey Zheng. I was just running into this problem and then remembered that you put this patch up a while back.

Why not just add an IOUtils.closeSocket() call inside the IOException catch clause, instead of adding the finally {} clause?, Marking this for 0.20-append, Code looks good to me. I will commit this to trunk., Patch for apache hadop trunk.

Todd: the finally clause should not hurt, will catch all types of exceptions and cleanup the socket.

Looks ok without a unit test, because the code is simple and I agree with Zheng that it is difficult to write a unit test, I just committed this. Thanks Zheng., Integrated in Hadoop-Hdfs-trunk-Commit #315 (See [http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk-Commit/315/])
    HDFS-1118. Fix socketleak on DFSClient. 
(Zheng Shao via dhruba)
, This bug also affects version 0.21.0, Merge patch from 0.20-append to 0.20-security, +1 for hdfs-1118.20s.patch, I have committed the patch to 0.20-security branch., Closed upon release of 0.20.205.0]