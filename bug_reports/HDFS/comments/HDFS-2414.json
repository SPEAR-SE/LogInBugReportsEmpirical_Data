[Interesting. Do you have the full logs for either of these cases? Can you verify that these failures are new in 23 vs 22 or 20?, I have the full logs for 1039 runs, of which 28 failed.  I will upload the logs for a couple of them.  I have not tried it on 22 or 20 yet.  I have some on-call stuff I have to slug through before I can spend the time trying to get that to happen., Here are the logs, run-106 corresponds to the first failure (The diff failure) and 158 corresponds to the second failure., Thanks. I'm also looping this here, haven't seen a failure yet. I'll take a look at your logs., I found one source of the test failure: the VERSION file contains a timestamp at the top, which could be different between the different directories. The md5sum check of course does not ignore this line in the file. This is the top (more common) failure., Another data point is that either our internal Jenkins build has hit this failure twice in a row.  It might be that it is just very un-lucky, I really don't know., Here's a test fix that addresses the issue of timestamp comparison. Will look into the unicode-related one now., Wow that was fast., I managed to reproduce the other failure too... I see this in one of the VERSION files:
{code}
CFºE ^Utt<8c>áÃ 1&:45:à2OüØT <8d><8d>11Þ^YÙmespacd"a=054a0Ç3¯<8d>3
æ\uÉt·r^FD=^_ºstCl<98>stërIâ
cwime^S<99>
sto:aÆeTypr¨MA6E^DNOjEg_Ëo^[k^RoflID=£P-15<94>32Í073^QkÚ27.<82>.0ÆO-1Y+1020pðIA<9f>î
Eayout<9f>erÌ_<83>n¸-38o
{code}

wow... putting my thinking cap on here., Sorry I cannot be more help on this, I really don't know the Rollback code at all.  I have a script and I am trying to reproduce it on 0.20 and 0.22 though.  Will let you know how it goes., oh... this is also just a test issue - this part of the test case calls UpgradeUtilities.corruptFile to corrupt one of the VERSION files, and then expects that it fails with a certain exception string. Instead, we're failing with a different exception because we've corrupted it in non-UTF8-compliant way.

I think the fix is probably to catch this kind of exception when reading a storage file and rethrow as an IOException, then change the test to expect either type of error., Attached fix for the other error. The problem was that in the corrupted file, we happened to corrupt in such a way that we got a "\uxxxx" sequence with some random junk after the "\u". Very improbably but it happens :) This caused the IAE to be thrown.

This patch changes the code to corrupt the file in a deterministic way to check exactly the expected code path., sorry, some unused imports in previous patch. this one's good to go., +1 for the fix (non-binding) I am happy to see that the corruption to the file is now deterministic Throwing random data at code is good for testing, but it needs to be reproducible with a random seed or something.

Thanks for jumping on this so quickly., +1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12498244/hdfs-2414.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 12 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in .

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/1355//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/1355//console

This message is automatically generated., +1, looks good to me., committed to trunk and 23. Nice find :), Integrated in Hadoop-Common-trunk-Commit #1045 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/1045/])
    HDFS-2414. Fix TestDFSRollback to avoid spurious failures. Contributed by Todd Lipcon.

todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1180541
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSRollback.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSUpgrade.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/UpgradeUtilities.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
, Integrated in Hadoop-Hdfs-trunk-Commit #1123 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/1123/])
    HDFS-2414. Fix TestDFSRollback to avoid spurious failures. Contributed by Todd Lipcon.

todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1180541
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSRollback.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSUpgrade.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/UpgradeUtilities.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
, Integrated in Hadoop-Mapreduce-trunk-Commit #1065 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/1065/])
    HDFS-2414. Fix TestDFSRollback to avoid spurious failures. Contributed by Todd Lipcon.

todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1180541
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSRollback.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSUpgrade.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/UpgradeUtilities.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
, Integrated in Hadoop-Hdfs-trunk #825 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/825/])
    HDFS-2414. Fix TestDFSRollback to avoid spurious failures. Contributed by Todd Lipcon.

todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1180541
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSRollback.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSUpgrade.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/UpgradeUtilities.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
, Integrated in Hadoop-Hdfs-0.23-Build #34 (See [https://builds.apache.org/job/Hadoop-Hdfs-0.23-Build/34/])
    HDFS-2414. Fix TestDFSRollback to avoid spurious failures. Contributed by Todd Lipcon.

todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1180540
Files : 
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSRollback.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSUpgrade.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/UpgradeUtilities.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
, Integrated in Hadoop-Mapreduce-0.23-Build #41 (See [https://builds.apache.org/job/Hadoop-Mapreduce-0.23-Build/41/])
    HDFS-2414. Fix TestDFSRollback to avoid spurious failures. Contributed by Todd Lipcon.

todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1180540
Files : 
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSRollback.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSUpgrade.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/UpgradeUtilities.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
, Integrated in Hadoop-Mapreduce-trunk #855 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/855/])
    HDFS-2414. Fix TestDFSRollback to avoid spurious failures. Contributed by Todd Lipcon.

todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1180541
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSRollback.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSUpgrade.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/UpgradeUtilities.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
]