[  <testcase time="0.013" classname="org.apache.hadoop.hdfs.server.namenode.TestSnapshotPathINodes" name="testAllowSnapshot">
    <failure type="java.lang.AssertionError">java.lang.AssertionError
        at org.junit.Assert.fail(Assert.java:92)
        at org.junit.Assert.assertTrue(Assert.java:43)
        at org.junit.Assert.assertFalse(Assert.java:68)
        at org.junit.Assert.assertFalse(Assert.java:79)
        at org.apache.hadoop.hdfs.server.namenode.TestSnapshotPathINodes.testAllowSnapshot(TestSnapshotPathINodes.java:91)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:601)
        at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:45)
        at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
        at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:42)
        at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
        at org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:62)
</failure>
, Thanks for the report Ravi! 

For the test, I could not reproduce the failure in my local test. Could you please attach the complete test output?, Thanks for the quick response Jing! Here are the logs from my run. Were you using JDK7?, I also faced this problem with JDK7 + Ubuntu.

{code}
Running org.apache.hadoop.hdfs.server.namenode.TestSnapshotPathINodes
Tests run: 6, Failures: 2, Errors: 0, Skipped: 0, Time elapsed: 5.285 sec <<< FAILURE! - in org.apache.hadoop.hdfs.server.namenode.TestSnapshotPathINodes
testAllowSnapshot(org.apache.hadoop.hdfs.server.namenode.TestSnapshotPathINodes)  Time elapsed: 0.006 sec  <<< FAILURE!
java.lang.AssertionError: null
	at org.junit.Assert.fail(Assert.java:92)
	at org.junit.Assert.assertTrue(Assert.java:43)
	at org.junit.Assert.assertFalse(Assert.java:68)
	at org.junit.Assert.assertFalse(Assert.java:79)
	at org.apache.hadoop.hdfs.server.namenode.TestSnapshotPathINodes.testAllowSnapshot(TestSnapshotPathINodes.java:91)
{code}, testNonSnapshotPathNodes also failed in the same environment.

{code}
testNonSnapshotPathINodes(org.apache.hadoop.hdfs.server.namenode.TestSnapshotPathINodes)  Time elapsed: 0.002 sec  <<< FAILURE!
java.lang.AssertionError: expected:<null> but was:<Snapshot.s3(id=3)>
	at org.junit.Assert.fail(Assert.java:93)
	at org.junit.Assert.failNotEquals(Assert.java:647)
	at org.junit.Assert.assertEquals(Assert.java:128)
	at org.junit.Assert.assertEquals(Assert.java:147)
	at org.apache.hadoop.hdfs.server.namenode.TestSnapshotPathINodes.assertSnapshot(TestSnapshotPathINodes.java:124)
	at org.apache.hadoop.hdfs.server.namenode.TestSnapshotPathINodes.testNonSnapshotPathINodes(TestSnapshotPathINodes.java:149)
{code}, Attaching patch for Trunk/Branch-2, {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12617252/HDFS-5023.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5650//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5650//console

This message is automatically generated., Mit, Thanks for the patch. Looks like you have left some debugging code in the patch submitted. 

//testSnapshotPathINodesAfterModification();
, Thanks Jon for the comments. Uploading the updated patch., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12617446/HDFS-5023.patch
  against trunk revision .

    {color:red}-1 patch{color}.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5664//console

This message is automatically generated., Invalid patch updated., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12617455/HDFS-5023.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5665//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5665//console

This message is automatically generated., Thanks for the fix Mit! So could you please also comment the cause of the failure? This can help us prevent similar issue in the future., Sure Jing.
-Main reason for the test failure was JAVA Version. The test were written keeping in mind the nature of Java 6 where it would work fine. But with Java 7 running the tests in a random order, the tests would start failing.
-The test creates files/snapshots during the entire test series. The problem was not cleaning these up.
-When a test that created a snapshot ends, it was not actually deleting the snapshot and that was being misinterpreted by the test that would be running next and the assert was failing due to inconsistent values.
-I think, making sure that the tests are independent of each other and that every test that makes any modification is just limited to that test would not give rise to such issues in future., Thanks Mit! Your explanation is very helpful. 

So since the current patch deletes snapshot for every test case, how about always using the same snapshot name, and moving "delete-snapshot" and "disallow-snapshot" code to an "After" method? This can make the code more clean., Jing,
I have tried making the changes according your suggestion. That would work but this will cause problem with the two tests i) testAllowSnapshot ii) testNonSnapshotPathINodes.
-These two tests does not create snapshots, so moving the "disallowSnapshot" and "deleteSnapshot" lines to "After" method, will throw an exception after their completion.

-As a fix to that, we will have to create an unnecessary snapshot after these tests.
-Or another fix would be to place the "disallowSnapshot" and "deleteSnapshot" lines in a try block and we don't do anything in the catch block ( This is just an additional option. But it does not seem to be good choice to me ).

But, I think that none of these solutions can be good to go. What do you think?, +1. Jing. If I don't hear anything on this issue today, I'll check this in tomorrow., +1. Thanks Mit!, SUCCESS: Integrated in Hadoop-trunk-Commit #4868 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/4868/])
HDFS-5023. TestSnapshotPathINodes.testAllowSnapshot is failing with jdk7 (Mit Desai via jeagles) (jeagles: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1550261)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestSnapshotPathINodes.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1610 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1610/])
HDFS-5023. TestSnapshotPathINodes.testAllowSnapshot is failing with jdk7 (Mit Desai via jeagles) (jeagles: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1550261)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestSnapshotPathINodes.java
, FAILURE: Integrated in Hadoop-Yarn-trunk #420 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/420/])
HDFS-5023. TestSnapshotPathINodes.testAllowSnapshot is failing with jdk7 (Mit Desai via jeagles) (jeagles: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1550261)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestSnapshotPathINodes.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1637 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1637/])
HDFS-5023. TestSnapshotPathINodes.testAllowSnapshot is failing with jdk7 (Mit Desai via jeagles) (jeagles: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1550261)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestSnapshotPathINodes.java
]