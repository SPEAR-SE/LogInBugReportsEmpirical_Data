[Patch attached for review. Fix the bug and add a warning message when quota is violated. I have tested on my cluster and it works ok. I will add a test case soon, maybe in TestAbandonBlock.java. Any suggestions?, New patch attached with test case. Run Hudson., Found another quota bug when testing the patch. Diskspace reduced twice when completing file. I think it is related to HDFS-1377. 

Linked with HDFS-1377. I will attach a new patch soon to fix this., +1   Good catch Zhong.

Patch attached is rebased against HDFS-1507, I made the test junit4 style. Also removed the warning in FSDirectory; the patch I wrote for HDFS-1377 has an something which we can discuss there or in a separate jira., I forgot to add that in my patch I pass true for checkQuota, since it should be checked by default (not that it would necessarily fire here since we're subtracting from the quota)., {noformat}
     [exec] 
     [exec] -1 overall.  
     [exec] 
     [exec]     +1 @author.  The patch does not contain any @author tags.
     [exec] 
     [exec]     +1 tests included.  The patch appears to include 3 new or modified tests.
     [exec] 
     [exec]     +1 javadoc.  The javadoc tool did not generate any warning messages.
     [exec] 
     [exec]     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.
     [exec] 
     [exec]     +1 findbugs.  The patch does not introduce any new Findbugs warnings.
     [exec] 
     [exec]     -1 release audit.  The applied patch generated 103 release audit warnings (more than the trunk's current 1 warnings).
     [exec] 
     [exec]     +1 system test framework.  The patch passed system test framework compile.
     [exec] 
{noformat}

Release audit is not due to this patch., I've committed this.  Will merge to 22 when the branch has been created. Thanks Zhong!, Committed to branch 22. , Patch for branch 20 attached.]