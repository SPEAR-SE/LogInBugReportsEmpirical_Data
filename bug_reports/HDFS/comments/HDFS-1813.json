[This is federation-branch only, right?, The problem #2 is related to federation, but others exist in trunk also. I will first fix it in federation branch. I will mark this jira for federation branch., +1 patch looks good. Now we are consistently setting block access token for the last block reported in LocatedBlock. This may not be required for the completed file, however from consistency point of view, your change makes sense.

Comments:
# Please add/modify existing unit test for checking token is set for last block.
# Please add/modify unit test to check for READ access., New patch adds a unit test., Added a unit test for checking token in last block.

Unit test for READ access in getReplicaVisibleLength is difficult because this method gets the access mode from the authenticated BlockTokenIdentifier. Since security is disabled we can't get an authenticated identifier. However, we already have tests to test if access modes are correctly set in the block tokens., Minor comment: Can you please add some description to the test as to what you are testing. This helps a lot in fixing test failures., One additional comment - can you please create a file name set to the test name instead of afile., New patch addressing the comments., +1 for the patch,      [exec] +1 overall.
     [exec]
     [exec]     +1 @author.  The patch does not contain any @author tags.
     [exec]
     [exec]     +1 tests included.  The patch appears to include 3 new or modified tests.
     [exec]
     [exec]     +1 javadoc.  The javadoc tool did not generate any warning messages.
     [exec]
     [exec]     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.
     [exec]
     [exec]     +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.
     [exec]
     [exec]     +1 release audit.  The applied patch does not increase the total number of release audit warnings.
     [exec]
     [exec]     +1 system test framework.  The patch passed system test framework compile.
, I have committed this to the branch., The following code added:
{noformat}
      if(isBlockTokenEnabled && needBlockToken) {
        setBlockTokens(locatedblocks);
      }

      LocatedBlock lastBlock = last.isComplete() ? blockManager
          .getBlockLocation(last, n - last.getNumBytes()) : blockManager
          .getBlockLocation(last, n);
      setBlockToken(lastBlock);
{noformat}
causes a problem. setBlockToken() should be called if isBlockTokenEnabled && needBlockToken is true., Reverted the commit., Updated patch addressing the comment., +1 for the patch., Committed the latest patch.]