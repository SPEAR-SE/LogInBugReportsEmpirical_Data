[Based on HDFS-11529 fix version, I updated the affected version field accordingly. Please let me know if this should be updated., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 48s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 15m 37s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 16s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 12s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 14s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 11s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} cc {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 11s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  0m 39s{color} | {color:green} hadoop-hdfs-native-client in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 21s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 19m 59s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:14b5c93 |
| JIRA Issue | HDFS-11851 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12868818/HDFS-11851.000.patch |
| Optional Tests |  asflicense  compile  cc  mvnsite  javac  unit  |
| uname | Linux ec3c446a5b22 3.13.0-108-generic #155-Ubuntu SMP Wed Jan 11 16:58:52 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 40e6a85 |
| Default Java | 1.8.0_131 |
|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/19499/testReport/ |
| modules | C: hadoop-hdfs-project/hadoop-hdfs-native-client U: hadoop-hdfs-project/hadoop-hdfs-native-client |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/19499/console |
| Powered by | Apache Yetus 0.5.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Very non-trivial to add a test for this bug., For Linux, initialize {{jvmMutex}} to {{PTHREAD_RECURSIVE_MUTEX_INITIALIZER}}. Windows critical section object is already re-entrant., [~jzhuge] Done. I used the non-portable version PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP since PTHREAD_RECURSIVE_MUTEX_INITIALIZER was not recognized., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 17s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 12m 14s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 22s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 11s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 11s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m  9s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 11s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} cc {color} | {color:green}  0m 11s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 11s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  0m 47s{color} | {color:green} hadoop-hdfs-native-client in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 16s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 15m 55s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:14b5c93 |
| JIRA Issue | HDFS-11851 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12868844/HDFS-11851.001.patch |
| Optional Tests |  asflicense  compile  cc  mvnsite  javac  unit  |
| uname | Linux bbbe1322fe9d 4.4.0-43-generic #63-Ubuntu SMP Wed Oct 12 13:48:03 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / b4adc83 |
| Default Java | 1.8.0_131 |
|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/19500/testReport/ |
| modules | C: hadoop-hdfs-project/hadoop-hdfs-native-client U: hadoop-hdfs-project/hadoop-hdfs-native-client |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/19500/console |
| Powered by | Apache Yetus 0.5.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Thanks [~sailesh]. Could we add a few unit tests?, [~jzhuge] Apologies for the slow response. It seems non-trivial to add tests for this fix.

One way to add it would be to add some functions only for the sake of testing to expose these mutexes to the test files and try to recursively lock and unlock. What do you think?, Sounds good. Simple unit tests to ensure {{printExceptionAndFree}} etc. can be called with {{jvmMutex}} locked., [~jzhuge] Thanks. I've just submitted a patch that does that. I've verified that it works locally. Also, if I change the mutex to a regular non-recursive mutex, I've verified that the test hangs., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 42s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 13m 59s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 16s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 13s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 13s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} cc {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  0m 35s{color} | {color:green} hadoop-hdfs-native-client in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 17s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 17m 52s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:14b5c93 |
| JIRA Issue | HDFS-11851 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12869928/HDFS-11851.002.patch |
| Optional Tests |  asflicense  compile  cc  mvnsite  javac  unit  |
| uname | Linux 98a1b99472d2 3.13.0-116-generic #163-Ubuntu SMP Fri Mar 31 14:13:22 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 2b5ad48 |
| Default Java | 1.8.0_131 |
|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/19617/testReport/ |
| modules | C: hadoop-hdfs-project/hadoop-hdfs-native-client U: hadoop-hdfs-project/hadoop-hdfs-native-client |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/19617/console |
| Powered by | Apache Yetus 0.5.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Thanks for adding the unit test.

Discovered the patch didn't compile on Mac because Mac has {{PTHREAD_RECURSIVE_MUTEX_INITIALIZER}} but not {{PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP}}. If we'd like to support Mac, there may be 2 choices:

1) #ifdef
{code}
diff --git a/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/os/posix/mutexes.c b/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/os/posix/mutexes.c
index c4c2f262135..a4e0e46d4a9 100644
--- a/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/os/posix/mutexes.c
+++ b/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/os/posix/mutexes.c
@@ -22,7 +22,11 @@
 #include <stdio.h>

 mutex hdfsHashMutex = PTHREAD_MUTEX_INITIALIZER;
-mutex jvmMutex = PTHREAD_MUTEX_INITIALIZER;
+#if defined __APPLE__ && defined __MACH__
+mutex jvmMutex = PTHREAD_RECURSIVE_MUTEX_INITIALIZER;
+#else
+mutex jvmMutex = PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP;
+#endif

 int mutexLock(mutex *m) {
   int ret = pthread_mutex_lock(m);
{code}

2) Use {{pthread_mutexattr_settype(&mta, PTHREAD_MUTEX_RECURSIVE);}} but this means we need to add a static initializer.
{code}
diff --git a/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/os/posix/mutexes.c b/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/
index c4c2f26..d6ad5cd 100644
--- a/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/os/posix/mutexes.c
+++ b/hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/os/posix/mutexes.c
@@ -22,7 +22,14 @@
 #include <stdio.h>

 mutex hdfsHashMutex = PTHREAD_MUTEX_INITIALIZER;
-mutex jvmMutex = PTHREAD_MUTEX_INITIALIZER;
+mutex jvmMutex;
+mutex jvmMutexAttr;
+
+__attribute__((constructor)) static void init() {
+  pthread_mutexattr_init(&jvmMutexAttr);
+  pthread_mutexattr_settype(&jvmMutexAttr, PTHREAD_MUTEX_RECURSIVE);
+  pthread_mutex_init(&jvmMutex, &jvmMutexAttr);
+}

 int mutexLock(mutex *m) {
   int ret = pthread_mutex_lock(m);
{code}

Tested both methods on Mac and Centos 7.2., Hi [~sailesh], are you planning to rev based on John's review comment? It's marked as a blocker, so I'd like to get it in., [~andrew.wang] [~jzhuge] Sorry this fell off my radar. Will post the updated patch shortly.

Thanks for the review John. I went with the second method of using the static mutex initializer as it seems a lot more clean to do it that way., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 35s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 16m 49s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 20s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 15s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 12s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 17s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} cc {color} | {color:red}  0m 17s{color} | {color:red} hadoop-hdfs-project_hadoop-hdfs-native-client generated 36 new + 0 unchanged - 0 fixed = 36 total (was 0) {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 17s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 12s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  0m 43s{color} | {color:green} hadoop-hdfs-native-client in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 22s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 20m 59s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:14b5c93 |
| JIRA Issue | HDFS-11851 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12871882/HDFS-11851.003.patch |
| Optional Tests |  asflicense  compile  cc  mvnsite  javac  unit  |
| uname | Linux 2931ba9d027e 3.13.0-108-generic #155-Ubuntu SMP Wed Jan 11 16:58:52 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 24181f5 |
| Default Java | 1.8.0_131 |
| cc | https://builds.apache.org/job/PreCommit-HDFS-Build/19827/artifact/patchprocess/diff-compile-cc-hadoop-hdfs-project_hadoop-hdfs-native-client.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/19827/testReport/ |
| modules | C: hadoop-hdfs-project/hadoop-hdfs-native-client U: hadoop-hdfs-project/hadoop-hdfs-native-client |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/19827/console |
| Powered by | Apache Yetus 0.5.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, [~sailesh] The "cc" failure for patch 003 is caused by a typo in my sample code. The type of {{jvmMutexAttr}} should be {{pthread_mutexattr_t}} not {{mutex}}:
{code}
pthread_mutexattr_t jvmMutexAttr;
{code}, [~jzhuge] Thanks! Oddly enough, it didn't throw that warning locally. I incorrectly assumed it may have been a portability issue. I made that change in the latest patch., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 17s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  1s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 13m 14s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 16s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 13s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m  9s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} cc {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  0m 31s{color} | {color:green} hadoop-hdfs-native-client in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 18s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 16m 24s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:14b5c93 |
| JIRA Issue | HDFS-11851 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12871963/HDFS-11851.005.patch |
| Optional Tests |  asflicense  compile  cc  mvnsite  javac  unit  |
| uname | Linux d76918db1020 3.13.0-106-generic #153-Ubuntu SMP Tue Dec 6 15:44:32 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 5672ae7 |
| Default Java | 1.8.0_131 |
|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/19829/testReport/ |
| modules | C: hadoop-hdfs-project/hadoop-hdfs-native-client U: hadoop-hdfs-project/hadoop-hdfs-native-client |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/19829/console |
| Powered by | Apache Yetus 0.5.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, +1 LGTM. Will commit tomorrow if no objection., Committed to trunk.

Thanks [~sailesh] for the contribution., SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #11845 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/11845/])
HDFS-11851. getGlobalJNIEnv() may deadlock if exception is thrown. (jzhuge: rev 164c222c4aa697c3acbaa6f34c59a23177d7f3cd)
* (edit) hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs-tests/test_libhdfs_threaded.c
* (edit) hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/os/posix/mutexes.c
, Would it be possible to backport this patch to HDFS 2.6 ? Thanks., This fixes a deadlock introduced by HDFS-11529 which is only in trunk, not in 2.6., [~jzhuge], I have following exception that matches HDFS-11851, doesn't it? See below:

{code}
$ gdb -p 8248
GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-94.el7
....  /cut/   
(gdb)
(gdb) bt
#0  0x00007fddd9f141bd in __lll_lock_wait () from /lib64/libpthread.so.0
#1  0x00007fddd9f0fd02 in _L_lock_791 () from /lib64/libpthread.so.0
#2  0x00007fddd9f0fc08 in pthread_mutex_lock () from /lib64/libpthread.so.0
#3  0x00007fddda9f3e26 in mutexLock () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#4  0x00007fddda9ed6f1 in setTLSExceptionStrings () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#5  0x00007fddda9ec38c in printExceptionAndFreeV () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#6  0x00007fddda9ec52d in printExceptionAndFree () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#7  0x00007fddda9ed46b in getJNIEnv () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#8  0x00007fddda9eee94 in hdfsBuilderConnect () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#9  0x0000000000400950 in main ()

{code}

It is from a Hadoop-2.6 based distribution of Hadoop (CDH 5.10)., After applying this patch program started core dumping - here's gdb back trace 

{code}
(gdb) bt
#0  0x00007fe78a34b1d7 in raise () from /lib64/libc.so.6
#1  0x00007fe78a34c8c8 in abort () from /lib64/libc.so.6
#2  0x00007fe78b212185 in os::abort(bool) () from /usr/java/default/jre/lib/amd64/server/libjvm.so
#3  0x00007fe78b3b4593 in VMError::report_and_die() () from /usr/java/default/jre/lib/amd64/server/libjvm.so
#4  0x00007fe78b21768f in JVM_handle_linux_signal () from /usr/java/default/jre/lib/amd64/server/libjvm.so
#5  0x00007fe78b20dbe3 in signalHandler(int, siginfo*, void*) () from /usr/java/default/jre/lib/amd64/server/libjvm.so
#6  <signal handler called>
#7  0x00007fe78a6db8b0 in setTLSExceptionStrings () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#8  0x00007fe78a6da52c in printExceptionAndFreeV () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#9  0x00007fe78a6da6cd in printExceptionAndFree () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#10 0x00007fe78a6db60b in getJNIEnv () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#11 0x00007fe78a6dd034 in hdfsBuilderConnect () from /opt/cloudera/parcels/CDH/lib64/libhdfs.so.0.0.0
#12 0x0000000000400950 in main ()
{code}

As you can see it happens in setTLSExceptionStrings () so definitely related to this patch. 
I can upload a hs_err*.log log file if it will be helpful.
, Please upload hs_err*.log. Probably a SEGV in setTLSExceptionStrings., [~jzhuge], please have a look at https://github.com/Tagar/shared/blob/master/hs_err_pid18963.log thanks, This NoClassDefFoundError indicates misconfigured classpath for hadoop-common jar:
{noformat}
Event: 0.067 Thread 0x0000000000e00000 Exception <a 'java/lang/NoClassDefFoundError': org/apache/hadoop/fs/FileSystem> (0x0000000580169ab0) thrown at [/HUDSON3/workspace/8-2-build-linux-amd64/jdk8u141/9370/hotspot/src/share/vm/classfile/systemDictionary.cpp, line 199]
{noformat}
Could you please double check {{CLASSPATH}} to make sure hadoop-common jar can be found?
, [~jzhuge], yes I did {{export CLASSPATH=`hadoop classpath`}} before so 
{{CLASSPATH}} does have all required jars including {{hadoop-common.jar}}
I think some elements of that hs_err..log file are misleading as it shows internal events including when the classes were discovered, 
for example,
{noformat}
Event: 0.067 Thread 0x0000000000e00000 Exception <a 'java/lang/NoClassDefFoundError': org/apache/hadoop/fs/FileSystem> (0x0000000580169ab0) thrown at [/HUDSON3/workspace/8-2-build-linux-amd64/jdk8u141/9370/hotspot/src/share/vm/classfile/systemDictionary.cpp, line 199]
Event: 0.067 Thread 0x0000000000e00000 Exception <a 'java/lang/NoClassDefFoundError': org/apache/commons/lang/exception/ExceptionUtils> (0x000000058016c1f0) thrown at [/HUDSON3/workspace/8-2-build-linux-amd64/jdk8u141/9370/hotspot/src/share/vm/classfile/systemDictionary.cpp, line 199]
Event: 0.068 Thread 0x0000000000e00000 Exception <a 'java/lang/NoClassDefFoundError': org/apache/commons/lang/exception/ExceptionUtils> (0x000000058016e708) thrown at [/HUDSON3/workspace/8-2-build-linux-amd64/jdk8u141/9370/hotspot/src/share/vm/classfile/systemDictionary.cpp, line 199]
{noformat}

but then right down below you see 
{noformat}
Event: 0.066 loading class java/io/FileNotFoundException
Event: 0.066 loading class java/io/IOException
Event: 0.066 loading class java/io/IOException done
Event: 0.066 loading class java/io/FileNotFoundException done
Event: 0.066 loading class java/security/PrivilegedActionException
Event: 0.066 loading class java/security/PrivilegedActionException done
Event: 0.067 loading class org/apache/commons/lang/exception/ExceptionUtils
Event: 0.067 loading class org/apache/commons/lang/exception/ExceptionUtils done
Event: 0.067 loading class org/apache/commons/lang/exception/ExceptionUtils
Event: 0.067 loading class org/apache/commons/lang/exception/ExceptionUtils done
{noformat}

Notice {{org/apache/commons/lang/exception/ExceptionUtils}} for example list twice in that "Internal exceptions (10 events)" section, but then shown as loaded fine in "Events (10 events)" section. So I think "Internal exceptions" is misleading? 

, You are right because "/opt/cloudera/parcels/CDH-5.12.1-1.cdh5.12.1.p2550.2807/lib/hadoop/libexec/../../hadoop/.//*" should point to hadoop-common jar:
{noformat}
# ls /opt/cloudera/parcels/CDH-5.12.1-1.cdh5.12.1.p2550.2807/lib/hadoop/libexec/../../hadoop/.//hadoop-common*jar
/opt/cloudera/parcels/CDH-5.12.1-1.cdh5.12.1.p2550.2807/lib/hadoop/libexec/../../hadoop/.//hadoop-common-2.6.0-cdh5.12.1.jar
/opt/cloudera/parcels/CDH-5.12.1-1.cdh5.12.1.p2550.2807/lib/hadoop/libexec/../../hadoop/.//hadoop-common-2.6.0-cdh5.12.1-tests.jar
/opt/cloudera/parcels/CDH-5.12.1-1.cdh5.12.1.p2550.2807/lib/hadoop/libexec/../../hadoop/.//hadoop-common.jar
/opt/cloudera/parcels/CDH-5.12.1-1.cdh5.12.1.p2550.2807/lib/hadoop/libexec/../../hadoop/.//hadoop-common-tests.jar
{noformat}

How did you hit the exception? Please set "ulimit -c unlimited" before reproducing the issue in order to generate a core dump. Upload the core dump or run "gdb <exec> <core>" and then "bt" to get the stack trace., Got a similar SEGV. Details in https://gist.github.com/jzhuge/23f6e058e1035528c86a383ad80dbb3f.

hs_err_pid14147.log: https://gist.github.com/jzhuge/106d87f10ec1bf6671b65cd8fad55ff8, {quote}
Please set "ulimit -c unlimited" before reproducing the issue in order to generate a core dump. Upload the core dump or run "gdb <exec> <core>" and then "bt" to get the stack trace.
{quote}

I already did .. a few days days ago and posted `bt` output [here|https://issues.apache.org/jira/browse/HDFS-11851?focusedCommentId=16166959&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16166959].

{quote}Got a similar SEGV{quote}
Thanks [~jzhuge]! Glad it wasn't something in our environment that caused this., [~Tagar] CLASSPATH for libhdfs doesn't support wildcard. Try this:
{noformat}
export CLASSPATH=$(hadoop classpath --glob)
{noformat}

The SEGV is a new issue. I will file a separate JIRA., Filed HDFS-12491 Support wildcard in CLASSPATH for libhdfs., Filed HDFS-12494 libhdfs SIGSEGV in setTLSExceptionStrings., thank you [~jzhuge]]