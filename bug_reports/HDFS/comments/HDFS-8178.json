[In this patch an in-progress edit file is considered stale if there's another in-progress edit file with a larger tx ID. Alternatively we can have a more aggressive policy and use the max tx ID in all finalized or in-progress edit files as the threshold. , \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  14m 38s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:green}+1{color} | tests included |   0m  0s | The patch appears to include 1 new or modified test files. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | javac |   7m 25s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 36s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 23s | The applied patch does not increase the total number of release audit warnings. |
| {color:red}-1{color} | checkstyle |   7m 15s | The applied patch generated  1  additional checkstyle issues. |
| {color:green}+1{color} | install |   1m 35s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   3m  5s | The patch does not introduce any new Findbugs (version 2.0.3) warnings. |
| {color:green}+1{color} | native |   3m 12s | Pre-build of native portion |
| {color:red}-1{color} | hdfs tests | 164m 31s | Tests failed in hadoop-hdfs. |
| | | 212m 16s | |
\\
\\
|| Reason || Tests ||
| Failed unit tests | hadoop.hdfs.TestEncryptionZonesWithKMS |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12727464/HDFS-8178.000.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / 0ebe84d |
| checkstyle | https://builds.apache.org/job/PreCommit-HDFS-Build/10350/artifact/patchprocess/checkstyle-result-diff.txt |
| hadoop-hdfs test log | https://builds.apache.org/job/PreCommit-HDFS-Build/10350/artifact/patchprocess/testrun_hadoop-hdfs.txt |
| Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/10350/testReport/ |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/10350//console |


This message was automatically generated., {{TestEncryptionZonesWithKMS}} is unrelated and passes locally., Hi Zhe, thanks a lot for posting this patch. It looks pretty good to me. I have one comment, and one question for you:

Comment: I'm a tad concerned that the current patch be be over aggressive in terms of purging edit log segments, if somehow we ended up with two in-progress segments, both of which were required to form the complete history of edit log transactions. Unless we're somehow guaranteed that that's not a state we could end up in, I think we should do something to guarantee that the in-progress edits file(s) that we're considering purging definitely overlap with finalized edit log segments so that they don't contain any edits that we can't afford to lose. Or, perhaps we should move them aside with a different name until such time as we can be sure that we don't need their transactions anymore, i.e. their transaction is less than minTxIdToKeep, and so we can definitely safely discard them.

Question: In the patch for HDFS-5919, we introduced a new regex for identifying stale in-progress files. I'm not familiar with why that was necessary in that patch, but can you please comment on why it's not necessary in this case? Naively, I'd expect either both or neither the FJM and JN to require accounting for that., Thanks ATM for the helpful review! After looking at HDFS-5919 more closely, we are actually trying to solve a different problem here. The objective of HDFS-5919 is sorely to save disk space (since FJM doesn't try to process those corrupt/empty files anyway). It's a safe cleanup, making sure the tx ID of empty / corrupt files are old enough before purging. So I think we should do the same in QJM.

Our main target here is _stale_ in-progress edit log files, which are not necessarily empty/corrupt (so they won't be mark as so). As the updated description states, we want to properly take care of those files so QJM doesn't try to process them. I like your proposal of rename / move aside those files and remove them when they are older than {{minTxIdToKeep}}. I'll update the patch based on this idea.

I also propose we do the same for corrupt / empty files, for both FJM and QJM. , Oops last paragraph was added by mistake, please ignore it., We can also combine this patch with HDFS-8303 and close one of them as dup., Combined with HDFS-8303 patch., \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  14m 54s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:green}+1{color} | tests included |   0m  0s | The patch appears to include 1 new or modified test files. |
| {color:red}-1{color} | javac |   7m 45s | The applied patch generated  133  additional warning messages. |
| {color:green}+1{color} | javadoc |  10m  5s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 22s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | checkstyle |   1m  1s | There were no new checkstyle issues. |
| {color:red}-1{color} | whitespace |   0m 23s | The patch has 1  line(s) that end in whitespace. Use git apply --whitespace=fix. |
| {color:green}+1{color} | install |   1m 40s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:red}-1{color} | findbugs |   3m  8s | The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings. |
| {color:green}+1{color} | native |   3m 19s | Pre-build of native portion |
| {color:red}-1{color} | hdfs tests | 225m 15s | Tests failed in hadoop-hdfs. |
| | | 268m 32s | |
\\
\\
|| Reason || Tests ||
| FindBugs | module:hadoop-hdfs |
|  |  Class org.apache.hadoop.hdfs.DataStreamer$LastException is not derived from an Exception, even though it is named as such  At DataStreamer.java:from an Exception, even though it is named as such  At DataStreamer.java:[lines 178-202] |
| Failed unit tests | hadoop.hdfs.TestDFSClientRetries |
|   | hadoop.hdfs.server.namenode.TestDeleteRace |
|   | hadoop.hdfs.server.datanode.TestBlockRecovery |
|   | hadoop.hdfs.server.datanode.fsdataset.impl.TestRbwSpaceReservation |
|   | hadoop.hdfs.TestClose |
|   | hadoop.hdfs.TestDFSOutputStream |
|   | hadoop.hdfs.TestCrcCorruption |
|   | hadoop.hdfs.TestFileLengthOnClusterRestart |
|   | hadoop.hdfs.TestQuota |
|   | hadoop.hdfs.TestMultiThreadedHflush |
|   | hadoop.cli.TestHDFSCLI |
| Timed out tests | org.apache.hadoop.hdfs.TestDataTransferProtocol |
|   | org.apache.hadoop.hdfs.tools.offlineEditsViewer.TestOfflineEditsViewer |
|   | org.apache.hadoop.hdfs.server.namenode.TestNamenodeRetryCache |
|   | org.apache.hadoop.hdfs.server.mover.TestMover |
|   | org.apache.hadoop.hdfs.TestClientProtocolForPipelineRecovery |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12729632/HDFS-8178.003.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / 87e9978 |
| javac | https://builds.apache.org/job/PreCommit-HDFS-Build/10496/artifact/patchprocess/diffJavacWarnings.txt |
| whitespace | https://builds.apache.org/job/PreCommit-HDFS-Build/10496/artifact/patchprocess/whitespace.txt |
| Findbugs warnings | https://builds.apache.org/job/PreCommit-HDFS-Build/10496/artifact/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html |
| hadoop-hdfs test log | https://builds.apache.org/job/PreCommit-HDFS-Build/10496/artifact/patchprocess/testrun_hadoop-hdfs.txt |
| Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/10496/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf904.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/10496/console |


This message was automatically generated., The failed tests are unrelated to HA (thus unrelated to this patch). They all passed locally except for {{TestOfflineEditsViewer}}, which also fails on trunk with the same error message.]