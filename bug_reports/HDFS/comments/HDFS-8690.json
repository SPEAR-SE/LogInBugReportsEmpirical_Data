[+1 pending Jenkins. I agree that the special case for SocketTimeoutException looks incorrect.

I tried to lookup the history but was not able to get past the source tree re-org in 2011. I will hold off committing in case someone more familiar with the history of this behavior wants to comment.

Thanks for reporting it and submitting the patch [~lichangleo]., Thanks, [~lichangleo] [~arpitagarwal]. There were some discussions in https://issues.apache.org/jira/browse/HDFS-7314 about this., \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:red}-1{color} | pre-patch |  17m 48s | Pre-patch trunk has 1 extant Findbugs (version 3.0.0) warnings. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | javac |   7m 32s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 35s | There were no new javadoc warning messages. |
| {color:green}+1{color} | release audit |   0m 22s | The applied patch does not increase the total number of release audit warnings. |
| {color:red}-1{color} | checkstyle |   2m 15s | The applied patch generated  1 new checkstyle issues (total was 19, now 20). |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 32s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 33s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   3m 16s | The patch does not introduce any new Findbugs (version 3.0.0) warnings. |
| {color:green}+1{color} | native |   3m 15s | Pre-build of native portion |
| {color:red}-1{color} | hdfs tests | 161m 43s | Tests failed in hadoop-hdfs. |
| | | 207m 55s | |
\\
\\
|| Reason || Tests ||
| Failed unit tests | hadoop.hdfs.TestAppendSnapshotTruncate |
|   | hadoop.hdfs.TestHDFSFileSystemContract |
|   | hadoop.hdfs.web.TestWebHdfsFileSystemContract |
|   | hadoop.hdfs.server.namenode.TestFileTruncate |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12742517/HDFS-8690.1.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / fde20ff |
| Pre-patch Findbugs warnings | https://builds.apache.org/job/PreCommit-HDFS-Build/11532/artifact/patchprocess/trunkFindbugsWarningshadoop-hdfs.html |
| checkstyle |  https://builds.apache.org/job/PreCommit-HDFS-Build/11532/artifact/patchprocess/diffcheckstylehadoop-hdfs.txt |
| hadoop-hdfs test log | https://builds.apache.org/job/PreCommit-HDFS-Build/11532/artifact/patchprocess/testrun_hadoop-hdfs.txt |
| Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/11532/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf909.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/11532/console |


This message was automatically generated., I do think it's odd to abort on {{SocketTimeout}} but not on {{IOException}}.  After all, a client partitioned from the network may experience other exceptions than {{SocketTimeout}} that have the same practical effect.

In general, the philosophy behind aborting is that the open-for-write files may be re-assigned to other lease holders at any point once we can no longer renew.  This is why {{DFSClient#abort}} includes a call to {{DFSClient#closeAllFilesBeingWritten}}.  There is probably scope for a larger cleanup of this code, but it would be difficult and take a very in-depth review..., I see HDFS-7314 is trying to address the same problem but appears stalled.  It looks like a better fix.  Can we expedite HDFS-7314?  If not, this jira is a tiny step in the right direction.  Chang filed this after I analyzed a production incident that required oozie and other services to be restarted because the renewer aborted the client., Daryn (or Ming), if you want to pick up HDFS-7314 that would be great ("Office Space" Bill Lumberg voice not intended).

It's a tricky area of the code since the way we start and stop the lease renewer thread is complex and seems to already have some race conditions in it.  But in general I agree that we should not abort entire DFSClients, but only abort open files when it becomes necessary., I unfortunately have zero time atm.  [~mingma]?, We actually deployed a slightly modified version of https://issues.apache.org/jira/secure/attachment/12680729/HDFS-7314-7.patch on our production clusters early this year. I will update HDFS-7314 with the patch. Let us continue the discussion in HDFS-7314, especially if we should fix the existing race conditions altogether.]