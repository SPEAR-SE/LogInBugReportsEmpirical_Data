[Words don't describe how just how horribly unacceptable the heap growth has become.  Here's 1 year of heap growth on a teeny tiny 350 node cluster processing only 1k ops/sec.  The previous aberration was due to a bad 2.7 release., [~xiaochen], [~jingzhao], any thoughts?  We've internally reverted HDFS-10797 for now as it is unusable for anything beyond light-duty test clusters., I am +1 for reverting HDFS-10797. In fact, that's what I initially wanted to do when filing HDFS-11515 (also broken by HDFS-10797)., [~kihwal], [~daryn] and [~nroberts]:
could you please share what your clusters run which exposed this bug? I would like to understand this bug and reproduce the issue you mentioned. We can revert HDFS-10797, but in the long run I would still like to fix the bug that HDFS-10797 intended to fix.

Thanks very much!, [~jojochuang], sure, occasional `du -s` of very large directory trees, think 100s of millions of files/directories. 


, Thanks [~nroberts] and all for reporting the issue. +1 on reverting HDFS-10797 if we don't have a quick fix here. Just pinged the patch authors of HDFS-10797 to see if any magic can happen in short term. :), +1 to the revert - I too would still like to see the original problem fixed, but this is worse. It does indeed require global context to do correctly, so it'll require some cleverness to make sure we do that without using tons of space or locking for a long time. 

[~jojochuang] - to revert cleanly we can revert HDFS-11515 (unless I'm missing something and that patch does more than just correct the original changes in HDFS-10797) first and then HDFS-10797. As [~xiaochen] is not available right now, would you be able to commit the revert when we're satisfied? I'll run tests with the reverts committed locally..., Hey Sean, thanks for the comment.
I think there's a lightweight approach to fix the same bug without includedNodes set. I will post a patch next week if I can do something clever., Here's my proof of concept fix to eliminate includedNodes while fixing renamed snapshotted files getting counted twice.

It uses FSDirectory.inodeMap to determine whether a deleted snapshotted inode is actually deleted or renamed, and whether the renamed inode remains under the same du subtree.

The v001 patch assumes the du root is a directory. I have not yet considered the cases when files are truncated or appended, and I have not considered the case if there are symlinks in the directory., Here's a rev 002 patch. Added a few asserts and checks to make sure it doesn't break.

The patch passed all tests on CDH5.11 code, so I think it's ready for precommit check on trunk., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 13s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 15m 24s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 55s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 41s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  2s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 16s{color} | {color:green} trunk passed {color} |
| {color:red}-1{color} | {color:red} findbugs {color} | {color:red}  1m 54s{color} | {color:red} hadoop-hdfs-project/hadoop-hdfs in trunk has 10 extant Findbugs warnings. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 44s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 52s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 58s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 58s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 39s{color} | {color:orange} hadoop-hdfs-project/hadoop-hdfs: The patch generated 1 new + 120 unchanged - 0 fixed = 121 total (was 120) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 56s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 58s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 40s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} unit {color} | {color:red} 67m  7s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 20s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 96m 20s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| Failed junit tests | hadoop.hdfs.server.balancer.TestBalancerRPCDelay |
|   | hadoop.hdfs.server.namenode.TestStartup |
|   | hadoop.hdfs.server.namenode.TestMetadataVersionOutput |
|   | hadoop.hdfs.server.datanode.TestDataNodeVolumeFailure |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:0ac17dc |
| JIRA Issue | HDFS-11661 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12865620/HDFs-11661.002.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux f1e485d1ad22 3.13.0-107-generic #154-Ubuntu SMP Tue Dec 20 09:57:27 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / fdf5192 |
| Default Java | 1.8.0_121 |
| findbugs | v3.1.0-RC1 |
| findbugs | https://builds.apache.org/job/PreCommit-HDFS-Build/19236/artifact/patchprocess/branch-findbugs-hadoop-hdfs-project_hadoop-hdfs-warnings.html |
| checkstyle | https://builds.apache.org/job/PreCommit-HDFS-Build/19236/artifact/patchprocess/diff-checkstyle-hadoop-hdfs-project_hadoop-hdfs.txt |
| unit | https://builds.apache.org/job/PreCommit-HDFS-Build/19236/artifact/patchprocess/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/19236/testReport/ |
| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/19236/console |
| Powered by | Apache Yetus 0.5.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, HI [~jojochuang],

Thanks for working on this, it seems a very good fix to solve the issue reported here. I did a review and below are my comments.

1. There are the following scenarios:
a. mv fileX fileY (fileY is a child of the same snapshot root)
b. mv fileX fileY (fileY is not a child of the same snapshot root)
c. mv fileX fileY, take snapshot, mv fileY fileX
d. delete fileX
where b/d can be handled same way, and a/c can be handled same way. HDFS-10797 already has a unit test, I'm not sure whether it covers all scenario, if not, we can extend the test to cover these scenarios. So to trace the behavior of the changed code to see if that the code works as expected for different scenarios.

2. The following code covers scenario c, it seems the calculation {{computeContentSummary}} done in this {{if}} branch is already done before this code is reached, and we should not call it again here. Let's prove that with the unit test.
{code}
    if (nodePath.equals(inodeInMapPath)) {
        LOG.info("snapshot inode " + nodePath + " was deleted or " +
                "was renamed+renamed back.");
        inodeInMap.computeContentSummary(Snapshot.CURRENT_STATE_ID, this);
      } else {
{code}

Thanks.
, Please hold off on commit until later this week.  There are more bugs related to snapshots and content summary and quota usage discrepencies.  I almost have a patch ready that optimizes content summary and appears to fix the snapshot issues.  , [~daryn] I am testing my patch against a production cluster fsimage, and found some issues.

But feel free to reassign this to you if you are working on a more complete fix.

Thanks., FYI the issue I found is related to HDFS-11515. That fix was not complete, so you might as well take that into account., [~daryn] do you think we can get this turned around by EOW? I'm aiming to roll alpha3 on Friday. We can retarget for beta1 if that's too aggressive., I don't want to have this one blocking Hadoop 3 alpha3. I suggest we revert both HDFS-11515 and HDFS-11661 to unblock., bq. I suggest we revert both HDFS-11515 and HDFS-11661 to unblock.
[~jojochuang]: By HDFS-11661, you mean HDFS-10797 correct ?, [~shahrs87]
My bad. You're absolutely correct., Sorry, thought I commented last week.  I agree we should just revert the original change entirely.  I may/should/hopefully have a patch by EOW, but don't let it block the release.  We've "lived" with the inconsistency this long so waiting a bit longer won't hurt.  Between debugging 2.8 and grokking snapshots, fixing the discrepancies is taking longer than expected., Heads up I am going to revert both commits EOD. I believe I've got sufficient number of upvotes., Just returning from paternity leave, sorry for the inconvenience and thanks Wei-Chiu for working on the revert. Please let me know if you need help on reverting.
Also love to look for a fix and the Daryn patch, but +1 to unblock the release first., Based on multiple +1, I reverted the commit from branch-2.8, branch-2 and trunk.

Thanks to [~nroberts] for reporting the issue, and comments from [~kihwal], [~mackrorysd], [~xiaochen] [~djp] [~andrew.wang] [~shahrs87] [~yzhangal] and [~daryn].

[~daryn] thanks for your effort trying to fix the bug. Please file a new jira for your patch. Thanks!, 2.8.1 became a security release. Moving fix-version to 2.8.2 after the fact., {quote}
There are more bugs related to snapshots and content summary and quota usage discrepencies. I almost have a patch ready that optimizes content summary and appears to fix the snapshot issues.
{quote}
Hi [~daryn] and [~shahrs87],
Just wanted to check if this was eventually done? And could you share the jira if so?

Thanks!]