[ *We can notice from the following, write lock time ~35sec+ . This I seen in 2.7, same issue exists in trunk also.* 

 *{color:red}2016-09-26 21:09:15,673{color}*  | INFO  | DecommissionMonitor-0 | Block: blk_1075238065_1497241, Expected Replicas: 3, live replicas: 2, corrupt replicas: 0, decommissioned replicas: 0, decommissioning replicas: 1, excess replicas: 0, Is Open File: false, Datanodes having this block: X.X.X.X:25009 Y.Y.Y.Y:25009 D.D.D.D:25009 , Current Datanode: D.D.D.D:25009, Is current datanode decommissioning: true | DecommissionManager.java:299
 *{color:red}2016-09-26 21:09:45,645{color}*  | INFO  | DecommissionMonitor-0 |  *{color:blue}Checked 50635805 blocks and 1 nodes this tick{color}*  | DecommissionManager.java:398

 *{color:red}2016-09-26 21:09:45,647{color}*  | INFO  | DecommissionMonitor-0 | Block: blk_1075238065_1497241, Expected Replicas: 3, live replicas: 2, corrupt replicas: 0, decommissioned replicas: 0, decommissioning replicas: 1, excess replicas: 0, Is Open File: false, Datanodes having this block: X.X.X.X:25009 Y.Y.Y.Y:25009 D.D.D.D:25009 , Current Datanode: D.D.D.D:25009, Is current datanode decommissioning: true | DecommissionManager.java:299
2016-09-26 21:10:15,279 | INFO  | DecommissionMonitor-0 |  *{color:blue}Checked 50635805 blocks and 1 nodes this tick{color}*  | DecommissionManager.java:398

2016-09-26 21:10:15,280 | INFO  | DecommissionMonitor-0 | Block: blk_1075238065_1497241, Expected Replicas: 3, live replicas: 2, corrupt replicas: 0, decommissioned replicas: 0, decommissioning replicas: 1, excess replicas: 0, Is Open File: false, Datanodes having this block: X.X.X.X:25009 Y.Y.Y.Y:25009 D.D.D.D:25009 , Current Datanode: D.D.D.D:25009, Is current datanode decommissioning: true | DecommissionManager.java:299
2016-09-26 21:10:45,595 | INFO  | DecommissionMonitor-0 |  *{color:blue}Checked 50635805 blocks and 1 nodes this tick{color}*  | DecommissionManager.java:398

2016-09-26 21:10:50,346 | INFO  | DecommissionMonitor-0 | Block: blk_1075238065_1497241, Expected Replicas: 3, live replicas: 2, corrupt replicas: 0, decommissioned replicas: 0, decommissioning replicas: 1, excess replicas: 0, Is Open File: false, Datanodes having this block: X.X.X.X:25009 Y.Y.Y.Y:25009 D.D.D.D:25009 , Current Datanode: D.D.D.D:25009, Is current datanode decommissioning: true | DecommissionManager.java:299
2016-09-26 21:11:20,176 | INFO  | DecommissionMonitor-0 |  *{color:blue}Checked 50635805 blocks and 1 nodes this tick{color}*  | DecommissionManager.java:398

2016-09-26 21:11:20,179 | INFO  | DecommissionMonitor-0 | Block: blk_1075238065_1497241, Expected Replicas: 3, live replicas: 2, corrupt replicas: 0, decommissioned replicas: 0, decommissioning replicas: 1, excess replicas: 0, Is Open File: false, Datanodes having this block: X.X.X.X:25009 Y.Y.Y.Y:25009 D.D.D.D:25009 , Current Datanode: D.D.D.D:25009, Is current datanode decommissioning: true | DecommissionManager.java:299
2016-09-26 21:11:49,669 | INFO  | DecommissionMonitor-0 |  *{color:blue}Checked 50635805 blocks and 1 nodes this tick{color}*  | DecommissionManager.java:398

2016-09-26 21:11:49,670 | INFO  | DecommissionMonitor-0 | Block: blk_1075238065_1497241, Expected Replicas: 3, live replicas: 2, corrupt replicas: 0, decommissioned replicas: 0, decommissioning replicas: 1, excess replicas: 0, Is Open File: false, Datanodes having this block: X.X.X.X:25009 Y.Y.Y.Y:25009 D.D.D.D:25009 , Current Datanode: D.D.D.D:25009, Is current datanode decommissioning: true | DecommissionManager.java:299
2016-09-26 21:12:19,192 | INFO  | DecommissionMonitor-0 | Checked 50635805 blocks and 1 nodes this tick | DecommissionManager.java:398
, Yielding is required in case of single Node have huge number of blocks to process.Introduced same and uploading the patch., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 15s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m 50s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 43s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 24s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 50s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 12s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 41s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 39s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 44s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 40s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 40s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 22s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 48s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m  9s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 45s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 37s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} unit {color} | {color:red} 58m  3s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 18s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 76m  7s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| Failed junit tests | hadoop.hdfs.server.namenode.TestDecommissioningStatus |
|   | hadoop.hdfs.TestEncryptionZones |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:9560f25 |
| JIRA Issue | HDFS-10987 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12832259/HDFS-10987.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux e6e42fda0aff 3.13.0-93-generic #140-Ubuntu SMP Mon Jul 18 21:21:05 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 4d10621 |
| Default Java | 1.8.0_101 |
| findbugs | v3.0.0 |
| unit | https://builds.apache.org/job/PreCommit-HDFS-Build/17068/artifact/patchprocess/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/17068/testReport/ |
| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/17068/console |
| Powered by | Apache Yetus 0.4.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Test failures are unrelated..Kindly review., We've seen this also. We don't have that many blocks per node, but still the lock time can be multiple seconds.  [~daryn] was going to do something similar, but he was also improving locking in replication monitor.  , Thanks [~kihwal] for taking look..

IIUC,[~daryn] was doing finegrained locking which is big change..?  what's your view on current patch..? 

JFYI,Tested the patch,NN was available(only first time it will take 15 to 25 sec) while running the decommission and all the depended services(HBase,Spark,Hive..) are able to communicate., bq. IIUC,Daryn Sharp was doing finegrained locking which is big change..?
It is a decomm manager and replication monitor change. He has a POF patch, but got preempted by other things before filing a jira for it.  

Now the patch. It looks okay in general. Just a few minor things.
{code}
// Yielding is required in case of single Node have huge number of
// blocks to process.
{code}
To be precise, the number of blocks doesn't have to be huge. It will yield if the number is greater than the configured per-iteration-limit.
When the sleep is interrupted, it should probably not ignore. It looks like it can simply return., Nice idea, patch LGTM too once Kihwal's comments are addressed. Hoping we can eventually find a way to break up all the full scans., bq. To be precise, the number of blocks doesn't have to be huge. It will yield if the number is greater than the configured per-iteration-limit.
Yes, that's correct. But before-this patch, check against per-iteration-limit is done after checking all blocks-per-node. So yielding is done only after current-nodes list is complete.

bq. When the sleep is interrupted, it should probably not ignore. It looks like it can simply return.
Yes. Along with that, IMO should also add 'namesystem.isRunning()' to while loop condition in 'check()' to end execution fast., Another improvement for standby-nn I am finding is, "blockManager.isPopulatingReplQueues()" could be added at run() itself to avoid all remaining checks in Standby state. Could be taken as separate Jira also., bq. Yes. Along with that, IMO should also add 'namesystem.isRunning()' to while loop condition in 'check()' to end execution fast

Sounds good to me.. Updated the patch..Addressed kihwal and vinay comments.., will handle in seperate jira., | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 17s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  8m 15s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 47s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 26s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 52s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 13s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 51s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 42s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 47s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 55s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 55s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 24s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 47s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 46s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 37s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} unit {color} | {color:green} 58m 13s{color} | {color:green} hadoop-hdfs in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 20s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 78m 31s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:9560f25 |
| JIRA Issue | HDFS-10987 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12832892/HDFS-10987-002.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux c874a437d553 3.13.0-92-generic #139-Ubuntu SMP Tue Jun 28 20:42:26 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 6476934 |
| Default Java | 1.8.0_101 |
| findbugs | v3.0.0 |
|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/17120/testReport/ |
| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/17120/console |
| Powered by | Apache Yetus 0.4.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, Looks good to me. +1, +1 from me too. Will commit it shortly., [~vinayrpet] thanks for review, will wait for commit till [~kihwal] and [~andrew.wang] looks latest patch., Ok. Not committing. Let's wait for Andrew., hmm..it was coincidence( same time we commented)..:), Yea LGTM too, thanks all!, SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #10606 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/10606/])
HDFS-10987. Make Decommission less expensive when lot of blocks present. (kihwal: rev 332a61fd74fd2a9874319232c583ab5d2c53ff03)
* (edit) hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/DecommissionManager.java
, Thanks everyone for reviews and thanks for working on this [~brahmareddy]. Committed this to trunk, branch-2 and branch-2.8. branch-2* had a couple of minor conflicts that was easily resolved., Thanks all., Uploading the branch-2.7 patch.Kindly Review., [~kihwal] can you please review the branch-2.7 patch, I am thinking,we no need run the jenkins against patch since it's straightforward patch with little modification against branch-2..Even I am ok to raise another jira to backport this(since 2.8 and alpha2 relase given and discussion in [mailing list|http://mail-archives.apache.org/mod_mbox/hadoop-mapreduce-dev/201705.mbox/browser]).., +1 for the backport. LGTM, Committed to branch-2.7.. [~shv] thanks for review.]