[- Fix file handle leak in Journal.close.
- Fix attempt to read from locked file that fails on Windows.
- Fix a test case that was leaking a file handle., Great catches!

Is it possible/worthwhile to use one of the file sharing APIs on the lock file instead of saying that the lock owner is unknown?  (i.e. {{NativeIO#getShareDeleteFileInputStream}} or perhaps add a new {{NativeIO#getShareReadFileInputStream}} for additional safety.)

{code}
+          lockingJvmName = new String("'unknown'");
{code}

Since this is a string literal, we wouldn't need to call new, and instead could just say:

{code}
+          lockingJvmName = "'unknown'";
{code}
, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12572639/HDFS-4572.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 tests included appear to have a timeout.{color}

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:red}-1 findbugs{color}.  The patch appears to introduce 1 new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/4053//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/4053//artifact/trunk/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/4053//console

This message is automatically generated., Thanks for the feedback Chris! Your second comment is the same as the findbug warning and I have fixed it.

I did not spend much time looking into the file share APIs. Changing the file locking behavior may be risky and would require significant testing. It would be a lot of effort for the minimal diagnosability benefit and only on Windows. Would it be acceptable to file a separate Jira to look into that?, +1 for the current patch.

Thanks for addressing the findbugs warning, and the explanation makes sense.
, {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12572789/HDFS-4572.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 tests included appear to have a timeout.{color}

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/4061//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/4061//console

This message is automatically generated., Patch looks good, +1

One question though, I see that you're adding a timeout to every test case in the test. Is this a new guideline? I found it hard to debug tests like these and always ended up removing the timeout what seemed a bit odd. Would it make more sense to have a test wide 15 minute timeout or something? Ideally, the timeout would be configured from the outside and not hit when debugging from eclipse.
, Thanks for reviewing! 

Ivan, adding timeout annotations for each new or changed test case is a requirement in trunk now., Arpit, instead of printing "It appears that another namenode unknown  has already locked the storage directory", would it not make sense to print "It appears that another namenode has already locked the storage directory". That is instead of setting lockingJvmName to unknown, set it to empty?, Also, while handling the above comment, you could also make the code terse by:
{code}
  // Cannot read from the locked file on Windows  
  String lockingJvmName = Path.WINDOWS ? "" : file.readLine();
{code}, Thanks for the feedback Suresh! 

I have updated the patch., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12573176/HDFS-4572.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 tests included appear to have a timeout.{color}

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.datanode.TestDataDirs

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/4078//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/4078//console

This message is automatically generated., The TestDataDirs failure is unrelated to my patch and repros on clean trunk. I filed HDFS-4589., Hi Arpit, we already filed HDFS-4586 on TestDataDirs failing. Will resolve yours as a duplicate., +1 for the patch. I will commit it soon., Committed the patch to trunk.

Thank you Arpit. Thanks to Chris and Ivan for reviewing the patch., Integrated in Hadoop-trunk-Commit #3449 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3449/])
    HDFS-4572. Fix TestJournal failures on Windows. Contributed by Arpit Agarwal. (Revision 1455360)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1455360
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/qjournal/server/Journal.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/Storage.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/qjournal/server/TestJournal.java
, Integrated in Hadoop-Yarn-trunk #153 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/153/])
    HDFS-4572. Fix TestJournal failures on Windows. Contributed by Arpit Agarwal. (Revision 1455360)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1455360
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/qjournal/server/Journal.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/Storage.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/qjournal/server/TestJournal.java
, Integrated in Hadoop-Hdfs-trunk #1342 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1342/])
    HDFS-4572. Fix TestJournal failures on Windows. Contributed by Arpit Agarwal. (Revision 1455360)

     Result = FAILURE
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1455360
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/qjournal/server/Journal.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/Storage.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/qjournal/server/TestJournal.java
, Integrated in Hadoop-Mapreduce-trunk #1370 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1370/])
    HDFS-4572. Fix TestJournal failures on Windows. Contributed by Arpit Agarwal. (Revision 1455360)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1455360
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/qjournal/server/Journal.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/Storage.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/qjournal/server/TestJournal.java
, Merged the patch to branch-2]