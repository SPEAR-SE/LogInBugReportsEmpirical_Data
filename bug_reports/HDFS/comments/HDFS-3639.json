[Trivial patch attached., +1 (Assuming tests pass) I saw that while fixing proxy tokens and it make me uneasy so I'm glad you're fixing it!, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12536094/hdfs-3639.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.TestReplication

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2799//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2799//console

This message is automatically generated., Test failure is unrelated, filed HDFS-3642., Thanks for the review Daryn. I've committed this and merged to branch-2 and branch-1. , Integrated in Hadoop-Mapreduce-trunk-Commit #2472 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/2472/])
    HDFS-3639. JspHelper#getUGI should always verify the token if security is enabled. Contributed by Eli Collins (Revision 1360485)

     Result = FAILURE
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1360485
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/JspHelper.java
, Integrated in Hadoop-Common-trunk-Commit #2454 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/2454/])
    HDFS-3639. JspHelper#getUGI should always verify the token if security is enabled. Contributed by Eli Collins (Revision 1360485)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1360485
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/JspHelper.java
, Integrated in Hadoop-Hdfs-trunk-Commit #2520 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/2520/])
    HDFS-3639. JspHelper#getUGI should always verify the token if security is enabled. Contributed by Eli Collins (Revision 1360485)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1360485
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/JspHelper.java
, Integrated in Hadoop-Hdfs-trunk #1101 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1101/])
    HDFS-3639. JspHelper#getUGI should always verify the token if security is enabled. Contributed by Eli Collins (Revision 1360485)

     Result = FAILURE
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1360485
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/JspHelper.java
, Integrated in Hadoop-Mapreduce-trunk #1134 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1134/])
    HDFS-3639. JspHelper#getUGI should always verify the token if security is enabled. Contributed by Eli Collins (Revision 1360485)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1360485
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/JspHelper.java
, I've reverted this change (and HDFS-3654). Thanks to ATM who pointed out that this "causes HftpFileSystem to not work at all with an actual secure cluster, failing with an NPE when attempting to read a file. The reason being that both DNs and NNs call JspHelper@getUGI, but it's 100% expected that in the DN case that the context.getAttribute("name.node") will return null. In the NN case (where "name.node" is set) it is needed for UGI verification."

Perhaps we should have a version of this function used by the NN that requires the the name.node attribute be set and another version used by the NN that doesn't verify the token?, Integrated in Hadoop-Hdfs-trunk-Commit #2559 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/2559/])
    Revert HDFS-3639. JspHelper#getUGI should always verify the token if security is enabled. (Revision 1362760)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1362760
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/JspHelper.java
, bq. Perhaps we should have a version of this function used by the NN that requires the the name.node attribute be set and another version used by the NN that doesn't verify the token?

That would be fine. Or break out the token verification from the getUGI function, and have the NN code path explicitly call some separate verifyToken function before calling getUGI., Integrated in Hadoop-Common-trunk-Commit #2494 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/2494/])
    Revert HDFS-3639. JspHelper#getUGI should always verify the token if security is enabled. (Revision 1362760)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1362760
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/JspHelper.java
, Integrated in Hadoop-Mapreduce-trunk-Commit #2516 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/2516/])
    Revert HDFS-3639. JspHelper#getUGI should always verify the token if security is enabled. (Revision 1362760)

     Result = FAILURE
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1362760
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/JspHelper.java
, Integrated in Hadoop-Hdfs-trunk #1107 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1107/])
    Revert HDFS-3639. JspHelper#getUGI should always verify the token if security is enabled. (Revision 1362760)

     Result = FAILURE
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1362760
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/JspHelper.java
, To avoid possible duplication of code, perhaps add a boolean to the method signature for whether to verify the token?  Or maybe pass in the NN object or null to indicate whether to verify the token?, Integrated in Hadoop-Mapreduce-trunk #1140 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1140/])
    Revert HDFS-3639. JspHelper#getUGI should always verify the token if security is enabled. (Revision 1362760)

     Result = FAILURE
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1362760
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/common/JspHelper.java
, Changed Target Version to 1.3.0 upon release of 1.2.0. Please change to 1.2.1 if you intend to submit a fix for branch-1.2.]