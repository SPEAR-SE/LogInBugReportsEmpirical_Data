[with this patch, fuse-dfs builds on a 11.04 ubuntu by simply typinh:

$ mvn install -Pnative 

which build java and the C libhdfs. In order to build fuse-dfs, go intro hadoop-hdfs/src/contrib and type:

$ ant

As soon as I get my hand on a ubuntu 11.10, I'll try to see if those "libflags at the end" don't strike again. 

I think eventually libhdfs and fuse-dfs should be united into the same project (all under hadoop-hdfs/src/native for example). , Attaching a patch (HDFS-2696-plus.patch) to be applied on top of Petru's patches in order to make it build on my Fedora 16.

I will also hook that patch to the hadoop-0.23 branch of Bigtop and see how it goes, Hey Bruno,
Can you generate one patch that applies against trunk so I can review?

Thanks! , Sure!
Please find attached HDFS-2696-complete.patch which contains a merged version of the 4 previous patches applied to trunk, - Why is the java env detection required now when it wasn't previously? Could we re-use the same code from libhdfs? 
- We don't need to add the m4 files, I believe those should be generated and not checked in
- Looks like this makes the native build compile fusedfs unconditionally? It's currently controlled by a flag so the build works on machines w/o fuse headers, Sure. Let me rework that., Please find attached a completely rewritten patch from scratch named HDFS-2696-rewrite.patch.

I believe it does address Eli's concerns since:
* It will only build fuse if the property build.fuse is defined. 
* It does not introduce any new new code, Here is another version of the patch a little bit more maven friendly.
The previous version of that patch could trigger some issues depending on the execution order of the different maven modules.

Tested with:
{noformat}mvn clean install -DskipTests -Pnative  -DskipTest -Pfuse{noformat}

The -DskipTest is there to go around a typo issue in some other unrelated native build in some yarn module


, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12522061/HDFS-2696-maven.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 1 new or modified test files.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests:
                  org.apache.hadoop.hdfs.server.namenode.ha.TestPipelinesFailover

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2241//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2241//console

This message is automatically generated., Let's have the new directory structure be src/contrib/fuse-dfs/src instead of src/contrib/fuse-dfs/src/main/contrib/fuse-dfs/src.  Otherwise looks great., Attaching 2 patches:
* HDFS-2696-maven-part-2 -> patch to be applied on top of the previous one, in case you would like to see what is different from the previous one
* HDFS-2696-maven-all.patch -> Complete patch that includes both patches. , -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12522172/HDFS-2696-maven-all.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in .

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2245//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2245//console

This message is automatically generated., +1 looks great. I tested that fuse-dfs now build when -Pfuse and -Pnative are passed. No new unit test is necessary since this just impacts the build.

Btw I filed HDFS-3250, HDFS-3251, and HDFS-3252 for mavenizing the build, including it in the tarball and getting the test running.
, I've committed this and merged to branch-2. Thanks Bruno!, Integrated in Hadoop-Hdfs-trunk-Commit #2122 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/2122/])
    HDFS-2696. Fix the fuse-fds build. Contributed by Bruno Mahé (Revision 1312068)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1312068
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/build-contrib.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/build.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/build-contrib.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/build.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/pom.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/src/Makefile.am
* /hadoop/common/trunk/hadoop-hdfs-project/pom.xml
, Integrated in Hadoop-Common-trunk-Commit #2048 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/2048/])
    HDFS-2696. Fix the fuse-fds build. Contributed by Bruno Mahé (Revision 1312068)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1312068
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/build-contrib.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/build.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/build-contrib.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/build.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/pom.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/src/Makefile.am
* /hadoop/common/trunk/hadoop-hdfs-project/pom.xml
, Integrated in Hadoop-Mapreduce-trunk-Commit #2061 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/2061/])
    HDFS-2696. Fix the fuse-fds build. Contributed by Bruno Mahé (Revision 1312068)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1312068
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/build-contrib.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/build.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/build-contrib.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/build.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/pom.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/src/Makefile.am
* /hadoop/common/trunk/hadoop-hdfs-project/pom.xml
, Integrated in Hadoop-Hdfs-trunk #1011 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1011/])
    HDFS-2696. Fix the fuse-fds build. Contributed by Bruno Mahé (Revision 1312068)

     Result = FAILURE
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1312068
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/build-contrib.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/build.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/build-contrib.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/build.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/pom.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/src/Makefile.am
* /hadoop/common/trunk/hadoop-hdfs-project/pom.xml
, Integrated in Hadoop-Mapreduce-trunk #1046 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1046/])
    HDFS-2696. Fix the fuse-fds build. Contributed by Bruno Mahé (Revision 1312068)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1312068
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/build-contrib.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/build.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/build-contrib.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/build.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/pom.xml
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/contrib/fuse-dfs/src/Makefile.am
* /hadoop/common/trunk/hadoop-hdfs-project/pom.xml
]