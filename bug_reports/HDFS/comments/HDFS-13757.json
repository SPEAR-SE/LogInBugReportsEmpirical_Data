[Thanks [~jojochuang] for reporting.
[~lukmajercak] ran the test in branch-2.9 and I did the same for trunk and the test passed for both of us.
There is a part of the code that is commented checking for the exception message; do we need to set that?
Can you reproduce in trunk?, Hi thanks for the quick response. Admittedly the test code is a little racy. However this is reproducible for me in trunk with the exact test code., Hi [~jojochuang]. Unfortunately, I haven't been able to reproduce this on trunk (ran the test 150~ times). I could reproduce something on 2.9, but the exception was not the same and the failed run did not even touch the code added in HDFS-12886., Looks like I also need to pause IBR as well. Attached test rev 02 for that. [^HDFS-13757.test.02.patch] , Surely the test should fail if you disable IBR?, It wouldn't fail for the "Negative Replica" before HDFS-13757.]