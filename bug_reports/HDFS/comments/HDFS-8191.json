[The default upcasting from byte to integer will result in negative integers if the first bit of the byte is 1. This causes {{read()}} to return -1, indicating end of stream. This patch uses a byte mask for {{read()}} to always return the actual byte with value 0~255., Thanks Zhe, this looks good, explanation makes sense too. Could we add a unit test though?, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12726721/HDFS-8191.000.patch
  against trunk revision 44872b7.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.qjournal.client.TestQuorumJournalManager
                  org.apache.hadoop.hdfs.server.datanode.TestSimulatedFSDataset

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/10325//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/10325//console

This message is automatically generated., Thanks Andrew for the review! Yes a unit test is a good idea.

It turns out I need to refactor {{TestSimulatedFSDataset}} quite a bit to inject simulated books with negative block IDs. But I think the added {{negativeBlkID}} will be useful in the future as well.

Both Jenkins failures pass locally., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12726801/HDFS-8191.001.patch
  against trunk revision d52de61.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/10330//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/10330//console

This message is automatically generated., Couple notes:

* Rather than adding another argument to addSomeBlocks, let's keep the one-arg form of addSomeBlocks and have it default negativeBlocks to false. Have a two-arg form just for testWriteRead.

I'm not very happy with this test in general. Not exactly related to this change, but if you don't mind let's do a few small cleanups:

* Make addSomeBlocks and blockIdToLen static
* testWriteRead's "read" function, let's break it out into a new static function "readSomeBlocks" and put it by addSomeBlocks. The logic is heavily interlinked., Thanks Andrew for the review! 

A {{addSomeBlocks}} with default positive IDs is a good way to minimize changes. The patch also removes the hard coded starting block ID (1)., testInjectionNonEmpty I think still is using the 3-arg when it could use the 2-arg addSomeBlocks. Might also consider reordering the addSomeBlock functions so it reads downwards in terms of what calls what, e.g. 1-arg then 2-arg then 3-arg.

+1 anyway, these are pretty nitty., Thanks Andrew for the comment. Reordering sounds good. {{testInjectionNonEmpty}} uses the 3-arg {{addSomeBlocks}} because it needs to change the starting block ID. This is kind of hard to avoid. As you mentioned the code in this test class isn't too neat. It's probably because {{SimulateFSDataset}} isn't currently heavily used. The EC branch will make more use of it; we should definitely revisit this code and refactor it., Missed that injection change, +1 again. Thanks for working on this Zhe, let's see what the shiny new test-patch says., I kicked the precommit, dunno why it didn't run.

https://builds.apache.org/job/PreCommit-HDFS-Build/10363/, Thanks Andrew for reviewing again! Maybe the new shiny buildbot is too busy :) Attaching a duplicate 003 patch to trigger it., \\
\\
| (/) *{color:green}+1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |   5m 11s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:green}+1{color} | tests included |   0m  0s | The patch appears to include 2 new or modified test files. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | javac |   7m 37s | There were no new javac warning messages. |
| {color:green}+1{color} | release audit |   0m 20s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | checkstyle |   5m 27s | There were no new checkstyle issues. |
| {color:green}+1{color} | install |   1m 33s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 31s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | findbugs |   3m  5s | The patch does not introduce any new Findbugs (version 2.0.3) warnings. |
| {color:green}+1{color} | native |   1m 21s | Pre-build of native portion |
| {color:green}+1{color} | hdfs tests | 165m 15s | Tests passed in hadoop-hdfs. |
| | | 190m 24s | |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12727467/HDFS-8191.003.patch |
| Optional Tests | javac unit findbugs checkstyle |
| git revision | trunk / ac281e3 |
| hadoop-hdfs test log | https://builds.apache.org/job/PreCommit-HDFS-Build/10363/artifact/patchprocess/testrun_hadoop-hdfs.txt |
| Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/10363/testReport/ |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/10363/console |


This message was automatically generated., (!) The patch artifact directory on has been removed! 
This is a fatal error for test-patch.sh.  Aborting. 
Jenkins (node H3) information at https://builds.apache.org/job/PreCommit-HDFS-Build/10364/ may provide some hints., Pushed to trunk and branch-2, thanks for working on this Zhe!, FAILURE: Integrated in Hadoop-trunk-Commit #7665 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/7665/])
HDFS-8191. Fix byte to integer casting in SimulatedFSDataset#simulatedByte. Contributed by Zhe Zhang. (wang: rev c7d9ad68e34c7f8b9efada6cfbf7d5474cbeff11)
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/SimulatedFSDataset.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestSimulatedFSDataset.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, Thanks Andrew for reviewing and taking care of the commit., FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #174 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/174/])
HDFS-8191. Fix byte to integer casting in SimulatedFSDataset#simulatedByte. Contributed by Zhe Zhang. (wang: rev c7d9ad68e34c7f8b9efada6cfbf7d5474cbeff11)
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestSimulatedFSDataset.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/SimulatedFSDataset.java
, FAILURE: Integrated in Hadoop-Yarn-trunk #908 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/908/])
HDFS-8191. Fix byte to integer casting in SimulatedFSDataset#simulatedByte. Contributed by Zhe Zhang. (wang: rev c7d9ad68e34c7f8b9efada6cfbf7d5474cbeff11)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestSimulatedFSDataset.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/SimulatedFSDataset.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #2106 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2106/])
HDFS-8191. Fix byte to integer casting in SimulatedFSDataset#simulatedByte. Contributed by Zhe Zhang. (wang: rev c7d9ad68e34c7f8b9efada6cfbf7d5474cbeff11)
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestSimulatedFSDataset.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/SimulatedFSDataset.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #165 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/165/])
HDFS-8191. Fix byte to integer casting in SimulatedFSDataset#simulatedByte. Contributed by Zhe Zhang. (wang: rev c7d9ad68e34c7f8b9efada6cfbf7d5474cbeff11)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestSimulatedFSDataset.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/SimulatedFSDataset.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #175 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/175/])
HDFS-8191. Fix byte to integer casting in SimulatedFSDataset#simulatedByte. Contributed by Zhe Zhang. (wang: rev c7d9ad68e34c7f8b9efada6cfbf7d5474cbeff11)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestSimulatedFSDataset.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/SimulatedFSDataset.java
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk #2124 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2124/])
HDFS-8191. Fix byte to integer casting in SimulatedFSDataset#simulatedByte. Contributed by Zhe Zhang. (wang: rev c7d9ad68e34c7f8b9efada6cfbf7d5474cbeff11)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/SimulatedFSDataset.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestSimulatedFSDataset.java
]