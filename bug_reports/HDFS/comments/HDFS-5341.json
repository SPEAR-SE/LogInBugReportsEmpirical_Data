[Hi qus! Thanks a lot for your contribution. Could you please upload the patch as a file using the More button -> Attach Files option?

Patches usually also contain a unit test. https://wiki.apache.org/hadoop/HowToContribute 

Could you please also specify how one may be able to reproduce this problem, if possible?, Hi Prakash :Thanks for help.

In out Hadoop cluster, some datanode store nearly 800 thousand blocks and 16 Disks.
when the disk's IO with high presure,the file getlength funciotn could be slow.
And it will hold the lock dataset too long., Move the disk operation to the async disk scan., First patch.Add block file length to scaninfo class and get the length from async disk scan., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12609378/HDFS-5341.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.qjournal.TestNNWithQJM
                  org.apache.hadoop.hdfs.server.balancer.TestBalancerWithNodeGroup

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5245//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5245//console

This message is automatically generated., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12609398/HDFS-5341.000.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.ha.TestStandbyCheckpoints
                  org.apache.hadoop.hdfs.server.balancer.TestBalancerWithNodeGroup

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5246//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5246//console

This message is automatically generated., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12609414/HDFS-5341.001.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.qjournal.client.TestQuorumJournalManager

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5248//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5248//console

This message is automatically generated., Add some Code annotation and test patch again.As the failed test is not cause by my patch., Asking for code review., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12609570/HDFS-5341.002.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5253//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5253//console

This message is automatically generated., change the master thread 's Priority.Make it finish the block diff more quickly., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12609604/HDFS-5341.003.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:red}-1 eclipse:eclipse{color}.  The patch failed to build with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

        {color:red}-1 release audit{color}.  The applied patch generated 1 release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5254//testReport/
Release audit warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/5254//artifact/trunk/patchprocess/patchReleaseAuditProblems.txt
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5254//console

This message is automatically generated., Hi Jiawei!
Thanks for the patch. This looks like a good change. I am reviewing HDFS-5341.002.patch . I wasn't able to download HDFS-5341.003.patch. Did you remove it? Sometimes JIRA has problems. Could you please upload it again?
Here are my comments.
# We usually use two spaces instead of tabs to indent. Could you please fix that?
# This block {code}      	  if (blockFile != null) {
		this.blockFileLength = blockFile.length();
	  }
      else {
        this.blockFileLength = 0;
      }{code} can be written more easily like {code} this.blockFileLength = (blockFile != null) ?  blockFile.length() : 0; {code}
# getDiskReport() should be annotated with @VisibleForTesting
# The test itself measures that time taken by diffBlock is less than time taken by reconcile(=getDiskReport + diffBlock) + a second getDiskReport. Technically the second getDiskReport is extraneous. I'm also afraid the getDiskReport might return in < 0.5 ms, which could cause the test to fail intermittently. Can you think of some other way in which we may test this? (It may not be necessary to come up with a unit test since the change seems quite small and straight-forward), but if we can think of an easy way, then we should.
# The old Test14 should now become Test15, Hi ,Ravi Prakash :
  Thanks for review.At the begining, I think isn't necessary to have an junit test. As the Hadoop QA 's test result,it tells that no tests include.So I add an useless test in patch 2.
  Now , I remove the junit test change and replace tabs with space., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12609784/HDFS-5341.004.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.blockmanagement.TestBlocksWithNotEnoughRacks

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5257//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5257//console

This message is automatically generated., Thanks Jiawei! This is a good change and this patch looks good to me. +1. Can a committer please review and commit this patch? The test TestBlocksWithNotEnoughRacks failure is not related to this patch. It is being tracked at HDFS-3267., +1 Moving massive stat calls out of the critical section is good. It does increase memory usage, but seems acceptable. , I've committed this to trunk and branch-2. Thanks for the patch, Jiawei, and your reviews are much appreciated, Ravi. , SUCCESS: Integrated in Hadoop-trunk-Commit #4652 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/4652/])
HDFS-5341. Reduce fsdataset lock duration during directory scanning. Contributed by Qus-Jiawei. (kihwal: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1535188)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/DirectoryScanner.java
, SUCCESS: Integrated in Hadoop-Yarn-trunk #372 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/372/])
HDFS-5341. Reduce fsdataset lock duration during directory scanning. Contributed by Qus-Jiawei. (kihwal: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1535188)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/DirectoryScanner.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1562 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1562/])
HDFS-5341. Reduce fsdataset lock duration during directory scanning. Contributed by Qus-Jiawei. (kihwal: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1535188)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/DirectoryScanner.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1588 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1588/])
HDFS-5341. Reduce fsdataset lock duration during directory scanning. Contributed by Qus-Jiawei. (kihwal: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1535188)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/DirectoryScanner.java
]