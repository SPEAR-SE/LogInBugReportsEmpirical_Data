[[~hitliuyi],

Good catch. I've attached a patch.

, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12674865/HDFS-7243.001.patch
  against trunk revision cdce883.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.ha.TestRetryCacheWithHA
                  org.apache.hadoop.hdfs.server.namenode.TestHDFSConcat
                  org.apache.hadoop.hdfs.tools.offlineEditsViewer.TestOfflineEditsViewer
                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencingWithReplication
                  org.apache.hadoop.hdfs.TestDFSInotifyEventInputStream
                  org.apache.hadoop.hdfs.server.namenode.TestNamenodeRetryCache
                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencing

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8425//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8425//console

This message is automatically generated., Thanks Clarles for post the patch.
*1.*
{quote}
target.substring(0, target.lastIndexOf(Path.SEPARATOR_CHAR))
{quote}
could be empty string (if the parent if root), then will cause {{getEZForPath}} failed.
*2.*
Don't invoke FSN#getEZForPath directly, it's a bit heavy, more importantly it has own permission check which will cause some issues: For example, concat just needs "write" permission for target, and "read, parent write" permission for srcs.  If we invoke {{getEZForPath}} on target or parent directly, it requires "read" permission of the path. 
Why not do a lite check of whether target is in an encryption zone in {{concatInternal}}.
, [~hitliuyi],

Thanks for your good comments. I've uploaded a new patch which addresses them.

I ran all of the previous test failures on my local machine with the new patch and they pass.

Charles
, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12674986/HDFS-7243.002.patch
  against trunk revision 128ace1.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencingWithReplication
                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencing

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8430//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8430//console

This message is automatically generated., Charles, the latest patch looks good and only one comment:
{code}
final INodesInPath trgIip = dir.getINodesInPath(target, true);
{code}
here, we should use {{getINodesInPath4Write}} instead of {{getINodesInPath}}., Thanks [~hitliuyi]. You're right. I've posted the updated patch.
, Thanks Charles for updating the patch, it looks good to me., Thanks for reviewing Yi.

, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12675272/HDFS-7243.003.patch
  against trunk revision 2894433.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencingWithReplication
                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencing

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8440//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8440//console

This message is automatically generated., Hi Charles, I was going to commit this patch just now, but found another issue, sorry for missing that in previous comments.
{code}
dir.getINodesInPath4Write(target, true);
{code}
we should call
{code}
dir.getINodesInPath4Write(target);
{code}
Since the later will hold the FsDir read lock.

Besides, another small nits in the test, 
{code}
fs.concat(new Path(ez, "target"), new Path[] { src1, src2 });
{code}
We could use {{target}} instead of {{new Path(ez, "target")}} , [~hitliuyi],

Oh yes, good points. The latest patch addesses this.

Thanks for the review!

Charles
, Thanks Charles for updating.  
+1,  pending jenkins. , {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12676081/HDFS-7243.004.patch
  against trunk revision 171f237.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencingWithReplication
                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencing

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8468//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8468//console

This message is automatically generated., Will commit later today., bq. Will commit later today.

Hi [~hitliuyi],

If you get a minute and can commit this, then we can close it out.

Thanks.
Charles
, Yes, there is some issue for git commit in my local env, I'm fixing that :), FAILURE: Integrated in Hadoop-trunk-Commit #6329 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6329/])
HDFS-7243. HDFS concat operation should not be allowed in Encryption Zone. (clamb via yliu) (yliu: rev 57dec288070f903931771485d6424317b20551aa)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestEncryptionZones.java
, Commit to trunk, branch-2, branch-2.6. Thanks Charles for the contribution., SUCCESS: Integrated in Hadoop-Yarn-trunk #722 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/722/])
HDFS-7243. HDFS concat operation should not be allowed in Encryption Zone. (clamb via yliu) (yliu: rev 57dec288070f903931771485d6424317b20551aa)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestEncryptionZones.java
, Thanks [~hitliuyi] for the review and commit.
, SUCCESS: Integrated in Hadoop-Hdfs-trunk #1911 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1911/])
HDFS-7243. HDFS concat operation should not be allowed in Encryption Zone. (clamb via yliu) (yliu: rev 57dec288070f903931771485d6424317b20551aa)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestEncryptionZones.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1936 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1936/])
HDFS-7243. HDFS concat operation should not be allowed in Encryption Zone. (clamb via yliu) (yliu: rev 57dec288070f903931771485d6424317b20551aa)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestEncryptionZones.java
]