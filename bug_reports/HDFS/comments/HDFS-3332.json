[This probably related to the recent DatanodeID changes: HDFS-3164, HDFS-3138, HDFS-3171, HDFS-3144, HDFS-3216., Hi Nicholas,
Please correct me if I am wrong :)

I have NN started with HA configuration(nn1=40.95 and nn2=40.96 nn2 not started).

I have started only 1 NN and made it as active, wrote a file and corrupted it manually.
Directory scanner is reporting the bad block to all the NN via BPServiceActor.

Here BPServiceActor#reportBadBlocks(ExtendedBlock block) will not check whether DN is correctly registered to NN.
We are trying to report bad blocks using bpRegistration(which is null) causing NPE.
{code}
 void reportBadBlocks(ExtendedBlock block) {
    DatanodeInfo[] dnArr = { new DatanodeInfo(bpRegistration) };
    LocatedBlock[] blocks = { new LocatedBlock(block, dnArr) }; 
{code}    


Why bpRegistration is null?

{code}
private void connectToNNAndHandshake() throws IOException {
    // get NN proxy
    bpNamenode = dn.connectToNN(nnAddr);

    // First phase of the handshake with NN - get the namespace
    // info.
    NamespaceInfo nsInfo = retrieveNamespaceInfo();
    
    // Verify that this matches the other NN in this HA pair.
    // This also initializes our block pool in the DN if we are
    // the first NN connection for this BP.
    bpos.verifyAndSetNamespaceInfo(nsInfo);
    
    // Second phase of the handshake with the NN.
    register();
  }
{code}

Here in register() call bpRegistration is assigned. Since retrieveNamespaceInfo() is like a infinite loop trying to get the version

{code}
NamespaceInfo retrieveNamespaceInfo() throws IOException {
    NamespaceInfo nsInfo = null;
    while (shouldRun()) {
      try {
        nsInfo = bpNamenode.versionRequest();
        LOG.debug(this + " received versionRequest response: " + nsInfo);
        break;
      } catch(SocketTimeoutException e) {  // namenode is busy
        LOG.warn("Problem connecting to server: " + nnAddr);
      } catch(IOException e ) {  // namenode is not available
        LOG.warn("Problem connecting to server: " + nnAddr);
      }
      
      // try again in a second
      sleepAndLogInterrupts(5000, "requesting version info from NN");
    }
    
    if (nsInfo != null) {
      checkNNVersion(nsInfo);
    } else {
      throw new IOException("DN shut down before block pool connected");
    }
    return nsInfo;
  }
{code}

so bpRegistration is not assigned.
, Hi Amith, do you mean that you configured both active and standby NNs but only started the active NN?, Yes Nicholas, I have configured 2 NN but started only 1 as active, So, the problem is that the DN has not registered with standby NN but tries to report bad blocks.  We probably should check if the registration is null before reporting the bad blocks., Yes Nicholas 
this is a simple defect :) probably will gave a patch today, Since the exception thrown is internally caught I couldn't right a good test case which can assert the functionality correctly., +1 patch looks good.

I agree that it is not easy to add a new test and the change is straightforward.  Please manually test it.  Thanks, amith., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12525315/HDFS-3332.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    -1 javadoc.  The javadoc tool appears to have generated 2 warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2361//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/2361//artifact/trunk/trunk/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2361//console

This message is automatically generated., I manually tested patch, it works fine.
Findbugs link is not opening in order to clear it :(, The findbugs warning is not related to this., Yes, findbug is related to HDFS-3350.
Thanks for the patch Amith.
Thanks for the review Nicholas. I will commit this patch., Thanks both of u, Integrated in Hadoop-Hdfs-trunk-Commit #2255 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/2255/])
    HDFS-3332. NullPointerException in DN when directoryscanner is trying to report bad blocks. Contributed by  Amith D K. (Revision 1333587)

     Result = SUCCESS
umamahesh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1333587
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java
, Integrated in Hadoop-Common-trunk-Commit #2181 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/2181/])
    HDFS-3332. NullPointerException in DN when directoryscanner is trying to report bad blocks. Contributed by  Amith D K. (Revision 1333587)

     Result = SUCCESS
umamahesh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1333587
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java
, I have just committed this to trunk and branch-2., Integrated in Hadoop-Mapreduce-trunk-Commit #2199 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/2199/])
    HDFS-3332. NullPointerException in DN when directoryscanner is trying to report bad blocks. Contributed by  Amith D K. (Revision 1333587)

     Result = ABORTED
umamahesh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1333587
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java
, Integrated in Hadoop-Hdfs-trunk #1034 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1034/])
    HDFS-3332. NullPointerException in DN when directoryscanner is trying to report bad blocks. Contributed by  Amith D K. (Revision 1333587)

     Result = FAILURE
umamahesh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1333587
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java
, Integrated in Hadoop-Mapreduce-trunk #1069 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1069/])
    HDFS-3332. NullPointerException in DN when directoryscanner is trying to report bad blocks. Contributed by  Amith D K. (Revision 1333587)

     Result = SUCCESS
umamahesh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1333587
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java
]