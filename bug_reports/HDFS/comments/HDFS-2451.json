[Seems like the call to {{blockManager.countNodes()}} is happening under namesystem's write locking elsewhere. Otherwise a race condition is likely., Hi Cos,
 I too think that was the cause. There is one more place in the test, where it is not taking the lock on fsnamesystem.
{code}
 // The block should be replicated
      do {
        num = namesystem.blockManager.countNodes(block);
      } while (num.liveReplicas() != REPLICATION_FACTOR);
      
{code}
Do you have any reason for not putting lock here?

Thanks
Uma, Because I've missed it ;( Thanks for catching., Looks like a race condition going on in the test itself. BlockManager.countNodes() should be called under a lock (readLock() TestNodeCount). If not under lock somebody can remove a replica between nodeIter.hasNext() and nodeIter.next() in countNodes(), which will return NULL and cause NPE., Sorry for the late comment. I wrote it yesterday, and pushed the Add button only today... The patch looks good except that ".gitignore" changes are unrelated., Yeah, .gitignore is relevant yet useful ;)
Here's new one.
I will run commit the patch soon, I have committed it to 0.22 branch.

An interesting observation: this problem has been fixed in the trunk a while ago as I have found out just yet checking if the patch needs to be applied for the trunk as well. Apparently, backporting wasn't a priority for trunk development ;(, As I suspected: it has been fixed long time ago in the trunk ;(, And one more...., Integrated in Hadoop-Hdfs-22-branch #100 (See [https://builds.apache.org/job/Hadoop-Hdfs-22-branch/100/])
    HDFS-2451. TestNodeCount.testNodeCount failes with NPE. Contributed by Konstantin Boudnik.

cos : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1186556
Files : 
* /hadoop/common/branches/branch-0.22/hdfs/CHANGES.txt
* /hadoop/common/branches/branch-0.22/hdfs/src/test/hdfs/org/apache/hadoop/hdfs/server/namenode/TestNodeCount.java
]