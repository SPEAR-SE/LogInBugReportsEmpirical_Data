[Here's a patch which addresses the issue. Previous to HDFS-3893, this test case was only inadvertently working since the testBlockTokenInLastLocatedBlock test case creates its own Configuration object (i.e. doesn't reuse the static one in the test class) and when starting the NN in the MiniDFSCluster this would cause {{UserGroupInformation#setConfiguration}} to be called with a Configuration object which had security disabled, thereby globally disabling Kerberos.

The fix is to only enable Kerberos in the conf for those test cases that actually require it for the functionality they aim to test. This patch also causes Kerberos to be disabled before each test case is run, which should make the whole test less fragile. (Previously, testBlockTokenRpc and testBlockTokenRpcLeak would fail if testBlockTokenInLastLocatedBlock happened to be run before them.)

I tested this patch by running TestBlockToken and all of the QJM tests. They all pass with this patch applied., +1, Thanks a lot for the quick review, Todd. I've just committed this to the HDFS-3077 branch.]