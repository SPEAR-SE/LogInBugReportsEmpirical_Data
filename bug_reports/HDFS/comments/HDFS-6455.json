[The code throws IllegalArgumentException so the error is printed into xxx.out file instead of xxx.log file.
Here we should throw non-run-time exception since the wrong configuration is a user error. , Hey Brandon, I compared this with the NN's behavior for illegal arguments and even it throws IllegalArgumentException. NN's main catches this exception, logs a FATAL message (making sure it gets added in logs) and then calls terminate(). Should we similarly add a log message here instead before exiting? 

Also, as per your comments in HDFS-6456, shutdown may not be desirable for incorrect exports as we want to support refreshing them without restarting NFS gateway. So we should make sure we catch the exception appropriately, log it and not shutdown here? Please advise. Thank you! , {quote}Should we similarly add a log message here instead before exiting? {quote}
Yes. A log message is preferred.
{quote}So we should make sure we catch the exception appropriately, log it and not shutdown here? {quote}
Agree. , Thanks for the feedback Brandon. Attaching a patch which catches the exception and logs it as ERROR in logs. NFS server does not exit now. 'showmount' command times out when invalid exports are provided.  

Output of 'hdfs nfs3':
{code}
14/07/06 02:13:37 INFO nfs3.Nfs3Base: registered UNIX signal handlers for [TERM, HUP, INT]
14/07/06 02:13:38 INFO oncrpc.RpcProgram: Will accept client connections from unprivileged ports
14/07/06 02:13:38 INFO nfs3.IdUserGroup: Not doing static UID/GID mapping because '/etc/nfs.map' does not exist.
14/07/06 02:13:38 INFO nfs3.IdUserGroup: Updated user map size: 36
14/07/06 02:13:38 INFO nfs3.IdUserGroup: Updated group map size: 65
14/07/06 02:13:38 ERROR nfs.NfsExports: Invalid NFS Exports provided:
java.lang.IllegalArgumentException: Incorrectly formatted line 'abc ro :foobar rw'
	at org.apache.hadoop.nfs.NfsExports.getMatch(NfsExports.java:363)
	at org.apache.hadoop.nfs.NfsExports.<init>(NfsExports.java:158)
	at org.apache.hadoop.nfs.NfsExports.getInstance(NfsExports.java:57)
	at org.apache.hadoop.hdfs.nfs.nfs3.RpcProgramNfs3.<init>(RpcProgramNfs3.java:177)
	at org.apache.hadoop.hdfs.nfs.nfs3.Nfs3.<init>(Nfs3.java:45)
	at org.apache.hadoop.hdfs.nfs.nfs3.Nfs3.startService(Nfs3.java:66)
	at org.apache.hadoop.hdfs.nfs.nfs3.Nfs3.main(Nfs3.java:72)
14/07/06 02:13:38 INFO nfs3.WriteManager: Stream timeout is 600000ms.
14/07/06 02:13:38 INFO nfs3.WriteManager: Maximum open streams is 256
14/07/06 02:13:38 INFO nfs3.OpenFileCtxCache: Maximum open streams is 256
14/07/06 02:13:39 WARN util.NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
14/07/06 02:13:39 INFO nfs3.RpcProgramNfs3: Delete current dump directory /tmp/.hdfs-nfs3
14/07/06 02:13:39 INFO nfs3.RpcProgramNfs3: Create new dump directory /tmp/.hdfs-nfs3
14/07/06 02:13:39 INFO nfs3.Nfs3Base: NFS server port set to: 2049
14/07/06 02:13:39 INFO oncrpc.RpcProgram: Will accept client connections from unprivileged ports
14/07/06 02:13:39 ERROR nfs.NfsExports: Invalid NFS Exports provided:
java.lang.IllegalArgumentException: Incorrectly formatted line 'abc ro :foobar rw'
	at org.apache.hadoop.nfs.NfsExports.getMatch(NfsExports.java:363)
	at org.apache.hadoop.nfs.NfsExports.<init>(NfsExports.java:158)
	at org.apache.hadoop.nfs.NfsExports.getInstance(NfsExports.java:57)
	at org.apache.hadoop.hdfs.nfs.mount.RpcProgramMountd.<init>(RpcProgramMountd.java:88)
	at org.apache.hadoop.hdfs.nfs.mount.Mountd.<init>(Mountd.java:37)
	at org.apache.hadoop.hdfs.nfs.nfs3.Nfs3.<init>(Nfs3.java:46)
	at org.apache.hadoop.hdfs.nfs.nfs3.Nfs3.startService(Nfs3.java:66)
	at org.apache.hadoop.hdfs.nfs.nfs3.Nfs3.main(Nfs3.java:72)
14/07/06 02:13:40 INFO oncrpc.SimpleUdpServer: Started listening to UDP requests at port 4242 for Rpc program: mountd at localhost:4242 with workerCount 1
14/07/06 02:13:40 INFO oncrpc.SimpleTcpServer: Started listening to TCP requests at port 4242 for Rpc program: mountd at localhost:4242 with workerCount 1
14/07/06 02:13:40 INFO oncrpc.SimpleTcpServer: Started listening to TCP requests at port 2049 for Rpc program: NFS3 at localhost:2049 with workerCount 0
{code}, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12654201/HDFS-6455.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-nfs hadoop-hdfs-project/hadoop-hdfs-nfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/7284//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/7284//console

This message is automatically generated., The patch looks good.
{quote}'showmount' command times out when invalid exports are provided. {quote}
is this due to NFS bug?, Thanks for reviewing the patch [~brandonli]. This is the output of showmount command:

{code}
abutala@abutala-vBox:~$ showmount -e 127.0.1.1
rpc mount export: RPC: Timed out
{code}

I don't see any errors or log messages in NFS server output. What should be the correct behavior of showmount in this case?, Sorry for the late reply. The time out is possibly due to this code in the patch:
{noformat}
+      if (hostsMatcher != null) {
+        hostsMatchers.add(hostsMatcher);
+        out = MountResponse.writeExportList(out, xid, exports, hostsMatchers);
+      }
{noformat}

If hostMatcher is null, it doesn't send response back.
I would suggest fixing HDFS-6456 first since it will fix part of the problem. After patch to HDFS-6456 is committed, this problem will be easier to fix.
, [~abutala], HDFS-6456 has been fixed. Please rebased the current patch. I think it should be a smaller change now. :-), Thanks [~brandonli], I rebased the patch and addressed the showmount timeout issue. This is how the showmount output looks like now:

{code}
showmount -e 127.0.1.1
rpc mount export: RPC: Procedure unavailable
{code}

So to summarize the patch does following:
1. Catch IllegalArgumentException, log it and return null NFS export instead of exiting the program.
2. Handle null NFS exports at appropriate places to avoid NullPointerException.

Let me know if anything. Thanks again!, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12656009/HDFS-6455.002.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-nfs hadoop-hdfs-project/hadoop-hdfs-nfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/7359//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/7359//console

This message is automatically generated., Thank you, [~abutala]. The patch looks good. It would be nice to add a unit test to validate the fix. You can use TestReaddir as a reference to add the unit test., Thanks for reviewing the patch [~brandonli]. As a part of fix to HDFS-6456, I have already added a unit test which also checks for invalid separator (given below) in allowed.hosts . Let me know if there is any other test case I should add.

{code}
+  @Test(expected=IllegalArgumentException.class)
+  public void testInvalidSeparator() {
+      NfsExports matcher = new NfsExports(CacheSize, ExpirationPeriod,
+        "foo ro : bar rw");
+  }
{code}, Sounds ok to me.
+1. , I've committed the patch. Thank you, [~abutala], for the contribution!
 , FAILURE: Integrated in Hadoop-trunk-Commit #5955 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/5955/])
HDFS-6455. NFS: Exception should be added in NFS log for invalid separator in nfs.exports.allowed.hosts. Contributed by Abhiraj Butala (brandonli: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1612947)
* /hadoop/common/trunk/hadoop-common-project/hadoop-nfs/src/main/java/org/apache/hadoop/nfs/NfsExports.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs-nfs/src/main/java/org/apache/hadoop/hdfs/nfs/mount/RpcProgramMountd.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs-nfs/src/main/java/org/apache/hadoop/hdfs/nfs/nfs3/RpcProgramNfs3.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Yarn-trunk #622 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/622/])
HDFS-6455. NFS: Exception should be added in NFS log for invalid separator in nfs.exports.allowed.hosts. Contributed by Abhiraj Butala (brandonli: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1612947)
* /hadoop/common/trunk/hadoop-common-project/hadoop-nfs/src/main/java/org/apache/hadoop/nfs/NfsExports.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs-nfs/src/main/java/org/apache/hadoop/hdfs/nfs/mount/RpcProgramMountd.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs-nfs/src/main/java/org/apache/hadoop/hdfs/nfs/nfs3/RpcProgramNfs3.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1814 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1814/])
HDFS-6455. NFS: Exception should be added in NFS log for invalid separator in nfs.exports.allowed.hosts. Contributed by Abhiraj Butala (brandonli: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1612947)
* /hadoop/common/trunk/hadoop-common-project/hadoop-nfs/src/main/java/org/apache/hadoop/nfs/NfsExports.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs-nfs/src/main/java/org/apache/hadoop/hdfs/nfs/mount/RpcProgramMountd.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs-nfs/src/main/java/org/apache/hadoop/hdfs/nfs/nfs3/RpcProgramNfs3.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk #1841 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1841/])
HDFS-6455. NFS: Exception should be added in NFS log for invalid separator in nfs.exports.allowed.hosts. Contributed by Abhiraj Butala (brandonli: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1612947)
* /hadoop/common/trunk/hadoop-common-project/hadoop-nfs/src/main/java/org/apache/hadoop/nfs/NfsExports.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs-nfs/src/main/java/org/apache/hadoop/hdfs/nfs/mount/RpcProgramMountd.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs-nfs/src/main/java/org/apache/hadoop/hdfs/nfs/nfs3/RpcProgramNfs3.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
]