[
{noformat}
java.lang.ClassCastException: org.apache.hadoop.hdfs.client.HdfsDataInputStream cannot be cast to org.apache.hadoop.hdfs.DFSClient$DFSDataInputStream
	at org.apache.hadoop.hdfs.TestShortCircuitLocalRead.checkFileContentDirect(TestShortCircuitLocalRead.java:183)
	at org.apache.hadoop.hdfs.TestShortCircuitLocalRead.doTestShortCircuitReadImpl(TestShortCircuitLocalRead.java:273)
	at org.apache.hadoop.hdfs.TestShortCircuitLocalRead.doTestShortCircuitRead(TestShortCircuitLocalRead.java:228)
	at org.apache.hadoop.hdfs.TestShortCircuitLocalRead.testFileLocalReadNoChecksum(TestShortCircuitLocalRead.java:283)
{noformat}, [~cmccabe] Can you check whether HADOOP-9414 or HADOOP-9416 has anything to do with it?, It looks like the problem is that trunk has HDFS-3322, whereas branch-2 does not.

I think we should just port HDFS-3322 to branch-2 (it's unclear why it isn't there now) to fix this.

Also, I don't think that the trunk build skips -Pnative.  Unless something has changed recently, that should not be true., update: HDFS-3322 was backported to branch-2, just not correctly.  Let me fix., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12592622/HDFS-4999-b2.001.patch
  against trunk revision .

    {color:red}-1 patch{color}.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/4665//console

This message is automatically generated., +1 The patch looks good.

I ran the test with the patch against branch-2.

{noformat}
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running org.apache.hadoop.hdfs.TestShortCircuitLocalRead
Tests run: 10, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 29.136 sec

Results :

Tests run: 10, Failures: 0, Errors: 0, Skipped: 0
{noformat}, Thanks for the quick fix, Colin. I've committed this to branch-2 and branch-2.1-beta.]