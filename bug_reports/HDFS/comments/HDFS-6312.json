[[~daryn] in our testing with webhdfs + HA on a secure cluster we hit HADOOP-10519. I am curious what kind of job did you run that actually started running tasks., I found the bug by just looking at the code.  {{resetStateToFailOver}} nulls out the internal token and clears the init flag in {{TokenAspect}}.  The next operation that calls {{getDelegationToken()}} to build the auth params for the url will attempt to acquire a new token.

HADOOP-10519 is a different issue.  The HA support in webhdfs has many flaws., Ah i see. I was just curious to see if could add more tests to reach this issue :)., Yes, of course on the tests. :)  I don't enjoy being the test subject for security changes with no code coverage...  I may fix this as part of a later change., HI [~daryn],

I filed HDFS-6510 for the same issue and [~wheat9] sent me here (thanks Haohui).  I wonder if we can dedicate this jira for this particular issue instead of bundling with other fix?

Thanks.
, Hi Daryn,

Attached is a quick fix for this issue, I tried to write a testcase but was not successful. However, I tested out the fix in a real cluster and I can see the problem without the patch, and see the patch resolved the problem.

Would you please take a look to see if we can have this issue fixed first?

Thanks a lot!

--Yongjun
, Patch LGTM. 

[~daryn], this is fixing a problem in its own merit. Do you see any issue committing this JIRA separately for your larger fix? (BTW, any JIRA for it?)

, planning to commit this tomorrow around noon PST., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12650623/HDFS-6312.attempted.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/7179//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/7179//console

This message is automatically generated., Thanks Daryn and Yongjun. Committed to trunk and branch-2.

(on the commit message i've given credit to Daryn as i saw the JIRA was assigned to him, sorry for the mishap)., Many thanks Alejandro and Daryn!
, SUCCESS: Integrated in Hadoop-trunk-Commit #5740 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/5740/])
HDFS-6312. WebHdfs HA failover is broken on secure clusters. (daryn via tucu) (tucu: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1604045)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/WebHdfsFileSystem.java
, SUCCESS: Integrated in Hadoop-Yarn-trunk #589 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/589/])
HDFS-6312. WebHdfs HA failover is broken on secure clusters. (daryn via tucu) (tucu: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1604045)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/WebHdfsFileSystem.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1780 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1780/])
HDFS-6312. WebHdfs HA failover is broken on secure clusters. (daryn via tucu) (tucu: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1604045)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/WebHdfsFileSystem.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1807 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1807/])
HDFS-6312. WebHdfs HA failover is broken on secure clusters. (daryn via tucu) (tucu: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1604045)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/WebHdfsFileSystem.java
]