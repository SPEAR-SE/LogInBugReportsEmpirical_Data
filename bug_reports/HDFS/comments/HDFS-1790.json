[The setting of safemode should be done inside the FSNamesystem write lock. The checking of safemode should be done inside the  FSNamesystem read lock. But can you explain why the SafeMode object needs its own "synchronization"?, SafeModeInfo contains several numeric variables which are overloaded with "in manual" or "in extension" or "not actually in safemode" semantics based on special values -- instead of just having a "state" variable (which I'm now providing).  Consequently, these variables may need to be read/written in a synchronized way.  So it isn't unreasonable to synchronize them on the SafeModeInfo instance.  But it seems to me that it is being done inconsistently, as described above.

Do I understand you correctly, that you agree incVolumeFailure(), isInSafeMode() and isPopulatingReplQueues(), should use the read/write lock rather than synchronizing on the FSNamesystem instance?  Thanks., incVolumeFailure(), isInSafeMode() and isPopulatingReplQueues() should use the FSNamesystem read/write lock.]