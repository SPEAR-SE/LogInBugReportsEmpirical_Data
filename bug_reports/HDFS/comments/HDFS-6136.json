[Patch attached, Hey Nick. This is a surprising bug fix since data transfer apparently works fine without it. Is there any effect of this change? If not, why not? Seems like getting this wrong should cause problems :), I am looking the related code these days, i agree with Nick's finding.
Seems Nick didn't make the patch under root dir and could not let QA robot run successful.
I just made HDFS-6136.txt per original patch and added a test verifier to expose this issue.
We works fine before, per my understanding, since when we generate a new "curHeader", we use the real interesting stuff only in later code flow, like: offset into block,pipeline seq no,data length...
I think it's still a potential bomb here, we do need to fix it., The current implementation always sends an empty packet at the end of a block transfer with the lastpacketinblock is set to true. However, if you send a packet with data in (ie datalen > 0) as your last packet (and so set the lastpacketinblock = true) the DN throws an exception (I've not got a stack trace to hand) and refuses to accept the block. I believe this should be supported behaviour, as it saves a bit of network traffic. Thanks -]