[Backport HDFS-4240 , Thanks Meng for doing this work. I will review your patch. Would you post the result of test patch?, Thanks for the patch. There are some trivial issue need to be addressed here:
1. Fix an indent issue in method of addToExcludedNodes() in BlockPlacementPolicyWithNodeGroup.java
2. Fix indent issue in define dataNodesInBoundaryCase[] and dataNodesInMoreTargetsCase[] in TestReplicationPolicyWithNodeGroup.java to keep consistent.
3. Replace unnecessary two blank lines below with one blank line
{noformat}
+     
+      File baseDir = new File(System.getProperty(
+           "test.build.data", "build/test/data"), "dfs/");
+      CONF.set(DFSConfigKeys.DFS_NAMENODE_NAME_DIR_KEY,
+           new File(baseDir, "name").getPath());
+            
+ 
{noformat}
4. Indent and unnecessary double blank lines issue for checkTargetsOnDifferentNodeGroup() in TestReplicationPolicyWithNodeGroup.java
5. Indent issue for following code: 
{noformat}
+    for(int i=0; i<NUM_OF_DATANODES_BOUNDARY; i++) {
+        dataNodes[0].updateHeartbeat(
+                2*MIN_BLOCKS_FOR_WRITE*BLOCK_SIZE, 0L,
+                (MIN_BLOCKS_FOR_WRITE-1)*BLOCK_SIZE, 0);
+        
+      dataNodesInBoundaryCase[i].updateHeartbeat(
+          2*MIN_BLOCKS_FOR_WRITE*BLOCK_SIZE, 0L,
+          2*MIN_BLOCKS_FOR_WRITE*BLOCK_SIZE, 0);
+    }

{noformat}
6. Remove unnecessary blank lines in the last several lines of TestReplicationPolicyWithNodeGroup.java, Thanks For Junpingï¼Œ I have corrected these intents, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12562437/HDFS-4337-v2.patch
  against trunk revision .

    {color:red}-1 patch{color}.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3693//console

This message is automatically generated., Thanks for updating in v2 patch. The patch looks good to me but a minor issue below:
The method of checkTargetsOnDifferentNodeGroup() in TestReplicationPolicyWithNodeGroup(), you should use indent 2 instead of 3:
{noformat}
    if(targets.length == 0)
       return true;
{noformat}
Can you correct it and post the test-patch result on branch-1? Thanks!
BTW, you don't have to remove previous patch in updating a new one. Also, for non-trunk patch, please get rid of submit patch. As current pre-commit test only for trunk branch., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12562444/HDFS-4337-v3.patch
  against trunk revision .

    {color:red}-1 patch{color}.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3695//console

This message is automatically generated., Thanks for junping. Following is the result of test
Ant test-commit build success

{noformat}
-1 overall.  

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 4 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 2.0.1) warnings.

{noformat}, Meng, could you also run all the unit tests for your patch?, For Nicholas:
I have runned all the unit tests and triggered two issue: MAPREDUCE-4906 and MAPREDUCE-4904
These two issue can be reproduce without this patch HDFS-4337
I will resolve them
Thank you, +1 patch looks good., I have committed this.  Thanks, Meng!, 
, Closed upon release of Hadoop 1.2.0.]