[I reproduce this problem with the following configuration:
1. set two storage directories, say dirA and dirB
2. start and then shutdown namenode 
3. change only dirB's layout version from -40 to 123.
4. start namenode and it should fail with the above NullPointerException

The problem here is:

Two storage inspectors are used in namenode, FSImagePreTransactionalStorageInspector for layout version before -38, and FSImageTransactionalStorageInspector for -38 or anything later.

In this case, the modified storage directory happens to be the last one inspected by the namenode in order to load image/edits. Even though it sees two layout version, it saves the last one ("123" in this case) as the storage layout version. However, it uses FSImageTransactionalStorageInspector to get image path because dirA still has -40 and then uses FSImagePreTransactionalStorageInspector to get edit stream. Because FSImagePreTransactionalStorageInspector can't recognize
 the file in a storage directory whose real version is newer, some references are not initialized which eventually cause the exception.

, Instead of allowing namenode to move forward with multiple layout versions, the storage inspector selector (NNStroage.readAndInspectDirs) should throw exception saying the inconsistent layout versions.
, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12527967/HDFS-3415.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 javadoc.  The javadoc tool appears to have generated 2 warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2466//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2466//console

This message is automatically generated., The warnings are not introduced by this patch. I did manually test to verify an exception is thrown when the layout versions are not the same., The patch looks good.  Could you also improve the error message?  We may first put all the dirs and versions in a map (Map<File, Integer>: root dir => version), check if all the versions are equal and, if not, print out all dirs and versions., New improved the error information. The error print out like the following:

java.io.IOException: Storage directories containe different layout versions: (/private/tmp/singlenn, -40) (/private/tmp/singlenn-edit, 123)
 , {quote}We may first put all the dirs and versions in a map (Map<File, Integer>: root dir => version), check if all the versions are equal and, if not, print out all dirs and versions.{quote}
Done with minor difference that the message is saved in a string not a map. , -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12528188/HDFS-3415.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 javadoc.  The javadoc tool appears to have generated 2 warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2484//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/2484//artifact/trunk/trunk/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2484//console

This message is automatically generated., I actually want you remove the min and max computation since it does not make sense to compute min and max for checking equality.  It is okay if you don't want to.  However, please remove "if (minLayoutVersion > maxLayoutVersion) {..}".

You should use StringBuilder instead of String as indicated by [the new findbugs warning|https://builds.apache.org/job/PreCommit-HDFS-Build/2484/artifact/trunk/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html]., {quota}I actually want you remove the min and max computation since it does not make sense to compute min and max for checking equality.{quota}
Got it. minversion and maxversion are not needed anymore. Done.

{quota}You should use StringBuilder instead of String as indicated by the new findbugs warning.{quota}
Done. Thanks!, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12528471/HDFS-3415.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    -1 findbugs.  The patch appears to introduce 1 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.TestListFilesInFileContext
                  org.apache.hadoop.hdfs.server.blockmanagement.TestBlocksWithNotEnoughRacks
                  org.apache.hadoop.hdfs.server.datanode.TestBPOfferService
                  org.apache.hadoop.hdfs.TestDatanodeBlockScanner

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2497//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/2497//artifact/trunk/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2497//console

This message is automatically generated., Fix the warning.
The test failures are unrelated. , -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12528528/HDFS-3415.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2499//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2499//console

This message is automatically generated., +1 patch looks good., Hi Brandon, since there is no new tests, could you manually test it?, Manually tested it. It works as expected: throws exception if there are multiple layout versions., I have committed this.  Thanks, Brandon!, Integrated in Hadoop-Hdfs-trunk-Commit #2353 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/2353/])
    HDFS-3415. Make sure all layout versions are the same for all storage directories in the Namenode.  Contributed by Brandon Li (Revision 1341676)

     Result = SUCCESS
szetszwo : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1341676
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/NNStorage.java
, Integrated in Hadoop-Common-trunk-Commit #2280 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/2280/])
    HDFS-3415. Make sure all layout versions are the same for all storage directories in the Namenode.  Contributed by Brandon Li (Revision 1341676)

     Result = SUCCESS
szetszwo : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1341676
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/NNStorage.java
, Integrated in Hadoop-Mapreduce-trunk-Commit #2298 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/2298/])
    HDFS-3415. Make sure all layout versions are the same for all storage directories in the Namenode.  Contributed by Brandon Li (Revision 1341676)

     Result = FAILURE
szetszwo : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1341676
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/NNStorage.java
, Integrated in Hadoop-Hdfs-trunk #1054 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1054/])
    HDFS-3415. Make sure all layout versions are the same for all storage directories in the Namenode.  Contributed by Brandon Li (Revision 1341676)

     Result = SUCCESS
szetszwo : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1341676
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/NNStorage.java
, Integrated in Hadoop-Mapreduce-trunk #1088 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1088/])
    HDFS-3415. Make sure all layout versions are the same for all storage directories in the Namenode.  Contributed by Brandon Li (Revision 1341676)

     Result = SUCCESS
szetszwo : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1341676
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/NNStorage.java
]