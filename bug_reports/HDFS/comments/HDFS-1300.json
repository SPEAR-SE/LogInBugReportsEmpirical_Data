[Please have a look at the patch.
Instead of inserting only when it doesn't exist we should rather follow the same way we handle dead datanodes. Update the block, so it will move up in priority queues when more nodes get decommissioned., Submitting to Hudson.
Can someone look at the code to see that it is OK?, Patch agains updated trunk, Submitting to Hudson again., Dmytro- Looks like the updated patch dropped the unit test. Can you upload a new one with it re-attached?  Thanks., The patch with the test in it. Also fixed the test to work with the latest change in trunk., submitting for hudson, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12459401/HDFS-1300.3.patch
  against trunk revision 1072023.

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 5 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these core unit tests:
                  org.apache.hadoop.cli.TestHDFSCLI
                  org.apache.hadoop.hdfs.server.datanode.TestBlockRecovery
                  org.apache.hadoop.hdfs.TestFileConcurrentReader

    -1 contrib tests.  The patch failed contrib unit tests.

    +1 system test framework.  The patch passed system test framework compile.

Test results: https://hudson.apache.org/hudson/job/PreCommit-HDFS-Build/191//testReport/
Findbugs warnings: https://hudson.apache.org/hudson/job/PreCommit-HDFS-Build/191//artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html
Console output: https://hudson.apache.org/hudson/job/PreCommit-HDFS-Build/191//console

This message is automatically generated., Patch no longer applies.]