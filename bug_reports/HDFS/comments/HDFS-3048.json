[Here's an example NPE seen in a unit test.

{noformat}
    [junit] 12/02/14 05:25:53 WARN blockmanagement.BlockManager: ReplicationMonitor thread received Runtime exception. 
    [junit] java.lang.NullPointerException
    [junit] 	at org.apache.hadoop.hdfs.server.blockmanagement.BlocksMap.getINode(BlocksMap.java:97)
    [junit] 	at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.computeReplicationWorkForBlocks(BlockManager.java:1062)
    [junit] 	at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.computeReplicationWork(BlockManager.java:1037)
    [junit] 	at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.computeDatanodeWork(BlockManager.java:2917)
    [junit] 	at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager$ReplicationMonitor.run(BlockManager.java:2877)
    [junit] 	at java.lang.Thread.run(Thread.java:662)
{noformat}
, Patch attached., I think you'd need to do a join() on the replication manager, otherwise there's still potentially a race, right? I seem to remember trying to fix this once, but ran into a deadlock issue with the join() call., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12517119/hdfs-3048.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests:
                  org.apache.hadoop.hdfs.TestFileAppend4

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/1953//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/1953//console

This message is automatically generated., Fix in HDFS-3787., Posting the patch from HDFS-3787 since that jira seems broken., +1, -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12540834/hdfs-3787-2.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.web.TestWebHdfsWithMultipleNameNodes

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/3006//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3006//console

This message is automatically generated., The test failure in TestWebHdfsWithMultipleNameNodes seems like it might be related. I'll loop it locally and see if I can reproduce., I looped TestWebHdfsWithMultipleNameNodes 1014 times and did not reproduce the ConcurrentModificationException shown at https://builds.apache.org/job/PreCommit-HDFS-Build/3006//testReport/org.apache.hadoop.hdfs.web/TestWebHdfsWithMultipleNameNodes/org_apache_hadoop_hdfs_web_TestWebHdfsWithMultipleNameNodes/

I did see one apparently unrelated failure on iteration 539 of 1014:

{noformat}
Failed tests:   testClusterIdMismatch(org.apache.hadoop.hdfs.server.datanode.TestDataNodeMultipleRegistrations): should've registered with three namenodes expected:<3> but was:<4>
{noformat}
This appears to be a race condition in the test; the assert is testing the number of BlockPoolOfferServices registered, and the log shows that the DN thread ended the BPOS 1 millisecond before the assert failed.
{noformat}
2012-08-15 02:05:31,725 FATAL datanode.DataNode (BPServiceActor.java:run(665)) - Initialization failed for block pool Block pool BP-108934869-127.0.1.1-1345021531615 (storage id DS-53519991-127.0.1.1-50044-1345021531116) service to localhost/127.0.0.1:9948
java.io.IOException: Cluster IDs not matched: dn cid=testClusterID but ns cid=DifferentCID; bpid=BP-108934869-127.0.1.1-1345021531615
        at org.apache.hadoop.hdfs.server.datanode.DataNode.setClusterId(DataNode.java:319)
        at org.apache.hadoop.hdfs.server.datanode.DataNode.initBlockPool(DataNode.java:808)
        at org.apache.hadoop.hdfs.server.datanode.BPOfferService.verifyAndSetNamespaceInfo(BPOfferService.java:308)
        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.connectToNNAndHandshake(BPServiceActor.java:218)
        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.run(BPServiceActor.java:661)
        at java.lang.Thread.run(Thread.java:679)
2012-08-15 02:05:31,726 WARN  datanode.DataNode (BPServiceActor.java:run(683)) - Ending block pool service for: Block pool BP-108934869-127.0.1.1-1345021531615 (storage id DS-53519991-127.0.1.1-50044-1345021531116) service to localhost/127.0.0.1:9948
2012-08-15 02:05:31,726 WARN  hdfs.MiniDFSCluster (MiniDFSCluster.java:shouldWait(1841)) - BPOfferService in datanode DataNode{data=FSDataset{dirpath='[/home/adi/w/apache-hadoop-trunk/hadoop-hdfs-project/hadoop-hdfs/target/test/data/dfs/data/data1/current, /home/adi/w/apache-hadoop-trunk/hadoop-hdfs-project/hadoop-hdfs/target/test/data/dfs/data/data2/current]'}, localName='127.0.0.1:50044', storageID='DS-53519991-127.0.1.1-50044-1345021531116', xmitsInProgress=0} failed to connect to namenode at localhost/127.0.0.1:9948
2012-08-15 02:05:31,726 INFO  datanode.TestDataNodeMultipleRegistrations (TestDataNodeMultipleRegistrations.java:testClusterIdMismatch(216)) - dn bpos len (still should be 3):4
{noformat}

Since this is a different failure and I didn't repro the Jenkins failure, let's try kicking Jenkins again and see if it happens again., Reattaching same patch to retrigger Jenkins., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12541111/hdfs-3048.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/3015//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3015//console

This message is automatically generated., bq. Please justify why no new tests are needed for this patch.

No testcases, because the race is very hard to hit without modifying the code., +1 lgtm 
, Forgot to mention, per Todd's comment above ("I seem to remember trying to fix this once, but ran into a deadlock issue with the join() call.") I looked and I don't see a deadlock issue with the join call, eg I don't see how it could be blocked on the BlockManager#close path that's waiting on it. Because the DN doesn't catch sig STOP we don't actually run the shutdown path in normal execution., I've committed this to trunk and merged to branch-2. Thanks Andy!, Integrated in Hadoop-Common-trunk-Commit #2582 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/2582/])
    HDFS-3048. Small race in BlockManager#close. Contributed by Andy Isaacson (Revision 1373664)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1373664
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockManager.java
, Integrated in Hadoop-Hdfs-trunk-Commit #2647 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/2647/])
    HDFS-3048. Small race in BlockManager#close. Contributed by Andy Isaacson (Revision 1373664)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1373664
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockManager.java
, Integrated in Hadoop-Mapreduce-trunk-Commit #2611 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/2611/])
    HDFS-3048. Small race in BlockManager#close. Contributed by Andy Isaacson (Revision 1373664)

     Result = FAILURE
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1373664
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockManager.java
, Integrated in Hadoop-Hdfs-trunk #1136 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1136/])
    HDFS-3048. Small race in BlockManager#close. Contributed by Andy Isaacson (Revision 1373664)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1373664
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockManager.java
, Integrated in Hadoop-Mapreduce-trunk #1168 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1168/])
    HDFS-3048. Small race in BlockManager#close. Contributed by Andy Isaacson (Revision 1373664)

     Result = FAILURE
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1373664
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockManager.java
]