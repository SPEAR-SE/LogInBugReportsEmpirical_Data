[Attached patch fixes the bug., It looks good. 

What's the expected behavior if renaming directory /a/b to be /a/b/? Could you please add a unit test for this?, > What's the expected behavior if renaming directory /a/b to be /a/b/? Could you please add a unit test for this?
It depends on what /a/b is.
# if /a/b is directory then rename as it is implemented tries to rename /a/b to /a/b/b. This fails since dst is a directory or file under src.
# If /a/b is a file, it succeeds under the condition src and dst are the same.

Attached a new patch that adds some comments to make the rename tests with quota more clear., +1, Hudson builds are not running. Ran the tests myself. Latest patch passes all the tests except TestBackupNode(HDFS-192):

Here is the test-patch result:
[exec] +1 overall.
[exec]
[exec] +1 @author. The patch does not contain any @author tags.
[exec]
[exec] +1 tests included. The patch appears to include 16 new or modified tests.
[exec]
[exec] +1 javadoc. The javadoc tool did not generate any warning messages.
[exec]
[exec] +1 javac. The applied patch does not increase the total number of javac compiler warnings.
[exec]
[exec] +1 findbugs. The patch does not introduce any new Findbugs warnings.
[exec]
[exec] +1 release audit. The applied patch does not increase the total number of release audit warnings.
[ Show Â» ]
Suresh Srinivas added a comment - 15/Oct/09 12:22 AM Latest patch passes all the tests with the following exception:

   1. org.apache.hadoop.hdfs.TestFileAppend3 (HDFS-668)
   2. org.apache.hadoop.hdfs.server.namenode.TestBackupNode(HDFS-192)

Here is the test-patch result: [exec] +1 overall. [exec] [exec] +1 @author. The patch does not contain any @author tags. [exec] [exec] +1 tests included. The patch appears to include 16 new or modified tests. [exec] [exec] +1 javadoc. The javadoc tool did not generate any warning messages. [exec] [exec] +1 javac. The applied patch does not increase the total number of javac compiler warnings. [exec] [exec] +1 findbugs. The patch does not introduce any new Findbugs warnings. [exec] [exec] +1 release audit. The applied patch does not increase the total number of release audit warnings.
, Committed this change to both 21 and trunk., Integrated in Hdfs-Patch-h2.grid.sp2.yahoo.net #47 (See [http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/47/])
    , Integrated in Hadoop-Hdfs-trunk-Commit #79 (See [http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk-Commit/79/])
    , Integrated in Hadoop-Hdfs-trunk #120 (See [http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk/120/])
    , Integrated in Hdfs-Patch-h5.grid.sp2.yahoo.net #78 (See [http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/78/])
    ]