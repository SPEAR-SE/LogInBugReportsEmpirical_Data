[Correlating OEV output vs audit log output, this seems to be an error on the _writer_ side.

{code}
2012-02-22 13:07:11,564 INFO org.apache.hadoop.hdfs.StateChange: DIR* NameSystem.completeFile: file /benchmarks/TestDFSIO/io_data/test_io_38 is closed by DFSClient_attempt_13299438936
{code}
corresponds to an OP_CLOSE

Then I see:
{code}
2012-02-22 13:15:37,959 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem.audit: ugi=todd (auth:SIMPLE)  ip=/172.29.99.9 cmd=append      src=/benchmarks/TestDFSIO/io_data/test_
{code}
but no corresponding OP_OPEN

then, when the file is CLOSED again, it barfs due to two CLOSE calls in a row, Inspecting the code, it seems like this bug is present in 0.23 also. We never log an OP_OPEN for append()! It appears to be fixed in the HA branch, covered by the TestPersistBlocks test. I'll work on porting that test over and fixing this. Meanwhile, it seems like a pretty bad bug that append is unusable in branch-0.23. Will also try to see how this was introduced, I've verified this bug is present on the 0.23.1-rc2 build. In particular it seems to only be the case when the file is reopened for append on an exact block boundary. You can reproduce with:
{code}
./bin/hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-0.23.1-tests.jar TestDFSIO -Dtest.build.data=/tmp/ -Dmapreduce.jobtracker.address=local -Ddfs.block.size=$[1024*1024]  -write -nrFiles 1 -fileSize 1
./bin/hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-0.23.1-tests.jar TestDFSIO -Dtest.build.data=/tmp/ -Dmapreduce.jobtracker.address=local -Ddfs.block.size=$[1024*1024]  -append -nrFiles 1 -fileSize 1
{code}
and then restart the NN., Attached patch fixes the issue and adds two tests. The first verifies that the underlying issue is fixed (ie that OP_ADD is always logged when the file is re-opened). The second verifies that we can continue to read the "broken" logs generated by prior versions. It depends on the attached tarball which goes in src/test/resources -- this tarball was created as described above using 0.23.1-rc2 (which displays the bug).

I also set up the workaround code so that, if  future versions have an issue like this, we'll throw the exception (ie the workaround only runs for known buggy versions). I didn't bump the log version, though, since the format itself has not changed., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12515698/hdfs-2991.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 10 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests:
                  org.apache.hadoop.hdfs.server.common.TestDistributedUpgrade
                  org.apache.hadoop.hdfs.TestFileAppendRestart

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/1894//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/1894//console

This message is automatically generated., bq. org.apache.hadoop.hdfs.server.common.TestDistributedUpgrade
This seems to be failing sporadically on trunk, unrelated.

bq. org.apache.hadoop.hdfs.TestFileAppendRestart
This is the new test, which fails on the QA bot because it requires the attached tarball. It passes on my machine locally., One thing worth testing here before commit, I just thought of:
- if you append() at a block boundary, you call OP_ADD, but don't yet log the next block.
- on restart, the last block of the file (which is FINALIZED) ends up marked in the NN as under construction
- does it properly recover, eventually?

Maybe we need a hack like checking if the last block in OP_ADD is a full-length block size, then don't mark it under construction in updateBlocks(), Seems like 0.22 has the same problem.
{{startFileInternal()}} journals OP_ADD for the new file via {{dir.addFile()}}, but never does it for opening for append.
On the patch.
# Todd, you should first logOpenFile() then convertLastBlockToUnderConstruction(), because the latter can throw IOException, and we will end up with the hanging OP_ADD in edits, leading to fake recovery on startup.
# You do not need to logOpenFile() in case of file creation. It is already done in dir.addFile(). Would be very confusing to journal the same transaction twice.
# Not wild about changing LAYOUT_VERSION to overcome the bug. Should we rather come up with a repair tool? Should be easy to implement with OIV. 
Changing LAYOUT_VERSION will not be as simple as just incrementing. We will have to do a simultaneous jump for all versions, as we did in the past., (1) should read the other way around: first {{convertLastBlockToUnderConstruction()}}, then {{logOpenFile()}}
, Good catch on #1.

bq. You do not need to logOpenFile() in case of file creation. It is already done in dir.addFile(). Would be very confusing to journal the same transaction twice.
The patch actually removes logOpenFile() from {{dir.addFile}} so that the logging for both cases are done in the same function. Otherwise I found the code harder to follow. The only caller to {{dir.addFile}} was from here, so I think that's safe.

bq. Not wild about changing LAYOUT_VERSION to overcome the bug. Should we rather come up with a repair tool? Should be easy to implement with OIV.
I actually did not change the LAYOUT_VERSION for just this reason. I just made it so that the workaround code only triggers when it's an older version. Does that make sense?, > The patch actually removes logOpenFile() from dir.addFile 

See it now. Makes sense.

> did not change the LAYOUT_VERSION for just this reason

By "just this reason" I meant just this bug, not just this version.
So you allow OP_CLOSE without the preceding OP_ADD for all older versions, but not the future ones, which does not require LAYOUT_VERSION update for .22 and .23, right? Works for me., bq. So you allow OP_CLOSE without the preceding OP_ADD for all older versions, but not the future ones, which does not require LAYOUT_VERSION update for .22 and .23, right? Works for me.

Exactly. Cool.

I'll upload a new patch to address your point #1 above., Attached patch addresses Konst's point above., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12516370/hdfs-2991.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 10 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests:
                  org.apache.hadoop.hdfs.TestFileAppendRestart

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/1921//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/1921//console

This message is automatically generated., Test failure is because it's missing the corresponding tarball. The test passes locally. Does the new patch look good, Konstantin?, Looks good +1, Thanks. I committed this to 23.2, branch-23, and trunk. I wasn't able to merge it to 22 easily - please merge it in if you'd like it in that branch. thanks!, Integrated in Hadoop-Hdfs-trunk-Commit #1882 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/1882/])
    HDFS-2991. Fix case where OP_ADD would not be logged in append(). Contributed by Todd Lipcon. (Revision 1295214)

     Result = FAILURE
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1295214
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/LayoutVersion.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSEditLogLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileAppendRestart.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/resources/image-with-buggy-append.tgz
, Integrated in Hadoop-Common-0.23-Commit #618 (See [https://builds.apache.org/job/Hadoop-Common-0.23-Commit/618/])
    HDFS-2991. Fix case where OP_ADD would not be logged in append(). Contributed by Todd Lipcon. (Revision 1295213)

     Result = FAILURE
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1295213
Files : 
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/LayoutVersion.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSEditLogLoader.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileAppendRestart.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/resources/image-with-buggy-append.tgz
, Integrated in Hadoop-Common-trunk-Commit #1808 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/1808/])
    HDFS-2991. Fix case where OP_ADD would not be logged in append(). Contributed by Todd Lipcon. (Revision 1295214)

     Result = FAILURE
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1295214
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/LayoutVersion.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSEditLogLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileAppendRestart.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/resources/image-with-buggy-append.tgz
, Integrated in Hadoop-Hdfs-0.23-Commit #606 (See [https://builds.apache.org/job/Hadoop-Hdfs-0.23-Commit/606/])
    HDFS-2991. Fix case where OP_ADD would not be logged in append(). Contributed by Todd Lipcon. (Revision 1295213)

     Result = SUCCESS
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1295213
Files : 
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/LayoutVersion.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSEditLogLoader.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileAppendRestart.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/resources/image-with-buggy-append.tgz
, Integrated in Hadoop-Mapreduce-trunk-Commit #1816 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/1816/])
    HDFS-2991. Fix case where OP_ADD would not be logged in append(). Contributed by Todd Lipcon. (Revision 1295214)

     Result = ABORTED
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1295214
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/LayoutVersion.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSEditLogLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileAppendRestart.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/resources/image-with-buggy-append.tgz
, Integrated in Hadoop-Mapreduce-0.23-Commit #618 (See [https://builds.apache.org/job/Hadoop-Mapreduce-0.23-Commit/618/])
    HDFS-2991. Fix case where OP_ADD would not be logged in append(). Contributed by Todd Lipcon. (Revision 1295213)

     Result = ABORTED
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1295213
Files : 
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/LayoutVersion.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSEditLogLoader.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileAppendRestart.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
* /hadoop/common/branches/branch-0.23/hadoop-hdfs-project/hadoop-hdfs/src/test/resources/image-with-buggy-append.tgz
, Integrated in Hadoop-Hdfs-trunk #971 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/971/])
    HDFS-2991. Fix case where OP_ADD would not be logged in append(). Contributed by Todd Lipcon. (Revision 1295214)

     Result = SUCCESS
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1295214
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/LayoutVersion.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSEditLogLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileAppendRestart.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/resources/image-with-buggy-append.tgz
, Integrated in Hadoop-Mapreduce-trunk #1006 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1006/])
    HDFS-2991. Fix case where OP_ADD would not be logged in append(). Contributed by Todd Lipcon. (Revision 1295214)

     Result = SUCCESS
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1295214
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/LayoutVersion.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSEditLogLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestFileAppendRestart.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/FSImageTestUtil.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/resources/image-with-buggy-append.tgz
, Here a patch for 0.22 branch.
The test is a bit simpler than Todd's, but it fails without the patch and succeeds with., Committed to branch 0.22.1. It is highly recommended to do -savenamespace if append was used on the cluster running 0.22.1 prio to this patch., Integrated in Hadoop-Hdfs-22-branch #128 (See [https://builds.apache.org/job/Hadoop-Hdfs-22-branch/128/])
    HDFS-2991. Fix case where OP_ADD would not be logged in append(). Contributed by Todd Lipcon. (Revision 1308223)

     Result = FAILURE
shv : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1308223
Files : 
* /hadoop/common/branches/branch-0.22/hdfs/CHANGES.txt
* /hadoop/common/branches/branch-0.22/hdfs/src/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* /hadoop/common/branches/branch-0.22/hdfs/src/java/org/apache/hadoop/hdfs/server/namenode/FSEditLogLoader.java
* /hadoop/common/branches/branch-0.22/hdfs/src/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java
* /hadoop/common/branches/branch-0.22/hdfs/src/test/hdfs/org/apache/hadoop/hdfs/TestFileAppendRestart.java
, Hi Todd,

I'm running into this, and I wonder which Apache Hadoop release I should take to get the fix.  You mentioned the HA branch has it fixed.  Which one do you mean by that?  

Thanks,
Jane, Hi Jane. What release are you running? This should be in any relatively new release (2.x, 23.2, etc), Thank you, Todd!  I am using 0.23.1, and I didn't find 0.23.2 anywhere in the release announcements.  But now I see 0.23.3 just out.  So I'll check that one out!]