[One possible solution is choose DataNode randomly with the cost of ignore the network distance., I think it is not a good idea to do random since it will lose data locality, especially, when both the client and the data are in the same host.

We probably should support exclude nodes in WebHDFS., What happened on our cluster is very rare case.
Server use HDP2.1 and client use HDP1.3, so I come up this patch.

Correct me if I'm wrong: when using WebHDFS, I think it will be very rare that both client and the data will be in the same host.
But I agree with you support exclude nodes in WebHDFS is a better idea., > Correct me if I'm wrong: when using WebHDFS, I think it will be very rare that both client and the data will be in the same host.

Client and data will be collocated when WebHDFS is used in MapReduce/YARN jobs.  When will webhdfs:// be used instead of hdfs:// ?  DistCp for coping data across clusters running different Hadoop versions., Yes. You are right. 
I never thought user may use WebHDFS as source and target filesystem, and running distcp job on source cluster.
For our use case, we always run jobs on target cluster and use WebHDFS as source filesystem., @ zhaoyunjiong, are you going to post a new patch?, Update patch to support exclude nodes in WebHDFS., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12656006/HDFS-6616.1.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.balancer.TestBalancer
                  org.apache.hadoop.hdfs.server.namenode.ha.TestPipelinesFailover
                  org.apache.hadoop.hdfs.tools.TestDFSAdminWithHA

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/7364//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/7364//console

This message is automatically generated., Patch looks good.  Some comments:
- Let's set ExcludeDatanodesParam.NAME to "excludedatanodes".
- We should also change WebHdfsFileSystem to use the exclude datanode feature so that it will retry will different datanodes.
- Please take a look the test failures.  I think they should not be related but why they failed?, bq. We should also change WebHdfsFileSystem to use the exclude datanode feature so that it will retry will different datanodes.

Yeah, I have the same comment. And the excludedatanodes should only be used by the internal retry logic in webhdfsfilesystem instead of an external API., Thanks Tsz Wo Nicholas Sze & Jing Zhao.

Update patch according to comments: change ExcludeDatanodesParam.NAME to "excludedatanodes" and change WebHdfsFileSystem to use the exclude datanode feature.

The test failures is  not related., Thanks for the update.  Some comments on WebHdfsFileSystem:
- Should we catch IOException instead of SocketException?  I think the redirect datanode should be excluded for any IOException.

Minors:
- TYPO: excludns
- hostName and port can be combined to a single variable, say "redirectHost".
- There is a tailing "," in ExcludeDatanodesParam if it is not empty.  See if you want to get rid of it.

[~jingzhao], do you want to take a look?, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12656424/HDFS-6616.2.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.web.TestWebHdfsFileSystemContract
                  org.apache.hadoop.hdfs.web.TestWebHdfsTimeouts
                  org.apache.hadoop.hdfs.web.TestHttpsFileSystem
                  org.apache.hadoop.fs.TestSymlinkHdfsFileContext
                  org.apache.hadoop.hdfs.TestDistributedFileSystem
                  org.apache.hadoop.hdfs.server.namenode.TestAuditLogs
                  org.apache.hadoop.fs.TestSymlinkHdfsFileSystem
                  org.apache.hadoop.hdfs.web.TestWebHdfsWithAuthenticationFilter
                  org.apache.hadoop.hdfs.web.TestWebHDFSAcl
                  org.apache.hadoop.hdfs.TestQuota
                  org.apache.hadoop.hdfs.security.TestDelegationTokenForProxyUser
                  org.apache.hadoop.hdfs.web.TestWebHDFS
                  org.apache.hadoop.hdfs.tools.offlineImageViewer.TestOfflineImageViewerForAcl
                  org.apache.hadoop.hdfs.web.TestWebHDFSForHA
                  org.apache.hadoop.hdfs.web.TestFSMainOperationsWebHdfs
                  org.apache.hadoop.hdfs.web.TestWebHdfsContentLength
                  org.apache.hadoop.hdfs.security.TestDelegationToken
                  org.apache.hadoop.hdfs.web.TestWebHDFSXAttr
                  org.apache.hadoop.hdfs.web.TestWebHdfsTokens
                  org.apache.hadoop.hdfs.tools.offlineImageViewer.TestOfflineImageViewer
                  org.apache.hadoop.hdfs.web.TestWebHdfsWithMultipleNameNodes

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/7378//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/7378//console

This message is automatically generated., Update patch according to comments and fix test failures., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12656469/HDFS-6616.3.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.ha.TestPipelinesFailover

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/7381//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/7381//console

This message is automatically generated., +1 patch looks good., I have committed this.  Thanks Yunjiong!, Should it be included in 2.5 as well?, FAILURE: Integrated in Hadoop-trunk-Commit #5916 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/5916/])
HDFS-6616. Add exclude-datanodes feature to WebHDFS redirection so that it will not redirect retries to the same datanode. Contributed by zhaoyunjiong (szetszwo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1611750)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/web/resources/NamenodeWebHdfsMethods.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/WebHdfsFileSystem.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/resources/ExcludeDatanodesParam.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/web/resources/TestWebHdfsDataLocality.java
, FAILURE: Integrated in Hadoop-Yarn-trunk #617 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/617/])
HDFS-6616. Add exclude-datanodes feature to WebHDFS redirection so that it will not redirect retries to the same datanode. Contributed by zhaoyunjiong (szetszwo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1611750)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/web/resources/NamenodeWebHdfsMethods.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/WebHdfsFileSystem.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/resources/ExcludeDatanodesParam.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/web/resources/TestWebHdfsDataLocality.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1809 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1809/])
HDFS-6616. Add exclude-datanodes feature to WebHDFS redirection so that it will not redirect retries to the same datanode. Contributed by zhaoyunjiong (szetszwo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1611750)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/web/resources/NamenodeWebHdfsMethods.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/WebHdfsFileSystem.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/resources/ExcludeDatanodesParam.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/web/resources/TestWebHdfsDataLocality.java
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk #1836 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1836/])
HDFS-6616. Add exclude-datanodes feature to WebHDFS redirection so that it will not redirect retries to the same datanode. Contributed by zhaoyunjiong (szetszwo: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1611750)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/web/resources/NamenodeWebHdfsMethods.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/WebHdfsFileSystem.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/web/resources/ExcludeDatanodesParam.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/web/resources/TestWebHdfsDataLocality.java
]