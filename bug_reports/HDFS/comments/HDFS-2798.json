[You can reproduce this fairly reliably by adding a sleep call in BlockReceiver as follows:

{code}

        case PIPELINE_SETUP_APPEND:
          replicaInfo = datanode.data.append(block, newGs, minBytesRcvd);
          try {
            Thread.sleep(1000);
          } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
          }
          if (datanode.blockScanner != null) { // remove from block scanner
            datanode.blockScanner.deleteBlock(block.getBlockPoolId(),
                block.getLocalBlock());
          }
          block.setGenerationStamp(newGs);
          break;
{code}
TestFileAppend2 will then time out., I think this problem has been fixed by HDFS-2525. 
Also tried TestFileAppend2 with adding sleep call in BlockReceiver, it passed., It was fixed in HDFS-2525.]