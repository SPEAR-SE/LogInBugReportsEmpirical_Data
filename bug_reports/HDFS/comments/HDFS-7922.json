[{color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12704228/001-HDFS-7922.patch
  against trunk revision 6dae6d1.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.shortcircuit.TestShortCircuitCache
                  org.apache.hadoop.hdfs.server.namenode.ha.TestRetryCacheWithHA
                  org.apache.hadoop.hdfs.TestAppendSnapshotTruncate
                  org.apache.hadoop.hdfs.server.namenode.TestFileTruncate

                                      The following test timeouts occurred in hadoop-hdfs-project/hadoop-hdfs:

org.apache.hadoop.hdfs.server.blockmanagement.TestDatanodeManager

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/9855//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/9855//console

This message is automatically generated., Note that this is never a problem in production, only in unit tests.

Test failures looks related, did you get a chance to look at them?, Thanks [~cmccabe] for the interest. Yes,  {{TestShortCircuitCache#testExpiry}} failure is due to waiting for the {{cleanerExecutor#shutdown()}} completion. I've attached another patch which modifies the interval values., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12704669/002-HDFS-7922.patch
  against trunk revision bc9cb3e.

    {color:red}-1 patch{color}.  Trunk compilation may be broken.

Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/9888//console

This message is automatically generated., This patch successfully compiles in my local env. Appreciate any help in resolving this issue. Thanks!

{code}
Compiling /home/jenkins/jenkins-slave/workspace/PreCommit-HDFS-Build
/home/jenkins/tools/maven/latest/bin/mvn clean test -DskipTests -DHadoopPatchProcess -Ptest-patch > /home/jenkins/jenkins-slave/workspace/PreCommit-HDFS-Build/../patchprocess/trunkJavacWarnings.txt 2>&1
Trunk compilation is broken?
{code}, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12704669/002-HDFS-7922.patch
  against trunk revision d884670.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.datanode.TestDataNodeMetrics
                  org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestLazyPersistFiles

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/9939//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/9939//console

This message is automatically generated., It looks like test case failures are unrelated to this patch. [~cmccabe] could you please have a look at the new patch. Thanks!, We need to do {{shutdown}} and {{awaitTermination}} after releasing the lock.   There isn't any reason to hold the lock when doing these and if one of the executors is about to take the lock right before close does it, it would lead to deadlock and timeout., Yes, thats correct. I've moved the {{cleanup}} outside the lock and updated another patch. Please have a look at it when you get some time. Thanks!, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12707974/003-HDFS-7922.patch
  against trunk revision 27d49e6.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.qjournal.client.TestQuorumJournalManager

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/10100//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/10100//console

This message is automatically generated., Thanks for looking at this, [~rakeshr].  

* You do not need to check the executors against null, since they are final members which are initialized when the object is constructed.  They cannot be null.

* I would put the calls to shutdown together before the calls to {{awaitTermination}}.

* It looks like there is an existing bug where we try to join the CacheCleaner thread (which may require a lock to finish) while holding the lock ourselves.  The fix is the same... we should join the cache cleaner thread once releasing the lock.

* I don't see the need for a separate cleanup and close function.  cleanup is only ever called by close and it does the same thing., Thanks a lot [~cmccabe] for the comments. I've updated another patch addressing the comments.

bq.It looks like there is an existing bug where we try to join the CacheCleaner thread (which may require a lock to finish) while holding the lock ourselves. The fix is the same... we should join the cache cleaner thread once releasing the lock.
Thanks again for identifying this case during reviews., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12708313/004-HDFS-7922.patch
  against trunk revision cce66ba.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.TestAuditLogs

                                      The following test timeouts occurred in hadoop-hdfs-project/hadoop-hdfs:

org.apache.hadoop.hdfs.server.blockmanagement.TestDatanodeManager

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/10123//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/10123//console

This message is automatically generated., It looks like test case failure is not related to the patch., Hi [~rakeshr], I agree that the test failure looks unrelated.  I was unable to reproduce it locally.

+1.  Committed to 2.8.  Thanks again., FAILURE: Integrated in Hadoop-trunk-Commit #7489 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/7489/])
HDFS-7922. ShortCircuitCache#close is not releasing ScheduledThreadPoolExecutors (Rakesh R via Colin P. McCabe) (cmccabe: rev 3c7adaaf3571c91fee80585472d2a81402a53e2b)
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/shortcircuit/TestShortCircuitCache.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/shortcircuit/ShortCircuitCache.java
, FAILURE: Integrated in Hadoop-Yarn-trunk #885 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/885/])
HDFS-7922. ShortCircuitCache#close is not releasing ScheduledThreadPoolExecutors (Rakesh R via Colin P. McCabe) (cmccabe: rev 3c7adaaf3571c91fee80585472d2a81402a53e2b)
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/shortcircuit/TestShortCircuitCache.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/shortcircuit/ShortCircuitCache.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #151 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/151/])
HDFS-7922. ShortCircuitCache#close is not releasing ScheduledThreadPoolExecutors (Rakesh R via Colin P. McCabe) (cmccabe: rev 3c7adaaf3571c91fee80585472d2a81402a53e2b)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/shortcircuit/ShortCircuitCache.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/shortcircuit/TestShortCircuitCache.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Hdfs-trunk #2083 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2083/])
HDFS-7922. ShortCircuitCache#close is not releasing ScheduledThreadPoolExecutors (Rakesh R via Colin P. McCabe) (cmccabe: rev 3c7adaaf3571c91fee80585472d2a81402a53e2b)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/shortcircuit/TestShortCircuitCache.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/shortcircuit/ShortCircuitCache.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #142 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/142/])
HDFS-7922. ShortCircuitCache#close is not releasing ScheduledThreadPoolExecutors (Rakesh R via Colin P. McCabe) (cmccabe: rev 3c7adaaf3571c91fee80585472d2a81402a53e2b)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/shortcircuit/TestShortCircuitCache.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/shortcircuit/ShortCircuitCache.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #151 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/151/])
HDFS-7922. ShortCircuitCache#close is not releasing ScheduledThreadPoolExecutors (Rakesh R via Colin P. McCabe) (cmccabe: rev 3c7adaaf3571c91fee80585472d2a81402a53e2b)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/shortcircuit/ShortCircuitCache.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/shortcircuit/TestShortCircuitCache.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #2101 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2101/])
HDFS-7922. ShortCircuitCache#close is not releasing ScheduledThreadPoolExecutors (Rakesh R via Colin P. McCabe) (cmccabe: rev 3c7adaaf3571c91fee80585472d2a81402a53e2b)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/shortcircuit/TestShortCircuitCache.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/shortcircuit/ShortCircuitCache.java
, Thanks [~cmccabe] for reviewing and committing the changes!]