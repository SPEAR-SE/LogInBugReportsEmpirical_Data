[Words of warning:
1. I am *adding* apache.commons.lang3 to the list of dependencies for hadoop-hdfs
2. StringEscapeUtils.escapeXml10 is slowing down OIV considerably. A file which used to take 10 seconds is now taking 50 seconds. LANG-877 talks about performance improvements for StringUtils, but to me this is a correctness issue, As a first cut, is it possible to wrap the data with the {{CDATA}} tag?, Hi Haohui! I'm not familiar with CDATA, but the  wikipedia https://en.wikipedia.org/wiki/CDATA entry says
{quote} But the text within a CDATA section is strictly limited to the characters available in the encoding.
Because of this, using a CDATA section programmatically to quote data that could potentially contain '&' or '<' characters can cause problems when the data happens to contain characters that cannot be represented in the encoding
{quote}, Please do not add another dependency for this.  We already have a function to deal with mangling XML: {{org.apache.hadoop.hdfs.util.XMLUtils#mangleXmlString}}., Thanks Colin for pointing that out! This new patch used XMLUtils. Moreover it just adds 3 seconds to a 10 second fsimage->OIV conversion., Thanks, Ravi.  +1 from me.  I will commit in a day or two if there are no more comments., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12676975/HDFS-7287.patch
  against trunk revision 86ac0d4.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.balancer.TestBalancer

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8525//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8525//console

This message is automatically generated., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12677005/HDFS-7287.1.patch
  against trunk revision a52eb4b.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.tools.offlineImageViewer.TestOfflineImageViewer
                  org.apache.hadoop.hdfs.server.namenode.TestNameEditsConfigs

                                      The following test timeouts occurred in hadoop-hdfs-project/hadoop-hdfs:

org.apache.hadoop.hdfs.TestParallelRead

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8532//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8532//console

This message is automatically generated., [~raviprak], it looks like you need to update {{TestOfflineImageViewer}} to work with the new changes., Hi Colin! Thanks for writing XMLUtils.mangleXmlString . I'd like to solicit opinion from you and the community. If I mangle the string using XMLUtils.mangleXmlString, then the output of oiv might be an XML file which will fail an xmllint test. StringEscapeUtils.escapeXml10() simply drops the characters in the 3rd code point. That would produce valid XML, but obviously might cause collisions (so directory\0000X and directoryX will have the same strings in XML). Which would we rather have? Is there another way?, bq. Hi Colin! Thanks for writing XMLUtils.mangleXmlString . I'd like to solicit opinion from you and the community. If I mangle the string using XMLUtils.mangleXmlString, then the output of oiv might be an XML file which will fail an xmllint test.

Maybe I'm missing something, but I'm not sure why the output of {{mangleXmlString}} would be something that would fail {{XmlLint}}.  {{mangleXmlString}} was specifically designed to avoid causing problems like this (invalid code points, etc.).  Can you explain why you think it's invalid?, Aah! I found it. The test TestOfflineImageViewer was failing because the character '<' is being passed as is. Here's the XML output generated for the test testPBImageXmlWriter() when a directory named "/dirContainingInvalidXMLChar\u0000<-here" was in the fsimage. I'll file a follow up JIRA to fix that.
, You can see that xmllint fails on this file. (This is the string variable 'xml' in testPBImageXmlWriter() ), Here's the patch without the test barfing. , {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12677907/HDFS-7287.2.patch
  against trunk revision ec63a3f.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The following test timeouts occurred in hadoop-hdfs-project/hadoop-hdfs:

org.apache.hadoop.hdfs.TestPread

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8581//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8581//console

This message is automatically generated., The build doesn't have any test failures: https://builds.apache.org/job/PreCommit-HDFS-Build/8581/ . The console says (Note its missing the "Tests run" string
{code}Running org.apache.hadoop.hdfs.TestPread
 0, Errors: 0, Skipped: 0, Time elapsed: 4.719 sec - in org.apache.hadoop.hdfs.TestSmallBlock{code}
I'm guessing this is because of the recent changes to test-patch.sh
Besides this test seems unrelated. Could someone please review and merge?, bq. Here's the patch without the test barfing.

Great!

bq. The build doesn't have any test failures

It has a test timeout, on {{TestPread}}.  However, this is clearly not related to your patch.

bq. I'm guessing this is because of the recent changes to test-patch.sh

test-patch.sh wasn't changed recently.  smart-patch-apply.sh was, but that shouldn't have anything to do with this test timeout, I think.

bq. Besides this test seems unrelated. Could someone please review and merge?

+1, will commit shortly., FAILURE: Integrated in Hadoop-trunk-Commit #6386 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6386/])
HDFS-7287. The OfflineImageViewer (OIV) can output invalid XML depending on the filename (Ravi Prakash via Colin P. McCabe) (cmccabe: rev d33e07dc49e00db138921fb3aa52c4ef00510161)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/PBImageXmlWriter.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/XmlImageVisitor.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/TestOfflineImageViewer.java
, Thanks Colin! I've filed HDFS-7309 for clarification on the mangling. Please feel free to close as it as invalid if you think its unreasonable., SUCCESS: Integrated in Hadoop-Yarn-trunk #728 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/728/])
HDFS-7287. The OfflineImageViewer (OIV) can output invalid XML depending on the filename (Ravi Prakash via Colin P. McCabe) (cmccabe: rev d33e07dc49e00db138921fb3aa52c4ef00510161)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/PBImageXmlWriter.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/TestOfflineImageViewer.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/XmlImageVisitor.java
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1917 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1917/])
HDFS-7287. The OfflineImageViewer (OIV) can output invalid XML depending on the filename (Ravi Prakash via Colin P. McCabe) (cmccabe: rev d33e07dc49e00db138921fb3aa52c4ef00510161)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/XmlImageVisitor.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/TestOfflineImageViewer.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/PBImageXmlWriter.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1942 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1942/])
HDFS-7287. The OfflineImageViewer (OIV) can output invalid XML depending on the filename (Ravi Prakash via Colin P. McCabe) (cmccabe: rev d33e07dc49e00db138921fb3aa52c4ef00510161)
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/TestOfflineImageViewer.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/PBImageXmlWriter.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/tools/offlineImageViewer/XmlImageVisitor.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
]