[I think fixing usage is enough here., Oops. [~surendrasingh] set assignee before I reload the page. Sorry for breaking in..., If an error happens when calling hdfsListDirectory, you could also get "fileList == NULL && numEntries == 0",  means the call still fails. I think check errno is necessary., Thanks for the comment, [~jyu@cloudera.com]. I updated the patch. I added test to test_libhdfs_threaded.c which is executed on {{mvn test -Pnative}} by default now., Please feel free to re-assigne, Thanks, [~surendrasingh]. I assigned this to myself., Thanks for looking at this, [~iwasakims].  One problem I see here is that we can't easily distinguish between NULL being returned because there is an error, and NULL being returned because there was an empty directory.  In both cases, {{errno}} may be set.

Here is the code in {{hdfs.c}}:
{code}
...
    ret = 0;

done:
    destroyLocalReference(env, jPath);
    destroyLocalReference(env, jPathList);

    if (ret) {
        hdfsFreeFileInfo(pathList, jPathListSize);
        errno = ret;
        return NULL;
    }
    *numEntries = jPathListSize;
    return pathList;
{code}

Note that {{errno}} is only set when there is an error.  When there is no error, {{errno}} may have any value.  Remember that lots of C library functions set {{errno}}.  Just because some random C library function failed, doesn't mean we want to return failure.

I think the current patch is a good start, but we should also explicitly set {{errno}} = 0 on success.  We should also document in the header file that {{errno}} will be set to 0 if there is no error., Thanks [~cmccabe] for pointing this out. That's exactly what I saw during testing.
In kerberos env, you could easily get EAGAIN error for a system call, since hdfsListDirectory() doesn't clear errno on success, retry won't work, errno will still be EAGAIN., Thanks for the comments.

bq. we should also explicitly set errno = 0 on success.

Sure. I updated the patch. Now testHdfsOperations fails without the fix to hdfsListDirectory as bellow.

bq. ...test_libhdfs_threaded.c:158 (errno: 13): got expected NULL without expected errno 0 from hdfsListDirectory(fs, paths->prefix, &numEntries)
, bq.  One problem I see here is that we can't easily distinguish between NULL being returned because there is an error, and NULL being returned because there was an empty directory.

I think setting numEntries to -1 and seeing if it is set to zero when NULL is returned could be workaround for current version but it is actually awkward..
, I think move "errno = ret;" before the if check will cover both cases, right?, True but I think it is safer to set errno just before return. It is possible that some function call which (or whose downstream) set errno is added before return in future., +1 pending jenkins.  Thanks, [~iwasakims]., \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |   5m 16s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:green}+1{color} | tests included |   0m  0s | The patch appears to include 1 new or modified test files. |
| {color:green}+1{color} | javac |   7m 40s | There were no new javac warning messages. |
| {color:green}+1{color} | release audit |   0m 21s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 33s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 32s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | native |   1m  8s | Pre-build of native portion |
| {color:red}-1{color} | hdfs tests | 162m 38s | Tests failed in hadoop-hdfs. |
| | | 179m 21s | |
\\
\\
|| Reason || Tests ||
| Failed unit tests | hadoop.hdfs.server.balancer.TestBalancer |
| Timed out tests | org.apache.hadoop.hdfs.server.namenode.TestEditLog |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12734001/HDFS-8407.003.patch |
| Optional Tests | javac unit |
| git revision | trunk / 7dba700 |
| hadoop-hdfs test log | https://builds.apache.org/job/PreCommit-HDFS-Build/11131/artifact/patchprocess/testrun_hadoop-hdfs.txt |
| Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/11131/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf903.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/11131/console |


This message was automatically generated., The test failures seem not to be related to the patch. TestBalancer and TestEditLog succeeds on my local environment., committed to 2.8.  thanks, Masatake., FAILURE: Integrated in Hadoop-trunk-Commit #7919 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/7919/])
HDFS-8407. libhdfs hdfsListDirectory must set errno to 0 on success (Masatake Iwasaki via Colin P. McCabe) (cmccabe: rev d2d95bfe886a7fdf9d58fd5c47ec7c0158393afb)
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/expect.h
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test_libhdfs_threaded.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test/test_libhdfs_ops.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.h
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.c
, FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #200 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/200/])
HDFS-8407. libhdfs hdfsListDirectory must set errno to 0 on success (Masatake Iwasaki via Colin P. McCabe) (cmccabe: rev d2d95bfe886a7fdf9d58fd5c47ec7c0158393afb)
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test_libhdfs_threaded.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.h
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test/test_libhdfs_ops.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/expect.h
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, SUCCESS: Integrated in Hadoop-Yarn-trunk-Java8 #212 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/212/])
HDFS-8407. libhdfs hdfsListDirectory must set errno to 0 on success (Masatake Iwasaki via Colin P. McCabe) (cmccabe: rev d2d95bfe886a7fdf9d58fd5c47ec7c0158393afb)
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.h
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/expect.h
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test_libhdfs_threaded.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test/test_libhdfs_ops.c
, SUCCESS: Integrated in Hadoop-Yarn-trunk #942 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/942/])
HDFS-8407. libhdfs hdfsListDirectory must set errno to 0 on success (Masatake Iwasaki via Colin P. McCabe) (cmccabe: rev d2d95bfe886a7fdf9d58fd5c47ec7c0158393afb)
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test_libhdfs_threaded.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test/test_libhdfs_ops.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/expect.h
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.h
, FAILURE: Integrated in Hadoop-Hdfs-trunk #2140 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2140/])
HDFS-8407. libhdfs hdfsListDirectory must set errno to 0 on success (Masatake Iwasaki via Colin P. McCabe) (cmccabe: rev d2d95bfe886a7fdf9d58fd5c47ec7c0158393afb)
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test_libhdfs_threaded.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test/test_libhdfs_ops.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.h
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/expect.h
, SUCCESS: Integrated in Hadoop-Mapreduce-trunk-Java8 #210 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/210/])
HDFS-8407. libhdfs hdfsListDirectory must set errno to 0 on success (Masatake Iwasaki via Colin P. McCabe) (cmccabe: rev d2d95bfe886a7fdf9d58fd5c47ec7c0158393afb)
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test/test_libhdfs_ops.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/test_libhdfs_threaded.c
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/expect.h
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/hdfs.h
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
]