[It seems this have been fixed in HDFS-6763. The operation {{updateCountForQuota}} has been removed in {{FSImage#loadEdits}} now., [~linyiqun] yeah code-wise looks that way. Thanks a lot.
We are based on Hadoop 2.6/2.7 so missed that one.

A few other related jiras too: HDFS-7811, HDFS-7728, HDFS-8865, HDFS-9003 and HDFS-6763., Looking at code again, the more relevant one is HDFS-8865 which uses thread pool to improve quota initialization performance. HDFS-6763 moved the operation outside FSImage#loadEdits to FSNameSystem#startActiveServices, but it still holds NameNodeRPCServer lock, so that's not going to help. But HDFS-11192 mentioned an issue using the threadpool in HDFS-8865., On the other hand, maybe a dedicated NameNode IPC thread for ZKFC, or something similar to DataNode lifeline protocol is the ultimate solution, because I am sure there are other incidences like this that could trigger NameNode crash., I'm going to close it as HDFS-8865 can help eliminate this issue.]