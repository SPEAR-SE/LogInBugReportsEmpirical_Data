[Here is stack trace of SNN before crash.

{noformat}

2014-03-29 18:07:35,380 ERROR org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader: Encountered exception on operation AddOp [length=0, path=/user/foo/bar.txt, replication=3, mtime=1396116335071, atime=1396116335071, blockSize=536870912, blocks=[], permissions=foo:supergroup:rw-r--r--, clientName=DFSClient_attempt_1395346107078_146938_m_000041_1_1098354233_1, clientMachine=10.10.10.10, opCode=OP_ADD, txid=487688396]
java.lang.NullPointerException
     at org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader.applyEditLogOp(FSEditLogLoader.java:281)
     at org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader.loadEditRecords(FSEditLogLoader.java:171)
     at org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader.loadFSEdits(FSEditLogLoader.java:90)
     at org.apache.hadoop.hdfs.server.namenode.FSImage.loadEdits(FSImage.java:708)
     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer.doTailEdits(EditLogTailer.java:227)
     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.doWork(EditLogTailer.java:321)
     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.access$200(EditLogTailer.java:279)
     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread$1.run(EditLogTailer.java:296)
     at org.apache.hadoop.security.SecurityUtil.doAsLoginUserOrFatal(SecurityUtil.java:456)
     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.run(EditLogTailer.java:292)
2014-03-29 18:07:35,622 WARN org.apache.hadoop.hdfs.server.namenode.NameNode: Quota violation in image for //user/foo (Namespace quota : 1445052 consumed : 1304943) (Diskspace quota : 2199023255552000 consumed : 2199023483200164).
2014-03-29 18:07:36,429 FATAL org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer: Unknown error encountered while tailing edits. Shutting down standby NN.
java.io.IOException: Failed to apply edit log operation AddOp [length=0, path=/user/foo/bar.txt, replication=3, mtime=1396116335071, atime=1396116335071, blockSize=536870912, blocks=[], permissions=foo:supergroup:rw-r--r--, clientName=DFSClient_attempt_1395346107078_146938_m_000041_1_1098354233_1, clientMachine=10.10.10.10, opCode=OP_ADD, txid=487688396]: error null
     at org.apache.hadoop.hdfs.server.namenode.MetaRecoveryContext.editLogLoaderPrompt(MetaRecoveryContext.java:94)
     at org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader.loadEditRecords(FSEditLogLoader.java:174)
     at org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader.loadFSEdits(FSEditLogLoader.java:90)
     at org.apache.hadoop.hdfs.server.namenode.FSImage.loadEdits(FSImage.java:708)
     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer.doTailEdits(EditLogTailer.java:227)
     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.doWork(EditLogTailer.java:321)
     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.access$200(EditLogTailer.java:279)
     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread$1.run(EditLogTailer.java:296)
     at org.apache.hadoop.security.SecurityUtil.doAsLoginUserOrFatal(SecurityUtil.java:456)
     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.run(EditLogTailer.java:292)
2014-03-29 18:07:36,431 INFO org.apache.hadoop.util.ExitUtil: Exiting with status 1
2014-03-29 18:07:36,433 INFO org.apache.hadoop.hdfs.server.namenode.NameNode: SHUTDOWN_MSG:
{noformat}, Looking at FSEditLogLoader::applyEditLogOp

{code}
        // add to the file tree
        newFile = (INodeFile)fsDir.unprotectedAddFile(
            addCloseOp.path, addCloseOp.permissions,
            replication, addCloseOp.mtime,
            addCloseOp.atime, addCloseOp.blockSize,
            true, addCloseOp.clientName, addCloseOp.clientMachine);
        fsNamesys.leaseManager.addLease(addCloseOp.clientName, addCloseOp.path);
{code}
could return newFile as null because of QuotaExceededExcetion in uprotectedAddFile

NPE exception happens further down in same function at

{code}
     // Update the salient file attributes.
      newFile.setAccessTime(addCloseOp.atime);
      newFile.setModificationTimeForce(addCloseOp.mtime);
      updateBlocks(fsDir, addCloseOp, newFile);
{code}

Even though stack trace points to line number of 2.0.6 release, I could not find any changes in trunk source code., One corner case I suspect is QuotaCheck done FSDirectory::addChild in active vs standby namenodes. When a file is created by active namenode and synced to edits, active NN's quota check might be close to its max, by the time standby NN replays this edit log space quota could have increased because of other files in a directory and valid edit log might hit QuotaExceededException. I feel when Standby namenode replays edits, it should ignore quota check since it is already controlled by Active Namenode anyways. This should solve the race condition and prevent Standby namenode from crashing. What do other think about this approach?, Not verifying Quota when in standby could be way to solve this. Attaching potential patch for inputs from others. , It is already fixed by HDFS-6191. , Thanks [~kihwal]]