[Do you have a test log with the failure?, Yes. Like this recent one: https://builds.apache.org/job/Hadoop-Hdfs-trunk/2704/testReport/org.apache.hadoop.hdfs.server.namenode.snapshot/TestOpenFilesWithSnapshot/testParentDirWithUCFileDeleteWithSnapShot/, bq. IOException in offerService  java.io.EOFException: End of File Exception between...
This exception is fine. The DN's rpc to the NN didn't finish due to restart. According to the log, it re-registered successfully and also sent a full block report well before the mini dfs cluster was shutdown.  It looks like the namenode was up, but might have been stuck in safe mode or taking a long time to get out of it. It's not the first time snapshot has caused this kind of issue., Thanks [~kihwal] for the analysis. Yes, it does look like it got stuck in safe mode.
I'll add more logs to figure out what went wrong., I know [~yzhangal] has hit a similar issue in production. Maybe this test failure will be fixed after Yongjun finds a solution.]