[A small bump in the timeout period in the test makes it pass consistently on my local machine. We can see if the jenkins runs agree.
, Hi [~clamb],

Thanks for reporting this issue and providing patch.

See my update in https://issues.apache.org/jira/browse/HADOOP-11045, this test failure is on the top.:-)

, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12673910/HDFS-7221.001.patch
  against trunk revision 8d7c549.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

      {color:red}-1 javac{color}.  The applied patch generated 1272 javac compiler warnings (more than the trunk's current 1267 warnings).

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

        {color:red}-1 release audit{color}.  The applied patch generated 1 release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencingWithReplication

                                      The following test timeouts occurred in hadoop-hdfs-project/hadoop-hdfs:

org.apache.hadoop.hdfs.server.datanode.TestBlockHasMultipleReplicasOTests
org.apache.hadoop.hdfs.Tests
org.apache.hadoop.hdfs.server.blockmanagement.TestCorruptReplicaInfo
org.apache.hadoop.hTests
org.apache.hadoopTests
org.apache.hadoop.hdfs.server.Tests
org.apache.hadoop.hdfs.sTests
org.apache.hadooTests
org.apache.hadoop.hdfs.qjournal.client.TestIPCLoggerChanTests
org.apache.hadoop.traciTests
org.apache.hadoop.hdfs.TestFileCreationClient

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8377//testReport/
Release audit warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/8377//artifact/patchprocess/patchReleaseAuditProblems.txt
Javac warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/8377//artifact/patchprocess/diffJavacWarnings.txt
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8377//console

This message is automatically generated., Hi [~clamb], seems your patch did not resolve the issue. maybe you can bump the timeout to a very high number and try again, just to see if it still fail, and thus guide us to look into the root cause. Thanks.


, [~yzhangal],

I bumped it to 5 mins.
, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12673970/HDFS-7221.002.patch
  against trunk revision d7b647f.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

        {color:red}-1 release audit{color}.  The applied patch generated 1 release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.snapshot.TestOpenFilesWithSnapshot
                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencing

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8383//testReport/
Release audit warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/8383//artifact/patchprocess/patchReleaseAuditProblems.txt
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8383//console

This message is automatically generated., HI [~clamb],

I think I found the root cause here. With HDFS-7128 fix, the "dfs.namenode.replication.max-streams-hard-limit" property is better enforced. And this caused the testFencingStress() test failure reported here, because the test is a stress one.

I added one line of change to see the test consistently passing:
{code}
 harness.conf.setInt(
        DFSConfigKeys.DFS_NAMENODE_REPLICATION_STREAMS_HARD_LIMIT_KEY, 16);
{code}

Thanks [~mingma] for fixing HDFS-7128, and [~kihwal], [~cnauroth] for the discussion there. 

I was thinking about whether the soft and hard setting of this property is ideal, and I noticed that you guys had some discussion there. It sounds that this property can be even set per node basis based on the hardware a node is equipped with. But this may complicate the software. I guess for now we just need to kind in mind that we have this property enforced.

Thanks Charles again for reporting this long outstanding failure of recent jenkins jobs.
, Thanks Yongjun and Charles for investigating this.

I agree with the suggestion to increase the value for dfs.namenode.replication.max-streams-hard-limit. Please note that dfs.namenode.replication.max-streams normally is set to less than or equal to dfs.namenode.replication.max-streams-hard-limit as it doesn't matter otherwise. So as part of this fix, you can change the value for dfs.namenode.replication.max-streams to be 16.

IMHO, per node configuration is useful if you have heterogeneous nodes in the cluster and the scope is much more than these two properties, for example you have other configurations such as maxXceiverCount, balancer bandwidth, etc.. Heterogeneous storages might have addressed some of the issues. Besides, it should be easy to manage; maybe some sort of labels support in HDFS., HI [~mingma], thanks a lot for your input, it's very helpful!

, [~yzhangal], [~mingma],

Attached is a patch with your suggested fix.

, Charles, thanks for the patch.

Maybe this config can be moved to HAStressTestHarness so that it can help other test cases? In addition, we can set dfs.namenode.replication.max-streams to 16, as larger value than dfs.namenode.replication.max-streams-hard-limit won't help., [~mingma],

Thanks for the review. That seems like a good idea. The .004 patch moves the setting to HAStressTestHarness.

We can see if the jenkins run blows anything up.
, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12675869/HDFS-7221.003.patch
  against trunk revision d5084b9.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencing
                  org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestInterDatanodeProtocol

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8453//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8453//console

This message is automatically generated., TestDNFencing is known to fail lately. TestInterDatanodeProtocol runs ok on my local machine with the patch applied.
, Thanks, Charles. It shouldn't change the test result either way, but it is better if dfs.namenode.replication.max-streams is set to 16 as well. Otherwise, others might wonder dfs.namenode.replication.max-streams is set to much larger value., [~mingma],

Yes, aesthetically that is better. I've changed that in the .005 version.

Thanks for the review.
, Thanks, Charles. The latest patch LGTM., Thanks Charles and Ming, the latest patch  LGTM too.
, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12675887/HDFS-7221.004.patch
  against trunk revision d5084b9.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.ha.TestRetryCacheWithHA
                  org.apache.hadoop.hdfs.TestDecommission
                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencing

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8454//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8454//console

This message is automatically generated., I verified that the three test failures are unrelated. TestDNFencing (with and without replication) are known failures right now. TestDecommission passes on my local machine with the patch applied., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12675918/HDFS-7221.005.patch
  against trunk revision 8942741.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.namenode.ha.TestDNFencing

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8457//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8457//console

This message is automatically generated., LGTM I'll commit shortly, Committed, thanks Charles for the patch, Yongjun and Ming for helping to review., FAILURE: Integrated in Hadoop-trunk-Commit #6304 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6304/])
HDFS-7221. TestDNFencingWithReplication fails consistently. Contributed by Charles Lamb. (wang: rev ac56b0637e55465d3b7f7719c8689bff2a572dc0)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/ha/HAStressTestHarness.java
, Thanks [~andrew.wang], SUCCESS: Integrated in Hadoop-Yarn-trunk #720 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/720/])
HDFS-7221. TestDNFencingWithReplication fails consistently. Contributed by Charles Lamb. (wang: rev ac56b0637e55465d3b7f7719c8689bff2a572dc0)
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/ha/HAStressTestHarness.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1909 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1909/])
HDFS-7221. TestDNFencingWithReplication fails consistently. Contributed by Charles Lamb. (wang: rev ac56b0637e55465d3b7f7719c8689bff2a572dc0)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/ha/HAStressTestHarness.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1934 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1934/])
HDFS-7221. TestDNFencingWithReplication fails consistently. Contributed by Charles Lamb. (wang: rev ac56b0637e55465d3b7f7719c8689bff2a572dc0)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/ha/HAStressTestHarness.java
, SUCCESS: Integrated in Hadoop-trunk-Commit #6476 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6476/])
HDFS-7221. Update CHANGES.txt to indicate fix in 2.6.0. (cnauroth: rev e7f1c0482e5dff8a1549ace1fc2b366941170c58)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, When I code reviewed HDFS-7128, Jenkins did report a failure on {{TestDNFencingWithReplication}}.  At the time, I misdiagnosed it as unrelated to the patch and went ahead with the commit.  Sorry for the confusion.

Charles, thank you for fixing it.  I merged it down to branch-2.6, since the test was still failing there., FAILURE: Integrated in Hadoop-Yarn-trunk #736 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/736/])
HDFS-7221. Update CHANGES.txt to indicate fix in 2.6.0. (cnauroth: rev e7f1c0482e5dff8a1549ace1fc2b366941170c58)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, SUCCESS: Integrated in Hadoop-Hdfs-trunk #1926 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1926/])
HDFS-7221. Update CHANGES.txt to indicate fix in 2.6.0. (cnauroth: rev e7f1c0482e5dff8a1549ace1fc2b366941170c58)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1950 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1950/])
HDFS-7221. Update CHANGES.txt to indicate fix in 2.6.0. (cnauroth: rev e7f1c0482e5dff8a1549ace1fc2b366941170c58)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
]