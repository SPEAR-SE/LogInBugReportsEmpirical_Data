[Here is the initial patch from Xiaobo. New unit tests and patch for hadoop 2.0 will come later., HDFS-3655-0.22.patch keeps the code that waits for termination of the old writer in stopWriter method of class ReplicaInPipeline. We pay the price to pass FSDataset to it in order to release the monitor during waiting.

HDFS-3655-0.22-use-join-instead-of-wait.patch moves join/wait code from ReplicaInPipeline to FSDataset. It looks cleaner. But we have to refactor some FSDataset code to not duplicate them., Please only set the "fix version" once the JIRA has been fixed/committed. Until then, please use the "target version" field to indicate where you intend to fix this.

Also, please note that in order for the automated pre-commited tests to run, you'll need to upload a patch that applies to trunk, and mark this JIRA "patch available." If indeed this bug exists in trunk/branch-2 as well as branch-0.22, we'll need to fix it in trunk/branch-2 before we can commit it to branch-0.22., Seems like its fixed in HDFS-5016, Closing this issue as duplicate. Please feel free to reopen if you disagree.]