[upload the error log ., Hello [~yzhangal].  Do you think this looks like a duplicate of the recent edit log bugs related to delayed block removal (HDFS-6825, HDFS-7414 and HDFS-7707)?  Thanks!, Thanks [~fujie] for reporting the issue and [~cnauroth] for bringing it to my attention.

I agree with Chris that it's likely related to HDFS-6825 etc. But to be sure, suggest to find out whether the file this OP_CLOSE tries to close was indeed deleted earlier. What I did before was to look into the edit logs to see if the file itself or its parent are deleted.




, HDFS-6825 affects version is 2.5.0, but our hadoop version is 2.3.0. So are you sure it is the same issue?

1. I am sure that the file was deleted. And I have some new findings.

Such as we have "image-file-1", "editlog-file-1" and "editlog-file-inprogress" when start the standby namenode A.
I found the below behavior of these files:
step-1) SNN will load "image-file-1" and "editlog-file-1" and generate new image file, take it as "image-file-2".
step-2) SNN will cp "image-file-2" to ative namenode.
step-3) "editlog-file-inprogress" will be renamed to "editlog-file-2" and a new "editlog-file-inprogress" will be opened.
step-4) SNN will load "editlog-file-2", at the same time datanode will report heartbeat to both active and standby. 

The crash happends at step-4. We print all the failed files and all of them are in "editlog-file-2".
We alse have a statistics, 20,000 operations failed in 500,000 operations. Then we parsed "editlog-file-2", and got the familar contents
of failed records. All of them, RPC_CLIENTID is null(blank) , and RPC_CALLID is -2.
<RECORD>
    <OPCODE>OP_ADD_BLOCK</OPCODE>
    <DATA>
      <TXID>7660428426</TXID>
      <PATH>/workspace/dm/recommend/VideoQuality/VRII/AppList/data/interactivedata_month/_temporary/1/_temporary/attempt_1427018831005_178665_r_000002_0/part
-r-00002</PATH>
      <BLOCK>
        <BLOCK_ID>2107099231</BLOCK_ID>
        <NUM_BYTES>0</NUM_BYTES>
        <GENSTAMP>1100893452304</GENSTAMP>
      </BLOCK>
      <RPC_CLIENTID></RPC_CLIENTID>
      <RPC_CALLID>-2</RPC_CALLID>
    </DATA>
  </RECORD>

2. If we restart SNN A again, "editlog-file-2" could be loaded correctly just like "editlog-file-1" in last restart operation. It's weird.
Does the reported heartbeat impact its behavior? But the "load" process and "report" process should asynchronous, isn't it?

We are looking forward to you reply., HDFS-6825 affects version is 2.5.0, but our hadoop version is 2.3.0. So are you sure it is the same issue?

1. I am sure that the file was deleted. And I have some new findings.

Such as we have "image-file-1", "editlog-file-1" and "editlog-file-inprogress" when start the standby namenode A.
I found the below behavior of these files:
step-1) SNN will load "image-file-1" and "editlog-file-1" and generate new image file, take it as "image-file-2".
step-2) SNN will cp "image-file-2" to ative namenode.
step-3) "editlog-file-inprogress" will be renamed to "editlog-file-2" and a new "editlog-file-inprogress" will be opened.
step-4) SNN will load "editlog-file-2", at the same time datanode will report heartbeat to both active and standby. 

The crash happends at step-4. We print all the failed files and all of them are in "editlog-file-2".
We alse have a statistics, 20,000 operations failed in 500,000 operations. Then we parsed "editlog-file-2", and got the familar contents
of failed records. All of them, RPC_CLIENTID is null(blank) , and RPC_CALLID is -2.
<RECORD>
    <OPCODE>OP_ADD_BLOCK</OPCODE>
    <DATA>
      <TXID>7660428426</TXID>
      <PATH>/workspace/dm/recommend/VideoQuality/VRII/AppList/data/interactivedata_month/_temporary/1/_temporary/attempt_1427018831005_178665_r_000002_0/part
-r-00002</PATH>
      <BLOCK>
        <BLOCK_ID>2107099231</BLOCK_ID>
        <NUM_BYTES>0</NUM_BYTES>
        <GENSTAMP>1100893452304</GENSTAMP>
      </BLOCK>
      <RPC_CLIENTID></RPC_CLIENTID>
      <RPC_CALLID>-2</RPC_CALLID>
    </DATA>
  </RECORD>

2. If we restart SNN A again, "editlog-file-2" could be loaded correctly just like "editlog-file-1" in last restart operation. It's weird.
Does the reported heartbeat impact its behavior? But the "load" process and "report" process should asynchronous, isn't it?

We are looking forward to you reply., Hi [~fujie] Can you attach little more log around above mentioned exceptions.?, Hi [~fujie],

"I am sure that the file was deleted", if a file was deleted, and it still has an OP_CLOSE in the edit log file, then why "If we restart SNN A again, "editlog-file-2" could be loaded correctly just like "editlog-file-1" in last restart operation." is indeed mysterious, unless OP_CLOSE silently ignores deleted file.

Can we dump the edit log with oev tool, and see if the involved file in OP_CLOSE operation that throws NPE was deleted (either it OR its parent has an OP_DELETE) before the OP_CLOSE? 

What it means by "20,000 operations failed in 500,000 operations"?  what are the error symptom? As Vinayakumar requested, can we analysze the trace stack of all failures to see if they have the same exception stack? 

Since you mentioned one problem OP_ADD_BLOCK, it seems that we are adding block to a deleted file? If it's deleted file, I think it's very likely related to delayed block removal, which relates to "at the same time datanode will report heartbeat to both active and standby".

Thanks.



, It is very likely fixed in the later releases when we fixed similar issues.]