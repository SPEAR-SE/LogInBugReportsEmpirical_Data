[Junping, can you add an example of the log and indicate what is wrong with the number printed?, Sure. I will add fix patch and unit test with example soon., Hi Suresh, Please check the patch with an example there in unit test. In this example, we have 6 data nodes but 2 nodes is not available due to low space. Then, placing 6 replicas should cause a warn with reporting short of 2 replicas. In previous (without this patch), it will report a short of 3 replicas which is wrong. I think we will meet this warn error very common in small scale (<10) cluster, as map-reduce job file will be placed with a lot of replicas. Isn't it?, Hi Junping, so after you make data node 0&1 not qualified for choosing, I think you may also need to reset these two nodes back to healthy state at the end of the new testcase, otherwise the two unqualified nodes will affect the following testcases. 

Another thing is, when calculating the number of replicas still in need for the log output, do we also need to consider the original size of the results? For example, when calling the chooseTarget, if there are already 3 nodes chosen (i.e., we want to increase the number of replicas from 3 to N), after selecting another S nodes, totalReplicasExpected should be N-3, and the size of the results is 3+S, and we should expect (N-3)-(3+S)+3=N-3-S more nodes., Hi Jing, Thanks for the comments. For calculating number of replicas, I think you are right that totalReplicasExpected now is N-3, but should be N as log message blow. Thus, we could update totalReplicasExpected 
From 
totalReplicasExpected = numOfReplicas;
To
totalReplicasExpected = numOfReplicas + result.size();
What do you think?, Yeah I think that will be good. (And in that case the meaning of totalReplicasExpected will be "the total number of replicas expected by the system", not "the total number of extra replicas expected for the chooseTarget method"., Agree. Update new patch and make it patch available. , {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12551254/HDFS-4127.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/3420//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3420//console

This message is automatically generated., The new patch looks good. +1 for the patch., +1 for the patch from me as well. Thanks for taking time to write the unit test., I committed the patch to trunk and branch-2. Thank you Junping., Also thank you Jing for the code review., Integrated in Hadoop-trunk-Commit #2941 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/2941/])
    HDFS-4127. Log message is not correct in case of short of replica. Contributed by Junping Du. (Revision 1403616)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1403616
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockPlacementPolicyDefault.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java
, Integrated in Hadoop-Yarn-trunk #21 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/21/])
    HDFS-4127. Log message is not correct in case of short of replica. Contributed by Junping Du. (Revision 1403616)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1403616
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockPlacementPolicyDefault.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java
, Integrated in Hadoop-Hdfs-trunk #1211 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1211/])
    HDFS-4127. Log message is not correct in case of short of replica. Contributed by Junping Du. (Revision 1403616)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1403616
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockPlacementPolicyDefault.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java
, Integrated in Hadoop-Mapreduce-trunk #1241 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1241/])
    HDFS-4127. Log message is not correct in case of short of replica. Contributed by Junping Du. (Revision 1403616)

     Result = FAILURE
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1403616
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockPlacementPolicyDefault.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java
]