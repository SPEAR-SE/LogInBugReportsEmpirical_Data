[Attaching the patch.

The test consistently fails on Windows because it incorrectly picks the excess datanode on the place where it is explicitly looking for a non-excess node. This happens because {{blocks.contains()}} tries to match the ExtendedBlock object in the collection of Block objects what always fails.

From the test log:
{quote}
2013-03-11 01:26:48,890 INFO  BlockStateChange (BlockManager.java:chooseExcessReplicates(2439)) - BLOCK* chooseExcessReplicates: (127.0.0.1:61959, blk_6432712012621304004_1002) is added to invalidated blocks set
...
...
...
2013-03-11 01:26:48,989 INFO  hdfs.MiniDFSCluster (MiniDFSCluster.java:stopDataNode(1607)) - DN name= 127.0.0.1:61959  found DN=DataNode{data=FSDataset 
{quote}
, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12573051/HDFS-4583.trunk.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 tests included appear to have a timeout.{color}

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.datanode.TestDataDirs
                  org.apache.hadoop.hdfs.server.blockmanagement.TestBlocksWithNotEnoughRacks

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/4072//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/4072//console

This message is automatically generated., I was able to repro TestDataDirs failure, seems orthogonal to this patch, will take a look at what is going on.

No repro for TestBlocksWithNotEnoughRacks., HDFS-4586 tracks the failure in TestDataDirs., +1 for the patch.

I verified the fix on Mac and Windows.

The fix makes sense, but I didn't follow why the test consistently passes on Linux even without this patch.  Is it because we get a different iteration order from {{bm.blocksMap.nodeIterator}} on Linux, and it just happens to get a non-excess node by coincidence?
, Thanks for the review!

bq. The fix makes sense, but I didn't follow why the test consistently passes on Linux even without this patch. Is it because we get a different iteration order from bm.blocksMap.nodeIterator on Linux, and it just happens to get a non-excess node by coincidence?
Good question. I haven't debugged this explicitly side-by-side, but I suspect this is what is happening. The iterator goes over datanodes which have the block, so there is likely some timing involved. The test did pass for me once on Windows while I was debugging., Interesting issue indeed. Patch seems straightforward. +1., Integrated in Hadoop-trunk-Commit #3464 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3464/])
    HDFS-4583. TestNodeCount fails. Contributed by Ivan Mitic. (Revision 1456052)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1456052
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestNodeCount.java
, I committed the patch to trunk and branch-2. Thank you Ivan., Integrated in Hadoop-Yarn-trunk #155 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/155/])
    HDFS-4583. TestNodeCount fails. Contributed by Ivan Mitic. (Revision 1456052)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1456052
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestNodeCount.java
, Integrated in Hadoop-Hdfs-trunk #1344 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1344/])
    HDFS-4583. TestNodeCount fails. Contributed by Ivan Mitic. (Revision 1456052)

     Result = FAILURE
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1456052
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestNodeCount.java
, Integrated in Hadoop-Mapreduce-trunk #1372 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1372/])
    HDFS-4583. TestNodeCount fails. Contributed by Ivan Mitic. (Revision 1456052)

     Result = SUCCESS
suresh : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1456052
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestNodeCount.java
]