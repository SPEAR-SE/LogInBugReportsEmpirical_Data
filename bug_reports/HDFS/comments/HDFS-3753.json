[This patch adds the hadoop-common native library directory to LD_LIBRARY_PATH, so that the junit tests of other projects, such as hadoop-hdfs-project, will be run with libhadoop.so if -Pnative was specified.  This ensures that we get test coverage of HDFS running with libhadoop.so present.

This patch also adds two new junit tests, TestNativeCodeLoader and TestHdfsNativeCodeLoader.  If the system property {{\-Drequire.test.libhadoop}} is set, these tests will ensure that libhadoop.so is actually being tested.  This is important for repeatable builds, and to prevent this bug from cropping up again--  for example if libhadoop.so is moved.

Finally, this adds {{\-Drequire.test.libhadoop}} to test-patch.sh.  This ensures that any regressions that lead to libhadoop.so not being tested are spotted by Jenkins., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12546607/HDFS-3753.001.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 3 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.TestShortCircuitLocalRead

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/3237//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3237//console

This message is automatically generated., TestShortCircuitLocalRead is currently broken in the presence of libhadoop.so.  This patch fixes TestShortCircuitLocalRead for this case., resubmitting patch 002 so that jenkins runs it, {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12547248/HDFS-3753.002.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 4 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/3249//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3249//console

This message is automatically generated., +1 looks great 

Nit: LD_LIBRARY_PATH shouldn't be indented more, I'll fix that when I commit, Integrated in Hadoop-Common-trunk-Commit #2802 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/2802/])
    HDFS-3753. Tests don't run with native libraries. Contributed by Colin Patrick McCabe (Revision 1393113)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1393113
Files : 
* /hadoop/common/trunk/dev-support/test-patch.sh
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/util/TestNativeCodeLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHdfsNativeCodeLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestShortCircuitLocalRead.java
* /hadoop/common/trunk/hadoop-project/pom.xml
, Integrated in Hadoop-Hdfs-trunk-Commit #2864 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/2864/])
    HDFS-3753. Tests don't run with native libraries. Contributed by Colin Patrick McCabe (Revision 1393113)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1393113
Files : 
* /hadoop/common/trunk/dev-support/test-patch.sh
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/util/TestNativeCodeLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHdfsNativeCodeLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestShortCircuitLocalRead.java
* /hadoop/common/trunk/hadoop-project/pom.xml
, Mark this as resolved? Or is it awaiting commit to more branches?, Integrated in Hadoop-Mapreduce-trunk-Commit #2825 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/2825/])
    HDFS-3753. Tests don't run with native libraries. Contributed by Colin Patrick McCabe (Revision 1393113)

     Result = FAILURE
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1393113
Files : 
* /hadoop/common/trunk/dev-support/test-patch.sh
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/util/TestNativeCodeLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHdfsNativeCodeLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestShortCircuitLocalRead.java
* /hadoop/common/trunk/hadoop-project/pom.xml
, I've committed this and merged to branch-2. Thanks Colin!, TestParallelLocalRead may be related to this. Filed HDFS-4000., Looks like TestNativeCodeLoader is failing in some other runs, eg HDFS-3995., Integrated in Hadoop-Hdfs-trunk #1184 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1184/])
    HDFS-3753. Tests don't run with native libraries. Contributed by Colin Patrick McCabe (Revision 1393113)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1393113
Files : 
* /hadoop/common/trunk/dev-support/test-patch.sh
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/util/TestNativeCodeLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHdfsNativeCodeLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestShortCircuitLocalRead.java
* /hadoop/common/trunk/hadoop-project/pom.xml
, Integrated in Hadoop-Mapreduce-trunk #1215 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1215/])
    HDFS-3753. Tests don't run with native libraries. Contributed by Colin Patrick McCabe (Revision 1393113)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1393113
Files : 
* /hadoop/common/trunk/dev-support/test-patch.sh
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/test/java/org/apache/hadoop/util/TestNativeCodeLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHdfsNativeCodeLoader.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestShortCircuitLocalRead.java
* /hadoop/common/trunk/hadoop-project/pom.xml
, Looks like TestNativeCodeLoader is failing because it can't find libhadoop, because the common native build was not run. I've updated the HDFS pre commit job to build the common native bits first.

The reason we didn't catch this here is that the Pre Commit job doesn't pick up on the test-patch.sh changes from the uploaded patch, I filed HADOOP-8875 for that., I kicked the Pre Commit job to re-run HDFS-4000 to make sure this works., Thanks, Eli.  These kind of environment setup issues are exactly what the test was meant to catch, and it looks like they have., The test in HDFS-4000 failed again, the issue here is that test-patch does a clean several times so unless the patch modifies common the native library is not present. I'll ammend this patch to add an @Ignore TestHdfsNativeCodeLoader and we'll do a follow on change to remove the @Ignore and modify test-patch to run the common native build before running the Hdfs tests., Filed HDFS-4003., Integrated in Hadoop-Hdfs-trunk-Commit #2870 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/2870/])
    Amend HDFS-3753 to ignore TestHdfsNativeCodeLoader. To be fixed in HDFS-4003. (Revision 1393830)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1393830
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHdfsNativeCodeLoader.java
, Integrated in Hadoop-Common-trunk-Commit #2808 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/2808/])
    Amend HDFS-3753 to ignore TestHdfsNativeCodeLoader. To be fixed in HDFS-4003. (Revision 1393830)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1393830
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHdfsNativeCodeLoader.java
, Integrated in Hadoop-Mapreduce-trunk-Commit #2831 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/2831/])
    Amend HDFS-3753 to ignore TestHdfsNativeCodeLoader. To be fixed in HDFS-4003. (Revision 1393830)

     Result = FAILURE
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1393830
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHdfsNativeCodeLoader.java
, Integrated in Hadoop-Hdfs-trunk #1185 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1185/])
    Amend HDFS-3753 to ignore TestHdfsNativeCodeLoader. To be fixed in HDFS-4003. (Revision 1393830)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1393830
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHdfsNativeCodeLoader.java
, Integrated in Hadoop-Mapreduce-trunk #1216 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1216/])
    Amend HDFS-3753 to ignore TestHdfsNativeCodeLoader. To be fixed in HDFS-4003. (Revision 1393830)

     Result = SUCCESS
eli : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1393830
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/fs/TestHdfsNativeCodeLoader.java
]