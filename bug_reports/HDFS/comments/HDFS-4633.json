[Here are some additional details.  There is a bad interaction between the 1-second cache expiration used by {{TestDFSClientExcludedNodes#testExcludedNodesForgiveness}} and the exclusion/retry logic within {{DFSOutputStream#DataStreamer#nextBlockOutputStream}}.  Here is the sequence of events I observed during a failed test run.  Assume 3 data nodes named dn1, dn2, and dn3.

# DFSOutputStream writes first block to [dn1, dn2, dn3].
# Test stops data nodes [dn1, dn2].
# DFSOutputStream attempts writing second block to [dn1, dn2, dn3].  It fails to dn1 and marks it excluded.
# DFSOutputStream retries and attempts writing second block to [dn2, dn3].  It fails to dn2 and marks it excluded.
# DFSOutputStream retries, but by now, > 1 second has elapsed since dn1 failed.  dn1 gets evicted from the cache and it attempts writing second block to [dn1, dn3].  This fails again, so it marks dn1 excluded again.
# DFSOutputStream retries, but by now, > 1 second has elapsed since dn2 failed.  dn2 gets evicted from the cache and it attempts writing second block to [dn2, dn3].  This fails again, so it marks dn2 excluded again.
# At this point, {{DFSOutputStream#DataStreamer#nextBlockOutputStream}} has exceeded max block write retries (3).  It aborts and throws {{IOException}} with "Unable to create new block.".
, With this patch, the test passes consistently on every machine I've tried.  The changes are:

# Guarantee that each test properly shuts down its {{MiniDFSCluster}}.
# Increase timeouts in test annotations from 10s to 60s.  These timeouts were too tight and even caused sporadic failures on my fastest machine.
# Increase excluded nodes cache expiry from 1s to 10s.  I expect this is plenty of time for any machine to make it through the loop in {{DFSOutputStream#DataStreamer#nextBlockOutputStream}}.
, BTW, big thanks to [~arpitagarwal] for spotting the problem of failing to shut down MiniDFSCluster., Good find in testExcludedNodesForgiveness. I verified the fix works on Windows and OS X.

I wonder if we can reduce the test execution time a little by reducing these delays?

{code}
    // Forgive nodes in under 10s for this test case.
    conf.setLong(
        DFSConfigKeys.DFS_CLIENT_WRITE_EXCLUDE_NODES_CACHE_EXPIRY_INTERVAL,
        10000);

    ThreadUtil.sleepAtLeastIgnoreInterrupts(15000);
{code}

The test passes reliably on my Windows machine with the former set to 2500ms and the latter to 5000ms. I'm fine if you prefer leaving the higher values to rule out spurious failures though.
, Thanks, Arpit.  Here is an updated patch that uses the timing values you recommended.  I retested this on multiple machines, and it passed consistently, so I think these settings will work fine., Patch looks good, thank you for reducing the timeouts.

+1, In the patch the 2 comments does not match the code
> +    // Forgive nodes in under 10s for this test case.
Here you changed the comment but forgot to change it again as you lowered the time based on Arpit's feedback.

>// [Sleeping just in case the restart of the DNs completed < 2s cause
2s is the older time, you have changed it to 5sec , Sanjay, thanks for the catch.  Here is a new patch that fixes the comments., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12575419/HDFS-4633.3.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/4143//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/4143//console

This message is automatically generated., +1 
Thanks Chris. Committed., Integrated in Hadoop-trunk-Commit #3537 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/3537/])
    HDFS-4633 TestDFSClientExcludedNodes fails sporadically if excluded nodes cache expires too quickly  (Chris Nauroth via Sanjay) (Revision 1461846)

     Result = SUCCESS
sradia : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1461846
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSClientExcludedNodes.java
, Integrated in Hadoop-Yarn-trunk #169 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/169/])
    HDFS-4633 TestDFSClientExcludedNodes fails sporadically if excluded nodes cache expires too quickly  (Chris Nauroth via Sanjay) (Revision 1461846)

     Result = FAILURE
sradia : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1461846
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSClientExcludedNodes.java
, Integrated in Hadoop-Hdfs-trunk #1358 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1358/])
    HDFS-4633 TestDFSClientExcludedNodes fails sporadically if excluded nodes cache expires too quickly  (Chris Nauroth via Sanjay) (Revision 1461846)

     Result = FAILURE
sradia : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1461846
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSClientExcludedNodes.java
, Integrated in Hadoop-Mapreduce-trunk #1386 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1386/])
    HDFS-4633 TestDFSClientExcludedNodes fails sporadically if excluded nodes cache expires too quickly  (Chris Nauroth via Sanjay) (Revision 1461846)

     Result = SUCCESS
sradia : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1461846
Files : 
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDFSClientExcludedNodes.java
, I'm going to merge this down to branch-2 and branch-2.2., I've merged this patch to branch-2 and branch-2.2.  I've also updated attribution in CHANGES.txt so that it's listed under release 2.2.1., SUCCESS: Integrated in Hadoop-trunk-Commit #4679 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/4679/])
HDFS-4633. Change attribution in CHANGES.txt to version 2.2.1. (cnauroth: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1537345)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, SUCCESS: Integrated in Hadoop-Yarn-trunk #379 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/379/])
HDFS-4633. Change attribution in CHANGES.txt to version 2.2.1. (cnauroth: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1537345)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Hdfs-trunk #1569 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1569/])
HDFS-4633. Change attribution in CHANGES.txt to version 2.2.1. (cnauroth: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1537345)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1595 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1595/])
HDFS-4633. Change attribution in CHANGES.txt to version 2.2.1. (cnauroth: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1537345)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
]