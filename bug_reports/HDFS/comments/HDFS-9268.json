[The segfault is triggered by strcmp(), so likely a NULL pointer or a corrupted pointer was passed in. 
This only happens using vim to edit the file. Other text editors including pico does not trigger segfault. Looking at the debugging message of the fuse process, the last few lines are:

unique: 59, opcode: LOOKUP (1), nodeid: 1, insize: 43
LOOKUP /y~
getattr /y~
   unique: 59, error: -2 (No such file or directory), outsize: 16
unique: 60, opcode: LOOKUP (1), nodeid: 1, insize: 43
LOOKUP /y~
getattr /y~
   unique: 60, error: -2 (No such file or directory), outsize: 16
unique: 61, opcode: LOOKUP (1), nodeid: 1, insize: 43
LOOKUP /y~
getattr /y~
   unique: 61, error: -2 (No such file or directory), outsize: 16
unique: 62, opcode: CREATE (35), nodeid: 1, insize: 59
create flags: 0x280c1 /y~ 0100600 umask=0022
   create[140079219900624] flags: 0x281c1 /y~
getattr /y~
   NODEID: 7
   unique: 62, success, outsize: 160
unique: 63, opcode: GETATTR (3), nodeid: 1, insize: 56
getattr /
   unique: 63, success, outsize: 120
unique: 64, opcode: SETATTR (4), nodeid: 7, insize: 128
getattr /y~
   unique: 64, success, outsize: 120
unique: 65, opcode: SETATTR (4), nodeid: 7, insize: 128
chown /y~ 4294967295 99

So when vi saves the file, it create a temporary file y~ and attempt to chown() it. There is a red-black tree structure in fuse where a bad pointer is found traversing the tree., Reproducible as long as the file permission is not the default (e.g. 600, 642, 640)
Bug found: vim creates a temporary file and then attempts to change its owner chown(-1,99)
The hdfs-fuse implementation does not handle this case. The Linux manual for chown states: "If the owner or group is specified as -1, then that ID is not changed."

Rev1 fix is uploaded. I need to make a test case as well., Hi [~jojochuang], good job debugging this.  However, I think you may have misinterpreted the man page.  Your change makes it so that nothing is changed if either uid or gid is -1.  But in fact, only the ID which is -1 should be left unchanged., I posted a patch which fixes the root of the problem, I think.  We should be using {{fuseConnectAsThreadUid}} instead of {{fuseConnect}}., \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |   5m 42s | Pre-patch trunk compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:red}-1{color} | tests included |   0m  0s | The patch doesn't appear to include any new or modified tests.  Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. |
| {color:green}+1{color} | javac |   8m 54s | There were no new javac warning messages. |
| {color:green}+1{color} | release audit |   0m 27s | The applied patch does not increase the total number of release audit warnings. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 49s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 35s | The patch built with eclipse:eclipse. |
| {color:green}+1{color} | native |   1m 13s | Pre-build of native portion |
| {color:green}+1{color} | hdfs tests |   0m 51s | Tests passed in hadoop-hdfs-native-client. |
| | |  19m 35s | |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12767653/HDFS-9268.002.patch |
| Optional Tests | javac unit |
| git revision | trunk / 01b103f |
| hadoop-hdfs-native-client test log | https://builds.apache.org/job/PreCommit-HDFS-Build/13090/artifact/patchprocess/testrun_hadoop-hdfs-native-client.txt |
| Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/13090/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf905.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/13090/console |


This message was automatically generated., Hi [~cmccabe], I was going to create a test case for this, but then noticed "mvn test" does not run any unit tests of fuse_dfs. Is that right? I understand unit-testing this may be hard, but the code base does appear to have test code ( I did not run it though), By the way, I tested your patch and it does work under the scenario. Thanks

On Tuesday, October 20, 2015, Colin Patrick McCabe (JIRA) <jira@apache.org>



-- 
Newbie Clouderan
, The patch LGTM. One minor suggestion is maybe we can fold {{fuseConnect}} into {{fuseConnectAsThreadUid}} to avoid bugs of this kind in the future? Seems we should always call {{fuseConnect}} with the thread UID anyway., I don't think {{fuseConnect}} is used anywhere but in fuse_connect.c at this point, so it could be made private to that file., Thanks [~cmccabe] for the clarification. Please see if you want to update the patch and make {{fuseConnect}} private. Otherwise +1 on the latest patch., Thanks, [~zhz].  I'll open a follow-on JIRA for making {{fuseConnect}} private to {{fuse_connect.c}}.  Committing to 2.8, FAILURE: Integrated in Hadoop-trunk-Commit #8710 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/8710/])
HDFS-9268. fuse_dfs chown crashes when uid is passed as -1 (cmccabe) (cmccabe: rev 2f1eb2bceb1df5f27649a514246b38b9ccf60cba)
* hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/fuse-dfs/fuse_impls_chown.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Yarn-trunk #1323 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/1323/])
HDFS-9268. fuse_dfs chown crashes when uid is passed as -1 (cmccabe) (cmccabe: rev 2f1eb2bceb1df5f27649a514246b38b9ccf60cba)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/fuse-dfs/fuse_impls_chown.c
, FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #599 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/599/])
HDFS-9268. fuse_dfs chown crashes when uid is passed as -1 (cmccabe) (cmccabe: rev 2f1eb2bceb1df5f27649a514246b38b9ccf60cba)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/fuse-dfs/fuse_impls_chown.c
, FAILURE: Integrated in Hadoop-Hdfs-trunk #2477 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2477/])
HDFS-9268. fuse_dfs chown crashes when uid is passed as -1 (cmccabe) (cmccabe: rev 2f1eb2bceb1df5f27649a514246b38b9ccf60cba)
* hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/fuse-dfs/fuse_impls_chown.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #2530 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2530/])
HDFS-9268. fuse_dfs chown crashes when uid is passed as -1 (cmccabe) (cmccabe: rev 2f1eb2bceb1df5f27649a514246b38b9ccf60cba)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/fuse-dfs/fuse_impls_chown.c
, FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #540 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/540/])
HDFS-9268. fuse_dfs chown crashes when uid is passed as -1 (cmccabe) (cmccabe: rev 2f1eb2bceb1df5f27649a514246b38b9ccf60cba)
* hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/fuse-dfs/fuse_impls_chown.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #588 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/588/])
HDFS-9268. fuse_dfs chown crashes when uid is passed as -1 (cmccabe) (cmccabe: rev 2f1eb2bceb1df5f27649a514246b38b9ccf60cba)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/fuse-dfs/fuse_impls_chown.c
]