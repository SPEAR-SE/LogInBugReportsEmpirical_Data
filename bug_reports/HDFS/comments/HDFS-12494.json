[Patch 001
* Fix SEGV by setting thread local var to {{state}} before calling getGlobalJNIEnv

Testing Done
# build and start a pseudo cluster
# pushd hadoop-hdfs-project/hadoop-hdfs-native-client/target
# make clean && make
# export CLASSPATH=$(hadoop classpath)
# make test, expect java.lang.NoClassDefFoundError not SEGV, | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 14s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
|| || || || {color:brown} trunk Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 13m 36s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 17s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 13s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 22m 44s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} cc {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 13s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m  6s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:green}+1{color} | {color:green} unit {color} | {color:green}  0m 35s{color} | {color:green} hadoop-hdfs-native-client in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 18s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 35m 15s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:71bbb86 |
| JIRA Issue | HDFS-12494 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12890481/HDFS-12494.001.patch |
| Optional Tests |  asflicense  compile  cc  mvnsite  javac  unit  |
| uname | Linux dc3c5a38e4d3 3.13.0-119-generic #166-Ubuntu SMP Wed May 3 12:18:55 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / f702c95 |
| Default Java | 1.8.0_144 |
|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/21529/testReport/ |
| modules | C: hadoop-hdfs-project/hadoop-hdfs-native-client U: hadoop-hdfs-project/hadoop-hdfs-native-client |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/21529/console |
| Powered by | Apache Yetus 0.6.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.

, [~sailesh] Could you please take a look at the patch?, [~jzhuge] Thanks for submitting the patch.

One question I have:

Shouldn't we now clear the TLS if a failure happens in getGlobalJNIEnv(), since we now set the TLS before calling getGlobalJNIEnv(), but that TLS has no associated JNIEnv? So the next time that thread calls getJNIEnv, it would get a TLS without a JNIEnv which would fail elsewhere., It is ok because getJNIEnv returns NULL in this case and callers always check for NULL., Ah, you're right. For some reason, I thought it was returning 'state' instead of 'state->env'.


+1 LGTM., Committed to trunk and branch-3.0. Thanks [~sailesh] for the review!, SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #13046 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/13046/])
HDFS-12494. libhdfs SIGSEGV in setTLSExceptionStrings. Contributed by (jzhuge: rev 2856eb207bfb206f22a6266f42cad0257083ab94)
* (edit) hadoop-hdfs-project/hadoop-hdfs-native-client/src/main/native/libhdfs/jni_helper.c
]