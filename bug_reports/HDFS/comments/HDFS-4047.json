[Just like the description, we hoist the info log from offerService() out to run() and remove the while loop in offerservice(). The patch looks like huge change due to the format of code., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12551496/HADOOP-4047.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/3432//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3432//console

This message is automatically generated., Thanks Yanbo. While looking at your patch I noticed that offerService doesn't actually throw Exception so the outer loop is dead code which we can nuke.

What do you think of the following patch that does this? It also adds the sleep on IOE from the outer loop to the inner loop since that seems like the desired behavior., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12552884/hdfs-4047.txt
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.TestSafeMode
                  org.apache.hadoop.hdfs.TestEncryptedTransfer
                  org.apache.hadoop.hdfs.server.datanode.TestBPOfferService
                  org.apache.hadoop.hdfs.server.namenode.TestStorageRestore
                  org.apache.hadoop.hdfs.server.datanode.TestDataNodeMultipleRegistrations
                  org.apache.hadoop.hdfs.TestFileCreation
                  org.apache.hadoop.hdfs.TestModTime
                  org.apache.hadoop.hdfs.server.namenode.TestStartup
                  org.apache.hadoop.hdfs.security.TestDelegationToken
                  org.apache.hadoop.hdfs.server.namenode.ha.TestHAStateTransitions

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/3475//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3475//console

This message is automatically generated., Hi Eli,
You comment is instructive. But if moving the sleep on IOE from the outer loop to the inner loop will make the interval of heartbeat sending longer. When IOE occurs during the process of heartbeat, the thread will sleep for 5s and during these time the NN will not receive any heartbeat from this DN. It will make some failure of test case. For example, if the NN waits for the block report and the DN report thread sleep due to the above IOE, it will takes more time to make NN exits safe mode. As far as I know, most of the test failure is caused by this reason. So I just remove the sleep on IOE based on your patch. If IOE is throw during the loop, just log it and continue the loop as soon as possible. Looking forward for your opinion~, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12553294/HDFS-4047.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:red}-1 javac{color:red}.  The patch appears to cause the build to fail.

Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3493//console

This message is automatically generated., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12553299/HDFS-4047.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.server.datanode.TestBPOfferService
                  org.apache.hadoop.hdfs.server.datanode.TestDataNodeMultipleRegistrations

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/3494//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3494//console

This message is automatically generated., Good point. Let's remove the additional sleep. Also, the two tests failed because moving cleanUp() outside the finally block mean it isnot being called when connectToNNAndHandshake fails., Updated patch fixes both., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12553597/hdfs-4047.txt
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/3508//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3508//console

This message is automatically generated., The patch looks good!, Maybe I'm missing something here, but the old code had the behavior of retrying on any exception, whereas the new one only retries on IOException. If something on the inner loop throws a RuntimeException or other unchecked exception, then it won't continue looping, which is a change in behavior. Whether that's a good or bad change in behavior is up for debate, but this JIRA's description seems to indicate it's just code cleanup, where in fact more than that is happening., That's correct, I captured that in the comments in the patch but not in the jira - sorry - I should have called that out explicitly here.

{code}
-   * No matter what kind of exception we get, keep retrying to offerService().
-   * That's the loop that connects to the NameNode and provides basic DataNode
-   * functionality.
...
+   * Main loop for each BP thread. It retries on IOExceptions, only
+   * stops when "shouldRun" or "shouldServiceRun" are false, ie
+   * on shutdown or refreshNamenodes (or non-IOE).
{code}

My thinking from HDFS-2882 and HDFS-4201 is that we shouldn't soldier on in the case of an RTE, eg NPE due to a BP failing to initialize, as this likely indicates a host configuration error. I could also see the point of view that the DN shouldn't stop running because one BP failed because perhaps the other is alive and well. What do you think?
, I think I agree, but it seems better suited to look at that in the context of HDFS-2882 rather than changing it here. Let's use this for cleanup, and discuss what the best semantics are in 2882., @Todd, roger.  @Yanbo, would you like to post a patch that (unlike mine) is just cleanup and preserves the current behavior of retrying on all exceptions?, @Eli, I agree with Todd, just post a patch for cleanup code at this issue without behavior change. Whether we should soldier on in the case of an RTE is depend on the resolving of HDFS-2882. Before the resolving of HDFS-2882, keep the original semantics will be better for users. I will continue to former work on HDFS-2882 if others have no time to work on it., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12554133/HDFS-4047.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/3540//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/3540//console

This message is automatically generated., \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:red}-1{color} | patch |   0m  0s | The patch command could not apply the patch during dryrun. |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12554133/HDFS-4047.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | trunk / f1a152c |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/10528/console |


This message was automatically generated.]