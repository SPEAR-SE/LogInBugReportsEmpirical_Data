[Patch attached.

Replace INodeDirectoryWithQuota back to INodeDirectory if isQuotaSet() is false after setQuota., HDFS-1258: another bug related to clear quota., Hi Xiao, thanks for reporting this and providing a patch.  Some comments on the patch:
- The following will get an array index exception when the inode is root.
{code}
+            INodeDirectory parent = (INodeDirectory)inodes[inodes.length-2];
{code}
- Need new unit tests., John, the patch looks good but it seems that you have not checked "Grant license to ASF for inclusion in ASF work" when attaching the patch., attached a new patch after checking "Grant license to ASF for inclusion in ASF work", attaching the same patch with a different name, ant -Dforrest.home=${FORREST_HOME} -Djava5.home=${JAVA5} -Dfindbugs.home=${FINDBUGS_HOME} -Dpatch.file=/home/johngeo/hadoop_patches/HDFS-1189.patch test-patch


     [exec] BUILD SUCCESSFUL
     [exec] Total time: 32 seconds
     [exec] 
     [exec] 
     [exec] 
     [exec] 
     [exec] +1 overall.  
     [exec] 
     [exec]     +1 @author.  The patch does not contain any @author tags.
     [exec] 
     [exec]     +1 tests included.  The patch appears to include 4 new or modified tests.
     [exec] 
     [exec]     +1 javadoc.  The javadoc tool did not generate any warning messages.
     [exec] 
     [exec]     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.
     [exec] 
     [exec]     +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.
     [exec] 
     [exec]     +1 release audit.  The applied patch does not increase the total number of release audit warnings.
     [exec] 
     [exec]     +1 system test framework.  The patch passed system test framework compile.
     [exec] 
, Ran ant test locally (both with and without the patch). Got the same output:

run-test-hdfs-excluding-commit-and-smoke:
    [mkdir] Created dir: /home/johngeo/hadoop/hdfs_apache/hadoop-hdfs/build-fi/test/data
    [mkdir] Created dir: /home/johngeo/hadoop/hdfs_apache/hadoop-hdfs/build-fi/test/logs
     [copy] Copying 1 file to /home/johngeo/hadoop/hdfs_apache/hadoop-hdfs/build-fi/test/extraconf
     [copy] Copying 1 file to /home/johngeo/hadoop/hdfs_apache/hadoop-hdfs/build-fi/test/extraconf
    [junit] WARNING: multiple versions of ant detected in path for junit 
    [junit]          jar:file:/hadoop/config/apache-ant-1.8.2/lib/ant.jar!/org/apache/tools/ant/Project.class
    [junit]      and jar:file:/home/johngeo/.ivy2/cache/ant/ant/jars/ant-1.6.5.jar!/org/apache/tools/ant/Project.class
    [junit] Running org.apache.hadoop.fs.TestFiListPath
    [junit] Tests run: 2, Failures: 0, Errors: 0, Time elapsed: 5.445 sec
    [junit] Running org.apache.hadoop.fs.TestFiRename
    [junit] Tests run: 4, Failures: 0, Errors: 0, Time elapsed: 18.176 sec
    [junit] Running org.apache.hadoop.hdfs.TestFiHFlush
    [junit] Tests run: 9, Failures: 0, Errors: 0, Time elapsed: 48.84 sec
    [junit] Running org.apache.hadoop.hdfs.TestFiHftp
    [junit] Tests run: 1, Failures: 0, Errors: 0, Time elapsed: 43.284 sec
    [junit] Running org.apache.hadoop.hdfs.TestFiPipelines
    [junit] Tests run: 3, Failures: 0, Errors: 0, Time elapsed: 17.021 sec
    [junit] Running org.apache.hadoop.hdfs.server.datanode.TestFiDataTransferProtocol
    [junit] Tests run: 29, Failures: 0, Errors: 0, Time elapsed: 292.307 sec
    [junit] Running org.apache.hadoop.hdfs.server.datanode.TestFiDataTransferProtocol2
    [junit] Tests run: 10, Failures: 0, Errors: 0, Time elapsed: 455.929 sec
    [junit] Running org.apache.hadoop.hdfs.server.datanode.TestFiPipelineClose
    [junit] Tests run: 3, Failures: 0, Errors: 0, Time elapsed: 40.212 sec

checkfailure:

-run-test-hdfs-fault-inject-withtestcaseonly:

run-test-hdfs-fault-inject:

BUILD FAILED
/home/johngeo/hadoop/hdfs_apache/hadoop-hdfs/build.xml:746: Tests failed!

Total time: 132 minutes 29 seconds
, +1 patch looks good.

I have committed this.  Thanks, John!, Integrated in Hadoop-Hdfs-trunk-Commit #548 (See [https://hudson.apache.org/hudson/job/Hadoop-Hdfs-trunk-Commit/548/])
    HDFS-1189. Quota counts missed between clear quota and set quota.  Contributed by John George
, Committed also to Federation Branch., Need to submit patch for .20 release, Submitting patch for 20.204 branch, I ran ant test, test-patch and the following manual tests:
1. set Quota on a directory (both types) - pass
2. clear Quotas on that directory  - pass
3. clear Quotas on a directory that does not have set Quotas - pass
4. set & clear Quotas on root node - pass

The attached test-patch tests for the use case where a namespace is set and then cleared and then set again. This is where the bug shows up. After the namespace quota is set the second time after clearing once, it should get set to the right value and any file creation that exceeds the space quota should fail.

the test-patch for .20 branch and had the following output. The patch should not change any eclipse classpatch but the tests fail for that. I doubt if its anything to do with the patch.

     [exec] -1 overall.
     [exec] 
     [exec]     +1 @author.  The patch does not contain any @author tags.
     [exec] 
     [exec]     +1 tests included.  The patch appears to include 4 new or modified tests.
     [exec] 
     [exec]     -1 javadoc.  The javadoc tool appears to have generated 1 warning messages.
     [exec] 
     [exec]     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.
     [exec] 
     [exec]     +1 findbugs.  The patch does not introduce any new Findbugs warnings.
     [exec] 
     [exec]     -1 Eclipse classpath. The patch causes the Eclipse classpath to differ from the contents of the lib directories.
     [exec]
     [exec] 
     [exec] 
     [exec]
     [exec] ======================================================================
     [exec] ======================================================================
     [exec]     Finished build.
     [exec] ======================================================================
     [exec] ======================================================================
     [exec]
     [exec]
, I have also committed this to 0.20-security., Integrated in Hadoop-Hdfs-trunk #643 (See [https://builds.apache.org/hudson/job/Hadoop-Hdfs-trunk/643/])
    , Integrated in Hadoop-Hdfs-22-branch #35 (See [https://builds.apache.org/hudson/job/Hadoop-Hdfs-22-branch/35/])
    , Hadoop 0.20.204.0 was released.]