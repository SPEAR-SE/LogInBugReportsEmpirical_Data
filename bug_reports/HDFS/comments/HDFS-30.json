[It turns out this bug is caused by HADOOP-5384. Simulated datanodes send block reports to NN that contains a block with an invalid generation stamp, GenerationStamp.WILDCARD_STAMP. NN finds out the block does not belong to any file so marks it to be invalid. Then ReplicationMonitor schedules the block to be deleted on its datanode by adding it to the invalidateSet of its DatanodeDescriptor, which is a TreeSet. So adding the block to the invalidateSet triggers the call to Block#compareTo that throws IllegalStateExceptionon on wild card generation stamp. ReplicationMonitor calls System.exit to shutdown NN when catching a RuntimeException. So NN gets crashed.

A simple solution to the problem is that block report processing should filter blocks with wild card generation stamp.]