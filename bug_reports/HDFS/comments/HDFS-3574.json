[This patch fixes the above race as follows:

- after setting the headers, we check again to see that the file exists. If it doesn't exist at that point, we throw the FNFE before opening the response output stream. We pass the already-opened stream (from before the exists check) into {{getFileServer(...)}} so that we don't have a Time-of-check-to-time-of-use bug here.

I also did a little cleanup and made some stuff public for later use in HDFS-3077. I hope it's OK to do these trivial changes in this same JIRA. If it's a big problem I'll move them elsewhere.

Unfortunately I didn't write a unit test for this, as it's a somewhat difficult race., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12533590/hdfs-3574.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 javadoc.  The javadoc tool appears to have generated 2 warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    -1 findbugs.  The patch appears to introduce 2 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.fs.viewfs.TestViewFsTrash

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2709//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/2709//artifact/trunk/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2709//console

This message is automatically generated., It seems like there is still some TOCTOUs here, since we're getting the length of the file and then reading the file afterwards.  What if the length of the file changes?  Maybe we don't care about this case, but perhaps there should be a comment that this race exists.

I also don't completely understand the logic behind this:
{code}
if (!imageFile.exists()) {
  // Potential race where the file was deleted while we were in the
  // process of setting headers!
  throw new FileNotFoundException();
}
// send fsImage
TransferFsImage.getFileServer(response, imageFile, fis, getThrottler(conf));
{code}

Can't the imageFile be deleted immediately after the imageFile.exists() check and before the call to TransferFsImage#getFileServer?  So the original TOCTOU isn't really fixed either.

It seems like the only real fix would be creating a hardlink to a temporary file, so that if a user deleted the original file we were concerned with, the data would not be lost.  Alternately we could buffer the file in memory ahead of time, so that we know the length of what we're going to send and it can't disappear.  But that probably isn't feasible for large files, at least., bq. It seems like there is still some TOCTOUs here, since we're getting the length of the file and then reading the file afterwards. What if the length of the file changes? Maybe we don't care about this case, but perhaps there should be a comment that this race exists.

That's a good point - we're relying on the fact that we're transferring files which shouldn't be changing length once we start transferring them. I'll add a comment.

bq. Can't the imageFile be deleted immediately after the imageFile.exists() check and before the call to TransferFsImage#getFileServer? So the original TOCTOU isn't really fixed either.

That's why we pass the already-open stream ({{fis}}) at this point, instead of just the file path. If the file is deleted after the exists check, the stream is still valid., Added comments to explain the above better., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12533724/hdfs-3574.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    -1 findbugs.  The patch appears to introduce 2 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.fs.viewfs.TestViewFsTrash
                  org.apache.hadoop.ha.TestZKFailoverController
                  org.apache.hadoop.io.file.tfile.TestTFileByteArrays
                  org.apache.hadoop.io.file.tfile.TestTFileJClassComparatorByteArrays
                  org.apache.hadoop.hdfs.server.namenode.metrics.TestNameNodeMetrics
                  org.apache.hadoop.hdfs.server.datanode.TestBPOfferService

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2716//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/2716//artifact/trunk/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2716//console

This message is automatically generated., The failed tests don't seem at all related (none of them use this servlet), The patch looks pretty good to me. One small comment. +1 once this is addressed:

# "throw new FileNotFoundException();" - would be nice to say which file, in two places., Attached patch adds the file path to the FileNotFoundException thrown.

I also refactored the common code into a new serveFile() function., -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12534472/hdfs-3574.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    -1 findbugs.  The patch appears to introduce 2 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.util.TestShell
                  org.apache.hadoop.ha.TestZKFailoverController
                  org.apache.hadoop.hdfs.server.datanode.TestBPOfferService
                  org.apache.hadoop.hdfs.server.namenode.metrics.TestNameNodeMetrics

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2731//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/2731//artifact/trunk/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2731//console

This message is automatically generated., New patch tries to address findbugs warnings., The precommit ran here: https://builds.apache.org/job/PreCommit-HDFS-Build/2735/console but failed to post to JIRA because of the recent JIRA outage. Here is its comment:

-1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12534561/hdfs-3574.txt
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    -1 tests included.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.

    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    -1 core tests.  The patch failed these unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.fs.viewfs.TestViewFsTrash

    +1 contrib tests.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/2735//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/2735//console

This message is automatically generated.


Aaron, mind taking a quick look at the updated patch? Fairly trivial changes since the version you +1ed., +1, latest patch looks great., Committed to branch-2 and trunk, thanks Aaron., Integrated in Hadoop-Common-trunk-Commit #2422 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/2422/])
    HDFS-3574. Fix small race and do some cleanup in GetImageServlet. Contributed by Todd Lipcon. (Revision 1356939)

     Result = SUCCESS
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1356939
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/ServletUtil.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/GetImageServlet.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/TransferFsImage.java
, Integrated in Hadoop-Hdfs-trunk-Commit #2490 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/2490/])
    HDFS-3574. Fix small race and do some cleanup in GetImageServlet. Contributed by Todd Lipcon. (Revision 1356939)

     Result = SUCCESS
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1356939
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/ServletUtil.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/GetImageServlet.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/TransferFsImage.java
, Integrated in Hadoop-Mapreduce-trunk-Commit #2439 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/2439/])
    HDFS-3574. Fix small race and do some cleanup in GetImageServlet. Contributed by Todd Lipcon. (Revision 1356939)

     Result = FAILURE
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1356939
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/ServletUtil.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/GetImageServlet.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/TransferFsImage.java
, Integrated in Hadoop-Hdfs-trunk #1094 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1094/])
    HDFS-3574. Fix small race and do some cleanup in GetImageServlet. Contributed by Todd Lipcon. (Revision 1356939)

     Result = FAILURE
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1356939
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/ServletUtil.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/GetImageServlet.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/TransferFsImage.java
, Integrated in Hadoop-Mapreduce-trunk #1127 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1127/])
    HDFS-3574. Fix small race and do some cleanup in GetImageServlet. Contributed by Todd Lipcon. (Revision 1356939)

     Result = SUCCESS
todd : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1356939
Files : 
* /hadoop/common/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/ServletUtil.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/GetImageServlet.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/TransferFsImage.java
]