[It looks like https://issues.apache.org/jira/secure/attachment/12563083/hdfs-4351-branch-1-1.patch and the changes for BlockPlacementPolicyDefault in https://issues.apache.org/jira/secure/attachment/12549392/HDFS-3912-branch-1.patch are missing. A patch was made based on these two patches, The subclasses weren't updated in my first patch. Because the old methods are called so many times, I added them back to BlockPlacementPolicyDefault.java. They call the new APIs (i.e. the methods with parameter "boolean avoidStaleNodes") and pass "avoidStaleNodes = false"., +1 for the patch.  I tested successfully on Mac and Windows.  I committed this to branch-1-win.  Thank you for the patch, Xi.]