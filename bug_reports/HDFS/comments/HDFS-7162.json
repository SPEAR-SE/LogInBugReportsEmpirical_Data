[Fix wrong path and remove a debug statement., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12671740/HDFS-7162.patch
  against trunk revision b38e52b.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:red}-1 findbugs{color}.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.TestEncryptionZonesWithKMS

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8248//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/8248//artifact/PreCommit-HADOOP-Build-patchprocess/newPatchFindbugsWarningshadoop-hdfs.html
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8248//console

This message is automatically generated., Good find.

Rather than doing as this patch does, it would be better to add a slash to the end of {{trash_base}}.  That way, this check would not be triggered for paths which were not actually in Current:

{code}
  if (!strncmp(trash_base, abs_path, strlen(trash_base))) {                                                            
{code}

A path that ended in "Currently" could trigger this check right now., Updated patch.

Now it handles the following abs_path:
- /user/yourname/.Trash/Current
- /user/yourname/.Trash/Current/
- /user/yourname/.Trash/Currently
- /user/yourname/.Trash/Current/path/to/file, [~cmccabe] Simply adding a slash at the end of {{trash_base}} won't work since the abs_path could be {{/user/yourname/.Trash/Current}}, which should and will not be deleted then. I have added another check for this in the second patch.

And the previous fix was about the missing slash between {{target_dir}} and {{pcomp}}, which has nothing to do with the slash after {{Current}}. Please help review the new patch, thanks!, {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12671967/HDFS-7162.2.patch
  against trunk revision 0577eb3.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:red}-1 findbugs{color}.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.TestEncryptionZonesWithKMS
                  org.apache.hadoop.hdfs.server.namenode.ha.TestPipelinesFailover

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/8263//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/8263//artifact/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/8263//console

This message is automatically generated., Why not just add a slash to the end of {{trash_base}}?  Then you only have to change one line in {{get_trash_base}}., I think there are some misunderstandings, probably due to the title is not quite clear. So let me clarify what the patch actually does.

Two problems are fixed in HDFS-7162.2.patch:
- Say we want to delete the file {{/path/to/file}}, and somehow the file {{/user/yourname/.Trash/Current/path/to/file}} exists, we expect the file to be moved as {{/user/yourname/.Trash/Current/path/to/file.1}}. The actual thing it did was moving the file to {{/user/yourname/.Trash/Current/path/tofile.1}}, where a slash is missing.
- When judging if the file to be deleted ({{abs_path}}) is already in the trash, we compare the {{trash_base}} with {{abs_path}}. The problem is exactly as Colin has pointed out. But I don't think we could just add a slash to the end of {{trash_base}}, since the given {{abs_path}} can end with {{/user/yourname/.Trash/Current}} with no slash at the end. In this case, adding a slash to the end of {{trash_base}} would not delete the whold {{/user/yourname/.Trash/Current}} directory., Ah, you're right.  We need to add the slash after {{target_dir}}, not after {{trash_base}}.

Thanks, Chengbing.

+1., FAILURE: Integrated in Hadoop-trunk-Commit #6179 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6179/])
HDFS-7162. Wrong path when deleting through fuse-dfs a file which already exists in trash (cmccabe) (cmccabe: rev 03db9cc839663cad387db7df8e4f60b312058f18)
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/fuse-dfs/fuse_trash.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
HDFS-7162. Fix CHANGES.txt (should have Chenging Liu's name) (cmccabe: rev a56f3ecf86858a8ea054fec10eabc650a545bee9)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, SUCCESS: Integrated in Hadoop-Yarn-trunk #699 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/699/])
HDFS-7162. Wrong path when deleting through fuse-dfs a file which already exists in trash (cmccabe) (cmccabe: rev 03db9cc839663cad387db7df8e4f60b312058f18)
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/fuse-dfs/fuse_trash.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
HDFS-7162. Fix CHANGES.txt (should have Chenging Liu's name) (cmccabe: rev a56f3ecf86858a8ea054fec10eabc650a545bee9)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, SUCCESS: Integrated in Hadoop-Hdfs-trunk #1890 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1890/])
HDFS-7162. Wrong path when deleting through fuse-dfs a file which already exists in trash (cmccabe) (cmccabe: rev 03db9cc839663cad387db7df8e4f60b312058f18)
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/fuse-dfs/fuse_trash.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
HDFS-7162. Fix CHANGES.txt (should have Chenging Liu's name) (cmccabe: rev a56f3ecf86858a8ea054fec10eabc650a545bee9)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1915 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1915/])
HDFS-7162. Wrong path when deleting through fuse-dfs a file which already exists in trash (cmccabe) (cmccabe: rev 03db9cc839663cad387db7df8e4f60b312058f18)
* hadoop-hdfs-project/hadoop-hdfs/src/main/native/fuse-dfs/fuse_trash.c
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
HDFS-7162. Fix CHANGES.txt (should have Chenging Liu's name) (cmccabe: rev a56f3ecf86858a8ea054fec10eabc650a545bee9)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
]