[This patch let NameNode can replicate blocks belongs to under construction files but not the last block.
And if the decommissioning DataNodes only have some blocks which are the last blocks of under construction files and have more than 1 live replicates left behind, then NameNode could set it to DECOMMISSIONED., Thanks [~zhaoyunjiong] for filing Jira.

I think your fix would work and decommission datanode quickly.
Here is little comments about your patch.

1. try-catch not required. no statement inside try block will throw exception.

2. {code}block.getBlockId() == bc.getLastBlock().getBlockId(){code}
Better to use block.equals(bc.getLastBlock())

3. {code}if (block.getBlockId() == bc.getLastBlock().getBlockId() && curReplicas > 1) {
+              continue;
+            }{code}
Instead of 1 use minReplication

4. {code}+          underReplicatedInOpenFiles++;{code}
This should be incremented only if enough replicas are not there., Thanks Vinay.
Update patch as your comments.
Except: getLastBlock  do throws IOException, I deleted it in this patch., Updated patch looks good.

It will be better you add a testcase to test decommissioning with openfiles.

+1 on adding test., Update patch, added test case for trunk., {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12617130/HDFS-5579.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5750//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5750//console

This message is automatically generated., The latest patch looks good to me. The only comment is that the following comment from Vinay has not been addressed? +1 after fixing this.
{quote}
4. +          underReplicatedInOpenFiles++;
This should be incremented only if enough replicas are not there.
{quote}, It's already in the patch.
+        if (bc.isUnderConstruction()) {
+          if (block.equals(bc.getLastBlock()) && curReplicas > minReplication) {
+            continue;
+          }
+          underReplicatedInOpenFiles++;
+        }, {code}
+        if (bc.isUnderConstruction()) {
+          if (block.equals(bc.getLastBlock()) && curReplicas > minReplication) {
+            continue;
+          }
+          underReplicatedInOpenFiles++;
+        }
{code}

Here if {{block}} is not the last block, and {{block}} is not under replicated, underReplicatedInOpenFiles will still increase?, Good point. Thanks Jing.
Update patches to fix this problem., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12622097/HDFS-5579-branch-1.2.patch
  against trunk revision .

    {color:red}-1 patch{color}.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5848//console

This message is automatically generated., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12622101/HDFS-5579.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.TestSafeMode

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5850//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5850//console

This message is automatically generated., {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12622101/HDFS-5579.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:red}-1 javadoc{color}.  The javadoc tool appears to have generated -2 warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/5864//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/5864//console

This message is automatically generated., The javadoc warning and TestSafeMode failure should be unrelated. I will commit the patch shortly., I've committed this to trunk and branch-2. Thanks for the contribution [~zhaoyunjiong]!, SUCCESS: Integrated in Hadoop-trunk-Commit #4993 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/4993/])
HDFS-5579. Under construction files make DataNode decommission take very long hours. Contributed by zhaoyunjiong. (jing9: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1557904)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockCollection.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockManager.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/INodeFile.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDecommission.java
, Thanks for your time to review the patch, Jing., SUCCESS: Integrated in Hadoop-Yarn-trunk #452 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/452/])
HDFS-5579. Under construction files make DataNode decommission take very long hours. Contributed by zhaoyunjiong. (jing9: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1557904)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockCollection.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockManager.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/INodeFile.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDecommission.java
, FAILURE: Integrated in Hadoop-Mapreduce-trunk #1669 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1669/])
HDFS-5579. Under construction files make DataNode decommission take very long hours. Contributed by zhaoyunjiong. (jing9: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1557904)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockCollection.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockManager.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/INodeFile.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDecommission.java
, SUCCESS: Integrated in Hadoop-Hdfs-trunk #1644 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1644/])
HDFS-5579. Under construction files make DataNode decommission take very long hours. Contributed by zhaoyunjiong. (jing9: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1557904)
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockCollection.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/blockmanagement/BlockManager.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/INodeFile.java
* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestDecommission.java
]