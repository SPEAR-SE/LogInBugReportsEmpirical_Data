{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "fields": {
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "aggregatetimeestimate": null,
        "aggregatetimeoriginalestimate": null,
        "aggregatetimespent": null,
        "assignee": null,
        "components": [{
            "id": "12324715",
            "name": "rolling upgrades",
            "self": "https://issues.apache.org/jira/rest/api/2/component/12324715"
        }],
        "created": "2018-06-14T08:34:17.000+0000",
        "creator": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258"
            },
            "displayName": "Yiqun Lin",
            "key": "linyiqun",
            "name": "linyiqun",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=linyiqun",
            "timeZone": "Asia/Shanghai"
        },
        "customfield_10010": null,
        "customfield_12310191": null,
        "customfield_12310192": null,
        "customfield_12310220": null,
        "customfield_12310222": null,
        "customfield_12310230": null,
        "customfield_12310250": null,
        "customfield_12310290": null,
        "customfield_12310291": null,
        "customfield_12310300": null,
        "customfield_12310310": "0.0",
        "customfield_12310320": [
            {
                "archived": false,
                "description": "2.10.0 release",
                "id": "12341705",
                "name": "2.10.0",
                "released": false,
                "self": "https://issues.apache.org/jira/rest/api/2/version/12341705"
            },
            {
                "archived": false,
                "description": "2.9.2 release",
                "id": "12343005",
                "name": "2.9.2",
                "released": false,
                "self": "https://issues.apache.org/jira/rest/api/2/version/12343005"
            }
        ],
        "customfield_12310420": "9223372036854775807",
        "customfield_12310920": "9223372036854775807",
        "customfield_12310921": null,
        "customfield_12311020": null,
        "customfield_12311024": null,
        "customfield_12311120": null,
        "customfield_12311820": "0|i3uumn:",
        "customfield_12312022": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "customfield_12312026": null,
        "customfield_12312220": null,
        "customfield_12312320": null,
        "customfield_12312321": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312324": null,
        "customfield_12312325": null,
        "customfield_12312326": null,
        "customfield_12312327": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312330": null,
        "customfield_12312331": null,
        "customfield_12312332": null,
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12312335": null,
        "customfield_12312336": null,
        "customfield_12312337": null,
        "customfield_12312338": null,
        "customfield_12312339": null,
        "customfield_12312340": null,
        "customfield_12312341": null,
        "customfield_12312520": null,
        "customfield_12312521": "2018-06-14 08:34:17.0",
        "customfield_12312720": null,
        "customfield_12312823": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "customfield_12312923": null,
        "customfield_12313422": "false",
        "customfield_12313520": null,
        "description": "In version 2.6.0, we supported more storage types in HDFS that implemented in HDFS-6584. But this seems a incompatible change when we rolling upgrade our cluster from 2.5.0 to 2.6.0 and throw following error.\r\n{noformat}\r\n2018-06-14 11:43:39,246 ERROR [DataNode: [[[DISK]file:/home/vipshop/hard_disk/dfs/, [DISK]file:/data1/dfs/, [DISK]file:/data2/dfs/]] heartbeating to xx.xx.xx.xx:8022] org.apache.hadoop.hdfs.server.datanode.DataNode: Exception in BPOfferService for Block pool BP-670256553-xx.xx.xx.xx-1528795419404 (Datanode Uuid ab150e05-fcb7-49ed-b8ba-f05c27593fee) service to xx.xx.xx.xx:8022\r\njava.lang.ArrayStoreException\r\n at java.util.ArrayList.toArray(ArrayList.java:412)\r\n at java.util.Collections$UnmodifiableCollection.toArray(Collections.java:1034)\r\n at org.apache.hadoop.hdfs.protocolPB.PBHelper.convert(PBHelper.java:1030)\r\n at org.apache.hadoop.hdfs.protocolPB.PBHelper.convert(PBHelper.java:836)\r\n at org.apache.hadoop.hdfs.protocolPB.DatanodeProtocolClientSideTranslatorPB.sendHeartbeat(DatanodeProtocolClientSideTranslatorPB.java:146)\r\n at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.sendHeartBeat(BPServiceActor.java:566)\r\n at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.offerService(BPServiceActor.java:664)\r\n at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.run(BPServiceActor.java:835)\r\n at java.lang.Thread.run(Thread.java:748)\r\n{noformat}\r\nThe scenery is that old DN parses StorageType error that got from new NN. This error is taking place in sending heratbeat to NN and blocks won't be reported to NN successfully. This will lead subsequent errors.\r\n\r\nCorresponding logic in 2.5.0:\r\n{code}\r\n  public static BlockCommand convert(BlockCommandProto blkCmd) {\r\n    ...\r\n\r\n    StorageType[][] targetStorageTypes = new StorageType[targetList.size()][];\r\n    List<StorageTypesProto> targetStorageTypesList = blkCmd.getTargetStorageTypesList();\r\n    if (targetStorageTypesList.isEmpty()) { // missing storage types\r\n      for(int i = 0; i < targetStorageTypes.length; i++) {\r\n        targetStorageTypes[i] = new StorageType[targets[i].length];\r\n        Arrays.fill(targetStorageTypes[i], StorageType.DEFAULT);\r\n      }\r\n    } else {\r\n      for(int i = 0; i < targetStorageTypes.length; i++) {\r\n        List<StorageTypeProto> p = targetStorageTypesList.get(i).getStorageTypesList();\r\n        targetStorageTypes[i] = p.toArray(new StorageType[p.size()]);  <==== error here\r\n      }\r\n    }\r\n{code}\r\n\r\nBut corresponding to the current logic , it's will be better to return default type instead of a exception in case StorageType changed(new fields added or new types) in new versions during rolling upgrade.\r\n{code:java}\r\n    public static StorageType convertStorageType(StorageTypeProto type) {\r\n    switch(type) {\r\n    case DISK:\r\n      return StorageType.DISK;\r\n    case SSD:\r\n      return StorageType.SSD;\r\n    case ARCHIVE:\r\n      return StorageType.ARCHIVE;\r\n    case RAM_DISK:\r\n      return StorageType.RAM_DISK;\r\n    case PROVIDED:\r\n      return StorageType.PROVIDED;\r\n    default:\r\n      throw new IllegalStateException(\r\n          \"BUG: StorageTypeProto not found, type=\" + type);\r\n    }\r\n  }\r\n{code}\r\n",
        "duedate": null,
        "environment": null,
        "fixVersions": [],
        "issuelinks": [{
            "id": "12536395",
            "outwardIssue": {
                "fields": {
                    "issuetype": {
                        "avatarId": 21141,
                        "description": "A new feature of the product, which has yet to be developed.",
                        "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21141&avatarType=issuetype",
                        "id": "2",
                        "name": "New Feature",
                        "self": "https://issues.apache.org/jira/rest/api/2/issuetype/2",
                        "subtask": false
                    },
                    "priority": {
                        "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
                        "id": "3",
                        "name": "Major",
                        "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
                    },
                    "status": {
                        "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.",
                        "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png",
                        "id": "6",
                        "name": "Closed",
                        "self": "https://issues.apache.org/jira/rest/api/2/status/6",
                        "statusCategory": {
                            "colorName": "green",
                            "id": 3,
                            "key": "done",
                            "name": "Done",
                            "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
                        }
                    },
                    "summary": "Support Archival Storage"
                },
                "id": "12722899",
                "key": "HDFS-6584",
                "self": "https://issues.apache.org/jira/rest/api/2/issue/12722899"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12536395",
            "type": {
                "id": "10030",
                "inward": "is related to",
                "name": "Reference",
                "outward": "relates to",
                "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"
            }
        }],
        "issuetype": {
            "avatarId": 21133,
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "id": "1",
            "name": "Bug",
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "subtask": false
        },
        "labels": [],
        "lastViewed": null,
        "priority": {
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "id": "3",
            "name": "Major",
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
        },
        "progress": {
            "progress": 0,
            "total": 0
        },
        "project": {
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094",
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094"
            },
            "id": "12310942",
            "key": "HDFS",
            "name": "Hadoop HDFS",
            "projectCategory": {
                "description": "Scalable Distributed Computing",
                "id": "10292",
                "name": "Hadoop",
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10292"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/project/12310942"
        },
        "reporter": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258"
            },
            "displayName": "Yiqun Lin",
            "key": "linyiqun",
            "name": "linyiqun",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=linyiqun",
            "timeZone": "Asia/Shanghai"
        },
        "resolution": null,
        "resolutiondate": null,
        "status": {
            "description": "The issue is open and ready for the assignee to start work on it.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png",
            "id": "1",
            "name": "Open",
            "self": "https://issues.apache.org/jira/rest/api/2/status/1",
            "statusCategory": {
                "colorName": "blue-gray",
                "id": 2,
                "key": "new",
                "name": "To Do",
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2"
            }
        },
        "subtasks": [],
        "summary": "StorageType is incompatible when rolling upgrade to 2.6/2.6+ versions",
        "timeestimate": null,
        "timeoriginalestimate": null,
        "timespent": null,
        "updated": "2018-06-14T10:01:32.000+0000",
        "versions": [{
            "archived": false,
            "description": "2.5.0 release",
            "id": "12326264",
            "name": "2.5.0",
            "releaseDate": "2014-08-11",
            "released": true,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12326264"
        }],
        "votes": {
            "hasVoted": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HDFS-13678/votes",
            "votes": 0
        },
        "watches": {
            "isWatching": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HDFS-13678/watchers",
            "watchCount": 4
        },
        "workratio": -1
    },
    "id": "13166035",
    "key": "HDFS-13678",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13166035"
}