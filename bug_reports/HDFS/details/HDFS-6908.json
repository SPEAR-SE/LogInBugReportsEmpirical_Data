{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12735884","self":"https://issues.apache.org/jira/rest/api/2/issue/12735884","key":"HDFS-6908","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12327181","id":"12327181","description":"2.6.0 release","name":"2.6.0","archived":false,"released":true,"releaseDate":"2014-11-18"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-08-21T23:18:04.489+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Feb 07 09:18:10 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_472202940_*|*_1_*:*_1_*:*_35481555_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-08-27T17:30:43.269+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6908/watchers","watchCount":7,"isWatching":false},"created":"2014-08-21T20:29:18.831+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12440106","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12440106","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12863206","key":"HDFS-9052","self":"https://issues.apache.org/jira/rest/api/2/issue/12863206","fields":{"summary":"deleteSnapshot runs into AssertionError","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-09-16T18:22:56.352+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12320700","id":"12320700","name":"snapshots","description":"HDFS snapshots"}],"timeoriginalestimate":null,"description":"In the following scenario, delete snapshot could generate incorrect snapshot directory diff and corrupted fsimage, if you restart NN after that, you will get NullPointerException.\n1. create a directory and create a file under it\n2. take a snapshot\n3. create another file under that directory\n4. take second snapshot\n5. delete both files and the directory\n6. delete second snapshot\nincorrect directory diff will be generated.\n\nRestart NN will throw NPE\n{code}\njava.lang.NullPointerException\n\tat org.apache.hadoop.hdfs.server.namenode.snapshot.FSImageFormatPBSnapshot$Loader.addToDeletedList(FSImageFormatPBSnapshot.java:246)\n\tat org.apache.hadoop.hdfs.server.namenode.snapshot.FSImageFormatPBSnapshot$Loader.loadDeletedList(FSImageFormatPBSnapshot.java:265)\n\tat org.apache.hadoop.hdfs.server.namenode.snapshot.FSImageFormatPBSnapshot$Loader.loadDirectoryDiffList(FSImageFormatPBSnapshot.java:328)\n\tat org.apache.hadoop.hdfs.server.namenode.snapshot.FSImageFormatPBSnapshot$Loader.loadSnapshotDiffSection(FSImageFormatPBSnapshot.java:192)\n\tat org.apache.hadoop.hdfs.server.namenode.FSImageFormatProtobuf$Loader.loadInternal(FSImageFormatProtobuf.java:254)\n\tat org.apache.hadoop.hdfs.server.namenode.FSImageFormatProtobuf$Loader.load(FSImageFormatProtobuf.java:168)\n\tat org.apache.hadoop.hdfs.server.namenode.FSImageFormat$LoaderDelegator.load(FSImageFormat.java:208)\n\tat org.apache.hadoop.hdfs.server.namenode.FSImage.loadFSImage(FSImage.java:906)\n\tat org.apache.hadoop.hdfs.server.namenode.FSImage.loadFSImage(FSImage.java:892)\n\tat org.apache.hadoop.hdfs.server.namenode.FSImage.loadFSImageFile(FSImage.java:715)\n\tat org.apache.hadoop.hdfs.server.namenode.FSImage.loadFSImage(FSImage.java:653)\n\tat org.apache.hadoop.hdfs.server.namenode.FSImage.recoverTransitionRead(FSImage.java:276)\n\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.loadFSImage(FSNamesystem.java:882)\n\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.loadFromDisk(FSNamesystem.java:629)\n\tat org.apache.hadoop.hdfs.server.namenode.NameNode.loadNamesystem(NameNode.java:498)\n\tat org.apache.hadoop.hdfs.server.namenode.NameNode.initialize(NameNode.java:554)\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12663522","id":"12663522","filename":"HDFS-6908.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-21T22:09:22.868+0000","size":3505,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12663522/HDFS-6908.001.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12663603","id":"12663603","filename":"HDFS-6908.002.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-22T06:20:25.627+0000","size":5504,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12663603/HDFS-6908.002.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12663979","id":"12663979","filename":"HDFS-6908.003.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-24T18:42:39.418+0000","size":5423,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12663979/HDFS-6908.003.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"incorrect snapshot directory diff generated by snapshot deletion","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14106035","id":"14106035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"body":"The problem is when deleting snapshot, hdfs will clean Inode that not in any snapshot any more. however, the logic is a bit wrong.\nif an inode is directory, it calls destroyCreatedList() to put created children inodes(created between prior snapshot and the deleting one) to removedINodes list, but also clear the createdList. this breaks the create/delete pair operation. so later, when combine the diff with prior diff, the delete operation stays.\nI think instead of calling destroyCreatedList(), it should just do dir.removeChild(c), and let the file diff does cleanup for files.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-21T22:09:22.872+0000","updated":"2014-08-21T22:09:22.872+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14106127","id":"14106127","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for working on this, [~jyu@cloudera.com]! Actually this is a case the current code fails to cover. Your analysis makes sense to me.\n\nHowever, for the fix, if we only call dir.removeChild, the inodes that were created between prior snapshot and the deleting one will still be kept in the created list, thus can cause leaking. Maybe a better way to fix is to call {{cleanSubtreeRecursively}} before {{cleanDeletedINode}}:\n{code}\ndiff --git a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/snapshot/DirectoryWithSnapshotFeature.java b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hado\nindex 9893bba..a4f69f0 100644\n--- a/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/snapshot/DirectoryWithSnapshotFeature.java\n+++ b/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/snapshot/DirectoryWithSnapshotFeature.java\n@@ -722,6 +722,8 @@ boolean computeDiffBetweenSnapshots(Snapshot fromSnapshot,\n         counts.add(lastDiff.diff.destroyCreatedList(currentINode,\n             collectedBlocks, removedINodes));\n       }\n+      counts.add(currentINode.cleanSubtreeRecursively(snapshot, prior,\n+          collectedBlocks, removedINodes, priorDeleted, countDiffChange));\n     } else {\n       // update prior\n       prior = getDiffs().updatePrior(snapshot, prior);\n@@ -739,7 +741,10 @@ boolean computeDiffBetweenSnapshots(Snapshot fromSnapshot,\n       \n       counts.add(getDiffs().deleteSnapshotDiff(snapshot, prior,\n           currentINode, collectedBlocks, removedINodes, countDiffChange));\n-      \n+\n+      counts.add(currentINode.cleanSubtreeRecursively(snapshot, prior,\n+          collectedBlocks, removedINodes, priorDeleted, countDiffChange));\n+\n       // check priorDiff again since it may be created during the diff deletion\n       if (prior != Snapshot.NO_SNAPSHOT_ID) {\n         DirectoryDiff priorDiff = this.getDiffs().getDiffById(prior);\n@@ -778,9 +783,7 @@ boolean computeDiffBetweenSnapshots(Snapshot fromSnapshot,\n         }\n       }\n     }\n-    counts.add(currentINode.cleanSubtreeRecursively(snapshot, prior,\n-        collectedBlocks, removedINodes, priorDeleted, countDiffChange));\n-    \n+\n     if (currentINode.isQuotaSet()) {\n       currentINode.getDirectoryWithQuotaFeature().addSpaceConsumed2Cache(\n           -counts.get(Quota.NAMESPACE), -counts.get(Quota.DISKSPACE));\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-21T23:18:04.489+0000","updated":"2014-08-21T23:18:04.489+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14106133","id":"14106133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"For the current patch, another comment is that we can move the new unit test to TestSnapshotDeletion.java, and call {{hdfs.delete(file1, true);}} instead of {{hdfs.delete(file1);}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-21T23:20:09.439+0000","updated":"2014-08-21T23:20:09.439+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14106231","id":"14106231","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~jingzhao].\nbecause the directory is deleted, it means the file created between prior snapshot and the deleting one must be deleted as well. so there are create/delete pair operations for those files. the file diff processing part will add the file to removedINodes list. when I debug the fix, I saw the inode for the file are deleted correctly, no leak. and the intermediate create/delete file change is cleaned after combining the diff with prior one as well.\n\n{code}\n} else if (topNode.isFile() && topNode.asFile().isWithSnapshot()) {\n        INodeFile file = topNode.asFile();\n        counts.add(file.getDiffs().deleteSnapshotDiff(post, prior, file,\n            collectedBlocks, removedINodes, countDiffChange));\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-22T00:23:04.690+0000","updated":"2014-08-22T00:23:04.690+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14106272","id":"14106272","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the response, [~jyu@cloudera.com].\n\nbq. so there are create/delete pair operations for those files.\n\nThe challenge here is that we cannot guarantee we always have the create/delete pair. Imagine the deletion happens on the directory while the creation happens on a file under the directory. Then we cannot depend on the snapshot diff combination to clean the file. The following unit test (based on your original test case) demos the scenario (but with your patch the following test will hit another exception before the leaking check):\n{code}\n  @Test (timeout=60000)\n  public void testDeleteSnapshot() throws Exception {\n    final Path root = new Path(\"/\");\n\n    Path dir = new Path(\"/dir1\");\n    Path file1 = new Path(dir, \"file1\");\n    DFSTestUtil.createFile(hdfs, file1, BLOCKSIZE, REPLICATION, seed);\n\n    hdfs.allowSnapshot(root);\n    hdfs.createSnapshot(root, \"s1\");\n\n    Path file2 = new Path(dir, \"file2\");\n    DFSTestUtil.createFile(hdfs, file2, BLOCKSIZE, REPLICATION, seed);\n    INodeFile file2Node = fsdir.getINode(file2.toString()).asFile();\n    long file2NodeId = file2Node.getId();\n\n    hdfs.createSnapshot(root, \"s2\");\n\n    // delete directory\n    assertTrue(hdfs.delete(dir, true));\n    assertNotNull(fsdir.getInode(file2NodeId));\n\n    // delete second snapshot\n    hdfs.deleteSnapshot(root, \"s2\");\n    assertTrue(fsdir.getInode(file2NodeId) == null);\n\n    NameNodeAdapter.enterSafeMode(cluster.getNameNode(), false);\n    NameNodeAdapter.saveNamespace(cluster.getNameNode());\n\n    // restart NN\n    cluster.restartNameNodes();\n  }\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-22T01:03:11.341+0000","updated":"2014-08-22T01:03:58.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14106507","id":"14106507","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"body":"[~jingzhao]] Thanks for the new unit test and explain the difference.\nI assumed when deleting a directory recursively, all children will be added to the diff list. but that's not how the implementation is done. snapshot diff only record directory deletion. so the fix you suggested is better.\nOne more question, I think what's really needed is to  call {{cleanSubtreeRecursively}} before {{destroyCreatedList}}, isn't it?\n{code}\n+      counts.add(currentINode.cleanSubtreeRecursively(snapshot, prior,\n+          collectedBlocks, removedINodes, priorDeleted, countDiffChange));\n      // delete everything in created list\n      DirectoryDiff lastDiff = diffs.getLast();\n      if (lastDiff != null) {\n         counts.add(lastDiff.diff.destroyCreatedList(currentINode,\n             collectedBlocks, removedINodes));\n       }\n     } else {\n       // update prior\n       prior = getDiffs().updatePrior(snapshot, prior);\n@@ -739,7 +741,10 @@ boolean computeDiffBetweenSnapshots(Snapshot fromSnapshot,\n       \n       counts.add(getDiffs().deleteSnapshotDiff(snapshot, prior,\n           currentINode, collectedBlocks, removedINodes, countDiffChange));\n-      \n+\n+      counts.add(currentINode.cleanSubtreeRecursively(snapshot, prior,\n+          collectedBlocks, removedINodes, priorDeleted, countDiffChange));\n+\n       // check priorDiff again since it may be created during the diff deletion\n       if (prior != Snapshot.NO_SNAPSHOT_ID) {\n         DirectoryDiff priorDiff = this.getDiffs().getDiffById(prior);\n@@ -778,9 +783,7 @@ boolean computeDiffBetweenSnapshots(Snapshot fromSnapshot,\n         }\n       }\n     }\n-    counts.add(currentINode.cleanSubtreeRecursively(snapshot, prior,\n-        collectedBlocks, removedINodes, priorDeleted, countDiffChange));\n-    \n+\n     if (currentINode.isQuotaSet()) {\n       currentINode.getDirectoryWithQuotaFeature().addSpaceConsumed2Cache(\n           -counts.get(Quota.NAMESPACE), -counts.get(Quota.DISKSPACE));\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-22T05:54:06.669+0000","updated":"2014-08-22T05:54:06.669+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14106516","id":"14106516","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"Yeah, I think that is necessary when deleting a snapshot. But when deleting a dir/file from the current fsdir, I guess it should be ok to place {{cleanSubtreeRecursively}} in the end.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-22T06:06:38.789+0000","updated":"2014-08-22T06:06:38.789+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14107809","id":"14107809","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12663603/HDFS-6908.002.patch\n  against trunk revision .\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:\n\n                  org.apache.hadoop.security.TestRefreshUserMappings\n                  org.apache.hadoop.hdfs.server.namenode.ha.TestPipelinesFailover\n                  org.apache.hadoop.hdfs.server.blockmanagement.TestBlockTokenWithDFS\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/7732//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/7732//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-08-23T02:31:55.626+0000","updated":"2014-08-23T02:31:55.626+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14107908","id":"14107908","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12663603/HDFS-6908.002.patch\n  against trunk revision .\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:\n\n                  org.apache.hadoop.hdfs.TestEncryptionZones\n                  org.apache.hadoop.hdfs.TestDistributedFileSystem\n                  org.apache.hadoop.hdfs.TestFileAppend4\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/7735//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/7735//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-08-23T07:12:18.263+0000","updated":"2014-08-23T07:12:18.263+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14108096","id":"14108096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"Actually when deleting a directory from the current namespace, it may be better to call {{destroyCreated}} before calling {{cleanSubtreeRecursively}}. This is because:\n# The current bug only exists in snapshot deletion scenario (when deleting a directory, there is no snapshot combination logic involved).\n# {{cleanSubtreeRecursively}} goes through the complete children list of the current directory, where the children that are contained in the created list anyway should be completely removed. We can avoid processing these files/directories in {{cleanSubtreeRecursively}} if we call {{destroyCreated}} first.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-23T19:10:05.390+0000","updated":"2014-08-23T19:10:05.390+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14108488","id":"14108488","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~jingzhao] for reviewing. revised the patch.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-24T18:42:39.422+0000","updated":"2014-08-24T18:42:39.422+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14108592","id":"14108592","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12663979/HDFS-6908.003.patch\n  against trunk revision .\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:\n\n                  org.apache.hadoop.hdfs.TestFileAppend\n                  org.apache.hadoop.hdfs.server.blockmanagement.TestBlockTokenWithDFS\n                  org.apache.hadoop.hdfs.web.TestWebHdfsFileSystemContract\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/7744//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/7744//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-08-24T21:33:12.534+0000","updated":"2014-08-24T21:33:12.534+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14108735","id":"14108735","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"body":"I don't think the failed tests are related to this patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-25T04:54:23.645+0000","updated":"2014-08-25T04:54:23.645+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14109386","id":"14109386","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"+1 for the latest patch. Thanks for the fix, [~jyu@cloudera.com]! I will commit it later today.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-25T17:48:29.697+0000","updated":"2014-08-25T17:48:29.697+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14110927","id":"14110927","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"body":"[~jingzhao]] Thanks for reviewing patch and the discussion.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jyu%40cloudera.com","name":"jyu@cloudera.com","key":"jyu@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juan Yu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-26T16:40:30.339+0000","updated":"2014-08-26T16:40:30.339+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14112507","id":"14112507","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"I've committed this to trunk and branch-2. Thanks [~jyu@cloudera.com] for the contribution!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-27T17:30:43.305+0000","updated":"2014-08-27T17:30:43.305+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14310377","id":"14310377","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abhishekrai","name":"abhishekrai","key":"abhishekrai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abhishek Rai","active":true,"timeZone":"America/Los_Angeles"},"body":"We have an HDFS installation in production where we ran into this problem.  Since the fsimage is corrupt, namenode fails to come up, leaving the system unusable.  We suspect that the problem was triggered in our case by deletion of one of the existing snapshots of a large directory containing several sub-directories and files.\n\nWhile the proposed fix above is definitely useful to prevent this issue going forward, is there any recommendation for how to fix an fsimage which was already corrupted by this bug?\n\nWe temporarily put in the following hack in FSImageFormatPBSnapshot.java to mask this problem.  The risk with this hack is that it can mask other bugs/corruptions, and since it doesn't fix the corrupt fsimage on disk, the hack will always be needed to make the namenode work.\n\n{noformat}\n+++ b/hadoop/hadoop-2.5.1-src/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/snapshot/FSImageFormatPBSnapshot.java\n@@ -34,6 +34,8 @@\n import java.util.List;\n import java.util.Map;\n \n+import org.apache.commons.logging.Log;\n+import org.apache.commons.logging.LogFactory;\n import org.apache.hadoop.classification.InterfaceAudience;\n import org.apache.hadoop.fs.permission.PermissionStatus;\n import org.apache.hadoop.hdfs.server.namenode.AclFeature;\n@@ -73,6 +75,9 @@\n \n @InterfaceAudience.Private\n public class FSImageFormatPBSnapshot {\n+  public static final Log LOG = LogFactory.getLog(FSImageFormatPBSnapshot.class);\n+\n+\n   /**\n    * Loading snapshot related information from protobuf based FSImage\n    */\n@@ -267,8 +272,12 @@ private void addToDeletedList(INode dnode, INodeDirectory parent) {\n       // load non-reference inodes\n       for (long deletedId : deletedNodes) {\n         INode deleted = fsDir.getInode(deletedId);\n-        dlist.add(deleted);\n-        addToDeletedList(deleted, dir);\n+        if (deleted != null) {\n+          dlist.add(deleted);\n+          addToDeletedList(deleted, dir);\n+        } else {\n+          LOG.error(\"Could not find inode \" + deletedId + \" from deleted-list of directory: \" + dir.toDetailString());\n+        }\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abhishekrai","name":"abhishekrai","key":"abhishekrai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abhishek Rai","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-02-07T01:13:55.013+0000","updated":"2015-02-07T01:13:55.013+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14310489","id":"14310489","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"body":"bq. and since it doesn't fix the corrupt fsimage on disk, the hack will always be needed to make the namenode work.\n\nWhen the NN comes up (ensure you also have this bugfix patched on), you can then invoke a {{dfsadmin -saveNamespace}} to recreate a new, good image.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-02-07T02:52:04.789+0000","updated":"2015-02-07T02:52:04.789+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12735884/comment/14310628","id":"14310628","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abhishekrai","name":"abhishekrai","key":"abhishekrai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abhishek Rai","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Harsh, that sounds reasonable.  It gives us a way to avoid having to live with the FSImageFormatPBSnapshot hack longer term once the proper fix for this bug is applied.\n\nThanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abhishekrai","name":"abhishekrai","key":"abhishekrai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Abhishek Rai","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-02-07T09:18:10.660+0000","updated":"2015-02-07T09:18:10.660+0000"}],"maxResults":19,"total":19,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6908/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1z787:"}}