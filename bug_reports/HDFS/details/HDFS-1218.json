{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12467129","self":"https://issues.apache.org/jira/rest/api/2/issue/12467129","key":"HDFS-1218","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316392","id":"12316392","description":"Merge append/sync support with security","name":"0.20.205.0","archived":false,"released":true,"releaseDate":"2011-10-06"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-06-22T00:53:27.356+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Mar 29 09:12:22 UTC 2012","customfield_12310420":"15935","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_40953373168_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-10-03T21:52:43.250+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-1218/watchers","watchCount":7,"isWatching":false},"created":"2010-06-16T21:56:30.159+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315103","id":"12315103","description":"Append/sync support for Hadoop 0.20","name":"0.20-append","archived":true,"released":false}],"issuelinks":[{"id":"12349857","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12349857","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12548630","key":"HDFS-3161","self":"https://issues.apache.org/jira/rest/api/2/issue/12548630","fields":{"summary":"20 Append: Excluded DN replica from recovery should be removed from DN.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-03-29T09:12:23.063+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312927","id":"12312927","name":"datanode"}],"timeoriginalestimate":null,"description":"When a datanode experiences power loss, it can come back up with truncated replicas (due to local FS journal replay). Those replicas should not be allowed to truncate the block during block synchronization if there are other replicas from DNs that have _not_ restarted.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12493871","id":"12493871","filename":"HDFS-1218.20s.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-09T23:53:43.666+0000","size":31143,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12493871/HDFS-1218.20s.2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12447282","id":"12447282","filename":"hdfs-1281.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-06-16T22:04:06.921+0000","size":32760,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12447282/hdfs-1281.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"14215","customfield_12312823":null,"summary":"20 append: Blocks recovered on startup should be treated with lower priority during block synchronization","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12879536","id":"12879536","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here's a patch, but won't apply on top of the branch currently. Requires HDFS-1057 and possibly some other FSDataset patches first to apply without conflict (possibly HDFS-1056)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-06-16T22:04:06.997+0000","updated":"2010-06-16T22:04:06.997+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12880987","id":"12880987","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"body":"a few questions\n\n1. this assumes a DN goes down with the client (either in tandem, or on the same box) and that the NN initiates lease recovery later correct?\n\n2. the idea here is that RBW should have lengths longer than RWR, but both will have the same genstamp?\n \nIf so, why aren't we just taking the replica with the longest length? Is there a reason to \n\n3.  if sync() did not complete, there is no violation.  do I follow?  i agree we can try to recover more data if it's there, but i just want to make sure i'm on the same page\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-06-22T00:53:27.356+0000","updated":"2010-06-22T00:53:27.356+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12880989","id":"12880989","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"body":"I realize in the hadoop code we already swallow InterruptedException frequently, but I think you can change the trend here:\n\n{code}\n        // wait for all acks to be received back from datanodes\n        synchronized (ackQueue) {\n          if (!closed && ackQueue.size() != 0) {\n            try {\n              ackQueue.wait();\n            } catch (InterruptedException e) {\n              Thread.currentThread.interrupt();  //add this \n            }\n            continue;\n          }\n        }\n{code}\n\notherwise, it's very easy to have a thread that I own and manage that has a DFSOutputStream in it that swallows an interrupt.  when i check Thread.currentThread.isInterrupted() to see if one of my other threads has interrupted me, i will not see it\n\n(the crux here is that swallowing interrupts in threads that hadoop controls are less harmful--this is directly in client code when you call sync()/close())\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-06-22T00:57:09.287+0000","updated":"2010-06-22T00:57:09.287+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12880990","id":"12880990","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"body":"disregard comment above, was meant for hdfs-895\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-06-22T00:58:09.243+0000","updated":"2010-06-22T00:58:09.243+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12880994","id":"12880994","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. 1. this assumes a DN goes down with the client (either in tandem, or on the same box) and that the NN initiates lease recovery later correct?\n\nReally, this applies any time that recovery is initiated after the node has come back to life. The most likely case is a hard lease expiry like you suggest above, since it gives a full hour for the DN to restart, but it could be a manually triggered recovery as well.\n\nbq. 2. the idea here is that RBW should have lengths longer than RWR, but both will have the same genstamp?\n\nyep, s/should/could/ though (in many cases, RWR will have the right length)\n\nbq. If so, why aren't we just taking the replica with the longest length? Is there a reason to\n\nIn a normal pipeline failure, it's likely that the earlier DNs in the pipeline will have longer length than the later ones, right? So if we always just took the longest length, we'd usually recover to a pipeline of length 1 even when other replicas are available that satisfy correct semantics. At least, I assume this is the reasoning - in this patch I was just trying to maintain the semantics elsewhere.\n\nbq. 3. if sync() did not complete, there is no violation. do I follow? i agree we can try to recover more data if it's there, but i just want to make sure i'm on the same page\n\nThe issue here is that sync() could complete, but the post-power-failure replica could still be truncated. Recall that hflush() doesn't actually fsync to disk, so after an actual power failure of the local node, it will usually come back with a truncated replica after EXT3 journal replay.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-06-22T01:00:01.420+0000","updated":"2010-06-22T01:00:01.420+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881005","id":"12881005","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"body":"1. how can there be a pipeline recovery by a client when the client goes down?  in client-initiated recovery, it sends in the list of nodes which excludes the node that went down.  Even if a node goes down and comes back up, it won't participate in recovery.\n\nThe only case I can see that this can occur is if the client is not the one to initiate lease recovery--ie hard or soft limits in the NN.\n\nI only point this out because I wonder if this recovery code can be simplified.  We already pass in a flag that is a surrogate for indicating NN initiated lease recovery (closeFile == true => NN).  \n\nmaybe not, but I wanted to throw it out there.\n\n2. hmm, i think i see, it's sort of like using RBW and RWR as 1 and 0, and tacking to the genstamp so that you take the highest appended genstamp and take the shortest length of those as the length of the block.  in this way, you are auto-incrementing the genstamp in a way...\n\nbut I think there's still an edge case:  \n\n  i. client node has network trouble (slow, falls off) and transfer to next DN in pipeline from primary slowed/stops (going to timeout)\n  ii. DN-1 writes after putting bytes into network buffer\n  iii. bytes make it to first DN disk, but do not leave OS network stack\n  iv. DN-1 comes up before NN starts hard expiry lease recovery\n  v. we use the other DNs length which is shorter\n\nor do I misunderstand?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-06-22T01:36:05.758+0000","updated":"2010-06-22T01:36:05.758+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881007","id":"12881007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"re #1: I was referring to client-initiated recovery after a soft lease expiration (like what we do in all of the TestFileAppend4 tests). In that case, the targets for recovery come from the \"targets\" field of the last block, which will include the previously-down node, which may well have restarted by this time.\n\nRegarding simplifying code, perhaps... but I think it's a bit late in the game to change it much now :)\n\nre #2. I think that's fine - we'll use a shorter length, but in this case the client never received ACK for those extra bytes. Thus, no sync() could have succeeded, and it's OK to truncate those extra bytes, even though we happen to have them.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-06-22T01:45:25.385+0000","updated":"2010-06-22T01:45:25.385+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881011","id":"12881011","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"body":"ah, interesting.  so the point of this fix isn't to get the best block, but to maintain sync semantics?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-06-22T01:55:16.451+0000","updated":"2010-06-22T01:55:16.451+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881012","id":"12881012","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"right - the block will get truncated to a length *smaller than* the last sync, in the following not-too-rare circumstance:\n1) node loses power\n2) node reboots, replays EXT3 journal (almost always results in truncation of replica)\n3) lease recovery occurs and includes the rebooted node as a recovery target","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-06-22T01:58:17.812+0000","updated":"2010-06-22T01:58:17.812+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881025","id":"12881025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"body":"re: the patch\n\nshouldn't the skipping of RWRs be inside the else block?  if keepLength is passed by a client, the fact the block length matches should be the sole criteria for accepting it right?  there is not a notion of \"better\".\n\n(tho, I don't think it will ever be the case that we have RWRs participating in a client-initiated recovery.  soft expiry even comes from the NN where keepLength=false)\n\n{code}\n        if (!shouldRecoverRwrs && info.wasRecoveredOnStartup()) {\n          LOG.info(\"Not recovering replica \" + record + \" since it was recovered on \"\n              + \"startup and we have better replicas\");\n          continue;\n        }\n        if (keepLength) {\n          if (info.getBlock().getNumBytes() == block.getNumBytes()) {\n            syncList.add(record);\n          }\n        } else {          \n          syncList.add(record);\n          if (info.getBlock().getNumBytes() < minlength) {\n            minlength = info.getBlock().getNumBytes();\n          }\n        }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-06-22T02:23:31.057+0000","updated":"2010-06-22T02:23:31.057+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881043","id":"12881043","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Yea, I see your point that we could move it inside. Like you said, though, I don't think it's material because the situation shouldn't happen in practice, and I think the code is a little clearer to skip at the top of the loop like that. Let me know if you want me to upload a new patch.\n\n(btw, I haven't mentioned above, but I've been running with this patch for a couple weeks with lots of testing, it should be pretty stable)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-06-22T03:49:33.254+0000","updated":"2010-06-22T03:49:33.254+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881249","id":"12881249","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"body":"I racked my brain and can't come up with a case that this could actually occur--keepLength is only set true when doing an append.  If any nodes had gone down and come back up (RWR), they either have an old genstamp and will be ignored, or soft lease expiry recovery is initiated by the NN with keepLength = false first.\n\ni think the idea + patch look good to me\n(and thanks for taking the time to explain it)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-06-22T16:59:06.360+0000","updated":"2010-06-22T16:59:06.360+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881382","id":"12881382","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"body":"sorry, to clarify my previous comment, \"this\" = the case in my previous(previous comment) that was talking about moving the recovery-state check inside the else block. \n\nso just to clarify, i think this patch is good for 0.20-append.\n\ntodd:  do we need to port this to trunk?  or does trunk already handle this since it has the RBW/RWR?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rash37","name":"rash37","key":"rash37","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sam rash","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-06-22T21:51:20.765+0000","updated":"2010-06-22T21:51:20.765+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881389","id":"12881389","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. todd: do we need to port this to trunk? or does trunk already handle this since it has the RBW/RWR?\n\nTrunk should already handle this case. We should port forward these test cases at some point, but there's already an open JIRA to move forward all the new TestFileAppend4 cases - hopefully we can do that after we finish getting everything in this branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-06-22T22:01:40.007+0000","updated":"2010-06-22T22:01:40.007+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881395","id":"12881395","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"This looks ready for commit into 0.20-append. Todd: can you pl upload a patch that merges with 0-20-append branch? Thanks a lot.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-06-22T22:09:43.806+0000","updated":"2010-06-22T22:09:43.806+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881401","id":"12881401","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"The patch has a lot of conflicts unless we do HDFS-1057 and HDFS-1056 first. Rather than try to resolve those conflicts, I think it's safer to get those patches in first, and then have less confict resolution work to do here (I'm afraid of switching around the application order too much - too easy to flub resolution and introduce a bug).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-06-22T22:14:58.428+0000","updated":"2010-06-22T22:14:58.428+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12881411","id":"12881411","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"Ok no problem. then we will just have to wait for HDFS-1056 and HDFS-1057 to be committed into trunk first.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-06-22T22:24:29.448+0000","updated":"2010-06-22T22:24:29.448+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/12936122","id":"12936122","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thanhdo","name":"thanhdo","key":"thanhdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thanhdo&avatarId=22565","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thanhdo&avatarId=22565","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thanhdo&avatarId=22565","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thanhdo&avatarId=22565"},"displayName":"Thanh Do","active":true,"timeZone":"Etc/UTC"},"body":"Todd, is this similar to HDFS-1103?\nwill the problem goes away\nif we don't take the replica at the reboot node\nin the recovery target?\nI.e., we only take RBW replicas into lease recovery,\nbut not RWR?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thanhdo","name":"thanhdo","key":"thanhdo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thanhdo&avatarId=22565","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thanhdo&avatarId=22565","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thanhdo&avatarId=22565","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thanhdo&avatarId=22565"},"displayName":"Thanh Do","active":true,"timeZone":"Etc/UTC"},"created":"2010-11-26T23:14:17.316+0000","updated":"2010-11-26T23:14:17.316+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13101660","id":"13101660","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"Patch ported to 0.20-security.\n\nTestFileAppend4#testFullClusterPowerLoss() fails in this patch. The test involves lease recovery post DN restart, triggered by append. Since DN ipc ports change between restarts and NN does not update the IPC port for the DNs upon re-registration, the lease recovery uses ipc port from the previous registration. This results in RPC failure and the test failure.\n\nI have change DatanodeID#updateRegInfo() to update ipc port along with other fields.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-09T23:53:43.693+0000","updated":"2011-09-09T23:53:43.693+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13101667","id":"13101667","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jnp","name":"jnp","key":"jnp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jitendra Nath Pandey","active":true,"timeZone":"Etc/UTC"},"body":"+1 for the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jnp","name":"jnp","key":"jnp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jitendra Nath Pandey","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-10T00:06:25.430+0000","updated":"2011-09-10T00:06:25.430+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13101669","id":"13101669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"I committed the patch to 0.20-security.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-10T00:07:01.140+0000","updated":"2011-09-10T00:07:01.140+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13101671","id":"13101671","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Sounds like you incorporated HDFS-894?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2011-09-10T00:07:52.858+0000","updated":"2011-09-10T00:07:52.858+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13119658","id":"13119658","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Suresh committed this to 0.20.205","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2011-10-03T21:52:43.297+0000","updated":"2011-10-03T21:52:43.297+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13130247","id":"13130247","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mattf","name":"mattf","key":"mattf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Foley","active":true,"timeZone":"America/Los_Angeles"},"body":"Closed upon release of 0.20.205.0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mattf","name":"mattf","key":"mattf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matt Foley","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-19T00:26:11.481+0000","updated":"2011-10-19T00:26:11.481+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13240355","id":"13240355","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"{code}\n if (!shouldRecoverRwrs && info.wasRecoveredOnStartup()) {\n+          LOG.info(\"Not recovering replica \" + record + \" since it was recovered on \"\n+              + \"startup and we have better replicas\");\n+          continue;\n+        }{code}\n\n@Todd, can you please tell why this check added?\n\nTake a case,  \n\n 1) DN1->DN2->DN3 are in pipeline.\n 2) Client killed abruptly\n 3) one DN has restarted , say DN3\n 4) In DN3 info.wasRecoveredOnStartup() will be true\n 5) NN recovery triggered, DN3 skipped from recovery due to above check.\n 6) Now DN1, DN2 has blocks with generataion stamp 2 and DN3 has older generation stamp say 1 and also DN3 still has this block entry in ongoingCreates\n 7) as part of recovery file has closed and got only two live replicas ( from DN1 and DN2)\n 8) So, NN issued the command for replication. Now DN3 also has the replica with newer generation stamp.\n 9) Now DN3 contains 2 replicas on disk. and one entry in ongoing creates with referring to blocksBeingWritten directory.\n \nWhen we call append/ leaseRecovery, it may again skip this node for that recovery as blockId entry still presents in ongoingCreates with startup recovery true.\nIt may keep continue this dance for evry recovery.\nAnd this stale replica will not be cleaned untill we restart the cluster. Actual replica will be trasferred to this node only through replication process.\n\nAlso unnecessarily that replicated blocks will get invalidated after next recoveries....\n\nI understood that check might be because to exclude the restarted node for calculating the min lengths to truncate.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-28T11:41:59.204+0000","updated":"2012-03-28T11:41:59.204+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13240611","id":"13240611","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hi Uma. The idea was to exclude the restarted node for length calculation. It looks like you're right that we aren't putting them in syncList at all, whereas we could put them in syncList in the case that they have length >= the calculated minlength.\n\nHowever, it's still the case that DN3 might be shorter than the good replicas, and not included in recovery. In that case, it should be deleted when it reports the block with the too-low GS later. I guess the real issue is that we don't include all RBW blocks in block reports in the 1.0 implementation, so it sticks around forever?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-03-28T18:33:15.836+0000","updated":"2012-03-28T18:33:15.836+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13240746","id":"13240746","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Since this issue has been closed a long time, mind opening a new one against branch-1? If you could come up with a test case that would also be great. Seems like you could modify the existing test cases just to make sure that the other replica eventually gets removed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-03-28T21:26:12.010+0000","updated":"2012-03-28T21:26:12.010+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13240872","id":"13240872","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks a lot Todd.\n\n{quote}\nHowever, it's still the case that DN3 might be shorter than the good replicas, and not included in recovery. In that case, it should be deleted when it reports the block with the too-low GS later. I guess the real issue is that we don't include all RBW blocks in block reports in the 1.0 implementation, so it sticks around forever?\n{quote}\n\nExactly.\n\n{quote}\nSince this issue has been closed a long time, mind opening a new one against branch-1? If you could come up with a test case that would also be great. Seems like you could modify the existing test cases just to make sure that the other replica eventually gets removed.\n{quote}\nSure. I will file one new bug and come up with testcase.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-29T01:18:13.715+0000","updated":"2012-03-29T01:18:13.715+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12467129/comment/13241096","id":"13241096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"Todd, here is the JIRA filed HDFS-3161","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-29T09:12:22.352+0000","updated":"2012-03-29T09:12:22.352+0000"}],"maxResults":29,"total":29,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-1218/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i02shb:"}}