{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12994963","self":"https://issues.apache.org/jira/rest/api/2/issue/12994963","key":"HDFS-10723","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-08-04T22:38:46.591+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Aug 15 22:03:44 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-10723/watchers","watchCount":3,"isWatching":false},"created":"2016-08-04T16:48:04.160+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-08-15T22:03:44.819+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312916","id":"12312916","name":"test"}],"timeoriginalestimate":null,"description":"In {{testWhileOpenRenameParentToNonexistentDir}},\n\n{code}\n      // restart cluster with the same namenode port as before.\n      // This ensures that leases are persisted in fsimage.\n      cluster.shutdown();\n{code}\n\nAnd we are getting test failures in precommit builds.\n{noformat}\njava.net.BindException: Problem binding to [localhost:47395]\n java.net.BindException: Address already in use;\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12822294","id":"12822294","filename":"testWhileOpenRenameParentToNonexistentDir.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2016-08-05T14:31:39.894+0000","size":102265,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12822294/testWhileOpenRenameParentToNonexistentDir.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"TestRenameWhileOpen tries to restart NN with the same rpc port","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15408597","id":"15408597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"body":"Hi [~kihwal], \nI wanted to give this jira a try but I can't assign jiras in HDFS to myself. \n\nIs the fix for this jira a matter of allowing the thread to sleep longer? I tried the test on my laptop and it passes.\n\nPatch as follows:\n\n{code}\ndiff --git hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestRenameWhileOpen.java hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestRenameWhileOpen.java\nindex 949fc74..f06383f 100644\n--- hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestRenameWhileOpen.java\n+++ hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestRenameWhileOpen.java\n@@ -188,7 +188,7 @@ public void testWhileOpenRenameParentToNonexistentDir() throws IOException {\n       // restart cluster with the same namenode port as before.\n       // This ensures that leases are persisted in fsimage.\n       cluster.shutdown();\n-      try {Thread.sleep(2*MAX_IDLE_TIME);} catch (InterruptedException e) {}\n+      try {Thread.sleep(8*MAX_IDLE_TIME);} catch (InterruptedException e) {}\n       cluster = new MiniDFSCluster.Builder(conf).nameNodePort(nnport)\n                                                 .format(false)\n                                                 .build();\n@@ -255,7 +255,7 @@ public void testWhileOpenRenameToExistentDirectory() throws IOException {\n       // restart cluster with the same namenode port as before.\n       // This ensures that leases are persisted in fsimage.\n       cluster.shutdown();\n-      try {Thread.sleep(2*MAX_IDLE_TIME);} catch (InterruptedException e) {}\n+      try {Thread.sleep(8*MAX_IDLE_TIME);} catch (InterruptedException e) {}\n       cluster = new MiniDFSCluster.Builder(conf).nameNodePort(nnport)\n                                                 .format(false)\n                                                 .build();\n@@ -319,7 +319,7 @@ public void testWhileOpenRenameToNonExistentDirectory() throws IOException {\n       // restart cluster with the same namenode port as before.\n       // This ensures that leases are persisted in fsimage.\n       cluster.shutdown();\n-      try {Thread.sleep(2*MAX_IDLE_TIME);} catch (InterruptedException e) {}\n+      try {Thread.sleep(8*MAX_IDLE_TIME);} catch (InterruptedException e) {}\n       cluster = new MiniDFSCluster.Builder(conf).nameNodePort(nnport)\n                                                 .format(false)\n                                                 .build();\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-04T22:38:46.591+0000","updated":"2016-08-04T22:38:46.591+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15408847","id":"15408847","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi, [~vrushalic], I am not sure if this is the best way for fixing this. Maybe we need to know why the cluster was not shutdown completely.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"created":"2016-08-05T04:25:58.055+0000","updated":"2016-08-05T04:25:58.055+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15408852","id":"15408852","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"body":"Hmm yes, the test runs fine on my local machine. Do you have a link handy to the failures in the precommit build? I tried looking but couldn't find any related to this one. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-05T04:30:01.475+0000","updated":"2016-08-05T04:30:01.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15409513","id":"15409513","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"It is more likely that another process grabbed the port. In general it is not a good idea to hard-code or reuse the same port number in unit tests. We had to fix a lot of such test cases in the past. The jenkins slave can run multiple jobs at the same time and also hdfs tests can run in parallel.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2016-08-05T14:23:04.571+0000","updated":"2016-08-08T19:10:50.792+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15409519","id":"15409519","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"Here is the log from a failed test run. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2016-08-05T14:31:39.900+0000","updated":"2016-08-05T14:31:39.900+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15409667","id":"15409667","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"body":"I see, got you. Let me see if I can change the port number. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-05T16:29:29.832+0000","updated":"2016-08-05T16:29:29.832+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15409906","id":"15409906","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"body":"I updated the test to use a random port number. The test output that I see is as follows:\n\n{code}\n[machine-channapattan hadoop-hdfs (trunk)]$ grep -rni -A2 \"nnport=\" target/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt:2:Will now start MiniDFSCluster with nnport=58999\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt-3-2016-08-05 11:51:56,081 [main] INFO  hdfs.MiniDFSCluster (MiniDFSCluster.java:<init>(465)) - starting cluster: numNameNodes=1, numDataNodes=1\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt-4-2016-08-05 11:51:56,319 [main] DEBUG namenode.NameNode (NameNode.java:initializeGenericKeys(1670)) - Setting fs.defaultFS to hdfs://127.0.0.1:58999\n--\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt:1592:Will now start MiniDFSCluster with nnport=7009\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt-1593-2016-08-05 11:52:09,583 [main] INFO  hdfs.MiniDFSCluster (MiniDFSCluster.java:<init>(465)) - starting cluster: numNameNodes=1, numDataNodes=1\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt-1594-2016-08-05 11:52:09,587 [main] DEBUG namenode.NameNode (NameNode.java:initializeGenericKeys(1670)) - Setting fs.defaultFS to hdfs://127.0.0.1:7009\n--\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt:2523:Will now start MiniDFSCluster with nnport=17516\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt-2524-2016-08-05 11:52:20,090 [main] INFO  hdfs.MiniDFSCluster (MiniDFSCluster.java:<init>(465)) - starting cluster: numNameNodes=1, numDataNodes=1\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt-2525-2016-08-05 11:52:20,093 [main] DEBUG namenode.NameNode (NameNode.java:initializeGenericKeys(1670)) - Setting fs.defaultFS to hdfs://127.0.0.1:17516\n--\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt:3450:Will now start MiniDFSCluster with nnport=28234\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt-3451-2016-08-05 11:52:30,808 [main] INFO  hdfs.MiniDFSCluster (MiniDFSCluster.java:<init>(465)) - starting cluster: numNameNodes=1, numDataNodes=1\ntarget/surefire-reports/org.apache.hadoop.hdfs.TestRenameWhileOpen-output.txt-3452-2016-08-05 11:52:30,811 [main] DEBUG namenode.NameNode (NameNode.java:initializeGenericKeys(1670)) - Setting fs.defaultFS to hdfs://127.0.0.1:28234\n[machine-channapattan hadoop-hdfs (trunk)]$\n{code}\n\nSo I still can't upload a patch to HDFS jiras. Hence pasting my patch here:\n\n{code}\n[machine-channapattan hadoop (trunk)]$ cat ../HDFS-10723.001.patch\ndiff --git hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestRenameWhileOpen.java hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestRenameWhileOpen.java\nindex 949fc74..9d6b127 100644\n--- hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestRenameWhileOpen.java\n+++ hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/TestRenameWhileOpen.java\n@@ -55,10 +55,16 @@ public void testWhileOpenRenameParent() throws IOException {\n     conf.setInt(DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_KEY, 1);\n     conf.setInt(DFSConfigKeys.DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_KEY, 1);\n     conf.setInt(DFSConfigKeys.DFS_BLOCK_SIZE_KEY, TestFileCreation.blockSize);\n+    System.out.println(\"Test 1*****************************\");\n\n+    // try to get a random port number < 65535\n+    // hence take mod 65534\n+    final int nnport = (int) (System.currentTimeMillis() % 65534);\n+    System.out.println(\"Will now start MiniDFSCluster with nnport=\" + nnport);\n     // create cluster\n-    System.out.println(\"Test 1*****************************\");\n-    MiniDFSCluster cluster = new MiniDFSCluster.Builder(conf).build();\n+    MiniDFSCluster cluster = new MiniDFSCluster.Builder(conf)\n+        .nameNodePort(nnport).format(true).build();\n+\n     FileSystem fs = null;\n     try {\n       cluster.waitActive();\n@@ -72,8 +78,6 @@ public void testWhileOpenRenameParent() throws IOException {\n       doNothing().when(spyLog).endCurrentLogSegment(Mockito.anyBoolean());\n       DFSTestUtil.setEditLogForTesting(cluster.getNamesystem(), spyLog);\n\n-      final int nnport = cluster.getNameNodePort();\n-\n       // create file1.\n       Path dir1 = new Path(\"/user/a+b/dir1\");\n       Path file1 = new Path(dir1, \"file1\");\n@@ -155,13 +159,18 @@ public void testWhileOpenRenameParentToNonexistentDir() throws IOException {\n     conf.setInt(DFSConfigKeys.DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_KEY, 1);\n     System.out.println(\"Test 2************************************\");\n\n+    // try to get a random port number < 65535\n+    // hence take mod 65534\n+    final int nnport = (int) (System.currentTimeMillis() % 65534);\n+    System.out.println(\"Will now start MiniDFSCluster with nnport=\" + nnport);\n     // create cluster\n-    MiniDFSCluster cluster = new MiniDFSCluster.Builder(conf).build();\n+    MiniDFSCluster cluster = new MiniDFSCluster.Builder(conf)\n+        .nameNodePort(nnport).format(true).build();\n+\n     FileSystem fs = null;\n     try {\n       cluster.waitActive();\n       fs = cluster.getFileSystem();\n-      final int nnport = cluster.getNameNodePort();\n\n       // create file1.\n       Path dir1 = new Path(\"/user/dir1\");\n@@ -230,13 +239,18 @@ public void testWhileOpenRenameToExistentDirectory() throws IOException {\n     conf.setInt(DFSConfigKeys.DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_KEY, 1);\n     System.out.println(\"Test 3************************************\");\n\n+    // try to get a random port number < 65535\n+    // hence take mod 65534\n+    final int nnport = (int) (System.currentTimeMillis() % 65534);\n+    System.out.println(\"Will now start MiniDFSCluster with nnport=\" + nnport);\n     // create cluster\n-    MiniDFSCluster cluster = new MiniDFSCluster.Builder(conf).build();\n+    MiniDFSCluster cluster = new MiniDFSCluster.Builder(conf)\n+        .nameNodePort(nnport).format(true).build();\n+\n     FileSystem fs = null;\n     try {\n       cluster.waitActive();\n       fs = cluster.getFileSystem();\n-      final int nnport = cluster.getNameNodePort();\n\n       // create file1.\n       Path dir1 = new Path(\"/user/dir1\");\n@@ -295,13 +309,18 @@ public void testWhileOpenRenameToNonExistentDirectory() throws IOException {\n     conf.setInt(DFSConfigKeys.DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_KEY, 1);\n     System.out.println(\"Test 4************************************\");\n\n+    // try to get a random port number < 65535\n+    // hence take mod 65534\n+    final int nnport = (int) (System.currentTimeMillis() % 65534);\n+    System.out.println(\"Will now start MiniDFSCluster with nnport=\" + nnport);\n     // create cluster\n-    MiniDFSCluster cluster = new MiniDFSCluster.Builder(conf).build();\n+    MiniDFSCluster cluster = new MiniDFSCluster.Builder(conf)\n+        .nameNodePort(nnport).format(true).build();\n+\n     FileSystem fs = null;\n     try {\n       cluster.waitActive();\n       fs = cluster.getFileSystem();\n-      final int nnport = cluster.getNameNodePort();\n\n       // create file1.\n       Path dir1 = new Path(\"/user/dir1\");\n[machine-channapattan hadoop (trunk)]$\n{code}\n\nWould appreciate your feedback.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-05T18:55:22.418+0000","updated":"2016-08-05T18:55:22.418+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15412183","id":"15412183","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"body":"Gentle ping [~kihwal] and [~linyiqun] for your thoughts on the patch posted above. Also, if you could please add me to the contributors list, then I can assign the jira to myself. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-08T18:05:47.312+0000","updated":"2016-08-08T18:05:47.312+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15412331","id":"15412331","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"When a {{MiniDFSCluster}} is brought up without setting the rpc port, it will binds to a random available port. There is no need to find and specify one. So making it bind to a random port is easy. Take a look at other test cases.\n\nThe test might be trying to use the same port for a specific reason. If this is the case, fixing it will be a bit more complicated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2016-08-08T19:38:16.308+0000","updated":"2016-08-08T19:38:16.308+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15412821","id":"15412821","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi, [~vrushalic], some comments from me:\n\n1.We can just removed the method {{nameNodePort(nnport)}} for here as [~kihwal] said if the test is not trying to use the same port. But in this test, I am not so sure for that, because it show this:\n{code}\n      // restart cluster with the same namenode port as before.\n      // This ensures that leases are persisted in fsimage.\n{code}\nSo we may be to confirm for this.\n\n2.I see there were some similar failed test in {{TestFileCreationDelete}}(https://builds.apache.org/job/PreCommit-HDFS-Build/16290/testReport/). If we can also fix in this jira, it will be better. These two tests seems very similar.\n\n3.Just attach your patch and trigger the button {{submit patch}}. If your patch was accepted by the commiters, they will assign this jira to you.\n\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"created":"2016-08-09T01:58:04.279+0000","updated":"2016-08-09T01:59:43.540+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12994963/comment/15421759","id":"15421759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"body":"Yes, the test does seem to require binding to the previously bound port in that test. My guess is that when the port is set free after the mini cluster is brought down and the test is trying to bind to the same port again, some other process grabs that port in the meantime. I am wondering how this can be controlled. Need to look deeper into how available ports are returned for bind calls with port 0. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vrushalic","name":"vrushalic","key":"vrushalic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10433"},"displayName":"Vrushali C","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-15T22:03:44.819+0000","updated":"2016-08-15T22:03:44.819+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-10723/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i31x4f:"}}