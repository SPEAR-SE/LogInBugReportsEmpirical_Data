{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12674337","self":"https://issues.apache.org/jira/rest/api/2/issue/12674337","key":"HDFS-5380","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Oct 17 16:20:02 UTC 2013","customfield_12310420":"353959","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-5380/watchers","watchCount":4,"isWatching":false},"created":"2013-10-17T16:17:18.487+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12320353","id":"12320353","description":"hadoop-2.0.0-alpha release","name":"2.0.0-alpha","archived":false,"released":true,"releaseDate":"2012-05-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324148","id":"12324148","description":"maintenance release on branch-1.2","name":"1.2.1","archived":false,"released":true,"releaseDate":"2013-08-01"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-10-17T16:34:05.788+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312926","id":"12312926","name":"namenode"}],"timeoriginalestimate":null,"description":"Consider the following contrived example:\n{code}\n// Step 1: Create file with replication factor = 2\nPath path = ...;\nshort replication = 2;\nOutputStream os = fs.create(path, ..., replication, ...);\n\n// Step 2: Write to file\nos.write(...);\n\n// Step 3: Reduce replication factor to 1\nfs.setReplication(path, 1);\n// Wait for namenode to prune excess replicates\n\n// Step 4: Read from file\nInputStream is = fs.open(path);\nis.read(...);\n{code}\n\nDuring the read in _Step 4_, the {{DFSInputStream}} client receives \"stale\" block locations from the NameNode.  Specifically, it receives block locations that the NameNode has already pruned/invalidated (and the DataNodes have already deleted).\n\nThe net effect of this is unnecessary churn in the {{DFSClient}} (timeouts, retries, extra RPCs, etc.).  In particular:\n{noformat}\nWARN  hdfs.DFSClient - Failed to connect to datanode-1 for block, add to deadNodes and continue.\n{noformat}\n\nThe blacklisting of DataNodes that are, in fact, functioning properly can lead to inefficient locality of reads.  Since the blacklist is _cumulative_ across all blocks in the file, this can have noticeable impact for large files.\n\nA pathological case can occur when *all* block locations are in the blacklist.  In this case, the {{DFSInputStream}} will sleep and refetch locations from the NameNode, causing unnecessary RPCs and a client-side sleep:  \n{noformat}\nINFO  hdfs.DFSClient - Could not obtain blk_1073741826_1002 from any node: java.io.IOException: No live nodes contain current block. Will get new block locations from namenode and retry...\n{noformat}\n\nThis pathological case can occur in the following example (for a read of file {{foo}}):\n# {{DFSInputStream}} attempts to read block 1 of {{foo}}.\n# Gets locations: {{( dn1(stale), dn2 )}}\n# Attempts read from {{dn1}}.  Fails.  Adds {{dn1}} to blacklist.\n# {{DFSInputStream}} attempts to read block 2 of {{foo}}.\n# Gets locations: {{( dn1, dn2(stale) )}}\n# Attempts read from {{dn2}} ({{dn1}} already blacklisted).  Fails.  Adds {{dn2}} to blacklist.\n# All locations for block 2 are now in blacklist.\n# Clears blacklists\n# Sleeps up to 3 seconds\n# Refetches locations from the NameNode\n\nA solution would be to change the NameNode to not return stale block locations to clients for replicas that it knows it has asked DataNodes to invalidate.\n\nA quick look at the {{BlockManager.chooseExcessReplicates()}} code path seems to indicate that the NameNode does not actually remove the pruned replica from the BlocksMap until the subsequent blockReport is received.  This can leave a substantial window where the NameNode can return stale replica locations to clients.  \n\nIf the NameNode were to proactively update the {{BlocksMap}} upon excess replica pruning, this situation could be avoided.  If the DataNode did not actually invalidate the replica as asked, the NameNode would simply re-add the replica to the {{BlocksMap}} upon next blockReport and go through the pruning exercise again.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12608955","id":"12608955","filename":"ExcessReplicaPruningTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sirianni","name":"sirianni","key":"sirianni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sirianni&avatarId=16970","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sirianni&avatarId=16970","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sirianni&avatarId=16970","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sirianni&avatarId=16970"},"displayName":"Eric Sirianni","active":true,"timeZone":"America/New_York"},"created":"2013-10-17T16:20:02.154+0000","size":4050,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12608955/ExcessReplicaPruningTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"354251","customfield_12312823":null,"summary":"NameNode returns stale block locations to clients during excess replica pruning","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sirianni","name":"sirianni","key":"sirianni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sirianni&avatarId=16970","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sirianni&avatarId=16970","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sirianni&avatarId=16970","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sirianni&avatarId=16970"},"displayName":"Eric Sirianni","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sirianni","name":"sirianni","key":"sirianni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sirianni&avatarId=16970","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sirianni&avatarId=16970","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sirianni&avatarId=16970","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sirianni&avatarId=16970"},"displayName":"Eric Sirianni","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12674337/comment/13798033","id":"13798033","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sirianni","name":"sirianni","key":"sirianni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sirianni&avatarId=16970","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sirianni&avatarId=16970","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sirianni&avatarId=16970","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sirianni&avatarId=16970"},"displayName":"Eric Sirianni","active":true,"timeZone":"America/New_York"},"body":"JUnit test that demonstrates this issue using {{MiniDFSCluster}}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sirianni","name":"sirianni","key":"sirianni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sirianni&avatarId=16970","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sirianni&avatarId=16970","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sirianni&avatarId=16970","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sirianni&avatarId=16970"},"displayName":"Eric Sirianni","active":true,"timeZone":"America/New_York"},"created":"2013-10-17T16:20:02.158+0000","updated":"2013-10-17T16:20:02.158+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-5380/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1p0w7:"}}