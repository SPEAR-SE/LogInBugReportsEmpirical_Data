{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13118771","self":"https://issues.apache.org/jira/rest/api/2/issue/13118771","key":"HDFS-12820","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-11-17T15:17:42.818+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Nov 20 09:14:27 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-12820/watchers","watchCount":5,"isWatching":false},"created":"2017-11-16T01:55:57.718+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326143","id":"12326143","description":"2.4.0 release","name":"2.4.0","archived":false,"released":true,"releaseDate":"2014-04-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-11-20T09:14:27.711+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/4","description":"This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/reopened.png","name":"Reopened","id":"4","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12332920","id":"12332920","name":"block placement"}],"timeoriginalestimate":null,"description":"When allocate a datanode when dfsclient write with considering the load, it checks if the datanode is overloaded by calculating the average xceivers of all the in service datanode. But if the datanode is decommissioned and become dead, it's still treated as in service, which make the average load much more than the real one especially when the number of the decommissioned datanode is great. In our cluster, 180 datanode, and 100 of them decommissioned, and the average load is 17. This failed all the datanode allocation. \r\n\r\nprivate void subtract(final DatanodeDescriptor node) {\r\n      capacityUsed -= node.getDfsUsed();\r\n      blockPoolUsed -= node.getBlockPoolUsed();\r\n      xceiverCount -= node.getXceiverCount();\r\n    {color:red}  if (!(node.isDecommissionInProgress() || node.isDecommissioned())) {{color}\r\n        nodesInService--;\r\n        nodesInServiceXceiverCount -= node.getXceiverCount();\r\n        capacityTotal -= node.getCapacity();\r\n        capacityRemaining -= node.getRemaining();\r\n      } else {\r\n        capacityTotal -= node.getDfsUsed();\r\n      }\r\n      cacheCapacity -= node.getCacheCapacity();\r\n      cacheUsed -= node.getCacheUsed();\r\n    }","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Decommissioned datanode is counted in service cause datanode allcating failure","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiegang112","name":"xiegang112","key":"xiegang112","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gang Xie","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiegang112","name":"xiegang112","key":"xiegang112","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gang Xie","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118771/comment/16257107","id":"16257107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for reporting the issue, [~xiegang112].\r\nHadoop 2.4.0 is an old release and no longer supported. The issue reported in this jira is fixed by HDFS-9279.\r\n\r\nI am going to resolve this jira as a dup of HDFS-9279. Please reopen if this is not the case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-17T15:17:42.818+0000","updated":"2017-11-17T15:17:42.818+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118771/comment/16258834","id":"16258834","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiegang112","name":"xiegang112","key":"xiegang112","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gang Xie","active":true,"timeZone":"Etc/UTC"},"body":"nice, let me check it out.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiegang112","name":"xiegang112","key":"xiegang112","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gang Xie","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-20T06:04:55.408+0000","updated":"2017-11-20T06:04:55.408+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118771/comment/16258974","id":"16258974","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiegang112","name":"xiegang112","key":"xiegang112","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gang Xie","active":true,"timeZone":"Etc/UTC"},"body":"After carefully check the issue reported in HDFS-9279, and found this issue is not its dup.\r\n\r\nthis case is mainly about the param {color:#d04437}nodesInService{color}. When a datanode is decommissioned and then dead. nodesInService will not be subtracted.  \r\nThen when allocation, the dead node will be counted in the maxload, which makes the maxload very low, in turns, causes any allocation failing.\r\n\r\n    if (considerLoad) {\r\n{color:#d04437}      final double maxLoad = maxLoadRatio * stats.getInServiceXceiverAverage();{color}\r\n      final int nodeLoad = node.getXceiverCount();\r\n      if (nodeLoad > maxLoad) {\r\n        logNodeIsNotChosen(storage,\r\n            \"the node is too busy (load:\"+nodeLoad+\" > \"+maxLoad+\") \");\r\n        stats.incrOverLoaded();\r\n        return false;\r\n      }\r\n    }","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiegang112","name":"xiegang112","key":"xiegang112","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gang Xie","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-20T09:10:16.296+0000","updated":"2017-11-20T09:11:32.651+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118771/comment/16258975","id":"16258975","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiegang112","name":"xiegang112","key":"xiegang112","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gang Xie","active":true,"timeZone":"Etc/UTC"},"body":"And I believe this issue still in the latest version","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiegang112","name":"xiegang112","key":"xiegang112","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gang Xie","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-20T09:11:00.473+0000","updated":"2017-11-20T09:11:00.473+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13118771/comment/16258981","id":"16258981","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiegang112","name":"xiegang112","key":"xiegang112","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gang Xie","active":true,"timeZone":"Etc/UTC"},"body":"Why we don't substract nodesInService when we complete the decommission of the datanode and it becomes dead? And consideration here? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiegang112","name":"xiegang112","key":"xiegang112","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gang Xie","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-20T09:14:27.711+0000","updated":"2017-11-20T09:14:27.711+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-12820/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3mulr:"}}