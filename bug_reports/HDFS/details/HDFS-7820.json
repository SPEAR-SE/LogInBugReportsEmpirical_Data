{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12776780","self":"https://issues.apache.org/jira/rest/api/2/issue/12776780","key":"HDFS-7820","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-02-28T00:27:48.369+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue May 12 02:50:08 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-7820/watchers","watchCount":7,"isWatching":false},"created":"2015-02-23T08:26:33.189+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-05-12T02:50:08.549+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"Steps to Reproduce:\n===================\n\nStep 1:  Prepare rolling upgrade using \"hdfs dfsadmin -rollingUpgrade prepare\"\nStep 2:  Shutdown SNN and NN\nStep 3:  Start NN with the \"hdfs namenode -rollingUpgrade started\" option.\nStep 4:  Executed \"hdfs dfsadmin -shutdownDatanode <DATANODE_HOST:IPC_PORT> upgrade\" and restarted Datanode\nStep 5:  Write 3 files to hdfs ( block id assigned are : blk_1073741831_1007, blk_1073741832_1008,blk_1073741833_1009 )\nStep 6:  Shutdown both NN and DN\nStep 7:  Start NNs with the \"hdfs namenode -rollingUpgrade rollback\" option.\n         Start DNs with the \"-rollback\" option.\nStep 8:  Write 2 files to hdfs.\n\nIssue:\n=======\nClient write failed with below exception\n{noformat}\n2015-02-23 16:00:12,896 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: Receiving BP-1837556285-XXXXXXXXXXX-1423130389269:blk_1073741832_1008 src: /XXXXXXXXXXX:48545 dest: /XXXXXXXXXXX:50010\n2015-02-23 16:00:12,897 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: opWriteBlock BP-1837556285-XXXXXXXXXXX-1423130389269:blk_1073741832_1008 received exception org.apache.hadoop.hdfs.server.datanode.ReplicaAlreadyExistsException: Block BP-1837556285-XXXXXXXXXXX-1423130389269:blk_1073741832_1008 already exists in state FINALIZED and thus cannot be created.\n{noformat}\n\nObservations:\n=============\n\n1. At Namenode side block invalidate is been sent only to 2 blocks.\n{noformat}\n15/02/23 14:59:56 INFO BlockStateChange: BLOCK* InvalidateBlocks: add blk_1073741833_1009 to XXXXXXXXXXX:50010\n15/02/23 14:59:56 INFO BlockStateChange: BLOCK* InvalidateBlocks: add blk_1073741831_1007 to XXXXXXXXXXX:50010\n{noformat}\n\n2. fsck report does not show information on blk_1073741832_1008\n{noformat}\nFSCK started by Rex (auth:SIMPLE) from /XXXXXXXXXXX for path / at Mon Feb 23 16:17:57 CST 2015\n\n/File1:  Under replicated BP-1837556285-XXXXXXXXXXX-1423130389269:blk_1073741825_1001. Target Replicas is 3 but found 1 replica(s).\n\n/File11:  Under replicated BP-1837556285-XXXXXXXXXXX-1423130389269:blk_1073741827_1003. Target Replicas is 3 but found 1 replica(s).\n\n/File2:  Under replicated BP-1837556285-XXXXXXXXXXX-1423130389269:blk_1073741826_1002. Target Replicas is 3 but found 1 replica(s).\n\n/AfterRollback_2:  Under replicated BP-1837556285-XXXXXXXXXXX-1423130389269:blk_1073741831_1007. Target Replicas is 3 but found 1 replica(s).\n\n/Test1:  Under replicated BP-1837556285-XXXXXXXXXXX-1423130389269:blk_1073741828_1004. Target Replicas is 3 but found 1 replica(s).\nStatus: HEALTHY\n Total size:    31620 B\n Total dirs:    7\n Total files:   6\n Total symlinks:                0\n Total blocks (validated):      5 (avg. block size 6324 B)\n Minimally replicated blocks:   5 (100.0 %)\n Over-replicated blocks:        0 (0.0 %)\n Under-replicated blocks:       5 (100.0 %)\n Mis-replicated blocks:         0 (0.0 %)\n Default replication factor:    3\n Average block replication:     1.0\n Corrupt blocks:                0\n Missing replicas:              10 (66.666664 %)\n Number of data-nodes:          1\n Number of racks:               1\nFSCK ended at Mon Feb 23 16:17:57 CST 2015 in 3 milliseconds\n{noformat}\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12701343","id":"12701343","filename":"HDFS-7820.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-02-27T12:21:22.354+0000","size":1813,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12701343/HDFS-7820.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Client Write fails after rolling upgrade rollback with \"<block_id> already exist in finalized state\"","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776780/comment/14333098","id":"14333098","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"body":"Please have a look at this , Iam trying to analyse further on this issue and provide a patch for the same.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-02-23T08:31:19.599+0000","updated":"2015-02-23T08:31:19.599+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776780/comment/14340074","id":"14340074","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"body":"I have attached a patch where the block id value will be incremented by 10 million , if the RollingUpgradeStartupOption=ROLLBACK. \n\nThis would avoid client write failure immediately after rollback,  because of assigning same block id as blocks written before rollback , which are still in Finalized state (Which will be deleted after the second block report.)\n\nPlease review the patch and give your feedback. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-02-27T12:21:22.361+0000","updated":"2015-02-27T12:21:22.361+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776780/comment/14341087","id":"14341087","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"body":"Thank you for reporting this issue [~andreina]. This looks like an unfortunate interaction of rollback with sequential block IDs. Your fix will work for most deployments but I don't like adding a hard-coded 10M increment. Let me think about this some more.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-02-28T00:27:48.369+0000","updated":"2015-02-28T00:27:48.369+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776780/comment/14341099","id":"14341099","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"body":"One thing I did not understand - the finalized block does not belong to any file after rollback. Hence it should never be added to the BlockInfo list and should be marked for deletion on the DN immediately.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-02-28T00:34:24.657+0000","updated":"2015-02-28T00:34:24.657+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776780/comment/14342696","id":"14342696","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi Arpit Agarwal thanks for looking at this issue. \n\nbq.One thing I did not understand - the finalized block does not belong to any file after rollback. Hence it should never be added to the BlockInfo list and should be marked for deletion on the DN immediately.\n\nBlock would be marked for deletion only on the second block report ( which would take 6 hrs, as default value for dfs.blockreport.intervalMsec=6hrs). So within this time after rollback any client write operation will fail since block with the same id already exist at DN . \n\nTo avoid the duplicate block id being assigned after rollback , i gave an initial patch considering there could be 10 million blocks written in worst case after upgrade and before rollback, hence incremented the block id by 10 million after rollback.\n\nPlease correct me if I'am wrong.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-03-02T04:04:06.588+0000","updated":"2015-03-02T04:04:06.588+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776780/comment/14353844","id":"14353844","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~andreina],\n\nSorry about the delay in responding. I see what you are saying. The blocks are not deleted right away since {{processFirstBlockReport}} does not schedule deletions.\n\nRather than add a hard-coded increment we can reserve the msb of the blockid for an epoch. The epoch is toggled on every rollback. The low order 63 bits are incremented sequentially as before on block allocation. Now we will not hit any collisions with block ids allocated before the rollback.\n\nThe only drawback I can see is if a second rollback is attempted before all excess blocks from the previous rollback were deleted. We could increase the number of epoch bits to avoid collisions in that pathological case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-09T23:12:18.180+0000","updated":"2015-03-09T23:13:50.407+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776780/comment/14354572","id":"14354572","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinayrpet","name":"vinayrpet","key":"vinayrpet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinayakumar B","active":true,"timeZone":"Asia/Kolkata"},"body":"bq. Rather than add a hard-coded increment we can reserve the msb of the blockid for an epoch. The epoch is toggled on every rollback. The low order 63 bits are incremented sequentially as before on block allocation. Now we will not hit any collisions with block ids allocated before the rollback.\nThis Idea is good, but the problem I am seeing is same as you mentioned. Multiple Rollbacks.\n\nDuring the testing of a upgrade, there could be possibility of multiple rollbacks. With each rollback if toggle the msb, then block id range will be reduced by half since the actual no bits involved is reduced. And in any case we cannot re-toggle the bit.\n\nWhat if blocks are scheduled for deletion on the first report itself only in case of RollBack?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinayrpet","name":"vinayrpet","key":"vinayrpet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinayakumar B","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-03-10T08:58:23.800+0000","updated":"2015-03-10T08:58:23.800+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776780/comment/14357386","id":"14357386","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"body":"Increasing the epoch bits to 5 or 6 will permit successive rollbacks in a short time interval while avoiding collisions. This addresses all practical scenarios. 2^58 blocks is orders of magnitude more than you would hit in a real cluster so I am not concerned about ID space reduction.\n\nbq. What if blocks are scheduled for deletion on the first report itself only in case of RollBack?\nThis behavior was added before my time but I think deferring deletions speeds up cluster startup e.g. after upgrades. DN startup time is already an issue in large clusters.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-11T18:50:43.889+0000","updated":"2015-03-11T18:53:35.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776780/comment/14358144","id":"14358144","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinayrpet","name":"vinayrpet","key":"vinayrpet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinayakumar B","active":true,"timeZone":"Asia/Kolkata"},"body":"bq. Increasing the epoch bits to 5 or 6 will permit successive rollbacks in a short time interval while avoiding collisions. \nI agree for one version upgrade and rollback. \nBut my point is, whatever bits changed will remain forever for the entire lifetime of the cluster. We cannot change it back, otherwise blockIds will be having the lesser value than previous. For 6 bits this gives 2^6 rollbacks at max.\nAnother issue is, we cannot persist this, since at this time NN will be at that startup phase. So in this case, if Namenode restarts again without writing any single block, then problem can occur again.\n\nAm I missing something?\n\nbq. This behavior was added before my time but I think deferring deletions speeds up cluster startup e.g. after upgrades. DN startup time is already an issue in large clusters.\nI agree for the upgrade. But for the rollback, entire cluster has to be restarted anyway.\n\nAnother option is to write new blocks after to some new directory inside volume itself after rolling upgrade starts, similar to trash, ex: upgrade . And on finalize of upgrade move to finalized directory. And on Rollback just delete them.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinayrpet","name":"vinayrpet","key":"vinayrpet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinayakumar B","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-03-12T06:06:50.653+0000","updated":"2015-03-12T06:06:50.653+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776780/comment/14539133","id":"14539133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"body":"Any updates on this issue ? .","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andreina","name":"andreina","key":"andreina","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"J.Andreina","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-05-12T02:50:08.549+0000","updated":"2015-05-12T02:50:08.549+0000"}],"maxResults":10,"total":10,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-7820/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i25wxb:"}}