{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12778994","self":"https://issues.apache.org/jira/rest/api/2/issue/12778994","key":"HDFS-7873","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-03-11T19:55:14.825+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Mar 12 12:31:00 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-7873/watchers","watchCount":2,"isWatching":false},"created":"2015-03-03T09:38:05.794+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12327181","id":"12327181","description":"2.6.0 release","name":"2.6.0","archived":false,"released":true,"releaseDate":"2014-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12328970","id":"12328970","description":"2.5.2 release","name":"2.5.2","archived":false,"released":true,"releaseDate":"2014-11-19"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-03-12T12:31:39.530+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312944","id":"12312944","name":"tools"}],"timeoriginalestimate":null,"description":"The new Offline Image Viewer (OIV) supports to load the FSImage and _emulate_ a webhdfs server to explore the image without touching the NN.\n\nThis webhdfs server is not working with folders holding a significant number of children (files or other folders):\n\n{quote}\n$  hadoop fs -ls webhdfs://127.0.0.1:5978/a/big/folder\n15/03/03 04:28:19 WARN ssl.FileBasedKeyStoresFactory: The property 'ssl.client.truststore.location' has not been set, no TrustStore will be loaded\n15/03/03 04:28:21 WARN security.UserGroupInformation: PriviledgedActionException as:bperroud (auth:SIMPLE) cause:java.io.IOException: Response decoding failure: java.lang.IllegalStateException: Expected one of '\"}'\nls: Response decoding failure: java.lang.IllegalStateException: Expected one of '\"}'\n{quote}\n\nThe error comes from an inappropriate usage of Netty. {{e.getFuture().addListener(ChannelFutureListener.CLOSE)}} is closing the channel too early because the future attached to the channel already sent the header so the I/O operation succeeded.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12702128","id":"12702128","filename":"HDFS-7873-v1.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"created":"2015-03-03T09:47:10.896+0000","size":7334,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12702128/HDFS-7873-v1.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12702129","id":"12702129","filename":"HDFS-7873-v2.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"created":"2015-03-03T09:51:58.725+0000","size":8176,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12702129/HDFS-7873-v2.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12704149","id":"12704149","filename":"HDFS-7873-v3.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"created":"2015-03-12T12:31:39.525+0000","size":9329,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12704149/HDFS-7873-v3.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"OIV webhdfs premature close channel issue","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12778994/comment/14344840","id":"14344840","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"body":"This patch contains a test case which reproduce the issue with the following steps:\n# Launch a MiniDFSCluster\n# Create a folder\n# Create 10000 files inside\n# Turn on safe mode, save metaspace\n# Retrieve the latest FSImage and launch into OIV::webhdfs\n# try a hdfs dfs -ls webhdfs://... on that folder\n# Assert everything goes well and the output is as expected.\n\nThis patch also fix properly the issue, ensuring the channel is closed *after* all the content has been streamed out of the webhdfs instance.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"created":"2015-03-03T09:47:10.905+0000","updated":"2015-03-03T09:47:10.905+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12778994/comment/14344843","id":"14344843","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"body":"With the ASF headers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"created":"2015-03-03T09:51:58.732+0000","updated":"2015-03-03T09:51:58.732+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12778994/comment/14357471","id":"14357471","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wheat9","name":"wheat9","key":"wheat9","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Haohui Mai","active":true,"timeZone":"America/Los_Angeles"},"body":"Can you please format the code with the compliance of the Hadoop coding style:\n\nhttp://wiki.apache.org/hadoop/CodeReviewChecklist\n\nI also don't understand why the unit test can effectively cover this issue. Can you explain?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wheat9","name":"wheat9","key":"wheat9","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Haohui Mai","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-11T19:55:14.825+0000","updated":"2015-03-11T19:55:14.825+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12778994/comment/14358592","id":"14358592","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"body":"When a folder contains a lot of files, the output sent back to the client is split in several packets. As {{channel.write}} call is async, it returns directly and is thus not waiting for all the data being sent, which might take some time.\nNow the problem is that {{MessageEvent.getFuture()}} will return a future which is already completed because the header has been sent properly before the data (there're two calls to {{channel.write}}, one for the header, one for the content), so {{ChannelFutureListener.CLOSE}} will be called immediately, potentially before all the packets are sent across the channel. This premature close of the channel leaves the client in a incomplete response.\n\nThe test launches a MiniDFSCluster and create 10000 files in a folder because with this number, I was able to repeatably reproduce the issue. The FSImage is then generated and loaded in OIV. Finally the content of the \"big\" folder is listed, and output asserted. Without the patch, the exception initially reported appears here\n\nI hope this will help.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bperroud","name":"bperroud","key":"bperroud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=bperroud&avatarId=12753","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=bperroud&avatarId=12753","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=bperroud&avatarId=12753","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=bperroud&avatarId=12753"},"displayName":"Benoit Perroud","active":true,"timeZone":"Europe/Berlin"},"created":"2015-03-12T12:31:00.899+0000","updated":"2015-03-12T12:31:00.899+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-7873/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i26a3r:"}}