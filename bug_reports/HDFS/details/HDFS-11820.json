{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13071759","self":"https://issues.apache.org/jira/rest/api/2/issue/13071759","key":"HDFS-11820","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":"2017-05-15T17:37:58.754+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon May 15 23:34:57 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_186275046_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-05-15T17:38:13.412+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-11820/watchers","watchCount":3,"isWatching":false},"created":"2017-05-13T13:53:38.394+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-05-15T23:34:57.921+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12329603","id":"12329603","name":"hdfs"}],"timeoriginalestimate":null,"description":"Hi there,\n\nI am new to Hadoop and trying to understand how things work under the hood by browsing through some of the codes.\n\nI noticed a potential thread safety issue in in FSEditLog.java in version 2.7.1 where the following patterns is used (the current trunk also use the same pattern):\n1. Instance of FSEditLogOp is retrieved from cache for reuse \n2. Set the attributes (e.g. path, timestamp, etc)\n3. Invoke logEdit(*op*). This method has synchronized block in it, but also has *wait* if auto-sync is scheduled\n\nNow, if I have two almost simultaneous rename operations, right after each is about to write edit log:\nThread #1 acquired instance of RenameOp, set the attributes, and invoked logEdit, then it waits because auto-sync is scheduled.\nThread #2 catches up, and acquires same instance of RenameOp, sets *different* attributes, and invokes logEdit.. It blocks because of synchronized block inside logEdit(...), but it manages to modify the attributes of RenameOp.\n\nThe second renameOp could end up being logged twice because both renameOps are actually the same instance. \nThe fix is to have synchronized(*op*) prior to calling logEdit(*op*) or clone the op before using it.\n\nI could be wrong. Am I missing something?\n\nThanks,\n\nAlexander Koentjara","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Thread safety in logEdit?","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tummybunny","name":"tummybunny","key":"tummybunny","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tummy Bunny","active":true,"timeZone":"Asia/Singapore"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tummybunny","name":"tummybunny","key":"tummybunny","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tummy Bunny","active":true,"timeZone":"Asia/Singapore"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13071759/comment/16010962","id":"16010962","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"Jira is for bug report. Please use relevant mailing list for discussions and questions.\n\nEdit logging is almost thread safe, but not entirely. Concurrency is controlled by the rule that edit logging should happen with the name system write lock held and logSync() after releasing the lock. A successful response only goes back to the user after successful logSync().","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2017-05-15T17:37:58.754+0000","updated":"2017-05-15T17:37:58.754+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13071759/comment/16011379","id":"16011379","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tummybunny","name":"tummybunny","key":"tummybunny","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tummy Bunny","active":true,"timeZone":"Asia/Singapore"},"body":"I understand that write lock guard concurrency against concurrent write to I/O. But what to be written also needs to be correct. How useful to return successful response if it failed to write things accurately, I would rather it did not succeed so client can retry. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tummybunny","name":"tummybunny","key":"tummybunny","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tummy Bunny","active":true,"timeZone":"Asia/Singapore"},"created":"2017-05-15T21:41:23.302+0000","updated":"2017-05-15T21:41:23.302+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13071759/comment/16011457","id":"16011457","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"Write lock ensures there is only one thread calling logEdit() at any time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2017-05-15T22:48:17.770+0000","updated":"2017-05-15T22:48:17.770+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13071759/comment/16011461","id":"16011461","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tummybunny","name":"tummybunny","key":"tummybunny","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tummy Bunny","active":true,"timeZone":"Asia/Singapore"},"body":"I beg you to read the code before commenting. The whole logic to get EditLog \"singleton\" instance from cache and modify its attributes is outside synchornized block and outside writeLock.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tummybunny","name":"tummybunny","key":"tummybunny","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tummy Bunny","active":true,"timeZone":"Asia/Singapore"},"created":"2017-05-15T22:53:04.145+0000","updated":"2017-05-15T22:53:04.145+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13071759/comment/16011498","id":"16011498","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"bq. Thread #2 catches up, and acquires same instance of RenameOp, sets different attributes\nIt does not happen, because logEdit() is only called with FSNamesystem writeLock held. Even when the thread is in wait(), no other thread can call logEdit(). \n\nbq. I beg you to read the code before commenting. The whole logic to get EditLog \"singleton\" instance from cache and modify its attributes is outside synchornized block and outside writeLock.\n\nBesides, the cache is thread local.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2017-05-15T23:27:15.423+0000","updated":"2017-05-15T23:27:15.423+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13071759/comment/16011507","id":"16011507","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tummybunny","name":"tummybunny","key":"tummybunny","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tummy Bunny","active":true,"timeZone":"Asia/Singapore"},"body":"Yes you are right, I missed those two facts. Thanks for clarification!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tummybunny","name":"tummybunny","key":"tummybunny","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tummy Bunny","active":true,"timeZone":"Asia/Singapore"},"created":"2017-05-15T23:34:57.921+0000","updated":"2017-05-15T23:34:57.921+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-11820/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3exqv:"}}