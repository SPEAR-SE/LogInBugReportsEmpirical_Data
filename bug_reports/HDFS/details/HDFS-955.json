{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12455702","self":"https://issues.apache.org/jira/rest/api/2/issue/12455702","key":"HDFS-955","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314814","id":"12314814","description":"","name":"0.20.3","archived":true,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-02-10T03:46:38.559+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Apr 06 19:22:40 UTC 2010","customfield_12310420":"16680","customfield_12312320":null,"customfield_12310222":"10002_*:*_4_*:*_1007767348_*|*_1_*:*_4_*:*_3897390535_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-04-06T18:34:29.825+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-955/watchers","watchCount":12,"isWatching":false},"created":"2010-02-09T00:01:51.942+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"13.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314048","id":"12314048","description":"","name":"0.20.1","archived":false,"released":true,"releaseDate":"2009-09-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314046","id":"12314046","description":"","name":"0.21.0","archived":false,"released":true,"releaseDate":"2010-08-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314241","id":"12314241","description":"","name":"0.22.0","archived":false,"released":true,"releaseDate":"2011-12-10"}],"issuelinks":[{"id":"12330362","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330362","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12358477","key":"HDFS-87","self":"https://issues.apache.org/jira/rest/api/2/issue/12358477","fields":{"summary":"NameNode startup fails if edit log terminates prematurely","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12330339","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330339","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12456712","key":"HDFS-988","self":"https://issues.apache.org/jira/rest/api/2/issue/12456712","fields":{"summary":"saveNamespace race can corrupt the edits log","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12330225","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330225","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12456084","key":"HDFS-970","self":"https://issues.apache.org/jira/rest/api/2/issue/12456084","fields":{"summary":"FSImage writing should always fsync before close","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12330159","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330159","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12455722","key":"HDFS-957","self":"https://issues.apache.org/jira/rest/api/2/issue/12455722","fields":{"summary":"FSImage layout version should be only once file is complete","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12331175","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12331175","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12460987","key":"HDFS-1073","self":"https://issues.apache.org/jira/rest/api/2/issue/12460987","fields":{"summary":"Simpler model for Namenode's fs Image and edit Logs ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12330155","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330155","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12446120","key":"HDFS-909","self":"https://issues.apache.org/jira/rest/api/2/issue/12446120","fields":{"summary":"Race condition between rollEditLog or rollFSImage ant FSEditsLog.write operations  corrupts edits log","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-04-06T21:21:12.196+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312926","id":"12312926","name":"namenode"}],"timeoriginalestimate":null,"description":"This is a continuation of a discussion from HDFS-909. The FSImage.saveFSImage function (implementing dfsadmin -saveNamespace) can corrupt the NN storage such that all current edits are lost.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12439848","id":"12439848","filename":"FSStateTransition7.htm","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-26T02:28:36.346+0000","size":122078,"mimeType":"text/html","content":"https://issues.apache.org/jira/secure/attachment/12439848/FSStateTransition7.htm"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12435634","id":"12435634","filename":"hdfs-955-moretests.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-12T00:36:18.580+0000","size":16785,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12435634/hdfs-955-moretests.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12435401","id":"12435401","filename":"hdfs-955-unittest.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-10T03:03:03.704+0000","size":4931,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12435401/hdfs-955-unittest.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12435407","id":"12435407","filename":"PurgeEditsBeforeImageSave.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-10T03:48:08.115+0000","size":3386,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12435407/PurgeEditsBeforeImageSave.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12440629","id":"12440629","filename":"saveNamespace.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-02T17:40:19.850+0000","size":41988,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12440629/saveNamespace.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12440567","id":"12440567","filename":"saveNamespace.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-02T02:22:58.221+0000","size":41985,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12440567/saveNamespace.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12440371","id":"12440371","filename":"saveNamespace.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-31T18:07:09.971+0000","size":38836,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12440371/saveNamespace.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12440109","id":"12440109","filename":"saveNamespace.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-29T21:08:45.627+0000","size":34654,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12440109/saveNamespace.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12439850","id":"12439850","filename":"saveNamespace.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-26T02:34:50.973+0000","size":34043,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12439850/saveNamespace.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12440925","id":"12440925","filename":"saveNamespace-0.20.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-06T17:34:43.747+0000","size":38134,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12440925/saveNamespace-0.20.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12440171","id":"12440171","filename":"saveNamespace-0.20.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-30T02:43:24.284+0000","size":30335,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12440171/saveNamespace-0.20.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12440924","id":"12440924","filename":"saveNamespace-0.21.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-06T17:34:43.710+0000","size":42242,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12440924/saveNamespace-0.21.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12440110","id":"12440110","filename":"saveNamespace-0.21.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-29T21:08:45.650+0000","size":34905,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12440110/saveNamespace-0.21.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"13944","customfield_12312823":null,"summary":"FSImage.saveFSImage can lose edits","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831201","id":"12831201","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Reproducing the comment from HDFS-909:\n\nFSImage.saveFSImage has this code:\n{noformat}\n1240       if (dirType.isOfType(NameNodeDirType.IMAGE))\n1241         saveFSImage(getImageFile(sd, NameNodeFile.IMAGE_NEW));\n1242       if (dirType.isOfType(NameNodeDirType.EDITS)) {\n1243         editLog.createEditLogFile(getImageFile(sd, NameNodeFile.EDITS));\n1244         File editsNew = getImageFile(sd, NameNodeFile.EDITS_NEW);\n1245         if (editsNew.exists())\n1246           editLog.createEditLogFile(editsNew);\n1247       }\n{noformat}\n\nOn line 1243 we truncate EDITS. Then if EDITS_NEW exists, we truncate it on 1246. All of this happens when the NN is in safe mode, so there shouldn't be any new edits coming in in the first place.\n\nI'm contending that line 1243 and 1245 should both be deleted. We should always create the image as IMAGE_NEW (line 1241). Touching EDITS seems incorrect - what if the order of storage dirs is EDITS then IMAGE, so we run line 1243, kill our current edit log, and then crash before saving the current image?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-09T00:03:58.272+0000","updated":"2010-02-09T00:03:58.272+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831211","id":"12831211","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Konstantin: by any chance, do you have a document that describes the NN's startup protocol with regards to image loading? To make sure we've got the failure scenarios correct we need to match up the recovery protocol to all of the failure points I think (eg what happens with a half-written IMAGE_NEW, what happens if some dirs have _NEW and others don't, etc).\n\nIf no such document exists I'll go through the code to work on creating it, or at least a thorough JIRA comment we can reference from the code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-09T00:19:09.832+0000","updated":"2010-02-09T00:19:09.832+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831258","id":"12831258","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"\n\nloadFSImage:\n  - find a pair of EDITS and IMAGE that have the same checkpoint time and are from the latest checkpointTime\n    (this ignores *_NEW)\n  - recoverInterruptedCheckpoint:\n    if there is an IMAGE_NEW:\n      if there is EDITS_NEW:\n        delete IMAGE_NEW (since we assume we can replay from IMAGE + EDITS + EDITS_NEW?\n      else:\n        replace IMAGE with IMAGE_NEW, delete IMAGE_NEW\nI took some pseudocode notes on what's currently going on in the load/save code:\n\n{noformat}\n  - load IMAGE\n  - load EDITS\n  - load EDITS_NEW\n\n  - if need to save:\n    saveFSImage:\n      save IMAGE_NEW\n      truncate EDITS\n      if EDITS_NEW exists:\n        truncate EDITS_NEW\n      rollFSImage:\n        purgeEditLog:\n          replace EDITS with EDITS_NEW\n        renameCheckpoint:\n          replace IMAGE with IMAGE_NEW\n{noformat}\n\nNext I'll look at a failure at each point and see if recovery works. Longer term we should also figure out how to get either use the FI test framework or some clever mockito spies to inject these failures for unit tests.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-09T02:12:09.851+0000","updated":"2010-02-09T02:12:09.851+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831259","id":"12831259","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Woops, somehow managed to mangle my edit buffer there... repasting, sorry for the spam.\n\n{noformat}\nloadFSImage:\n  - find a pair of EDITS and IMAGE that have the same checkpoint time and are from the latest checkpointTime\n    (this ignores *_NEW)\n  - recoverInterruptedCheckpoint:\n    if there is an IMAGE_NEW:\n      if there is EDITS_NEW:\n        delete IMAGE_NEW (since we assume we can replay from IMAGE + EDITS + EDITS_NEW?\n      else:\n        replace IMAGE with IMAGE_NEW, delete IMAGE_NEW\n  - load IMAGE\n  - load EDITS\n  - load EDITS_NEW\n  - if need to save:\n    saveFSImage:\n      save IMAGE_NEW\n      truncate EDITS\n      if EDITS_NEW exists:\n        truncate EDITS_NEW\n      rollFSImage:\n        purgeEditLog:\n          replace EDITS with EDITS_NEW\n        renameCheckpoint:\n          replace IMAGE with IMAGE_NEW\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-09T02:14:17.520+0000","updated":"2010-02-09T02:14:17.520+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831300","id":"12831300","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"I've verified the behavior from HDFS-909 on 0.20 (though I'm pretty certain it also exists on trunk).\n\nTo reproduce, I did a little manual \"fault injection\" - I added {code}if (new File(\"/tmp/savefsimage.die\").exists()) System.exit(1);{code} after saving IMAGE_NEW in saveFSImage. I then did the following sequence:\n\n- start NN\n- hadoop fs -mkdir test1\n- hadoop dfsadmin -safemode enter\n- touch /tmp/savefsimage.die\n- hadoop dfsadmin -saveNamespace\n- (NN \"crashes\")\n\nThis leaves dfs.name.dir/current as:\n{noformat}\n-rw-r--r-- 1 todd todd   4 2010-02-08 21:24 edits\n-rw-r--r-- 1 todd todd   4 2010-02-08 21:24 edits.new\n-rw-r--r-- 1 todd todd  94 2010-02-08 21:24 fsimage\n-rw-r--r-- 1 todd todd 323 2010-02-08 21:24 fsimage.ckpt\n-rw-r--r-- 1 todd todd   8 2010-02-08 21:24 fstime\n-rw-r--r-- 1 todd todd 100 2010-02-08 21:24 VERSION\n{noformat}\n\n(fsimage.ckpt has the proper image including my directory)\n\nIf I now remove the fault injection file and start the NN, it \"recovers\" to:\n{noformat}\n-rw-r--r-- 1 todd todd   4 2010-02-08 21:25 edits\n-rw-r--r-- 1 todd todd  94 2010-02-08 21:25 fsimage\n-rw-r--r-- 1 todd todd   8 2010-02-08 21:25 fstime\n-rw-r--r-- 1 todd todd 100 2010-02-08 21:25 VERSION\n{noformat}\n(ie all edits since last successful checkpoint were lost)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-09T05:27:28.032+0000","updated":"2010-02-09T05:27:28.032+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831806","id":"12831806","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"This issue also occurs if there are multiple name/edit dirs and an exception is thrown while saving any fsimage other than the first.\n\nTo reproduce, I added:\n{code}\n    if (savedCount++ > 0 && new File(\"/tmp/inject\").exists()) {\n      throw new IOException(\"Injected fault\");\n    } else {\n      LOG.warn(\"Not injecting\", new IOException());\n    }\n{code}\n\nalong with a static int savedCount = 0 in FSImage.\n\nI started a NN, created some directories, shut it down. I then created /tmp/inject, and started the NN again. It failed while saving the second image, as planned. This left the edit dir in such a state that starting the NN up again recovered from the first name dir where the edits had been blown away.\n\nThis should be unit testable with mockito. I'll try to form such a test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-10T01:41:21.057+0000","updated":"2010-02-10T01:41:21.057+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831813","id":"12831813","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Adding 0.20.1 as an Affects Version since I can reproduce this there.. I think as a dataloss bug this should be eventually backported once we have a fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-10T01:57:19.841+0000","updated":"2010-02-10T01:57:19.841+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831833","id":"12831833","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here is a test that shows the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-10T03:03:03.717+0000","updated":"2010-02-10T03:03:03.717+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831844","id":"12831844","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"It is good to have the test. I ran it on current trunk. It successfully gets the expected exception, but then fails to close FSNamesystem with NPE. So yes it fails but not where you wanted it to.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-10T03:46:38.559+0000","updated":"2010-02-10T03:46:38.559+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831845","id":"12831845","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"I checked weather the test passes if we change the order of writing in dorectories. It does, although it still throws NPE on close. I am attaching the changes I maid to FSImage while running your test, in case it will save your time fixing this. If not please feel free to disregard it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-10T03:48:08.180+0000","updated":"2010-02-10T03:48:08.180+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12831854","id":"12831854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"HADOOP-6554 is the NPE on close. Sorry, I should have mentioned you need to fix that by adding the appropriate if (thread != null) check. After fixing that, the test fails on the reopen. Also, the test doesn't fail if you switch to only one dfs.name.dir.\n\nI'll take a look at your patch, thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-10T04:30:19.956+0000","updated":"2010-02-10T04:30:19.956+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12832212","id":"12832212","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"h2. Without concurrent checkpoint\n\nLooking at this as a series of state transitions on the storage directory:\n\n{noformat}\nState 1: normal operation\n  Valid: IMAGE + EDITS\n  (there is nothing special happening)\n\nState 2: createNewIfNotExists\n  Valid a: IMAGE + EDITS\n  Valid b: IMAGE + EDITS + EDITS_NEW (since EDITS_NEW is empty)\n  Current recovery: b\n\nState 3: saving IMAGE_NEW,\n  Same validity as State 2\n  Current recovery: b\n\nState 4: save IMAGE_NEW complete\n  Valid a: IMAGE + EDITS\n  Valid b: IMAGE + EDITS + EDITS_NEW (since EDITS_NEW is empty)\n  Valid c: IMAGE_NEW + EDITS_NEW (since EDITS_NEW is empty)\n  Current recovery: b\n\nState 5: truncate EDITS and EDITS_NEW\n  (a) and (b) are no longer valid\n  Valid c: IMAGE_NEW + EDITS_NEW\n  Current recovery: *b (this is the error we're seeing)\n\nState 6: rollFSImage -> purgeEditLog: moves EDITS_NEW to EDITS\n  Valid: IMAGE_NEW + EDITS\n  Current recovery: rename IMAGE_NEW to IMAGE (correct)\n\nState 7: rollFSImage -> renameCheckpoint: moves IMAGE_NEW to IMAGE\n  Valid: IMAGE + EDITS\n  Current recovery: no recovery necessary (correct)\n{noformat}\n\nThe problem here is in State 5. The question is how to detect that\nwe are in this state during recovery so we can do the right thing.\nThis is where HDFS-957 comes in. With 957, the recovery logic can easily\ndetermine that IMAGE_NEW is correct, and choose the same recovery\nmechanism as state 6.\n\nh2. With ongoing checkpoint (logs start rolled)\n\n{noformat}\nState 1: normal operation\n  Valid: IMAGE + EDITS + EDITS_NEW\n  Recovery: IMAGE + EDITS + EDITS_NEW\n\nState 2: createNewIfNotExists\n  no effect - NEW already exists\n\nState 3: saving IMAGE_NEW,\n  Same validity as State 2\n  Current recovery: IMAGE + EDITS + EDITS_NEW\n\nState 4: save IMAGE_NEW complete\n  Valid a: IMAGE + EDITS + EDITS_NEW\n  Valid b: IMAGE_NEW only\n  Current recovery: a\n\nState 5: truncate EDITS and EDITS_NEW\n  Valid: IMAGE_NEW (any other recovery is incorrect)\n  Current recovery: IMAGE + EDITS + EDITS_NEW (incorrect, loses data)\n\nState 6: rollFSImage -> purgeEditLog: moves EDITS_NEW to EDITS\n  Valid: IMAGE_NEW + EDITS\n  Current recovery: rename IMAGE_NEW to IMAGE (correct)\n\nState 7: rollFSImage -> renameCheckpoint: moves IMAGE_NEW to IMAGE\n  Valid: IMAGE + EDITS\n  Current recovery: no recovery necessary (correct)\n{noformat}\n\n\nSo the issue in both cases is essentially the same, and both can be solved\nif we use HDFS-957.\n\nI'll work on a patch for this.\n\nOn a side note, I think there's another race where a checkpoint upload from the SNN can\noverlap with this operation and really screw things up. That's a separate JIRA though.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-10T21:30:45.772+0000","updated":"2010-02-10T21:30:45.772+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12832220","id":"12832220","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Unfortunately HDFS-957 I think provides a fix for both of the examples above where the correct recovery in state 5 is IMAGE_NEW. However, in the case where we've just received an actual checkpoint but haven't rolled yet, the correct recovery is IMAGE_NEW + EDITS_NEW. I don't have a good way of distinguishing that situation from the manual saveNamespace where we don't want to recover EDITS_NEW.\n\nI don't know that we can actually fix this with the current set of files and determinable state. I'll continue to think.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-10T21:48:21.533+0000","updated":"2010-02-10T21:48:21.533+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12832706","id":"12832706","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"I worked through this a bit last night. Here are some options for a solution.\n\nh3. 1. Add \"undo log\" file to storage directory\n\nIn this solution, we add a new file called \"undolog\" in each storage directory. Whenever we're in the midst of a transition, we write some bit of data in this file that explains what the proper rollback procedure is. Thus, for the checkpoint from the checkpoint node, we'd write a file that says \"if IMAGE_NEW is complete, use IMAGE_NEW + EDITS_NEW. Otherwise use IMAGE + EDITS + EDITS_NEW\". For the saveNamespace operation, we'd write \"If IMAGE_NEW is complete, use IMAGE_NEW. Otherwise use IMAGE + EDITS + EDITS_NEW\".\n\nThis has the advantage of making the recovery choices explicit during all state transitions - we're forced to think carefully after each step of the operation in order to maintain the undo instructions.\n\nOn the downside, it's more complexity.\n\nh3. 2. Don't allow -saveNamespace when the logs are in ROLLED state\n\nI don't like this one at all, but it would allow us to always use the IMAGE_NEW + EDITS_NEW recovery.\n\nh3. 3. Redesign rolling to not reuse filenames\n\nThis is a much bigger change, but I think it would also help simplify a lot of the code. The proposal here is to manage edit logs in a way that's similar to what MySQL does. Specifically, instead of IMAGE and IMAGE_NEW plus EDITS and EDITS_NEW, we simply have a monotonically increasing identifier on each log file. So, the state of the system starts with image_0 and edits_0. Logs may be rolled at any point, which increments edits_N. So in a normal operation we'd see:\n\nimage_0\nedits_0 <- writing here\n\n[roll edits]\nimage_0\nedits_0\nedits_1 <- writing here\n\n[checkpoint node fetches image_0 and edits_0, and uploads images_1]\n\nimage_0 <- this is now \"stale\" and can be garbage collected later\nimage_1 <- this contains image_0 + edits_0\nedits_0 <- this is also stale\nedits_1 <- still being written\n\nThis design has many plusses in my view:\n# Files never change names, and thus race conditions like HDFS-909 are less likely, so long as the current number is synchronized.\n# Recovery is much simpler - you can always recover from image_n + edits_n through edits_max, so long as image_n is complete. Any incomplete or corrupt images can always be safely ignored so long as there is an earlier one, plus all the edit logs going back to that point.\n# the fstime checking logic is simplified - an image made from image_N plus edits_N through edits_(M-1) is always going to be called image_M. Any image_M from any storage directory should be identical regardless of any ongoing rolls.\n# edit logs and images can both be kept for some time window, simpifying backup and recovery a bit while also providing an easy mechanism for point-in-time recovery of the namespace. Although PITR is less than useful if data blocks are gone, this mechanism would make it impossible for a bug like HDFS-909 or HDFS-955 to lose edits, since files are never truncated or removed until after they're \"stale\".\n# We no longer have to be careful about the NN's \"rolled\" vs \"upload_done\" vs \"start\" state - the logs are looked at as constantly rolling, and it's always clear where to apply a checkpoint image.\n\nThe downside, of course, is that it's a very big change, definitely not a candidate for backport, and could take a while.\n\nh3. 4. Distinguish IMAGE_NEW_CKPT vs IMAGE_NEW_SAVED\n\nRather than having a single IMAGE_NEW filename like we do now, we could split it into IMAGE_NEW_CKPT and IMAGE_NEW_SAVED. The recovery mechanism for these would differ in that, if there is a completed IMAGE_NEW_CKPT, then it will recover IMAGE_NEW_CKPT + EDITS_NEW. If there is a completed IMAGE_NEW_SAVED, then it can truncate both EDITS and EDITS_NEW during recovery, since a saved namespace encompasses both.\n\n\nUnfortunately, not one of these is a simple fix. If you have any proposals that are both simple and correct, I'd be very interested to hear them.\n\nOne thing I'd also like to consider more is the interaction of these processes with filesystem journaling. I'm not sure if ext3's data=ordered\njournaling mode (probably the most common deployment configuration) guarantees quite enough ordering between different files that all of the above will work correctly in the event of host failures. I need to learn more about that and report back.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-11T22:31:36.976+0000","updated":"2010-02-11T22:31:36.976+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12832730","id":"12832730","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. One thing I'd also like to consider more is the interaction of these processes with filesystem journaling\n\nI read up a bit on journaling implementations in ext3, ext4, and xfs. It looks like the current \"write file, close, then rename to replace\" method is considered an antipattern by the kernel folks, since with delayed allocation it's possible that on a crash the new file will end up with length 0 (or zeroed blocks in XFS). We definitely need an fsync after writing the new fsimage. Will open a separate JIRA for this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-11T23:29:08.282+0000","updated":"2010-02-11T23:29:08.282+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12832755","id":"12832755","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Todd, I did not get a clear idea whether what you are trying to explain belongs to HDFS-957 or HDFS-909 or yet a new jira. But it does not seem to belong here. I thought this issue was about fixing a rather simple bug of correcting the order in which directories are scanned when we save fsimage and purge edits. I don't think the issue should be converted into a project at this point, because the problem stated here has a simple solution, and because it is important to fix it. Could you please indicate whether you still have intention to fix it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-12T00:25:15.769+0000","updated":"2010-02-12T00:25:15.769+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12832757","id":"12832757","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. because the problem stated here has a simple solution, and because it is important to fix it\n\nI'm still waiting for that simple solution. I don't believe it does have one.\n\nYour solution of reordering the loops shrinks the time window of the problem occurring, but it still occurs. Note that the \"state 5\" problem in my comment above occurs regardless of the number of storage directories.\n\nI'll upload a patch momentarily which includes another unit test that shows the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-12T00:30:24.105+0000","updated":"2010-02-12T00:30:24.105+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12832759","id":"12832759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here's a patch which includes your patch from before, plus two new unit tests. Your patch fixes the original test, but not the two new ones.\n\nI think, unless we implement one of the proposals from my comment above, that there is no way to rearrange the current code that does this safely. I'd love to be proven wrong here - I really hope there is a simple fix as you suggest.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-12T00:36:18.640+0000","updated":"2010-02-12T00:36:18.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12832760","id":"12832760","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"I'll take a look at your patch, thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-12T00:39:59.163+0000","updated":"2010-02-12T00:39:59.163+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12835950","id":"12835950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Very good test cases.\nI don't understand why you mixed in this patch the code from HDFS-957. It does not help the test cases, right?\n# testCrashWhileSavingSecondImage() passes with my fix.\n# testCrashBeforeRollingFSImage() does not pass. The reason is that we\n#- we save image into IMAGE_NEW\n#- then empty EDITS and EDITS_NEW\n#- then crash\nThe criteria that IMAGE_NEW was written completely and successfully is the existence of EDITS_NEW. So if we try to restart NN at this point, IMAGE_NEW will be discarded (since EDITS_NEW is present) and we end up with the old IMAGE.\n# testSaveWhileEditsRolled(). I don't know what you were trying to achieve with this. I don't see the expected exception thrown. But it fails, and the reason here is that after saveNamespace() we get a corrupted edits. It has the version bytes, but does not have the end-mark byte (OP_INVALID) in the end. I think it was not closed properly.\n\nWill try to fix this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-19T21:00:04.215+0000","updated":"2010-02-19T21:00:04.215+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12835992","id":"12835992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. I don't understand why you mixed in this patch the code from HDFS-957. It does not help the test cases, right?\n\nI was just working on the two in the same tree - with a bit of modification to recoverInterruptedCheckpoint I think the second test can be fixed using the functionality from HDFS-957. I can demonstrate this with a patch if you would like.\n\nbq. The criteria that IMAGE_NEW was written completely and successfully is the existence of EDITS_NEW\n\nI think you misspoke here - EDITS_NEW exists _before_ IMAGE_NEW is saved. In my opinion the cleanest way of knowing that IMAGE_NEW is complete is the HDFS-957 patch. You may be able to know that info from the state of some other files, but why not be explicit about it to avoid some classes of errors?\n\nbq. I don't know what you were trying to achieve with this. I don't see the expected exception thrown. \n\nAh, sloppy copy paste there on my part. I don't expect an exception to actually be caught there. The failed restart with corrupted edits is indeed the failure I expected to provoke with that test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-19T22:07:23.809+0000","updated":"2010-02-19T22:07:23.809+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12836067","id":"12836067","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":">> The criteria that IMAGE_NEW was written completely and successfully is the existence of EDITS_NEW\n> I think you misspoke here - EDITS_NEW exists before IMAGE_NEW is saved. \n\nThis is what I meant. During start up the NN decides on whether to discard or to keep IMAGE_NEW (and rename it to IMAGE) based on the existence of EDITS_NEW. If EDITS_NEW exists then it simply removes IMAGE_NEW. This means that the NN failure occurred before IMAGE_NEW was completed. If EDITS_NEW is not present, but IMAGE_NEW is, this means that the NN failure occurred after IMAGE_NEW was successfully written, and therefore the NN need just to complete the checkpoint by renaming IMAGE_NEW to IMAGE and purging edits.\n\n> You may be able to know that info from the state of some other files, but why not be explicit about it to avoid some classes of errors?\n\nWe want to be able to know about failure without reading contents of the image file. The contents may be corrupted during failures, it is not safe to rely on reading the data from image or edits files.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-20T00:36:28.156+0000","updated":"2010-02-20T00:36:28.156+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12836073","id":"12836073","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. If EDITS_NEW is not present, but IMAGE_NEW is, this means that the NN failure occurred after IMAGE_NEW was successfully written\n\nThis is not necessarily the case on a lot of filesystems. As I noted in HDFS-970, delayed allocation combined with the default journaling modes in many commonly deployed filesystems means that you cannot use the existance of one file to determine whether data has been flushed in another. That is to say, some filesystems will recover the metadata operations on the EDITS files even though the data operations on IMAGE_NEW are incomplete.\n\nThe _only_ way we can know that IMAGE_NEW is really on disk across a variety of filesystems is to fsync it. Otherwise, when the filesystem is recovered, we could rollback to a state where the file is empty but EDITS_NEW has been removed.\n\nbq. During start up the NN decides on whether to discard or to keep IMAGE_NEW (and rename it to IMAGE) based on the existence of EDITS_NEW\n\nI agree this is what it does. But I don't think there is then any valid rolling order that tolerates arbitrary crashes. See my discussion above\n\nbq. The contents may be corrupted during failures, it is not safe to rely on reading the data from image or edits files\n\nIt is safe if we fsync. metadata can also be corrupted (rolled back to indeterminate states) in failures. Especially with the broken way in which we currently do image replacement, I don't want to take chances here. This is best explained by the presentation linked from this post by Theodore T'so: http://www.linuxfoundation.org/news-media/blogs/browse/2009/03/don%E2%80%99t-fear-fsync","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-20T00:48:20.456+0000","updated":"2010-02-20T00:48:20.456+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12840412","id":"12840412","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"h3. The Problem\n\nOur recovery logic for IMAGE_NEW file was originally intended for the checkpoint recovery, and it works in this case. But it does not work for recovery from a saveFSImage() failure.\n\nThe storage directory may contain four files: IMAGE, EDITS, EDITS_NEW, and IMAGE_NEW.\nHere are the steps we perform during checkpoint:\n0. Initially storage directory has IMAGE and EDITS files only.\n1. Start checkpoint. NN creates EDITS_NEW, and starts streaming edits into it.\n2. Upload IMAGE_NEW from SNN to NN storage directory.\n3. When upload is done, rename EDITS_NEW -> EDITS.\n4. Rename IMAGE_NEW -> IMAGE. Back to the initial state.\n\nHere is the time-line of which combination of files represent the _current_ state of the file system relative to the events above.\n\nIMAGE + EDITS --- (1) --- IMAGE + EDITS + EDITS_NEW --- (2) --- IMAGE + EDITS + EDITS_NEW --- (3) --- IMAGE_NEW + EDITS --- (4) --- IMAGE + EDITS \n\nThe recovery procedure:\n- If EDITS_NEW.exists, then we know NN failed after 1 or 2, but before 3, and our recovery strategy is to discard IMAGE_NEW.\n- If ! EDITS_NEW.exists && IMAGE_NEW.exists, then NN failed after 3, but before 4, and we recover by upgrading IMAGE_NEW to IMAGE.\n\nNow lets see what happens when we save image during startup or saveNamespace.\nHere are the steps we perform when we call saveFSImage():\n0. Initially the storage directory has IMAGE, EDITS, and potentially EDITS_NEW, which have been all loaded and digested in NN RAM.\n1. Create EDITS_NEW if missing.\n2. Save IMAGE_NEW.\n3. Empty EDITS and EDITS_NEW.\n4. Rename EDITS_NEW -> EDITS.\n5. Rename IMAGE_NEW -> IMAGE.\n\nWe use the same recovery procedure here as in checkpointing, which leads to a data loss in the following failure scenario.\nIf we fail after 3 but before 4, then we will discard IMAGE_NEW, because EDITS_NEW.exists. \nBut the latest updates in EDITS and/or EDITS_NEW has already been wiped out and we loose these edits forever.\n\nThe main reason the checkpointing logic does not work for saving is that IMAGE_NEW has different semantics in these two cases.\n- In checkpoint  IMAGE_NEW = IMAGE + EDITS\n- In saveFSImage IMAGE_NEW = IMAGE + EDITS + EDITS_NEW\n\nh3. The Solution\n\nDifferent images should be represented by separate files and treated differently. I'll denote them\n- IMAGE_CKPT = IMAGE + EDITS the checkpoint image\n- IMAGE_LAST = IMAGE + EDITS + EDITS_NEW the last saved image\n\nSo the checkpoint process will create IMAGE_CKPT and will work with is exactly as before, no changes here.\n\nsaveFSImage will save NN's memory state into IMAGE_LAST, and should consist of the following steps:\n0. Initially the storage directory has IMAGE, EDITS, and potentially EDITS_NEW and IMAGE_CKPT.\n1. Save image into IMAGE_LAST.\n2. Remove EDITS, IMAGE_CKPT, and EDITS_NEW - in the order listed.\n3. Rename IMAGE_LAST -> IMAGE.\n4. Create empty EDITS.\n\nIt is important to note that checkpoint cannot start once saveFSImage started, because NN is in safe mode, and because it holds the NN lock. If the upload of IMAGE_CKPT has started (stage c-2) it will proceed concurrently with the save. But rollEdits() (stage c-3) will fail if called during saveFSImage.\n\nHere is the time-line of which combination of files represent the _current_ state of the file system relative to the events above. \n\nIMAGE + EDITS + EDITS_NEW --- (1) --- IMAGE + EDITS + EDITS_NEW --- (2) --- IMAGE_LAST --- (3) --- IMAGE --- (4) --- IMAGE + EDITS \n\nThe recovery procedure for saving image is:\n- If EDITS.exists && IMAGE_LAST.exists, then we know NN failed after 1 but before 2, and we recover by discarding IMAGE_LAST.\n- If ! EDITS.exists && IMAGE_LAST.exists, then NN failed during or after 2, and we recover by applying 2, 3, and 4.\n- If ! EDITS.exists && ! IMAGE_LAST.exists, then NN failed after 3, and we recover by applying 4.\n\nThere is a slight complication for WinFS. It will not let us remove IMAGE_CKPT on stage 3 if the checkpointer is still writing into it. In this case we will ignore the failure, and quit the procedure, delaing the rest of the steps for the future. The correct state (rename IMAGE_LAST to IMAGE) will be restored either when checkpoint finishes or if the NN restarts due to a failure.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-03T00:59:16.610+0000","updated":"2010-03-03T00:59:16.610+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12840415","id":"12840415","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"If I'm reading correctly, your solution is the same as my Option #4 [above|https://issues.apache.org/jira/browse/HDFS-955?focusedCommentId=12832706&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12832706] right?\n\nAre you already working on this or should I start work on a patch that implements this option?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-03-03T01:13:57.307+0000","updated":"2010-03-03T01:13:57.307+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12841983","id":"12841983","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Unfortunately, this solution does not work either. The problem is that it assumes that all files are in the same directory, while in our model edits and image directories may be independent of each other. It means that we cannot rely on the presence or absence of EDITS_NEW (and EDITS) in order to decide whether to remove or promote IMAGE_NEW, because the system can dye when EDITS_NEW is renamed to EDITS in one directory but not in an other. We are trying here to restore the stage of the NN storage transformation sequence, when it crashed, by examining the remaining files. This is error-prone, and introduces unnecessary complexity. We should rather apply the technique used in BackupNode and for the upgrade.\n\nh3. A Better Solution\n\nThe idea is to create a temporary directory and accumulate all necessary changes to the persistent data in it, and then rename it to {{current}} once the new data is ready. The rename is two-step, not atomic, but it minimizes the recovery effort. Here is how saveFSImage() should work.\n\n# Create prospective_current.tmp, and write necessary files in it.\n#- Save new image into prospective_current.tmp/IMAGE\n#- Create empty prospective_current.tmp/EDITS\n#- Create VERSION and fstime files in prospective_current.tmp and write new checkpointTime.\n# Rename current to removed_current.tmp\n# Rename prospective_current.tmp to current\n# Remove removed_current.tmp\n\nAnd the recovery procedure is very simple:\n- if current.exists && prospective_current.tmp.exists then remove prospective_current.tmp\n- if ! current.exists && prospective_current.tmp.exists then rename  prospective_current.tmp to current and remove removed_current.tmp\n\nIt is important that image and edits directories are operated (created and recovered) independently of each other, but maintain the same meta-data state.\nI plan to implement this algorithm, and will try to reuse some code from BN. \nI will not change the checkpoint procedure for SNN, since it is deprecated, and it should not cause problems, as\n- Checkpoint cannot start when saveFSImage is in progress.\n- If checkpoint image upload started before saveFSImage, then the uploading will continue to current, and further rollFSImage will fail either because the NN is in safe mode (saveFSImage is still in progress) or because EDITS_NEW does not exist anymore (saveFSImage already completed).\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-05T19:35:10.597+0000","updated":"2010-03-05T19:35:10.597+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12842052","id":"12842052","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Sounds good to me. Looking forward to your patch. Thanks Konstantin.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-03-05T22:09:48.022+0000","updated":"2010-03-05T22:09:48.022+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12849985","id":"12849985","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"The highlighted (yellow) text explains how {{saveNamespace()}} works and what is the recovery procedure. The recovery is a common procedure, which includes recovery from failed upgrades (taking snapshots), that is why I updated this document under HADOOP-702 and placed it her.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-26T02:28:36.414+0000","updated":"2010-03-26T02:28:36.414+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12849986","id":"12849986","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"This patch fixes the problem. The algorithm is as follows:\n# if current exists, then rename current to lastcheckpoint.tmp\n# create new current directory, and save new image into it\n# remove previous.checkpoint if exists\n# rename lastcheckpoint.tmp to previous.checkpoint\n\nI added the new recovery cases to TestDFSStorageStateRecovery.\nI modified Todd's test to reflect the new code. I renamed saveFSImage() to saveNamespace(), because it saves both fsimafe and edits.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-26T02:34:50.980+0000","updated":"2010-03-26T02:34:50.980+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12849987","id":"12849987","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Also I did not change the LAYOUT_VERSION because there no change in any layouts. I reused directories {{lastcheckpoint.tmp}} and {{previous.checkpoint}} that already existed for making checkpoints.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-26T02:37:47.668+0000","updated":"2010-03-26T02:37:47.668+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12850808","id":"12850808","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12439850/saveNamespace.txt\n  against trunk revision 927999.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 11 new or modified tests.\n\n    -1 javadoc.  The javadoc tool appears to have generated 1 warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/136/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/136/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/136/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/136/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-29T07:27:51.824+0000","updated":"2010-03-29T07:27:51.824+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12851095","id":"12851095","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"This patch fixes the JavaDoc warning.\nDon't know why Hundson complains about test failures. I don't see any failed tests on the Test results page.\nThe patch for 0.21 is mostly the same as for trunk. except for a couple of lines.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-29T21:08:45.655+0000","updated":"2010-03-29T21:08:45.655+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12851222","id":"12851222","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"A patch for 0.20 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-30T02:43:24.359+0000","updated":"2010-03-30T02:43:24.359+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12851513","id":"12851513","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"With the new solution, I see the following issues:\n# The order in which namespace is saved is still important. It has to be image followed by edits. If edits is emptied first, during recovery either edits is lost or system will not start due to image time not matching with that of edits.\n# On a failure after saving image and before edits is emptied, during recovery, the system may not start due to mismatch between fsimage and edits time. However, there is no loss of data in this case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-30T19:08:50.247+0000","updated":"2010-03-30T19:08:50.247+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12852007","id":"12852007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"New patch addresses Suresh's comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-31T18:07:09.978+0000","updated":"2010-03-31T18:07:09.978+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12852100","id":"12852100","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12440371/saveNamespace.patch\n  against trunk revision 929406.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 11 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/289/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/289/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/289/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/289/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-31T20:59:49.821+0000","updated":"2010-03-31T20:59:49.821+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12852537","id":"12852537","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"# FSImage.java\n#* saveNameSpace() - in method comments, instead of \"descrepancy between directory states\", some thing like \"in order help recovery in case failure during saveNamespace\"\n#* typo onle\n#* loadFSImage() - why do we need check for directory type, while comparing latest checkpoint times?\n#* loadFSImage() - instead of \"after saving some of the images\", to \"after saving images in some of the storage directories\" to avoid interpretation that partial image is saved.\n#* saveCurrent(), moveCurrent(), moveLastCheckpoint() could all be static. Better still, they should all be methods in StorageDirectory.\n# Storage.java\n#* if (!hasCheckpointTmp) will always be true.\n#* This might be a good time to document all the the get***Dir() methods\n#* analyzestorage() - optional - can you add IOException after throws to fix javadoc warning\n# TestSaveNamespace - should the switch cases for MOVE_CURRENT and MOVE_LAST_CHECKPOINT be switched?\n# TestSaveNamespace - we should add other tests where save image could fail for first dir also. Also adding failing at different iterations of moveLastCheckPoint() and moveCurrent()?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-01T20:36:26.465+0000","updated":"2010-04-01T20:36:26.465+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12852660","id":"12852660","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"> loadFSImage() - why do we need check for directory type, while comparing latest checkpoint times?\n\nIMAGE latest checkpoint can be larger than EDITS latest checkpoint only if the two directories are image-only and edits-only respectively. If this is one directory which is IMAGE_AND_EDITS then the condition should be treated as an error. This could be an assert in current code, but being overprotective seems to be appropriate here.\n\n> saveCurrent(), moveCurrent(), moveLastCheckpoint() could all be static. Better still, they should all be methods in StorageDirectory.\n\nsaveCurrent() cannot be static, it uses editLog member. All three methods are very much name-node specific, while StorageDirectory is intended to have methods common for all storage types data-node or name-node. So I decided to keep them in FSImage.\n\n> TestSaveNamespace - we should add other tests\n\nI believe these cases are covered in updated TestDFSStorageStateRecovery. The test emulates failures on different stages by creating corresponding  storage directory configurations and verifies that the nodes recover or fail correctly.\n\nThe rest is corrected / updated.\nSuresh, thank you for the meticulous review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-02T01:54:07.742+0000","updated":"2010-04-02T01:54:07.742+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12852886","id":"12852886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"> TestSaveNamespace - should the switch cases for MOVE_CURRENT and MOVE_LAST_CHECKPOINT be switched?\n\nGot it, this is what you meant by switching.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-02T17:40:19.854+0000","updated":"2010-04-02T17:40:19.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12852889","id":"12852889","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"+1 for the patch. BTW thanks for documenting various directories under  storage directories. It adds more clarity to the code, save namespace, upgrade mechanisms.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-02T17:50:09.746+0000","updated":"2010-04-02T17:50:09.746+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12853559","id":"12853559","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12440629/saveNamespace.patch\n  against trunk revision 929406.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 11 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/297/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/297/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/297/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/297/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-04-05T22:11:45.550+0000","updated":"2010-04-05T22:11:45.550+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12853774","id":"12853774","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"+1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12440629/saveNamespace.patch\n  against trunk revision 930967.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 11 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/148/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/148/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/148/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/148/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-04-06T06:38:26.262+0000","updated":"2010-04-06T06:38:26.262+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12854076","id":"12854076","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Here are the new patches for 0.21 and 0.20 branches.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-06T17:34:43.750+0000","updated":"2010-04-06T17:34:43.750+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12854111","id":"12854111","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"I just committed this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-06T18:34:29.751+0000","updated":"2010-04-06T18:34:29.751+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12455702/comment/12854135","id":"12854135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hadoop-Hdfs-trunk-Commit #231 (See [http://hudson.zones.apache.org/hudson/job/Hadoop-Hdfs-trunk-Commit/231/])\n    . New implementation of saveNamespace() to avoid loss of edits when name-node fails during saving. Contributed by Konstantin Shvachko.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2010-04-06T19:22:40.520+0000","updated":"2010-04-06T19:22:40.520+0000"}],"maxResults":45,"total":45,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-955/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i02qt3:"}}