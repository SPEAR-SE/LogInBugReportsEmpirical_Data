{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12547331","self":"https://issues.apache.org/jira/rest/api/2/issue/12547331","key":"HDFS-3122","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2012-03-22T12:16:28.138+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Apr 25 14:32:13 UTC 2014","customfield_12310420":"232489","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_66130036104_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-04-25T14:32:13.395+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-3122/watchers","watchCount":13,"isWatching":false},"created":"2012-03-21T05:04:57.333+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315571","id":"12315571","description":"","name":"0.23.0","archived":false,"released":true,"releaseDate":"2011-11-11"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12320353","id":"12320353","description":"hadoop-2.0.0-alpha release","name":"2.0.0-alpha","archived":false,"released":true,"releaseDate":"2012-05-23"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-03-10T04:36:54.806+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312927","id":"12312927","name":"datanode"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312926","id":"12312926","name":"namenode"}],"timeoriginalestimate":null,"description":"*Block Report* can *race* with *Block Recovery* with closeFile flag true.\n\n Block report generated just before block recovery at DN side and due to N/W problems, block report got delayed to NN. \nAfter this, recovery success and generation stamp modifies to new one. \nAnd primary DN invokes the commitBlockSynchronization and block got updated in NN side. Also block got marked as complete, since the closeFile flag was true. Updated with new genstamp.\n\nNow blockReport started processing at NN side. This particular block from RBW (when it generated the BR at DN), and file was completed at NN side.\nFinally block will be marked as corrupt because of genstamp mismatch.\n\n{code}\n case RWR:\n      if (!storedBlock.isComplete()) {\n        return null; // not corrupt\n      } else if (storedBlock.getGenerationStamp() != iblk.getGenerationStamp()) {\n        return new BlockToMarkCorrupt(storedBlock,\n            \"reported \" + reportedState + \" replica with genstamp \" +\n            iblk.getGenerationStamp() + \" does not match COMPLETE block's \" +\n            \"genstamp in block map \" + storedBlock.getGenerationStamp());\n      } else { // COMPLETE block, same genstamp\n{code}\n\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12320052","id":"12320052","description":"0.23.3","name":"0.23.3","archived":false,"released":true,"releaseDate":"2012-09-20"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12519176","id":"12519176","filename":"blockCorrupt.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-21T05:41:59.589+0000","size":2745,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12519176/blockCorrupt.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"114100","customfield_12312823":null,"summary":"Block recovery with closeFile flag true can race with blockReport. Due to this blocks are getting marked as corrupt.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13234104","id":"13234104","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"I reproduced this case with the debug points.\n\n1) created a file and hsync'ed that file.\n2) triggered on BR in separate thread and blocked this call in NN side just before aquiring the fsnamesystem lock.\n3) triggered one recoverlease call from separate thread and completed the call.\n4) after successfully completed #3 (after commitBlockSynchronization with new genstamp), started processing the blocked BR in #2.\n5) since that old BR has older genstamp, that block is getting marked as corrupt.\n\nwill attach the colored logs. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-21T05:11:32.562+0000","updated":"2012-03-21T05:11:32.562+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13234127","id":"13234127","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"attched the grepped logs.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-21T05:42:00.499+0000","updated":"2012-03-21T05:42:00.499+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13235530","id":"13235530","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ewenpower","name":"ewenpower","key":"ewenpower","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liaowenrui","active":true,"timeZone":"Asia/Shanghai"},"body":"in this sence, delete data is very danger.it is very easy to loss data!\n\n solution that resolve this issue:\n\nwhen namenode find replica with genstamp not match,the namenode require it's datanode re-report block reportï¼Œ\nif it is still not match,the namenode mark it corrupt.\n\nAre you right?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ewenpower","name":"ewenpower","key":"ewenpower","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liaowenrui","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-03-22T12:16:28.138+0000","updated":"2012-03-22T12:16:28.138+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13240883","id":"13240883","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"@Todd, Did you look at this issue?\nWant to invite you on this issue for solution discussions. It looks like, it is hard to identify the block corruption at this situation. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-03-29T01:27:49.247+0000","updated":"2012-03-29T01:27:49.247+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13246256","id":"13246256","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amithdk","name":"amithdk","key":"amithdk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"amith","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi Folks\n\nI thought of  some sample solution for this problem please give your inputs to the same.\n\nWhen any blockrecovery happen, commitBlockSynchronization is called we can store the old and new generation stamp for this block in a map which is like \nhistoryMap = new HashMap<String, ArrayList<Long>>(). Here ArrayList is of size 2 which contain old and new GenerationStamp. \n\nFor every recovery this map is updated with the block and Generation Stamps. \n\nConsider the scenario when BlockReport has arrived @ NN and delayed. \nNow if the any BlockRecovery completed (historyMap will have the entry of old and new Generation Stamps). \nNow the Blockreport processing started. Here \n\n{code}\ncase RWR: \n      if (!storedBlock.isComplete()) { \n        return null; // not corrupt \n      } else if (storedBlock.getGenerationStamp() != iblk.getGenerationStamp() &&\n            !historyMap.get(iblk.getBlockId()).get(0) != iblk.getGenerationStamp() )) { \n        return new BlockToMarkCorrupt(storedBlock, \n            \"reported \" + reportedState + \" replica with genstamp \" + \n            iblk.getGenerationStamp() + \" does not match COMPLETE block's \" + \n            \"genstamp in block map \" + storedBlock.getGenerationStamp()); \n      } else { // COMPLETE block, same genstamp\n{code}\n\nHere we are checking like \nif (Block GenerationStamp from BlockMap != BlockReport's Block GenerationStamp and (blockGenerationStamp is newly changed due to recovery then check the) \nold GenerationStamp is not equal BlockReports Block GenerationStamp) then { // mark block as corrupt the block } \n\nMap is populated in CommitBlockSynchronization and cleared when BlockReport is processed for this block with new generationstamp\n\n \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amithdk","name":"amithdk","key":"amithdk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"amith","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-04-04T13:47:02.399+0000","updated":"2012-04-04T13:47:02.399+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13403169","id":"13403169","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Nicholas,\n\nDo you have any solution for this?\n\nOne work around could be that, if reported block is having less genstamp and NN is having higher then , how about adding them into some suspected corrupt list. On next block report if the block is having correct genstamp(newer genstamp), then we can just clean that block from suspectedCorruptMap. If block is having still less genstamp and that entry already presents in suspectedCorruptMap, then mark it as corrupt. But I am worrying to introduce one more datastructure here.\n\nAny suggestion on this would be appreciated.\n\nThanks,\nUma","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-06-28T15:34:55.154+0000","updated":"2012-06-28T15:34:55.154+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13403180","id":"13403180","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Uma,\n\nI may have missed something: at the time of processing BR, both the block stored in NN and the replica stored in DN have the newer genstamp.  We should have the following:\n\n- NN side: NN has a newer genstamp but DN reported a replica with an older genstamp.  NN should tell DN to delete replica with the older genstamp and the stored block in NN remains unchanged.\n- DN side: DN receives a replica-delete with the older genstamp from NN but the stored genstamp is newer.  So it ignores the replica-delete.\n\nThere may be some bugs in the implementation.  What happen after the block is marked as corrupted?  Will DN delete the replica?  Or will NN remove the DN from the block location list?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-06-28T15:59:32.546+0000","updated":"2012-06-28T15:59:32.546+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13403200","id":"13403200","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks a lot Nicholas.\n\n{quote}\n- DN side: DN receives a replica-delete with the older genstamp from NN but the stored genstamp is newer.  So it ignores the replica-delete.\n{quote}\nIn my case, this happened for all the blocks unfortunately. I have seen the logs, all blocks marked as corrupt almost at same time. So, it will just leave all the corrupt block as is.\n\n Yes, here is one bug I remember. HDFS-3157. NN will add the block as corrupt with NN genstamp rather than reported genstamp ( I will take a look on that patch again). This should solve this problem. But all DNs configured BR time same and happens for all means, all blocks will get marked as corrupt right?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-06-28T16:28:47.517+0000","updated":"2012-06-28T16:28:47.517+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13403690","id":"13403690","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amithdk","name":"amithdk","key":"amithdk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"amith","active":true,"timeZone":"Asia/Kolkata"},"body":"In our situation we had only 3 DN in test cluster, NN marked block (which has replication 3 ) has corrupt in same time, There is no command from NN to DN to invalidate the block\n\nI guess this is because of the behaviour i.e, NN will try to replicate the corrupt block with a valid block first then invalidate the corrupt block.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amithdk","name":"amithdk","key":"amithdk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"amith","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-06-29T04:38:18.595+0000","updated":"2012-06-29T04:38:18.595+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13403903","id":"13403903","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Uma, please review HDFS-3157 when you have time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-06-29T13:47:43.013+0000","updated":"2012-06-29T13:47:43.013+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13404950","id":"13404950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Nicholas,\n\n I feel this issue is still valid after HDFS-3157 and when all blocks marked as corrupt.\nAlso we are seeing many race conditions with recovery and close, commitBlockSynchronization. see HDFS-3584 and HDFS-3585 just reported by Brahma. Once it corrupts all the blocks, leter even though DN sends with correct block, there is no use, as it already put them into corrupt. Also there will not be any replication as there is no live replicas.\n\nThanks\nUma\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-02T09:01:19.891+0000","updated":"2012-07-02T09:01:19.891+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13979848","id":"13979848","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitdesai","name":"mitdesai","key":"mitdesai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Mit Desai","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~umamaheswararao],\nIs this still an issue? I looked at the code and I think this got fixed sometime.\nHere is the code snippet from BlockManager\n{code}\ncase RWR:\n      if (!storedBlock.isComplete()) {\n        return null; // not corrupt\n      } else if (storedBlock.getGenerationStamp() != reported.getGenerationStamp()) {\n        final long reportedGS = reported.getGenerationStamp();\n        return new BlockToMarkCorrupt(storedBlock, reportedGS,\n            \"reported \" + reportedState + \" replica with genstamp \" + reportedGS\n            + \" does not match COMPLETE block's genstamp in block map \"\n            + storedBlock.getGenerationStamp(), Reason.GENSTAMP_MISMATCH);\n      } else { // COMPLETE block, same genstamp\n        if (reportedState == ReplicaState.RBW) {\n          // If it's a RBW report for a COMPLETE block, it may just be that\n          // the block report got a little bit delayed after the pipeline\n          // closed. So, ignore this report, assuming we will get a\n          // FINALIZED replica later. See HDFS-2791\n          LOG.info(\"Received an RBW replica for \" + storedBlock +\n              \" on \" + dn + \": ignoring it, since it is \" +\n              \"complete with the same genstamp\");\n          return null;\n        } else {\n          return new BlockToMarkCorrupt(storedBlock,\n              \"reported replica has invalid state \" + reportedState,\n              Reason.INVALID_STATE);\n        }\n      }\n{code}\n\nI will resolve this Jira as \"Not a Problem\" tomorrow unless someone wants to go some other way.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitdesai","name":"mitdesai","key":"mitdesai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Mit Desai","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-04-24T15:39:18.181+0000","updated":"2014-04-24T15:39:18.181+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12547331/comment/13981058","id":"13981058","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitdesai","name":"mitdesai","key":"mitdesai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Mit Desai","active":true,"timeZone":"America/Los_Angeles"},"body":"Haven't heard anything yet. Resolving this issue. Feel free to reopen if anyone thinks the other way.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitdesai","name":"mitdesai","key":"mitdesai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Mit Desai","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-04-25T14:32:13.425+0000","updated":"2014-04-25T14:32:13.425+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-3122/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0jvwv:"}}