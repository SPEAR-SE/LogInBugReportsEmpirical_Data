{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12725923","self":"https://issues.apache.org/jira/rest/api/2/issue/12725923","key":"HDFS-6636","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jul 08 03:03:51 UTC 2014","customfield_12310420":"404081","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6636/watchers","watchCount":5,"isWatching":false},"created":"2014-07-08T02:36:11.231+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325049","id":"12325049","description":"2.2.0 release","name":"2.2.0","archived":false,"released":true,"releaseDate":"2013-10-15"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-08-05T02:00:36.553+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312926","id":"12312926","name":"namenode"}],"timeoriginalestimate":null,"description":"In our test environment, we found the namenode can not handle incremental block report correctly when the block replica is under construction and the replica is marked as corrupt.\nHere is our scenario.\n* the block had 3 replica by default. But because one datanode was down, the available replica for the block was 2. Say the alive datanode is DN1 and DN2.\n* client tried to append data to the block. And during appending, something was wrong with the pipeline. Then, client did the pipeline recovery, only one datanode DN1 is in the pipeline now.\n* For some unknown reason(might be the IO error), DN2 got checksum error when receiving block data from DN1, then DN2 reported the replica on DN1 as bad block to NameNode. But actually, client was appending data to replica on DN1, and the replica is good.\n* NameNode marked replica on DN1 as corrupt.\n* When client finished appending, DN1 checked the data in the replica, and the replica is OK. Then, DN1 finalized the replica, DN1 reported the block as received block to NameNode.\n* NameNode handled the incremental block report form DN1, because the block is under construction. NameNode called the addStoredBlockUnderConstruction in block manager. But as the replica on DN1 was never removed from the corrupted block. The number of alive replica for the block was 0, and the number of corrupt replica was 1.\n* client could not complete the file because the number of alive replicas for the last block was smaller than minimal replica number. \n \n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"404122","customfield_12312823":null,"summary":"NameNode should remove block replica out from corrupted replica map when adding block under construction","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangg23","name":"wangg23","key":"wangg23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wangg23&avatarId=18994","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wangg23&avatarId=18994","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wangg23&avatarId=18994","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wangg23&avatarId=18994"},"displayName":"Gordon Wang","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangg23","name":"wangg23","key":"wangg23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wangg23&avatarId=18994","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wangg23&avatarId=18994","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wangg23&avatarId=18994","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wangg23&avatarId=18994"},"displayName":"Gordon Wang","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12725923/comment/14054447","id":"14054447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangg23","name":"wangg23","key":"wangg23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wangg23&avatarId=18994","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wangg23&avatarId=18994","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wangg23&avatarId=18994","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wangg23&avatarId=18994"},"displayName":"Gordon Wang","active":true,"timeZone":"Asia/Shanghai"},"body":"IMO, NameNode should check the corrupted block map when adding block under construction.\nIf the reported block has been marked as corrupted before, NameNode should remove the reported block from the corrupted block map. It is possible that the under construction replica is marked as corrupted.\nI have 2 reasons for the proposal\n# Because as long as the reported block triggers the method addStoredBlockUnderConstruction, this means this reported block is not corrupt. The block has passed the check of checkReplicaCorrupt.\n# In the code of method addStoredBlock,  when adding a reported block, NameNode checks the corrupted block map and remove the block in the corrupted block map. This kind of logic should be consistent in addStoredBlock and addStoredBlockUnderConstruction.\n\nI can reproduce this issue with a Unit Test. The unit test is a simple scenario to mimic the situation I met.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangg23","name":"wangg23","key":"wangg23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wangg23&avatarId=18994","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wangg23&avatarId=18994","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wangg23&avatarId=18994","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wangg23&avatarId=18994"},"displayName":"Gordon Wang","active":true,"timeZone":"Asia/Shanghai"},"created":"2014-07-08T02:48:07.261+0000","updated":"2014-07-08T02:48:07.261+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12725923/comment/14054453","id":"14054453","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangg23","name":"wangg23","key":"wangg23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wangg23&avatarId=18994","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wangg23&avatarId=18994","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wangg23&avatarId=18994","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wangg23&avatarId=18994"},"displayName":"Gordon Wang","active":true,"timeZone":"Asia/Shanghai"},"body":"attach the UT for reproducing this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangg23","name":"wangg23","key":"wangg23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wangg23&avatarId=18994","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wangg23&avatarId=18994","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wangg23&avatarId=18994","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wangg23&avatarId=18994"},"displayName":"Gordon Wang","active":true,"timeZone":"Asia/Shanghai"},"created":"2014-07-08T03:03:51.937+0000","updated":"2014-07-08T03:03:51.937+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6636/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1xjlz:"}}