{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13037050","self":"https://issues.apache.org/jira/rest/api/2/issue/13037050","key":"HDFS-11360","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2017-01-23T16:04:21.773+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Feb 08 09:42:33 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_32903674905_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2018-02-08T09:51:45.982+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-11360/watchers","watchCount":8,"isWatching":false},"created":"2017-01-23T13:57:11.133+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12331979","id":"12331979","description":"2.7.1 release","name":"2.7.1","archived":false,"released":true,"releaseDate":"2015-07-06"}],"issuelinks":[{"id":"12526556","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12526556","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"12909880","key":"HDFS-9365","self":"https://issues.apache.org/jira/rest/api/2/issue/12909880","fields":{"summary":"Balancer does not work with the HDFS-6376 HA setup","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-02-08T09:52:37.599+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313153","id":"12313153","name":"balancer & mover"}],"timeoriginalestimate":null,"description":"With distcp configuration, there are two or more \"nameservices\" setting in hdfs-site.xml, for example:\n{code}\n    <property>\n        <name>dfs.nameservices</name>\n        <value>one-nn-ha,two-nn-ha</value>\n    </property>\n{code}\n\nIf the HDFS Balancer also launches in that node, it will create two IPC threads to connect both of NNs. And block removing both happens in this Balancer. Although I didn't find any block removing between different clusters, the behavior still became weird and unexpected.\nSo the best way is adding a configuration that appoint to a decided nameservice to launch. I can offer a patch. Any better ideal? ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"HDFS balancer need a config to appoint to a decided nameservice","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13037050/comment/15834807","id":"15834807","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"It was originally done that way for the federation feature.  Whatever approach you take should not break it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2017-01-23T16:04:21.773+0000","updated":"2017-01-23T16:04:21.773+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13037050/comment/15835062","id":"15835062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=surendrasingh","name":"surendrasingh","key":"surendrasingh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=surendrasingh&avatarId=30759","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=surendrasingh&avatarId=30759","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=surendrasingh&avatarId=30759","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=surendrasingh&avatarId=30759"},"displayName":"Surendra Singh Lilhore","active":true,"timeZone":"Etc/UTC"},"body":"Hi [~cltlfcjin],\n\nDid you try \"dfs.internal.nameservices\" ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=surendrasingh","name":"surendrasingh","key":"surendrasingh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=surendrasingh&avatarId=30759","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=surendrasingh&avatarId=30759","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=surendrasingh&avatarId=30759","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=surendrasingh&avatarId=30759"},"displayName":"Surendra Singh Lilhore","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-23T19:11:34.260+0000","updated":"2017-01-23T19:11:34.260+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13037050/comment/15835820","id":"15835820","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"body":"Yes, \"dfs.internal.nameservices\" has been set to of of them \"one-nn-ha\".\nNo data transferred between them by searching the log but the Balancer worked two jobs.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-24T08:05:06.118+0000","updated":"2017-01-24T08:05:06.118+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13037050/comment/15835851","id":"15835851","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"body":"Found the log below:\n{code}\nINFO org.apache.hadoop.hdfs.server.balancer.Balancer: namenodes  = [hdfs://one-nn-ha, hdfs://two-nn-ha]\n{code}\n\nIs this design on purpose or a bug?\nIn the run method of Balancer.Cli, it just uses DFSUtil class to get the namenode list. The getNsServiceRpcUris method uses \"dfs.nameservices\". \n{code:java}\n        final Collection<URI> namenodes = DFSUtil.getNsServiceRpcUris(conf);\n{code}\n\nAnd it create a Balancer instance for each: (in the run of Balancer)\n{code:java}\n    Collections.shuffle(connectors);\n        for(NameNodeConnector nnc : connectors) {\n          final Balancer b = new Balancer(nnc, p, conf);\n          final Result r = b.runOneIteration();\n          ...\n{code}\n\nI am afraid that most of user cases of Balancer need to set different configuration and to start independency instance.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-24T08:41:36.034+0000","updated":"2017-01-24T08:41:36.034+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13037050/comment/15836218","id":"15836218","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"body":"In the official document https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/Federation.html#Balancer\nThe Balancer has been changed to work with multiple Namenodes.\nAnd we can set the datanode policy or blockpool policy. Whatever policy set, one Balancer instance always takes charge of all nameservices.\n\nBTW, the default policy is datanode policy:\n{code}\n    // Defaults\n    private BalancingPolicy policy = BalancingPolicy.Node.INSTANCE;\n{code}\n\nBut our use case isn't the federation cluster. Two nameservices set in hdfs-site.xml is just for using distcp. \nSo the actual behavior in two clusters degrades into blockpool policy from default datanode one (Block removing only occurs in the same cluster).\n\nSo I think if we need to add a configuration to setting a decided nameservice when start a Balancer instance.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-24T15:17:58.183+0000","updated":"2017-01-24T15:17:58.183+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13037050/comment/16353212","id":"16353212","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bharatviswa","name":"bharatviswa","key":"bharatviswa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bharat Viswanadham","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~cltlfcjin]\r\n\r\n//To find namenodes in the cluster\r\n\r\nfinal Collection<URI> namenodes = DFSUtil.getNsServiceRpcUris(conf);\r\n If DFS_INTERNAL_NAMESERVICES_KEY is set, the above method returns only namenode that belong to this cluster.\r\n\r\n \r\n\r\nAs in your case it is not federated cluster, you can set dfs.internal.nameservices to avoid the above scenario you have mentioned.\r\n\r\nAs, DFSUtil.getInternalNsRpcUris(), calls getInternalNameServices(), which will return the value of dfs.internal.nameservices value if it is set, otherwise it will use dfs.nameservices and return all the nameservices. So, if dfs.internal.nameservices is set, it will only create one NameNodeConnector.\r\n\r\n \r\n\r\nCould you please let me know if i am missing something here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bharatviswa","name":"bharatviswa","key":"bharatviswa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bharat Viswanadham","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-02-06T01:48:17.893+0000","updated":"2018-02-06T01:50:51.317+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13037050/comment/16356730","id":"16356730","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"body":"Actually, the bug has been fixed in HDFS-9365 now.\r\nIn the run() method of Balancer.Cli.\r\n{code}\r\n        final Collection<URI> namenodes = DFSUtil.getInternalNsRpcUris(conf);\r\n{code}\r\n\r\nClosed","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-08T09:42:33.960+0000","updated":"2018-02-08T09:52:37.594+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-11360/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i392rb:"}}