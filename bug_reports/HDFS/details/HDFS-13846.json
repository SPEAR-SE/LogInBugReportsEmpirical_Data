{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13180496","self":"https://issues.apache.org/jira/rest/api/2/issue/13180496","key":"HDFS-13846","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-08-24T10:14:20.765+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 30 12:43:52 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13846/watchers","watchCount":5,"isWatching":false},"created":"2018-08-22T15:09:07.521+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341434","id":"12341434","description":"3.1.0 release","name":"3.1.0","archived":false,"released":true,"releaseDate":"2018-04-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-08-30T12:43:52.752+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12329603","id":"12329603","name":"hdfs"}],"timeoriginalestimate":null,"description":"In BlockManagerSafeMode class, the \"safe blocks\" counter is incremented if the number of nodes containing the block equals to the number of data units specified by the erasure coding policy, which looks like this in the code:\r\n{code:java}\r\nfinal int safe = storedBlock.isStriped() ?\r\n        ((BlockInfoStriped)storedBlock).getRealDataBlockNum() : safeReplication;\r\n    if (storageNum == safe) {\r\n      this.blockSafe++;\r\n{code}\r\nBut when it is decremented the code does not check if the block is striped or not, just compares the number of nodes containing the block with 0 (safeReplication - 1) if the block is complete, which is not correct.\r\n{code:java}\r\nif (storedBlock.isComplete() &&\r\n        blockManager.countNodes(b).liveReplicas() == safeReplication - 1) {\r\n      this.blockSafe--;\r\n      assert blockSafe >= 0;\r\n      checkSafeMode();\r\n    }\r\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12342772","id":"12342772","description":"","name":"3.2.0","archived":false,"released":false}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12936674","id":"12936674","filename":"HDFS-13846.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-22T16:29:31.562+0000","size":4709,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12936674/HDFS-13846.001.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12937270","id":"12937270","filename":"HDFS-13846.002.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-27T11:38:37.680+0000","size":6215,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12937270/HDFS-13846.002.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12937597","id":"12937597","filename":"HDFS-13846.003.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-29T09:22:34.915+0000","size":8237,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12937597/HDFS-13846.003.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12937751","id":"12937751","filename":"HDFS-13846.004.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-30T11:43:58.495+0000","size":8247,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12937751/HDFS-13846.004.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Safe blocks counter is not decremented correctly if the block is striped","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13180496/comment/16591436","id":"16591436","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zvenczel","name":"zvenczel","key":"zvenczel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=zvenczel&avatarId=33404","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=zvenczel&avatarId=33404","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=zvenczel&avatarId=33404","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=zvenczel&avatarId=33404"},"displayName":"Zsolt Venczel","active":true,"timeZone":"Europe/Budapest"},"body":"Thanks [~knanasi] for creating this issue, I think it's a great catch!\r\n\r\nIn the description the term \"node\" is a bit confusing to me. These are the \"real data blocks\" you are referring to right?\r\n\r\nI like how you extended the already available mocking approach in the unit tests.\r\n When I applied the test it was failing but it did pass with your proposed fix therefore I think it should be valid.\r\n\r\nOverall I think it's a valid change, +1 (non-binding) from me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zvenczel","name":"zvenczel","key":"zvenczel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=zvenczel&avatarId=33404","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=zvenczel&avatarId=33404","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=zvenczel&avatarId=33404","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=zvenczel&avatarId=33404"},"displayName":"Zsolt Venczel","active":true,"timeZone":"Europe/Budapest"},"created":"2018-08-24T10:14:20.765+0000","updated":"2018-08-24T10:15:12.298+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13180496/comment/16591522","id":"16591522","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"body":"Thanks you [~zvenczel] for reviewing this! Yes, when I wrote \"the number of nodes containing the block\" I meant \"real data blocks\".","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-24T11:43:29.143+0000","updated":"2018-08-24T11:43:29.143+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13180496/comment/16593177","id":"16593177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Kitti for finding and fixing this, and Zsolt for reviewing!\r\n\r\nThis is a good find, and the patch looks pretty good overall. A few test comment:\r\n- We can take out the magic number (dataBlockNum) 2 here, make it a constant and calculated from {{liveReplicas}}. {code}\r\nwhen(blockInfo.getRealDataBlockNum()).thenReturn((short)2);\r\n{code}\r\n- The assertion part of {{testIncrementAndDecrementSafeBlockCount}} and {{testIncrementAndDecrementStripedSafeBlockCount}} can be refactored into a shared method.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-27T04:25:04.070+0000","updated":"2018-08-27T04:25:04.070+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13180496/comment/16593542","id":"16593542","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for the comments [~xiaochen]! I fixed them in patch v002.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-27T11:39:54.058+0000","updated":"2018-08-27T11:39:54.058+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13180496/comment/16593714","id":"16593714","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 30s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 19m  6s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 56s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 51s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  3s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 12m 58s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 54s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 49s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  1m  3s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 56s{color} | {color:green} the patch passed {color} |\r\n| {color:red}-1{color} | {color:red} javac {color} | {color:red}  0m 56s{color} | {color:red} hadoop-hdfs-project_hadoop-hdfs generated 1 new + 530 unchanged - 0 fixed = 531 total (was 530) {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 47s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  0s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 11m 56s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 58s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 45s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:red}-1{color} | {color:red} unit {color} | {color:red} 94m 23s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 32s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}151m 17s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Reason || Tests ||\r\n| Failed junit tests | hadoop.hdfs.server.namenode.TestCacheDirectives |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:ba1ab08 |\r\n| JIRA Issue | HDFS-13846 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12937270/HDFS-13846.002.patch |\r\n| Optional Tests |  dupname  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux e15cc814735e 3.13.0-153-generic #203-Ubuntu SMP Thu Jun 14 08:52:28 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / 91836f0 |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_181 |\r\n| findbugs | v3.1.0-RC1 |\r\n| javac | https://builds.apache.org/job/PreCommit-HDFS-Build/24889/artifact/out/diff-compile-javac-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n| unit | https://builds.apache.org/job/PreCommit-HDFS-Build/24889/artifact/out/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/24889/testReport/ |\r\n| Max. process+thread count | 3076 (vs. ulimit of 10000) |\r\n| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |\r\n| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/24889/console |\r\n| Powered by | Apache Yetus 0.9.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-27T14:11:54.714+0000","updated":"2018-08-27T14:11:54.714+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13180496/comment/16595669","id":"16595669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=templedf","name":"templedf","key":"templedf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=templedf&avatarId=24879","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=templedf&avatarId=24879","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=templedf&avatarId=24879","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=templedf&avatarId=24879"},"displayName":"Daniel Templeton","active":true,"timeZone":"America/Los_Angeles"},"body":"Great catch. Thanks for the patch. Here are some comments:\r\n # In {{BlockManagerSafeMode.decrementSafeBlockCount()}} the javadoc says it will, \"decrement number of safe blocks if current block has fallen below minimal replication,\" but the conditional only tests for equality:\r\n{code:java}\r\nblockManager.countNodes(b).liveReplicas() == safe - 1{code}\r\nWhich one is wrong?\r\n\r\n # In {{BlockManagerSafeMode.decrementSafeBlockCount()}} I don't like the name {{safe}}. I see you copied it from another method, but it sounds like a boolean. Can you give it a name that's more obvious as to what it is?\r\n # In {{BlockManagerSafeMode.assertSafeModeIsLeftAtThreshold()}}, please add messages to the asserts.\r\n\r\nOtherwise, looks good.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=templedf","name":"templedf","key":"templedf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=templedf&avatarId=24879","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=templedf&avatarId=24879","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=templedf&avatarId=24879","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=templedf&avatarId=24879"},"displayName":"Daniel Templeton","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-28T22:27:32.735+0000","updated":"2018-08-28T22:27:32.735+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13180496/comment/16596141","id":"16596141","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"body":"Thanks [~templedf] for the comments! I fixed them in patch v003.\r\n\r\nAbout the javadoc, BlockManagerSafeMode.decrementSafeBlockCount() method is invoked from BlockManager every time a block is removed, so it is enough to decrement the counter at the point when it is first less than the \"safe\" variable, and what it will do is exactly to decrement the counter when \"current block has fallen below minimal replication\".","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-29T09:48:03.082+0000","updated":"2018-08-29T09:48:03.082+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13180496/comment/16596832","id":"16596832","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=templedf","name":"templedf","key":"templedf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=templedf&avatarId=24879","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=templedf&avatarId=24879","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=templedf&avatarId=24879","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=templedf&avatarId=24879"},"displayName":"Daniel Templeton","active":true,"timeZone":"America/Los_Angeles"},"body":"I see.  That makes sense.  Might be nice to add a comment to explain that so that someone doesn't \"fix\" it later by making the conditional test {{<=}}.  Aside from that, LGTM.  Did you look at the deprecation warning that popped up?  The jenkins build is gone now, so I can't verify whether it was related to code you added.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=templedf","name":"templedf","key":"templedf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=templedf&avatarId=24879","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=templedf&avatarId=24879","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=templedf&avatarId=24879","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=templedf&avatarId=24879"},"displayName":"Daniel Templeton","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-29T20:40:11.246+0000","updated":"2018-08-29T20:40:11.246+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13180496/comment/16597407","id":"16597407","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"body":"I modified the javadoc to say \"it has just fallen below minimal replication\", so it is more clear to the reader that it is only decremented once for a block. Do you have any other idea on how to state that?\r\n\r\nThe deprecation warning popped up because the Whitebox.setInternalState deprecated method is used in the new test, it is used to modify the extension field, which would come from configuration otherwise, note that all the other tests in this class sets that field like the new one.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knanasi","name":"knanasi","key":"knanasi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=knanasi&avatarId=35301","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=knanasi&avatarId=35301","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=knanasi&avatarId=35301","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=knanasi&avatarId=35301"},"displayName":"Kitti Nanasi","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-30T12:43:52.752+0000","updated":"2018-08-30T12:43:52.752+0000"}],"maxResults":9,"total":9,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13846/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3xb7r:"}}