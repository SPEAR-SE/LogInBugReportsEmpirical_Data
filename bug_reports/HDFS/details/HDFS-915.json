{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12446392","self":"https://issues.apache.org/jira/rest/api/2/issue/12446392","key":"HDFS-915","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2010-02-17T23:28:29.487+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 14 20:11:56 UTC 2012","customfield_12310420":"16754","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-915/watchers","watchCount":8,"isWatching":false},"created":"2010-01-23T00:00:24.542+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314048","id":"12314048","description":"","name":"0.20.1","archived":false,"released":true,"releaseDate":"2009-09-01"}],"issuelinks":[{"id":"12330002","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330002","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12446401","key":"HDFS-917","self":"https://issues.apache.org/jira/rest/api/2/issue/12446401","fields":{"summary":"Write pipeline heartbeat interval should be determined by client timeout, not DN","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-05-16T19:17:19.054+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312928","id":"12312928","name":"hdfs-client"}],"timeoriginalestimate":null,"description":"After running kill -STOP on the datanode in the middle of a write pipeline, the client takes far longer to recover than it should. The ResponseProcessor times out in the correct interval, but doesn't interrupt the DataStreamer, which appears to not be subject to the same timeout. The client only recovers once the OS actually declares the TCP stream dead, which can take a very long time.\n\nI've experienced this on 0.20.1, haven't tried it yet on trunk or 0.21.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12518368","id":"12518368","filename":"hdfs-915-0.20.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-03-14T20:11:55.960+0000","size":1588,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12518368/hdfs-915-0.20.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12431179","id":"12431179","filename":"local-dn.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-23T00:48:26.427+0000","size":12175,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12431179/local-dn.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"14214","customfield_12312823":null,"summary":"Hung DN stalls write pipeline for far longer than its timeout","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446392/comment/12803970","id":"12803970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"This still happens on trunk, and actually a little worse:\n\n[todd@monster01 hadoop-combined]$ top -d 0.1 -b |  ./bin/hadoop fs -put - top-foo-9\n======> I issue kill -STOP. Around a minute later (read timeout time) I get, as expected:\n10/01/22 16:23:31 WARN hdfs.DFSClient: DFSOutputStream ResponseProcessor exception  for block blk_-5990414986184221392_1107java.io.IOException: Bad response ERROR for block blk_-5990414986184221392_1107 from datanode 192.168.42.41:42060\n        at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream$DataStreamer$ResponseProcessor.run(DFSClient.java:3071)\n======> I hit C-\\ to get a thread dump (elided the JVM threads which arent important)  \n2010-01-22 16:24:31\nFull thread dump Java HotSpot(TM) 64-Bit Server VM (14.0-b16 mixed mode):\n\n\"LeaseChecker\" daemon prio=10 tid=0x00000000578eb800 nid=0x6fbe waiting on condition [0x0000000042c02000]\n   java.lang.Thread.State: TIMED_WAITING (sleeping)\n        at java.lang.Thread.sleep(Native Method)\n        at org.apache.hadoop.hdfs.DFSClient$LeaseChecker.run(DFSClient.java:1289)\n        at java.lang.Thread.run(Thread.java:619)\n\n\"DataStreamer for file /user/todd/top-foo-9 block blk_-5990414986184221392_1107\" daemon prio=10 tid=0x00000000578eb000 nid=0x6fbd runnable [0x0000000040803000]\n   java.lang.Thread.State: RUNNABLE\n        at sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)\n        at sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:215)\n        at sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:65)\n        at sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:69)\n        - locked <0x00002aaadd18dc30> (a sun.nio.ch.Util$1)\n        - locked <0x00002aaadd18dc18> (a java.util.Collections$UnmodifiableSet)\n        - locked <0x00002aaadd18d8b8> (a sun.nio.ch.EPollSelectorImpl)\n        at sun.nio.ch.SelectorImpl.select(SelectorImpl.java:80)\n        at org.apache.hadoop.net.SocketIOWithTimeout$SelectorPool.select(SocketIOWithTimeout.java:332)\n        at org.apache.hadoop.net.SocketIOWithTimeout.doIO(SocketIOWithTimeout.java:157)\n        at org.apache.hadoop.net.SocketOutputStream.write(SocketOutputStream.java:146)\n        at org.apache.hadoop.net.SocketOutputStream.write(SocketOutputStream.java:107)\n        at java.io.BufferedOutputStream.write(BufferedOutputStream.java:105)\n        - locked <0x00002aaaddaf9318> (a java.io.BufferedOutputStream)\n        at java.io.DataOutputStream.write(DataOutputStream.java:90)\n        - locked <0x00002aaaddaf92e8> (a java.io.DataOutputStream)\n        at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream$DataStreamer.run(DFSClient.java:2924)\n\n\"main\" prio=10 tid=0x00000000574e0800 nid=0x6f9a in Object.wait() [0x0000000040209000]\n   java.lang.Thread.State: WAITING (on object monitor)\n        at java.lang.Object.wait(Native Method)\n        - waiting on <0x00002aaab34b0dd0> (a java.util.LinkedList)\n        at java.lang.Object.wait(Object.java:485)\n        at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream.waitAndQueuePacket(DFSClient.java:3561)\n        - locked <0x00002aaab34b0dd0> (a java.util.LinkedList)\n        at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream.writeChunk(DFSClient.java:3620)\n        - locked <0x00002aaaddaf97a0> (a org.apache.hadoop.hdfs.DFSClient$DFSOutputStream)\n        at org.apache.hadoop.fs.FSOutputSummer.writeChecksumChunk(FSOutputSummer.java:150)\n        at org.apache.hadoop.fs.FSOutputSummer.write1(FSOutputSummer.java:100)\n        at org.apache.hadoop.fs.FSOutputSummer.write(FSOutputSummer.java:86)\n        - locked <0x00002aaaddaf97a0> (a org.apache.hadoop.hdfs.DFSClient$DFSOutputStream)\n        at org.apache.hadoop.fs.FSDataOutputStream$PositionCache.write(FSDataOutputStream.java:49)\n        at java.io.DataOutputStream.write(DataOutputStream.java:90)\n        - locked <0x00002aaaddb32eb8> (a org.apache.hadoop.fs.FSDataOutputStream)\n        at org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:68)\n        at org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:45)\n        at org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:97)\n        at org.apache.hadoop.fs.FsShell.copyFromStdin(FsShell.java:101)\n        at org.apache.hadoop.fs.FsShell.copyFromLocal(FsShell.java:127)\n        at org.apache.hadoop.fs.FsShell.run(FsShell.java:1846)\n        at org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:65)\n        at org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:79)\n        at org.apache.hadoop.fs.FsShell.main(FsShell.java:1977)\n\n======> 6 minutes later, the TCP connection itself times out, and error recovery kicks in\n\n10/01/22 16:30:33 WARN hdfs.DFSClient: Error Recovery for block blk_-5990414986184221392_1107 in pipeline 192.168.42.40:47076, 192.168.42.41:42060, 192.168.42.42:34557: bad datanode 192.168.42.41:42060\n======> and fails in some bizarre way - the writer is still writing into fs -put, but it dumps me back to my prompt\n[todd@monster01 hadoop-combined]$ \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-23T00:47:19.196+0000","updated":"2010-01-23T00:47:19.196+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446392/comment/12803971","id":"12803971","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here's the log from the localhost DN. The DN I kill -STOPed was .41 (downstream) and I never CONTed it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-23T00:48:26.435+0000","updated":"2010-01-23T00:48:26.435+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446392/comment/12803978","id":"12803978","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Looking closer, I think the crux of this issue is that the DFSClient uses HdfsConstants.WRITE_TIMEOUT to time its writes out, and this value defaults to something like 8 minutes. If the reader sees an error, it should probably interrupt() the writer, which should treat the interrupt identically to IOException.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-23T01:05:43.106+0000","updated":"2010-01-23T01:05:43.106+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446392/comment/12835048","id":"12835048","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"I agree with Todd that the default value of HdfsConstants.WRITE_TIMEOUT is somewhat in the order of 8 to 10 minutes. But this is a configurable value and you can set it lower if necessary, isn't it? If you set it to a smaller value, then does your kill -STOP experiment generate an error in the client quicker than 10 minutes?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-17T23:28:29.487+0000","updated":"2010-02-17T23:28:29.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446392/comment/12835055","id":"12835055","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"I haven't had a chance to run that test, but do you agree that, when the ResponseProcessor catches any exception, it should also interrupt the writer? It should be receiving ack heartbeats every READ_TIMEOUT/2 millis, and if it doesn't, that seems like grounds to kill off both sides of the stream.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-17T23:45:25.125+0000","updated":"2010-02-17T23:45:25.125+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446392/comment/12835061","id":"12835061","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"when I first wrote some of this code in 0.16 or so, there were subtle issues on how the client detected this failure. This was important because the client had to correctly detect which datanode in the pipeline was dead. I am unable to recollect that scenario as of now.\nBut the better way to solve this issue (as done in trunk) is for the client to send a ping message periodically, it travels all the way to the last datanode in the pipeline... the last datanode then sends an ack back which travels all the way back the client. This round-trip tests that all DataStreamers and ResponseProcessors are alive and kicking. If the ack for the ping message does not arrive, then the the client can start recovery?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-18T00:07:02.591+0000","updated":"2010-02-18T00:07:02.591+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446392/comment/12835087","id":"12835087","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. This was important because the client had to correctly detect which datanode in the pipeline was dead. I am unable to recollect that scenario as of now\n\nI think these issues were identified and fixed by HDFS-793 and HDFS-101, no?\n\nbq. But the better way to solve this issue (as done in trunk) is for the client to send a ping message periodically\n\nI agree - the pipeline heartbeats should ideally originate from the clients. In the current implementation, they originate from the last node in the pipeline, though, so at least we are detecting that each ResponseProcessor is alive. Since DataStreamer will interrupt ResponseProcessor in the case of an error, we're also indirectly verifying the DataStreamers are alive. So while end-to-end heartbeat would be a little better, the current mechanism should also work.\n\nIf the heartbeat doesn't arrive on a node in the pipeline, its reader times out. This causes an IOException which makes the ResponseProcessor shut down. But it's not interrupting the DataStreamer - instead we have to wait the much longer write timeout.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-18T01:40:06.124+0000","updated":"2010-02-18T01:40:06.124+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446392/comment/12835102","id":"12835102","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"My suggestion would be to set the timeout small of required and then see if this problem still exists in trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-18T03:08:40.390+0000","updated":"2010-02-18T03:08:40.390+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446392/comment/12848029","id":"12848029","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryanobjc","name":"ryanobjc","key":"ryanobjc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ryan rawson","active":true,"timeZone":"America/Los_Angeles"},"body":"i got this, i was doing a 3 TB distcp from a hftp:// url to the target cluster.  It was running hadoop 0.20.1+169.56, with patches of HDFS-200, HDFS-826 as well.\n\nnothing super interesting in the logs, just:\n\njava.net.SocketTimeoutException: 480000 millis timeout while waiting for channel to be ready for write. ch : java.nio.channels.SocketChannel[connected local=/10.10.21.27:50010 remote=/10.10.21.17:33970]\n        at org.apache.hadoop.net.SocketIOWithTimeout.waitForIO(SocketIOWithTimeout.java:246)\n        at org.apache.hadoop.net.SocketOutputStream.waitForWritable(SocketOutputStream.java:159)\n        at org.apache.hadoop.net.SocketOutputStream.transferToFully(SocketOutputStream.java:198)\n        at org.apache.hadoop.hdfs.server.datanode.BlockSender.sendChunks(BlockSender.java:313)\n        at org.apache.hadoop.hdfs.server.datanode.BlockSender.sendBlock(BlockSender.java:401)\n        at org.apache.hadoop.hdfs.server.datanode.DataXceiver.readBlock(DataXceiver.java:180)\n        at org.apache.hadoop.hdfs.server.datanode.DataXceiver.run(DataXceiver.java:95)\n        at java.lang.Thread.run(Thread.java:619)\n\nand errors in my distcp job every now and again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryanobjc","name":"ryanobjc","key":"ryanobjc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ryan rawson","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-03-22T04:10:46.238+0000","updated":"2010-03-22T04:10:46.238+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446392/comment/13229571","id":"13229571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here's a patch that we've tested for a long time in an 0.20-based build. We need to re-investigate this to see if it's still relevant for branch-1 and trunk, as well as add a test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-03-14T20:11:56.079+0000","updated":"2012-03-14T20:11:56.079+0000"}],"maxResults":10,"total":10,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-915/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i02sh3:"}}