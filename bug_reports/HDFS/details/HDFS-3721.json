{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12600066","self":"https://issues.apache.org/jira/rest/api/2/issue/12600066","key":"HDFS-3721","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12322472","id":"12322472","description":"2.0.2-alpha release","name":"2.0.2-alpha","archived":false,"released":true,"releaseDate":"2012-10-09"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-07-25T06:43:51.208+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 09 22:44:58 UTC 2012","customfield_12310420":"240974","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_1361396823_*|*_1_*:*_1_*:*_23176031_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-08-09T21:34:27.427+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-3721/watchers","watchCount":14,"isWatching":false},"created":"2012-07-24T20:58:14.620+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12320353","id":"12320353","description":"hadoop-2.0.0-alpha release","name":"2.0.0-alpha","archived":false,"released":true,"releaseDate":"2012-05-23"}],"issuelinks":[{"id":"12355463","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12355463","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"inwardIssue":{"id":"12439560","key":"HDFS-744","self":"https://issues.apache.org/jira/rest/api/2/issue/12439560","fields":{"summary":"Support hsync in HDFS","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21141&avatarType=issuetype","name":"New Feature","subtask":false,"avatarId":21141}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-10-11T17:46:20.514+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312927","id":"12312927","name":"datanode"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312928","id":"12312928","name":"hdfs-client"}],"timeoriginalestimate":null,"description":"HDFS-744 added support for hsync to the data transfer wire protocol. However, it actually broke wire compatibility: if the client has hsync support but the server does not, the client cannot read or write data on the old cluster.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12540129","id":"12540129","filename":"hdfs-3721.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-09T21:28:15.421+0000","size":59217,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12540129/hdfs-3721.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12539159","id":"12539159","filename":"hdfs-3721.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-04T20:15:09.065+0000","size":59821,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12539159/hdfs-3721.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12537798","id":"12537798","filename":"hdfs-3721.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-07-25T03:24:15.411+0000","size":54352,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12537798/hdfs-3721.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"4982","customfield_12312823":null,"summary":"hsync support broke wire compatibility","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13421751","id":"13421751","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"The issue here is the following code:\n{code}\n  /** Header size for a packet */\n  private static final int PROTO_SIZE = \n    PacketHeaderProto.newBuilder()\n      .setOffsetInBlock(0)\n      .setSeqno(0)\n      .setLastPacketInBlock(false)\n      .setDataLen(0)\n      .setSyncBlock(false)\n      .build().getSerializedSize();\n  public static final int PKT_HEADER_LEN =\n    6 + PROTO_SIZE;\n{code}\n\nSince the new {{syncBlock}} flag is optional, this caused the packet header to become variable-length depending on whether the client is post-hsync or not. This screws up the datanode, resulting in an exception:\n{code}\n12/07/24 13:55:45 INFO datanode.DataNode: Exception in receiveBlock for BP-2093170007-127.0.0.1-1342943513882:blk_3332306339985613438_1008\njava.io.IOException: Data remaining in packet does not matchsum of checksumLen and dataLen  size remaining: 22 data len: 20 checksum Len: 4\n        at org.apache.hadoop.hdfs.server.datanode.BlockReceiver.receivePacket(BlockReceiver.java:595)\n        at org.apache.hadoop.hdfs.server.datanode.BlockReceiver.receivePacket(BlockReceiver.java:532)\n        at org.apache.hadoop.hdfs.server.datanode.BlockReceiver.receiveBlock(BlockReceiver.java:748)\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-07-24T21:00:07.460+0000","updated":"2012-07-24T21:00:07.460+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13421779","id":"13421779","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"This also affects the read path, since it uses the same packet header as well assuming it's fixed size.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-07-24T21:30:43.887+0000","updated":"2012-07-24T21:30:43.887+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13421923","id":"13421923","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"I have a fix for this, that rewrites BlockReceiver and RemoteBlockReader2 to handle variable-length packet headers. Unfortunately, since it modifies the server side, it still doesn't allow a new client to write to an old server (just read).\n\nI'm trying to think of a creative way to fix this issue -- perhaps adding a flag in the response to \"writeBlock\" which indicates {{supportsVariableLengthPacketHeader}}. If the flag isn't set, then hsync wouldn't be supported on this stream, and it would fall back to the old fixed format header.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-07-25T01:24:05.707+0000","updated":"2012-07-25T01:24:05.707+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13421971","id":"13421971","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"This patch fixes the issue as follows:\n- Refactors out the packet-reading code from BlockReceiver and RemoteBlockReader2 into a new {{PacketReceiver}} class. This really simplified BlockReceiver in particular, and has the nice side effect of getting us significantly closer to HDFS-3529.\n- All places where we used to assume a fixed-length packet header now support variable length. In some cases this is achieved by allocating a larger-than-necessary buffer and then, once we know the size for the header, putting it at the right spot to make the header contiguous with the data. In other cases, this is achieved by simply separating the buffer containing the header from the buffer containing the data.\n\n- Regarding the issue above with 2.1 clients writing to 2.0 servers, I fixed the issue by having the PacketHeader class not set any value for the {{syncBlock}} flag when it is false. That means that, so long as the new hsync functionality isn't used, new clients can still talk to 2.0 servers. If hsync is used, an error will occur. It's slightly unfortunate, but given that the 2.0 branch is pretty new, and this is a new feature. I think this is acceptable.\n\nI manually tested a trunk client both reading and writing from a 2.0.0-alpha cluster with this patch applied.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-07-25T03:24:15.612+0000","updated":"2012-07-25T03:24:15.612+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13421972","id":"13421972","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"(I should also note that, even with this patch, a 2.0 client can still talk to a trunk cluster, since the server now properly handles variable-length headers)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-07-25T03:25:05.907+0000","updated":"2012-07-25T03:25:05.907+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13422038","id":"13422038","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12537798/hdfs-3721.txt\n  against trunk revision .\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:\n\n                  org.apache.hadoop.hdfs.TestFileConcurrentReader\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/2902//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/2902//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-25T06:43:51.208+0000","updated":"2012-07-25T06:43:51.208+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13422444","id":"13422444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"Todd, I will review this in a couple of days. Looking at the issue briefly, this is only an issue with DataTransferProtocol, due to packet header length. It should not happen in RPC right? I would be good to review RPC code once more to confirm it.\n\nIn a related note, we should think about what backward/forward compatibility for an alpha release means and how to handle it when we find issues.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-25T17:38:05.716+0000","updated":"2012-07-25T17:38:05.716+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13422575","id":"13422575","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. Todd, I will review this in a couple of days. Looking at the issue briefly, this is only an issue with DataTransferProtocol, due to packet header length. It should not happen in RPC right? I would be good to review RPC code once more to confirm it.\n\nI think RPC is basically sound. I've done diffs of the protobufs between trunk and 2.0 and all the changes look compatible. This was just a special case because, when I did the original PB-ification, I took the simpler route of maintaining fixed-length headers. Then I overlooked the bit of HDFS-744 which made the header non-fixed-width (oops).\n\nbq. In a related note, we should think about what backward/forward compatibility for an alpha release means and how to handle it when we find issues.\n\nIn that case, I'd also like to consider whether we can promote the HDFS side of 2.0.x to \"beta\". We've seen very few issues after extensive testing. I don't want the alpha state of MR2 to hold back stability classification of HDFS, which is important for those users who aren't using MR2. But that's probably better suited for a mailing list discussion.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-07-25T20:19:40.188+0000","updated":"2012-07-25T20:19:40.188+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13422835","id":"13422835","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lhofhansl","name":"lhofhansl","key":"lhofhansl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Hofhansl","active":true,"timeZone":"Etc/UTC"},"body":"What sort of wire-compatibility are we talking about? Both trunk and 2.0 have the hsync code. What sort of old cluster would not have this? Does the 2.x.x client support communicating with a 1.x.x cluster?\n\nApologies for introducing this with my patch in HDFS-744, I had assumed protobuf will take care of it.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lhofhansl","name":"lhofhansl","key":"lhofhansl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Hofhansl","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-26T01:59:36.212+0000","updated":"2012-07-26T01:59:36.212+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13422840","id":"13422840","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lhofhansl","name":"lhofhansl","key":"lhofhansl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Hofhansl","active":true,"timeZone":"Etc/UTC"},"body":"Oh this is a 2.1.x vs 2.0.x issue...?\nThe HDFS-744 patch is smaller than this patch, could we port that to 2.0.x?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lhofhansl","name":"lhofhansl","key":"lhofhansl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Hofhansl","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-26T02:02:47.195+0000","updated":"2012-07-26T02:02:47.195+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13423180","id":"13423180","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lhofhansl","name":"lhofhansl","key":"lhofhansl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Hofhansl","active":true,"timeZone":"Etc/UTC"},"body":"Saw Todd's comment on HDFS-744 (moving that change to 2.0.x is not an option).\nI had assumed that HDFS-744 would be in 2.0.x (in which case there would have been no compatibility issues).\n\nHad a quick look through the patch here. Looks good as far as I can tell, I'll take more detailed look later today.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lhofhansl","name":"lhofhansl","key":"lhofhansl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Hofhansl","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-26T16:11:56.710+0000","updated":"2012-07-26T16:11:56.710+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13426176","id":"13426176","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"body":"The patch looks pretty good to me, and I agree it's a good refactor to make RemoteBlockReader and RemoteBlockReader2 share some code.\n\nOne tiny nit on the code, it looks like you have some extra whitespace here:\n{code}\nif ( checksumBuf.capacity() != checksumLen) {\n{code}\n\nIt looks to me like the TestFileConcurrentReader failure is due to this patch. I can't recall that test being flaky, and at least on my box the test passes without this patch, but fails with it applied.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-31T22:24:27.559+0000","updated":"2012-07-31T22:24:27.559+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13426182","id":"13426182","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"Todd, I meant to review this. But the code refactoring, even though it is a good idea, has made the review difficult. Given that I may not be able to get though my code review in a short period of time, here are the comments I had accumulated based on my review so far:\n\n\n# DFSOutputStream.java\n#* Packet consturctor, can you please add javadoc (especially to describe pktSize)\n#* Math in computePacketChunkSize seems correct, but it results in different value from previous code.\n# PacketReceiver.java\n#* Make #bufferPool final\n# PacketHeader.java\n#* Builder import not used\n#* Please add javadoc on PacketHeader structure\n#* BlockSender.java javadoc could just point to the javadoc of PacketHeader for header information. We have this in multiple places.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-31T22:33:18.208+0000","updated":"2012-07-31T22:36:48.439+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13426183","id":"13426183","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"Also there are bunch of empty line additions in the patch that could be removed (in DFSOutputStream.java, RemoteBlockReader2.java etc.).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-31T22:34:09.793+0000","updated":"2012-07-31T22:34:09.793+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13428673","id":"13428673","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"body":"Todd's been busy with some other stuff so I'm going to take over working on this issue.\n\nAttached is an updated patch which addresses Suresh's and my feedback.\n\nDuring testing, I also discovered that Todd's original patch introduced some unfortunate interaction with Nagle's algorithm in TCP for small packets during writing. This was the cause of the TestFileConcurrentReader failure. So, in addition to addressing the feedback, this patch also changes DFSOutputStream.Packet#writeTo back to only ever call OutputStream#write once, by ensuring that the packet header, checksum data, and actual data are all in a single contiguous buffer, similarly to how it was done before this patch.\n\nThe functional difference between this patch and the last is the following, to make review easier:\n\n{code}\ncommit 61fe911e60fe4db710813fc97a209456722ef1f7\nAuthor: Aaron T. Myers <atm@cloudera.com>\nDate:   Sat Aug 4 12:32:11 2012 -0700\n\n    Send one buffer when writing to avoid nagling.\n\ndiff --git hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java\nindex e460a3c..4582712 100644\n--- hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java\n+++ hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java\n@@ -147,10 +147,17 @@ public class DFSOutputStream extends FSOutputSummer implements Syncable {\n      * buf is pointed into like follows:\n      *  (C is checksum data, D is payload data)\n      *\n-     * [CCCCCCCCC________________DDDDDDDDDDDDDDDD___]\n-     *           ^               ^               ^\n-     *           checksumPos     dataStart       dataPos\n+     * [_________CCCCCCCCC________________DDDDDDDDDDDDDDDD___]\n+     *           ^        ^               ^               ^\n+     *           |        checksumPos     dataStart       dataPos\n+     *           checksumStart\n+     * \n+     * Right before sending, we move the checksum data to immediately precede\n+     * the actual data, and then insert the header into the buffer immediately\n+     * preceding the checksum data, so we make sure to keep enough space in\n+     * front of the checksum data to support the largest conceivable header. \n      */\n+    int checksumStart;\n     int checksumPos;\n     int dataStart;\n     int dataPos;\n@@ -166,9 +173,9 @@ public class DFSOutputStream extends FSOutputSummer implements Syncable {\n       this.offsetInBlock = 0;\n       this.seqno = HEART_BEAT_SEQNO;\n       \n-      buf = new byte[0];\n+      buf = new byte[PacketHeader.PKT_MAX_HEADER_LEN];\n       \n-      checksumPos = dataPos = dataStart = 0;\n+      checksumStart = checksumPos = dataPos = dataStart = PacketHeader.PKT_MAX_HEADER_LEN;\n       maxChunks = 0;\n     }\n     \n@@ -180,10 +187,11 @@ public class DFSOutputStream extends FSOutputSummer implements Syncable {\n       this.seqno = currentSeqno;\n       currentSeqno++;\n       \n-      buf = new byte[pktSize];\n+      buf = new byte[PacketHeader.PKT_MAX_HEADER_LEN + pktSize];\n       \n-      checksumPos = 0;\n-      dataStart = chunksPerPkt * checksum.getChecksumSize();\n+      checksumStart = PacketHeader.PKT_MAX_HEADER_LEN;\n+      checksumPos = checksumStart;\n+      dataStart = checksumStart + (chunksPerPkt * checksum.getChecksumSize());\n       dataPos = dataStart;\n       maxChunks = chunksPerPkt;\n     }\n@@ -205,19 +213,38 @@ public class DFSOutputStream extends FSOutputSummer implements Syncable {\n     }\n     \n     /**\n-     * Returns ByteBuffer that contains one full packet, including header.\n+     * Write the full packet, including the header, to the given output stream.\n      */\n     void writeTo(DataOutputStream stm) throws IOException {\n-      int dataLen = dataPos - dataStart;\n-      int checksumLen = checksumPos;\n-      int pktLen = HdfsConstants.BYTES_IN_INTEGER + dataLen + checksumLen;\n+      final int dataLen = dataPos - dataStart;\n+      final int checksumLen = checksumPos - checksumStart;\n+      final int pktLen = HdfsConstants.BYTES_IN_INTEGER + dataLen + checksumLen;\n \n       PacketHeader header = new PacketHeader(\n         pktLen, offsetInBlock, seqno, lastPacketInBlock, dataLen, syncBlock);\n       \n-      header.write(stm);\n-      stm.write(buf, 0, checksumLen);\n-      stm.write(buf, dataStart, dataLen);\n+      if (checksumPos != dataStart) {\n+        // Move the checksum to cover the gap. This can happen for the last\n+        // packet or during an hflush/hsync call.\n+        System.arraycopy(buf, checksumStart, buf, \n+                         dataStart - checksumLen , checksumLen); \n+        checksumPos = dataStart;\n+        checksumStart = checksumPos - checksumLen;\n+      }\n+      \n+      final int headerStart = checksumStart - header.getSerializedSize();\n+      assert checksumStart + 1 >= header.getSerializedSize();\n+      assert checksumPos == dataStart;\n+      assert headerStart >= 0;\n+      assert headerStart + header.getSerializedSize() == checksumStart;\n+      \n+      // Copy the header data into the buffer immediately preceding the checksum\n+      // data.\n+      System.arraycopy(header.getBytes(), 0, buf, headerStart,\n+          header.getSerializedSize());\n+      \n+      // Write the now contiguous full packet to the output stream.\n+      stm.write(buf, headerStart, header.getSerializedSize() + checksumLen + dataLen);\n     }\n     \n     // get the packet's last byte's offset in the block\ndiff --git hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/PacketHeader.java hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/PacketHeader.java\nindex 1709101..dd56962 100644\n--- hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/PacketHeader.java\n+++ hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/PacketHeader.java\n@@ -166,6 +166,12 @@ public class PacketHeader {\n     out.writeShort(proto.getSerializedSize());\n     proto.writeTo(out);\n   }\n+  \n+  public byte[] getBytes() {\n+    ByteBuffer buf = ByteBuffer.allocate(getSerializedSize());\n+    putInBuffer(buf);\n+    return buf.array();\n+  }\n \n   /**\n    * Perform a sanity check on the packet, returning true if it is sane.\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-04T20:15:09.097+0000","updated":"2012-08-04T20:15:09.097+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13428687","id":"13428687","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12539159/hdfs-3721.txt\n  against trunk revision .\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    -1 tests included.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 eclipse:eclipse.  The patch built with eclipse:eclipse.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.\n\n    +1 contrib tests.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/2956//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/2956//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2012-08-04T22:03:00.159+0000","updated":"2012-08-04T22:03:00.159+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13430663","id":"13430663","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"+1 to your fixups of my patch. Thanks Aaron for taking this over.\n\nI also wanted to double-check the performance, so I made some modifications to TestMultithreadedHFlush to calculate latency percentiles. Here are the results I got:\n\n{code}\nBefore patch (trunk):\n\nLatency quantiles (in microseconds):\n50.00 %ile +/- 5.00%: 531\n75.00 %ile +/- 2.50%: 669\n90.00 %ile +/- 1.00%: 960\n95.00 %ile +/- 0.50%: 1273\n99.00 %ile +/- 0.10%: 2822\n\nMy earlier broken patch:\nLatency quantiles (in microseconds):\n50.00 %ile +/- 5.00%: 40090\n75.00 %ile +/- 2.50%: 40921\n90.00 %ile +/- 1.00%: 42837\n95.00 %ile +/- 0.50%: 44027\n99.00 %ile +/- 0.10%: 49937\n\nAaron's patch:\nLatency quantiles (in microseconds):\n50.00 %ile +/- 5.00%: 556\n75.00 %ile +/- 2.50%: 697\n90.00 %ile +/- 1.00%: 982\n95.00 %ile +/- 0.50%: 1303\n99.00 %ile +/- 0.10%: 2789\n{code}\n\nIn other words, the performance after this patch is comparable to the performance before, and indeed the performance of my earlier patch was a mess due to the 40ms nagling delay. This patch is also going to help performance in the future since it gets us a lot closer to the direct-buf based write path by simplifying the code.\n\nI'll upload the modifications to TestMultithreadedHFlush as a new JIRA, since it was useful in verifying this performance.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-08-07T22:01:18.272+0000","updated":"2012-08-07T22:01:18.272+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13430818","id":"13430818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks a lot for verifying that this patch introduces no performance regressions, Todd.\n\nSince I've reviewed Todd's original patch and addressed Suresh's feedback, and since Todd has reviewed the functional difference between his original patch and the one I posted, I'd like to go ahead and commit this patch. Unless I hear something in the next day or so, I'm going to go ahead and commit this, so please post your feedback promptly if you intend to review it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-08T02:44:19.389+0000","updated":"2012-08-08T02:44:19.389+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13432170","id":"13432170","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"body":"Here's a patch that's rebased on trunk.\n\nSince I haven't heard anything for a few days, I'm going to go ahead and commit this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-09T21:28:15.454+0000","updated":"2012-08-09T21:28:15.454+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13432178","id":"13432178","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"body":"I've just committed this to trunk and branch-2.\n\nThanks a lot for the contribution, Todd, and thanks to everyone else for the discussion of this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atm","name":"atm","key":"atm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=atm&avatarId=14136","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=atm&avatarId=14136","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=atm&avatarId=14136","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=atm&avatarId=14136"},"displayName":"Aaron T. Myers","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-09T21:34:27.458+0000","updated":"2012-08-09T21:34:27.458+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13432234","id":"13432234","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hadoop-Mapreduce-trunk-Commit #2589 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Commit/2589/])\n    HDFS-3721. hsync support broke wire compatibility. Contributed by Todd Lipcon and Aaron T. Myers. (Revision 1371495)\n\n     Result = FAILURE\natm : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1371495\nFiles : \n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/RemoteBlockReader2.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/PacketHeader.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/PacketReceiver.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BlockReceiver.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BlockSender.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2012-08-09T22:26:47.933+0000","updated":"2012-08-09T22:26:47.933+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13432253","id":"13432253","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hadoop-Hdfs-trunk-Commit #2634 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Commit/2634/])\n    HDFS-3721. hsync support broke wire compatibility. Contributed by Todd Lipcon and Aaron T. Myers. (Revision 1371495)\n\n     Result = SUCCESS\natm : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1371495\nFiles : \n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/RemoteBlockReader2.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/PacketHeader.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/PacketReceiver.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BlockReceiver.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BlockSender.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2012-08-09T22:40:07.907+0000","updated":"2012-08-09T22:40:07.907+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12600066/comment/13432261","id":"13432261","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hadoop-Common-trunk-Commit #2569 (See [https://builds.apache.org/job/Hadoop-Common-trunk-Commit/2569/])\n    HDFS-3721. hsync support broke wire compatibility. Contributed by Todd Lipcon and Aaron T. Myers. (Revision 1371495)\n\n     Result = SUCCESS\natm : http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&view=rev&rev=1371495\nFiles : \n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/DFSOutputStream.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/RemoteBlockReader2.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/PacketHeader.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/protocol/datatransfer/PacketReceiver.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BlockReceiver.java\n* /hadoop/common/trunk/hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BlockSender.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2012-08-09T22:44:58.952+0000","updated":"2012-08-09T22:44:58.952+0000"}],"maxResults":23,"total":23,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-3721/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i017hj:"}}