{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13160156","self":"https://issues.apache.org/jira/rest/api/2/issue/13160156","key":"HDFS-13585","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Jun 09 00:07:22 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13585/watchers","watchCount":3,"isWatching":false},"created":"2018-05-17T21:04:23.720+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341257","id":"12341257","description":"2.7.5 release","name":"2.7.5","archived":false,"released":true,"releaseDate":"2017-12-14"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-07-02T17:45:47.447+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324906","id":"12324906","name":"native"}],"timeoriginalestimate":null,"description":"We are using libhdfs for hdfs support from our native library. This has been working mostly fine with Java/Spark applications, but some of them throw a SIGSEGV in hdfsThreadDestructor(). We tried to dynamically load and unload libhdfs.so using dlopen/dlclose but to no avail and we still see the seg fault. Is this a known issue? Looks like thread local storage is involved, are there workarounds? \r\n\r\n \r\n\r\nHere is a call stack from gdb java <core file>\r\n(gdb) bt\r\n#0 0x00007f3333ad21f7 in raise () from /usr/lib64/libc.so.6\r\n#1 0x00007f3333ad38e8 in abort () from /usr/lib64/libc.so.6\r\n#2 0x00007f3333380259 in os::abort(bool) () from /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre/lib/amd64/server/libjvm.so\r\n#3 0x00007f3333585986 in VMError::report_and_die() () from /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre/lib/amd64/server/libjvm.so\r\n#4 0x00007f3333389ec7 in JVM_handle_linux_signal () from /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre/lib/amd64/server/libjvm.so\r\n#5 0x00007f333337d678 in signalHandler(int, siginfo_t*, void*) () from /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre/lib/amd64/server/libjvm.so\r\n#6 <signal handler called>\r\n#7 0x00007f3333341e66 in Monitor::ILock(Thread*) () from /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre/lib/amd64/server/libjvm.so\r\n#8 0x00007f33333428f6 in Monitor::lock_without_safepoint_check() () from /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre/lib/amd64/server/libjvm.so\r\n#9 0x00007f333358bc21 in VM_Exit::wait_if_vm_exited() () from /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre/lib/amd64/server/libjvm.so\r\n#10 0x00007f333314fee5 in jni_DetachCurrentThread () from /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre/lib/amd64/server/libjvm.so\r\n#11 0x00007f32f2645f15 in hdfsThreadDestructor (v=0x7f332c018bc8)\r\n at /home/kshvachk/Work/Hadoop/hadoop/hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/os/posix/thread_local_storage.c:49\r\n#12 0x00007f3334490c22 in __nptl_deallocate_tsd () from /usr/lib64/libpthread.so.0\r\n#13 0x00007f3334490e33 in start_thread () from /usr/lib64/libpthread.so.0\r\n#14 0x00007f3333b9534d in clone () from /usr/lib64/libc.so.6","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"libhdfs SIGSEGV during shutdown of Java application.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nganapati","name":"nganapati","key":"nganapati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nalini Ganapati","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nganapati","name":"nganapati","key":"nganapati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nalini Ganapati","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Centos 7\r\ngcc (GCC) 4.9.2 20150212 (Red Hat 4.9.2-6)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13160156/comment/16506720","id":"16506720","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nganapati","name":"nganapati","key":"nganapati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nalini Ganapati","active":true,"timeZone":"America/Los_Angeles"},"body":"This is critical for us to be fixed. Basically, the crash shows up when there are multiple native libraries using JNI in the same application. In our case, this was from gatk([https://github.com/broadinstitute/gatk)] that packages numerous jars with some having embedded native libraries. We worked around this issue by rewriting hdfsThreadDestructor in hadoop/hadoop-hdfs-project/hadoop-hdfs/src/main/native/libhdfs/os/posix/thread_local_storage.c\r\n\r\nstatic void hdfsThreadDestructor(void *v)\r\n {\r\n   JavaVM *vm;\r\n   JNIEnv *env = v;\r\n   jint ret;\r\n\r\n  ret = (*env)->GetJavaVM(env, &vm);\r\n   if (ret)\r\n\r\n{     fprintf(stderr, \"hdfsThreadDestructor: GetJavaVM failed with error %d\\n\",     ret);     (*env)->ExceptionDescribe(env);   }\r\n\r\nelse {\r\n     *// Buggy JVM support, DetachCurrentThread throws exceptions sometimes.*\r\n     *// Workaround is to try to AttachCurrentThread as it is a noop if the*\r\n     *// Thread is already attached.*\r\n     *ret = (*vm)->AttachCurrentThread(vm, (void**)&env, 0);\r\n     *if (ret == JNI_OK) {*\r\n       (**vm)->DetachCurrentThread(vm);*\r\n     *}*\r\n   }\r\n }\r\n\r\n \r\n\r\nIs there any possibility of getting this issue fixed soon?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nganapati","name":"nganapati","key":"nganapati","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nalini Ganapati","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-09T00:07:22.659+0000","updated":"2018-07-02T17:45:47.439+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13585/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3tutb:"}}