{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12508050","self":"https://issues.apache.org/jira/rest/api/2/issue/12508050","key":"HDFS-1982","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2011-05-30T19:04:39.057+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue May 31 08:26:58 UTC 2011","customfield_12310420":"15288","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_119800188673_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-03-10T03:00:48.661+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-1982/watchers","watchCount":3,"isWatching":false},"created":"2011-05-23T13:11:00.025+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315103","id":"12315103","description":"Append/sync support for Hadoop 0.20","name":"0.20-append","archived":true,"released":false}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-03-10T03:00:48.693+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312926","id":"12312926","name":"namenode"}],"timeoriginalestimate":null,"description":"Conisder the following scenario. \nWE have a cluster with one NN and 2 DN.\n\nWe write some file.\n\nOne of the block is written in DN1 but not yet completed in DN2 local disk.\n\nNow DN1 gets killed and so pipeline recovery happens for the block with the size as in DN2 but the generation stamp gets updated in the NN.\n\nDN2 also gets killed.\n\nNow restart NN and DN1\nNow if NN restarts, the block that NN has greater time stamp but the size is lesser in the NN.\n\nThis leads to Null pointer exception in addstoredblock api\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"113737","customfield_12312823":null,"summary":"Null pointer exception is thrown when NN restarts with a block lesser in size than the block that is present in DN1 but the generation stamp is greater in the NN ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ram_krish","name":"ram_krish","key":"ram_krish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ramkrishna.s.vasudevan","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ram_krish","name":"ram_krish","key":"ram_krish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ramkrishna.s.vasudevan","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12508050/comment/13041236","id":"13041236","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"Theoretically, this seems plausible. are you experiencing it? do u have a unit test that I can use to reliably reproduce this problem?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2011-05-30T19:04:39.057+0000","updated":"2011-05-30T19:04:39.057+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12508050/comment/13041480","id":"13041480","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ram_krish","name":"ram_krish","key":"ram_krish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ramkrishna.s.vasudevan","active":true,"timeZone":"Asia/Kolkata"},"body":"{noformat}\npackage org.apache.hadoop.hdfs.server.namenode;\n\nimport static org.junit.Assert.assertTrue;\n\nimport java.io.IOException;\nimport java.io.OutputStream;\nimport java.util.ArrayList;\nimport java.util.List;\n\nimport org.apache.hadoop.conf.Configuration;\nimport org.apache.hadoop.fs.FSDataOutputStream;\nimport org.apache.hadoop.fs.FileSystem;\nimport org.apache.hadoop.fs.Path;\nimport org.apache.hadoop.hdfs.MiniDFSCluster;\nimport org.apache.hadoop.hdfs.protocol.Block;\nimport org.apache.hadoop.hdfs.protocol.LocatedBlock;\nimport org.apache.hadoop.hdfs.protocol.LocatedBlocks;\nimport org.junit.Test;\n\npublic class TestAddStoredBlockForNPE {\n  \n  @Test\n  public void testaddStoredBlockShouldInvalidateStaleBlock() throws Exception {\n    MiniDFSCluster cluster = null;\n    List<String> list = new ArrayList<String>();\n    list.add(\"test\");\n    try {\n      Configuration conf = new Configuration();\n      conf.setInt ( \"dfs.block.size\", 1024 );\n      cluster = new MiniDFSCluster(conf, 2, true, null);\n      FileSystem dfs = cluster.getFileSystem();\n      String fname = \"/test\";\n      FSDataOutputStream fsdataout = dfs.create(new Path(fname));\n      int fileLen = 10 * 1024+94;\n      write(fsdataout, 0, fileLen);\n      FSNamesystem namesystem = cluster.getNameNode().namesystem;\n\n      LocatedBlocks blockLocations = cluster.getNameNode().getBlockLocations(\n\t  fname, 0, fileLen);\n      List<LocatedBlock> blockList = blockLocations.getLocatedBlocks();\n      Block block = blockList.get(blockList.size() - 1).getBlock();\n \n      Block block1 = new Block();\n      block1.setBlockId(block.getBlockId());\n      block1.setGenerationStamp(block.getGenerationStamp() - 10);\n      block1.setNumBytes(block.getNumBytes() + 10);\n\n      namesystem.blockReceived(cluster.getDataNodes().get(1).dnRegistration,\n\t  block1, null);\n      dfs.close();\n      list.remove(0);\n    }\n\n    finally {\n      if (null != cluster) {\n\tcluster.shutdown();\n\t\n      }\n      assertTrue(\"The flow should have executed without nullpointer exception\",\n\t  list.size() == 0);\n    }\n  }\n\n  private static void write(OutputStream out, int offset, int length)\n      throws IOException {\n    final byte[] bytes = new byte[length];\n    for (int i = 0; i < length; i++) {\n      bytes[i] = (byte) (offset + i);\n    }\n    out.write(bytes);\n  }\n}\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ram_krish","name":"ram_krish","key":"ram_krish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ramkrishna.s.vasudevan","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-05-31T08:25:04.730+0000","updated":"2011-05-31T08:25:04.730+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12508050/comment/13041481","id":"13041481","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ram_krish","name":"ram_krish","key":"ram_krish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ramkrishna.s.vasudevan","active":true,"timeZone":"Asia/Kolkata"},"body":"In this \nif (storedBlock != null\n\t  && storedBlock.getINode() != null\n\t  && (storedBlock.getGenerationStamp() <= block.getGenerationStamp() || storedBlock\n\t      .getINode().isUnderConstruction()))\nWhat is the significance to check if INode is under construction?\nOnly the generationtimestamp check may be enough?\n\nKindly provide your comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ram_krish","name":"ram_krish","key":"ram_krish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ramkrishna.s.vasudevan","active":true,"timeZone":"Asia/Kolkata"},"created":"2011-05-31T08:26:58.518+0000","updated":"2011-05-31T08:26:58.518+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-1982/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0jto7:"}}