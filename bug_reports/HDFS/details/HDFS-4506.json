{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12632676","self":"https://issues.apache.org/jira/rest/api/2/issue/12632676","key":"HDFS-4506","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2013-02-18T04:29:18.359+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Nov 21 23:36:13 UTC 2013","customfield_12310420":"313172","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-4506/watchers","watchCount":9,"isWatching":false},"created":"2013-02-16T00:12:04.520+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321656","id":"12321656","description":"maintenance release on branch-1.1","name":"1.1.1","archived":false,"released":true,"releaseDate":"2012-11-27"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-11-21T23:36:13.130+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312928","id":"12312928","name":"hdfs-client"}],"timeoriginalestimate":null,"description":"We found a case, where if the short circuit user name is configured correctly, but the user does not have enough permissions in unix, DFS operations fails with IOException, rather than silently failing over through datanode. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"313518","customfield_12312823":null,"summary":"In branch-1, HDFS short circuit fails non-transparently when user does not have unix permissions","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12632676/comment/13579619","id":"13579619","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"body":"This causes the HBase region server to fail: \n{code}\n13/02/15 15:23:14 INFO hdfs.DFSClient: Failed to read block blk_-4320583063454486173_1019 on local machinejava.io.FileNotFoundException: /tmp/hadoop-enis/dfs/data/current/blk_-4320583063454486173 (Permission denied)\n\tat java.io.FileInputStream.open(Native Method)\n\tat java.io.FileInputStream.<init>(FileInputStream.java:120)\n\tat org.apache.hadoop.hdfs.BlockReaderLocal.newBlockReader(BlockReaderLocal.java:149)\n\tat org.apache.hadoop.hdfs.DFSClient.getLocalBlockReader(DFSClient.java:358)\n\tat org.apache.hadoop.hdfs.DFSClient.access$800(DFSClient.java:74)\n\tat org.apache.hadoop.hdfs.DFSClient$DFSInputStream.blockSeekTo(DFSClient.java:2073)\n\tat org.apache.hadoop.hdfs.DFSClient$DFSInputStream.read(DFSClient.java:2224)\n\tat java.io.DataInputStream.read(DataInputStream.java:132)\n\tat org.apache.hadoop.io.IOUtils.readFully(IOUtils.java:153)\n\tat org.apache.hadoop.hbase.io.hfile.HFileBlock$AbstractFSReader.readAtOffset(HFileBlock.java:1409)\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-02-16T00:13:26.643+0000","updated":"2013-02-16T00:13:26.643+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12632676/comment/13580406","id":"13580406","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgong%40vmware.com","name":"mgong@vmware.com","key":"mgong@vmware.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10453","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10453","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10453","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10453"},"displayName":"meng gong","active":true,"timeZone":"Asia/Shanghai"},"body":"I can't reproduce this issue with source code of branch-1.\nThe FileNotFoundException will be catched as an IOException.\nCan you give out more logs or environment details?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgong%40vmware.com","name":"mgong@vmware.com","key":"mgong@vmware.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10453","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10453","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10453","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10453"},"displayName":"meng gong","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-02-18T04:29:18.359+0000","updated":"2013-02-18T04:29:18.359+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12632676/comment/13581579","id":"13581579","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"body":"I've tested this with hadoop-1.1.2-rc5. \nTo repro, you can do smt like this: \n - start hadoop with user hadoop. configure short circuit reads for user hbase. \n{code}\n<property>\n        <name>dfs.block.local-path-access.user</name>\n        <value>hbase</value>\n    </property>\n{code}\n - configure hbase to use shortcircuit. \n{code}\n<property>\n    <name>dfs.client.read.shortcircuit</name>\n    <value>true</value>\n  </property>\n{code}\n - ensure that user \"hbase\" does not have access perms to local block files. \n{code}\n$ su - hadoop\n$ chmod 700 -R ${dfs.data.dir}\n$ su - hbase\n$ ls -la /tmp/hadoop-enis/dfs/data/current/\nls: cannot open directory /tmp/hadoop-enis/dfs/data/current/: Permission denied\n{code}\n- start hbase in local mode. \n\nI think from inspecting the logs, the problem is that we catch the IOE in DFSClient.blockSeekTo(), but not in fetchBlockByteRange(). When we get ACE, we disable shortCircuit reads, but not on IOE, which also causes us to retry again and again to read locally. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=enis","name":"enis","key":"enis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enis Soztutar","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-02-19T20:03:29.544+0000","updated":"2013-02-19T20:03:29.544+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12632676/comment/13829474","id":"13829474","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sarutak","name":"sarutak","key":"sarutak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sarutak&avatarId=20842","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sarutak&avatarId=20842","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sarutak&avatarId=20842","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sarutak&avatarId=20842"},"displayName":"Kousuke Saruta","active":true,"timeZone":"Asia/Tokyo"},"body":"getLocalBLockReader calls BlockReaderLocal.newBlockReader and newBlockReader accesses local file. When we access local files with FileInputStream ( and subclasses ) without proper permission, FileNotFoundException will be thrown. So, can we modify like as follows?\n\n{code}\n  private BlockReader getLocalBlockReader(Configuration conf,\n      String src, Block blk, Token<BlockTokenIdentifier> accessToken,\n      DatanodeInfo chosenNode, int socketTimeout, long offsetIntoBlock)\n      throws InvalidToken, IOException {\n    try {\n      return BlockReaderLocal.newBlockReader(conf, src, blk, accessToken,\n          chosenNode, socketTimeout, offsetIntoBlock, blk.getNumBytes()\n              - offsetIntoBlock, connectToDnViaHostname);\n-    } catch (RemoteException re) {\n-      throw re.unwrapRemoteException(InvalidToken.class,\n-          AccessControlException.class);\n+    } catch (FileNotFoundException fe) {\n+      throw new AcceccControlException(fe);\n+    } catch (IOException ie) {\n+      throw ie;\n     }\n   }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sarutak","name":"sarutak","key":"sarutak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=sarutak&avatarId=20842","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=sarutak&avatarId=20842","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=sarutak&avatarId=20842","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=sarutak&avatarId=20842"},"displayName":"Kousuke Saruta","active":true,"timeZone":"Asia/Tokyo"},"created":"2013-11-21T23:36:13.130+0000","updated":"2013-11-21T23:36:13.130+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-4506/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1i1lj:"}}