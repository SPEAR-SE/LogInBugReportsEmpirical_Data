{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12612783","self":"https://issues.apache.org/jira/rest/api/2/issue/12612783","key":"HDFS-4089","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2012-10-19T21:47:51.647+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Oct 26 14:27:46 UTC 2012","customfield_12310420":"250043","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-4089/watchers","watchCount":8,"isWatching":false},"created":"2012-10-19T21:26:43.055+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-10-26T14:27:46.336+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312927","id":"12312927","name":"datanode"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12316609","id":"12316609","name":"ha","description":"High Availability"}],"timeoriginalestimate":null,"description":"Hi, I stumbled upon this while trying to understand the append design recently. I am assuming when SyncBehindWrites is enabled we do indeed want to do a complete sync after each write. In that case the implementation seems wrong to me.\n\nHere's a comment from the manpage of sync_file_range on the usage of the SYNC_FILE_RANGE_WRITE flag in solitude: \"This is an asynchronous flush-to-disk operation. This is not suitable for data integrity operations.\" I don't know why this syscall is invoked here instead of just fsync","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12550083","id":"12550083","filename":"syncBehindWrites.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jkunigk","name":"jkunigk","key":"jkunigk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Jan Kunigk","active":true,"timeZone":"Etc/UTC"},"created":"2012-10-19T21:29:03.532+0000","size":825,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12550083/syncBehindWrites.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"60159","customfield_12312823":null,"summary":"SyncBehindWrites uses wrong flags on sync_file_range","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jkunigk","name":"jkunigk","key":"jkunigk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Jan Kunigk","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jkunigk","name":"jkunigk","key":"jkunigk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Jan Kunigk","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612783/comment/13480406","id":"13480406","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jkunigk","name":"jkunigk","key":"jkunigk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Jan Kunigk","active":true,"timeZone":"Etc/UTC"},"body":"I believe this patch has the appropriate flags to enforce sync semantics with the sync_file_range call","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jkunigk","name":"jkunigk","key":"jkunigk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Jan Kunigk","active":true,"timeZone":"Etc/UTC"},"created":"2012-10-19T21:29:03.534+0000","updated":"2012-10-19T21:29:03.534+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612783/comment/13480422","id":"13480422","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hi Jan. The purpose of this flag isn't for data integrity -- it's to avoid lumpy IO writeback. If you want data integrity you should be using the hsync() call after every write.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-10-19T21:47:51.647+0000","updated":"2012-10-19T21:47:51.647+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612783/comment/13481057","id":"13481057","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jkunigk","name":"jkunigk","key":"jkunigk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Jan Kunigk","active":true,"timeZone":"Etc/UTC"},"body":"Hi Todd, I only have a small tenure on HDFS, which means I don't have a history of why this feature was put there, but considering your comments it seems like the reason is performance.\n\nI personally also think syncing after every write is tremendous sacrifice to make for durability, but since the flag is called SyncBehindWrites it implies just that meaning.\nThe flag is enabled in DFSConfigKeys.java in a section called \"HA related\", so it might mislead a user/admin into believing this actually enforces synchronous IO.\n\nI'm happy to close this, but I ideally the flags should be renamed to something like WriteOutDirtyOSPages, since that is really what's done.\nThank you for your swift reply in any case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jkunigk","name":"jkunigk","key":"jkunigk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Jan Kunigk","active":true,"timeZone":"Etc/UTC"},"created":"2012-10-21T20:25:53.320+0000","updated":"2012-10-21T20:25:53.320+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612783/comment/13481063","id":"13481063","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hi Jan. The docs for this config say:\n{quote}\n        If this configuration is enabled, the datanode will instruct the\n        operating system to enqueue all written data to the disk immediately\n        after it is written. This differs from the usual OS policy which\n        may wait for up to 30 seconds before triggering writeback.\n\n        This may improve performance for some workloads by smoothing the\n        IO profile for data written to disk.\n\n        If the Hadoop native libraries are not available, this configuration\n        has no effect.\n{quote}\n\nDo you think we could improve it? In DFSConfigKeys.java, it's in a lower section than the HA-related config, though I agree we could add some more comment lines to clearly delineate the different config keys.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-10-21T20:40:00.287+0000","updated":"2012-10-21T20:40:00.287+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612783/comment/13484557","id":"13484557","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jkunigk","name":"jkunigk","key":"jkunigk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Jan Kunigk","active":true,"timeZone":"Etc/UTC"},"body":"Hi Todd, sorry the lag in my replies. I think we can improve the naming at least.\n1) I would rename the variable from SyncBehindWrites to WriteOutDirtyOSPages. Sync is misleading, since, even though the syscall is named sync_file_range, the flags that it is used with here do not entail sync semantics, i.e. a synchronous, i.e. blocking operation.\n2) I think we should mark the appropriate section in DFSConfigKeys.java as \"performance related\"\n\nThis is more an issue of hygiene and, after your explanations, no longer a concern w/r to data integrity. Thanks. \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jkunigk","name":"jkunigk","key":"jkunigk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Jan Kunigk","active":true,"timeZone":"Etc/UTC"},"created":"2012-10-25T22:54:04.199+0000","updated":"2012-10-25T22:54:04.199+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612783/comment/13484951","id":"13484951","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Sounds reasonable. Want to submit a patch? Please make sure you add the old config name as 'deprecated' here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2012-10-26T14:27:46.336+0000","updated":"2012-10-26T14:27:46.336+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-4089/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0anzj:"}}