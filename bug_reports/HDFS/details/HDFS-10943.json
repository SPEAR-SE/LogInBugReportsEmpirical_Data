{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13009031","self":"https://issues.apache.org/jira/rest/api/2/issue/13009031","key":"HDFS-10943","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-10-03T15:42:49.315+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Apr 20 22:24:58 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-10943/watchers","watchCount":23,"isWatching":false},"created":"2016-10-01T04:13:17.238+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12490281","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12490281","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13032057","key":"HDFS-11292","self":"https://issues.apache.org/jira/rest/api/2/issue/13032057","fields":{"summary":"log lastWrittenTxId etc info in logSyncAll","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12490697","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12490697","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13033188","key":"HDFS-11306","self":"https://issues.apache.org/jira/rest/api/2/issue/13033188","fields":{"summary":"Print remaining edit logs from buffer if edit log can't be rolled.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-04-20T22:24:58.534+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"Per the following trace stack:\n{code}\nFATAL org.apache.hadoop.hdfs.server.namenode.FSEditLog: Error: finalize log segment 10562075963, 10562174157 failed for required journal (JournalAndStream(mgr=QJM to [0.0.0.1:8485, 0.0.0.2:8485, 0.0.0.3:8485, 0.0.0.4:8485, 0.0.0.5:8485], stream=QuorumOutputStream starting at txid 10562075963))\njava.io.IOException: FSEditStream has 49708 bytes still to be flushed and cannot be closed.\n        at org.apache.hadoop.hdfs.server.namenode.EditsDoubleBuffer.close(EditsDoubleBuffer.java:66)\n        at org.apache.hadoop.hdfs.qjournal.client.QuorumOutputStream.close(QuorumOutputStream.java:65)\n        at org.apache.hadoop.hdfs.server.namenode.JournalSet$JournalAndStream.closeStream(JournalSet.java:115)\n        at org.apache.hadoop.hdfs.server.namenode.JournalSet$4.apply(JournalSet.java:235)\n        at org.apache.hadoop.hdfs.server.namenode.JournalSet.mapJournalsAndReportErrors(JournalSet.java:393)\n        at org.apache.hadoop.hdfs.server.namenode.JournalSet.finalizeLogSegment(JournalSet.java:231)\n        at org.apache.hadoop.hdfs.server.namenode.FSEditLog.endCurrentLogSegment(FSEditLog.java:1243)\n        at org.apache.hadoop.hdfs.server.namenode.FSEditLog.rollEditLog(FSEditLog.java:1172)\n        at org.apache.hadoop.hdfs.server.namenode.FSImage.rollEditLog(FSImage.java:1243)\n        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.rollEditLog(FSNamesystem.java:6437)\n        at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.rollEditLog(NameNodeRpcServer.java:1002)\n        at org.apache.hadoop.hdfs.protocolPB.NamenodeProtocolServerSideTranslatorPB.rollEditLog(NamenodeProtocolServerSideTranslatorPB.java:142)\n        at org.apache.hadoop.hdfs.protocol.proto.NamenodeProtocolProtos$NamenodeProtocolService$2.callBlockingMethod(NamenodeProtocolProtos.java:12025)\n        at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:617)\n        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:1060)\n        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2086)\n        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2082)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at javax.security.auth.Subject.doAs(Subject.java:422)\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1671)\n        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2080)\n2016-09-23 21:40:59,618 WARN org.apache.hadoop.hdfs.qjournal.client.QuorumJournalManager: Aborting QuorumOutputStream starting at txid 10562075963\n{code}\n\nThe exception is from  EditsDoubleBuffer\n{code}\n public void close() throws IOException {\n    Preconditions.checkNotNull(bufCurrent);\n    Preconditions.checkNotNull(bufReady);\n\n    int bufSize = bufCurrent.size();\n    if (bufSize != 0) {\n      throw new IOException(\"FSEditStream has \" + bufSize\n          + \" bytes still to be flushed and cannot be closed.\");\n    }\n\n    IOUtils.cleanup(null, bufCurrent, bufReady);\n    bufCurrent = bufReady = null;\n  }\n{code}\n\nWe can see that FSNamesystem.rollEditLog expects  EditsDoubleBuffer.bufCurrent to be empty.\n\nEdits are recorded via FSEditLog$logSync, which does:\n{code}\n   * The data is double-buffered within each edit log implementation so that\n   * in-memory writing can occur in parallel with the on-disk writing.\n   *\n   * Each sync occurs in three steps:\n   *   1. synchronized, it swaps the double buffer and sets the isSyncRunning\n   *      flag.\n   *   2. unsynchronized, it flushes the data to storage\n   *   3. synchronized, it resets the flag and notifies anyone waiting on the\n   *      sync.\n   *\n   * The lack of synchronization on step 2 allows other threads to continue\n   * to write into the memory buffer while the sync is in progress.\n   * Because this step is unsynchronized, actions that need to avoid\n   * concurrency with sync() should be synchronized and also call\n   * waitForSyncToFinish() before assuming they are running alone.\n   */\n{code}\n\nWe can see that step 2 is on-purposely not synchronized to let other threads to write into the memory buffer, presumbaly EditsDoubleBuffer.bufCurrent. This means that the EditsDoubleBuffer.bufCurrent  can be non-empty when logSync is done.\n\nNow if rollEditLog happens, the above exception happens.\n\nAnother interesting observation is, the size of the EditsDoubleBuffer can be as large as \"private int outputBufferCapacity = 512 * 1024;\", which means a lot of edits could get buffered before they are flushed to JNs. \n\nHow can rollEdit operation expect the EditsDoubleBuffer.bufCurrent to be empty? Or ask in another way, ollEdit operation want to close the stream\n{code}\norg.apache.hadoop.hdfs.server.namenode.JournalSet$JournalAndStream.closeStream(JournalSet.java:115)\n{code}\nwhere the close operation expects EditsDoubleBuffer.bufCurrent to be empty. It  seems rollEdit should make sure the EditsDoubleBuffer is flushed in a synchronized way before it tries to close the stream. Why it doesn't do that?\n\nIf my above theory is correct, wonder why this issue doesn't show up so often.\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"rollEditLog expects empty EditsDoubleBuffer.bufCurrent which is not guaranteed","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/15542701","id":"15542701","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"Which version are you looking at?  {{rollEditLog()}} does not and cannot solely depend on {{FSEditLog}} synchronization.  That's why it acquires the FSN write lock. This blocks everyone from edit logging. While still in the write lock, the edits are synced. This is different from regular {{logSync()}}, which happens outside the write lock.  \n\nIf you are seeing such an exception, something is circumventing the FSN lock and edit logging.  There are some places where locking is more complicated like use of {{noInterruptsLock}} in {{DelegationTokenSecretManager}}, but they are also not supposed to edit log while rolling edits.  The exception clearly indicates a bug.  If you can reproduce it, make it dump the buffer before terminating so that we can find out who did edit logging.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2016-10-03T15:42:49.315+0000","updated":"2016-10-03T15:42:49.315+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/15543293","id":"15543293","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks a lot [~kihwal]!\n\nAbout\n{quote}\n That's why it acquires the FSN write lock. This blocks everyone from edit logging. While still in the write lock, the edits are synced.\n{quote}\nI examined and found a diff between the branch I'm using and trunk, I saw trunk has {{logSyncAll()}} in the following code:\n{code}\nFSEditLog.java\n /**\n   * Finalize the current log segment.\n   * Transitions from IN_SEGMENT state to BETWEEN_LOG_SEGMENTS state.\n   */\n  public synchronized void endCurrentLogSegment(boolean writeEndTxn) {\n    LOG.info(\"Ending log segment \" + curSegmentTxId);\n    Preconditions.checkState(isSegmentOpen(),\n        \"Bad state: %s\", state);\n    \n    if (writeEndTxn) {\n      logEdit(LogSegmentOp.getInstance(cache.get(), \n          FSEditLogOpCodes.OP_END_LOG_SEGMENT));\n    }\n    // always sync to ensure all edits are flushed.\n    logSyncAll();  <====================================\n\n    printStatistics(true);\n    \n    final long lastTxId = getLastWrittenTxId();\n    \n    try {\n      journalSet.finalizeLogSegment(curSegmentTxId, lastTxId);\n      editLogStream = null;\n    } catch (IOException e) {\n      //All journals have failed, it will be handled in logSync.\n    }\n    \n    state = State.BETWEEN_LOG_SEGMENTS;\n  }\n{code}\n\nThe {{logSyncAll()}} call is introduced by  HDFS-7964 (Add support for async edit logging), which seems to be the behavior I'm asking for in HDFS-10943 : we should flush edits before closing the stream.\n\nSo likely HDFS-7964 is is not just as described \"Add support for async edit logging\", but likely also fixing the bug I reported here, that is, prior to HDFS-7964, we don't flush the edits before closing the stream. \n\nWhat do yout think?  Hi [~daryn], welcome to comment if my above statement is correct since you worked out HDFS-7964?\n\nMany thanks.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-10-03T20:12:45.855+0000","updated":"2016-10-03T20:12:45.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/15569447","id":"15569447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~daryn],\n\nAbout my last comment, do you think it's a bug for {{endCurrentLogSegment}} not to call {{logSyncAll()}}, which is fixed by HDFS-7964? \n\nThanks a lot.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-10-12T18:12:07.915+0000","updated":"2016-10-12T18:12:07.915+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/15590079","id":"15590079","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Unless something has changed semi-recently, you definitely cannot roll the edits w/o fsn synchronization.  Kihwal was right, he's heard me grumble many times about the edit logs not really being thread-safe.  I think I filed a jira about it many years ago...\n\nThe main problem is the complex wait/notify behavior for interleaving edits and syncs.  Essentially the roll needs to be an atomic:  log segment end, close segment, open new segment, log segment start.  Relinquishing the edit log mutex anywhere during that transaction due to wait() may cause \"very bad things\" to happen.  Best case is an NPE when another thread tries to log between segments.  The sync won't matter if another spurious edit slips in after the end segment edit or before the start segment edit.  Must... bury... memories of scrambling to save the namespace of a few clusters after the standby crashed from corrupted edits.\n\nThe answer is track down why the fsn lock is not being held.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2016-10-19T22:35:57.977+0000","updated":"2016-10-19T22:35:57.977+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/15590210","id":"15590210","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks a lot [~daryn]!\n\nSorry a follow-up question at the end with this comment:\n\nAbout\n\nEssentially the roll needs to be an atomic: \n# log segment end, \n# close segment, \n# open new segment, \n# log segment start. \n\nStep #1 and #2 above should have flushed all edits in the buffer before closing the segment, but seems we were not doing that in {{FSEditLog#endCurrentSegment}} before HDFS-7964 added the following call:\n{code}\n    // always sync to ensure all edits are flushed.\n    logSyncAll();  <====================================\n{code}\n\nMy problem is that some edits are not flushed to JN when the editlog is being rolled, and the release that has this problem doesn't have the fix of HDFS-7964.  Though HDFS-7964 is reported as an enhancement to support async edit logging, as a side product,  it also likely fixes my problem. \n\n{quote}\nThe answer is track down why the fsn lock is not being held.\n{quote}\nAre you saying that if we were not to use HDFS-7964 fix,  then the fsn lock should have been held, so we don't need to call  {{logSyncAll()}} in {{FSEditLog#endCurrentSegment}}. That is, you suspect there is some place that the fsn lock was not held (as it's supposed to) rather than the missing {{logSyncAll()}} call?\n\nThanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-10-19T23:25:50.925+0000","updated":"2016-10-19T23:25:50.925+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/15799075","id":"15799075","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"The issue remains even after HDFS-7964 is included. \n\nHDFS-7964 added the call {{logSyncAll{}}} before the edit log rolling. So either this method did not finish its job correctly, or some new edits gets in after the flush and before the edit log rolling. Created HDFS-11292 to help the diagnosis.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-04T19:09:59.032+0000","updated":"2017-01-04T19:09:59.032+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/15826898","id":"15826898","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhz","name":"zhz","key":"zhz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=zhz&avatarId=20493","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=zhz&avatarId=20493","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=zhz&avatarId=20493","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=zhz&avatarId=20493"},"displayName":"Zhe Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"[~yzhangal] Thanks for reporting the issue. Which version did you use when observing the issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhz","name":"zhz","key":"zhz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=zhz&avatarId=20493","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=zhz&avatarId=20493","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=zhz&avatarId=20493","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=zhz&avatarId=20493"},"displayName":"Zhe Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-17T21:50:08.734+0000","updated":"2017-01-17T21:50:08.734+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/15826910","id":"15826910","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~zhz], I originally saw it with CDH 5.5.x. Then after digging, I think it's likely all upstream branches also have the issue. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-17T22:02:31.166+0000","updated":"2017-01-17T22:02:31.166+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/16443671","id":"16443671","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"hi [~zhz],[~daryn],[~yzhangal],[~kihwal] is this issue still going on?\r\nI meet the same problem in my production cluster, and my hadoop version is apache hadoop-2.7.1.\r\nI agree that some editlog in doublebuffer is not flush. maybe it is not related to {{logSyncAll}} since compare {{logSyncAll}} to {{logSync}}, it is only different about set {{txid}} but not different for doublebuffer.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-04-19T07:50:21.777+0000","updated":"2018-04-19T07:50:21.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/16445363","id":"16445363","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"I would like to provide more detail information:\r\n A. NameNode logs before fatal which is same as [~yzhangal] mentioned above:\r\n{code:java}\r\n2018-04-19 13:10:24,222 INFO org.apache.hadoop.hdfs.server.namenode.FSEditLog: Rolling edit logs\r\n2018-04-19 13:10:24,222 INFO org.apache.hadoop.hdfs.server.namenode.FSEditLog: Ending log segment 15221708217\r\n2018-04-19 13:10:24,595 INFO org.apache.hadoop.hdfs.server.namenode.FSEditLog: Number of transactions: 206713 Total time for transactions(ms): 2575 Number of transactions batched in Syncs: 8218 Number of syncs: 138767 SyncTimes(ms): 42337 29016\r\n2018-04-19 13:10:25,264 FATAL org.apache.hadoop.hdfs.server.namenode.FSEditLog: Error: finalize log segment 15221708217, 15221914929 failed for required journal (JournalAndStream(mgr=QJM to [0.0.0.0:8485, 0.0.0.0:8485, 0.0.0.0:8485], stream=QuorumOutputStream starting at txid 15221708217))\r\njava.io.IOException: FSEditStream has 160370 bytes still to be flushed and cannot be closed.\r\n        at org.apache.hadoop.hdfs.server.namenode.EditsDoubleBuffer.close(EditsDoubleBuffer.java:66)\r\n        at org.apache.hadoop.hdfs.qjournal.client.QuorumOutputStream.close(QuorumOutputStream.java:65)\r\n        at org.apache.hadoop.hdfs.server.namenode.JournalSet$JournalAndStream.closeStream(JournalSet.java:115)\r\n        at org.apache.hadoop.hdfs.server.namenode.JournalSet$4.apply(JournalSet.java:235)\r\n        at org.apache.hadoop.hdfs.server.namenode.JournalSet.mapJournalsAndReportErrors(JournalSet.java:393)\r\n        at org.apache.hadoop.hdfs.server.namenode.JournalSet.finalizeLogSegment(JournalSet.java:231)\r\n        at org.apache.hadoop.hdfs.server.namenode.FSEditLog.endCurrentLogSegment(FSEditLog.java:1274)\r\n        at org.apache.hadoop.hdfs.server.namenode.FSEditLog.rollEditLog(FSEditLog.java:1203)\r\n        at org.apache.hadoop.hdfs.server.namenode.FSImage.rollEditLog(FSImage.java:1293)\r\n        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.rollEditLog(FSNamesystem.java:6084)\r\n        at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.rollEditLog(NameNodeRpcServer.java:1295)\r\n        at org.apache.hadoop.hdfs.protocolPB.NamenodeProtocolServerSideTranslatorPB.rollEditLog(NamenodeProtocolServerSideTranslatorPB.java:142)\r\n        at org.apache.hadoop.hdfs.protocol.proto.NamenodeProtocolProtos$NamenodeProtocolService$2.callBlockingMethod(NamenodeProtocolProtos.java:12025)\r\n        at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:616)\r\n        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:969)\r\n        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2049)\r\n        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2045)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at javax.security.auth.Subject.doAs(Subject.java:415)\r\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1690)\r\n        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2043)\r\n2018-04-19 13:10:25,390 WARN org.apache.hadoop.hdfs.qjournal.client.QuorumJournalManager: Aborting QuorumOutputStream starting at txid 15221708217\r\n{code}\r\nB. JournalNode logs when Standby NameNode transition To Active and recovery EditLog:\r\n{code:java}\r\n2018-04-19 13:10:47,137 INFO org.apache.hadoop.hdfs.qjournal.server.Journal: Accepted recovery for segment 15221708217: segmentState { startTxId: 15221708217 endTxId: 15221913880 isInProgress: true } acceptedInEpoch: 24\r\n{code}\r\nC. CallQueue of NameNode is full and lasted no more than three seconds.\r\n{code:java}\r\nDate   Time         RpcProcessingTime  CallQueueLength RpcQueueTime\r\n04-19 13:10:22         0.120               0              0.031 \r\n04-19 13:10:24         0.505            3200             10.619 \r\n04-19 13:10:25      1038.286            3200            265.548\r\n{code}\r\nBased on logs, we can come to conclusions:\r\n 1. only 2/3 JournalNodes active at that time since logs show {{SyncTimes(ms): 42337 29016}}\r\n 2. 1049 {{FSEditLogOp}} transations (finalize TxId of NameNode before fatal: 15221914929 - endTxId of JournalNode after recovery: 15221913880) are still in {{bufCurrent}} of EditsDoubleBuffer and do not flushed out.\r\n 3. All write of NameNode from DFSClient request still not return at that time, and FsEditLogOps of DFSClient's write op. still continue to put into {{bufCurrent}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-04-20T06:16:40.737+0000","updated":"2018-04-20T06:23:17.043+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/16445377","id":"16445377","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"Correct:\r\n{quote}1. only 2/3 JournalNodes active at that time since logs show SyncTimes(ms): 42337 29016{quote}\r\nthis conclusion is not correct, and please ignore.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-04-20T06:39:19.369+0000","updated":"2018-04-20T06:39:19.369+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/16445837","id":"16445837","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"hi [~daryn], I wonder is there any condition to make sure that {{EditsDoubleBuffer.bufReady}} is empty when swap buffer if disable assertions. Thanks for your help.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-04-20T14:43:31.642+0000","updated":"2018-04-20T14:43:31.642+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/16446329","id":"16446329","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"This error should not be possible.  The entire roll holds the FSN lock so nothing else can generate edits to avoid lingering bytes in the buffer.  {{endCurrentLogSegment}} does a logSync which loops calling setReadyToFlush (which flips the buffer) & flush until the last written txid is synced.  If the stream reports the last txid synced, there cannot/must-not be bytes lingering in the buffer or the stream lied.\r\n\r\nI'll take a quick look at the code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-04-20T20:34:41.803+0000","updated":"2018-04-20T20:34:41.803+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13009031/comment/16446446","id":"16446446","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"The quorum output stream will +always+ crash the NN if edits are rolled while a node is down.  The edit roll will sync, flush, close.  As we can see, closing a logger will fail if there are unflushed bytes.\r\n\r\nThe issue is {{QuorumOutputStream#flush}} succeeds with only a simple majority of loggers.  The those that failed cause close to fail due to unflushed bytes.  Someone familiar with QJM (we don't use it) will need to decide if it's safe for the quorum's flush to clear the buffers of failed loggers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-04-20T22:24:58.534+0000","updated":"2018-04-20T22:24:58.534+0000"}],"maxResults":14,"total":14,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-10943/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i34bun:"}}