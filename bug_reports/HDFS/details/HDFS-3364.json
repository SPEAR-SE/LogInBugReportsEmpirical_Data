{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12553815","self":"https://issues.apache.org/jira/rest/api/2/issue/12553815","key":"HDFS-3364","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2012-07-04T08:14:18.912+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jul 04 08:14:18 UTC 2012","customfield_12310420":"238026","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-3364/watchers","watchCount":4,"isWatching":false},"created":"2012-05-03T19:36:45.116+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12320353","id":"12320353","description":"hadoop-2.0.0-alpha release","name":"2.0.0-alpha","archived":false,"released":true,"releaseDate":"2012-05-23"}],"issuelinks":[{"id":"12355800","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12355800","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12601436","key":"HADOOP-8755","self":"https://issues.apache.org/jira/rest/api/2/issue/12601436","fields":{"summary":"Print thread dump when tests fail due to timeout ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-08-03T22:31:12.133+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312916","id":"12312916","name":"test"}],"timeoriginalestimate":null,"description":"I've seen TestFileAppend4.testRecoverFinalizedBlock shutdown occasionally time out in jenkins. Doesn't fail for me locally.\n\n{noformat}\ntest timed out after 60000 milliseconds\nStacktrace\n\njava.lang.Exception: test timed out after 60000 milliseconds\n\tat java.lang.Object.wait(Native Method)\n\tat java.lang.Thread.join(Thread.java:1186)\n\tat java.lang.Thread.join(Thread.java:1239)\n\tat org.apache.hadoop.hdfs.server.datanode.BPServiceActor.join(BPServiceActor.java:473)\n\tat org.apache.hadoop.hdfs.server.datanode.BPOfferService.join(BPOfferService.java:259)\n\tat org.apache.hadoop.hdfs.server.datanode.BlockPoolManager.shutDownAll(BlockPoolManager.java:117)\n\tat org.apache.hadoop.hdfs.server.datanode.DataNode.shutdown(DataNode.java:1098)\n\tat org.apache.hadoop.hdfs.MiniDFSCluster.shutdownDataNodes(MiniDFSCluster.java:1280)\n\tat org.apache.hadoop.hdfs.MiniDFSCluster.shutdown(MiniDFSCluster.java:1260)\n\tat org.apache.hadoop.hdfs.TestFileAppend4.testRecoverFinalizedBlock(TestFileAppend4.java:208)\n{noformat}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"114192","customfield_12312823":null,"summary":"TestFileAppend4.testRecoverFinalizedBlock occasionally times out","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli2","name":"eli2","key":"eli2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli2","name":"eli2","key":"eli2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12553815/comment/13406354","id":"13406354","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"body":"I saw this error in pre-commit test for HADOOP-8472, and also cannot reproduce in local. The full log is https://builds.apache.org/job/PreCommit-HADOOP-Build/1155//testReport/org.apache.hadoop.hdfs/TestFileAppend4/testCompleteOtherLeaseHoldersFile/ and the relevant log is as following:\n{noformat}\n2012-06-29 16:26:22,187 INFO  ipc.Server (Server.java:stop(1991)) - Stopping server on 46047\n2012-06-29 16:26:22,424 DEBUG datanode.DataNode (BPServiceActor.java:sendHeartBeat(431)) - Sending heartbeat from service actor: Block pool BP-166940465-67.195.138.20-1340987178877 (storage id DS-851929818-67.195.138.20-36687-1340987179189) service to localhost/127.0.0.1:49801\n2012-06-29 16:26:22,424 DEBUG datanode.DataNode (BPServiceActor.java:sendHeartBeat(431)) - Sending heartbeat from service actor: Block pool BP-166940465-67.195.138.20-1340987178877 (storage id DS-1404243958-67.195.138.20-36424-1340987179356) service to localhost/127.0.0.1:49801\n2012-06-29 16:26:22,424 DEBUG datanode.DataNode (BPServiceActor.java:sendHeartBeat(431)) - Sending heartbeat from service actor: Block pool BP-166940465-67.195.138.20-1340987178877 (storage id DS-1672148922-67.195.138.20-53642-1340987179269) service to localhost/127.0.0.1:49801\n2012-06-29 16:26:22,425 INFO  ipc.Server (Server.java:run(638)) - Stopping IPC Server listener on 46047\n2012-06-29 16:26:22,425 INFO  ipc.Server (Server.java:run(780)) - Stopping IPC Server Responder\n2012-06-29 16:26:22,425 INFO  datanode.DataNode (DataNode.java:shutdown(1068)) - Waiting for threadgroup to exit, active threads is 1\n2012-06-29 16:26:22,428 WARN  ipc.Server (Server.java:processResponse(979)) - IPC Server Responder, call org.apache.hadoop.hdfs.server.protocol.DatanodeProtocol.sendHeartbeat from 127.0.0.1:51257: output error\n2012-06-29 16:26:22,429 INFO  ipc.Server (Server.java:run(1745)) - IPC Server handler 9 on 49801 caught an exception\njava.nio.channels.ClosedChannelException\n\tat sun.nio.ch.SocketChannelImpl.ensureWriteOpen(SocketChannelImpl.java:133)\n\tat sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:324)\n\tat org.apache.hadoop.ipc.Server.channelWrite(Server.java:2131)\n\tat org.apache.hadoop.ipc.Server.access$2000(Server.java:107)\n\tat org.apache.hadoop.ipc.Server$Responder.processResponse(Server.java:930)\n\tat org.apache.hadoop.ipc.Server$Responder.doRespond(Server.java:994)\n\tat org.apache.hadoop.ipc.Server$Handler.run(Server.java:1738)\n{noformat}\n\nFrom this log, the problem happens in shutting down 3rd datanodes as previous 2 datanodes are shut down successfully. It looks like when shutting down ipcserver on 3rd datanode, it happens to do heartbeat for BPServiceActor in offerService() so some heartbeat exceptions are thrown out.\nAlso, the following code which is for interrupt offerService() is not taking effective which means offerService() pending on somewhere else? like heartbeat response or pendingIncrementalBR. Does adding catch InterruptedException(...) in whole offerService() can help here? \n\n{code}\n  synchronized(pendingIncrementalBR) {\n    if (waitTime > 0 && pendingReceivedRequests == 0) {\n      try {\n        pendingIncrementalBR.wait(waitTime);\n      } catch (InterruptedException ie) {\n        LOG.warn(\"BPOfferService for \" + this + \" interrupted\");\n      }\n    }\n  }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-07-04T08:14:18.912+0000","updated":"2012-07-04T08:14:18.912+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-3364/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0jwhb:"}}