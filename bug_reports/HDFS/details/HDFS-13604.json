{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13161340","self":"https://issues.apache.org/jira/rest/api/2/issue/13161340","key":"HDFS-13604","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2018-05-23 09:05:03.052","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13604/watchers","watchCount":2,"isWatching":false},"created":"2018-05-23T09:05:03.052+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12327181","id":"12327181","description":"2.6.0 release","name":"2.6.0","archived":false,"released":true,"releaseDate":"2014-11-18"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-23T09:07:15.543+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324603","id":"12324603","name":"distcp"}],"timeoriginalestimate":null,"description":"DistCp has an option to filter (not copy) files that match one of the file patterns in a file.  DistCp also has options where it optimizes incremental copying based on snapshots present at the source and target location.  When enabling both options, files that should be copied from source to target are missing on the target.\r\n\r\nTo reproduce the issue:\r\n * Create two directories, {{source}} and {{target}}.\r\n * In {{source}}, put two files, {{A}} and {{B}}, with some random content.\r\n * Create a filter file that filters {{A}} (so blocks copying {{A}}).\r\n * Create a snapshot, {{snapshot_old}}, of the {{source}} directory.\r\n * Use {{distcp}} to copy the content of {{source}} to {{target}}.\r\n * As expected, the {{target}} directory will contain only file {{B}}.  {{A}} is filtered.\r\n * Take a snapshot of the target directory, snapshot_old.\r\n * In the {{source}} directory, rename {{A}} to {{C}}.\r\n * Take a new snapshot of the source directory, {{snapshot_new}}.\r\n * Now, perform an incremental {{distcp}} copy using the created snapshots so as to optimize the incremental copy process: {{distcp -update -filters filters.txt -diff snapshot_old snapshot_new ... ...}}\r\n * You will find that the newly created file {{C}} is not copied to the {{target}} directory.\r\n\r\nI suspect that the reason for this is that {{distcp}} concludes from analyzing the difference between {{snapshot_source}} and {{snapshot_source_new}} that {{A}} was renamed to {{C}}. This can be confirmed by using {{snapshotDiff}} to compare the two snapshot:  it reports that {{A}} has been renamed to {{C}}.\r\n\r\n{{distcp}} seems to then assume that the data for {{C}} is already present in the {{target}} directory and only needs to be renamed.  However, due to the filtering, {{A}} is {{not}} present on the target and cannot be renamed to {{C}}.\r\n\r\nAlthough the final {{distcp}} fails to create a copy of the {{C}} file in the {{target}} directory, {{distcp}} does not report any failure, nor can I find any trace of errors in the job logs of the jobs created by {{distcp}} to execute the actual copy.\r\n\r\nSo, some options:\r\n * Combining {{-diff}} and {{-filters}} could be disallowed.\r\n * {{distcp}} could assume that files that have been filtered are _not_ present and should be replicated in ordinary fashion.\r\n\r\n \r\n\r\n ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"DistCp filtering conflicts with snapshotting","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mark_christiaens","name":"mark_christiaens","key":"mark_christiaens","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Christiaens","active":true,"timeZone":"Europe/Brussels"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mark_christiaens","name":"mark_christiaens","key":"mark_christiaens","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Christiaens","active":true,"timeZone":"Europe/Brussels"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13604/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3u1pj:"}}