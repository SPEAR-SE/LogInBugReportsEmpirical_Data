{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12721278","self":"https://issues.apache.org/jira/rest/api/2/issue/12721278","key":"HDFS-6536","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2014-06-17T16:58:21.663+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jun 18 06:33:16 UTC 2014","customfield_12310420":"399474","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_258076638_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-06-18T06:35:51.830+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6536/watchers","watchCount":3,"isWatching":false},"created":"2014-06-15T06:54:35.866+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326143","id":"12326143","description":"2.4.0 release","name":"2.4.0","archived":false,"released":true,"releaseDate":"2014-04-07"}],"issuelinks":[{"id":"12389897","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12389897","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"12707492","key":"HDFS-6222","self":"https://issues.apache.org/jira/rest/api/2/issue/12707492","fields":{"summary":"Remove background token renewer from webhdfs","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-06-18T06:35:52.098+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312928","id":"12312928","name":"hdfs-client"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12319200","id":"12319200","name":"webhdfs","description":"WebHDFS: HTTP REST API for HDFS"}],"timeoriginalestimate":null,"description":"With a small client program below, when running as user \"root\" which doesn't have kerberos credential, exception is thrown at the end of the client run. The config is HA security enabled, with client config setting \n{code}\n  <property>\n    <name>fs.defaultFS</name>\n    <value>webhdfs://ns1</value>\n  </property>\n{code}\n\nThe client program:\n\n{code}\npublic class kclient1 {\n\tpublic static void main(String[] args) throws IOException {\n\t  final Configuration conf = new Configuration();\n          //a non-root user\n          final UserGroupInformation ugi = UserGroupInformation.getUGIFromTicketCache(\"/tmp/krb5cc_496\", \"hdfs@xyz.com\");  \n\n          System.out.println(\"Starting\");\n          ugi.doAs(new PrivilegedAction<Object>() {\n\t  @Override\n\t      public Object run() {\n\t\t  try {\n\t\t  \tFileSystem fs = FileSystem.get(conf);\t\t\t\n\t\t  \tString renewer = \"abcdefg\";\n\t\t  \tfs.addDelegationTokens(\n\t\t  \t\t\trenewer, ugi.getCredentials());\n\t\t  \t// Just to prove that we connected with right credentials.\n\t\t  \tfs.getFileStatus(new Path(\"/\"));\n\t\t  \treturn fs.getDelegationToken(renewer);\n\t\t  } catch (Exception e) {\n\t\t  \te.printStackTrace();\n\t\t  \treturn null;\n                  }\n           }\n    });\n    System.out.println(\"THE END\");\n  }\n}\t\t\n{code}\n\nOutput:\n{code}\n[root@yjzc5w-1 tmp2]# hadoop --config /tmp2/conf jar kclient1.jar kclient1.kclient1\nStarting\n14/06/14 20:38:51 WARN ssl.FileBasedKeyStoresFactory: The property 'ssl.client.truststore.location' has not been set, no TrustStore will be loaded\n14/06/14 20:38:52 INFO web.WebHdfsFileSystem: Retrying connect to namenode: yjzc5w-2.xyz.com/172.26.3.87:20101. Already tried 0 time(s); retry policy is org.apache.hadoop.io.retry.RetryPolicies$FailoverOnNetworkExceptionRetry@1a92210, delay 0ms.\nTo prove that connection with right credentials\nto get file status updated updated 7\nTHE END\n14/06/14 20:38:53 WARN ssl.FileBasedKeyStoresFactory: The property 'ssl.client.truststore.location' has not been set, no TrustStore will be loaded\n14/06/14 20:38:53 WARN security.UserGroupInformation: PriviledgedActionException as:root (auth:KERBEROS) cause:java.io.IOException: org.apache.hadoop.security.authentication.client.AuthenticationException: GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)\n14/06/14 20:38:53 INFO fs.FileSystem: FileSystem.Cache.closeAll() threw an exception:\njava.io.IOException: Authentication failed, url=http://yjzc5w-2.xyz.com:20101/webhdfs/v1/?op=CANCELDELEGATIONTOKEN&user.name=root&token=HAAEaGRmcwRoZGZzAIoBRp2bNByKAUbBp7gcbBQUD6vWmRYJRv03XZj7Jajf8PU8CB8SV0VCSERGUyBkZWxlZ2F0aW9uC2hhLWhkZnM6bnMx\n[root@yjzc5w-1 tmp2]# \n{code}\n\nWe can see the the exception is thrown in the end of the client run.\n\nI found that the problem is that at the end of client run, the FileSystem$Cache$ClientFinalizer is run, in which process the tokens stored in the filesystem cache is get cancelled with the following all:\n\n{code}\nfinal class TokenAspect<T extends FileSystem & Renewable> {\n  @InterfaceAudience.Private\n  public static class TokenManager extends TokenRenewer {\n    @Override\n    public void cancel(Token<?> token, Configuration conf) throws IOException {\n      getInstance(token, conf).cancelDelegationToken(token); <==\n    }\n{code}\nwhere getInstance(token, conf) create a FileSystem as user \"root\", then call cancelDelegationToken to server side. However, server doesn't have \"root\" kerberos credential, so throw this exceptoin.\n\nWhen I run the same program as user \"hdfs\" which has the kerberos credential, then it's fine.\n\nIn this case, the client program doesn't own the delegation token, it should not try to cancel the token.  However, the token does not get cancelled because of the exception I described is thrown, which is good.\n\nThe remaining question is, do we need to check token ownership before trying to cancel the token. This is a minor issue here, and I'm dropping the severity.\n\nHi [~daryn], I wonder if you could give a quick comment, really appreciate it!\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"399583","customfield_12312823":null,"summary":"FileSystem.Cache.closeAll() throws authentication exception at the end of a webhdfs client","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12721278/comment/14031798","id":"14031798","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"I guess if we create credential for user \"root\" at namenode, then the problem will go away. But since linux \"root\" user can run any client program like I described, the issue I described is still valid. Any comments are welcome.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-06-15T07:32:28.838+0000","updated":"2014-06-15T07:32:28.838+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12721278/comment/14034039","id":"14034039","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"The problem should manifest with something as simple as this in the doAs:\n{code}\nFileSystem fs = FileSystem.get(conf);\nfs.getFileStatus(new Path(\"/\"));\n{code}\n\nWebhdfs internally acquires a token and tries to cancel upon close of the fs.  The tokens you explicitly acquired should be inconsequential.  The issue is TokenAspect doesn't know the ugi context that acquired the token.\n\nSee if HDFS-6222 solves the problem.  Webhdfs will cancel its own token directly instead of via TokenAspect.  If it solves the issue, let's dup this jira.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2014-06-17T16:58:21.663+0000","updated":"2014-06-17T16:58:21.663+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12721278/comment/14034875","id":"14034875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks a lot [~daryn]! Sorry to late response.Had to work on other stuff daytime.\n\nYour comments above indeed matches the problem reported here and I just verified that your HDFS-6222 patch solves the problem, many thanks for the fix there!\n\nI noticed that you fixed https://issues.apache.org/jira/browse/HDFS-6312 in this one. But would you please still consider HDFS-6312 as a separate fix? Please see mine and Alejandro's comments there. \n\nBest regards.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-06-18T06:33:16.149+0000","updated":"2014-06-18T06:33:16.149+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6536/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1wrp3:"}}