{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13136593","self":"https://issues.apache.org/jira/rest/api/2/issue/13136593","key":"HDFS-13111","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-02-06T16:10:58.466+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Apr 30 21:07:22 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13111/watchers","watchCount":8,"isWatching":false},"created":"2018-02-06T15:28:54.037+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329057","id":"12329057","description":"2.8.0 release","name":"2.8.0","archived":false,"released":true,"releaseDate":"2017-03-22"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-09-08T08:27:39.074+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312927","id":"12312927","name":"datanode"}],"timeoriginalestimate":null,"description":"Close recovery can leave a block marked corrupt until the next FBR arrives from one of the DNs.  The reason is unclear but has happened multiple times when a DN has io saturated disks.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12344055","id":"12344055","description":"2.8.6 release","name":"2.8.6","archived":false,"released":false}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Close recovery may incorrectly mark blocks corrupt","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13136593/comment/16354015","id":"16354015","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"In two studied cases, the pipeline succeeded but the client timedout.  Close recovery succeeded.   The problem appears to be possibly be caused by a multiple IBR race causing a delayed IBR with the prior genstamp.  Due to heavy io load and DN dataset lock contention, the belief is the block sender/receiver may not be exiting prior to completion of the close recovery.  Recovery appears to try to interrupt the existing xceiver but has a timed join before plowing ahead.  The block sender does not necessarily wait for the packet responder to exit which is what will send the IBR.  If correct: when the xceiver doesn't exit, the pending operation (close recovery in this case) must fail.  The block sender must also ensure the packet responder has exited.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-02-06T15:35:13.876+0000","updated":"2018-02-06T15:35:13.876+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13136593/comment/16354076","id":"16354076","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"Here is relevant log lines of the latest example. This node was under a heavy I/O load.\r\n\r\n{noformat}\r\n2018-02-06 00:00:03,413 [DataXceiver for client DFSClient_XXX at /1.2.3.4:57710] INFO\r\n Receiving BP-YYY:blk_7654321_1234567 src: /1.2.3.4:57710 dest: /1.2.3.5:1004\r\n2018-02-06 00:09:58,840 [DataXceiver for client DFSClient_XXX at /1.2.3.4:57710] WARN\r\n Slow BlockReceiver write data to disk cost:462ms (threshold=300ms)\r\n2018-02-06 00:10:40,148 [DataXceiver for client DFSClient_XXX at /1.2.3.4:57710] WARN\r\n Slow BlockReceiver write data to disk cost:11155ms (threshold=300ms)\r\n2018-02-06 00:10:46,053 [DataXceiver for client DFSClient_XXX at /1.2.3.4:57710] WARN\r\n Slow BlockReceiver write data to disk cost:1577ms (threshold=300ms)\r\n2018-02-06 00:11:02,376 [DataXceiver for client DFSClient_XXX at /1.2.3.4:57710] WARN\r\n Slow BlockReceiver write data to disk cost:327ms (threshold=300ms)\r\n2018-02-06 00:11:53,064 [DataXceiver for client DFSClient_XXX at /1.2.3.4:40532] INFO\r\n Receiving BP-YYY:blk_7654321_1234567 src: /1.2.3.4:40532 dest: /1.2.3.5:1004\r\n2018-02-06 00:12:09,782 [DataXceiver for client DFSClient_XXX at /1.2.3.4:40532] INFO\r\n Recover failed close BP-YYY:blk_7654321_1234567\r\n2018-02-06 00:12:13,081 [DataXceiver for client DFSClient_XXX at /1.2.3.7:46522] INFO\r\n Receiving BP-YYY:blk_7654321_1234567 src: /1.2.3.7:46522 dest: /1.2.3.5:1004\r\n2018-02-06 00:12:13,081 [DataXceiver for client DFSClient_XXX at /1.2.3.7:46522] INFO\r\n Recover failed close BP-YYY:blk_7654321_1234567\r\n2018-02-06 00:12:17,276 [DataXceiver for client DFSClient_XXX at /1.2.3.4:40532] WARN\r\n Lock held time above threshold: lock identifier: org.apache.hadoop.hdfs.server.datanode\r\n .fsdataset.impl.FsDatasetImpl lockHeldTimeMs=7492 ms. Suppressed 0 lock warnings.\r\n The stack trace is: java.lang.Thread.getStackTrace(Thread.java:1556)\r\n ... // it was recoverClose()\r\n2018-02-06 00:12:17,276 [DataXceiver for client DFSClient_XXX at /1.2.3.7:46522] INFO\r\n Received BP-YYY:blk_7654321_1135832806836 src: /1.2.3.7:46522 dest: /1.2.3.5:1004 of size xx\r\n2018-02-06 00:12:20,103 [DataXceiver for client DFSClient_XXX at /1.2.3.4:40532] INFO\r\n Received BP-YYY:blk_7654321_1135832805246 src: /1.2.3.4:40532 dest: /1.2.3.5:1004 of size xx\r\n2018-02-06 00:12:38,353 [PacketResponder: BP-YYY:blk_7654321_1234567, type=LAST_IN_PIPELINE] INFO\r\n DataNode.clienttrace: src: /1.2.3.4:57710, dest: /1.2.3.5:1004, bytes: 134217728, op: HDFS_WRITE,\r\n cliID: DFSClient_XXX, offset: 0, srvID: ZZZ, blockid: BP-YYY:blk_7654321_1234567, duration: looong\r\n{noformat}\r\n\r\nNote the client port number to identify each writer thread. After two \"successful\" {{recoverClose()}}, the original writer comes around and also declares a success. This must have resulted in the reported gen stamp going backward. On disk actually was the latest one.\r\n\r\nThis clearly illustrates that it is wrong to time out on the writer termination and continue with the recovery.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-02-06T16:10:58.466+0000","updated":"2018-02-06T16:10:58.466+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13136593/comment/16362677","id":"16362677","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"It looks like \"trying forever\" might be actually part of the problem.\r\n\r\n{code:java}\r\n public Replica recoverClose(....) throws IOException {\r\n    while (true) {\r\n      try {\r\n        try(AutoCloseableLock lock = datasetLock.acquire()) {\r\n          // check replica's state\r\n          ReplicaInfo replicaInfo = recoverCheck(b, newGS, expectedBlockLen);\r\n          // update the replica state/gs and finalize if necessary.\r\n          return replicaInfo;\r\n        }\r\n      } catch (MustStopExistingWriter e) {\r\n        e.getReplica().stopWriter(datanode.getDnConf().getXceiverStopTimeout());\r\n      }\r\n    }\r\n  }\r\n{code}\r\n\r\nWhen the I/O frees up and the original writer (normally the packet responder) and the xceiver thread doing {{recoverClose()}} can finish in non-deterministic order.  If {{recoverClose()}} finishes last, everything is good.  If the packer responder finishes last as the example above, the replica will be marked as corrupt until the next full block report.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-02-13T17:07:33.598+0000","updated":"2018-02-13T17:07:33.598+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13136593/comment/16455659","id":"16455659","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"body":"move to 2.8.5 given this jira has been quiet for a while.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-04-27T02:00:43.310+0000","updated":"2018-04-27T02:00:43.310+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13136593/comment/16459059","id":"16459059","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Note that unassigned jiras are free for the taking.  Please. :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-04-30T21:07:22.324+0000","updated":"2018-04-30T21:07:22.324+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13111/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3pur3:"}}