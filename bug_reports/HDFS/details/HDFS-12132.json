{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13086845","self":"https://issues.apache.org/jira/rest/api/2/issue/13086845","key":"HDFS-12132","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-07-13T18:22:44.448+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Feb 03 03:46:43 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-12132/watchers","watchCount":8,"isWatching":false},"created":"2017-07-13T08:13:21.425+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12339198","id":"12339198","name":"2.8.1","archived":false,"released":true,"releaseDate":"2017-06-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-02-03T03:47:34.286+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12317907","id":"12317907","name":"auto-failover","description":"Automatic failover"}],"timeoriginalestimate":null,"description":"Active NameNode become Standby because the ZKFC exception and Standby NameNode is still Standby When rolling upgrading Hadoop from Hadoop-2.6.5 to Hadoop-2.8.0, this lead HDFS to be not available. The logic of processing exception in ZKFC seems to be problematic, ZKFC should guarantee to have a active NameNode.\n\nBefore upgrading, the cluster was deployed with HA, NN1 was active, and NN2 was standby\nThe configuration before upgrading is as follows:\n\n{code:java}\ndfs.namenode.rpc-address.nameservice.nn1 nn1: 8020\ndfs.namenode.rpc-address.nameservice.nn2 nn2: 8020\n{code}\n\nAfter upgrading, add the configuration of the separate RPC service:\n{code:java}\ndfs.namenode.rpc-address.nameservice.nn1 nn1: 8020\ndfs.namenode.rpc-address.nameservice.nn2 nn2: 8020\ndfs.namenode.servicerpc-address.nameservice.nn1 nn1: 8021\ndfs.namenode.servicerpc-address.nameservice.nn2 nn2: 8021\ndfs.namenode.lifeline.rpc-address.nameservice.nn1 nn1: 8022\ndfs.namenode.lifeline.rpc-address.nameservice.nn2 nn2: 8022\n{code}\n\nThe upgrade steps are as follows:\n1. Upgrade NN2: restart NameNode process on NN2\n2. Upgrade NN1: restart the NameNode process on NN1, then NN2 becomes active, NN1 is standby\n3. Restart both ZKFC on NN1 and NN2\n\nAfter restarting ZKFC,  Active NameNodes have become Standby, and Standby NameNode did not become Active. Two ZKFC having been doing a loop and threw many same exceptions.\n{code:java}\ncreateLockNodeAsync()  // create lock successfully\nbecomeActive()  // return false\nterminateConnection()  // delete EPHEMERAL znode of 'ActiveStandbyElectorLock'  \nsleepFor(sleepTime)\n{code}\nAfter running command 'hdfs zkfc -formatZK', ZKFC backs to normal. \nZKFC Exception log is:\n{code:java}\n2017-07-11 18:49:44,311 WARN [main-EventThread] org.apache.hadoop.ha.ActiveStandbyElector: Exception handling the winning of election\njava.lang.RuntimeException: Mismatched address stored in ZK for NameNode at nn2/xx.xxx.xx.xxx:8022: Stored protobuf was nameserviceId: “nameservice”\nnamenodeId: \"nn2\"\nhostname: “nn2_hostname”\nport: 8020\nzkfcPort: 8019\n, address from our own configuration for this NameNode was nn2_hostname/xx.xxx.xx.xxx:8021\n        at org.apache.hadoop.hdfs.tools.DFSZKFailoverController.dataToTarget(DFSZKFailoverController.java:87)\n        at org.apache.hadoop.ha.ZKFailoverController.fenceOldActive(ZKFailoverController.java:506)\n        at org.apache.hadoop.ha.ZKFailoverController.access$1100(ZKFailoverController.java:61)\n        at org.apache.hadoop.ha.ZKFailoverController$ElectorCallbacks.fenceOldActive(ZKFailoverController.java:895)\n        at org.apache.hadoop.ha.ActiveStandbyElector.fenceOldActive(ActiveStandbyElector.java:985)\n        at org.apache.hadoop.ha.ActiveStandbyElector.becomeActive(ActiveStandbyElector.java:882)\n        at org.apache.hadoop.ha.ActiveStandbyElector.processResult(ActiveStandbyElector.java:467)\n        at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:599)\n        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:498)\n2017-07-11 18:49:44,311 INFO [main-EventThread] org.apache.hadoop.ha.ActiveStandbyElector: Trying to re-establish ZK session\n2017-07-11 18:49:44,311 INFO [main-EventThread] org.apache.zookeeper.ZooKeeper: Session: 0x15c3ada0ec319aa closed\n{code}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Both two NameNodes become Standby because the ZKFC exception","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13086845/comment/16086151","id":"16086151","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=surendrasingh","name":"surendrasingh","key":"surendrasingh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=surendrasingh&avatarId=30759","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=surendrasingh&avatarId=30759","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=surendrasingh&avatarId=30759","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=surendrasingh&avatarId=30759"},"displayName":"Surendra Singh Lilhore","active":true,"timeZone":"Etc/UTC"},"body":"This happened because you configured {{dfs.namenode.servicerpc-address}} after upgrade. Before upgrade ZKFC used {{dfs.namenode.rpc-address}} address to store in zookeeper for active namenode. Now in fencing it trying to compare new address {{dfs.namenode.servicerpc-address}} with old active namenode address from ZK and it is not matching. \n\nIt should be fine once you format the zkfc. This is not a issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=surendrasingh","name":"surendrasingh","key":"surendrasingh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=surendrasingh&avatarId=30759","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=surendrasingh&avatarId=30759","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=surendrasingh&avatarId=30759","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=surendrasingh&avatarId=30759"},"displayName":"Surendra Singh Lilhore","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-13T18:22:44.448+0000","updated":"2017-07-13T18:22:44.448+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13086845/comment/16086799","id":"16086799","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"body":"Thank you for your response. I understand what you mean. ZKFC let NN2 also become standby, and the whole HDFS is not available, which leads to Yarn and HBase are also not available. so the consequences are too serious. The better solution is that the ZKFC throws exception and exits, and  Active NameNode keep active state.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-14T03:45:54.960+0000","updated":"2017-07-17T11:49:46.607+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13086845/comment/16089705","id":"16089705","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"body":"[~surendrasingh]  What do you think of the above idea？","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-17T11:51:04.536+0000","updated":"2017-07-17T11:51:04.536+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13086845/comment/16090097","id":"16090097","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=surendrasingh","name":"surendrasingh","key":"surendrasingh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=surendrasingh&avatarId=30759","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=surendrasingh&avatarId=30759","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=surendrasingh&avatarId=30759","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=surendrasingh&avatarId=30759"},"displayName":"Surendra Singh Lilhore","active":true,"timeZone":"Etc/UTC"},"body":"bq. The better solution is that the ZKFC throws exception and exits, and Active NameNode keep active state.\n\nWhat if your old active Namenode(NN1) is not healthy and its not starting because of some reason like disk failure ?. ZKFC should not exit, it should retry to make local namenode active.\n\n[~yangjiandan], we will check with others also their opinion.\n\n[~arpitagarwal], [~andrew.wang], [~vinayrpet] Please can you give your opinion ? \nHow to handle fail-over if user configured {{dfs.namenode.servicerpc-address}} address after cluster installation ? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=surendrasingh","name":"surendrasingh","key":"surendrasingh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=surendrasingh&avatarId=30759","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=surendrasingh&avatarId=30759","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=surendrasingh&avatarId=30759","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=surendrasingh&avatarId=30759"},"displayName":"Surendra Singh Lilhore","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-17T17:08:15.790+0000","updated":"2017-07-17T17:08:15.790+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13086845/comment/16105604","id":"16105604","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"body":"Surendra was right. Reformatting the zkfc is the correct answer.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-07-28T20:15:29.999+0000","updated":"2017-07-28T20:15:29.999+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13086845/comment/16351230","id":"16351230","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=beeflyme","name":"beeflyme","key":"beeflyme","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"caixiaofeng","active":true,"timeZone":"Etc/UTC"},"body":"meet this problem and mark,  delete znode store in zookeeper /hadoop-ha/hacluster/*  will also be ok.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=beeflyme","name":"beeflyme","key":"beeflyme","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"caixiaofeng","active":true,"timeZone":"Etc/UTC"},"created":"2018-02-03T03:46:43.602+0000","updated":"2018-02-03T03:47:34.280+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-12132/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3hh0v:"}}