{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12377680","self":"https://issues.apache.org/jira/rest/api/2/issue/12377680","key":"HDFS-56","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2007-09-06T22:42:25.814+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Sep 26 01:21:03 UTC 2007","customfield_12310420":"16486","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-56/watchers","watchCount":3,"isWatching":false},"created":"2007-09-06T16:55:25.603+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12317746","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12317746","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"outwardIssue":{"id":"12379065","key":"HADOOP-1946","self":"https://issues.apache.org/jira/rest/api/2/issue/12379065","fields":{"summary":"du should be not called on every heartbeat","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-02T02:29:10.157+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":">> Copy from dev list:\nOur cluster has 4 nodes and i set the mapred.subimt.replication parameter to 2 on all nodes and the master. Everything has been restarted.\nUnfortuantely, we still have the same exception :\n\n2007-09-05 17:01:59,623 ERROR org.apache.hadoop.dfs.DataNode:\nDataXceiver: java.io.IOException: Block blk_-5969983648201186681 is valid, and cannot be written to.\n        at org.apache.hadoop.dfs.FSDataset.writeToBlock(FSDataset.java:515)\n        at\norg.apache.hadoop.dfs.DataNode$DataXceiver.writeBlock(DataNode.java:822)\n        at org.apache.hadoop.dfs.DataNode$DataXceiver.run(DataNode.java:727)\n        at java.lang.Thread.run(Thread.java:595)\n>> end of copy\n\nThe message shows that the namenode schedules to replicate a block to a datanode that already holds the block. The namenode block placement algorithm makes sure that it does not schedule a block to a datanode that is confirmed to hold a replica of the block. But it is not aware of any in-transit  block placements (i.e. the scheduled but not confirmed block placements), so occasionally we may still see \"is valid, and cannot be written to\" errors.\n\nA fix to the problem is to keep track of all in-transit block  placements, and the block placement algorithm considers these  to-be-confirmed replicas as well.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"107677","customfield_12312823":null,"summary":"Datanodes get error message \"is valid, and cannot be written to\" ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hairong","name":"hairong","key":"hairong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hairong Kuang","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hairong","name":"hairong","key":"hairong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hairong Kuang","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12525544","id":"12525544","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cutting","name":"cutting","key":"cutting","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Cutting","active":true,"timeZone":"America/Los_Angeles"},"body":"Does the current behavior actually cause any problems?  Or is the message just disconcerting?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cutting","name":"cutting","key":"cutting","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Cutting","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-06T22:42:25.814+0000","updated":"2007-09-06T22:42:25.814+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12525546","id":"12525546","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"body":"Assuming default replication is 3, setting mapred.submit.replication to 2 should not result in this exception. Relevant log from namenode from original poster would be helpful.\n\nThe problem that Hairong described hasn't cause real failures yet as far as I know. It only slows down increasing replication.. not sure by how much.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-06T22:52:42.433+0000","updated":"2007-09-06T22:52:42.433+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12525547","id":"12525547","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jimk","name":"jimk","key":"jimk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Kellerman","active":true,"timeZone":"Etc/UTC"},"body":"Until I saw the explanation above, it was disconcerting as it looked like there was something wrong with the DFS, especially since the log message is an ERROR. If it was an INFO, I would have assumed it was mostly harmless.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jimk","name":"jimk","key":"jimk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Kellerman","active":true,"timeZone":"Etc/UTC"},"created":"2007-09-06T22:53:13.284+0000","updated":"2007-09-06T22:53:13.284+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12525548","id":"12525548","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"body":"This is from Datanode log. As far as datanode is concerned, it is an error. Agreed, it is confusing to the user. We should fix this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-06T22:57:07.574+0000","updated":"2007-09-06T22:57:07.574+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12525633","id":"12525633","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tcurdt","name":"tcurdt","key":"tcurdt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Torsten Curdt","active":true,"timeZone":"Europe/Berlin"},"body":"We can try to gather a (new) log but if I remember even the unit test had the exception. (see the thread on dev) With my still limited knowledge of the codebase and comparing to what is going on the cluster it seems it does not really cause huge problems. So it was mainly disconcerting. But - at some stage we have had so many of these exception in the logs that they were essentially spamming the logs. (More than hundred exceptions per minute!) ...which made it a bit more than just disconcerting. Maybe the word \"panic\" was more suited ;) At least OPS stopped believing this is not a problem and doesn't add to a good reputation of hadoop. It also make you lose the eye for real problems as it just drowns them in a see of information.\n\nSo yeah ...we should really fix this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tcurdt","name":"tcurdt","key":"tcurdt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Torsten Curdt","active":true,"timeZone":"Europe/Berlin"},"created":"2007-09-07T07:55:55.157+0000","updated":"2007-09-07T07:55:55.157+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12525766","id":"12525766","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"body":"> We can try to gather a (new) log but if I remember even the unit test had the exception. \n\nThe unit test failure was for a different reason. If there are many of this kind, we can fix that too. The proposed fix in this jira should fix the most commonly observed cause of these exceptions.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-07T16:20:24.029+0000","updated":"2007-09-07T16:20:24.029+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12526229","id":"12526229","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"This looks like a recent addition. Could you guys post with which versions of hadoop you can/started to see that behavior\nso that we could track what could have caused it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-10T19:20:20.068+0000","updated":"2007-09-10T19:20:20.068+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12528282","id":"12528282","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tcurdt","name":"tcurdt","key":"tcurdt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Torsten Curdt","active":true,"timeZone":"Europe/Berlin"},"body":"We have been seen this in 0.10 and are still seeing it in 0.14","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tcurdt","name":"tcurdt","key":"tcurdt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Torsten Curdt","active":true,"timeZone":"Europe/Berlin"},"created":"2007-09-18T07:44:46.093+0000","updated":"2007-09-18T07:44:46.093+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12528287","id":"12528287","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"Hi Torsten, how many datanodes do you have in your cluster? The reason I asm asking this question is because the probability of these exception occuring increases if the cluster size is very small (or if only a very small number of nodes have avilable disk space)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2007-09-18T07:51:54.892+0000","updated":"2007-09-18T07:51:54.892+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12528609","id":"12528609","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"I am running a 2-node cluster and see this exception all the time.\nHere is the log from the name-node that explains the behavior:\n\n{code}\n07/09/18 12:08:05 INFO dfs.StateChange: BLOCK* NameSystem.allocateBlock: /Dir0/file20. blk_-4934058791921230875 is created and added to pendingCreates and pendingCreateBlocks\n07/09/18 12:08:06 INFO dfs.StateChange: BLOCK* NameSystem.addStoredBlock: blockMap updated: node.x.x.111:50077 is added to blk_-4934058791921230875\n07/09/18 12:08:08 INFO dfs.StateChange: BLOCK* NameSystem.pendingTransfer: ask node.x.x.111:50077 to replicate blk_-4934058791921230875 to datanode(s) node.x.x.222:50017\n07/09/18 12:08:09 INFO dfs.StateChange: BLOCK* NameSystem.addStoredBlock: blockMap updated: node.x.x.222:50017 is added to blk_-4934058791921230875\n{code}\n\nWhat we see here is a race condition between blockReceived()  and sendHeartbeat().\nThe client writes 2 block replicas to 2 data-nodes. When finished writing replicas to their disks the data-nodes send blockReceived() to the name-node.\nThe following sequence of events causes the exception:\n\n# node1.blockReceived(): the block is added to the list of under-replicated blocks, since it is supposed to have replication 2;\n# node1.sendHeartbeat(): node1 starts replicating block to node2.\n   In respond node2 throws \"block is valid, and cannot be written to\" exception.\n# node2.blockReceived(): everything goes back to normal.\n\nOn a 2-node cluster there is always one choice where the other replica can be placed. That is why the exception is inevitable if replication is requested.\nOn a bigger clusters the exception is rather rare, because replication most probably will be scheduled to a data-node that does not contain the block.\nWhich makes it even worse, because the actual transfer happens, the block becomes over-replicated so that now one of the replicas needs to be removed.\n\nI think this decreases the overall performance of the cluster  - unnecessary transfers of large blocks can be costly.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-18T23:28:45.778+0000","updated":"2007-09-18T23:28:45.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12530323","id":"12530323","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"HADOOP-1946 is the main reason for that behavior.\nThe data-nodes were very slow so that blockReceived()  were in fact coming late after the file had been closed.\nDo we still want to remove the exception mentioned in the initial description?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-25T23:29:16.276+0000","updated":"2007-09-25T23:29:16.276+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377680/comment/12530345","id":"12530345","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hairong","name":"hairong","key":"hairong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hairong Kuang","active":true,"timeZone":"Etc/UTC"},"body":"I feel that fundamentally namenode does not handle blockReceived well. HADOOP-1946 simply \"amplied\" the problem. BlockReceived should not trigger re-replication. We should put block placement decisions at file creation time in the PendingReplicationBlocks queue as well. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hairong","name":"hairong","key":"hairong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hairong Kuang","active":true,"timeZone":"Etc/UTC"},"created":"2007-09-26T01:21:03.910+0000","updated":"2007-09-26T01:21:03.910+0000"}],"maxResults":12,"total":12,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-56/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0isaf:"}}